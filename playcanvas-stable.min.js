/**
 * @license
 * PlayCanvas Engine v2.16.1 revision 4486208 (RELEASE)
 * Copyright 2011-2026 PlayCanvas Ltd. All rights reserved.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
var e,t;e=this,t=function(e){let t,i,s,r,a,n,o,l,h,c,d,u,f,p,m,_,g,v,S,y,x;var T="undefined"!=typeof document?document.currentScript:null;let E="GpuTimings",w="2.16.1",b="4486208";function A(e,t){for(let i in t){let s=t[i];Array.isArray(s)?e[i]=A([],s):s&&"object"==typeof s?e[i]=A({},s):e[i]=s;}return e}let C={create:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return ("x"===e?t:3&t|8).toString(16)})},P={delimiter:"/",join(...e){let t=e[0];for(let i=0;i<e.length-1;i++){let s=e[i],r=e[i+1];if(r[0]===P.delimiter){t=r;continue}s&&r&&s[s.length-1]!==P.delimiter&&r[0]!==P.delimiter?t+=P.delimiter+r:t+=r;}return t},normalize(e){let t=e.startsWith(P.delimiter),i=e.endsWith(P.delimiter),s=e.split("/"),r="",a=[];for(let e=0;e<s.length;e++)if(""!==s[e]&&"."!==s[e]){if(".."===s[e]&&a.length>0){a=a.slice(0,a.length-2);continue}e>0&&a.push(P.delimiter),a.push(s[e]);}return r=a.join(""),t||r[0]!==P.delimiter||(r=r.slice(1)),i&&r[r.length-1]!==P.delimiter&&(r+=P.delimiter),r},split(e){let t=e.lastIndexOf(P.delimiter);return -1!==t?[e.substring(0,t),e.substring(t+1)]:["",e]},getBasename:e=>P.split(e)[1],getDirectory:e=>P.split(e)[0],getExtension(e){let t=e.split("?")[0].split(".").pop();return t!==e?`.${t}`:""},isRelativePath:e=>"/"!==e.charAt(0)&&null===e.match(/:\/\//),extractPath(e){let t="",i=e.split("/"),s=0;if(i.length>1)if(P.isRelativePath(e))if("."===i[0])for(s=0;s<i.length-1;++s)t+=0===s?i[s]:`/${i[s]}`;else if(".."===i[0])for(s=0;s<i.length-1;++s)t+=0===s?i[s]:`/${i[s]}`;else for(s=0,t=".";s<i.length-1;++s)t+=`/${i[s]}`;else for(s=0;s<i.length-1;++s)t+=0===s?i[s]:`/${i[s]}`;return t}},I="undefined"!=typeof navigator?navigator.userAgent:"",D="undefined"!=typeof window?"browser":"undefined"!=typeof global?"node":"worker",R=/android/i.test(I)?"android":/ip(?:[ao]d|hone)/i.test(I)?"ios":/windows/i.test(I)?"windows":/mac os/i.test(I)?"osx":/linux/i.test(I)?"linux":/cros/i.test(I)?"cros":null,L="browser"!==D?null:/Chrome\/|Chromium\/|Edg.*\//.test(I)?"chrome":/Safari\//.test(I)?"safari":/Firefox\//.test(I)?"firefox":"other",M=/xbox/i.test(I),O="browser"===D&&("ontouchstart"in window||"maxTouchPoints"in navigator&&navigator.maxTouchPoints>0),F="browser"===D&&(!!navigator.getGamepads||!!navigator.webkitGetGamepads),N="undefined"!=typeof Worker,B=(()=>{let e=false;try{let t=Object.defineProperty({},"passive",{get:function(){return e=!0,!1}});window.addEventListener("testpassive",null,t),window.removeEventListener("testpassive",null,t);}catch(e){}return e})(),k={name:R,environment:D,global:("undefined"!=typeof globalThis&&globalThis)??("browser"===D&&window)??("node"===D&&global)??("worker"===D&&self),browser:"browser"===D,worker:"worker"===D,desktop:["windows","osx","linux","cros"].includes(R),mobile:["android","ios"].includes(R),ios:"ios"===R,android:"android"===R,xbox:M,gamepads:F,touch:O,workers:N,passiveEvents:B,browserName:L},U="abcdefghijklmnopqrstuvwxyz",z="ABCDEFGHIJKLMNOPQRSTUVWXYZ";function V(e,t=0){let i=e.length;if(t<0||t>=i)return null;let s=e.charCodeAt(t);if(i>1&&s>=55296&&s<=56319){let i=e.charCodeAt(t+1);if(i>=56320&&i<=57343)return {code:(s-55296)*1024+i-56320+65536,long:true}}return {code:s,long:false}}function G(e,t,i){if(!e)return  false;let s=V(e);if(s){let e=s.code;return e>=t&&e<=i}return  false}let H={ASCII_LOWERCASE:U,ASCII_UPPERCASE:z,ASCII_LETTERS:U+z,format(e,...t){for(let i=0;i<t.length;i++)e=e.replace(`{${i}}`,t[i]);return e},getCodePoint(e,t){let i=V(e,t);return i&&i.code},getCodePoints(e){let t;if("string"!=typeof e)throw TypeError("Not a string");let i=0,s=[];for(;t=V(e,i);)s.push(t.code),i+=t.long?2:1;return s},getSymbols(e){let t;if("string"!=typeof e)throw TypeError("Not a string");let i=0,s=e.length,r=[],a=0;for(;i<s;){if(a+=function(e,t){if(t===e.length-1)return 1;if(G(e[t],55296,56319)){let i=e.substring(t,t+2),s=e.substring(t+2,t+4);return G(s,127995,127999)||G(i,127462,127487)&&G(s,127462,127487)?4:G(s,65024,65039)?3:2}return G(e[t+1],65024,65039)?2:1}(e,i+a),G(t=e[i+a],8400,8447)&&(t=e[i+a++]),G(t,65024,65039)&&(t=e[i+a++]),t&&8205===t.charCodeAt(0)){t=e[i+a++];continue}let s=e.substring(i,i+a);r.push(s),i+=a,a=0;}return r},fromCodePoint:(...e)=>e.map(e=>e>65535?String.fromCharCode(((e-=65536)>>10)+55296,e%1024+56320):String.fromCharCode(e)).join("")};class W{off(){this._removed||this.handler.offByHandle(this);}on(e,t,i=this){return this.handler._addCallback(e,t,i,false)}once(e,t,i=this){return this.handler._addCallback(e,t,i,true)}set removed(e){e&&(this._removed=true);}get removed(){return this._removed}toJSON(e){}constructor(e,t,i,s,r=false){this._removed=false,this.handler=e,this.name=t,this.callback=i,this.scope=s,this._once=r;}}class X{initEventHandler(){this._callbacks=new Map,this._callbackActive=new Map;}_addCallback(e,t,i,s){if(this._callbacks.has(e)||this._callbacks.set(e,[]),this._callbackActive.has(e)){let t=this._callbackActive.get(e);t&&t===this._callbacks.get(e)&&this._callbackActive.set(e,t.slice());}let r=new W(this,e,t,i,s);return this._callbacks.get(e).push(r),r}on(e,t,i=this){return this._addCallback(e,t,i,false)}once(e,t,i=this){return this._addCallback(e,t,i,true)}off(e,t,i){if(e)this._callbackActive.has(e)&&this._callbackActive.get(e)===this._callbacks.get(e)&&this._callbackActive.set(e,this._callbackActive.get(e).slice());else for(let[e,t]of this._callbackActive)this._callbacks.has(e)&&this._callbacks.get(e)===t&&this._callbackActive.set(e,t.slice());if(e)if(t){let s=this._callbacks.get(e);if(!s)return this;for(let e=0;e<s.length;e++)s[e].callback===t&&(!i||s[e].scope===i)&&(s[e].removed=true,s.splice(e,1),e--);0===s.length&&this._callbacks.delete(e);}else {let t=this._callbacks.get(e);if(t){for(let e=0;e<t.length;e++)t[e].removed=true;this._callbacks.delete(e);}}else {for(let e of this._callbacks.values())for(let t=0;t<e.length;t++)e[t].removed=true;this._callbacks.clear();}return this}offByHandle(e){let t=e.name;e.removed=true,this._callbackActive.has(t)&&this._callbackActive.get(t)===this._callbacks.get(t)&&this._callbackActive.set(t,this._callbackActive.get(t).slice());let i=this._callbacks.get(t);if(!i)return this;let s=i.indexOf(e);return -1!==s&&(i.splice(s,1),0===i.length&&this._callbacks.delete(t)),this}fire(e,t,i,s,r,a,n,o,l){let h;if(!e)return this;let c=this._callbacks.get(e);if(!c)return this;this._callbackActive.has(e)?this._callbackActive.get(e)!==c&&(h=c.slice()):this._callbackActive.set(e,c);for(let c=0;(h||this._callbackActive.get(e))&&c<(h||this._callbackActive.get(e)).length;c++){let d=(h||this._callbackActive.get(e))[c];if(d.callback&&(d.callback.call(d.scope,t,i,s,r,a,n,o,l),d._once)){let t=this._callbacks.get(e),i=t?t.indexOf(d):-1;if(-1!==i){this._callbackActive.get(e)===t&&this._callbackActive.set(e,this._callbackActive.get(e).slice());let s=this._callbacks.get(e);if(!s)continue;s[i].removed=true,s.splice(i,1),0===s.length&&this._callbacks.delete(e);}}}return h||this._callbackActive.delete(e),this}hasEvent(e){return !!this._callbacks.get(e)?.length}constructor(){this._callbacks=new Map,this._callbackActive=new Map;}}class Y{push(e,t){if(this._index[e])throw Error(`Key already in index ${e}`);let i=this._list.push(t)-1;this._index[e]=i;}has(e){return void 0!==this._index[e]}get(e){let t=this._index[e];return void 0!==t?this._list[t]:null}remove(e){let t=this._index[e];if(void 0!==t){for(e in this._list.splice(t,1),delete this._index[e],this._index){let i=this._index[e];i>t&&(this._index[e]=i-1);}return  true}return  false}list(){return this._list}clear(){for(let e in this._list.length=0,this._index)delete this._index[e];}constructor(){this._list=[],this._index={};}}class q{static loadScript(e,t){let i=document.createElement("script");i.setAttribute("src",e),i.onload=()=>{t(null);},i.onerror=()=>{t(`Failed to load script='${e}'`);},document.body.appendChild(i);}static loadWasm(e,t,i){let s=q.wasmSupported()&&t.glueUrl&&t.wasmUrl?t.glueUrl:t.fallbackUrl;s?q.loadScript(s,s=>{if(s)i(s,null);else {let s=window[e];window[e]=void 0,s({locateFile:()=>t.wasmUrl,onAbort:()=>{i("wasm module aborted.");}}).then(e=>{i(null,e);});}}):i("No supported wasm modules found.",null);}static getModule(e){return q.modules.hasOwnProperty(e)||(q.modules[e]={config:null,initializing:false,instance:null,callbacks:[]}),q.modules[e]}static initialize(e,t){if(t.initializing)return;let i=t.config;(i.glueUrl||i.wasmUrl||i.fallbackUrl)&&(t.initializing=true,q.loadWasm(e,i,(e,s)=>{e?i.errorHandler&&i.errorHandler(e):(t.instance=s,t.callbacks.forEach(e=>{e(s);}));}));}}q.modules={},y=S={},q.wasmSupported=()=>(y===S&&(y=(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){let e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return  false})()),y);class ${static setConfig(e,t){let i=q.getModule(e);i.config=t,i.callbacks.length>0&&q.initialize(e,i);}static getConfig(e){return q.modules?.[e]?.config}static getInstance(e,t){let i=q.getModule(e);i.instance?t(i.instance):(i.callbacks.push(t),i.config&&q.initialize(e,i));}}class j{get remainingBytes(){return this.dataView.byteLength-this.offset}reset(e=0){this.offset=e;}skip(e){this.offset+=e;}align(e){this.offset=this.offset+e-1&~(e-1);}_inc(e){return this.offset+=e,this.offset-e}readChar(){return String.fromCharCode(this.dataView.getUint8(this.offset++))}readChars(e){let t="";for(let i=0;i<e;++i)t+=this.readChar();return t}readU8(){return this.dataView.getUint8(this.offset++)}readU16(){return this.dataView.getUint16(this._inc(2),true)}readU32(){return this.dataView.getUint32(this._inc(4),true)}readU64(){return this.readU32()+0x100000000*this.readU32()}readU32be(){return this.dataView.getUint32(this._inc(4),false)}readArray(e){for(let t=0;t<e.length;++t)e[t]=this.readU8();}readLine(){let e=this.dataView,t="";for(;!(this.offset>=e.byteLength);){let e=String.fromCharCode(this.readU8());if("\n"===e)break;t+=e;}return t}constructor(e){this.offset=0,this.arraybuffer=e,this.dataView=new DataView(e);}}class K{_binarySearch(e){let t,i,s=0,r=this.items.length-1,a=e[this._sortBy];for(;s<=r;)t=Math.floor((s+r)/2),(i=this.items[t][this._sortBy])<=a?s=t+1:i>a&&(r=t-1);return s}_doSort(e,t){let i=this._sortBy;return e[i]-t[i]}insert(e){let t=this._binarySearch(e);this.items.splice(t,0,e),this.length++,this.loopIndex>=t&&this.loopIndex++;}append(e){this.items.push(e),this.length++;}remove(e){let t=this.items.indexOf(e);!(t<0)&&(this.items.splice(t,1),this.length--,this.loopIndex>=t&&this.loopIndex--);}sort(){let e=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),null!==e&&(this.loopIndex=this.items.indexOf(e));}constructor(e){this.items=[],this.length=0,this.loopIndex=-1,this._sortBy=e.sortBy,this._sortHandler=this._doSort.bind(this);}}class Z extends X{add(...e){let t=false,i=this._processArguments(e,true);if(!i.length)return t;for(let e=0;e<i.length;e++)this._index[i[e]]||(t=true,this._index[i[e]]=true,this._list.push(i[e]),this.fire("add",i[e],this._parent));return t&&this.fire("change",this._parent),t}remove(...e){let t=false;if(!this._list.length)return t;let i=this._processArguments(e,true);if(!i.length)return t;for(let e=0;e<i.length;e++)this._index[i[e]]&&(t=true,delete this._index[i[e]],this._list.splice(this._list.indexOf(i[e]),1),this.fire("remove",i[e],this._parent));return t&&this.fire("change",this._parent),t}clear(){if(!this._list.length)return;let e=this._list.slice(0);this._list=[],this._index={};for(let t=0;t<e.length;t++)this.fire("remove",e[t],this._parent);this.fire("change",this._parent);}has(...e){return !!this._list.length&&this._has(this._processArguments(e))}_has(e){if(!this._list.length||!e.length)return  false;for(let t=0;t<e.length;t++)if(1===e[t].length){if(this._index[e[t][0]])return  true}else {let i=true;for(let s=0;s<e[t].length;s++)if(!this._index[e[t][s]]){i=false;break}if(i)return  true}return  false}list(){return this._list.slice(0)}_processArguments(e,t){let i=[],s=[];if(!e||!e.length)return i;for(let r=0;r<e.length;r++)if(e[r]instanceof Array){t||(s=[]);for(let a=0;a<e[r].length;a++)"string"==typeof e[r][a]&&(t?i.push(e[r][a]):s.push(e[r][a]));!t&&s.length&&i.push(s);}else "string"==typeof e[r]&&(t?i.push(e[r]):i.push([e[r]]));return i}get size(){return this._list.length}constructor(e){super(),this._index={},this._list=[],this._parent=e;}}Z.EVENT_ADD="add",Z.EVENT_REMOVE="remove",Z.EVENT_CHANGE="change";let Q="undefined"!=typeof window&&window.performance&&window.performance.now?performance.now.bind(performance):Date.now,J=/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class ee{toString(){let e="";return this.scheme&&(e+=`${this.scheme}:`),this.authority&&(e+=`//${this.authority}`),e+=this.path,this.query&&(e+=`?${this.query}`),this.fragment&&(e+=`#${this.fragment}`),e}getQuery(){let e={};if(this.query)for(let t of decodeURIComponent(this.query).split("&")){let i=t.split("=");e[i[0]]=i[1];}return e}setQuery(e){let t="";for(let i in e)e.hasOwnProperty(i)&&(""!==t&&(t+="&"),t+=`${encodeURIComponent(i)}=${encodeURIComponent(e[i])}`);this.query=t;}constructor(e){let t=e.match(J);this.scheme=t[2],this.authority=t[4],this.path=t[5],this.query=t[7],this.fragment=t[9];}}class et{static set(e,t=true){}static get(e){return et._traceChannels.has(e)}}et._traceChannels=new Set,et.stack=false;let ei={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:(e,t,i)=>e>=i?i:e<=t?t:e,intToBytes24:e=>[e>>16&255,e>>8&255,255&e],intToBytes32:e=>[e>>24&255,e>>16&255,e>>8&255,255&e],bytesToInt24:(e,t,i)=>(e.length&&(i=e[2],t=e[1],e=e[0]),e<<16|t<<8|i),bytesToInt32:(e,t,i,s)=>(e.length&&(s=e[3],i=e[2],t=e[1],e=e[0]),(e<<24|t<<16|i<<8|s)>>>0),lerp:(e,t,i)=>e+(t-e)*ei.clamp(i,0,1),lerpAngle:(e,t,i)=>(t-e>180&&(t-=360),t-e<-180&&(t+=360),ei.lerp(e,t,ei.clamp(i,0,1))),powerOfTwo:e=>0!==e&&!(e&e-1),nextPowerOfTwo:e=>(e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e),nearestPowerOfTwo:e=>Math.pow(2,Math.round(Math.log2(e))),random:(e,t)=>Math.random()*(t-e)+e,smoothstep:(e,t,i)=>i<=e?0:i>=t?1:(i=(i-e)/(t-e))*i*(3-2*i),smootherstep:(e,t,i)=>i<=e?0:i>=t?1:(i=(i-e)/(t-e))*i*i*(i*(6*i-15)+10),roundUp:(e,t)=>0===t?e:Math.ceil(e/t)*t,between(e,t,i,s){let r=Math.min(t,i),a=Math.max(t,i);return s?e>=r&&e<=a:e>r&&e<a}};class es{clone(){return new this.constructor(this.r,this.g,this.b,this.a)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}equals(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}set(e,t,i,s=1){return this.r=e,this.g=t,this.b=i,this.a=s,this}lerp(e,t,i){return this.r=e.r+i*(t.r-e.r),this.g=e.g+i*(t.g-e.g),this.b=e.b+i*(t.b-e.b),this.a=e.a+i*(t.a-e.a),this}linear(e=this){return this.r=Math.pow(e.r,2.2),this.g=Math.pow(e.g,2.2),this.b=Math.pow(e.b,2.2),this.a=e.a,this}gamma(e=this){return this.r=Math.pow(e.r,1/2.2),this.g=Math.pow(e.g,1/2.2),this.b=Math.pow(e.b,1/2.2),this.a=e.a,this}mulScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}fromString(e){let t,i=parseInt(e.replace("#","0x"),16);return e.length>7?t=ei.intToBytes32(i):(t=ei.intToBytes24(i))[3]=255,this.set(t[0]/255,t[1]/255,t[2]/255,t[3]/255),this}fromArray(e,t=0){return this.r=e[t]??this.r,this.g=e[t+1]??this.g,this.b=e[t+2]??this.b,this.a=e[t+3]??this.a,this}toString(e,t){let{r:i,g:s,b:r,a}=this;if(t||i>1||s>1||r>1)return `${i.toFixed(3)}, ${s.toFixed(3)}, ${r.toFixed(3)}, ${a.toFixed(3)}`;let n=`#${(0x1000000+(Math.round(255*i)<<16)+(Math.round(255*s)<<8)+Math.round(255*r)).toString(16).slice(1)}`;if(true===e){let e=Math.round(255*a).toString(16);this.a<16/255?n+=`0${e}`:n+=e;}return n}toArray(e=[],t=0,i=true){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,i&&(e[t+3]=this.a),e}constructor(e=0,t=0,i=0,s=1){let r=e.length;3===r||4===r?(this.r=e[0],this.g=e[1],this.b=e[2],this.a=e[3]??1):(this.r=e,this.g=t,this.b=i,this.a=s);}}es.BLACK=Object.freeze(new es(0,0,0,1)),es.BLUE=Object.freeze(new es(0,0,1,1)),es.CYAN=Object.freeze(new es(0,1,1,1)),es.GRAY=Object.freeze(new es(.5,.5,.5,1)),es.GREEN=Object.freeze(new es(0,1,0,1)),es.MAGENTA=Object.freeze(new es(1,0,1,1)),es.RED=Object.freeze(new es(1,0,0,1)),es.WHITE=Object.freeze(new es(1,1,1,1)),es.YELLOW=Object.freeze(new es(1,1,0,1));class er{evaluate(e,t=false){let i;(t||e<this._left||e>=this._right)&&this._reset(e);let s=this._curve.type;if(5===s)i=this._p0;else {let t=0===this._recip?0:(e-this._left)*this._recip;i=0===s?ei.lerp(this._p0,this._p1,t):1===s?ei.lerp(this._p0,this._p1,t*t*(3-2*t)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,t);}return i}_reset(e){let t=this._curve.keys,i=t.length;if(i)if(e<t[0][0])this._left=-1/0,this._right=t[0][0],this._recip=0,this._p0=this._p1=t[0][1],this._m0=this._m1=0;else if(e>=t[i-1][0])this._left=t[i-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=t[i-1][1],this._m0=this._m1=0;else {let i=0;for(;e>=t[i+1][0];)i++;this._left=t[i][0],this._right=t[i+1][0];let s=1/(this._right-this._left);this._recip=isFinite(s)?s:0,this._p0=t[i][1],this._p1=t[i+1][1],4===this._curve.type&&this._calcTangents(t,i);}else this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0;}_calcTangents(e,t){let i,s,r=e[t],a=e[t+1];if(i=0===t?[e[0][0]+(e[0][0]-e[1][0]),e[0][1]+(e[0][1]-e[1][1])]:e[t-1],s=t===e.length-2?[e[t+1][0]+(e[t+1][0]-e[t][0]),e[t+1][1]+(e[t+1][1]-e[t][1])]:e[t+2],4===this._curve.type){let e=2*(a[0]-r[0])/(a[0]-i[0]),t=2*(a[0]-r[0])/(s[0]-r[0]);this._m0=this._curve.tension*(isFinite(e)?e:0)*(a[1]-i[1]),this._m1=this._curve.tension*(isFinite(t)?t:0)*(s[1]-r[1]);}else {let e=(a[0]-r[0])/(r[0]-i[0]),t=(a[0]-r[0])/(s[0]-a[0]),n=r[1]+(i[1]-r[1])*(isFinite(e)?e:0),o=a[1]+(s[1]-a[1])*(isFinite(t)?t:0),l=this._curve.tension;this._m0=l*(a[1]-n),this._m1=l*(o-r[1]);}}_evaluateHermite(e,t,i,s,r){let a=r*r,n=r+r,o=1-r,l=o*o;return (1+n)*l*e+r*l*i+a*(3-n)*t+a*(r-1)*s}constructor(e,t=0){this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._curve=e,this._reset(t);}}class ea{get length(){return this.keys.length}add(e,t){let i=this.keys,s=i.length,r=0;for(;r<s&&!(i[r][0]>e);r++);let a=[e,t];return this.keys.splice(r,0,a),a}get(e){return this.keys[e]}sort(){this.keys.sort((e,t)=>e[0]-t[0]);}value(e){return this._eval.evaluate(e,true)}closest(e){let t=this.keys,i=t.length,s=2,r=null;for(let a=0;a<i;a++){let i=Math.abs(e-t[a][0]);if(s>=i)s=i,r=t[a];else break}return r}clone(){let e=new this.constructor;return e.keys=this.keys.map(e=>[...e]),e.type=this.type,e.tension=this.tension,e}quantize(e){let t=new Float32Array(e=Math.max(e,2)),i=1/(e-1);t[0]=this._eval.evaluate(0,true);for(let s=1;s<e;s++)t[s]=this._eval.evaluate(i*s);return t}quantizeClamped(e,t,i){let s=this.quantize(e);for(let e=0;e<s.length;++e)s[e]=Math.min(i,Math.max(t,s[e]));return s}constructor(e){if(this.keys=[],this.type=1,this.tension=.5,this._eval=new er(this),e)for(let t=0;t<e.length-1;t+=2)this.keys.push([e[t],e[t+1]]);this.sort();}}class en{get length(){return this.curves.length}set type(e){this._type=e;for(let t=0;t<this.curves.length;t++)this.curves[t].type=e;}get type(){return this._type}get(e){return this.curves[e]}value(e,t=[]){let i=this.curves.length;t.length=i;for(let s=0;s<i;s++)t[s]=this.curves[s].value(e);return t}clone(){let e=new this.constructor;e.curves=[];for(let t=0;t<this.curves.length;t++)e.curves.push(this.curves[t].clone());return e._type=this._type,e}quantize(e){e=Math.max(e,2);let t=this.curves.length,i=new Float32Array(e*t),s=1/(e-1);for(let r=0;r<t;r++){let a=new er(this.curves[r]);for(let n=0;n<e;n++)i[n*t+r]=a.evaluate(s*n);}return i}quantizeClamped(e,t,i){let s=this.quantize(e);for(let e=0;e<s.length;++e)s[e]=Math.min(i,Math.max(t,s[e]));return s}constructor(...e){if(this.curves=[],this._type=1,e.length>1)for(let t=0;t<e.length;t++)this.curves.push(new ea(e[t]));else if(0===e.length)this.curves.push(new ea);else {let t=e[0];if("number"==typeof t)for(let e=0;e<t;e++)this.curves.push(new ea);else for(let e=0;e<t.length;e++)this.curves.push(new ea(t[e]));}}}let eo=new Float32Array(1),el=new Int32Array(eo.buffer);class eh{static float2Half(e){eo[0]=e;let t=el[0],i=t>>16&32768,s=t>>12&2047,r=t>>23&255;return r<103?i:r>142?(i|=31744,i|=+(255!==r)&&8388607&t):r<113?(s|=2048,i|=(s>>114-r)+(s>>113-r&1)):(i|=r-112<<10|s>>1,i+=1&s)}static float2RGBA8(e,t){eo[0]=e;let i=el[0];t.r=(i>>24&255)/255,t.g=(i>>16&255)/255,t.b=(i>>8&255)/255,t.a=(255&i)/255;}}class ec{static concentric(e,t){let i=[];i.push(0,0);let s=2*Math.PI/e/t;for(let t=1;t<=e;t++){let r=t/e,a=Math.max(1,Math.floor(2*Math.PI*r/s)),n=2*Math.PI/a;for(let e=0;e<a;e++){let t=e*n,s=r*Math.cos(t),a=r*Math.sin(t);i.push(s,a);}}return i}}class ed{add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}cross(e,t){let i=e.x,s=e.y,r=e.z,a=t.x,n=t.y,o=t.z;return this.x=s*o-n*r,this.y=r*a-o*i,this.z=i*n-a*s,this}distance(e){let t=this.x-e.x,i=this.y-e.y,s=this.z-e.z;return Math.sqrt(t*t+i*i+s*s)}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}lerp(e,t,i){return this.x=e.x+i*(t.x-e.x),this.y=e.y+i*(t.y-e.y),this.z=e.z+i*(t.z-e.z),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}normalize(e=this){let t=e.x*e.x+e.y*e.y+e.z*e.z;if(t>0){let i=1/Math.sqrt(t);this.x=e.x*i,this.y=e.y*i,this.z=e.z*i;}return this}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),this}project(e){let t=(this.x*e.x+this.y*e.y+this.z*e.z)/(e.x*e.x+e.y*e.y+e.z*e.z);return this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this}set(e,t,i){return this.x=e,this.y=t,this.z=i,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}fromArray(e,t=0){return this.x=e[t]??this.x,this.y=e[t+1]??this.y,this.z=e[t+2]??this.z,this}toString(){return `[${this.x}, ${this.y}, ${this.z}]`}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}constructor(e=0,t=0,i=0){3===e.length?(this.x=e[0],this.y=e[1],this.z=e[2]):(this.x=e,this.y=t,this.z=i);}}ed.ZERO=Object.freeze(new ed(0,0,0)),ed.HALF=Object.freeze(new ed(.5,.5,.5)),ed.ONE=Object.freeze(new ed(1,1,1)),ed.UP=Object.freeze(new ed(0,1,0)),ed.DOWN=Object.freeze(new ed(0,-1,0)),ed.RIGHT=Object.freeze(new ed(1,0,0)),ed.LEFT=Object.freeze(new ed(-1,0,0)),ed.FORWARD=Object.freeze(new ed(0,0,-1)),ed.BACK=Object.freeze(new ed(0,0,1));class eu{clone(){return new this.constructor().copy(this)}copy(e){let t=e.data,i=this.data;return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],this}set(e){let t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this}getX(e=new ed){return e.set(this.data[0],this.data[1],this.data[2])}getY(e=new ed){return e.set(this.data[3],this.data[4],this.data[5])}getZ(e=new ed){return e.set(this.data[6],this.data[7],this.data[8])}equals(e){let t=this.data,i=e.data;return t[0]===i[0]&&t[1]===i[1]&&t[2]===i[2]&&t[3]===i[3]&&t[4]===i[4]&&t[5]===i[5]&&t[6]===i[6]&&t[7]===i[7]&&t[8]===i[8]}isIdentity(){let e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&1===e[4]&&0===e[5]&&0===e[6]&&0===e[7]&&1===e[8]}setIdentity(){let e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this}toString(){return `[${this.data.join(", ")}]`}transpose(e=this){let t=e.data,i=this.data;if(t===i){let e;e=t[1],i[1]=t[3],i[3]=e,e=t[2],i[2]=t[6],i[6]=e,e=t[5],i[5]=t[7],i[7]=e;}else i[0]=t[0],i[1]=t[3],i[2]=t[6],i[3]=t[1],i[4]=t[4],i[5]=t[7],i[6]=t[2],i[7]=t[5],i[8]=t[8];return this}setFromMat4(e){let t=e.data,i=this.data;return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[4],i[4]=t[5],i[5]=t[6],i[6]=t[8],i[7]=t[9],i[8]=t[10],this}setFromQuat(e){let t=e.x,i=e.y,s=e.z,r=e.w,a=t+t,n=i+i,o=s+s,l=t*a,h=t*n,c=t*o,d=i*n,u=i*o,f=s*o,p=r*a,m=r*n,_=r*o,g=this.data;return g[0]=1-(d+f),g[1]=h+_,g[2]=c-m,g[3]=h-_,g[4]=1-(l+f),g[5]=u+p,g[6]=c+m,g[7]=u-p,g[8]=1-(l+d),this}invertMat4(e){let t=e.data,i=t[0],s=t[1],r=t[2],a=t[4],n=t[5],o=t[6],l=t[8],h=t[9],c=t[10],d=c*n-o*h,u=-c*a+o*l,f=h*a-n*l,p=i*d+s*u+r*f;if(0===p)this.setIdentity();else {let e=1/p,t=this.data;t[0]=d*e,t[1]=(-c*s+r*h)*e,t[2]=(o*s-r*n)*e,t[3]=u*e,t[4]=(c*i-r*l)*e,t[5]=(-o*i+r*a)*e,t[6]=f*e,t[7]=(-h*i+s*l)*e,t[8]=(n*i-s*a)*e;}return this}transformVector(e,t=new ed){let i=this.data,{x:s,y:r,z:a}=e;return t.x=s*i[0]+r*i[3]+a*i[6],t.y=s*i[1]+r*i[4]+a*i[7],t.z=s*i[2]+r*i[5]+a*i[8],t}constructor(){this.data=new Float32Array(9),this.data[0]=this.data[4]=this.data[8]=1;}}eu.IDENTITY=Object.freeze(new eu),eu.ZERO=Object.freeze(new eu().set([0,0,0,0,0,0,0,0,0]));class ef{add(e){return this.x+=e.x,this.y+=e.y,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}cross(e){return this.x*e.y-this.y*e.x}distance(e){let t=this.x-e.x,i=this.y-e.y;return Math.sqrt(t*t+i*i)}div(e){return this.x/=e.x,this.y/=e.y,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this}divScalar(e){return this.x/=e,this.y/=e,this}dot(e){return this.x*e.x+this.y*e.y}equals(e){return this.x===e.x&&this.y===e.y}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}lerp(e,t,i){return this.x=e.x+i*(t.x-e.x),this.y=e.y+i*(t.y-e.y),this}mul(e){return this.x*=e.x,this.y*=e.y,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this}mulScalar(e){return this.x*=e,this.y*=e,this}normalize(e=this){let t=e.x*e.x+e.y*e.y;if(t>0){let i=1/Math.sqrt(t);this.x=e.x*i,this.y=e.y*i;}return this}rotate(e){let t=Math.atan2(this.x,this.y)+e*ei.DEG_TO_RAD,i=Math.sqrt(this.x*this.x+this.y*this.y);return this.x=Math.sin(t)*i,this.y=Math.cos(t)*i,this}angle(){return Math.atan2(this.x,this.y)*ei.RAD_TO_DEG}angleTo(e){return Math.atan2(this.x*e.y+this.y*e.x,this.x*e.x+this.y*e.y)*ei.RAD_TO_DEG}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),this}set(e,t){return this.x=e,this.y=t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}subScalar(e){return this.x-=e,this.y-=e,this}fromArray(e,t=0){return this.x=e[t]??this.x,this.y=e[t+1]??this.y,this}toString(){return `[${this.x}, ${this.y}]`}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}static angleRad(e,t){return Math.atan2(e.x*t.y-e.y*t.x,e.x*t.x+e.y*t.y)}constructor(e=0,t=0){2===e.length?(this.x=e[0],this.y=e[1]):(this.x=e,this.y=t);}}ef.ZERO=Object.freeze(new ef(0,0)),ef.HALF=Object.freeze(new ef(.5,.5)),ef.ONE=Object.freeze(new ef(1,1)),ef.UP=Object.freeze(new ef(0,1)),ef.DOWN=Object.freeze(new ef(0,-1)),ef.RIGHT=Object.freeze(new ef(1,0)),ef.LEFT=Object.freeze(new ef(-1,0));class ep{add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this.w=e.w/t.w,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this.w/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(e,t,i){return this.x=e.x+i*(t.x-e.x),this.y=e.y+i*(t.y-e.y),this.z=e.z+i*(t.z-e.z),this.w=e.w+i*(t.w-e.w),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this.w=e.w*t.w,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}normalize(e=this){let t=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;if(t>0){let i=1/Math.sqrt(t);this.x=e.x*i,this.y=e.y*i,this.z=e.z*i,this.w=e.w*i;}return this}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this.w=Math.floor(e.w),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this.w=Math.ceil(e.w),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this.w=Math.round(e.w),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}set(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}fromArray(e,t=0){return this.x=e[t]??this.x,this.y=e[t+1]??this.y,this.z=e[t+2]??this.z,this.w=e[t+3]??this.w,this}toString(){return `[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}constructor(e=0,t=0,i=0,s=0){4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=i,this.w=s);}}ep.ZERO=Object.freeze(new ep(0,0,0,0)),ep.HALF=Object.freeze(new ep(.5,.5,.5,.5)),ep.ONE=Object.freeze(new ep(1,1,1,1));let em=new ef,e_=new ed,eg=new ed,ev=new ed,eS=new ed;class ey{static _getPerspectiveHalfSize(e,t,i,s,r){r?(e.x=s*Math.tan(t*Math.PI/360),e.y=e.x/i):(e.y=s*Math.tan(t*Math.PI/360),e.x=e.y*i);}add2(e,t){let i=e.data,s=t.data,r=this.data;return r[0]=i[0]+s[0],r[1]=i[1]+s[1],r[2]=i[2]+s[2],r[3]=i[3]+s[3],r[4]=i[4]+s[4],r[5]=i[5]+s[5],r[6]=i[6]+s[6],r[7]=i[7]+s[7],r[8]=i[8]+s[8],r[9]=i[9]+s[9],r[10]=i[10]+s[10],r[11]=i[11]+s[11],r[12]=i[12]+s[12],r[13]=i[13]+s[13],r[14]=i[14]+s[14],r[15]=i[15]+s[15],this}add(e){return this.add2(this,e)}clone(){return new this.constructor().copy(this)}copy(e){let t=e.data,i=this.data;return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],this}equals(e){let t=this.data,i=e.data;return t[0]===i[0]&&t[1]===i[1]&&t[2]===i[2]&&t[3]===i[3]&&t[4]===i[4]&&t[5]===i[5]&&t[6]===i[6]&&t[7]===i[7]&&t[8]===i[8]&&t[9]===i[9]&&t[10]===i[10]&&t[11]===i[11]&&t[12]===i[12]&&t[13]===i[13]&&t[14]===i[14]&&t[15]===i[15]}isIdentity(){let e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]}mul2(e,t){let i,s,r,a,n=e.data,o=t.data,l=this.data,h=n[0],c=n[1],d=n[2],u=n[3],f=n[4],p=n[5],m=n[6],_=n[7],g=n[8],v=n[9],S=n[10],y=n[11],x=n[12],T=n[13],E=n[14],w=n[15];return i=o[0],s=o[1],r=o[2],a=o[3],l[0]=h*i+f*s+g*r+x*a,l[1]=c*i+p*s+v*r+T*a,l[2]=d*i+m*s+S*r+E*a,l[3]=u*i+_*s+y*r+w*a,i=o[4],s=o[5],r=o[6],a=o[7],l[4]=h*i+f*s+g*r+x*a,l[5]=c*i+p*s+v*r+T*a,l[6]=d*i+m*s+S*r+E*a,l[7]=u*i+_*s+y*r+w*a,i=o[8],s=o[9],r=o[10],a=o[11],l[8]=h*i+f*s+g*r+x*a,l[9]=c*i+p*s+v*r+T*a,l[10]=d*i+m*s+S*r+E*a,l[11]=u*i+_*s+y*r+w*a,i=o[12],s=o[13],r=o[14],a=o[15],l[12]=h*i+f*s+g*r+x*a,l[13]=c*i+p*s+v*r+T*a,l[14]=d*i+m*s+S*r+E*a,l[15]=u*i+_*s+y*r+w*a,this}mulAffine2(e,t){let i,s,r,a=e.data,n=t.data,o=this.data,l=a[0],h=a[1],c=a[2],d=a[4],u=a[5],f=a[6],p=a[8],m=a[9],_=a[10],g=a[12],v=a[13],S=a[14];return i=n[0],s=n[1],r=n[2],o[0]=l*i+d*s+p*r,o[1]=h*i+u*s+m*r,o[2]=c*i+f*s+_*r,o[3]=0,i=n[4],s=n[5],r=n[6],o[4]=l*i+d*s+p*r,o[5]=h*i+u*s+m*r,o[6]=c*i+f*s+_*r,o[7]=0,i=n[8],s=n[9],r=n[10],o[8]=l*i+d*s+p*r,o[9]=h*i+u*s+m*r,o[10]=c*i+f*s+_*r,o[11]=0,i=n[12],s=n[13],r=n[14],o[12]=l*i+d*s+p*r+g,o[13]=h*i+u*s+m*r+v,o[14]=c*i+f*s+_*r+S,o[15]=1,this}mul(e){return this.mul2(this,e)}transformPoint(e,t=new ed){let i=this.data,{x:s,y:r,z:a}=e;return t.x=s*i[0]+r*i[4]+a*i[8]+i[12],t.y=s*i[1]+r*i[5]+a*i[9]+i[13],t.z=s*i[2]+r*i[6]+a*i[10]+i[14],t}transformVector(e,t=new ed){let i=this.data,{x:s,y:r,z:a}=e;return t.x=s*i[0]+r*i[4]+a*i[8],t.y=s*i[1]+r*i[5]+a*i[9],t.z=s*i[2]+r*i[6]+a*i[10],t}transformVec4(e,t=new ep){let i=this.data,{x:s,y:r,z:a,w:n}=e;return t.x=s*i[0]+r*i[4]+a*i[8]+n*i[12],t.y=s*i[1]+r*i[5]+a*i[9]+n*i[13],t.z=s*i[2]+r*i[6]+a*i[10]+n*i[14],t.w=s*i[3]+r*i[7]+a*i[11]+n*i[15],t}setLookAt(e,t,i){ev.sub2(e,t).normalize(),eg.copy(i).normalize(),e_.cross(eg,ev).normalize(),eg.cross(ev,e_);let s=this.data;return s[0]=e_.x,s[1]=e_.y,s[2]=e_.z,s[3]=0,s[4]=eg.x,s[5]=eg.y,s[6]=eg.z,s[7]=0,s[8]=ev.x,s[9]=ev.y,s[10]=ev.z,s[11]=0,s[12]=e.x,s[13]=e.y,s[14]=e.z,s[15]=1,this}setFrustum(e,t,i,s,r,a){let n=2*r,o=t-e,l=s-i,h=a-r,c=this.data;return c[0]=n/o,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=n/l,c[6]=0,c[7]=0,c[8]=(t+e)/o,c[9]=(s+i)/l,c[10]=(-a-r)/h,c[11]=-1,c[12]=0,c[13]=0,c[14]=-n*a/h,c[15]=0,this}setPerspective(e,t,i,s,r){return ey._getPerspectiveHalfSize(em,e,t,i,r),this.setFrustum(-em.x,em.x,-em.y,em.y,i,s)}setOrtho(e,t,i,s,r,a){let n=this.data;return n[0]=2/(t-e),n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2/(s-i),n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=-2/(a-r),n[11]=0,n[12]=-(t+e)/(t-e),n[13]=-(s+i)/(s-i),n[14]=-(a+r)/(a-r),n[15]=1,this}setFromAxisAngle(e,t){t*=ei.DEG_TO_RAD;let{x:i,y:s,z:r}=e,a=Math.cos(t),n=Math.sin(t),o=1-a,l=o*i,h=o*s,c=this.data;return c[0]=l*i+a,c[1]=l*s+n*r,c[2]=l*r-n*s,c[3]=0,c[4]=l*s-n*r,c[5]=h*s+a,c[6]=h*r+n*i,c[7]=0,c[8]=l*r+n*s,c[9]=h*r-i*n,c[10]=o*r*r+a,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this}setTranslate(e,t,i){let s=this.data;return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=e,s[13]=t,s[14]=i,s[15]=1,this}setScale(e,t,i){let s=this.data;return s[0]=e,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=t,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=i,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,this}setViewport(e,t,i,s){let r=this.data;return r[0]=.5*i,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=.5*s,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=.5,r[11]=0,r[12]=e+.5*i,r[13]=t+.5*s,r[14]=.5,r[15]=1,this}setReflection(e,t){let i=e.x,s=e.y,r=e.z,a=this.data;return a[0]=1-2*i*i,a[1]=-2*i*s,a[2]=-2*i*r,a[3]=0,a[4]=-2*i*s,a[5]=1-2*s*s,a[6]=-2*s*r,a[7]=0,a[8]=-2*i*r,a[9]=-2*s*r,a[10]=1-2*r*r,a[11]=0,a[12]=-2*i*t,a[13]=-2*s*t,a[14]=-2*r*t,a[15]=1,this}invert(e=this){let t=e.data,i=t[0],s=t[1],r=t[2],a=t[3],n=t[4],o=t[5],l=t[6],h=t[7],c=t[8],d=t[9],u=t[10],f=t[11],p=t[12],m=t[13],_=t[14],g=t[15],v=i*o-s*n,S=i*l-r*n,y=i*h-a*n,x=s*l-r*o,T=s*h-a*o,E=r*h-a*l,w=c*m-d*p,b=c*_-u*p,A=c*g-f*p,C=d*_-u*m,P=d*g-f*m,I=u*g-f*_,D=v*I-S*P+y*C+x*A-T*b+E*w;if(0===D)this.setIdentity();else {let e=1/D,t=this.data;t[0]=(o*I-l*P+h*C)*e,t[1]=(-s*I+r*P-a*C)*e,t[2]=(m*E-_*T+g*x)*e,t[3]=(-d*E+u*T-f*x)*e,t[4]=(-n*I+l*A-h*b)*e,t[5]=(i*I-r*A+a*b)*e,t[6]=(-p*E+_*y-g*S)*e,t[7]=(c*E-u*y+f*S)*e,t[8]=(n*P-o*A+h*w)*e,t[9]=(-i*P+s*A-a*w)*e,t[10]=(p*T-m*y+g*v)*e,t[11]=(-c*T+d*y-f*v)*e,t[12]=(-n*C+o*b-l*w)*e,t[13]=(i*C-s*b+r*w)*e,t[14]=(-p*x+m*S-_*v)*e,t[15]=(c*x-d*S+u*v)*e;}return this}set(e){let t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this}setIdentity(){let e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}setTRS(e,t,i){let s=t.x,r=t.y,a=t.z,n=t.w,o=i.x,l=i.y,h=i.z,c=s+s,d=r+r,u=a+a,f=s*c,p=s*d,m=s*u,_=r*d,g=r*u,v=a*u,S=n*c,y=n*d,x=n*u,T=this.data;return T[0]=(1-(_+v))*o,T[1]=(p+x)*o,T[2]=(m-y)*o,T[3]=0,T[4]=(p-x)*l,T[5]=(1-(f+v))*l,T[6]=(g+S)*l,T[7]=0,T[8]=(m+y)*h,T[9]=(g-S)*h,T[10]=(1-(f+_))*h,T[11]=0,T[12]=e.x,T[13]=e.y,T[14]=e.z,T[15]=1,this}transpose(e=this){let t=e.data,i=this.data;if(t===i){let e;e=t[1],i[1]=t[4],i[4]=e,e=t[2],i[2]=t[8],i[8]=e,e=t[3],i[3]=t[12],i[12]=e,e=t[6],i[6]=t[9],i[9]=e,e=t[7],i[7]=t[13],i[13]=e,e=t[11],i[11]=t[14],i[14]=e;}else i[0]=t[0],i[1]=t[4],i[2]=t[8],i[3]=t[12],i[4]=t[1],i[5]=t[5],i[6]=t[9],i[7]=t[13],i[8]=t[2],i[9]=t[6],i[10]=t[10],i[11]=t[14],i[12]=t[3],i[13]=t[7],i[14]=t[11],i[15]=t[15];return this}getTranslation(e=new ed){return e.set(this.data[12],this.data[13],this.data[14])}getX(e=new ed){return e.set(this.data[0],this.data[1],this.data[2])}getY(e=new ed){return e.set(this.data[4],this.data[5],this.data[6])}getZ(e=new ed){return e.set(this.data[8],this.data[9],this.data[10])}getScale(e=new ed){return this.getX(e_),this.getY(eg),this.getZ(ev),e.set(e_.length(),eg.length(),ev.length()),e}get scaleSign(){return this.getX(e_),this.getY(eg),this.getZ(ev),e_.cross(e_,eg),0>e_.dot(ev)?-1:1}setFromEulerAngles(e,t,i){e*=ei.DEG_TO_RAD,t*=ei.DEG_TO_RAD,i*=ei.DEG_TO_RAD;let s=Math.sin(-e),r=Math.cos(-e),a=Math.sin(-t),n=Math.cos(-t),o=Math.sin(-i),l=Math.cos(-i),h=this.data;return h[0]=n*l,h[1]=-n*o,h[2]=a,h[3]=0,h[4]=r*o+l*s*a,h[5]=r*l-s*a*o,h[6]=-n*s,h[7]=0,h[8]=s*o-r*l*a,h[9]=l*s+r*a*o,h[10]=r*n,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,this}getEulerAngles(e=new ed){let t,i;this.getScale(eS);let s=eS.x,r=eS.y,a=eS.z;if(0===s||0===r||0===a)return e.set(0,0,0);let n=this.data,o=Math.asin(-n[2]/s),l=.5*Math.PI;return o<l?o>-l?(t=Math.atan2(n[6]/r,n[10]/a),i=Math.atan2(n[1]/s,n[0]/s)):(i=0,t=-Math.atan2(n[4]/r,n[5]/r)):(i=0,t=Math.atan2(n[4]/r,n[5]/r)),e.set(t,o,i).mulScalar(ei.RAD_TO_DEG)}toString(){return `[${this.data.join(", ")}]`}constructor(){this.data=new Float32Array(16),this.data[0]=this.data[5]=this.data[10]=this.data[15]=1;}}ey.IDENTITY=Object.freeze(new ey),ey.ZERO=Object.freeze(new ey().set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));class ex{clone(){return new this.constructor(this.x,this.y,this.z,this.w)}conjugate(e=this){return this.x=-1*e.x,this.y=-1*e.y,this.z=-1*e.z,this.w=e.w,this}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}getAxisAngle(e){let t=2*Math.acos(this.w),i=Math.sin(t/2);return 0!==i?(e.x=this.x/i,e.y=this.y/i,e.z=this.z/i,(e.x<0||e.y<0||e.z<0)&&(e.x*=-1,e.y*=-1,e.z*=-1,t*=-1)):(e.x=1,e.y=0,e.z=0),t*ei.RAD_TO_DEG}getEulerAngles(e=new ed){let t,i,s,r=this.x,a=this.y,n=this.z,o=this.w,l=2*(o*a-r*n);return l<=-0.99999?(t=2*Math.atan2(r,o),i=-Math.PI/2,s=0):l>=.99999?(t=2*Math.atan2(r,o),i=Math.PI/2,s=0):(t=Math.atan2(2*(o*r+a*n),1-2*(r*r+a*a)),i=Math.asin(l),s=Math.atan2(2*(o*n+r*a),1-2*(a*a+n*n))),e.set(t,i,s).mulScalar(ei.RAD_TO_DEG)}invert(e=this){return this.conjugate(e).normalize()}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(e,t,i){let s=(1-i)*(0>e.dot(t)?-1:1);return this.x=e.x*s+t.x*i,this.y=e.y*s+t.y*i,this.z=e.z*s+t.z*i,this.w=e.w*s+t.w*i,this.normalize()}mul(e){let t=this.x,i=this.y,s=this.z,r=this.w,a=e.x,n=e.y,o=e.z,l=e.w;return this.x=r*a+t*l+i*o-s*n,this.y=r*n+i*l+s*a-t*o,this.z=r*o+s*l+t*n-i*a,this.w=r*l-t*a-i*n-s*o,this}mulScalar(e,t=this){return this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this.w=t.w*e,this}mul2(e,t){let i=e.x,s=e.y,r=e.z,a=e.w,n=t.x,o=t.y,l=t.z,h=t.w;return this.x=a*n+i*h+s*l-r*o,this.y=a*o+s*h+r*n-i*l,this.z=a*l+r*h+i*o-s*n,this.w=a*h-i*n-s*o-r*l,this}normalize(e=this){let t=e.length();return 0===t?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this.w=e.w*t),this}set(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this}setFromAxisAngle(e,t){let i=Math.sin(t*=.5*ei.DEG_TO_RAD),s=Math.cos(t);return this.x=i*e.x,this.y=i*e.y,this.z=i*e.z,this.w=s,this}setFromEulerAngles(e,t,i){if(e instanceof ed){let s=e;e=s.x,t=s.y,i=s.z;}let s=.5*ei.DEG_TO_RAD;e*=s,t*=s,i*=s;let r=Math.sin(e),a=Math.cos(e),n=Math.sin(t),o=Math.cos(t),l=Math.sin(i),h=Math.cos(i);return this.x=r*o*h-a*n*l,this.y=a*n*h+r*o*l,this.z=a*o*l-r*n*h,this.w=a*o*h+r*n*l,this}setFromMat4(e){let t,i=e.data,s=i[0],r=i[1],a=i[2],n=i[4],o=i[5],l=i[6],h=i[8],c=i[9],d=i[10];return (s*(o*d-l*c)-r*(n*d-l*h)+a*(n*c-o*h)<0&&(s=-s,r=-r,a=-a),0==(t=s*s+r*r+a*a)||(s*=t=1/Math.sqrt(t),r*=t,a*=t,0==(t=n*n+o*o+l*l)||(n*=t=1/Math.sqrt(t),o*=t,l*=t,0==(t=h*h+c*c+d*d))))?this.set(0,0,0,1):(h*=t=1/Math.sqrt(t),c*=t,(d*=t)<0?s>o?this.set(1+s-o-d,r+n,h+a,l-c):this.set(r+n,1-s+o-d,l+c,h-a):s<-o?this.set(h+a,l+c,1-s-o+d,r-n):this.set(l-c,h-a,r-n,1+s+o+d),this.mulScalar(1/this.length()))}setFromDirections(e,t){let i=1+e.dot(t);return i<Number.EPSILON?(Math.abs(e.x)>Math.abs(e.y)?(this.x=-e.z,this.y=0,this.z=e.x):(this.x=0,this.y=-e.z,this.z=e.y),this.w=0):(this.x=e.y*t.z-e.z*t.y,this.y=e.z*t.x-e.x*t.z,this.z=e.x*t.y-e.y*t.x,this.w=i),this.normalize()}slerp(e,t,i){let s=e.x,r=e.y,a=e.z,n=e.w,o=t.x,l=t.y,h=t.z,c=t.w,d=n*c+s*o+r*l+a*h;if(d<0&&(c=-c,o=-o,l=-l,h=-h,d=-d),Math.abs(d)>=1)return this.w=n,this.x=s,this.y=r,this.z=a,this;let u=Math.acos(d),f=Math.sqrt(1-d*d);if(.001>Math.abs(f))return this.w=.5*n+.5*c,this.x=.5*s+.5*o,this.y=.5*r+.5*l,this.z=.5*a+.5*h,this;let p=Math.sin((1-i)*u)/f,m=Math.sin(i*u)/f;return this.w=n*p+c*m,this.x=s*p+o*m,this.y=r*p+l*m,this.z=a*p+h*m,this}transformVector(e,t=new ed){let i=e.x,s=e.y,r=e.z,a=this.x,n=this.y,o=this.z,l=this.w,h=l*i+n*r-o*s,c=l*s+o*i-a*r,d=l*r+a*s-n*i,u=-a*i-n*s-o*r;return t.x=h*l+-(u*a)+-(c*o)- -(d*n),t.y=c*l+-(u*n)+-(d*a)- -(h*o),t.z=d*l+-(u*o)+-(h*n)- -(c*a),t}fromArray(e,t=0){return this.x=e[t]??this.x,this.y=e[t+1]??this.y,this.z=e[t+2]??this.z,this.w=e[t+3]??this.w,this}toString(){return `[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}constructor(e=0,t=0,i=0,s=1){4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=i,this.w=s);}}ex.IDENTITY=Object.freeze(new ex(0,0,0,1)),ex.ZERO=Object.freeze(new ex(0,0,0,0));let eT=new ed,eE=new ed,ew=new ed,eb=new ed,eA=new ed;class eC{add(e){let t=this.center,i=t.x,s=t.y,r=t.z,a=this.halfExtents,n=a.x,o=a.y,l=a.z,h=i-n,c=i+n,d=s-o,u=s+o,f=r-l,p=r+l,m=e.center,_=m.x,g=m.y,v=m.z,S=e.halfExtents,y=S.x,x=S.y,T=S.z,E=_-y,w=_+y,b=g-x,A=g+x,C=v-T,P=v+T;E<h&&(h=E),w>c&&(c=w),b<d&&(d=b),A>u&&(u=A),C<f&&(f=C),P>p&&(p=P),t.x=(h+c)*.5,t.y=(d+u)*.5,t.z=(f+p)*.5,a.x=(c-h)*.5,a.y=(u-d)*.5,a.z=(p-f)*.5;}copy(e){this.center.copy(e.center),this.halfExtents.copy(e.halfExtents);}clone(){return new eC(this.center,this.halfExtents)}intersects(e){let t=this.getMax(),i=this.getMin(),s=e.getMax(),r=e.getMin();return i.x<=s.x&&t.x>=r.x&&i.y<=s.y&&t.y>=r.y&&i.z<=s.z&&t.z>=r.z}_intersectsRay(e,t){let i=eT.copy(this.getMin()).sub(e.origin),s=eE.copy(this.getMax()).sub(e.origin),r=e.direction;0===r.x?(i.x=i.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,s.x=s.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(i.x/=r.x,s.x/=r.x),0===r.y?(i.y=i.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,s.y=s.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(i.y/=r.y,s.y/=r.y),0===r.z?(i.z=i.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,s.z=s.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(i.z/=r.z,s.z/=r.z);let a=ew.set(Math.min(i.x,s.x),Math.min(i.y,s.y),Math.min(i.z,s.z)),n=eb.set(Math.max(i.x,s.x),Math.max(i.y,s.y),Math.max(i.z,s.z)),o=Math.min(Math.min(n.x,n.y),n.z),l=Math.max(Math.max(a.x,a.y),a.z),h=o>=l&&l>=0;return h&&t.copy(e.direction).mulScalar(l).add(e.origin),h}_fastIntersectsRay(e){let t=e.direction;return eT.sub2(e.origin,this.center),eb.set(Math.abs(eT.x),Math.abs(eT.y),Math.abs(eT.z)),ew.mul2(eT,t),(!(eb.x>this.halfExtents.x)||!(ew.x>=0))&&(!(eb.y>this.halfExtents.y)||!(ew.y>=0))&&(!(eb.z>this.halfExtents.z)||!(ew.z>=0))&&(eA.set(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z)),eE.cross(t,eT),eE.set(Math.abs(eE.x),Math.abs(eE.y),Math.abs(eE.z)),!(eE.x>this.halfExtents.y*eA.z+this.halfExtents.z*eA.y)&&!(eE.y>this.halfExtents.x*eA.z+this.halfExtents.z*eA.x)&&!(eE.z>this.halfExtents.x*eA.y+this.halfExtents.y*eA.x))}intersectsRay(e,t){return t?this._intersectsRay(e,t):this._fastIntersectsRay(e)}setMinMax(e,t){this.center.add2(t,e).mulScalar(.5),this.halfExtents.sub2(t,e).mulScalar(.5);}getMin(){return this._min.copy(this.center).sub(this.halfExtents)}getMax(){return this._max.copy(this.center).add(this.halfExtents)}containsPoint(e){let t=this.center,i=this.halfExtents;return !(e.x<t.x-i.x)&&!(e.x>t.x+i.x)&&!(e.y<t.y-i.y)&&!(e.y>t.y+i.y)&&!(e.z<t.z-i.z)&&!(e.z>t.z+i.z)}closestPoint(e,t=new ed){let i=this.center,s=this.halfExtents;return t.set(Math.max(i.x-s.x,Math.min(e.x,i.x+s.x)),Math.max(i.y-s.y,Math.min(e.y,i.y+s.y)),Math.max(i.z-s.z,Math.min(e.z,i.z+s.z)))}setFromTransformedAabb(e,t,i=false){let s=e.center,r=e.halfExtents,a=t.data,n=a[0],o=a[4],l=a[8],h=a[1],c=a[5],d=a[9],u=a[2],f=a[6],p=a[10];if(i){let e=n*n+o*o+l*l;if(e>0){let t=1/Math.sqrt(e);n*=t,o*=t,l*=t;}if((e=h*h+c*c+d*d)>0){let t=1/Math.sqrt(e);h*=t,c*=t,d*=t;}if((e=u*u+f*f+p*p)>0){let t=1/Math.sqrt(e);u*=t,f*=t,p*=t;}}this.center.set(a[12]+n*s.x+o*s.y+l*s.z,a[13]+h*s.x+c*s.y+d*s.z,a[14]+u*s.x+f*s.y+p*s.z),this.halfExtents.set(Math.abs(n)*r.x+Math.abs(o)*r.y+Math.abs(l)*r.z,Math.abs(h)*r.x+Math.abs(c)*r.y+Math.abs(d)*r.z,Math.abs(u)*r.x+Math.abs(f)*r.y+Math.abs(p)*r.z);}static computeMinMax(e,t,i,s=e.length/3){if(s>0){let r=e[0],a=e[1],n=e[2],o=r,l=a,h=n,c=3*s;for(let t=3;t<c;t+=3){let i=e[t],s=e[t+1],c=e[t+2];i<r&&(r=i),s<a&&(a=s),c<n&&(n=c),i>o&&(o=i),s>l&&(l=s),c>h&&(h=c);}t.set(r,a,n),i.set(o,l,h);}}compute(e,t){eC.computeMinMax(e,eT,eE,t),this.setMinMax(eT,eE);}intersectsBoundingSphere(e){return this._distanceToBoundingSphereSq(e)<=e.radius*e.radius}_distanceToBoundingSphereSq(e){let t=this.getMin(),i=this.getMax(),s=0,r=["x","y","z"];for(let a=0;a<3;++a){let n=0,o=e.center[r[a]],l=t[r[a]],h=i[r[a]],c=0;o<l&&(n+=(c=l-o)*c),o>h&&(n+=(c=o-h)*c),s+=n;}return s}_expand(e,t){eT.add2(this.getMin(),e),eE.add2(this.getMax(),t),this.setMinMax(eT,eE);}constructor(e,t){this.center=new ed,this.halfExtents=new ed(.5,.5,.5),this._min=new ed,this._max=new ed,e&&this.center.copy(e),t&&this.halfExtents.copy(t);}}let eP=new ed,eI=new ed;class eD{containsPoint(e){let t=eP.sub2(e,this.center).lengthSq(),i=this.radius;return t<i*i}intersectsRay(e,t){let i=eP.copy(e.origin).sub(this.center),s=i.dot(eI.copy(e.direction).normalize()),r=i.dot(i)-this.radius*this.radius;if(r>0&&s>0)return  false;let a=s*s-r;if(a<0)return  false;let n=Math.abs(-s-Math.sqrt(a));return t&&t.copy(e.direction).mulScalar(n).add(e.origin),true}intersectsBoundingSphere(e){eP.sub2(e.center,this.center);let t=e.radius+this.radius;return eP.lengthSq()<=t*t}constructor(e=new ed,t=.5){this.center=e,this.radius=t;}}class eR{clone(){return new this.constructor().copy(this)}copy(e){return this.normal.copy(e.normal),this.distance=e.distance,this}intersectsLine(e,t,i){let s=this.distance,r=this.normal.dot(e)+s,a=r/(r-(this.normal.dot(t)+s)),n=a>=0&&a<=1;return n&&i&&i.lerp(e,t,a),n}intersectsRay(e,t){let i=this.normal.dot(e.direction);if(0===i)return  false;let s=-(this.normal.dot(e.origin)+this.distance)/i;return s>=0&&t&&t.copy(e.direction).mulScalar(s).add(e.origin),s>=0}normalize(){let e=1/this.normal.length();return this.normal.mulScalar(e),this.distance*=e,this}set(e,t,i,s){return this.normal.set(e,t,i),this.distance=s,this}setFromPointNormal(e,t){return this.normal.copy(t),this.distance=-this.normal.dot(e),this}constructor(e=ed.UP,t=0){this.normal=new ed,this.normal.copy(e),this.distance=t;}}class eL{clone(){return new this.constructor().copy(this)}copy(e){for(let t=0;t<6;t++)this.planes[t].copy(e.planes[t]);return this}setFromMat4(e){let[t,i,s,r,a,n,o,l,h,c,d,u,f,p,m,_]=e.data,g=this.planes;g[0].set(r-t,l-a,u-h,_-f).normalize(),g[1].set(r+t,l+a,u+h,_+f).normalize(),g[2].set(r+i,l+n,u+c,_+p).normalize(),g[3].set(r-i,l-n,u-c,_-p).normalize(),g[4].set(r-s,l-o,u-d,_-m).normalize(),g[5].set(r+s,l+o,u+d,_+m).normalize();}containsPoint(e){for(let t=0;t<6;t++){let{normal:i,distance:s}=this.planes[t];if(i.dot(e)+s<=0)return  false}return  true}add(e){let t=this.planes,i=e.planes;for(let e=0;e<6;e++)i[e].distance>t[e].distance&&t[e].copy(i[e]);return this}containsSphere(e){let{center:t,radius:i}=e,s=0;for(let e=0;e<6;e++){let{normal:r,distance:a}=this.planes[e],n=r.dot(t)+a;if(n<=-i)return 0;n>i&&s++;}return 6===s?2:1}constructor(){this.planes=[];for(let e=0;e<6;e++)this.planes[e]=new eR;}}class eM{set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.set(e.origin,e.direction)}clone(){return new this.constructor(this.origin,this.direction)}constructor(e,t){this.origin=new ed,this.direction=ed.FORWARD.clone(),e&&this.origin.copy(e),t&&this.direction.copy(t);}}let eO=new eM,eF=new ed,eN=new eD,eB=new ey,ek=new ed,eU=new ed,ez=new ed,eV=new ed,eG=new ed;class eH{set(e,t,i){return this.v0.copy(e),this.v1.copy(t),this.v2.copy(i),this}intersectsRay(e,t){ek.sub2(this.v1,this.v0),eU.sub2(this.v2,this.v0),ez.cross(e.direction,eU);let i=ek.dot(ez);if(i>-1e-6&&i<1e-6)return  false;let s=1/i;eV.sub2(e.origin,this.v0);let r=s*eV.dot(ez);if(r<0||r>1)return  false;eG.cross(eV,ek);let a=s*e.direction.dot(eG);if(a<0||r+a>1)return  false;let n=s*eU.dot(eG);return n>1e-6&&(t instanceof ed&&t.copy(e.direction).mulScalar(n).add(e.origin),true)}toString(){return `[${this.v0.toString()}, ${this.v1.toString()}, ${this.v2.toString()}]`}constructor(e=ed.ZERO,t=ed.ZERO,i=ed.ZERO){this.v0=new ed,this.v1=new ed,this.v2=new ed,this.set(e,t,i);}}let eW=[1,2,4],eX=new Map([[0,{name:"A8",size:1,ldr:true}],[52,{name:"R8",size:1,ldr:true}],[1,{name:"L8",size:1,ldr:true}],[2,{name:"LA8",size:2,ldr:true}],[53,{name:"RG8",size:2,ldr:true}],[3,{name:"RGB565",size:2,ldr:true}],[4,{name:"RGBA5551",size:2,ldr:true}],[5,{name:"RGBA4",size:2,ldr:true}],[6,{name:"RGB8",size:4,ldr:true}],[7,{name:"RGBA8",size:4,ldr:true,srgbFormat:20}],[50,{name:"R16F",size:2}],[51,{name:"RG16F",size:4}],[11,{name:"RGB16F",size:8}],[12,{name:"RGBA16F",size:8}],[13,{name:"RGB32F",size:16}],[14,{name:"RGBA32F",size:16}],[15,{name:"R32F",size:4}],[70,{name:"RG32F",size:8}],[71,{name:"RGB9E5",size:4}],[72,{name:"RG8S",size:2}],[73,{name:"RGBA8S",size:4}],[74,{name:"RGB10A2",size:4}],[75,{name:"RGB10A2U",size:4,isUint:true}],[16,{name:"DEPTH",size:4}],[69,{name:"DEPTH16",size:2}],[17,{name:"DEPTHSTENCIL",size:4}],[18,{name:"111110F",size:4}],[19,{name:"SRGB8",size:4,ldr:true,srgb:true}],[20,{name:"SRGBA8",size:4,ldr:true,srgb:true}],[31,{name:"BGRA8",size:4,ldr:true}],[64,{name:"SBGRA8",size:4,ldr:true,srgb:true}],[8,{name:"DXT1",blockSize:8,ldr:true,srgbFormat:54}],[9,{name:"DXT3",blockSize:16,ldr:true,srgbFormat:55}],[10,{name:"DXT5",blockSize:16,ldr:true,srgbFormat:56}],[21,{name:"ETC1",blockSize:8,ldr:true}],[22,{name:"ETC2_RGB",blockSize:8,ldr:true,srgbFormat:61}],[23,{name:"ETC2_RGBA",blockSize:16,ldr:true,srgbFormat:62}],[24,{name:"PVRTC_2BPP_RGB_1",ldr:true,blockSize:8}],[25,{name:"PVRTC_2BPP_RGBA_1",ldr:true,blockSize:8}],[26,{name:"PVRTC_4BPP_RGB_1",ldr:true,blockSize:8}],[27,{name:"PVRTC_4BPP_RGBA_1",ldr:true,blockSize:8}],[28,{name:"ASTC_4x4",blockSize:16,ldr:true,srgbFormat:63}],[29,{name:"ATC_RGB",blockSize:8,ldr:true}],[30,{name:"ATC_RGBA",blockSize:16,ldr:true}],[65,{name:"BC6H_RGBF",blockSize:16}],[66,{name:"BC6H_RGBUF",blockSize:16}],[67,{name:"BC7_RGBA",blockSize:16,ldr:true,srgbFormat:68}],[54,{name:"DXT1_SRGB",blockSize:8,ldr:true,srgb:true}],[55,{name:"DXT3_SRGBA",blockSize:16,ldr:true,srgb:true}],[56,{name:"DXT5_SRGBA",blockSize:16,ldr:true,srgb:true}],[61,{name:"ETC2_SRGB",blockSize:8,ldr:true,srgb:true}],[62,{name:"ETC2_SRGBA",blockSize:16,ldr:true,srgb:true}],[63,{name:"ASTC_4x4_SRGB",blockSize:16,ldr:true,srgb:true}],[68,{name:"BC7_SRGBA",blockSize:16,ldr:true,srgb:true}],[32,{name:"R8I",size:1,isInt:true}],[34,{name:"R16I",size:2,isInt:true}],[36,{name:"R32I",size:4,isInt:true}],[38,{name:"RG8I",size:2,isInt:true}],[40,{name:"RG16I",size:4,isInt:true}],[42,{name:"RG32I",size:8,isInt:true}],[44,{name:"RGBA8I",size:4,isInt:true}],[46,{name:"RGBA16I",size:8,isInt:true}],[48,{name:"RGBA32I",size:16,isInt:true}],[33,{name:"R8U",size:1,isUint:true}],[35,{name:"R16U",size:2,isUint:true}],[37,{name:"R32U",size:4,isUint:true}],[39,{name:"RG8U",size:2,isUint:true}],[41,{name:"RG16U",size:4,isUint:true}],[43,{name:"RG32U",size:8,isUint:true}],[45,{name:"RGBA8U",size:4,isUint:true}],[47,{name:"RGBA16U",size:8,isUint:true}],[49,{name:"RGBA32U",size:16,isUint:true}]]),eY=e=>eX.get(e)?.blockSize!==void 0,eq=e=>eX.get(e)?.srgb===true,e$=e=>{let t=eX.get(e);return t?.isInt===true||t?.isUint===true},ej={sampler:"sampler2D",returnType:"vec4"},eK={sampler:"usampler2D",returnType:"uvec4"},eZ={sampler:"isampler2D",returnType:"ivec4"},eQ={textureType:"texture_2d<f32>",returnType:"vec4f"},eJ={textureType:"texture_2d<u32>",returnType:"vec4u"},e0={textureType:"texture_2d<i32>",returnType:"vec4i"},e1=e=>{let t=eX.get(e);return t?.isUint?eK:t?.isInt?eZ:ej},e2=e=>{let t=eX.get(e);return t?.isUint?eJ:t?.isInt?e0:eQ},e3=e=>eX.get(e)?.srgbFormat||e,e4=e=>{for(let[t,i]of eX)if(i.srgbFormat===e)return t;return e},e5=e=>{let t=eX.get(e);return !!(t?.ldr&&!t?.srgb)},e8=e=>{switch(e){case 15:case 70:case 13:case 14:return Float32Array;case 36:case 42:case 48:return Int32Array;case 37:case 43:case 49:case 71:case 74:case 75:return Uint32Array;case 34:case 40:case 46:return Int16Array;case 35:case 41:case 47:case 3:case 4:case 5:case 50:case 51:case 11:case 12:return Uint16Array;case 32:case 38:case 44:case 72:case 73:return Int8Array;default:return Uint8Array}},e6="POSITION",e9="NORMAL",e7="TANGENT",te="BLENDWEIGHT",tt="BLENDINDICES",ti="COLOR",ts="TEXCOORD",tr="TEXCOORD0",ta="TEXCOORD1",tn="TEXCOORD2",to="TEXCOORD3",tl="TEXCOORD4",th="TEXCOORD5",tc="TEXCOORD6",td="TEXCOORD7",tu="ATTR0",tf="ATTR1",tp="ATTR2",tm="ATTR3",t_="ATTR4",tg="ATTR5",tv="ATTR6",tS="ATTR7",ty="ATTR8",tx="ATTR9",tT="ATTR10",tE="ATTR11",tw="ATTR12",tb="ATTR13",tA="ATTR14",tC="ATTR15",tP="default",tI="rgbm",tD="rgbe",tR="rgbp",tL="swizzleGGGR",tM="2d-array",tO="cube",tF="cube-array",tN="none",tB="cube",tk="equirect",tU="octahedral",tz="glsl",tV="wgsl",tG=["bool","int","float","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","mat2","mat3","mat4","sampler2D","samplerCube","","sampler2DShadow","samplerCubeShadow","sampler3D","","","","","sampler2DArray","uint","uvec2","uvec3","uvec4","","","","","","","","","","","","","isampler2D","usampler2D","isamplerCube","usamplerCube","isampler3D","usampler3D","isampler2DArray","usampler2DArray"],tH=[["bool"],["i32"],["f32"],["vec2f","vec2<f32>"],["vec3f","vec3<f32>"],["vec4f","vec4<f32>"],["vec2i","vec2<i32>"],["vec3i","vec3<i32>"],["vec4i","vec4<i32>"],["vec2<bool>"],["vec3<bool>"],["vec4<bool>"],["mat2x2f","mat2x2<f32>"],["mat3x3f","mat3x3<f32>"],["mat4x4f","mat4x4<f32>"],["texture_2d<f32>"],["texture_cube<f32>"],["array<f32>"],["texture_depth_2d"],["texture_depth_cube"],["texture_3d<f32>"],["array<vec2<f32>>"],["array<vec3<f32>>"],["array<vec4<f32>>"],["array<mat4x4<f32>>"],["texture_2d_array<f32>"],["u32"],["vec2u","vec2<u32>"],["vec3u","vec3<u32>"],["vec4u","vec4<u32>"],["array<i32>"],["array<u32>"],["array<bool>"],["array<vec2i>","array<vec2<i32>>"],["array<vec2u>","array<vec2<u32>>"],["array<vec2b>","array<vec2<bool>>"],["array<vec3i>","array<vec3<i32>>"],["array<vec3u>","array<vec3<u32>>"],["array<vec3b>","array<vec3<bool>>"],["array<vec4i>","array<vec4<i32>>"],["array<vec4u>","array<vec4<u32>>"],["array<vec4b>","array<vec4<bool>>"],["texture_2d<i32>"],["texture_2d<u32>"],["texture_cube<i32>"],["texture_cube<u32>"],["texture_3d<i32>"],["texture_3d<u32>"],["texture_2d_array<i32>"],["texture_2d_array<u32>"]],tW=new Map;tH.forEach((e,t)=>{e.forEach(e=>tW.set(e,t));});let tX=new Uint8Array([4,4,6,6,6,6,4,4,4,4,4,4,6,6,6,4,4,6,4,4,4,6,6,6,6,4,5,5,5,5,4,5,4,4,5,4,4,5,4,4,5,4,4,5,4,5,4,5,4,5]),tY="webgl2",tq="webgpu",t$="null",tj="ldr_srgb",tK=["view","mesh","mesh_ub"],tZ="default",tQ="_unused_float_uniform",tJ=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Uint16Array],t0=[1,1,2,2,4,4,4,2],t1=[Uint8Array,Uint16Array,Uint32Array],t2=[1,2,4],t3=new Map([["float","f32"],["vec2","vec2f"],["vec3","vec3f"],["vec4","vec4f"],["int","i32"],["ivec2","vec2i"],["ivec3","vec3i"],["ivec4","vec4i"],["uint","u32"],["uvec2","vec2u"],["uvec3","vec3u"],["uvec4","vec4u"]]),t4={};t4[e6]=0,t4[e9]=1,t4[te]=2,t4[tt]=3,t4[ti]=4,t4[tr]=5,t4[ta]=6,t4[tn]=7,t4[to]=8,t4[tl]=9,t4[th]=10,t4[tc]=11,t4[td]=12,t4[e7]=13,t4[tu]=0,t4[tf]=1,t4[tp]=2,t4[tm]=3,t4[t_]=4,t4[tg]=5,t4[tv]=6,t4[tS]=7,t4[ty]=8,t4[tx]=9,t4[tT]=10,t4[tE]=11,t4[tw]=12,t4[tb]=13,t4[tA]=14,t4[tC]=15;let t5=0;class t8{constructor(e,t){this.slot=-1,this.scopeId=null,this.name=e,this.visibility=t;}}class t6 extends t8{}class t9 extends t8{constructor(e,t,i=false){super(e,t),this.format="",this.readOnly=i;}}class t7 extends t8{constructor(e,t,i="2d",s=0,r=true,a=null){super(e,t),this.textureDimension=i,this.sampleType=s,this.hasSampler=r,this.samplerName=a??`${e}_sampler`;}}class ie extends t8{constructor(e,t=7,i="2d",s=true,r=false){super(e,4),this.format=t,this.textureDimension=i,this.write=s,this.read=r;}}class it{destroy(){this.impl.destroy();}getTexture(e){let t=this.textureFormatsMap.get(e);return void 0!==t?this.textureFormats[t]:null}getStorageTexture(e){let t=this.storageTextureFormatsMap.get(e);return void 0!==t?this.storageTextureFormats[t]:null}loseContext(){}constructor(e,t){this.uniformBufferFormats=[],this.textureFormats=[],this.storageTextureFormats=[],this.storageBufferFormats=[],this.id=t5++;let i=0;t.forEach(e=>{e.slot=i++,e instanceof t7&&e.hasSampler&&i++,e instanceof t6?this.uniformBufferFormats.push(e):e instanceof t7?this.textureFormats.push(e):e instanceof ie?this.storageTextureFormats.push(e):e instanceof t9&&this.storageBufferFormats.push(e);}),this.device=e;let s=e.scope;this.bufferFormatsMap=new Map,this.uniformBufferFormats.forEach((e,t)=>this.bufferFormatsMap.set(e.name,t)),this.textureFormatsMap=new Map,this.textureFormats.forEach((e,t)=>{this.textureFormatsMap.set(e.name,t),e.scopeId=s.resolve(e.name);}),this.storageTextureFormatsMap=new Map,this.storageTextureFormats.forEach((e,t)=>{this.storageTextureFormatsMap.set(e.name,t),e.scopeId=s.resolve(e.name);}),this.storageBufferFormatsMap=new Map,this.storageBufferFormats.forEach((e,t)=>{this.storageBufferFormatsMap.set(e.name,t),e.scopeId=s.resolve(e.name);}),this.impl=e.createBindGroupFormatImpl(this);}}class ii{get(e,t){return this._cache.has(e)||(this._cache.set(e,t()),e.on("destroy",()=>{this.remove(e);}),e.on("devicelost",()=>{this._cache.get(e)?.loseContext?.(e);})),this._cache.get(e)}remove(e){this._cache.get(e)?.destroy?.(e),this._cache.delete(e);}constructor(){this._cache=new Map;}}class is{static calcLevelDimension(e,t){return Math.max(e>>t,1)}static calcMipLevelsCount(e,t,i=1){return 1+Math.floor(Math.log2(Math.max(e,t,i)))}static calcLevelGpuSize(e,t,i,s){let r=eX.get(s),a=eX.get(s)?.size??0;if(a>0)return e*t*i*a;let n=r.blockSize??0,o=Math.floor((e+3)/4),l=Math.floor((t+3)/4),h=Math.floor((i+3)/4);return (24===s||25===s)&&(o=Math.max(Math.floor(o/2),1)),o*l*h*n}static calcGpuSize(e,t,i,s,r,a){let n=0;for(;n+=is.calcLevelGpuSize(e,t,i,s),r&&(1!==e||1!==t||1!==i);)e=Math.max(e>>1,1),t=Math.max(t>>1,1),i=Math.max(i>>1,1);return n*(a?6:1)}}class ir{get(e){let t=this.map.get(e);return void 0===t&&(t=this.id++,this.map.set(e,t)),t}constructor(){this.map=new Map,this.id=0;}}let ia=new ir;class io{constructor(e,t=0,i=1,s=0,r=1){this.texture=e,this.baseMipLevel=t,this.mipLevelCount=i,this.baseArrayLayer=s,this.arrayLayerCount=r,this.key=ia.get(`${t}:${i}:${s}:${r}`);}}let il=0;class ih{destroy(){let e=this.device;e&&(e.onTextureDestroyed(this),this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this._gpuSize),this._levels=null,this.device=null);}recreateImpl(e=true){let{device:t}=this;this.impl?.destroy(t),this.impl=null,this.impl=t.createTextureImpl(this),this.dirtyAll(),e&&this.upload();}_clearLevels(){this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null];}resize(e,t,i=1){if(this.width!==e||this.height!==t||this.depth!==i){let s=this.device;this.adjustVramSizeTracking(s._vram,-this._gpuSize),this._gpuSize=0,this.impl.destroy(s),this._clearLevels(),this._width=Math.floor(e),this._height=Math.floor(t),this._depth=Math.floor(i),this._updateNumLevel(),this.impl=s.createTextureImpl(this),this.dirtyAll();}}loseContext(){this.impl.loseContext(),this.dirtyAll();}adjustVramSizeTracking(e,t){e.tex+=t;}propertyChanged(e){this.impl.propertyChanged(e),this.renderVersionDirty=this.device.renderVersion;}_updateNumLevel(){let e=this.mipmaps?is.calcMipLevelsCount(this.width,this.height):1,t=this._numLevelsRequested;this._numLevels=Math.min(t??e,e),this._mipmaps=this._numLevels>1;}get lockedMode(){return this._lockedMode}set minFilter(e){this._minFilter!==e&&(e$(this._format)||(this._minFilter=e,this.propertyChanged(1)));}get minFilter(){return this._minFilter}set magFilter(e){this._magFilter!==e&&(e$(this._format)||(this._magFilter=e,this.propertyChanged(2)));}get magFilter(){return this._magFilter}set addressU(e){this._addressU!==e&&(this._addressU=e,this.propertyChanged(4));}get addressU(){return this._addressU}set addressV(e){this._addressV!==e&&(this._addressV=e,this.propertyChanged(8));}get addressV(){return this._addressV}set addressW(e){this._volume&&e!==this._addressW&&(this._addressW=e,this.propertyChanged(16));}get addressW(){return this._addressW}set compareOnRead(e){this._compareOnRead!==e&&(this._compareOnRead=e,this.propertyChanged(32));}get compareOnRead(){return this._compareOnRead}set compareFunc(e){this._compareFunc!==e&&(this._compareFunc=e,this.propertyChanged(64));}get compareFunc(){return this._compareFunc}set anisotropy(e){this._anisotropy!==e&&(this._anisotropy=e,this.propertyChanged(128));}get anisotropy(){return this._anisotropy}set mipmaps(e){this._mipmaps!==e&&(this.device.isWebGPU||e$(this._format)||(this._mipmaps=e),e&&(this._needsMipmapsUpload=true,this.device?.texturesToUpload?.add(this)));}get mipmaps(){return this._mipmaps}get numLevels(){return this._numLevels}get storage(){return this._storage}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get cubemap(){return this._cubemap}get gpuSize(){let e=this.pot&&this._mipmaps&&!(this._compressed&&1===this._levels.length);return is.calcGpuSize(this._width,this._height,this._depth,this._format,e,this._cubemap)}get array(){return this._arrayLength>0}get arrayLength(){return this._arrayLength}get volume(){return this._volume}set type(e){this._type!==e&&(this._type=e,this.device._shadersDirty=true);}get type(){return this._type}set srgb(e){if(e!==eq(this.format))if(e){let e=e3(this.format);this._format!==e&&(this._format=e,this.recreateImpl(),this.device._shadersDirty=true);}else {let e=e4(this.format);this._format!==e&&(this._format=e,this.recreateImpl(),this.device._shadersDirty=true);}}get srgb(){return eq(this.format)}set flipY(e){this._flipY!==e&&(this._flipY=e,this.markForUpload());}get flipY(){return this._flipY}set premultiplyAlpha(e){this._premultiplyAlpha!==e&&(this._premultiplyAlpha=e,this.markForUpload());}get premultiplyAlpha(){return this._premultiplyAlpha}get pot(){return ei.powerOfTwo(this._width)&&ei.powerOfTwo(this._height)}get encoding(){switch(this.type){case tI:return "rgbm";case tD:return "rgbe";case tR:return "rgbp"}return e5(this.format)?"srgb":"linear"}dirtyAll(){this._levelsUpdated=this._cubemap?[[true,true,true,true,true,true]]:[true],this.markForUpload(),this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=false,this.propertyChanged(255);}lock(e={}){e.level??(e.level=0),e.face??(e.face=0),e.mode??(e.mode=2),this._lockedMode=e.mode,this._lockedLevel=e.level;let t=this.cubemap?this._levels[e.face]:this._levels;if(null===t[e.level]){let i=Math.max(1,this._width>>e.level),s=Math.max(1,this._height>>e.level),r=Math.max(1,this._depth>>e.level),a=new ArrayBuffer(is.calcLevelGpuSize(i,s,r,this._format));t[e.level]=new(e8(this._format))(a);}return t[e.level]}setSource(e,t=0){let i,s,r=false;if(this._cubemap){if(e[0]){i=e[0].width||0,s=e[0].height||0;for(let t=0;t<6;t++){let a=e[t];if(!a||a.width!==i||a.height!==s||!this.device._isBrowserInterface(a)){r=true;break}}}else r=true;if(!r)for(let i=0;i<6;i++)this._levels[t][i]!==e[i]&&(this._levelsUpdated[t][i]=true);}else this.device._isBrowserInterface(e)||(r=true),r||(e!==this._levels[t]&&(this._levelsUpdated[t]=true),e instanceof HTMLVideoElement?(i=e.videoWidth,s=e.videoHeight):(i=e.width,s=e.height));if(r)if(this._width=4,this._height=4,this._cubemap)for(let e=0;e<6;e++)this._levels[t][e]=null,this._levelsUpdated[t][e]=true;else this._levels[t]=null,this._levelsUpdated[t]=true;else 0===t&&(this._width=i,this._height=s),this._levels[t]=e;this._invalid===r&&r||(this._invalid=r,this.upload());}getSource(e=0){return this._levels[e]}unlock(){this._lockedMode,2===this._lockedMode&&this.upload(),this._lockedLevel=-1,this._lockedMode=0;}markForUpload(){this._needsUpload=true,this.device?.texturesToUpload?.add(this);}upload(){this.markForUpload(),this._needsMipmapsUpload=this._mipmaps,this.impl.uploadImmediate?.(this.device,this);}read(e,t,i,s,r={}){return this.impl.read?.(e,t,i,s,r)}write(e,t,i,s,r){return this.impl.write?.(e,t,i,s,r)}getView(e=0,t=1,i=0,s=1){return new io(this,e,t,i,s)}constructor(e,t={}){this._gpuSize=0,this.id=il++,this._invalid=false,this._lockedLevel=-1,this._lockedMode=0,this.renderVersionDirty=0,this._storage=false,this._numLevels=0,this.device=e,this.name=t.name??"",this._width=Math.floor(t.width??4),this._height=Math.floor(t.height??4),this._format=t.format??7,this._compressed=eY(this._format),this._integerFormat=e$(this._format),this._integerFormat&&(t.minFilter=0,t.magFilter=0),this._volume=t.volume??false,this._depth=Math.floor(t.depth??1),this._arrayLength=Math.floor(t.arrayLength??0),this._storage=t.storage??false,this._cubemap=t.cubemap??false,this._flipY=t.flipY??false,this._premultiplyAlpha=t.premultiplyAlpha??false,this._mipmaps=t.mipmaps??true,this._numLevelsRequested=t.numLevels,void 0!==t.numLevels&&(this._numLevels=t.numLevels),this._updateNumLevel(),this._minFilter=t.minFilter??5,this._magFilter=t.magFilter??1,this._anisotropy=t.anisotropy??1,this._addressU=t.addressU??0,this._addressV=t.addressV??0,this._addressW=t.addressW??0,this._compareOnRead=t.compareOnRead??false,this._compareFunc=t.compareFunc??1,this._type=t.type??tP,this.projection=tN,this._cubemap?this.projection=tB:t.projection&&t.projection!==tB&&(this.projection=t.projection),this._levels=t.levels;let i=!!t.levels;this._levels||this._clearLevels(),this.recreateImpl(i);}}let ic={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255],pink:[255,128,255,255]};class id{destroy(){this.map.forEach(e=>{e.destroy();});}constructor(){this.map=new Map;}}let iu=new ii,ip=(e,t)=>{let i=iu.get(e,()=>new id);if(!i.map.has(t)){let s=new ih(e,{name:`built-in-texture-${t}`,width:1,height:1,format:7}),r=s.lock(),a=ic[t];r.set(a),s.unlock(),i.map.set(t,s);}return i.map.get(t)},im=0;class i_{constructor(){this.offsets=[];}}class ig{destroy(){this.impl.destroy(),this.impl=null,this.format=null,this.defaultUniformBuffer=null;}setUniformBuffer(e,t){let i=this.format.bufferFormatsMap.get(e);this.uniformBuffers[i]!==t&&(this.uniformBuffers[i]=t,this.dirty=true);}setStorageBuffer(e,t){let i=this.format.storageBufferFormatsMap.get(e);this.storageBuffers[i]!==t&&(this.storageBuffers[i]=t,this.dirty=true);}setTexture(e,t){let i=this.format.textureFormatsMap.get(e),s=t instanceof io?t.texture:t;this.textures[i]!==t?(this.textures[i]=t,this.dirty=true):this.renderVersionUpdated<s.renderVersionDirty&&(this.dirty=true);}setStorageTexture(e,t){let i=this.format.storageTextureFormatsMap.get(e),s=t instanceof io?t.texture:t;this.storageTextures[i]!==t?(this.storageTextures[i]=t,this.dirty=true):this.renderVersionUpdated<s.renderVersionDirty&&(this.dirty=true);}updateUniformBuffers(){for(let e=0;e<this.uniformBuffers.length;e++)this.uniformBuffers[e].update();}update(){let{textureFormats:e,storageTextureFormats:t,storageBufferFormats:i}=this.format;for(let t=0;t<e.length;t++){let i=e[t],s=i.scopeId.value;!s&&("uSceneDepthMap"===i.name&&(s=ip(this.device,"white")),"uSceneColorMap"===i.name&&(s=ip(this.device,"pink")),s||(s=ip(this.device,"pink"))),this.setTexture(i.name,s);}for(let e=0;e<t.length;e++){let i=t[e],s=i.scopeId.value;this.setStorageTexture(i.name,s);}for(let e=0;e<i.length;e++){let t=i[e],s=t.scopeId.value;this.setStorageBuffer(t.name,s);}this.uniformBufferOffsets.length=this.uniformBuffers.length;for(let e=0;e<this.uniformBuffers.length;e++){let t=this.uniformBuffers[e];this.uniformBufferOffsets[e]=t.offset,this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=true);}this.dirty&&(this.dirty=false,this.renderVersionUpdated=this.device.renderVersion,this.impl.update(this));}constructor(e,t,i){this.renderVersionUpdated=-1,this.uniformBufferOffsets=[],this.id=im++,this.device=e,this.format=t,this.dirty=true,this.impl=e.createBindGroupImpl(this),this.textures=[],this.storageTextures=[],this.storageBuffers=[],this.uniformBuffers=[],this.defaultUniformBuffer=i,i&&this.setUniformBuffer(tZ,i);}}let iv={set:(e,t,i,s=1)=>e&~(s<<i)|t<<i,get:(e,t,i=1)=>e>>t&i,all(e,t,i=1){let s=i<<t;return (e&s)===s},any:(e,t,i=1)=>(e&i<<t)!=0};class iS{set blend(e){this.target0=iv.set(this.target0,+!!e,26);}get blend(){return iv.all(this.target0,26)}setColorBlend(e,t,i){this.target0=iv.set(this.target0,e,0,7),this.target0=iv.set(this.target0,t,3,15),this.target0=iv.set(this.target0,i,7,15);}setAlphaBlend(e,t,i){this.target0=iv.set(this.target0,e,11,7),this.target0=iv.set(this.target0,t,14,15),this.target0=iv.set(this.target0,i,18,15);}setColorWrite(e,t,i,s){this.redWrite=e,this.greenWrite=t,this.blueWrite=i,this.alphaWrite=s;}get colorOp(){return iv.get(this.target0,0,7)}get colorSrcFactor(){return iv.get(this.target0,3,15)}get colorDstFactor(){return iv.get(this.target0,7,15)}get alphaOp(){return iv.get(this.target0,11,7)}get alphaSrcFactor(){return iv.get(this.target0,14,15)}get alphaDstFactor(){return iv.get(this.target0,18,15)}set redWrite(e){this.target0=iv.set(this.target0,+!!e,22);}get redWrite(){return iv.all(this.target0,22)}set greenWrite(e){this.target0=iv.set(this.target0,+!!e,23);}get greenWrite(){return iv.all(this.target0,23)}set blueWrite(e){this.target0=iv.set(this.target0,+!!e,24);}get blueWrite(){return iv.all(this.target0,24)}set alphaWrite(e){this.target0=iv.set(this.target0,+!!e,25);}get alphaWrite(){return iv.all(this.target0,25)}get allWrite(){return iv.get(this.target0,22,15)}copy(e){return this.target0=e.target0,this}clone(){return new this.constructor().copy(this)}get key(){return this.target0}equals(e){return this.target0===e.target0}constructor(e=false,t=0,i=1,s=0,r,a,n,o=true,l=true,h=true,c=true){this.target0=0,this.setColorBlend(t,i,s),this.setAlphaBlend(r??t,a??i,n??s),this.setColorWrite(o,l,h,c),this.blend=e;}}iS.NOBLEND=Object.freeze(new iS),iS.NOWRITE=Object.freeze(new iS(void 0,void 0,void 0,void 0,void 0,void 0,void 0,false,false,false,false)),iS.ALPHABLEND=Object.freeze(new iS(true,0,6,8)),iS.ADDBLEND=Object.freeze(new iS(true,0,1,1));let iy=new ir;class ix{set test(e){this.func=e?3:7,this.updateKey();}get test(){return 7!==this.func}set write(e){this.data=iv.set(this.data,+!!e,3),this.updateKey();}get write(){return iv.all(this.data,3)}set func(e){this.data=iv.set(this.data,e,0,7),this.updateKey();}get func(){return iv.get(this.data,0,7)}set depthBias(e){this._depthBias=e,this.updateKey();}get depthBias(){return this._depthBias}set depthBiasSlope(e){this._depthBiasSlope=e,this.updateKey();}get depthBiasSlope(){return this._depthBiasSlope}copy(e){return this.data=e.data,this._depthBias=e._depthBias,this._depthBiasSlope=e._depthBiasSlope,this.key=e.key,this}clone(){return new this.constructor().copy(this)}updateKey(){let{data:e,_depthBias:t,_depthBiasSlope:i}=this,s=`${e}-${t}-${i}`;this.key=iy.get(s);}equals(e){return this.key===e.key}constructor(e=3,t=true){this.data=0,this._depthBias=0,this._depthBiasSlope=0,this.key=0,this.func=e,this.write=t;}}ix.DEFAULT=Object.freeze(new ix),ix.NODEPTH=Object.freeze(new ix(7,false)),ix.WRITEDEPTH=Object.freeze(new ix(7,true));class iT{equals(e){return this.globalId===e.globalId&&this.revision===e.revision}copy(e){this.globalId=e.globalId,this.revision=e.revision;}reset(){this.globalId=0,this.revision=0;}constructor(){this.globalId=0,this.revision=0;}}let iE=0;class iw{increment(){this.version.revision++;}constructor(){iE++,this.version=new iT,this.version.globalId=iE;}}class ib{toJSON(e){}setValue(e){this.value=e,this.versionObject.increment();}getValue(){return this.value}constructor(e){this.name=e,this.value=null,this.versionObject=new iw;}}class iA{resolve(e){return this.variables.has(e)||this.variables.set(e,new ib(e)),this.variables.get(e)}removeValue(e){for(let t of this.variables.values())t.value===e&&(t.value=null);}constructor(e){this.name=e,this.variables=new Map;}}let iC=0;class iP{destroy(){let e=this.device;e.buffers.delete(this),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength));}adjustVramSizeTracking(e,t){e.vb+=t;}loseContext(){this.impl.loseContext();}getFormat(){return this.format}getUsage(){return this.usage}getNumVertices(){return this.numVertices}lock(){return this.storage}unlock(){this.impl.unlock(this);}setData(e){return e.byteLength===this.numBytes&&(this.storage=e,this.unlock(),true)}constructor(e,t,i,s){this.usage=0,this.usage=s?.usage??0,this.device=e,this.format=t,this.numVertices=i,this.id=iC++,this.impl=e.createVertexBufferImpl(this,t,s),this.numBytes=t.verticesByteSize?t.verticesByteSize:t.size*i,this.adjustVramSizeTracking(e._vram,this.numBytes);let r=s?.data;r?this.setData(r):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.add(this);}}function iI(e){if(null==e)return 0;let t=0;for(let i=0,s=e.length;i<s;i++)t=(t<<5)-t+e.charCodeAt(i)|0;return t}function iD(e){let t=0x811c9dc5;for(let i=0;i<e.length;i++)t^=e[i],t*=0x1000193;return t>>>0}let iR=new ir,iL=[2,4,8,12,16],iM=new ii;class iO{get elements(){return this._elements}static getDefaultInstancingFormat(e){return iM.get(e,()=>new iO(e,[{semantic:tE,components:4,type:6},{semantic:tw,components:4,type:6},{semantic:tA,components:4,type:6},{semantic:tC,components:4,type:6}]))}static isElementValid(e,t){let i=t.components*t0[t.type];return !e.isWebGPU||!!iL.includes(i)}update(){this._evaluateHash();}_evaluateHash(){let e=[],t=[],i=this._elements.length;for(let s=0;s<i;s++){let{name:i,dataType:r,numComponents:a,normalize:n,offset:o,stride:l,size:h,asInt:c}=this._elements[s],d=i+r+a+n+c;e.push(d);let u=d+o+l+h;t.push(u);}e.sort();let s=e.join();this.batchingHash=iI(s),this.shaderProcessingHashString=s,this.renderingHashString=t.join("_"),this.renderingHash=iR.get(this.renderingHashString);}constructor(e,t,i){this.device=e,this._elements=[],this.hasUv0=false,this.hasUv1=false,this.hasColor=false,this.hasTangents=false,this.verticesByteSize=0,this.vertexCount=i,this.interleaved=void 0===i,this.instancing=false,this.size=t.reduce((e,t)=>e+4*Math.ceil(t.components*t0[t.type]/4),0);let s=0,r;for(let e=0,a=t.length;e<a;e++){let a=t[e];r=a.components*t0[a.type],i&&(s=ei.roundUp(s,r));let n=a.asInt??false,o=!n&&(a.normalize??false),l={name:a.semantic,offset:i?s:a.hasOwnProperty("offset")?a.offset:s,stride:i?r:a.hasOwnProperty("stride")?a.stride:this.size,dataType:a.type,numComponents:a.components,normalize:o,size:r,asInt:n};this._elements.push(l),i?s+=r*i:s+=4*Math.ceil(r/4),a.semantic===tr?this.hasUv0=true:a.semantic===ta?this.hasUv1=true:a.semantic===ti?this.hasColor=true:a.semantic===e7&&(this.hasTangents=true);}i&&(this.verticesByteSize=s),this._evaluateHash();}}let iF=new ir;class iN{set func(e){this._func=e,this._dirty=true;}get func(){return this._func}set ref(e){this._ref=e,this._dirty=true;}get ref(){return this._ref}set fail(e){this._fail=e,this._dirty=true;}get fail(){return this._fail}set zfail(e){this._zfail=e,this._dirty=true;}get zfail(){return this._zfail}set zpass(e){this._zpass=e,this._dirty=true;}get zpass(){return this._zpass}set readMask(e){this._readMask=e,this._dirty=true;}get readMask(){return this._readMask}set writeMask(e){this._writeMask=e,this._dirty=true;}get writeMask(){return this._writeMask}_evalKey(){let{_func:e,_ref:t,_fail:i,_zfail:s,_zpass:r,_readMask:a,_writeMask:n}=this,o=`${e},${t},${i},${s},${r},${a},${n}`;this._key=iF.get(o),this._dirty=false;}get key(){return this._dirty&&this._evalKey(),this._key}copy(e){return this._func=e._func,this._ref=e._ref,this._readMask=e._readMask,this._writeMask=e._writeMask,this._fail=e._fail,this._zfail=e._zfail,this._zpass=e._zpass,this._dirty=e._dirty,this._key=e._key,this}clone(){return new this.constructor().copy(this)}constructor(e={}){this._dirty=true,this._func=e.func??7,this._ref=e.ref??0,this._readMask=e.readMask??255,this._writeMask=e.writeMask??255,this._fail=e.fail??0,this._zfail=e.zfail??0,this._zpass=e.zpass??0,this._evalKey();}}iN.DEFAULT=Object.freeze(new iN);class iB extends X{postInit(){let e=new iO(this,[{semantic:e6,components:2,type:6}]),t=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this.quadVertexBuffer=new iP(this,e,4,{data:t});}initCapsDefines(){let{capsDefines:e}=this;e.clear(),this.textureFloatFilterable&&e.set("CAPS_TEXTURE_FLOAT_FILTERABLE",""),this.textureFloatRenderable&&e.set("CAPS_TEXTURE_FLOAT_RENDERABLE",""),this.supportsMultiDraw&&e.set("CAPS_MULTI_DRAW",""),this.supportsPrimitiveIndex&&e.set("CAPS_PRIMITIVE_INDEX",""),k.desktop&&e.set("PLATFORM_DESKTOP",""),k.mobile&&e.set("PLATFORM_MOBILE",""),k.android&&e.set("PLATFORM_ANDROID",""),k.ios&&e.set("PLATFORM_IOS","");}destroy(){this.fire("destroy"),this.quadVertexBuffer?.destroy(),this.quadVertexBuffer=null,this.dynamicBuffers?.destroy(),this.dynamicBuffers=null,this.gpuProfiler?.destroy(),this.gpuProfiler=null,this._destroyed=true;}onDestroyShader(e){this.fire("destroy:shader",e);let t=this.shaders.indexOf(e);-1!==t&&this.shaders.splice(t,1);}onTextureDestroyed(e){this.textures.delete(e),this.texturesToUpload.delete(e),this.scope.removeValue(e);}postDestroy(){this.scope=null,this.canvas=null;}loseContext(){for(let e of(this.contextLost=true,this.backBufferSize.set(-1,-1),this.textures))e.loseContext();for(let e of this.buffers)e.loseContext();for(let e of this.targets)e.loseContext();this.gpuProfiler?.loseContext();}restoreContext(){for(let e of(this.contextLost=false,this.initializeRenderState(),this.initializeContextCaches(),this.buffers))e.unlock();this.gpuProfiler?.restoreContext?.();}toJSON(e){}initializeContextCaches(){this.vertexBuffers=[],this.shader=null,this.shaderValid=void 0,this.shaderAsyncCompile=false,this.renderTarget=null;}initializeRenderState(){this.blendState=new iS,this.depthState=new ix,this.cullMode=1,this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.blendColor=new es(0,0,0,0);}setStencilState(e,t){}setBlendState(e){}setBlendColor(e,t,i,s){}setDepthState(e){}setCullMode(e){}setRenderTarget(e){this.renderTarget=e;}setVertexBuffer(e){e&&this.vertexBuffers.push(e);}clearVertexBuffer(){this.vertexBuffers.length=0;}getIndirectDrawSlot(e=1){return 0}get indirectDrawBuffer(){return null}getIndirectDispatchSlot(e=1){return 0}get indirectDispatchBuffer(){return null}getRenderTarget(){return this.renderTarget}initRenderTarget(e){e.initialized||(e.init(),this.targets.add(e));}draw(e,t,i,s,r=true,a=true){}_isBrowserInterface(e){return this._isImageBrowserInterface(e)||this._isImageCanvasInterface(e)||this._isImageVideoInterface(e)}_isImageBrowserInterface(e){return "undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement}_isImageCanvasInterface(e){return "undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement}_isImageVideoInterface(e){return "undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement}resizeCanvas(e,t){let i=Math.min(this._maxPixelRatio,k.browser?window.devicePixelRatio:1),s=Math.floor(e*i),r=Math.floor(t*i);(s!==this.canvas.width||r!==this.canvas.height)&&this.setResolution(s,r);}setResolution(e,t){this.canvas.width=e,this.canvas.height=t,this.fire(iB.EVENT_RESIZE,e,t);}update(){this.updateClientRect();}updateClientRect(){if(k.worker)this.clientRect.width=this.canvas.width,this.clientRect.height=this.canvas.height;else {let e=this.canvas.getBoundingClientRect();this.clientRect.width=e.width,this.clientRect.height=e.height;}}get width(){return this.canvas.width}get height(){return this.canvas.height}set fullscreen(e){}get fullscreen(){return  false}set maxPixelRatio(e){this._maxPixelRatio=e;}get maxPixelRatio(){return this._maxPixelRatio}get deviceType(){return this._deviceType}startRenderPass(e){}endRenderPass(e){}startComputePass(e){}endComputePass(){}frameStart(){this.renderPassIndex=0,this.renderVersion++;}frameEnd(){this.mapsToClear.forEach(e=>e.clear()),this.mapsToClear.clear();}computeDispatch(e,t="Unnamed"){}getRenderableHdrFormat(e=[18,12,14],t=true,i=1){for(let s=0;s<e.length;s++){let r=e[s];switch(r){case 18:if(this.textureRG11B10Renderable)return r;break;case 12:if(this.textureHalfFloatRenderable)return r;break;case 14:if(this.isWebGPU&&i>1)continue;if(this.textureFloatRenderable&&(!t||this.textureFloatFilterable))return r}}}validateAttributes(e,t,i){}constructor(e,t){var i,s,r,a,n,o;super(),this.backBuffer=null,this.backBufferSize=new ef,this.backBufferAntialias=false,this.isWebGPU=false,this.isWebGL2=false,this.isNull=false,this.isHdr=false,this.maxIndirectDrawCount=1024,this.maxIndirectDispatchCount=256,this.maxColorAttachments=1,this.maxSamples=1,this.supportsMultiDraw=true,this.supportsCompute=false,this.supportsStorageTextureRead=false,this.supportsSubgroupUniformity=false,this.supportsSubgroupId=false,this.renderTarget=null,this.shaders=[],this.textures=new Set,this.texturesToUpload=new Set,this.targets=new Set,this.renderVersion=0,this.insideRenderPass=false,this.supportsUniformBuffers=false,this.supportsClipDistances=false,this.supportsPrimitiveIndex=false,this.textureRG11B10Renderable=false,this.textureFloatFilterable=false,this.blendState=new iS,this.depthState=new ix,this.stencilEnabled=false,this.stencilFront=new iN,this.stencilBack=new iN,this._destroyed=false,this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3},this.clientRect={width:0,height:0},this._shadersDirty=false,this.capsDefines=new Map,this.mapsToClear=new Set,this.canvas=e,"setAttribute"in e&&e.setAttribute("data-engine",`PlayCanvas ${w}`),this.initOptions={...t},(i=this.initOptions).alpha??(i.alpha=true),(s=this.initOptions).depth??(s.depth=true),(r=this.initOptions).stencil??(r.stencil=true),(a=this.initOptions).antialias??(a.antialias=true),(n=this.initOptions).powerPreference??(n.powerPreference="high-performance"),(o=this.initOptions).displayFormat??(o.displayFormat="ldr"),this._maxPixelRatio=k.browser?Math.min(1,window.devicePixelRatio):1,this.buffers=new Set,this._vram={tex:0,vb:0,ib:0,ub:0,sb:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.initializeContextCaches(),this._drawCallsPerFrame=0,this._shaderSwitchesPerFrame=0,this._primsPerFrame=[];for(let e=0;e<=6;e++)this._primsPerFrame[e]=0;this._renderTargetCreationTime=0,this.scope=new iA("Device"),this.textureBias=this.scope.resolve("textureBias"),this.textureBias.setValue(0);}}iB.EVENT_RESIZE="resizecanvas";let ik=0;class iU{destroy(){let e=this._device;e&&(e.targets.delete(this),e.renderTarget===this&&e.setRenderTarget(null),this.destroyFrameBuffers());}destroyFrameBuffers(){let e=this._device;e&&this.impl.destroy(e);}destroyTextureBuffers(){this._depthBuffer?.destroy(),this._depthBuffer=null,this._colorBuffers?.forEach(e=>{e.destroy();}),this._colorBuffers=null,this._colorBuffer=null;}resize(e,t){if(!(this.mipLevel>0)&&(this._depthBuffer?.resize(e,t),this._colorBuffers?.forEach(i=>{i.resize(e,t);}),this._width!==e||this._height!==t)){this.destroyFrameBuffers();let e=this._device;e.renderTarget===this&&e.setRenderTarget(null),this.evaluateDimensions(),this.validateMrt(),this.impl=e.createRenderTargetImpl(this);}}validateMrt(){}evaluateDimensions(){let e=this._colorBuffer??this._depthBuffer;e&&(this._width=e.width,this._height=e.height,this._mipLevel>0&&(this._width=is.calcLevelDimension(this._width,this._mipLevel),this._height=is.calcLevelDimension(this._height,this._mipLevel)));}init(){this.impl.init(this._device,this);}get initialized(){return this.impl.initialized}get device(){return this._device}loseContext(){this.impl.loseContext();}resolve(e=true,t=!!this._depthBuffer){this._device&&this._samples>1&&this.impl.resolve(this._device,this,e,t);}copy(e,t,i){if(!this._device)if(!e._device)return  false;else this._device=e._device;return this._device.copyRenderTarget(e,this,t,i)}get samples(){return this._samples}get depth(){return this._depth}get stencil(){return this._stencil}get colorBuffer(){return this._colorBuffer}getColorBuffer(e){return this._colorBuffers?.[e]}get depthBuffer(){return this._depthBuffer}get face(){return this._face}get mipLevel(){return this._mipLevel}get mipmaps(){return this._mipmaps}get width(){return this._width??this._device.width}get height(){return this._height??this._device.height}isColorBufferSrgb(e=0){if(this.device.backBuffer===this)return eq(this.device.backBufferFormat);let t=this.getColorBuffer(e);return !!t&&eq(t.format)}constructor(e={}){this.id=ik++;let t=e.colorBuffer?.device??e.colorBuffers?.[0].device??e.depthBuffer?.device??e.graphicsDevice;this._device=t;let{maxSamples:i}=this._device;if(this._samples=Math.min(e.samples??1,i),t.isWebGPU&&(this._samples=this._samples>1?i:1),this._colorBuffer=e.colorBuffer,e.colorBuffer&&(this._colorBuffers=[e.colorBuffer]),this._depthBuffer=e.depthBuffer,this._face=e.face??0,this._depthBuffer){let e=this._depthBuffer._format;16===e||69===e?(this._depth=true,this._stencil=false):17===e?(this._depth=true,this._stencil=true):(15===e&&this._depthBuffer.device.isWebGPU&&this._samples>1?this._depth=true:this._depth=false,this._stencil=false);}else this._depth=e.depth??true,this._stencil=e.stencil??false;e.colorBuffers&&!this._colorBuffers&&(this._colorBuffers=[...e.colorBuffers],this._colorBuffer=e.colorBuffers[0]),this.autoResolve=e.autoResolve??true,this.name=e.name,this.name||(this.name=this._colorBuffer?.name),this.name||(this.name=this._depthBuffer?.name),this.name||(this.name="Untitled"),this.flipY=e.flipY??false,this._mipLevel=e.mipLevel??0,this._mipLevel>0&&this._depth&&(this._mipLevel=0),this._mipmaps=void 0===e.mipLevel,this.evaluateDimensions(),this.validateMrt(),this.impl=t.createRenderTargetImpl(this);}}class iz{update(e){this.destroy();let t=e.device,i=this.createDescriptor(t,e);this.bindGroup=t.wgpu.createBindGroup(i);}destroy(){this.bindGroup=null;}createDescriptor(e,t){let i=[],s=t.format,r=t.format.uniformBufferFormats;t.uniformBuffers.forEach((e,t)=>{let s=r[t].slot,a=e.persistent?e.impl.buffer:e.allocation.gpuBuffer.buffer;i.push({binding:s,resource:{buffer:a,offset:0,size:e.format.byteSize}});});let a=t.format.textureFormats;t.textures.forEach((t,r)=>{let n=t instanceof io,o=(n?t.texture:t).impl,l=s.textureFormats[r],h=a[r].slot,c=o.getView(e,n?t:void 0);if(i.push({binding:h,resource:c}),l.hasSampler){let t=o.getSampler(e,l.sampleType);i.push({binding:h+1,resource:t});}});let n=t.format.storageTextureFormats;t.storageTextures.forEach((t,s)=>{let r=t instanceof io,a=(r?t.texture:t).impl,o=n[s].slot,l=a.getView(e,r?t:void 0);i.push({binding:o,resource:l});});let o=t.format.storageBufferFormats;return t.storageBuffers.forEach((e,t)=>{let s=e.impl.buffer,r=o[t].slot;i.push({binding:r,resource:{buffer:s}});}),{layout:t.format.impl.bindGroupLayout,entries:i}}}class iV{static shaderStage(e){let t=0;return 1&e&&(t|=GPUShaderStage.VERTEX),2&e&&(t|=GPUShaderStage.FRAGMENT),4&e&&(t|=GPUShaderStage.COMPUTE),t}}let iG=[];iG[0]="",iG[1]="",iG[2]="",iG[52]="r8unorm",iG[53]="rg8unorm",iG[3]="",iG[4]="",iG[5]="",iG[6]="rgba8unorm",iG[7]="rgba8unorm",iG[8]="bc1-rgba-unorm",iG[9]="bc2-rgba-unorm",iG[10]="bc3-rgba-unorm",iG[11]="",iG[12]="rgba16float",iG[50]="r16float",iG[51]="rg16float",iG[13]="",iG[14]="rgba32float",iG[15]="r32float",iG[70]="rg32float",iG[16]="depth32float",iG[69]="depth16unorm",iG[17]="depth24plus-stencil8",iG[18]="rg11b10ufloat",iG[19]="",iG[20]="rgba8unorm-srgb",iG[21]="",iG[22]="etc2-rgb8unorm",iG[23]="etc2-rgba8unorm",iG[24]="",iG[25]="",iG[26]="",iG[27]="",iG[28]="astc-4x4-unorm",iG[29]="",iG[30]="",iG[31]="bgra8unorm",iG[64]="bgra8unorm-srgb",iG[32]="r8sint",iG[33]="r8uint",iG[34]="r16sint",iG[35]="r16uint",iG[36]="r32sint",iG[37]="r32uint",iG[38]="rg8sint",iG[39]="rg8uint",iG[40]="rg16sint",iG[41]="rg16uint",iG[42]="rg32sint",iG[43]="rg32uint",iG[44]="rgba8sint",iG[45]="rgba8uint",iG[46]="rgba16sint",iG[47]="rgba16uint",iG[48]="rgba32sint",iG[49]="rgba32uint",iG[65]="bc6h-rgb-float",iG[66]="bc6h-rgb-ufloat",iG[67]="bc7-rgba-unorm",iG[71]="rgb9e5ufloat",iG[72]="rg8snorm",iG[73]="rgba8snorm",iG[74]="rgb10a2unorm",iG[75]="rgb10a2uint",iG[54]="bc1-rgba-unorm-srgb",iG[55]="bc2-rgba-unorm-srgb",iG[56]="bc3-rgba-unorm-srgb",iG[61]="etc2-rgb8unorm-srgb",iG[62]="etc2-rgba8unorm-srgb",iG[68]="bc7-rgba-unorm-srgb",iG[63]="astc-4x4-unorm-srgb";let iH=[];iH[0]="filtering",iH[1]="non-filtering",iH[2]="comparison",iH[3]="comparison",iH[4]="comparison";let iW=[];iW[0]="float",iW[1]="unfilterable-float",iW[2]="depth",iW[3]="sint",iW[4]="uint";let iX=new ir;class iY{destroy(){this.bindGroupLayout=null;}loseContext(){}createDescriptor(e){let t=[],i="";return e.uniformBufferFormats.forEach(e=>{let s=iV.shaderStage(e.visibility);i+=`#${e.slot}U:${s}`,t.push({binding:e.slot,visibility:s,buffer:{type:"uniform",hasDynamicOffset:true}});}),e.textureFormats.forEach(e=>{let s=iV.shaderStage(e.visibility),r=e.sampleType,a=e.textureDimension,n=iW[r];if(i+=`#${e.slot}T:${s}-${n}-${a}-false`,t.push({binding:e.slot,visibility:s,texture:{sampleType:n,viewDimension:a,multisampled:false}}),e.hasSampler){let a=iH[r];i+=`#${e.slot+1}S:${s}-${a}`,t.push({binding:e.slot+1,visibility:s,sampler:{type:a}});}}),e.storageTextureFormats.forEach(e=>{let{format:s,textureDimension:r}=e,{read:a,write:n}=e;i+=`#${e.slot}ST:${s}-${r}-${a?"r1":"r0"}-${n?"w1":"w0"}`,t.push({binding:e.slot,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:a?n?"read-write":"read-only":"write-only",format:iG[s],viewDimension:r}});}),e.storageBufferFormats.forEach(e=>{let s=e.readOnly,r=iV.shaderStage(e.visibility);i+=`#${e.slot}SB:${r}-${s?"ro":"rw"}`,t.push({binding:e.slot,visibility:r,buffer:{type:s?"read-only-storage":"storage"}});}),{key:i,desc:{entries:t}}}constructor(e){let t=e.device,{key:i,desc:s}=this.createDescriptor(e);this.key=iX.get(i),this.bindGroupLayout=t.wgpu.createBindGroupLayout(s);}}class iq{destroy(e){this.buffer&&(this.buffer.destroy(),this.buffer=null);}get initialized(){return !!this.buffer}loseContext(){}allocate(e,t){this.buffer=e.wgpu.createBuffer({size:t,usage:this.usageFlags});}unlock(e,t){let i=e.wgpu;if(!this.buffer){let i=t.byteLength+3&-4;this.usageFlags|=GPUBufferUsage.COPY_DST,this.allocate(e,i);}let s=t.byteOffset??0,r=new Uint8Array(t.buffer??t,s,t.byteLength),a=new Uint8Array(this.buffer.size);a.set(r),i.queue.writeBuffer(this.buffer,0,a,0,a.length);}read(e,t,i,s,r){return e.readStorageBuffer(this,t,i,s,r)}write(e,t,i,s,r){e.writeStorageBuffer(this,t,i,s,r);}clear(e,t,i){e.clearStorageBuffer(this,t,i);}constructor(e=0){this.buffer=null,this.usageFlags=0,this.usageFlags=e;}}class i$ extends iq{unlock(e){let t=e.device;super.unlock(t,e.storage);}constructor(e,t){super(16|128*!!t?.storage),this.format=null,this.format=1===e.format?"uint16":"uint32";}}let ij={equals(e,t){if(e.length!==t.length)return  false;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return  false;return  true}},iK=[];iK[0]="sint8",iK[1]="uint8",iK[2]="sint16",iK[3]="uint16",iK[4]="sint32",iK[5]="uint32",iK[6]="float32",iK[7]="float16";let iZ=[];iZ[0]="snorm8",iZ[1]="unorm8",iZ[2]="snorm16",iZ[3]="unorm16",iZ[4]="sint32",iZ[5]="uint32",iZ[6]="float32",iZ[7]="float16";class iQ{get(e,t=null){let i=this.getKey(e,t),s=this.cache.get(i);return s||(s=this.create(e,t),this.cache.set(i,s)),s}getKey(e,t=null){return `${e?.renderingHashString}-${t?.renderingHashString}`}create(e,t){let i=[],s=e=>{let t=e.interleaved,s=e.instancing?"instance":"vertex",r=[],a=e.elements.length;for(let n=0;n<a;n++){let o=e.elements[n],l=t4[o.name],h=o.normalize?iZ:iK;r.push({shaderLocation:l,offset:t?o.offset:0,format:`${h[o.dataType]}${o.numComponents>1?`x${o.numComponents}`:""}`}),t&&n!==a-1||(i.push({attributes:r,arrayStride:o.stride,stepMode:s}),r=[]);}};return e&&s(e),t&&s(t),i}constructor(){this.cache=new Map;}}class iJ{getPipelineLayout(e){let t=[];return e.forEach(e=>{t.push(e.bindGroupLayout);}),this.device.wgpu.createPipelineLayout({bindGroupLayouts:t})}constructor(e){this.device=e;}}let i0=["point-list","line-list",void 0,"line-strip","triangle-list","triangle-strip",void 0],i1=["add","subtract","reverse-subtract","min","max"],i2=["zero","one","src","one-minus-src","dst","one-minus-dst","src-alpha","src-alpha-saturated","one-minus-src-alpha","dst-alpha","one-minus-dst-alpha","constant","one-minus-constant"],i3=["never","less","equal","less-equal","greater","not-equal","greater-equal","always"],i4=["none","back","front"],i5=["keep","zero","replace","increment-clamp","increment-wrap","decrement-clamp","decrement-wrap","invert"],i8=["","uint16","uint32"],i6=class{};class i9 extends iJ{get(e,t,i,s,r,a,n,o,l,h,c,d,u){let f=e.type;s&&3!==f&&5!==f&&(s=void 0);let p=this.lookupHashes;p[0]=f,p[1]=r.id,p[2]=h,p[3]=l.key,p[4]=o.key,p[5]=t?.renderingHash??0,p[6]=i?.renderingHash??0,p[7]=a.impl.key,p[8]=n[0]?.key??0,p[9]=n[1]?.key??0,p[10]=n[2]?.key??0,p[11]=c?d.key:0,p[12]=c?u.key:0,p[13]=s??0;let m=iD(p),_=this.cache.get(m);if(_)for(let e=0;e<_.length;e++){let t=_[e];if(ij.equals(t.hashes,p))return t.pipeline}let g=i0[f],v=this.getPipelineLayout(n),S=this.vertexBufferLayout.get(t,i),y=new i6;return y.hashes=new Uint32Array(p),y.pipeline=this.create(g,s,r,a,v,o,l,S,h,c,d,u),_?_.push(y):_=[y],this.cache.set(m,_),y.pipeline}getBlend(e){let t;return e.blend&&(t={color:{operation:i1[e.colorOp],srcFactor:i2[e.colorSrcFactor],dstFactor:i2[e.colorDstFactor]},alpha:{operation:i1[e.alphaOp],srcFactor:i2[e.alphaSrcFactor],dstFactor:i2[e.alphaDstFactor]}}),t}getDepthStencil(e,t,i,s,r,a){let n,{depth:o,stencil:l}=t;if(o||l){if(n={format:t.impl.depthAttachment.format},o){n.depthWriteEnabled=e.write,n.depthCompare=i3[e.func];let t="triangle-list"===a||"triangle-strip"===a;n.depthBias=t?e.depthBias:0,n.depthBiasSlopeScale=t?e.depthBiasSlope:0;}else n.depthWriteEnabled=false,n.depthCompare="always";l&&i&&(n.stencilReadMas=s.readMask,n.stencilWriteMask=s.writeMask,n.stencilFront={compare:i3[s.func],failOp:i5[s.fail],passOp:i5[s.zpass],depthFailOp:i5[s.zfail]},n.stencilBack={compare:i3[r.func],failOp:i5[r.fail],passOp:i5[r.zpass],depthFailOp:i5[r.zfail]});}return n}create(e,t,i,s,r,a,n,o,l,h,c,d){let u=this.device.wgpu,f=i.impl,p={vertex:{module:f.getVertexShaderModule(),entryPoint:f.vertexEntryPoint,buffers:o},primitive:{topology:e,frontFace:"ccw",cullMode:i4[l]},depthStencil:this.getDepthStencil(n,s,h,c,d,e),multisample:{count:s.samples},layout:r};t&&(p.primitive.stripIndexFormat=i8[t]),p.fragment={module:f.getFragmentShaderModule(),entryPoint:f.fragmentEntryPoint,targets:[]};let m=s.impl.colorAttachments;if(m.length>0){let e=0;a.redWrite&&(e|=GPUColorWrite.RED),a.greenWrite&&(e|=GPUColorWrite.GREEN),a.blueWrite&&(e|=GPUColorWrite.BLUE),a.alphaWrite&&(e|=GPUColorWrite.ALPHA);let t=this.getBlend(a);m.forEach(i=>{p.fragment.targets.push({format:i.format,writeMask:e,blend:t});});}return u.createRenderPipeline(p)}constructor(e){super(e),this.lookupHashes=new Uint32Array(14),this.vertexBufferLayout=new iQ,this.cache=new Map;}}class i7{constructor(){this.pipeline=null,this.hashes=null;}}class se extends iJ{get(e,t){let i=this.lookupHashes;i[0]=e.impl.computeKey,i[1]=t.impl.key;let s=iD(i),r=this.cache.get(s);if(r)for(let e=0;e<r.length;e++){let t=r[e];if(ij.equals(t.hashes,i))return t.pipeline}let a=this.getPipelineLayout([t.impl]),n=new i7;return n.hashes=new Uint32Array(i),n.pipeline=this.create(e,a),r?r.push(n):r=[n],this.cache.set(s,r),n.pipeline}create(e,t){let i=this.device.wgpu,s=e.impl,r={compute:{module:s.getComputeShaderModule(),entryPoint:s.computeEntryPoint},layout:t};return i.createComputePipeline(r)}constructor(...e){super(...e),this.lookupHashes=new Uint32Array(2),this.cache=new Map;}}class st{incRefCount(){this._refCount++;}decRefCount(){this._refCount--;}get refCount(){return this._refCount}constructor(){this._refCount=0;}}class si extends st{constructor(e){super(),this.object=e,this.incRefCount();}}class ss{destroy(){this.cache.forEach(e=>{e.object?.destroy();}),this.cache.clear();}clear(){this.cache.clear();}get(e){let t=this.cache.get(e);return t?(t.incRefCount(),t.object):null}set(e,t){this.cache.set(e,new si(t));}release(e){let t=this.cache.get(e);t&&(t.decRefCount(),0===t.refCount&&(this.cache.delete(e),t.object?.destroy()));}constructor(){this.cache=new Map;}}class sr extends ss{loseContext(e){this.clear();}}let sa=new ii,sn=e=>sa.get(e,()=>new sr),so=new ir;class sl{destroy(){this.multisampledBuffer?.destroy(),this.multisampledBuffer=null;}}class sh{destroy(e){this.depthTextureInternal&&(this.depthTexture?.destroy(),this.depthTexture=null),this.multisampledDepthBuffer&&(this.multisampledDepthBuffer=null,sn(e).release(this.multisampledDepthBufferKey));}constructor(e){this.depthTexture=null,this.depthTextureInternal=false,this.multisampledDepthBuffer=null,this.format=e,this.hasStencil="depth24plus-stencil8"===e;}}class sc{destroy(e){this.initialized=false,this.assignedColorTexture=null,this.colorAttachments.forEach(e=>{e.destroy();}),this.colorAttachments.length=0,this.depthAttachment?.destroy(e),this.depthAttachment=null;}updateKey(){let e=this.renderTarget,t=`${e.samples}:${this.depthAttachment?this.depthAttachment.format:"nodepth"}`;this.colorAttachments.forEach(e=>{t+=`:${e.format}`;}),this.key=so.get(t);}assignColorTexture(e,t){this.assignedColorTexture=t;let i=t.createView({format:e.backBufferViewFormat}),s=this.renderPassDescriptor.colorAttachments[0];this.renderTarget.samples>1?s.resolveTarget=i:s.view=i,this.setColorAttachment(0,void 0,e.backBufferViewFormat),this.updateKey();}setColorAttachment(e,t,i){this.colorAttachments[e]||(this.colorAttachments[e]=new sl),t&&(this.colorAttachments[e].multisampledBuffer=t),i&&(this.colorAttachments[e].format=i);}init(e,t){let i=e.wgpu;this.initDepthStencil(e,i,t),t._colorBuffers&&t._colorBuffers.forEach((e,t)=>{this.setColorAttachment(t,void 0,e.impl.format);}),this.renderPassDescriptor.colorAttachments=[];let s=this.isBackbuffer?1:t._colorBuffers?.length??0;for(let r=0;r<s;++r){let s=this.initColor(e,i,t,r),a=0===r&&this.colorAttachments[0]?.format;(s.view||a)&&this.renderPassDescriptor.colorAttachments.push(s);}this.updateKey(),this.initialized=true;}initDepthStencil(e,t,i){let{samples:s,width:r,height:a,depth:n,depthBuffer:o}=i;if(n||o){let i;if(o)if(this.depthAttachment=new sh(o.impl.format),s>1){let n="depth24plus-stencil8";this.depthAttachment.format=n,this.depthAttachment.hasStencil=true;let l=`${o.id}:${r}:${a}:${s}:${n}`,h=sn(e),c=h.get(l);if(!c){let e={size:[r,a,1],dimension:"2d",sampleCount:s,format:n,usage:GPUTextureUsage.RENDER_ATTACHMENT|(n!==o.impl.format?GPUTextureUsage.TEXTURE_BINDING:0)};c=t.createTexture(e),h.set(l,c);}this.depthAttachment.multisampledDepthBuffer=c,this.depthAttachment.multisampledDepthBufferKey=l,i=c.createView();}else {let e=o.impl.gpuTexture;this.depthAttachment.depthTexture=e,i=e.createView();}else {this.depthAttachment=new sh("depth24plus-stencil8");let e={size:[r,a,1],dimension:"2d",sampleCount:s,format:this.depthAttachment.format,usage:GPUTextureUsage.RENDER_ATTACHMENT};s>1?e.usage|=GPUTextureUsage.TEXTURE_BINDING:e.usage|=GPUTextureUsage.COPY_SRC;let n=t.createTexture(e);this.depthAttachment.depthTexture=n,this.depthAttachment.depthTextureInternal=true,i=n.createView();}this.renderPassDescriptor.depthStencilAttachment={view:i};}}initColor(e,t,i,s){let r={},{samples:a,width:n,height:o,mipLevel:l}=i,h=i.getColorBuffer(s),c=null;if(h&&(c=h.cubemap?h.impl.createView({dimension:"2d",baseArrayLayer:i.face,arrayLayerCount:1,mipLevelCount:1,baseMipLevel:l}):h.impl.createView({mipLevelCount:1,baseMipLevel:l})),a>1){let i={size:[n,o,1],dimension:"2d",sampleCount:a,format:this.isBackbuffer?e.backBufferViewFormat:h.impl.format,usage:GPUTextureUsage.RENDER_ATTACHMENT},l=t.createTexture(i);this.setColorAttachment(s,l,i.format),r.view=l.createView(),r.resolveTarget=c;}else r.view=c;return r}setupForRenderPass(e,t){let i=this.renderPassDescriptor.colorAttachments?.length??0;for(let s=0;s<i;++s){let i=this.renderPassDescriptor.colorAttachments[s],r=e.colorArrayOps[s];i.clearValue=t.isColorBufferSrgb(s)?r.clearValueLinear:r.clearValue,i.loadOp=r.clear?"clear":"load",i.storeOp=r.store?"store":"discard";}let s=this.renderPassDescriptor.depthStencilAttachment;s&&(s.depthClearValue=e.depthStencilOps.clearDepthValue,s.depthLoadOp=e.depthStencilOps.clearDepth?"clear":"load",s.depthStoreOp=e.depthStencilOps.storeDepth?"store":"discard",s.depthReadOnly=false,this.depthAttachment.hasStencil&&(s.stencilClearValue=e.depthStencilOps.clearStencilValue,s.stencilLoadOp=e.depthStencilOps.clearStencil?"clear":"load",s.stencilStoreOp=e.depthStencilOps.storeStencil?"store":"discard",s.stencilReadOnly=false));}loseContext(){this.initialized=false;}resolve(e,t,i,s){}constructor(e){this.initialized=false,this.colorAttachments=[],this.depthAttachment=null,this.assignedColorTexture=null,this.renderPassDescriptor={},this.isBackbuffer=false,this.renderTarget=e;}}let sd=[];sd[2]=1,sd[3]=2,sd[4]=3,sd[5]=4,sd[1]=1,sd[6]=2,sd[7]=3,sd[8]=4,sd[0]=1,sd[9]=2,sd[10]=3,sd[11]=4,sd[12]=8,sd[13]=12,sd[14]=16,sd[26]=1,sd[27]=2,sd[28]=3,sd[29]=4;class su{get isArrayType(){return this.count>0}calculateOffset(e){let t=this.byteSize<=8?this.byteSize:16;this.count&&(t=16),e=ei.roundUp(e,t),this.offset=e/4;}constructor(e,t,i=0){if(this.shortName=e,this.name=i?`${e}[0]`:e,this.type=t,this.numComponents=sd[t],this.updateType=t,i>0)switch(t){case 2:this.updateType=17;break;case 1:this.updateType=30;break;case 26:this.updateType=31;break;case 0:this.updateType=32;break;case 3:this.updateType=21;break;case 6:this.updateType=33;break;case 27:this.updateType=34;break;case 9:this.updateType=35;break;case 4:this.updateType=22;break;case 7:this.updateType=36;break;case 28:this.updateType=37;break;case 10:this.updateType=38;break;case 5:this.updateType=23;break;case 8:this.updateType=39;break;case 29:this.updateType=40;break;case 11:this.updateType=41;break;case 14:this.updateType=24;}this.count=i;let s=this.numComponents;i&&(s=ei.roundUp(s,4)),this.byteSize=4*s,i&&(this.byteSize*=i);}}class sf{get(e){return this.map.get(e)}constructor(e,t){this.byteSize=0,this.map=new Map,this.scope=e.scope,this.uniforms=t;let i=0;for(let e=0;e<t.length;e++){let s=t[e];s.calculateOffset(i),i=4*s.offset+s.byteSize,s.scopeId=this.scope.resolve(s.name),this.map.set(s.name,s);}this.byteSize=ei.roundUp(i,16);}}let sp=/[ \t]*(\battribute\b|\bvarying\b|\buniform\b)/g,sm=/(\battribute\b|\bvarying\b|\bout\b|\buniform\b)[ \t]*([^;]+)(;+)/g,s_=/([\w-]+)\[(.*?)\]/,sg=new Set(["highp","mediump","lowp"]),sv=new Set(["sampler2DShadow","samplerCubeShadow","sampler2DArrayShadow"]),sS={sampler2D:"2d",sampler3D:"3d",samplerCube:tO,samplerCubeShadow:tO,sampler2DShadow:"2d",sampler2DArray:tM,sampler2DArrayShadow:tM,isampler2D:"2d",usampler2D:"2d",isampler3D:"3d",usampler3D:"3d",isamplerCube:tO,usamplerCube:tO,isampler2DArray:tM,usampler2DArray:tM},sy={"2d":"texture2D",[tO]:"textureCube","3d":"texture3D",[tM]:"texture2DArray"},sx=class{constructor(e,t){this.line=e;let i=e.trim().split(/\s+/);if(sg.has(i[0])&&(this.precision=i.shift()),this.type=i.shift(),e.includes(","),e.includes("[")){let e=i.join(" "),s=s_.exec(e);this.name=s[1],this.arraySize=Number(s[2]),isNaN(this.arraySize)&&(t.failed=true);}else this.name=i.shift(),this.arraySize=0;this.isSampler=-1!==this.type.indexOf("sampler"),this.isSignedInt=-1!==this.type.indexOf("isampler"),this.isUnsignedInt=-1!==this.type.indexOf("usampler");}};class sT{static run(e,t,i){let s=new Map,r=sT.extract(t.vshader),a=sT.extract(t.fshader),n=new Map,o=sT.processAttributes(r.attributes,t.attributes,n,t.processingOptions),l=sT.processVaryings(r.varyings,s,true),h=sT.processVaryings(a.varyings,s,false),c=sT.processOuts(a.outs),d=Array.from(new Set(r.uniforms.concat(a.uniforms))).map(e=>new sx(e,i)),u=sT.processUniforms(e,d,t.processingOptions,i),f=`${o}
${l}
${u.code}`,p=r.src.replace("@@@",f),m=`${h}
${c}
${u.code}`;return {vshader:p,fshader:a.src.replace("@@@",m),attributes:n,meshUniformBufferFormat:u.meshUniformBufferFormat,meshBindGroupFormat:u.meshBindGroupFormat}}static extract(e){let t,i=[],s=[],r=[],a=[],n=`@@@
`;for(;null!==(t=sp.exec(e));){let o=t[1];switch(o){case "attribute":case "varying":case "uniform":case "out":{sm.lastIndex=t.index;let l=sm.exec(e);"attribute"===o?i.push(l[2]):"varying"===o?s.push(l[2]):"out"===o?r.push(l[2]):"uniform"===o&&a.push(l[2]),e=sT.cutOut(e,t.index,sm.lastIndex,n),sp.lastIndex=t.index+n.length,n="";}}}return {src:e,attributes:i,varyings:s,outs:r,uniforms:a}}static processUniforms(e,t,i,s){let r=[],a=[];t.forEach(e=>{e.isSampler?r.push(e):a.push(e);});let n=[];a.forEach(e=>{if(!i.hasUniform(e.name)){let t=tG.indexOf(e.type),i=new su(e.name,t,e.arraySize);n.push(i);}}),0===n.length&&n.push(new su(tQ,2));let o=n.length?new sf(e,n):null,l=[];r.forEach(e=>{if(!i.hasTexture(e.name)){let t=0;e.isSignedInt?t=3:e.isUnsignedInt?t=4:("highp"===e.precision&&(t=1),sv.has(e.type)&&(t=2));let i=sS[e.type];l.push(new t7(e.name,3,i,t));}});let h=new it(e,l),c="";return i.uniformFormats.forEach((e,t)=>{e&&(c+=sT.getUniformShaderDeclaration(e,t,0));}),o&&(c+=sT.getUniformShaderDeclaration(o,2,0)),i.bindGroupFormats.forEach((e,t)=>{e&&(c+=sT.getTexturesShaderDeclaration(e,t));}),{code:c+=sT.getTexturesShaderDeclaration(h,1),meshUniformBufferFormat:o,meshBindGroupFormat:h}}static processVaryings(e,t,i){let s="",r=i?"out":"in";return e.forEach((e,a)=>{let n=sT.splitToWords(e),o=n.slice(0,-1).join(" "),l=n[n.length-1];i?t.set(l,a):a=t.get(l),s+=`layout(location = ${a}) ${r} ${o} ${l};
`;}),s}static processOuts(e){let t="";return e.forEach((e,i)=>{t+=`layout(location = ${i}) out ${e};
`;}),t}static getTypeCount(e){let t=parseInt(e.substring(e.length-1),10);return isNaN(t)?1:t}static processAttributes(e,t,i,s){let r="";return e.forEach(e=>{let a=sT.splitToWords(e),n=a[0],o=a[1];if(t.hasOwnProperty(o)){let e,a=t[o],l=t4[a];i.set(l,o);let h=s.getVertexElement(a);if(h){let t=h.dataType;if(6!==t&&7!==t&&!h.normalize&&!h.asInt){let i=sT.getTypeCount(n),s=`_private_${o}`;e=`vec${i} ${o} = vec${i}(${s});
`,o=s;let r=0===t||2===t||4===t;n=1===i?r?"int":"uint":r?`ivec${i}`:`uvec${i}`;}}r+=`layout(location = ${l}) in ${n} ${o};
`,e&&(r+=e);}}),r}static splitToWords(e){return (e=e.replace(/\s+/g," ").trim()).split(" ")}static cutOut(e,t,i,s){return e.substring(0,t)+s+e.substring(i)}static getUniformShaderDeclaration(e,t,i){let s=tK[t],r=`layout(set = ${t}, binding = ${i}, std140) uniform ub_${s} {
`;return e.uniforms.forEach(e=>{let t=tG[e.type];r+=`    ${t} ${e.shortName}${e.count?`[${e.count}]`:""};
`;}),`${r}};
`}static getTexturesShaderDeclaration(e,t){let i="";return e.textureFormats.forEach(e=>{let s=sy[e.textureDimension],r="texture2DArray"===s,a=4===e.sampleType?"u":3===e.sampleType?"i":"";s=`${a}${s}`;let n="",o="";r&&(n="_texture",o=`#define ${e.name} ${a}sampler2DArray(${e.name}${n}, ${e.name}_sampler)
`),i+=`layout(set = ${t}, binding = ${e.slot}) uniform ${s} ${e.name}${n};
`,e.hasSampler&&(i+=`layout(set = ${t}, binding = ${e.slot+1}) uniform sampler ${e.name}_sampler;
`),i+=o;}),i}}let sE=/^[ \t]*(attribute|varying|uniform)[\t ]+/gm,sw=/^[ \t]*(attribute|varying|uniform)[ \t]*([^;]+)(;+)/gm,sb=/^[ \t]*var\s*(?:(<storage,[^>]*>)\s*([\w\d_]+)\s*:\s*(.*?)\s*;|(<(?!storage,)[^>]*>)?\s*([\w\d_]+)\s*:\s*(texture_.*|storage_texture_.*|storage\w.*|external_texture|sampler(?:_comparison)?)\s*;)\s*$/gm,sA=/(?:@interpolate\([^)]*\)\s*)?([\w]+)\s*:\s*([\w<>]+)/,sC=/(@vertex|@fragment)\s*fn\s+\w+\s*\(\s*(\w+)\s*:[\s\S]*?\{/,sP={texture_1d:{viewDimension:"1d",baseSampleType:0},texture_2d:{viewDimension:"2d",baseSampleType:0},texture_2d_array:{viewDimension:tM,baseSampleType:0},texture_3d:{viewDimension:"3d",baseSampleType:0},texture_cube:{viewDimension:tO,baseSampleType:0},texture_cube_array:{viewDimension:tF,baseSampleType:0},texture_multisampled_2d:{viewDimension:"2d",baseSampleType:0},texture_depth_2d:{viewDimension:"2d",baseSampleType:2},texture_depth_2d_array:{viewDimension:tM,baseSampleType:2},texture_depth_cube:{viewDimension:tO,baseSampleType:2},texture_depth_cube_array:{viewDimension:tF,baseSampleType:2},texture_external:{viewDimension:"2d",baseSampleType:1}},sI={f32:"WrappedF32",i32:"WrappedI32",u32:"WrappedU32",vec2f:"WrappedVec2F",vec2i:"WrappedVec2I",vec2u:"WrappedVec2U"},sD=e=>(e=e.replace(/\s+/g," ").trim()).split(/[\s:]+/),sR=/array<([^,]+),\s*([^>]+)>/;class sL{constructor(e,t){this.ubName=null,this.arraySize=0,this.line=e;let i=sD(e);if(i.length<2){t.failed=true;return}if(this.name=i[0],this.type=i.slice(1).join(" "),this.type.includes("array<")){let e=sR.exec(this.type);this.type=e[1].trim(),this.arraySize=Number(e[2]),isNaN(this.arraySize)&&(t.failed=true);}}}let sM=/^\s*var\s+(\w+)\s*:\s*(texture_\w+)(?:<(\w+)>)?;\s*$/,sO=/^\s*var\s+([\w\d_]+)\s*:\s*(texture_storage_2d|texture_storage_2d_array)<([\w\d_]+),\s*(\w+)>\s*;\s*$/,sF=/^\s*var\s*<storage,\s*(read|write)?>\s*([\w\d_]+)\s*:\s*(.*)\s*;\s*$/,sN=/^\s*var\s+([\w\d_]+)\s*:\s*texture_external;\s*$/,sB=/^\s*var\s+([\w\d_]+)\s*:\s*(sampler|sampler_comparison)\s*;\s*$/;class sk{equals(e){return this.name===e.name&&this.type===e.type&&this.isTexture===e.isTexture&&this.isSampler===e.isSampler&&this.isStorageTexture===e.isStorageTexture&&this.isStorageBuffer===e.isStorageBuffer&&this.isExternalTexture===e.isExternalTexture&&this.textureFormat===e.textureFormat&&this.textureDimension===e.textureDimension&&this.sampleType===e.sampleType&&this.textureType===e.textureType&&this.format===e.format&&this.access===e.access&&this.accessMode===e.accessMode&&this.samplerType===e.samplerType&&true}constructor(e,t){this.originalLine=e,this.line=e,this.isTexture=false,this.isSampler=false,this.isStorageTexture=false,this.isStorageBuffer=false,this.isExternalTexture=false,this.type="",this.matchedElements=[];let i=this.line.match(sM);if(i){this.name=i[1],this.type=i[2],this.textureFormat=i[3],this.isTexture=true,this.matchedElements.push(...i);let e=((e,t)=>{let i=sP[e],s=i.baseSampleType;if(0===i.baseSampleType&&"texture_multisampled_2d"!==e)switch(t){case "u32":s=4;break;case "i32":s=3;break;case "f32":s=0;break;case "uff":s=1;}return {viewDimension:i.viewDimension,sampleType:s}})(this.type,this.textureFormat);this.textureDimension=e.viewDimension,this.sampleType=e.sampleType;}let s=this.line.match(sO);s&&(this.isStorageTexture=true,this.name=s[1],this.textureType=s[2],this.format=s[3],this.access=s[4],this.matchedElements.push(...s));let r=this.line.match(sF);r&&(this.isStorageBuffer=true,this.accessMode=r[1]||"none",this.name=r[2],this.type=r[3],this.matchedElements.push(...r));let a=this.line.match(sN);a&&(this.name=a[1],this.isExternalTexture=true,this.matchedElements.push(...r));let n=this.line.match(sB);n&&(this.name=n[1],this.samplerType=n[2],this.isSampler=true,this.matchedElements.push(...n)),0===this.matchedElements.length&&(t.failed=true);}}class sU{static run(e,t,i){let s=new Map,r=sU.extract(t.vshader),a=sU.extract(t.fshader),n=new Map,o=sU.processAttributes(r.attributes,t.attributes,n,t.processingOptions,i),l=sU.processVaryings(r.varyings,s,true,e),h=sU.processVaryings(a.varyings,s,false,e),c=Array.from(new Set(r.uniforms.concat(a.uniforms))).map(e=>new sL(e,i)),d=sU.processUniforms(e,c,t.processingOptions,i);r.src=sU.renameUniformAccess(r.src,c),a.src=sU.renameUniformAccess(a.src,c);let u=sU.mergeResources(r.resources,a.resources,i),f=sU.processResources(e,u,t.processingOptions,i),p=sU.generateFragmentOutputStruct(a.src,e.maxColorAttachments);r.src=sU.copyInputs(r.src,i),a.src=sU.copyInputs(a.src,i);let m=`${o}
${l}
${d.code}
${f.code}
`,_=r.src.replace("@@@",m),g=`${h}
${p}
${d.code}
${f.code}
`;return {vshader:_,fshader:a.src.replace("@@@",g),attributes:n,meshUniformBufferFormat:d.meshUniformBufferFormat,meshBindGroupFormat:f.meshBindGroupFormat}}static extract(e){let t,i=[],s=[],r=[],a=[],n=`@@@
`;for(;null!==(t=sE.exec(e));){let a=t[1];sw.lastIndex=t.index;let o=sw.exec(e);"attribute"===a?i.push(o[2]):"varying"===a?s.push(o[2]):"uniform"===a&&r.push(o[2]),e=sU.cutOut(e,t.index,sw.lastIndex,n),sE.lastIndex=t.index+n.length,n="";}for(;null!==(t=sb.exec(e));)a.push(t[0]),e=sU.cutOut(e,t.index,sb.lastIndex,n),sb.lastIndex=t.index+n.length,n="";return {src:e,attributes:i,varyings:s,uniforms:r,resources:a}}static processUniforms(e,t,i,s){let r=[];t.forEach(e=>{if(i.hasUniform(e.name))e.ubName="ub_view";else {e.ubName="ub_mesh_ub";let t=tW.get(e.type),i=new su(e.name,t,e.arraySize);r.push(i);}}),0===r.length&&r.push(new su(tQ,2));let a=new sf(e,r),n="";return i.uniformFormats.forEach((e,t)=>{e&&(n+=sU.getUniformShaderDeclaration(e,t,0));}),a&&(n+=sU.getUniformShaderDeclaration(a,2,0)),{code:n,meshUniformBufferFormat:a}}static renameUniformAccess(e,t){return t.forEach(t=>{let i=`uniform.${t.name}`,s=`${t.ubName}.${t.name}`,r=RegExp(`\\b${i}\\b`,"g");e=e.replace(r,s);}),e}static mergeResources(e,t,i){let s=e.map(e=>new sk(e,i));return t.map(e=>new sk(e,i)).forEach(e=>{let t=s.find(t=>t.name===e.name);t?t.equals(e)||(i.failed=true):s.push(e);}),s}static processResources(e,t,i,s){let r=[];for(let e=0;e<t.length;e++){let i=t[e];if(i.isTexture){let s=t[e+1],a=s?.isSampler,n=i.sampleType,o=i.textureDimension;r.push(new t7(i.name,3,o,n,a,a?s.name:null)),a&&e++;}if(i.isStorageBuffer){let e="read_write"!==i.accessMode,t=new t9(i.name,3,e);t.format=i.type,r.push(t);}}let a=new it(e,r),n="";return i.bindGroupFormats.forEach((e,t)=>{e&&(n+=sU.getTextureShaderDeclaration(e,t));}),{code:n+=sU.getTextureShaderDeclaration(a,1),meshBindGroupFormat:a}}static getUniformShaderDeclaration(e,t,i){let s=tK[t],r=`struct_ub_${s}`,a=`struct ${r} {
`;return e.uniforms.forEach(e=>{let t=tH[e.type][0];e.count>0?(sI.hasOwnProperty(t)&&(t=sI[t]),a+=`    ${e.shortName}: array<${t}, ${e.count}>,
`):a+=`    ${e.shortName}: ${t},
`;}),a+=`};
@group(${t}) @binding(${i}) var<uniform> ub_${s} : ${r};

`}static getTextureShaderDeclaration(e,t){let i="";return e.textureFormats.forEach(e=>{let s=((e,t)=>{let i,s;if(2===t)switch(e){case "2d":return "texture_depth_2d";case tM:return "texture_depth_2d_array";case tO:return "texture_depth_cube";case tF:return "texture_depth_cube_array"}switch(e){case "1d":i="texture_1d";break;case "2d":i="texture_2d";break;case tM:i="texture_2d_array";break;case "3d":i="texture_3d";break;case tO:i="texture_cube";break;case tF:i="texture_cube_array";}switch(t){case 0:case 1:s="f32";break;case 4:s="u32";break;case 3:s="i32";}return `${i}<${s}>`})(e.textureDimension,e.sampleType);if(i+=`@group(${t}) @binding(${e.slot}) var ${e.name}: ${s};
`,e.hasSampler){let s=2===e.sampleType?"sampler_comparison":"sampler";i+=`@group(${t}) @binding(${e.slot+1}) var ${e.samplerName}: ${s};
`;}}),e.storageBufferFormats.forEach(e=>{let s=e.readOnly?"read":"read_write";i+=`@group(${t}) @binding(${e.slot}) var<storage, ${s}> ${e.name} : ${e.format};
`;}),i}static processVaryings(e,t,i,s){let r="",a="",n="";e.forEach((e,s)=>{let o=e.match(sA);if(o){let l=o[1],h=o[2];i?t.set(l,s):s=t.get(l),r+=`    @location(${s}) ${e},
`,i||(a+=`    var<private> ${l}: ${h};
`,n+=`    ${l} = input.${l};
`);}}),i?r+="    @builtin(position) position : vec4f,\n":(r+="    @builtin(position) position : vec4f,\n    @builtin(front_facing) frontFacing : bool,\n    @builtin(sample_index) sampleIndex : u32,\n",s.supportsPrimitiveIndex&&(r+="    @builtin(primitive_index) primitiveIndex : u32,\n"));let o=s.supportsPrimitiveIndex?`
						var<private> pcPrimitiveIndex: u32;
				`:"",l=s.supportsPrimitiveIndex?`
								pcPrimitiveIndex = input.primitiveIndex;
				`:"",h=i?"":`
						var<private> pcPosition: vec4f;
						var<private> pcFrontFacing: bool;
						var<private> pcSampleIndex: u32;
						${o}
						${a}
						
						// function to copy inputs (varyings) to private global variables
						fn _pcCopyInputs(input: FragmentInput) {
								${n}
								pcPosition = input.position;
								pcFrontFacing = input.frontFacing;
								pcSampleIndex = input.sampleIndex;
								${l}
						}
				`;return `
						struct ${i?"VertexOutput":"FragmentInput"} {
								${r}
						};
						${h}
				`}static generateFragmentOutputStruct(e,t){let i="struct FragmentOutput {\n";for(let e=0;e<t;e++)i+=`    @location(${e}) color${e>0?e:""} : pcOutType${e},
`;return -1!==e.search(/\.fragDepth\s*=/)&&(i+="    @builtin(frag_depth) fragDepth : f32\n"),`${i}};
`}static floatAttributeToInt(e,t){return ({f32:t?"i32":"u32",vec2f:t?"vec2i":"vec2u",vec3f:t?"vec3i":"vec3u",vec4f:t?"vec4i":"vec4u"})[({f32:"f32","vec2<f32>":"vec2f","vec3<f32>":"vec3f","vec4<f32>":"vec4f"})[e]||e]||null}static processAttributes(e,t={},i,s,r){let a="",n="",o="";return e.forEach(e=>{let r=sD(e),l=r[0],h=r[1],c=h;if(t.hasOwnProperty(l)){let r=t[l],d=t4[r];i.set(d,l);let u=s.getVertexElement(r);if(u){let e=u.dataType;6===e||7===e||u.normalize||u.asInt||(h=sU.floatAttributeToInt(h,0===e||2===e||4===e));}a+=`    @location(${d}) ${l}: ${h},
`,n+=`    var<private> ${e};
`,o+=`    ${l} = ${c}(input.${l});
`;}}),`
						struct VertexInput {
								${a}
								@builtin(vertex_index) vertexIndex : u32,       // built-in vertex index
								@builtin(instance_index) instanceIndex : u32    // built-in instance index
						};

						${n}
						var<private> pcVertexIndex: u32;
						var<private> pcInstanceIndex: u32;

						fn _pcCopyInputs(input: VertexInput) {
								${o}
								pcVertexIndex = input.vertexIndex;
								pcInstanceIndex = input.instanceIndex;
						}
				`}static copyInputs(e,t){let i=e.match(sC);if(!i||!i[2])return e;let s=i[2],r=i.index+i[0].length-1;return e.slice(0,r+1)+`
    _pcCopyInputs(${s});`+e.slice(r+1)}static cutOut(e,t,i,s){return e.substring(0,t)+s+e.substring(i)}}let sz=new ir;class sV{destroy(e){this._vertexCode=null,this._fragmentCode=null;}createShaderModule(e,t){return this.shader.device.wgpu.createShaderModule({code:e})}getVertexShaderModule(){return this.createShaderModule(this._vertexCode,"Vertex")}getFragmentShaderModule(){return this.createShaderModule(this._fragmentCode,"Fragment")}getComputeShaderModule(){return this.createShaderModule(this._computeCode,"Compute")}processGLSL(){let e=this.shader,t=sT.run(e.device,e.definition,e);this._vertexCode=this.transpile(t.vshader,"vertex",e.definition.vshader),this._fragmentCode=this.transpile(t.fshader,"fragment",e.definition.fshader),this._vertexCode&&this._fragmentCode?e.ready=true:e.failed=true,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat,e.attributes=t.attributes;}processWGSL(){let e=this.shader,t=sU.run(e.device,e.definition,e);this._vertexCode=t.vshader,this._fragmentCode=t.fshader,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat,e.attributes=t.attributes;}transpile(e,t,i){let s=this.shader.device;if(!s.glslang||!s.twgsl)return null;try{let i=s.glslang.compileGLSL(e,t);return s.twgsl.convertSpirV2WGSL(i)}catch(e){}}get vertexCode(){return this._vertexCode}get fragmentCode(){return this._fragmentCode}get computeKey(){if(void 0===this._computeKey){let e=`${this._computeCode}|${this.computeEntryPoint}`;this._computeKey=sz.get(e);}return this._computeKey}loseContext(){}restoreContext(e,t){}constructor(e){this._vertexCode=null,this._fragmentCode=null,this._computeCode=null,this.vertexEntryPoint="main",this.fragmentEntryPoint="main",this.computeEntryPoint="main",this.shader=e;let t=e.definition;t.shaderLanguage===tV?(t.cshader?(this._computeCode=t.cshader??null,this.computeUniformBufferFormats=t.computeUniformBufferFormats,this.computeBindGroupFormat=t.computeBindGroupFormat,t.computeEntryPoint&&(this.computeEntryPoint=t.computeEntryPoint)):(this.vertexEntryPoint="vertexMain",this.fragmentEntryPoint="fragmentMain",t.processingOptions?this.processWGSL():(this._vertexCode=t.vshader??null,this._fragmentCode=t.fshader??null,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat)),e.ready=true):t.processingOptions&&this.processGLSL();}}let sG=[];sG[0]="repeat",sG[1]="clamp-to-edge",sG[2]="mirror-repeat";let sH=[];sH[0]={level:"nearest",mip:"nearest"},sH[1]={level:"linear",mip:"nearest"},sH[2]={level:"nearest",mip:"nearest"},sH[3]={level:"nearest",mip:"linear"},sH[4]={level:"linear",mip:"nearest"},sH[5]={level:"linear",mip:"linear"};class sW{create(e){let t,i=this.texture,s=e.wgpu,r=i.numLevels;this.desc={size:{width:i.width,height:i.height,depthOrArrayLayers:i.cubemap?6:i.array?i.arrayLength:1},format:this.format,mipLevelCount:r,sampleCount:1,dimension:i.volume?"3d":"2d",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC|(eY(i.format)?0:GPUTextureUsage.RENDER_ATTACHMENT)|(i.storage?GPUTextureUsage.STORAGE_BINDING:0)},this.gpuTexture=s.createTexture(this.desc),17===this.texture.format&&(t={format:"depth24plus",aspect:"depth-only"}),this.view=this.createView(t),this.viewCache.clear();}destroy(e){e.deferDestroy(this.gpuTexture),this.gpuTexture=null,this.view=null,this.viewCache.clear(),this.samplers.length=0;}propertyChanged(e){this.samplers.length=0;}getView(e,t){if(this.uploadImmediate(e,this.texture),t){let e=this.viewCache.get(t.key);return e||(e=this.createView({baseMipLevel:t.baseMipLevel,mipLevelCount:t.mipLevelCount,baseArrayLayer:t.baseArrayLayer,arrayLayerCount:t.arrayLayerCount}),this.viewCache.set(t.key,e)),e}return this.view}createView(e){let t=e??{},i=this.desc,s=this.texture,r={format:t.format??i.format,dimension:t.dimension??(s.cubemap?"cube":s.volume?"3d":s.array?"2d-array":"2d"),aspect:t.aspect??"all",baseMipLevel:t.baseMipLevel??0,mipLevelCount:t.mipLevelCount??i.mipLevelCount,baseArrayLayer:t.baseArrayLayer??0,arrayLayerCount:t.arrayLayerCount??i.depthOrArrayLayers};return this.gpuTexture.createView(r)}getSampler(e,t){let i=this.samplers[t];if(!i){let s=this.texture,r={addressModeU:sG[s.addressU],addressModeV:sG[s.addressV],addressModeW:sG[s.addressW]};!t&&s.compareOnRead&&(t=2),2===t||3===t||4===t?(r.compare="less",r.magFilter="linear",r.minFilter="linear"):1===t||!e.textureFloatFilterable&&(14===s.format||12===s.format)||17===this.texture.format||e$(this.texture.format)?(r.magFilter="nearest",r.minFilter="nearest",r.mipmapFilter="nearest"):(r.magFilter=sH[s.magFilter].level,r.minFilter=sH[s.minFilter].level,r.mipmapFilter=sH[s.minFilter].mip);let a="linear"===r.minFilter&&"linear"===r.magFilter&&"linear"===r.mipmapFilter;r.maxAnisotropy=a?ei.clamp(Math.round(s._anisotropy),1,e.maxTextureAnisotropy):1,i=e.wgpu.createSampler(r),this.samplers[t]=i;}return i}loseContext(){}uploadImmediate(e,t){(t._needsUpload||t._needsMipmapsUpload)&&(this.uploadData(e),t._needsUpload=false,t._needsMipmapsUpload=false);}uploadData(e){let t=this.texture;if(this.desc&&(this.desc.size.width!==t.width||this.desc.size.height!==t.height)&&(this.gpuTexture.destroy(),this.create(e),t.renderVersionDirty=e.renderVersion),t._levels){let i=false,s=false,r=t.numLevels;for(let a=0;a<r;a++){let r=t._levels[a];if(r)if(t.cubemap)for(let t=0;t<6;t++){let n=r[t];n?this.isExternalImage(n)?(this.uploadExternalImage(e,n,a,t),i=true):ArrayBuffer.isView(n)&&(this.uploadTypedArrayData(e,n,a,t),i=true):s=true;}else if(t._volume);else if(t.array)if(t.arrayLength===r.length)for(let s=0;s<t._arrayLength;s++){let t=r[s];this.isExternalImage(t)?(this.uploadExternalImage(e,t,a,s),i=true):ArrayBuffer.isView(t)&&(this.uploadTypedArrayData(e,t,a,s),i=true);}else s=true;else this.isExternalImage(r)?(this.uploadExternalImage(e,r,a,0),i=true):ArrayBuffer.isView(r)&&(this.uploadTypedArrayData(e,r,a,0),i=true);else s=true;}i&&s&&t.mipmaps&&!eY(t.format)&&!e$(t.format)&&e.mipmapRenderer.generate(this),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize);}}isExternalImage(e){return "undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas}uploadExternalImage(e,t,i,s){let r={texture:this.gpuTexture,mipLevel:i,origin:[0,0,s],aspect:"all",premultipliedAlpha:this.texture._premultiplyAlpha},a={width:this.desc.size.width,height:this.desc.size.height,depthOrArrayLayers:1};e.submit(),t instanceof HTMLCanvasElement&&t.getContext("2d"),e.wgpu.queue.copyExternalImageToTexture({source:t,origin:[0,0],flipY:false},r,a);}uploadTypedArrayData(e,t,i,s){let r,a,n=this.texture,o=e.wgpu,l={texture:this.gpuTexture,origin:[0,0,s],mipLevel:i},h=is.calcLevelDimension(n.width,i),c=is.calcLevelDimension(n.height,i);is.calcLevelGpuSize(h,c,1,n.format);let d=eX.get(n.format);if(d.size)r={offset:0,bytesPerRow:d.size*h,rowsPerImage:c},a={width:h,height:c};else if(d.blockSize){let e=e=>Math.floor((e+3)/4);r={offset:0,bytesPerRow:d.blockSize*e(h),rowsPerImage:e(c)},a={width:Math.max(4,h),height:Math.max(4,c)};}e.submit(),o.queue.writeTexture(l,t,r,a);}read(e,t,i,s,r){let a=r.mipLevel??0,n=r.face??0,o=r.data??null,l=r.immediate??false,h=this.texture,c=i*eX.get(h.format).size,d=ei.roundUp(c,256),u=d*s,f=h.device,p=f.createBufferImpl(9);p.allocate(f,u);let m={texture:this.gpuTexture,mipLevel:a,origin:[e,t,n]},_={buffer:p.buffer,offset:0,bytesPerRow:d};return f.getCommandEncoder().copyTextureToBuffer(m,_,{width:i,height:s,depthOrArrayLayers:1}),f.readBuffer(p,u,null,l).then(e=>{let t=e8(h.format),i=o?.buffer??new ArrayBuffer(s*c),r=new Uint8Array(i,o?.byteOffset??0,s*c);for(let t=0;t<s;t++){let i=t*d,s=t*c;r.set(e.subarray(i,i+c),s);}return o??new t(i)})}constructor(e){this.samplers=[],this.viewCache=new Map,this.texture=e,this.format=iG[e.format],this.create(e.device);}}class sX extends iq{unlock(e){let t=e.device;super.unlock(t,e.storageInt32.buffer);}constructor(e){super(64);}}class sY extends iq{unlock(e){let t=e.device;super.unlock(t,e.storage);}constructor(e,t,i){super(32|128*!!i?.storage);}}let sq=/[ \t]*#(ifn?def|if|endif|else|elif|define|undef|extension|include)/g,s$=/define[ \t]+([^\n]+)\r?(?:\n|$)/g,sj=/extension[ \t]+([\w-]+)[ \t]*:[ \t]*(enable|require)/g,sK=/undef[ \t]+([^\n]+)\r?(?:\n|$)/g,sZ=/(ifdef|ifndef|if)[ \t]*([^\r\n]+)\r?\n/g,sQ=/(endif|else|elif)(?:[ \t]+([^\r\n]*))?\r?\n?/g,sJ=/\{?[\w-]+\}?/,s0=/(!|\s)?defined\(([\w-]+)\)/,s1=/!?defined\s*\([^)]*\)/g,s2=/!?defined\s*$/,s3=/([a-z_]\w*)\s*(==|!=|<|<=|>|>=)\s*([\w"']+)/i,s4=/[+\-]/g,s5=/include[ \t]+"([\w-]+)(?:\s*,\s*([\w-]+))?"/g,s8=/\{i\}/g,s6=/(pcFragColor[1-8])\b/g,s9=/^\d+(?:\.\d+)?$/;class s7{static run(e,t=new Map,i={}){s7.sourceName=i.sourceName,e=(e=this.stripComments(e)).split(/\r?\n/).map(e=>e.trimEnd()).join("\n");let s=new Map,r=new Map;if(null===(e=this._preprocess(e,s,r,t,i.stripDefines)))return null;let a=new Map;return s.forEach((e,t)=>{Number.isInteger(parseFloat(e))&&!e.includes(".")&&a.set(t,e);}),e=this.stripComments(e),e=this.stripUnusedColorAttachments(e,i),e=this.RemoveEmptyLines(e),e=this.processArraySize(e,a),e=this.injectDefines(e,r)}static stripUnusedColorAttachments(e,t){if(t.stripUnusedColorAttachments){let t=new Map,i=e.match(s6);if(i?.forEach(e=>{let i=parseInt(e.charAt(e.length-1),10);t.set(i,(t.get(i)??0)+1);}),Array.from(t.values()).some(e=>1===e)){let i=e.split("\n"),s=[];for(let e=0;e<i.length;e++){let r=i[e].match(s6);if(r){let e=parseInt(r[0].charAt(r[0].length-1),10);if(e>0&&1===t.get(e))continue}s.push(i[e]);}e=s.join("\n");}}return e}static stripComments(e){return e.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"$1")}static processArraySize(e,t){return null!==e&&t.forEach((t,i)=>{e=e.replace(RegExp(`\\[${i}\\]`,"g"),`[${t}]`);}),e}static injectDefines(e,t){if(null!==e&&t.size>0){let i=e.split("\n");t.forEach((e,t)=>{let s=RegExp(t,"g");for(let t=0;t<i.length;t++)i[t].includes("#")||(i[t]=i[t].replace(s,e));}),e=i.join("\n");}return e}static RemoveEmptyLines(e){return null!==e&&(e=(e=e.split(/\r?\n/).map(e=>""===e.trim()?"":e).join("\n")).replace(/(\n\n){3,}/g,"\n\n")),e}static _preprocess(e,t=new Map,i,s,r){let a,n=[],o=false;for(;null!==(a=sq.exec(e))&&!o;){let l=a[1];switch(l){case "define":{s$.lastIndex=a.index;let s=s$.exec(e);o||(o=null===s);let l=s[1];sJ.lastIndex=s.index;let h=sJ.exec(l)[0],c=l.substring(h.length).trim();""===c&&(c="true");let d=s7._keep(n),u=r;if(d){let r=h.startsWith("{")&&h.endsWith("}");r&&(u=true),r?i.set(h,c):t.set(h,c),u&&(e=e.substring(0,s.index-1)+e.substring(s$.lastIndex),sq.lastIndex=s.index-1);}u||(sq.lastIndex=s.index+s[0].length);break}case "undef":{sK.lastIndex=a.index;let i=sK.exec(e),s=i[1].trim();s7._keep(n)&&(t.delete(s),r&&(e=e.substring(0,i.index-1)+e.substring(sK.lastIndex),sq.lastIndex=i.index-1)),r||(sq.lastIndex=i.index+i[0].length);break}case "extension":{sj.lastIndex=a.index;let i=sj.exec(e);if(o||(o=null===i),i){let e=i[1];s7._keep(n)&&t.set(e,"true");}sq.lastIndex=i.index+i[0].length;break}case "ifdef":case "ifndef":case "if":{sZ.lastIndex=a.index;let i=sZ.exec(e),s=i[2],r=s7.evaluate(s,t);o||(o=r.error);let h=r.result;"ifndef"===l&&(h=!h),n.push({anyKeep:h,keep:h,start:a.index,end:sZ.lastIndex}),sq.lastIndex=i.index+i[0].length;break}case "endif":case "else":case "elif":{sQ.lastIndex=a.index;let i=sQ.exec(e),s=n.pop();if(!s){o=true;continue}let r=s.keep?e.substring(s.end,a.index):"";e=e.substring(0,s.start)+r+e.substring(sQ.lastIndex),sq.lastIndex=s.start+r.length;let l=i[1];if("else"===l||"elif"===l){let e=false;if(!s.anyKeep)if("else"===l)e=!s.keep;else {let s=s7.evaluate(i[2],t);e=s.result,o||(o=s.error);}n.push({anyKeep:s.anyKeep||e,keep:e,start:sq.lastIndex,end:sq.lastIndex});}break}case "include":{s5.lastIndex=a.index;let i=s5.exec(e);if(o||(o=null===i),!i){o=true;continue}let r=i[1].trim(),l=i[2]?.trim();if(s7._keep(n)){let a=s?.get(r);if(void 0!==a){if(a=this.stripComments(a),l){let e=parseFloat(t.get(l));if(Number.isInteger(e)){let t="";for(let i=0;i<e;i++)t+=a.replace(s8,String(i));a=t;}else o=true;}e=e.substring(0,i.index-1)+a+e.substring(s5.lastIndex),sq.lastIndex=i.index-1;}else {o=true;continue}}}}}return (n.length>0&&(o=true),o)?null:e}static _keep(e){for(let t=0;t<e.length;t++)if(!e[t].keep)return  false;return  true}static evaluateAtomicExpression(e,t){let i=false;e=e.trim();let s=false;if("true"===e)return {result:true,error:i};if("false"===e)return {result:false,error:i};if(s9.test(e))return {result:0!==parseFloat(e),error:i};let r=s0.exec(e);if(r){s="!"===r[1],e=r[2].trim();let a=t.has(e);return {result:s?!a:a,error:i}}let a=s3.exec(e);if(a){let e=t.get(a[1].trim())??a[1].trim(),s=t.get(a[3].trim())??a[3].trim(),r=a[2].trim(),n=false;switch(r){case "==":n=e===s;break;case "!=":n=e!==s;break;case "<":n=e<s;break;case "<=":n=e<=s;break;case ">":n=e>s;break;case ">=":n=e>=s;break;default:i=true;}return {result:n,error:i}}return {result:t.has(e),error:i}}static processParentheses(e,t){let i=false,s=e.trim();for(;s.startsWith("(")&&s.endsWith(")");){let e=0,t=true;for(let i=0;i<s.length-1;i++)if("("===s[i])e++;else if(")"===s[i]&&0==--e){t=false;break}if(t)s=s.slice(1,-1).trim();else break}for(;;){let e=false,r=0,a=0,n=-1,o=-1,l=0;for(let t=0;t<s.length;t++)if("("===s[t]){let i=s.substring(0,t);s2.test(i)?l++:0===l&&(++r>a&&(a=r,n=t),e=true);}else ")"===s[t]&&(l>0?l--:r>0&&(r===a&&-1!==n&&(o=t),r--));if(!e||-1===n||-1===o)break;let h=s.substring(n+1,o),{result:c,error:d}=s7.evaluate(h,t);i=i||d,s=s.substring(0,n)+(c?"true":"false")+s.substring(o+1);}return {expression:s,error:i}}static evaluate(e,t){let i=null===s4.exec(e),s=e,r=false;if(-1!==e.replace(s1,"").indexOf("(")){let i=s7.processParentheses(e,t);s=i.expression,r=i.error;}if(r)return {result:false,error:true};for(let e of s.split("||")){let s=e.split("&&"),r=true;for(let e of s){let{result:i,error:s}=s7.evaluateAtomicExpression(e.trim(),t);if(!i||s){r=false;break}}if(r)return {result:true,error:!i}}return {result:false,error:!i}}}var re=`
#ifndef outType_0
#define outType_0 vec4
#endif
layout(location = 0) out highp outType_0 pcFragColor0;
#if COLOR_ATTACHMENT_1
layout(location = 1) out highp outType_1 pcFragColor1;
#endif
#if COLOR_ATTACHMENT_2
layout(location = 2) out highp outType_2 pcFragColor2;
#endif
#if COLOR_ATTACHMENT_3
layout(location = 3) out highp outType_3 pcFragColor3;
#endif
#if COLOR_ATTACHMENT_4
layout(location = 4) out highp outType_4 pcFragColor4;
#endif
#if COLOR_ATTACHMENT_5
layout(location = 5) out highp outType_5 pcFragColor5;
#endif
#if COLOR_ATTACHMENT_6
layout(location = 6) out highp outType_6 pcFragColor6;
#endif
#if COLOR_ATTACHMENT_7
layout(location = 7) out highp outType_7 pcFragColor7;
#endif
#define gl_FragColor pcFragColor0
#define varying in
#define texture2D texture
#define texture2DBias texture
#define textureCube texture
#define texture2DProj textureProj
#define texture2DLod textureLod
#define texture2DProjLod textureProjLod
#define textureCubeLod textureLod
#define texture2DGrad textureGrad
#define texture2DProjGrad textureProjGrad
#define textureCubeGrad textureGrad
#define utexture2D texture
#define itexture2D texture
#define texture2DLodEXT texture2DLodEXT_is_no_longer_supported_use_texture2DLod_instead
#define texture2DProjLodEXT texture2DProjLodEXT_is_no_longer_supported_use_texture2DProjLod
#define textureCubeLodEXT textureCubeLodEXT_is_no_longer_supported_use_textureCubeLod_instead
#define texture2DGradEXT texture2DGradEXT_is_no_longer_supported_use_texture2DGrad_instead
#define texture2DProjGradEXT texture2DProjGradEXT_is_no_longer_supported_use_texture2DProjGrad_instead
#define textureCubeGradEXT textureCubeGradEXT_is_no_longer_supported_use_textureCubeGrad_instead
#define textureShadow(res, uv) textureGrad(res, uv, vec2(1, 1), vec2(1, 1))
#define SHADOWMAP_PASS(name) name
#define SHADOWMAP_ACCEPT(name) sampler2DShadow name
#define TEXTURE_PASS(name) name
#define TEXTURE_ACCEPT(name) sampler2D name
#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name
#define GL2
`,rt=`
#extension GL_ANGLE_multi_draw : enable
#define attribute in
#define varying out
#define texture2D texture
#define utexture2D texture
#define itexture2D texture
#define GL2
#define VERTEXSHADER
#define TEXTURE_PASS(name) name
#define TEXTURE_ACCEPT(name) sampler2D name
#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name
`,ri=`
#extension GL_EXT_samplerless_texture_functions : require
#ifndef outType_0
#define outType_0 vec4
#endif
#ifndef outType_1
#define outType_1 vec4
#endif
#ifndef outType_2
#define outType_2 vec4
#endif
#ifndef outType_3
#define outType_3 vec4
#endif
#ifndef outType_4
#define outType_4 vec4
#endif
#ifndef outType_5
#define outType_5 vec4
#endif
#ifndef outType_6
#define outType_6 vec4
#endif
#ifndef outType_7
#define outType_7 vec4
#endif
layout(location = 0) out highp outType_0 pcFragColor0;
layout(location = 1) out highp outType_1 pcFragColor1;
layout(location = 2) out highp outType_2 pcFragColor2;
layout(location = 3) out highp outType_3 pcFragColor3;
layout(location = 4) out highp outType_4 pcFragColor4;
layout(location = 5) out highp outType_5 pcFragColor5;
layout(location = 6) out highp outType_6 pcFragColor6;
layout(location = 7) out highp outType_7 pcFragColor7;
#define gl_FragColor pcFragColor0
#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)
#define texture2DBias(res, uv, bias) texture(sampler2D(res, res ## _sampler), uv, bias)
#define texture2DLod(res, uv, lod) textureLod(sampler2D(res, res ## _sampler), uv, lod)
#define textureCube(res, uv) texture(samplerCube(res, res ## _sampler), uv)
#define textureCubeLod(res, uv, lod) textureLod(samplerCube(res, res ## _sampler), uv, lod)
#define textureShadow(res, uv) textureLod(sampler2DShadow(res, res ## _sampler), uv, 0.0)
#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)
#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)
#define texture2DLodEXT texture2DLodEXT_is_no_longer_supported_use_texture2DLod_instead
#define texture2DProjLodEXT texture2DProjLodEXT_is_no_longer_supported_use_texture2DProjLod
#define textureCubeLodEXT textureCubeLodEXT_is_no_longer_supported_use_textureCubeLod_instead
#define texture2DGradEXT texture2DGradEXT_is_no_longer_supported_use_texture2DGrad_instead
#define texture2DProjGradEXT texture2DProjGradEXT_is_no_longer_supported_use_texture2DProjGrad_instead
#define textureCubeGradEXT textureCubeGradEXT_is_no_longer_supported_use_textureCubeGrad_instead
#define SHADOWMAP_PASS(name) name, name ## _sampler
#define SHADOWMAP_ACCEPT(name) texture2D name, sampler name ## _sampler
#define TEXTURE_PASS(name) name, name ## _sampler
#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler
#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT
#define GL2
#define WEBGPU
`,rs=`
#extension GL_EXT_samplerless_texture_functions : require
#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)
#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)
#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)
#define TEXTURE_PASS(name) name, name ## _sampler
#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler
#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT
#define GL2
#define WEBGPU
#define VERTEXSHADER
#define gl_VertexID gl_VertexIndex
#define gl_InstanceID gl_InstanceIndex
`,rr=`
`,ra=`
#define VERTEXSHADER
`,rn=`
vec2 getGrabScreenPos(vec4 clipPos) {
	vec2 uv = (clipPos.xy / clipPos.w) * 0.5 + 0.5;
	#ifdef WEBGPU
		uv.y = 1.0 - uv.y;
	#endif
	return uv;
}
vec2 getImageEffectUV(vec2 uv) {
	#ifdef WEBGPU
		uv.y = 1.0 - uv.y;
	#endif
	return uv;
}
`,ro=`
#define WEBGPU
fn getGrabScreenPos(clipPos: vec4<f32>) -> vec2<f32> {
	var uv: vec2<f32> = (clipPos.xy / clipPos.w) * 0.5 + vec2<f32>(0.5);
	uv.y = 1.0 - uv.y;
	return uv;
}
fn getImageEffectUV(uv: vec2<f32>) -> vec2<f32> {
	var modifiedUV: vec2<f32> = uv;
	modifiedUV.y = 1.0 - modifiedUV.y;
	return modifiedUV;
}
struct WrappedF32 { @size(16) element: f32 }
struct WrappedI32 { @size(16) element: i32 }
struct WrappedU32 { @size(16) element: u32 }
struct WrappedVec2F { @size(16) element: vec2f }
struct WrappedVec2I { @size(16) element: vec2i }
struct WrappedVec2U { @size(16) element: vec2u }
`;let rl={vertex_position:e6,vertex_normal:e9,vertex_tangent:e7,vertex_texCoord0:tr,vertex_texCoord1:ta,vertex_texCoord2:tn,vertex_texCoord3:to,vertex_texCoord4:tl,vertex_texCoord5:th,vertex_texCoord6:tc,vertex_texCoord7:td,vertex_color:ti,vertex_boneIndices:tt,vertex_boneWeights:te};class rh{static createDefinition(e,t){let i,s,r=e=>{let t=e.fragmentOutputTypes??"vec4";return Array.isArray(t)||(t=[t]),t},a=(t,i,s,a)=>{let n=e.isWebGPU?t:i,o="";if(!s){let t=r(a);for(let i=0;i<e.maxColorAttachments;i++){o+=`#define COLOR_ATTACHMENT_${i}
`;let e=t[i]??"vec4";o+=`#define outType_${i} ${e}
`;}}return o+n},n=(t,i)=>{let s="";if(!t&&e.supportsPrimitiveIndex&&(s+="enable primitive_index;\n"),!t){let t=r(i);for(let i=0;i<e.maxColorAttachments;i++){let e=t[i]??"vec4",r=t3.get(e);s+=`alias pcOutType${i} = ${r};
`;}}return s},o=t.name??"Untitled",l=rh.getDefinesCode(e,t.vertexDefines),h=rh.getDefinesCode(e,t.fragmentDefines);return t.shaderLanguage===tV?(i=`
								${n(true,t)}
								${l}
								${ra}
								${ro}
								${t.vertexCode}
						`,s=`
								${n(false,t)}
								${h}
								${rr}
								${ro}
								${t.fragmentCode}
						`):(i=`${rh.versionCode(e)+a(rs,rt,true,t)+l+rh.precisionCode(e)}
								${rn}
								${rh.getShaderNameCode(o)}
								${t.vertexCode}`,s=`${(t.fragmentPreamble||"")+rh.versionCode(e)+a(ri,re,false,t)+h+rh.precisionCode(e)}
								${rn}
								${rh.getShaderNameCode(o)}
								${t.fragmentCode}`),{name:o,shaderLanguage:t.shaderLanguage??tz,attributes:t.attributes,vshader:i,vincludes:t.vertexIncludes,fincludes:t.fragmentIncludes,fshader:s,feedbackVaryings:t.feedbackVaryings,useTransformFeedback:t.useTransformFeedback,meshUniformBufferFormat:t.meshUniformBufferFormat,meshBindGroupFormat:t.meshBindGroupFormat}}static getDefinesCode(e,t){let i="";return e.capsDefines.forEach((e,t)=>{i+=`#define ${t} ${e}
`;}),i+="\n",t?.forEach((e,t)=>{i+=`#define ${t} ${e}
`;}),i+="\n"}static getShaderNameCode(e){return `#define SHADER_NAME ${e}
`}static versionCode(e){return e.isWebGPU?"#version 450\n":"#version 300 es\n"}static precisionCode(e,t){t&&"highp"!==t&&"mediump"!==t&&"lowp"!==t&&(t=null),t&&("highp"===t&&"highp"!==e.maxPrecision&&(t="mediump"),"mediump"===t&&"lowp"===e.maxPrecision&&(t="lowp"));let i=t||e.precision;return `
						precision ${i} float;
						precision ${i} int;
						precision ${i} usampler2D;
						precision ${i} isampler2D;
						precision ${i} sampler2DShadow;
						precision ${i} samplerCubeShadow;
						precision ${i} sampler2DArray;
				`}static collectAttributes(e){let t={},i=0,s=e.indexOf("attribute");for(;s>=0&&(!(s>0)||"/"!==e[s-1]);){let r=false;if(s>0){let t=e.lastIndexOf("\n",s);t=-1!==t?t+1:0,e.substring(t,s).includes("#")&&(r=true);}if(!r){let r=e.indexOf(";",s),a=e.lastIndexOf(" ",r),n=e.substring(a+1,r);if(t[n]);else {let e=rl[n];void 0!==e?t[n]=e:(t[n]=`ATTR${i}`,i++);}}s=e.indexOf("attribute",s+1);}return t}}let rc=0;class rd{init(){this.ready=false,this.failed=false;}get label(){return `Shader Id ${this.id} (${this.definition.shaderLanguage===tV?"WGSL":"GLSL"}) ${this.name}`}destroy(){this.device.onDestroyShader(this),this.impl.destroy(this);}loseContext(){this.init(),this.impl.loseContext();}restoreContext(){this.impl.restoreContext(this.device,this);}constructor(e,t){if(this.attributes=new Map,this.id=rc++,this.device=e,this.definition=t,this.name=t.name||"Untitled",this.init(),t.cshader){let i=rh.getDefinesCode(e,t.cdefines)+t.cshader;t.cshader=s7.run(i,t.cincludes,{sourceName:`compute shader for ${this.label}`,stripDefines:true});}else {let i=t.shaderLanguage===tV;t.vshader=s7.run(t.vshader,t.vincludes,{sourceName:`vertex shader for ${this.label}`,stripDefines:i}),t.shaderLanguage===tz&&(t.attributes??(t.attributes=rh.collectAttributes(t.vshader)));let s=e.isWebGL2&&("osx"===k.name||"ios"===k.name);if(t.fshader=s7.run(t.fshader,t.fincludes,{stripUnusedColorAttachments:s,stripDefines:i,sourceName:`fragment shader for ${this.label}`}),!t.vshader||!t.fshader){this.failed=true;return}}this.impl=e.createShaderImpl(this);}}class ru{}class rf{}class rp{destroy(){this.gpuBuffers.forEach(e=>{e.destroy(this.device);}),this.gpuBuffers=null,this.stagingBuffers.forEach(e=>{e.destroy(this.device);}),this.stagingBuffers=null,this.usedBuffers=null,this.activeBuffer=null;}alloc(e,t){if(this.activeBuffer){let e=ei.roundUp(this.activeBuffer.size,this.bufferAlignment);this.bufferSize-e<t&&this.scheduleSubmit();}if(!this.activeBuffer){let e=this.gpuBuffers.pop();e||(e=this.createBuffer(this.device,this.bufferSize,false));let t=this.stagingBuffers.pop();t||(t=this.createBuffer(this.device,this.bufferSize,true)),this.activeBuffer=new ru,this.activeBuffer.stagingBuffer=t,this.activeBuffer.gpuBuffer=e,this.activeBuffer.offset=0,this.activeBuffer.size=0;}let i=this.activeBuffer,s=ei.roundUp(i.size,this.bufferAlignment);e.gpuBuffer=i.gpuBuffer,e.offset=s,e.storage=i.stagingBuffer.alloc(s,t),i.size=s+t;}scheduleSubmit(){this.activeBuffer&&(this.usedBuffers.push(this.activeBuffer),this.activeBuffer=null);}submit(){this.scheduleSubmit();}constructor(e,t,i){this.gpuBuffers=[],this.stagingBuffers=[],this.usedBuffers=[],this.activeBuffer=null,this.device=e,this.bufferSize=t,this.bufferAlignment=i;}}let rm=[];rm[2]=function(e,t,i){e.storageFloat32[i]=t;},rm[3]=(e,t,i)=>{let s=e.storageFloat32;s[i]=t[0],s[i+1]=t[1];},rm[4]=(e,t,i)=>{let s=e.storageFloat32;s[i]=t[0],s[i+1]=t[1],s[i+2]=t[2];},rm[5]=(e,t,i)=>{let s=e.storageFloat32;s[i]=t[0],s[i+1]=t[1],s[i+2]=t[2],s[i+3]=t[3];},rm[1]=function(e,t,i){e.storageInt32[i]=t;},rm[6]=function(e,t,i){let s=e.storageInt32;s[i]=t[0],s[i+1]=t[1];},rm[7]=function(e,t,i){let s=e.storageInt32;s[i]=t[0],s[i+1]=t[1],s[i+2]=t[2];},rm[8]=function(e,t,i){let s=e.storageInt32;s[i]=t[0],s[i+1]=t[1],s[i+2]=t[2],s[i+3]=t[3];},rm[12]=(e,t,i)=>{let s=e.storageFloat32;s[i]=t[0],s[i+1]=t[1],s[i+4]=t[2],s[i+5]=t[3],s[i+8]=t[4],s[i+9]=t[5];},rm[13]=(e,t,i)=>{let s=e.storageFloat32;s[i]=t[0],s[i+1]=t[1],s[i+2]=t[2],s[i+4]=t[3],s[i+5]=t[4],s[i+6]=t[5],s[i+8]=t[6],s[i+9]=t[7],s[i+10]=t[8];},rm[17]=function(e,t,i,s){let r=e.storageFloat32;for(let e=0;e<s;e++)r[i+4*e]=t[e];},rm[21]=(e,t,i,s)=>{let r=e.storageFloat32;for(let e=0;e<s;e++)r[i+4*e]=t[2*e],r[i+4*e+1]=t[2*e+1];},rm[22]=(e,t,i,s)=>{let r=e.storageFloat32;for(let e=0;e<s;e++)r[i+4*e]=t[3*e],r[i+4*e+1]=t[3*e+1],r[i+4*e+2]=t[3*e+2];},rm[26]=(e,t,i,s)=>{e.storageUint32[i]=t;},rm[27]=(e,t,i,s)=>{let r=e.storageUint32;r[i]=t[0],r[i+1]=t[1];},rm[28]=(e,t,i,s)=>{let r=e.storageUint32;r[i]=t[0],r[i+1]=t[1],r[i+2]=t[2];},rm[29]=(e,t,i,s)=>{let r=e.storageUint32;r[i]=t[0],r[i+1]=t[1],r[i+2]=t[2],r[i+3]=t[3];},rm[30]=function(e,t,i,s){let r=e.storageInt32;for(let e=0;e<s;e++)r[i+4*e]=t[e];},rm[32]=rm[30],rm[31]=function(e,t,i,s){let r=e.storageUint32;for(let e=0;e<s;e++)r[i+4*e]=t[e];},rm[33]=(e,t,i,s)=>{let r=e.storageInt32;for(let e=0;e<s;e++)r[i+4*e]=t[2*e],r[i+4*e+1]=t[2*e+1];},rm[35]=rm[33],rm[34]=(e,t,i,s)=>{let r=e.storageUint32;for(let e=0;e<s;e++)r[i+4*e]=t[2*e],r[i+4*e+1]=t[2*e+1];},rm[36]=(e,t,i,s)=>{let r=e.storageInt32;for(let e=0;e<s;e++)r[i+4*e]=t[3*e],r[i+4*e+1]=t[3*e+1],r[i+4*e+2]=t[3*e+2];},rm[38]=rm[36],rm[37]=(e,t,i,s)=>{let r=e.storageUint32;for(let e=0;e<s;e++)r[i+4*e]=t[3*e],r[i+4*e+1]=t[3*e+1],r[i+4*e+2]=t[3*e+2];};class r_{destroy(){if(this.persistent){let e=this.device;this.impl.destroy(e),e._vram.ub-=this.format.byteSize;}}get offset(){return this.persistent?0:this.allocation.offset}assignStorage(e){this.storageInt32=e,this.storageUint32=new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4),this.storageFloat32=new Float32Array(e.buffer,e.byteOffset,e.byteLength/4);}loseContext(){this.impl?.loseContext();}setUniform(e,t){let i=e.offset;if(null!=t){let s=rm[e.updateType];s?s(this,t,i,e.count):this.storageFloat32.set(t,i);}}set(e,t){let i=this.format.map.get(e);i&&this.setUniform(i,t);}startUpdate(e){if(!this.persistent){let t=this.allocation,i=t.gpuBuffer;this.device.dynamicBuffers.alloc(t,this.format.byteSize),this.assignStorage(t.storage),e&&(e.bindGroup=t.gpuBuffer.getBindGroup(this),e.offsets[0]=t.offset),i!==t.gpuBuffer&&(this.renderVersionDirty=this.device.renderVersion);}}endUpdate(){this.persistent?this.impl.unlock(this):(this.storageFloat32=null,this.storageInt32=null);}update(e){this.startUpdate(e);let t=this.format.uniforms;for(let e=0;e<t.length;e++){let i=t[e].scopeId.value;this.setUniform(t[e],i);}this.endUpdate();}constructor(e,t,i=true){if(this.renderVersionDirty=0,this.device=e,this.format=t,this.persistent=i,i){this.impl=e.createUniformBufferImpl(this);let i=new ArrayBuffer(t.byteSize);this.assignStorage(new Int32Array(i)),e._vram.ub+=this.format.byteSize;}else this.allocation=new rf;}}let rg={type:5,base:0,baseVertex:0,count:4,indexed:false};class rv{destroy(){this.shader.destroy(),this.shader=null,this.uniformBuffer.destroy(),this.uniformBuffer=null;}clear(e,t,i,s){let r=(i=i||s).flags??s.flags;if(0!==r){let{uniformBuffer:a,dynamicBindGroup:n}=this;if(a.startUpdate(n),e.setBindGroup(2,n.bindGroup,n.offsets),e.setBindGroup(1,e.emptyBindGroup),1&r&&(t.colorBuffer||t.impl.assignedColorTexture)){let t=i.color??s.color;this.colorData.set(t),e.setBlendState(iS.NOBLEND);}else e.setBlendState(iS.NOWRITE);if(a.set("color",this.colorData),2&r&&t.depth){let t=i.depth??s.depth;a.set("depth",t),e.setDepthState(ix.WRITEDEPTH);}else a.set("depth",1),e.setDepthState(ix.NODEPTH);4&r&&t.stencil,a.endUpdate(),e.setCullMode(0),e.setShader(this.shader),e.draw(rg);}}constructor(e){let t=`

						struct ub_mesh {
								color : vec4f,
								depth: f32
						}

						@group(2) @binding(0) var<uniform> ubMesh : ub_mesh;

						var<private> pos : array<vec2f, 4> = array<vec2f, 4>(
								vec2(-1.0, 1.0), vec2(1.0, 1.0),
								vec2(-1.0, -1.0), vec2(1.0, -1.0)
						);

						struct VertexOutput {
								@builtin(position) position : vec4f
						}

						@vertex
						fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {
								var output : VertexOutput;
								output.position = vec4(pos[vertexIndex], ubMesh.depth, 1.0);
								return output;
						}

						@fragment
						fn fragmentMain() -> @location(0) vec4f {
								return ubMesh.color;
						}
				`;this.shader=new rd(e,{name:"WebGPUClearRendererShader",shaderLanguage:tV,vshader:t,fshader:t}),this.uniformBuffer=new r_(e,new sf(e,[new su("color",5),new su("depth",2)]),false),this.dynamicBindGroup=new i_,this.colorData=new Float32Array(4);}}class rS{destroy(){this.shader.destroy(),this.shader=null,this.pipelineCache.clear();}generate(e){let t=e.desc;if(t.mipLevelCount<=1||e.texture.volume)return;let i=this.device,s=i.wgpu,r=t.format,a=this.pipelineCache.get(r);if(!a){let e=this.shader.impl;a=s.createRenderPipeline({layout:"auto",vertex:{module:e.getVertexShaderModule(),entryPoint:e.vertexEntryPoint},fragment:{module:e.getFragmentShaderModule(),entryPoint:e.fragmentEntryPoint,targets:[{format:r}]},primitive:{topology:"triangle-strip"}}),this.pipelineCache.set(r,a);}let n=e.texture,o=n.cubemap?6:n.array?n.arrayLength:1,l=[];for(let t=0;t<o;t++)l.push(e.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:t}));let h=i.getCommandEncoder();for(let i=1;i<t.mipLevelCount;i++)for(let t=0;t<o;t++){let r=e.createView({dimension:"2d",baseMipLevel:i,mipLevelCount:1,baseArrayLayer:t}),n=h.beginRenderPass({colorAttachments:[{view:r,loadOp:"clear",storeOp:"store"}]}),o=s.createBindGroup({layout:a.getBindGroupLayout(0),entries:[{binding:0,resource:this.minSampler},{binding:1,resource:l[t]}]});n.setPipeline(a),n.setBindGroup(0,o),n.draw(4),n.end(),l[t]=r;}i.pipeline=null;}constructor(e){this.pipelineCache=new Map,this.device=e;let t=`
 
						var<private> pos : array<vec2f, 4> = array<vec2f, 4>(
								vec2(-1.0, 1.0), vec2(1.0, 1.0),
								vec2(-1.0, -1.0), vec2(1.0, -1.0)
						);

						struct VertexOutput {
								@builtin(position) position : vec4f,
								@location(0) texCoord : vec2f
						};

						@vertex
						fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {
							var output : VertexOutput;
							output.texCoord = pos[vertexIndex] * vec2f(0.5, -0.5) + vec2f(0.5);
							output.position = vec4f(pos[vertexIndex], 0, 1);
							return output;
						}

						@group(0) @binding(0) var imgSampler : sampler;
						@group(0) @binding(1) var img : texture_2d<f32>;

						@fragment
						fn fragmentMain(@location(0) texCoord : vec2f) -> @location(0) vec4f {
							return textureSample(img, imgSampler, texCoord);
						}
				`;this.shader=new rd(e,{name:"WebGPUMipmapRendererShader",shaderLanguage:tV,vshader:t,fshader:t}),this.minSampler=e.wgpu.createSampler({minFilter:"linear"});}}class ry{getBindGroup(e){let t=e.format.byteSize,i=this.bindGroupCache.get(t);return i||((i=new ig(this.device,this.bindGroupFormat,e)).update(),this.bindGroupCache.set(t,i)),i}constructor(e){this.bindGroupCache=new Map,this.device=e,this.bindGroupFormat=new it(this.device,[new t6(tZ,3)]);}}class rx extends ry{destroy(e){e._vram.ub-=this.buffer.size,this.buffer.destroy(),this.buffer=null;}onAvailable(){this.mappedRange=this.buffer.getMappedRange();}alloc(e,t){return new Int32Array(this.mappedRange,e,t/4)}constructor(e,t,i){super(e),this.buffer=null,this.mappedRange=null,this.buffer=e.wgpu.createBuffer({size:t,usage:i?GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:i}),i&&this.onAvailable(),e._vram.ub+=t;}}class rT extends rp{createBuffer(e,t,i){return new rx(e,t,i)}submit(){super.submit();let e=this.usedBuffers.length;if(e){let t=this.device,i=this.gpuBuffers,s=t.wgpu.createCommandEncoder();for(let t=e-1;t>=0;t--){let{stagingBuffer:e,gpuBuffer:r,offset:a,size:n}=this.usedBuffers[t],o=e.buffer;o.unmap(),s.copyBufferToBuffer(o,a,r.buffer,a,n),i.push(r);}let r=s.finish();t.addCommandBuffer(r,true);for(let t=0;t<e;t++){let e=this.usedBuffers[t].stagingBuffer;this.pendingStagingBuffers.push(e);}this.usedBuffers.length=0;}}onCommandBuffersSubmitted(){let e=this.pendingStagingBuffers.length;if(e){for(let t=0;t<e;t++){let e=this.pendingStagingBuffers[t];e.buffer.mapAsync(GPUMapMode.WRITE).then(()=>{this.stagingBuffers&&(e.onAvailable(),this.stagingBuffers.push(e));});}this.pendingStagingBuffers.length=0;}}constructor(...e){super(...e),this.pendingStagingBuffers=[];}}class rE{loseContext(){this.pastFrameAllocations.clear();}set enabled(e){this._enableRequest=e;}get enabled(){return this._enableRequest}get passTimings(){return this._passTimings}processEnableRequest(){this._enableRequest!==this._enabled&&(this._enabled=this._enableRequest,this._enabled||(this._frameTime=0));}request(e){this.pastFrameAllocations.set(e,this.frameAllocations),this.frameAllocations=[];}_parsePassName(e){let t=this._nameCache.get(e);return void 0===t&&(t=e.startsWith("RenderPass")?e.substring(10):e,this._nameCache.set(e,t)),t}report(e,t){if(t){let i=this.pastFrameAllocations.get(e);if(!i)return;t.length>0&&(this._frameTime=t.reduce((e,t)=>e+t,0)),this._passTimings.clear();for(let e=0;e<i.length;++e){let s=i[e],r=t[e],a=this._parsePassName(s);this._passTimings.set(a,(this._passTimings.get(a)||0)+r);}if(et.get(E))for(let e=0;e<i.length;++e)i[e],t[e];}this.pastFrameAllocations.delete(e);}getSlot(e){if(this.frameAllocations.length>=this.maxCount)return -1;let t=this.frameAllocations.length;return this.frameAllocations.push(e),t}get slotCount(){return this.frameAllocations.length}constructor(){this.frameAllocations=[],this.pastFrameAllocations=new Map,this._enabled=false,this._enableRequest=false,this._frameTime=0,this._passTimings=new Map,this._nameCache=new Map,this.maxCount=9999;}}class rw{destroy(){this.querySet?.destroy(),this.querySet=null,this.queryBuffer?.destroy(),this.queryBuffer=null,this.activeStagingBuffer=null,this.stagingBuffers.forEach(e=>{e.destroy();}),this.stagingBuffers=null;}getStagingBuffer(){let e=this.stagingBuffers.pop();return e||(e=this.device.wgpu.createBuffer({size:this.queryBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})),e}resolve(e){let t=this.device.getCommandEncoder();t.resolveQuerySet(this.querySet,0,e,this.queryBuffer,0);let i=this.getStagingBuffer();this.activeStagingBuffer=i,t.copyBufferToBuffer(this.queryBuffer,0,i,0,this.bytesPerSlot*e);}request(e,t){let i=this.activeStagingBuffer;return this.activeStagingBuffer=null,i.mapAsync(GPUMapMode.READ).then(()=>{let s=new BigInt64Array(i.getMappedRange()),r=[];for(let t=0;t<e;t++)r.push(1e-6*Number(s[2*t+1]-s[2*t]));return i.unmap(),this.stagingBuffers?.push(i),{renderVersion:t,timings:r}})}constructor(e,t,i){this.stagingBuffers=[],this.activeStagingBuffer=null,this.device=e,this.capacity=i,this.bytesPerSlot=t?8:4;let s=e.wgpu;this.querySet=s.createQuerySet({type:t?"timestamp":"occlusion",count:i}),this.queryBuffer=s.createBuffer({size:this.bytesPerSlot*i,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST});}}class rb extends rE{destroy(){this.timestampQueriesSet?.destroy(),this.timestampQueriesSet=null;}frameStart(){this.processEnableRequest();}frameEnd(){this._enabled&&this.timestampQueriesSet?.resolve(2*this.slotCount);}request(){if(this._enabled){let e=this.device.renderVersion;this.timestampQueriesSet?.request(this.slotCount,e).then(e=>{this.report(e.renderVersion,e.timings);}),super.request(e);}}constructor(e){super(),this.device=e,this.maxCount=1024,this.timestampQueriesSet=e.supportsTimestampQuery?new rw(e,true,2*this.maxCount):null;}}class rA{destroy(){this.shader.destroy(),this.shader=null,this.pipelineCache=null;}getPipeline(e){let t=this.pipelineCache.get(e);return t||(t=this.createPipeline(e),this.pipelineCache.set(e,t)),t}createPipeline(e){let t=this.shader.impl;return this.device.wgpu.createRenderPipeline({layout:"auto",vertex:{module:t.getVertexShaderModule(),entryPoint:t.vertexEntryPoint},fragment:{module:t.getFragmentShaderModule(),entryPoint:t.fragmentEntryPoint,targets:[{format:e}]},primitive:{topology:"triangle-strip"}})}resolveDepth(e,t,i){let s=this.device,r=s.wgpu,a=this.getPipeline(i.format),n=t.depthOrArrayLayers;for(let s=0;s<n;s++){let n=t.createView({dimension:"2d",aspect:"depth-only",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:s}),o=i.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:s}),l=e.beginRenderPass({colorAttachments:[{view:o,loadOp:"clear",storeOp:"store"}]}),h=r.createBindGroup({layout:a.getBindGroupLayout(0),entries:[{binding:0,resource:n}]});l.setPipeline(a),l.setBindGroup(0,h),l.draw(4),l.end();}s.pipeline=null;}constructor(e){this.pipelineCache=new Map,this.device=e;let t=`
 
						var<private> pos : array<vec2f, 4> = array<vec2f, 4>(
								vec2(-1.0, 1.0), vec2(1.0, 1.0), vec2(-1.0, -1.0), vec2(1.0, -1.0)
						);

						struct VertexOutput {
								@builtin(position) position : vec4f,
						};

						@vertex
						fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {
							var output : VertexOutput;
							output.position = vec4f(pos[vertexIndex], 0, 1);
							return output;
						}

						@group(0) @binding(0) var img : texture_depth_multisampled_2d;

						@fragment
						fn fragmentMain(@builtin(position) fragColor: vec4f) -> @location(0) vec4f {
								// load th depth value from sample index 0
								var depth = textureLoad(img, vec2i(fragColor.xy), 0u);
								return vec4f(depth, 0.0, 0.0, 0.0);
						}
				`;this.shader=new rd(e,{name:"WebGPUResolverDepthShader",shaderLanguage:tV,vshader:t,fshader:t});}}class rC{destroy(){this.uniformBuffers.forEach(e=>e.destroy()),this.uniformBuffers.length=0,this.bindGroup.destroy(),this.bindGroup=null;}updateBindGroup(){let{bindGroup:e}=this;e.updateUniformBuffers(),e.update();}dispatch(e,t,i){let s=this.compute.device;s.setBindGroup(0,this.bindGroup);let r=s.passEncoder;r.setPipeline(this.pipeline);let{indirectSlotIndex:a,indirectBuffer:n,indirectFrameStamp:o}=this.compute;if(a>=0){let e;e=n?n.impl.buffer:s.indirectDispatchBuffer.impl.buffer,r.dispatchWorkgroupsIndirect(e,12*a);}else r.dispatchWorkgroups(e,t,i);}constructor(e){this.uniformBuffers=[],this.bindGroup=null,this.compute=e;let{device:t,shader:i}=e,{computeBindGroupFormat:s,computeUniformBufferFormats:r}=i.impl;if(this.bindGroup=new ig(t,s),r){for(let e in r)if(r.hasOwnProperty(e)){let i=new r_(t,r[e],true);this.uniformBuffers.push(i),this.bindGroup.setUniformBuffer(e,i);}}this.pipeline=t.computePipeline.get(i,s);}}let rP=0;class rI{destroy(){let e=this.device;e.buffers.delete(this),this.adjustVramSizeTracking(e._vram,-this.byteSize),this.impl.destroy(e);}adjustVramSizeTracking(e,t){e.sb+=t;}read(e=0,t=this.byteSize,i=null,s=false){return this.impl.read(this.device,e,t,i,s)}write(e=0,t,i=0,s){this.impl.write(this.device,e,t,i,s);}clear(e=0,t=this.byteSize){this.impl.clear(this.device,e,t);}copy(e,t=0,i=0,s=e.byteSize-t){this.device.getCommandEncoder().copyBufferToBuffer(e.impl.buffer,t,this.impl.buffer,i,s);}constructor(e,t,i=0,s=true){this.id=rP++,this.device=e,this.byteSize=t,this.bufferUsage=i,this.impl=e.createBufferImpl(s?128|i:i),this.impl.allocate(e,t),this.device.buffers.add(this),this.adjustVramSizeTracking(e._vram,this.byteSize);}}class rD{allocate(e){this.gpuIndirect&&this.gpuIndirect.length===5*e||(this.storage?.destroy(),this.gpuIndirect=new Uint32Array(5*e),this.gpuIndirectSigned=new Int32Array(this.gpuIndirect.buffer),this.storage=new rI(this.device,this.gpuIndirect.byteLength,264));}add(e,t,i,s,r=0,a=0){let n=5*e;this.gpuIndirect[n+0]=t,this.gpuIndirect[n+1]=i,this.gpuIndirect[n+2]=s,this.gpuIndirectSigned[n+3]=r,this.gpuIndirect[n+4]=a;}update(e){return this.storage&&e>0&&this.storage.write(0,this.gpuIndirect,0,5*e),0}destroy(){this.storage?.destroy(),this.storage=null;}constructor(e){this.gpuIndirect=null,this.gpuIndirectSigned=null,this.storage=null,this.device=e;}}class rR{_onDeviceLost(){}destroy(){this._destroyed=true,this.availableStagingBuffers.forEach(e=>e.destroy()),this.pendingStagingBuffers.forEach(e=>e.destroy());}update(e){let t=this.pendingStagingBuffers;for(let e=0;e<t.length;e++){let i=t[e];i.mapAsync(GPUMapMode.WRITE).then(()=>{this._destroyed?i.destroy():this.availableStagingBuffers.push(i);});}t.length=0;let i=this.availableStagingBuffers;for(let t=i.length-1;t>=0;t--)i[t].size<e&&(i[t].destroy(),i.splice(t,1));}upload(e,t,i,s){this.useSingleBuffer?this.uploadDirect(e,t,i,s):this.uploadStaging(e,t,i,s);}uploadDirect(e,t,i,s){let r=i*e.BYTES_PER_ELEMENT;e.BYTES_PER_ELEMENT,t.write(r,e,0,s);}uploadStaging(e,t,i,s){let r=this.uploadStream.device,a=i*e.BYTES_PER_ELEMENT,n=s*e.BYTES_PER_ELEMENT;this.update(n);let o=this.availableStagingBuffers.pop()??this.uploadStream.device.wgpu.createBuffer({size:n,usage:GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC,mappedAtCreation:true});new Uint8Array(o.getMappedRange()).set(new Uint8Array(e.buffer,e.byteOffset,n)),o.unmap(),r.getCommandEncoder().copyBufferToBuffer(o,0,t.impl.buffer,a,n),this.pendingStagingBuffers.push(o);}constructor(e){this.availableStagingBuffers=[],this.pendingStagingBuffers=[],this._destroyed=false,this.uploadStream=e,this.useSingleBuffer=e.useSingleBuffer;}}let rL=new Map;class rM extends iB{destroy(){this.clearRenderer.destroy(),this.clearRenderer=null,this.mipmapRenderer.destroy(),this.mipmapRenderer=null,this.resolver.destroy(),this.resolver=null,super.destroy();}initDeviceCaps(){let e=this.wgpu?.limits;this.limits=e,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=e.maxTextureDimension2D,this.maxCubeMapSize=e.maxTextureDimension2D,this.maxVolumeSize=e.maxTextureDimension3D,this.maxColorAttachments=e.maxColorAttachments,this.maxPixelRatio=1,this.maxAnisotropy=16,this.fragmentUniformsCount=e.maxUniformBufferBindingSize/16,this.vertexUniformsCount=e.maxUniformBufferBindingSize/16,this.supportsUniformBuffers=true,this.supportsAreaLights=true,this.supportsGpuParticles=true,this.supportsCompute=true,this.textureFloatRenderable=true,this.textureHalfFloatRenderable=true,this.supportsImageBitmap=true,this.samples=this.backBufferAntialias?4:1;let t=window.navigator.gpu.wgslLanguageFeatures;this.supportsStorageTextureRead=t?.has("readonly_and_readwrite_storage_textures"),this.supportsSubgroupUniformity=t?.has("subgroup_uniformity"),this.supportsSubgroupId=t?.has("subgroup_id"),this.initCapsDefines();}async initWebGpu(e,t){if(!window.navigator.gpu)throw Error("Unable to retrieve GPU. Ensure you are using a browser that supports WebGPU rendering.");if(e&&t){let i=e=>new URL(e,window.location.href).toString(),s=await Promise.all([Function("modulePath","return import(modulePath)")(`${i(t)}`).then(e=>twgsl(t.replace(".js",".wasm"))),Function("modulePath","return import(modulePath)")(`${i(e)}`).then(e=>e.default())]);this.twgsl=s[0],this.glslang=s[1];}return this.createDevice()}async createDevice(){let e={powerPreference:"default"!==this.initOptions.powerPreference?this.initOptions.powerPreference:void 0,xrCompatible:this.initOptions.xrCompatible};this.gpuAdapter=await window.navigator.gpu.requestAdapter(e);let t=[],i=e=>{let i=this.gpuAdapter.features.has(e);return i&&t.push(e),i};this.textureFloatFilterable=i("float32-filterable"),this.textureFloatBlendable=i("float32-blendable"),this.extCompressedTextureS3TC=i("texture-compression-bc"),this.extCompressedTextureS3TCSliced3D=i("texture-compression-bc-sliced-3d"),this.extCompressedTextureETC=i("texture-compression-etc2"),this.extCompressedTextureASTC=i("texture-compression-astc"),this.extCompressedTextureASTCSliced3D=i("texture-compression-astc-sliced-3d"),this.supportsTimestampQuery=i("timestamp-query"),this.supportsDepthClip=i("depth-clip-control"),this.supportsDepth32Stencil=i("depth32float-stencil8"),this.supportsIndirectFirstInstance=i("indirect-first-instance"),this.supportsShaderF16=i("shader-f16"),this.supportsStorageRGBA8=i("bgra8unorm-storage"),this.textureRG11B10Renderable=i("rg11b10ufloat-renderable"),this.supportsClipDistances=i("clip-distances"),this.supportsTextureFormatTier1=i("texture-format-tier1"),this.supportsTextureFormatTier2=i("texture-format-tier2"),this.supportsPrimitiveIndex=i("primitive-index");let s=this.gpuAdapter?.limits,r={};if(s)for(let e in s)"minSubgroupSize"!==e&&"maxSubgroupSize"!==e&&(r[e]=s[e]);this.wgpu=await this.gpuAdapter.requestDevice({requiredFeatures:t,requiredLimits:r,defaultQueue:{label:"Default Queue"}}),this.wgpu.lost?.then(this.handleDeviceLost.bind(this)),this.initDeviceCaps(),this.gpuContext=this.canvas.getContext("webgpu");let a="standard",n=window.navigator.gpu.getPreferredCanvasFormat(),o=this.initOptions.displayFormat;if(this.backBufferFormat="rgba8unorm"===n?o===tj?20:7:o===tj?64:31,this.backBufferViewFormat=o===tj?`${n}-srgb`:n,"hdr"===o&&this.textureFloatFilterable){let e=window.matchMedia("(dynamic-range: high)");e?.matches&&(this.backBufferFormat=12,this.backBufferViewFormat="rgba16float",n="rgba16float",this.isHdr=true,a="extended");}return this.canvasConfig={device:this.wgpu,colorSpace:"srgb",alphaMode:this.initOptions.alpha?"premultiplied":"opaque",format:n,toneMapping:{mode:a},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST,viewFormats:o===tj?[this.backBufferViewFormat]:[]},this.gpuContext?.configure(this.canvasConfig),this.createBackbuffer(),this.clearRenderer=new rv(this),this.mipmapRenderer=new rS(this),this.resolver=new rA(this),this.postInit(),this}async handleDeviceLost(e){"destroyed"!==e.reason&&(super.loseContext(),await this.createDevice(),super.restoreContext());}postInit(){super.postInit(),this.initializeRenderState(),this.setupPassEncoderDefaults(),this.gpuProfiler=new rb(this),this.dynamicBuffers=new rT(this,102400,this.limits.minUniformBufferOffsetAlignment),this.emptyBindGroup=new ig(this,new it(this,[])),this.emptyBindGroup.update();}createBackbuffer(){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new iU({name:"WebgpuFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.isBackbuffer=true;}frameStart(){super.frameStart(),this.gpuProfiler.frameStart(),this.submit();let e=this.gpuContext?.getCurrentTexture?.()??this.externalBackbuffer?.impl.gpuTexture;(this.backBufferSize.x!==e.width||this.backBufferSize.y!==e.height)&&(this.backBufferSize.set(e.width,e.height),this.backBuffer.destroy(),this.backBuffer=null,this.createBackbuffer());let t=this.backBuffer,i=t.impl;i.setColorAttachment(0,void 0,this.backBufferViewFormat),this.initRenderTarget(t),i.assignColorTexture(this,e);}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.submit(),this.contextLost||this.gpuProfiler.request(),this._indirectDrawNextIndex=0,this._indirectDispatchNextIndex=0;}createBufferImpl(e){return new iq(e)}createUniformBufferImpl(e){return new sX(e)}createVertexBufferImpl(e,t,i){return new sY(e,t,i)}createIndexBufferImpl(e,t){return new i$(e,t)}createShaderImpl(e){return new sV(e)}createDrawCommandImpl(e){return new rD(this)}createTextureImpl(e){return this.textures.add(e),new sW(e)}createRenderTargetImpl(e){return new sc(e)}createUploadStreamImpl(e){return new rR(e)}createBindGroupFormatImpl(e){return new iY(e)}createBindGroupImpl(e){return new iz}createComputeImpl(e){return new rC(e)}get indirectDrawBuffer(){return this.allocateIndirectDrawBuffer(),this._indirectDrawBuffer}allocateIndirectDrawBuffer(){0===this._indirectDrawNextIndex&&this._indirectDrawBufferCount<this.maxIndirectDrawCount&&(this._indirectDrawBuffer?.destroy(),this._indirectDrawBuffer=null),null===this._indirectDrawBuffer&&(this._indirectDrawBuffer=new rI(this,20*this.maxIndirectDrawCount,264),this._indirectDrawBufferCount=this.maxIndirectDrawCount);}getIndirectDrawSlot(e=1){this.allocateIndirectDrawBuffer();let t=this._indirectDrawNextIndex,i=this._indirectDrawNextIndex+e;return this._indirectDrawNextIndex=i,t}get indirectDispatchBuffer(){return this.allocateIndirectDispatchBuffer(),this._indirectDispatchBuffer}allocateIndirectDispatchBuffer(){0===this._indirectDispatchNextIndex&&this._indirectDispatchBufferCount<this.maxIndirectDispatchCount&&(this._indirectDispatchBuffer?.destroy(),this._indirectDispatchBuffer=null),null===this._indirectDispatchBuffer&&(this._indirectDispatchBuffer=new rI(this,12*this.maxIndirectDispatchCount,264),this._indirectDispatchBufferCount=this.maxIndirectDispatchCount);}getIndirectDispatchSlot(e=1){this.allocateIndirectDispatchBuffer();let t=this._indirectDispatchNextIndex,i=this._indirectDispatchNextIndex+e;return this._indirectDispatchNextIndex=i,t}setBindGroup(e,t,i){this.passEncoder&&(this.passEncoder.setBindGroup(e,t.impl.bindGroup,i??t.uniformBufferOffsets),this.bindGroupFormats[e]=t.format.impl);}submitVertexBuffer(e,t){let{interleaved:i,elements:s}=e.format,r=s.length,a=e.impl.buffer;if(i)return this.passEncoder.setVertexBuffer(t,a),1;for(let e=0;e<r;e++)this.passEncoder.setVertexBuffer(t+e,a,s[e].offset);return r}validateVBLocations(e,t){let i=e=>{let{elements:t}=e.format;for(let e=0;e<t.length;e++){let i=t[e].name,s=t4[i];rL.has(s),rL.set(s,i);}};i(e),i(t),rL.clear();}draw(e,t,i=1,s,r=true,a=true){if(this.shader.ready&&!this.shader.failed){let a=this.passEncoder,n=this.pipeline,o=this.vertexBuffers[0],l=this.vertexBuffers[1];if(r){if(o){let e=this.submitVertexBuffer(o,0);l&&this.submitVertexBuffer(l,e);}n=this.renderPipeline.get(e,o?.format,l?.format,t?.format,this.shader,this.renderTarget,this.bindGroupFormats,this.blendState,this.depthState,this.cullMode,this.stencilEnabled,this.stencilFront,this.stencilBack),this.pipeline!==n&&(this.pipeline=n,a.setPipeline(n));}if(t&&a.setIndexBuffer(t.impl.buffer,t.impl.format),s){let e=(s.impl?.storage??this.indirectDrawBuffer).impl.buffer,i=s.count;for(let r=0;r<i;r++){let i=(s.slotIndex+r)*20;t?a.drawIndexedIndirect(e,i):a.drawIndirect(e,i);}}else t?a.drawIndexed(e.count,i,e.base,e.baseVertex??0,0):a.draw(e.count,i,e.base,0);this._drawCallsPerFrame++;}a&&(this.clearVertexBuffer(),this.pipeline=null);}setShader(e,t=false){e!==this.shader&&(this.shader=e);}setBlendState(e){this.blendState.copy(e);}setDepthState(e){this.depthState.copy(e);}setStencilState(e,t){if(e||t){this.stencilEnabled=true,this.stencilFront.copy(e??iN.DEFAULT),this.stencilBack.copy(t??iN.DEFAULT);let i=this.stencilFront.ref;this.stencilRef!==i&&(this.stencilRef=i,this.passEncoder.setStencilReference(i));}else this.stencilEnabled=false;}setBlendColor(e,t,i,s){let r=this.blendColor;(e!==r.r||t!==r.g||i!==r.b||s!==r.a)&&(r.set(e,t,i,s),this.passEncoder.setBlendConstant(r));}setCullMode(e){this.cullMode=e;}setAlphaToCoverage(e){}initializeContextCaches(){super.initializeContextCaches();}setupPassEncoderDefaults(){this.pipeline=null,this.stencilRef=0,this.blendColor.set(0,0,0,0);}_uploadDirtyTextures(){this.texturesToUpload.forEach(e=>{(e._needsUpload||e._needsMipmapsUpload)&&e.upload();}),this.texturesToUpload.clear();}setupTimeStampWrites(e,t){if(this.gpuProfiler._enabled&&this.gpuProfiler.timestampQueriesSet){let i=this.gpuProfiler.getSlot(t);-1===i||((e=e??{}).timestampWrites={querySet:this.gpuProfiler.timestampQueriesSet.querySet,beginningOfPassWriteIndex:2*i,endOfPassWriteIndex:2*i+1});}return e}startRenderPass(e){this._uploadDirtyTextures();let t=e.renderTarget||this.backBuffer;this.renderTarget=t;let i=t.impl;t!==this.backBuffer&&this.initRenderTarget(t),i.setupForRenderPass(e,t);let s=i.renderPassDescriptor;this.setupTimeStampWrites(s,e.name);let r=this.getCommandEncoder();this.passEncoder=r.beginRenderPass(s),this.passEncoder.label=`${e.name}-PassEncoder RT:${t.name}`,this.setupPassEncoderDefaults();let{width:a,height:n}=t;this.setViewport(0,0,a,n),this.setScissor(0,0,a,n),this.insideRenderPass=true;}endRenderPass(e){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=false,this.bindGroupFormats.length=0;let t=this.renderTarget;if(t&&t.depthBuffer&&e.depthStencilOps.resolveDepth&&e.samples>1&&t.autoResolve){let e=t.impl.depthAttachment,i=t.depthBuffer.impl.gpuTexture;e&&i&&this.resolver.resolveDepth(this.commandEncoder,e.multisampledDepthBuffer,i);}for(let t=0;t<e.colorArrayOps.length;t++)e.colorArrayOps[t].genMipmaps&&this.mipmapRenderer.generate(e.renderTarget._colorBuffers[t].impl);}startComputePass(e){this._uploadDirtyTextures(),this.pipeline=null;let t=this.setupTimeStampWrites(void 0,e),i=this.getCommandEncoder();this.passEncoder=i.beginComputePass(t),this.insideRenderPass=true;}endComputePass(){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=false,this.bindGroupFormats.length=0;}computeDispatch(e,t="Unnamed"){this.startComputePass(t);for(let t=0;t<e.length;t++){let i=e[t];i.applyParameters(),i.impl.updateBindGroup();}for(let t=0;t<e.length;t++){let i=e[t];i.impl.dispatch(i.countX,i.countY,i.countZ);}this.endComputePass();}getCommandEncoder(){let e=this.commandEncoder;return e||(e=this.wgpu.createCommandEncoder(),this.commandEncoder=e),e}endCommandEncoder(){let{commandEncoder:e}=this;if(e){let t=e.finish();this.addCommandBuffer(t),this.commandEncoder=null;}}addCommandBuffer(e,t=false){t?this.commandBuffers.unshift(e):this.commandBuffers.push(e);}submit(){this.endCommandEncoder(),this.commandBuffers.length>0&&(this.dynamicBuffers.submit(),this.wgpu.queue.submit(this.commandBuffers),this.commandBuffers.length=0,this.dynamicBuffers.onCommandBuffersSubmitted());let e=this._deferredDestroys;if(e.length>0){for(let t=0;t<e.length;t++)e[t].destroy();e.length=0;}}deferDestroy(e){e&&this._deferredDestroys.push(e);}clear(e){e.flags&&this.clearRenderer.clear(this,this.renderTarget,e,this.defaultClearOptions);}setViewport(e,t,i,s){this.passEncoder&&(this.renderTarget.flipY||(t=this.renderTarget.height-t-s),this.vx=e,this.vy=t,this.vw=i,this.vh=s,this.passEncoder.setViewport(e,t,i,s,0,1));}setScissor(e,t,i,s){this.passEncoder&&(this.renderTarget.flipY||(t=this.renderTarget.height-t-s),this.sx=e,this.sy=t,this.sw=i,this.sh=s,this.passEncoder.setScissorRect(e,t,i,s));}clearStorageBuffer(e,t=0,i=e.byteSize){this.getCommandEncoder().clearBuffer(e.buffer,t,i);}readStorageBuffer(e,t=0,i=e.byteSize-t,s=null,r=false){let a=this.createBufferImpl(9);a.allocate(this,i);let n=a.buffer;return this.getCommandEncoder().copyBufferToBuffer(e.buffer,t,n,0,i),this.readBuffer(a,i,s,r)}readBuffer(e,t,i=null,s=false){let r=e.buffer;return new Promise((a,n)=>{let o=()=>{r?.mapAsync(GPUMapMode.READ).then(()=>{i??(i=new Uint8Array(t));let s=r.getMappedRange(0,t),n=i.constructor;i.set(new n(s)),r.unmap(),e.destroy(this),a(i);});};s?(this.submit(),o()):setTimeout(()=>{o();});})}writeStorageBuffer(e,t=0,i,s=0,r){this.wgpu.queue.writeBuffer(e.buffer,t,i,s,r);}copyRenderTarget(e,t,i,s){let r={width:e?e.width:t.width,height:e?e.height:t.height,depthOrArrayLayers:1},a=this.getCommandEncoder();if(i){let i={texture:e?e.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:e?e.mipLevel:0},s={texture:t?t.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:t?t.mipLevel:0};a.copyTextureToTexture(i,s,r);}if(s){let i=e||this.renderTarget,s=i.impl.depthAttachment.depthTexture,n=i.mipLevel;if(e.samples>1){let e=t.colorBuffer.impl.gpuTexture;this.resolver.resolveDepth(a,s,e);}else {let e=t?t.depthBuffer.impl.gpuTexture:this.renderTarget.impl.depthAttachment.depthTexture,i=t?t.mipLevel:this.renderTarget.mipLevel;a.copyTextureToTexture({texture:s,mipLevel:n},{texture:e,mipLevel:i},r);}}return  true}get hasTranspilers(){return this.glslang&&this.twgsl}constructor(e,t={}){super(e,t),this._deferredDestroys=[],this.renderPipeline=new i9(this),this.computePipeline=new se(this),this._indirectDrawBuffer=null,this._indirectDrawBufferCount=0,this._indirectDrawNextIndex=0,this._indirectDispatchBuffer=null,this._indirectDispatchBufferCount=0,this._indirectDispatchNextIndex=0,this.pipeline=null,this.bindGroupFormats=[],this.commandEncoder=null,this.commandBuffers=[],this.glslang=null,this.twgsl=null,(t=this.initOptions).alpha=t.alpha??true,this.backBufferAntialias=t.antialias??false,this.isWebGPU=true,this._deviceType=tq,this.scope.resolve(tQ).setValue(0);}}class rO{destroy(e){this.bufferId&&(e.gl.deleteBuffer(this.bufferId),this.bufferId=null);}get initialized(){return !!this.bufferId}loseContext(){this.bufferId=null;}unlock(e,t,i,s){let r=e.gl;if(this.bufferId)r.bindBuffer(i,this.bufferId),r.bufferSubData(i,0,s);else {let e;switch(t){case 0:e=r.STATIC_DRAW;break;case 1:e=r.DYNAMIC_DRAW;break;case 2:e=r.STREAM_DRAW;break;case 3:e=r.DYNAMIC_COPY;}this.bufferId=r.createBuffer(),r.bindBuffer(i,this.bufferId),r.bufferData(i,s,e);}}constructor(){this.bufferId=null;}}class rF extends rO{destroy(e){super.destroy(e),e.unbindVertexArray();}loseContext(){super.loseContext(),this.vao=null;}unlock(e){let t=e.device;super.unlock(t,e.usage,t.gl.ARRAY_BUFFER,e.storage);}constructor(...e){super(...e),this.vao=null;}}class rN extends rO{unlock(e){let t=e.device;super.unlock(t,e.usage,t.gl.ELEMENT_ARRAY_BUFFER,e.storage);}constructor(e){super();let t=e.device.gl,i=e.format;0===i?this.glFormat=t.UNSIGNED_BYTE:1===i?this.glFormat=t.UNSIGNED_SHORT:2===i&&(this.glFormat=t.UNSIGNED_INT);}}class rB{constructor(e,t,i,s){if(this.locationId=s,this.scopeId=e.scope.resolve(t),this.version=new iT,"[0]"===t.substring(t.length-3))switch(i){case 2:i=17;break;case 1:i=30;break;case 26:i=31;break;case 0:i=32;break;case 3:i=21;break;case 6:i=33;break;case 27:i=34;break;case 9:i=35;break;case 4:i=22;break;case 7:i=36;break;case 28:i=37;break;case 10:i=38;break;case 5:i=23;break;case 8:i=39;break;case 29:i=40;break;case 11:i=41;}this.dataType=i,this.value=[null,null,null,null],this.array=[];}}let rk=new Set(["gl_VertexID","gl_InstanceID","gl_DrawID","gl_BaseVertex","gl_BaseInstance"]);class rU{destroy(e){this.map.forEach(t=>{e.gl.deleteShader(t);});}loseContext(e){this.map.clear();}constructor(){this.map=new Map;}}let rz=new ii,rV=new ii;class rG{destroy(e){this.glProgram&&(e.device.gl.deleteProgram(this.glProgram),this.glProgram=null);}init(){this.uniforms=[],this.samplers=[],this.attributes=[],this.glProgram=null,this.glVertexShader=null,this.glFragmentShader=null;}loseContext(){this.init();}restoreContext(e,t){this.compile(e,t),this.link(e,t);}compile(e,t){let i=t.definition;this.glVertexShader=this._compileShaderSource(e,i.vshader,true),this.glFragmentShader=this._compileShaderSource(e,i.fshader,false);}link(e,t){if(this.glProgram)return;let i=e.gl;if(i.isContextLost())return;let s=i.createProgram();this.glProgram=s,i.attachShader(s,this.glVertexShader),i.attachShader(s,this.glFragmentShader);let r=t.definition,a=r.attributes;if(r.useTransformFeedback){let e=r.feedbackVaryings;if(!e)for(let t in e=[],a)a.hasOwnProperty(t)&&e.push(`out_${t}`);i.transformFeedbackVaryings(s,e,i.INTERLEAVED_ATTRIBS);}for(let e in a)if(a.hasOwnProperty(e)){let t=t4[a[e]];i.bindAttribLocation(s,t,e);}i.linkProgram(s);}_compileShaderSource(e,t,i){let s=e.gl;if(s.isContextLost())return null;let r=(i?rz:rV).get(e,()=>new rU),a=r.map.get(t);return a||(a=s.createShader(i?s.VERTEX_SHADER:s.FRAGMENT_SHADER),s.shaderSource(a,t),s.compileShader(a),r.map.set(t,a)),a}finalize(e,t){let i=e.gl;if(i.isContextLost())return  true;let s=this.glProgram,r=t.definition;if(!i.getProgramParameter(s,i.LINK_STATUS))return !!this._isCompiled(e,t,this.glVertexShader,r.vshader,"vertex")&&!!this._isCompiled(e,t,this.glFragmentShader,r.fshader,"fragment")&&(i.getProgramInfoLog(s),false);let a=i.getProgramParameter(s,i.ACTIVE_ATTRIBUTES);t.attributes.clear();for(let e=0;e<a;e++){let a=i.getActiveAttrib(s,e),n=i.getAttribLocation(s,a.name);rk.has(a.name)||(void 0===r.attributes[a.name]?t.failed=true:t.attributes.set(n,a.name));}let n=e._samplerTypes,o=i.getProgramParameter(s,i.ACTIVE_UNIFORMS);for(let t=0;t<o;t++){let r=i.getActiveUniform(s,t),a=i.getUniformLocation(s,r.name);if(rk.has(r.name))continue;let o=new rB(e,r.name,e.pcUniformType[r.type],a);n.has(r.type)?this.samplers.push(o):this.uniforms.push(o);}return t.ready=true,true}_isCompiled(e,t,i,s,r){let a=e.gl;if(!a.getShaderParameter(i,a.COMPILE_STATUS)){let e=a.getShaderInfoLog(i),[t,r]=this._processError(s,e);return  false}return  true}isLinked(e){let{extParallelShaderCompile:t}=e;return !t||e.gl.getProgramParameter(this.glProgram,t.COMPLETION_STATUS_KHR)}_processError(e,t){let i={},s="";if(e){let r=e.split("\n"),a=0,n=r.length;if(t&&t.startsWith("ERROR:")){let e=t.match(/^ERROR:\s(\d+):(\d+):\s*(.+)/);e&&(i.message=e[3],i.line=parseInt(e[2],10),a=Math.max(0,i.line-6),n=Math.min(r.length,i.line+5));}for(let e=a;e<n;e++){let t=e+1===i.line?"> ":"  ";s+=`${t}${e+1}:	${r[e]}
`;}i.source=e;}return [s,i]}constructor(e){this.compileDuration=0,this.init(),this.compile(e.device,e),this.link(e.device,e),e.device.shaders.push(e);}}class rH{allocate(e){this.glCounts&&this.glCounts.length===e||(this.glCounts=new Int32Array(e),this.glOffsetsBytes=new Int32Array(e),this.glInstanceCounts=new Int32Array(e));}add(e,t,i,s){this.glCounts[e]=t,this.glOffsetsBytes[e]=s*this.indexSizeBytes,this.glInstanceCounts[e]=i;}update(e){return 0}constructor(e){this.glCounts=null,this.glOffsetsBytes=null,this.glInstanceCounts=null,this.indexSizeBytes=e;}}function rW(e,t){let i=e.width,s=e.height;if(i>t||s>t){let r=t/Math.max(i,s),a=Math.floor(i*r),n=Math.floor(s*r),o=document.createElement("canvas");return o.width=a,o.height=n,o.getContext("2d").drawImage(e,0,0,i,s,0,0,a,n),o}return e}class rX{destroy(e){if(this._glTexture){for(let t=0;t<e.textureUnits.length;t++){let i=e.textureUnits[t];for(let e=0;e<i.length;e++)i[e]===this._glTexture&&(i[e]=null);}e.gl.deleteTexture(this._glTexture),this._glTexture=null;}}loseContext(){this._glTexture=null;}propertyChanged(e){this.dirtyParameterFlags|=e;}initialize(e,t){let i=e.gl;switch(this._glTexture=i.createTexture(),this._glTarget=t._cubemap?i.TEXTURE_CUBE_MAP:t._volume?i.TEXTURE_3D:t.array?i.TEXTURE_2D_ARRAY:i.TEXTURE_2D,t._format){case 0:this._glFormat=i.ALPHA,this._glInternalFormat=i.ALPHA,this._glPixelType=i.UNSIGNED_BYTE;break;case 1:this._glFormat=i.LUMINANCE,this._glInternalFormat=i.LUMINANCE,this._glPixelType=i.UNSIGNED_BYTE;break;case 2:this._glFormat=i.LUMINANCE_ALPHA,this._glInternalFormat=i.LUMINANCE_ALPHA,this._glPixelType=i.UNSIGNED_BYTE;break;case 52:this._glFormat=i.RED,this._glInternalFormat=i.R8,this._glPixelType=i.UNSIGNED_BYTE;break;case 53:this._glFormat=i.RG,this._glInternalFormat=i.RG8,this._glPixelType=i.UNSIGNED_BYTE;break;case 3:this._glFormat=i.RGB,this._glInternalFormat=i.RGB565,this._glPixelType=i.UNSIGNED_SHORT_5_6_5;break;case 4:this._glFormat=i.RGBA,this._glInternalFormat=i.RGB5_A1,this._glPixelType=i.UNSIGNED_SHORT_5_5_5_1;break;case 5:this._glFormat=i.RGBA,this._glInternalFormat=i.RGBA4,this._glPixelType=i.UNSIGNED_SHORT_4_4_4_4;break;case 6:this._glFormat=i.RGB,this._glInternalFormat=i.RGB8,this._glPixelType=i.UNSIGNED_BYTE;break;case 7:this._glFormat=i.RGBA,this._glInternalFormat=i.RGBA8,this._glPixelType=i.UNSIGNED_BYTE;break;case 31:case 64:case 70:break;case 71:this._glFormat=i.RGB,this._glInternalFormat=i.RGB9_E5,this._glPixelType=i.UNSIGNED_INT_5_9_9_9_REV;break;case 72:this._glFormat=i.RG,this._glInternalFormat=i.RG8_SNORM,this._glPixelType=i.BYTE;break;case 73:this._glFormat=i.RGBA,this._glInternalFormat=i.RGBA8_SNORM,this._glPixelType=i.BYTE;break;case 74:this._glFormat=i.RGBA,this._glInternalFormat=i.RGB10_A2,this._glPixelType=i.UNSIGNED_INT_2_10_10_10_REV;break;case 75:this._glFormat=i.RGBA_INTEGER,this._glInternalFormat=i.RGB10_A2UI,this._glPixelType=i.UNSIGNED_INT_2_10_10_10_REV;break;case 8:this._glFormat=i.RGB,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:this._glFormat=i.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case 10:this._glFormat=i.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:this._glFormat=i.RGB,this._glInternalFormat=e.extCompressedTextureETC1.COMPRESSED_RGB_ETC1_WEBGL;break;case 24:this._glFormat=i.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case 25:this._glFormat=i.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:this._glFormat=i.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:this._glFormat=i.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 22:this._glFormat=i.RGB,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGB8_ETC2;break;case 23:this._glFormat=i.RGBA,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:this._glFormat=i.RGBA,this._glInternalFormat=e.extCompressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:this._glFormat=i.RGB,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGB_ATC_WEBGL;break;case 30:this._glFormat=i.RGBA,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 65:this._glFormat=i.RGB,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;break;case 66:this._glFormat=i.RGB,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT;break;case 67:this._glFormat=i.RGBA,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGBA_BPTC_UNORM_EXT;break;case 54:this._glFormat=i.SRGB,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_S3TC_DXT1_EXT;break;case 55:this._glFormat=i.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;break;case 56:this._glFormat=i.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;break;case 61:this._glFormat=i.SRGB,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_SRGB8_ETC2;break;case 62:this._glFormat=i.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;break;case 63:this._glFormat=i.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 68:this._glFormat=i.RGBA,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 50:this._glFormat=i.RED,this._glInternalFormat=i.R16F,this._glPixelType=i.HALF_FLOAT;break;case 51:this._glFormat=i.RG,this._glInternalFormat=i.RG16F,this._glPixelType=i.HALF_FLOAT;break;case 11:this._glFormat=i.RGB,this._glInternalFormat=i.RGB16F,this._glPixelType=i.HALF_FLOAT;break;case 12:this._glFormat=i.RGBA,this._glInternalFormat=i.RGBA16F,this._glPixelType=i.HALF_FLOAT;break;case 13:this._glFormat=i.RGB,this._glInternalFormat=i.RGB32F,this._glPixelType=i.FLOAT;break;case 14:this._glFormat=i.RGBA,this._glInternalFormat=i.RGBA32F,this._glPixelType=i.FLOAT;break;case 15:this._glFormat=i.RED,this._glInternalFormat=i.R32F,this._glPixelType=i.FLOAT;break;case 16:this._glFormat=i.DEPTH_COMPONENT,this._glInternalFormat=i.DEPTH_COMPONENT32F,this._glPixelType=i.FLOAT;break;case 69:this._glFormat=i.DEPTH_COMPONENT,this._glInternalFormat=i.DEPTH_COMPONENT16,this._glPixelType=i.UNSIGNED_SHORT;break;case 17:this._glFormat=i.DEPTH_STENCIL,this._glInternalFormat=i.DEPTH24_STENCIL8,this._glPixelType=i.UNSIGNED_INT_24_8;break;case 18:this._glFormat=i.RGB,this._glInternalFormat=i.R11F_G11F_B10F,this._glPixelType=i.UNSIGNED_INT_10F_11F_11F_REV;break;case 19:this._glFormat=i.RGB,this._glInternalFormat=i.SRGB8,this._glPixelType=i.UNSIGNED_BYTE;break;case 20:this._glFormat=i.RGBA,this._glInternalFormat=i.SRGB8_ALPHA8,this._glPixelType=i.UNSIGNED_BYTE;break;case 32:this._glFormat=i.RED_INTEGER,this._glInternalFormat=i.R8I,this._glPixelType=i.BYTE;break;case 33:this._glFormat=i.RED_INTEGER,this._glInternalFormat=i.R8UI,this._glPixelType=i.UNSIGNED_BYTE;break;case 34:this._glFormat=i.RED_INTEGER,this._glInternalFormat=i.R16I,this._glPixelType=i.SHORT;break;case 35:this._glFormat=i.RED_INTEGER,this._glInternalFormat=i.R16UI,this._glPixelType=i.UNSIGNED_SHORT;break;case 36:this._glFormat=i.RED_INTEGER,this._glInternalFormat=i.R32I,this._glPixelType=i.INT;break;case 37:this._glFormat=i.RED_INTEGER,this._glInternalFormat=i.R32UI,this._glPixelType=i.UNSIGNED_INT;break;case 38:this._glFormat=i.RG_INTEGER,this._glInternalFormat=i.RG8I,this._glPixelType=i.BYTE;break;case 39:this._glFormat=i.RG_INTEGER,this._glInternalFormat=i.RG8UI,this._glPixelType=i.UNSIGNED_BYTE;break;case 40:this._glFormat=i.RG_INTEGER,this._glInternalFormat=i.RG16I,this._glPixelType=i.SHORT;break;case 41:this._glFormat=i.RG_INTEGER,this._glInternalFormat=i.RG16UI,this._glPixelType=i.UNSIGNED_SHORT;break;case 42:this._glFormat=i.RG_INTEGER,this._glInternalFormat=i.RG32I,this._glPixelType=i.INT;break;case 43:this._glFormat=i.RG_INTEGER,this._glInternalFormat=i.RG32UI,this._glPixelType=i.UNSIGNED_INT;break;case 44:this._glFormat=i.RGBA_INTEGER,this._glInternalFormat=i.RGBA8I,this._glPixelType=i.BYTE;break;case 45:this._glFormat=i.RGBA_INTEGER,this._glInternalFormat=i.RGBA8UI,this._glPixelType=i.UNSIGNED_BYTE;break;case 46:this._glFormat=i.RGBA_INTEGER,this._glInternalFormat=i.RGBA16I,this._glPixelType=i.SHORT;break;case 47:this._glFormat=i.RGBA_INTEGER,this._glInternalFormat=i.RGBA16UI,this._glPixelType=i.UNSIGNED_SHORT;break;case 48:this._glFormat=i.RGBA_INTEGER,this._glInternalFormat=i.RGBA32I,this._glPixelType=i.INT;break;case 49:this._glFormat=i.RGBA_INTEGER,this._glInternalFormat=i.RGBA32UI,this._glPixelType=i.UNSIGNED_INT;}this._glCreated=false;}upload(e,t){let i,s,r=e.gl;if(!t._needsUpload&&(t._needsMipmapsUpload&&t._mipmapsUploaded||!t.pot))return;let a=0,n=t.numLevels;for(t.array&&!this._glCreated&&r.texStorage3D(r.TEXTURE_2D_ARRAY,n,this._glInternalFormat,t._width,t._height,t._arrayLength);t._levels[a]||0===a;){if(t._needsUpload||0!==a){if(a&&(!t._needsMipmapsUpload||!t._mipmaps))break}else {a++;continue}if(i=t._levels[a],s=1/Math.pow(2,a),1!==a||t._compressed||t._integerFormat||!(t._levels.length<n)||(r.generateMipmap(this._glTarget),t._mipmapsUploaded=true),t._cubemap){let n;if(e._isBrowserInterface(i[0]))for(n=0;n<6;n++){if(!t._levelsUpdated[0][n])continue;let s=i[n];e._isImageBrowserInterface(s)&&(s.width>e.maxCubeMapSize||s.height>e.maxCubeMapSize)&&(s=rW(s,e.maxCubeMapSize),0===a&&(t._width=s.width,t._height=s.height)),e.setUnpackFlipY(false),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated?r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+n,a,0,0,this._glFormat,this._glPixelType,s):r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+n,a,this._glInternalFormat,this._glFormat,this._glPixelType,s);}else for(n=0,s=1/Math.pow(2,a);n<6;n++){if(!t._levelsUpdated[0][n])continue;let o=i[n];t._compressed?this._glCreated&&o?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+n,a,0,0,Math.max(t._width*s,1),Math.max(t._height*s,1),this._glInternalFormat,o):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+n,a,this._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),0,o):(e.setUnpackFlipY(false),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.setUnpackAlignment(1),this._glCreated&&o?r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+n,a,0,0,Math.max(t._width*s,1),Math.max(t._height*s,1),this._glFormat,this._glPixelType,o):r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+n,a,this._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),0,this._glFormat,this._glPixelType,o));}}else if(t._volume)t._compressed?r.compressedTexImage3D(r.TEXTURE_3D,a,this._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),Math.max(t._depth*s,1),0,i):(e.setUnpackFlipY(false),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.setUnpackAlignment(1),r.texImage3D(r.TEXTURE_3D,a,this._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),Math.max(t._depth*s,1),0,this._glFormat,this._glPixelType,i));else if(t.array){if(Array.isArray(i)&&t._arrayLength===i.length)if(t._compressed)for(let e=0;e<t._arrayLength;e++)r.compressedTexSubImage3D(r.TEXTURE_2D_ARRAY,a,0,0,e,Math.max(Math.floor(t._width*s),1),Math.max(Math.floor(t._height*s),1),1,this._glInternalFormat,i[e]);else {e.setUnpackAlignment(1);for(let e=0;e<t._arrayLength;e++)r.texSubImage3D(r.TEXTURE_2D_ARRAY,a,0,0,e,Math.max(Math.floor(t._width*s),1),Math.max(Math.floor(t._height*s),1),1,this._glFormat,this._glPixelType,i[e]);}}else {if(e._isBrowserInterface(i)){e._isImageBrowserInterface(i)&&(i.width>e.maxTextureSize||i.height>e.maxTextureSize)&&(i=rW(i,e.maxTextureSize),0===a&&(t._width=i.width,t._height=i.height));let s=i.width||i.videoWidth,n=i.height||i.videoHeight;e.setUnpackFlipY(t._flipY),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&t._width===s&&t._height===n&&!e._isImageVideoInterface(i)?r.texSubImage2D(r.TEXTURE_2D,a,0,0,this._glFormat,this._glPixelType,i):(r.texImage2D(r.TEXTURE_2D,a,this._glInternalFormat,this._glFormat,this._glPixelType,i),0===a&&(t._width=s,t._height=n));}else s=1/Math.pow(2,a),t._compressed?this._glCreated&&i?r.compressedTexSubImage2D(r.TEXTURE_2D,a,0,0,Math.max(Math.floor(t._width*s),1),Math.max(Math.floor(t._height*s),1),this._glInternalFormat,i):r.compressedTexImage2D(r.TEXTURE_2D,a,this._glInternalFormat,Math.max(Math.floor(t._width*s),1),Math.max(Math.floor(t._height*s),1),0,i):(e.setUnpackFlipY(false),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.setUnpackAlignment(1),this._glCreated&&i?r.texSubImage2D(r.TEXTURE_2D,a,0,0,Math.max(t._width*s,1),Math.max(t._height*s,1),this._glFormat,this._glPixelType,i):r.texImage2D(r.TEXTURE_2D,a,this._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),0,this._glFormat,this._glPixelType,i));0===a?t._mipmapsUploaded=false:t._mipmapsUploaded=true;}a++;}if(t._needsUpload)if(t._cubemap)for(let e=0;e<6;e++)t._levelsUpdated[0][e]=false;else t._levelsUpdated[0]=false;!t._compressed&&!t._integerFormat&&t._mipmaps&&t._needsMipmapsUpload&&1===t._levels.length&&(r.generateMipmap(this._glTarget),t._mipmapsUploaded=true),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize),this._glCreated=true;}uploadImmediate(e,t){(t._needsUpload||t._needsMipmapsUpload)&&(e.setTexture(t,0),t._needsUpload=false,t._needsMipmapsUpload=false);}read(e,t,i,s,r){let a=this.texture;return a.device.readTextureAsync(a,e,t,i,s,r)}write(e,t,i,s,r){let{texture:a}=this,{device:n}=a;return n.setTexture(a,0),n.writeTextureAsync(a,e,t,i,s,r)}constructor(e){this._glTexture=null,this.dirtyParameterFlags=0,this.texture=e;}}class rY{destroy(e){this.msaaFB&&(e.deleteRenderbuffer(this.msaaFB),this.msaaFB=null),this.resolveFB&&(e.deleteRenderbuffer(this.resolveFB),this.resolveFB=null);}constructor(e,t){this.msaaFB=e,this.resolveFB=t;}}class rq{destroy(e){let t=e.gl;this._isInitialized=false,this._glFrameBuffer&&(this._glFrameBuffer!==this.suppliedColorFramebuffer&&t.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(t.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(this._glResolveFrameBuffer!==this.suppliedColorFramebuffer&&t.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffers.forEach(e=>{t.deleteRenderbuffer(e);}),this._glMsaaColorBuffers.length=0,this.colorMrtFramebuffers?.forEach(e=>{e.destroy(t);}),this.colorMrtFramebuffers=null,this._glMsaaDepthBuffer&&(this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey&&sn(e).release(this.msaaDepthBufferKey)),this.suppliedColorFramebuffer=void 0;}get initialized(){return this._isInitialized}init(e,t){let i=e.gl;this._isInitialized=true;let s=[];if(void 0!==this.suppliedColorFramebuffer)this._glFrameBuffer=this.suppliedColorFramebuffer;else {this._glFrameBuffer=i.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);let r=t._colorBuffers?.length??0,a=i.COLOR_ATTACHMENT0;for(let n=0;n<r;++n){let r=t.getColorBuffer(n);r&&(r.impl._glTexture||(r._width=Math.min(r.width,e.maxRenderBufferSize),r._height=Math.min(r.height,e.maxRenderBufferSize),e.setTexture(r,0)),i.framebufferTexture2D(i.FRAMEBUFFER,a+n,r._cubemap?i.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:i.TEXTURE_2D,r.impl._glTexture,t.mipLevel),s.push(a+n));}i.drawBuffers(s);let n=t._depthBuffer;if(n||t._depth){let s=t._stencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;if(n)n.impl._glTexture||(n._width=Math.min(n.width,e.maxRenderBufferSize),n._height=Math.min(n.height,e.maxRenderBufferSize),e.setTexture(n,0)),i.framebufferTexture2D(i.FRAMEBUFFER,s,n._cubemap?i.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:i.TEXTURE_2D,t._depthBuffer.impl._glTexture,t.mipLevel);else if(!(t._samples>1)){this._glDepthBuffer||(this._glDepthBuffer=i.createRenderbuffer());let e=t._stencil?i.DEPTH24_STENCIL8:i.DEPTH_COMPONENT32F;i.bindRenderbuffer(i.RENDERBUFFER,this._glDepthBuffer),i.renderbufferStorage(i.RENDERBUFFER,e,t.width,t.height),i.framebufferRenderbuffer(i.FRAMEBUFFER,s,i.RENDERBUFFER,this._glDepthBuffer),i.bindRenderbuffer(i.RENDERBUFFER,null);}}}if(t._samples>1){this._glResolveFrameBuffer=this._glFrameBuffer,this._glFrameBuffer=i.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);let r=t._colorBuffers?.length??0;if(void 0!==this.suppliedColorFramebuffer){let s=i.createRenderbuffer();this._glMsaaColorBuffers.push(s);let r=7===e.backBufferFormat?i.RGBA8:i.RGB8;i.bindRenderbuffer(i.RENDERBUFFER,s),i.renderbufferStorageMultisample(i.RENDERBUFFER,t._samples,r,t.width,t.height),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.RENDERBUFFER,s);}else for(let e=0;e<r;++e){let s=t.getColorBuffer(e);if(s){let r=i.createRenderbuffer();this._glMsaaColorBuffers.push(r),i.bindRenderbuffer(i.RENDERBUFFER,r),i.renderbufferStorageMultisample(i.RENDERBUFFER,t._samples,s.impl._glInternalFormat,t.width,t.height),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+e,i.RENDERBUFFER,r);}}if(t._depth){let s,r=t._stencil?i.DEPTH24_STENCIL8:i.DEPTH_COMPONENT32F,a=t._stencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT,n=t._depthBuffer;n&&(s=`${n.id}:${t.width}:${t.height}:${t._samples}:${r}:${a}`,this._glMsaaDepthBuffer=sn(e).get(s)),!this._glMsaaDepthBuffer&&(this._glMsaaDepthBuffer=i.createRenderbuffer(),i.bindRenderbuffer(i.RENDERBUFFER,this._glMsaaDepthBuffer),i.renderbufferStorageMultisample(i.RENDERBUFFER,t._samples,r,t.width,t.height),this._glMsaaDepthBuffer.destroy=function(){i.deleteRenderbuffer(this);},n&&sn(e).set(s,this._glMsaaDepthBuffer)),this.msaaDepthBufferKey=s,i.framebufferRenderbuffer(i.FRAMEBUFFER,a,i.RENDERBUFFER,this._glMsaaDepthBuffer);}r>1&&(this._createMsaaMrtFramebuffers(e,t,r),e.setFramebuffer(this._glFrameBuffer),i.drawBuffers(s));}}_createMsaaMrtFramebuffers(e,t,i){let s=e.gl;this.colorMrtFramebuffers=[];for(let r=0;r<i;++r){let i=t.getColorBuffer(r),a=s.createFramebuffer();e.setFramebuffer(a);let n=this._glMsaaColorBuffers[r];s.bindRenderbuffer(s.RENDERBUFFER,n),s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,i.impl._glInternalFormat,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,n),s.drawBuffers([s.COLOR_ATTACHMENT0]);let o=s.createFramebuffer();e.setFramebuffer(o),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,i._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:s.TEXTURE_2D,i.impl._glTexture,0),this.colorMrtFramebuffers[r]=new rY(a,o);}}_checkFbo(e,t,i=""){let s=e.gl;switch(s.checkFramebufferStatus(s.FRAMEBUFFER)){case s.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:case s.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:case s.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:case s.FRAMEBUFFER_UNSUPPORTED:}}loseContext(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffers.length=0,this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey=void 0,this.colorMrtFramebuffers=null,this.suppliedColorFramebuffer=void 0,this._isInitialized=false;}internalResolve(e,t,i,s,r){e.setScissor(0,0,s.width,s.height);let a=e.gl;a.bindFramebuffer(a.READ_FRAMEBUFFER,t),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,i),a.blitFramebuffer(0,0,s.width,s.height,0,0,s.width,s.height,r,a.NEAREST);}resolve(e,t,i,s){let r=e.gl;if(this.colorMrtFramebuffers){if(i)for(let i=0;i<this.colorMrtFramebuffers.length;i++){let s=this.colorMrtFramebuffers[i];this.internalResolve(e,s.msaaFB,s.resolveFB,t,r.COLOR_BUFFER_BIT);}s&&this.internalResolve(e,this._glFrameBuffer,this._glResolveFrameBuffer,t,r.DEPTH_BUFFER_BIT);}else this.internalResolve(e,this._glFrameBuffer,this._glResolveFrameBuffer,t,(i?r.COLOR_BUFFER_BIT:0)|(s?r.DEPTH_BUFFER_BIT:0));r.bindFramebuffer(r.FRAMEBUFFER,this._glFrameBuffer);}constructor(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this.colorMrtFramebuffers=null,this._glMsaaColorBuffers=[],this._glMsaaDepthBuffer=null,this._isInitialized=false;}}class r${destroy(){let e=this.uploadStream.device.gl;this.availablePBOs.forEach(t=>e.deleteBuffer(t.pbo)),this.pendingPBOs.forEach(t=>{t.sync&&e.deleteSync(t.sync),e.deleteBuffer(t.pbo);});}_onDeviceLost(){this.availablePBOs.length=0,this.pendingPBOs.length=0;}update(e){let t=this.uploadStream.device.gl,i=this.pendingPBOs;for(let e=i.length-1;e>=0;e--){let s=i[e],r=t.clientWaitSync(s.sync,0,0);(r===t.CONDITION_SATISFIED||r===t.ALREADY_SIGNALED)&&(t.deleteSync(s.sync),this.availablePBOs.push({pbo:s.pbo,size:s.size}),i.splice(e,1));}let s=this.availablePBOs;for(let i=s.length-1;i>=0;i--)s[i].size<e&&(t.deleteBuffer(s[i].pbo),s.splice(i,1));}upload(e,t,i,s){this.useSingleBuffer?this.uploadDirect(e,t,i,s):this.uploadPBO(e,t,i,s);}uploadDirect(e,t,i,s){t._levels[0]=e,t.upload();}uploadPBO(e,t,i,s){let r=this.uploadStream.device,a=r.gl,n=t.width,o=s*e.BYTES_PER_ELEMENT;this.update(o);let l=this.availablePBOs.pop()??{pbo:a.createBuffer()};a.bindBuffer(a.PIXEL_UNPACK_BUFFER,l.pbo),a.bufferData(a.PIXEL_UNPACK_BUFFER,o,a.STREAM_DRAW),a.bufferSubData(a.PIXEL_UNPACK_BUFFER,0,new Uint8Array(e.buffer,e.byteOffset,o)),a.bindBuffer(a.PIXEL_UNPACK_BUFFER,null),r.setTexture(t,0),r.activeTexture(0),r.bindTexture(t),a.bindBuffer(a.PIXEL_UNPACK_BUFFER,l.pbo),r.setUnpackFlipY(false),r.setUnpackPremultiplyAlpha(false),r.setUnpackAlignment(e.BYTES_PER_ELEMENT),a.pixelStorei(a.UNPACK_ROW_LENGTH,0),a.pixelStorei(a.UNPACK_SKIP_ROWS,0),a.pixelStorei(a.UNPACK_SKIP_PIXELS,0);let h=t.impl;a.texSubImage2D(a.TEXTURE_2D,0,0,i/n,n,s/n,h._glFormat,h._glPixelType,0),a.bindBuffer(a.PIXEL_UNPACK_BUFFER,null);let c=a.fenceSync(a.SYNC_GPU_COMMANDS_COMPLETE,0);this.pendingPBOs.push({pbo:l.pbo,size:o,sync:c}),a.flush();}constructor(e){this.availablePBOs=[],this.pendingPBOs=[],this.uploadStream=e,this.useSingleBuffer=e.useSingleBuffer;}}class rj{destroy(e){this.queries.forEach(t=>e.deleteQuery(t)),this.queries=null;}constructor(){this.queries=[];}}class rK extends rE{destroy(){this.freeQueries.forEach(e=>this.device.gl.deleteQuery(e)),this.frameQueries.forEach(e=>this.device.gl.deleteQuery(e)),this.previousFrameQueries.forEach(e=>e.destroy(this.device.gl)),this.freeQueries=null,this.frameQueries=null,this.previousFrameQueries=null;}loseContext(){super.loseContext(),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[];}restoreContext(){this.ext=this.device.extDisjointTimerQuery;}getQuery(){return this.freeQueries.pop()??this.device.gl.createQuery()}start(e){if(this.ext){let t=this.getSlot(e),i=this.getQuery();return this.frameQueries[t]=i,this.device.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,i),t}}end(e){ void 0!==e&&this.device.gl.endQuery(this.ext.TIME_ELAPSED_EXT);}frameStart(){this.processEnableRequest(),this._enabled&&(this.frameGPUMarkerSlot=this.start("GpuFrame"));}frameEnd(){this._enabled&&this.end(this.frameGPUMarkerSlot);}request(){if(this._enabled){let e=this.ext,t=this.device.gl,i=this.device.renderVersion,s=this.frameQueries;if(s.length>0){this.frameQueries=[];let e=new rj;e.queries=s,e.renderVersion=i,this.previousFrameQueries.push(e);}if(this.previousFrameQueries.length>0){let i=this.previousFrameQueries[0],s=i.queries,r=s[s.length-1],a=t.getQueryParameter(r,t.QUERY_RESULT_AVAILABLE),n=t.getParameter(e.GPU_DISJOINT_EXT);if(a&&!n){this.previousFrameQueries.shift();let e=this.timings;e.length=0;for(let i=0;i<s.length;i++){let r=s[i],a=t.getQueryParameter(r,t.QUERY_RESULT);e[i]=1e-6*a,this.freeQueries.push(r);}this.report(i.renderVersion,e);}n&&(this.previousFrameQueries.forEach(e=>{this.report(e.renderVersion,null),e.destroy(t);}),this.previousFrameQueries.length=0);}super.request(i);}}constructor(e){super(),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[],this.timings=[],this.device=e,this.ext=e.extDisjointTimerQuery;}}let rZ=[];class rQ extends iB{postInit(){super.postInit(),this.gpuProfiler=new rK(this);}destroy(){super.destroy();let e=this.gl;this.feedback&&e.deleteTransformFeedback(this.feedback),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,false),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,false),this._contextLostHandler=null,this._contextRestoredHandler=null,this.gl=null,super.postDestroy();}createBackbuffer(e){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new iU({name:"WebglFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.suppliedColorFramebuffer=e;}updateBackbufferFormat(e){let t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e);let i=this.gl.getParameter(this.gl.ALPHA_BITS);this.backBufferFormat=i?7:6;}updateBackbuffer(){let e=this.canvas.width!==this.backBufferSize.x||this.canvas.height!==this.backBufferSize.y;(this._defaultFramebufferChanged||e)&&(this._defaultFramebufferChanged&&this.updateBackbufferFormat(this._defaultFramebuffer),this._defaultFramebufferChanged=false,this.backBufferSize.set(this.canvas.width,this.canvas.height),this.backBuffer.destroy(),this.createBackbuffer(this._defaultFramebuffer));}createVertexBufferImpl(e,t){return new rF}createIndexBufferImpl(e){return new rN(e)}createShaderImpl(e){return new rG(e)}createDrawCommandImpl(e){return new rH(e.indexSizeBytes)}createTextureImpl(e){return this.textures.add(e),new rX(e)}createRenderTargetImpl(e){return new rq}createUploadStreamImpl(e){return new r$(e)}getPrecision(){let e=this.gl,t="highp";if(e.getShaderPrecisionFormat){let i=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT),s=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT),r=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT),a=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT);if(i&&s&&r&&a){let e=i.precision>0&&r.precision>0,n=s.precision>0&&a.precision>0;e||(t=n?"mediump":"lowp");}}return t}getExtension(){for(let e=0;e<arguments.length;e++)if(-1!==this.supportedExtensions.indexOf(arguments[e]))return this.gl.getExtension(arguments[e]);return null}get extDisjointTimerQuery(){return this._extDisjointTimerQuery||(this._extDisjointTimerQuery=this.getExtension("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query")),this._extDisjointTimerQuery}initializeExtensions(){let e=this.gl;this.supportedExtensions=e.getSupportedExtensions()??[],this._extDisjointTimerQuery=null,this.textureRG11B10Renderable=true,this.extColorBufferFloat=this.getExtension("EXT_color_buffer_float"),this.textureFloatRenderable=!!this.extColorBufferFloat,this.extColorBufferHalfFloat=this.getExtension("EXT_color_buffer_half_float"),this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat||!!this.extColorBufferFloat,this.extDebugRendererInfo=this.getExtension("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=this.getExtension("OES_texture_float_linear"),this.textureFloatFilterable=!!this.extTextureFloatLinear,this.extFloatBlend=this.getExtension("EXT_float_blend"),this.extTextureFilterAnisotropic=this.getExtension("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extParallelShaderCompile=this.getExtension("KHR_parallel_shader_compile"),this.extMultiDraw=this.getExtension("WEBGL_multi_draw"),this.supportsMultiDraw=!!this.extMultiDraw,this.extCompressedTextureETC1=this.getExtension("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=this.getExtension("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=this.getExtension("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=this.getExtension("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureS3TC_SRGB=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this.extCompressedTextureATC=this.getExtension("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=this.getExtension("WEBGL_compressed_texture_astc"),this.extTextureCompressionBPTC=this.getExtension("EXT_texture_compression_bptc");}initializeCapabilities(){let e,t=this.gl,i="undefined"!=typeof navigator?navigator.userAgent:"";this.maxPrecision=this.precision=this.getPrecision();let s=t.getContextAttributes();this.supportsMsaa=s?.antialias??false,this.supportsStencil=s?.stencil??false,this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubeMapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE),this.maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this.maxColorAttachments=t.getParameter(t.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE),e=this.extDebugRendererInfo,this.unmaskedRenderer=e?t.getParameter(e.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=e?t.getParameter(e.UNMASKED_VENDOR_WEBGL):"",this.supportsGpuParticles=!("ARM"===this.unmaskedVendor&&i.match(/SM-[a-zA-Z0-9]+/))&&!this.unmaskedRenderer.match(/\bMali-G52+/),e=this.extTextureFilterAnisotropic,this.maxAnisotropy=e?t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1;let r=!this.forceDisableMultisampling;this.maxSamples=r?t.getParameter(t.MAX_SAMPLES):1,this.maxSamples=Math.min(this.maxSamples,4),this.samples=r&&this.backBufferAntialias?this.maxSamples:1,this.supportsAreaLights=!k.android,this.maxTextures<=8&&(this.supportsAreaLights=false),this.initCapsDefines();}initializeRenderState(){super.initializeRenderState();let e=this.gl;e.disable(e.BLEND),e.blendFunc(e.ONE,e.ZERO),e.blendEquation(e.FUNC_ADD),e.colorMask(true,true,true,true),e.blendColor(0,0,0,0),e.enable(e.CULL_FACE),this.cullFace=e.BACK,e.cullFace(e.BACK),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.depthMask(true),this.stencil=false,e.disable(e.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=7,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,e.stencilFunc(e.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=0,this.stencilZfailFront=this.stencilZfailBack=0,this.stencilZpassFront=this.stencilZpassBack=0,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.stencilMask(255),this.alphaToCoverage=false,this.raster=true,e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.RASTERIZER_DISCARD),this.depthBiasEnabled=false,e.disable(e.POLYGON_OFFSET_FILL),this.clearDepth=1,e.clearDepth(1),this.clearColor=new es(0,0,0,0),e.clearColor(0,0,0,0),this.clearStencil=0,e.clearStencil(0),e.hint(e.FRAGMENT_SHADER_DERIVATIVE_HINT,e.NICEST),e.enable(e.SCISSOR_TEST),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE),this.unpackFlipY=false,e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,false),this.unpackPremultiplyAlpha=false,e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false),this.unpackAlignment=1,e.pixelStorei(e.UNPACK_ALIGNMENT,1);}initTextureUnits(e=16){this.textureUnits=[];for(let t=0;t<e;t++)this.textureUnits.push([null,null,null]);}initializeContextCaches(){super.initializeContextCaches(),this._vaoMap=new Map,this.boundVao=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.initTextureUnits(this.maxCombinedTextures);}loseContext(){for(let e of(super.loseContext(),this.shaders))e.loseContext();}restoreContext(){for(let e of(this.initializeExtensions(),this.initializeCapabilities(),super.restoreContext(),this.shaders))e.restoreContext();}setViewport(e,t,i,s){(this.vx!==e||this.vy!==t||this.vw!==i||this.vh!==s)&&(this.gl.viewport(e,t,i,s),this.vx=e,this.vy=t,this.vw=i,this.vh=s);}setScissor(e,t,i,s){(this.sx!==e||this.sy!==t||this.sw!==i||this.sh!==s)&&(this.gl.scissor(e,t,i,s),this.sx=e,this.sy=t,this.sw=i,this.sh=s);}setFramebuffer(e){if(this.activeFramebuffer!==e){let t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e),this.activeFramebuffer=e;}}copyRenderTarget(e,t,i,s){let r=this.gl;if(e===this.backBuffer&&(e=null),i){if(t){if(e&&(!e._colorBuffer||!t._colorBuffer||e._colorBuffer._format!==t._colorBuffer._format))return  false}else if(!e._colorBuffer)return  false}if(s&&e&&!e._depth&&(!e._depthBuffer||!t._depthBuffer||e._depthBuffer._format!==t._depthBuffer._format))return  false;let a=this.renderTarget;this.renderTarget=t,this.updateBegin();let n=e?e.impl._glFrameBuffer:this.backBuffer?.impl._glFrameBuffer,o=t?t.impl._glFrameBuffer:this.backBuffer?.impl._glFrameBuffer;r.bindFramebuffer(r.READ_FRAMEBUFFER,n),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,o);let l=e?e.width:t?t.width:this.width,h=e?e.height:t?t.height:this.height;return r.blitFramebuffer(0,0,l,h,0,0,l,h,(i?r.COLOR_BUFFER_BIT:0)|(s?r.DEPTH_BUFFER_BIT:0),r.NEAREST),this.renderTarget=a,r.bindFramebuffer(r.FRAMEBUFFER,a?a.impl._glFrameBuffer:null),true}frameStart(){super.frameStart(),this.updateBackbuffer(),this.gpuProfiler.frameStart();}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.gpuProfiler.request();}startRenderPass(e){let t=e.renderTarget??this.backBuffer;this.renderTarget=t,this.updateBegin();let{width:i,height:s}=t;this.setViewport(0,0,i,s),this.setScissor(0,0,i,s);let r=e.colorOps,a=e.depthStencilOps;if(r?.clear||a.clearDepth||a.clearStencil){let e=0,t={};r?.clear&&(e|=1,t.color=[r.clearValue.r,r.clearValue.g,r.clearValue.b,r.clearValue.a]),a.clearDepth&&(e|=2,t.depth=a.clearDepthValue),a.clearStencil&&(e|=4,t.stencil=a.clearStencilValue),t.flags=e,this.clear(t);}this.insideRenderPass=true;}endRenderPass(e){this.unbindVertexArray();let t=this.renderTarget,i=e.colorArrayOps.length;if(t){rZ.length=0;let s=this.gl;for(let t=0;t<i;t++){let i=e.colorArrayOps[t];i.store||i.resolve||rZ.push(s.COLOR_ATTACHMENT0+t);}t!==this.backBuffer&&(e.depthStencilOps.storeDepth||rZ.push(s.DEPTH_ATTACHMENT),e.depthStencilOps.storeStencil||rZ.push(s.STENCIL_ATTACHMENT)),rZ.length>0&&e.fullSizeClearRect&&s.invalidateFramebuffer(s.DRAW_FRAMEBUFFER,rZ),i&&e.colorOps?.resolve&&e.samples>1&&t.autoResolve&&t.resolve(true,false),t.depthBuffer&&e.depthStencilOps.resolveDepth&&e.samples>1&&t.autoResolve&&t.resolve(false,true);for(let s=0;s<i;s++)if(e.colorArrayOps[s].genMipmaps){let e=t._colorBuffers[s];e&&e.impl._glTexture&&e.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(e),this.gl.generateMipmap(e.impl._glTarget));}}this.insideRenderPass=false;}set defaultFramebuffer(e){this._defaultFramebuffer!==e&&(this._defaultFramebuffer=e,this._defaultFramebufferChanged=true);}get defaultFramebuffer(){return this._defaultFramebuffer}updateBegin(){if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(let e=0;e<this.textureUnits.length;++e)for(let t=0;t<3;++t)this.textureUnits[e][t]=null;let e=this.renderTarget??this.backBuffer,t=e.impl;t.initialized||this.initRenderTarget(e),this.setFramebuffer(t._glFrameBuffer);}updateEnd(){this.unbindVertexArray();let e=this.renderTarget;if(e&&e!==this.backBuffer){e._samples>1&&e.autoResolve&&e.resolve();let t=e._colorBuffer;t&&t.impl._glTexture&&t.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(t),this.gl.generateMipmap(t.impl._glTarget));}}setUnpackFlipY(e){if(this.unpackFlipY!==e){this.unpackFlipY=e;let t=this.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e);}}setUnpackPremultiplyAlpha(e){if(this.unpackPremultiplyAlpha!==e){this.unpackPremultiplyAlpha=e;let t=this.gl;t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e);}}setUnpackAlignment(e){this.unpackAlignment!==e&&(this.unpackAlignment=e,this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,e));}activeTexture(e){this.textureUnit!==e&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.textureUnit=e);}bindTexture(e){let t=e.impl,i=t._glTarget,s=t._glTexture,r=this.textureUnit,a=this.targetToSlot[i];this.textureUnits[r][a]!==s&&(this.gl.bindTexture(i,s),this.textureUnits[r][a]=s);}bindTextureOnUnit(e,t){let i=e.impl,s=i._glTarget,r=i._glTexture,a=this.targetToSlot[s];this.textureUnits[t][a]!==r&&(this.activeTexture(t),this.gl.bindTexture(s,r),this.textureUnits[t][a]=r);}setTextureParameters(e){let t=this.gl,i=e.impl.dirtyParameterFlags,s=e.impl._glTarget;if(1&i){let i=e._minFilter;(!e._mipmaps||e._compressed&&1===e._levels.length)&&(2===i||3===i?i=0:(4===i||5===i)&&(i=1)),t.texParameteri(s,t.TEXTURE_MIN_FILTER,this.glFilter[i]);}if(2&i&&t.texParameteri(s,t.TEXTURE_MAG_FILTER,this.glFilter[e._magFilter]),4&i&&t.texParameteri(s,t.TEXTURE_WRAP_S,this.glAddress[e._addressU]),8&i&&t.texParameteri(s,t.TEXTURE_WRAP_T,this.glAddress[e._addressV]),16&i&&t.texParameteri(s,t.TEXTURE_WRAP_R,this.glAddress[e._addressW]),32&i&&t.texParameteri(s,t.TEXTURE_COMPARE_MODE,e._compareOnRead?t.COMPARE_REF_TO_TEXTURE:t.NONE),64&i&&t.texParameteri(s,t.TEXTURE_COMPARE_FUNC,this.glComparison[e._compareFunc]),128&i){let i=this.extTextureFilterAnisotropic;i&&t.texParameterf(s,i.TEXTURE_MAX_ANISOTROPY_EXT,ei.clamp(Math.round(e._anisotropy),1,this.maxAnisotropy));}}setTexture(e,t){let i=e.impl;i._glTexture||i.initialize(this,e),i.dirtyParameterFlags>0||e._needsUpload||e._needsMipmapsUpload?(this.activeTexture(t),this.bindTexture(e),i.dirtyParameterFlags&&(this.setTextureParameters(e),i.dirtyParameterFlags=0),(e._needsUpload||e._needsMipmapsUpload)&&(i.upload(this,e),e._needsUpload=false,e._needsMipmapsUpload=false)):this.bindTextureOnUnit(e,t);}createVertexArray(e){let t,i,s=e.length>1;if(s){t="";for(let i=0;i<e.length;i++){let s=e[i];t+=s.id+s.format.renderingHash;}i=this._vaoMap.get(t);}if(!i){let r=this.gl;i=r.createVertexArray(),r.bindVertexArray(i),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null);for(let t=0;t<e.length;t++){let i=e[t];r.bindBuffer(r.ARRAY_BUFFER,i.impl.bufferId);let s=i.format.elements;for(let e=0;e<s.length;e++){let t=s[e],a=t4[t.name];t.asInt?r.vertexAttribIPointer(a,t.numComponents,this.glType[t.dataType],t.stride,t.offset):r.vertexAttribPointer(a,t.numComponents,this.glType[t.dataType],t.normalize,t.stride,t.offset),r.enableVertexAttribArray(a),i.format.instancing&&r.vertexAttribDivisor(a,1);}}r.bindVertexArray(null),r.bindBuffer(r.ARRAY_BUFFER,null),s&&this._vaoMap.set(t,i);}return i}unbindVertexArray(){this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null));}setBuffers(e){let t,i=this.gl;if(1===this.vertexBuffers.length){let e=this.vertexBuffers[0];e.impl.vao||(e.impl.vao=this.createVertexArray(this.vertexBuffers)),t=e.impl.vao;}else t=this.createVertexArray(this.vertexBuffers);this.boundVao!==t&&(this.boundVao=t,i.bindVertexArray(t));let s=e?e.impl.bufferId:null;i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,s);}_multiDrawLoopFallback(e,t,i,s,r){let a=this.gl;if(t.indexed){let t=i.impl.glFormat,{glCounts:n,glOffsetsBytes:o,glInstanceCounts:l,count:h}=r.impl;if(s>0)for(let i=0;i<h;i++)a.drawElementsInstanced(e,n[i],t,o[i],l[i]);else for(let i=0;i<h;i++)a.drawElements(e,n[i],t,o[i]);}else {let{glCounts:t,glOffsetsBytes:i,glInstanceCounts:n,count:o}=r.impl;if(s>0)for(let s=0;s<o;s++)a.drawArraysInstanced(e,i[s],t[s],n[s]);else for(let s=0;s<o;s++)a.drawArrays(e,i[s],t[s]);}}draw(e,t,i,s,r=true,a=true){let n=this.shader;if(n&&(this.activateShader(),this.shaderValid)){let a=this.gl;r&&this.setBuffers(t);let o=0,l=n.impl.samplers;for(let e=0,t=l.length;e<t;e++){let t=l[e],i=t.scopeId.value;if(!i){let e=t.scopeId.name;"uSceneDepthMap"===e&&(i=ip(this,"white")),"uSceneColorMap"===e&&(i=ip(this,"pink")),i||(i=ip(this,"pink"));}if(i instanceof ih){let e=i;this.setTexture(e,o),t.slot!==o&&(a.uniform1i(t.locationId,o),t.slot=o),o++;}else {t.array.length=0;let e=i.length;for(let s=0;s<e;s++){let e=i[s];this.setTexture(e,o),t.array[s]=o,o++;}a.uniform1iv(t.locationId,t.array);}}let h=n.impl.uniforms;for(let e=0,t=h.length;e<t;e++){let t=h[e],i=t.scopeId,s=t.version,r=i.versionObject.version;if(s.globalId!==r.globalId||s.revision!==r.revision){s.globalId=r.globalId,s.revision=r.revision;let e=i.value;null!=e&&this.commitFunction[t.dataType](t,e);}}this.transformFeedbackBuffer&&(a.bindBufferBase(a.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.impl.bufferId),a.beginTransformFeedback(a.POINTS));let c=this.glPrimitive[e.type],d=e.count;if(s)if(this.extMultiDraw){let r=s.impl;if(e.indexed){let e=t.impl.glFormat;i>0?this.extMultiDraw.multiDrawElementsInstancedWEBGL(c,r.glCounts,0,e,r.glOffsetsBytes,0,r.glInstanceCounts,0,s.count):this.extMultiDraw.multiDrawElementsWEBGL(c,r.glCounts,0,e,r.glOffsetsBytes,0,s.count);}else i>0?this.extMultiDraw.multiDrawArraysInstancedWEBGL(c,r.glOffsetsBytes,0,r.glCounts,0,r.glInstanceCounts,0,s.count):this.extMultiDraw.multiDrawArraysWEBGL(c,r.glOffsetsBytes,0,r.glCounts,0,s.count);}else this._multiDrawLoopFallback(c,e,t,i,s);else if(e.indexed){let s=t.impl.glFormat,r=e.base*t.bytesPerIndex;i>0?a.drawElementsInstanced(c,d,s,r,i):a.drawElements(c,d,s,r);}else {let t=e.base;i>0?a.drawArraysInstanced(c,t,d,i):a.drawArrays(c,t,d);}this.transformFeedbackBuffer&&(a.endTransformFeedback(),a.bindBufferBase(a.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++;}a&&this.clearVertexBuffer();}clear(e){let t=this.defaultClearOptions,i=(e=e||t).flags??t.flags;if(0!==i){let s=this.gl;if(1&i){let i=e.color??t.color,s=i[0],r=i[1],a=i[2],n=i[3],o=this.clearColor;(s!==o.r||r!==o.g||a!==o.b||n!==o.a)&&(this.gl.clearColor(s,r,a,n),this.clearColor.set(s,r,a,n)),this.setBlendState(iS.NOBLEND);}if(2&i){let i=e.depth??t.depth;i!==this.clearDepth&&(this.gl.clearDepth(i),this.clearDepth=i),this.setDepthState(ix.WRITEDEPTH);}if(4&i){let i=e.stencil??t.stencil;i!==this.clearStencil&&(this.gl.clearStencil(i),this.clearStencil=i),s.stencilMask(255),this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255;}s.clear(this.glClearFlag[i]);}}submit(){this.gl.flush();}readPixels(e,t,i,s,r){let a=this.gl;a.readPixels(e,t,i,s,a.RGBA,a.UNSIGNED_BYTE,r);}clientWaitAsync(e,t){let i=this.gl,s=i.fenceSync(i.SYNC_GPU_COMMANDS_COMPLETE,0);return this.submit(),new Promise((r,a)=>{!function n(){let o=i.clientWaitSync(s,e,0);o===i.TIMEOUT_EXPIRED?setTimeout(n,t):(i.deleteSync(s),o===i.WAIT_FAILED?a(Error("webgl clientWaitSync sync failed")):r());}();})}async readPixelsAsync(e,t,i,s,r,a=false){let n,o,l=this.gl;if(a)n=l.RGBA,o=l.UNSIGNED_BYTE;else {let e=this.renderTarget.colorBuffer?.impl;n=e?._glFormat??l.RGBA,o=e?._glPixelType??l.UNSIGNED_BYTE;}let h=l.createBuffer();return l.bindBuffer(l.PIXEL_PACK_BUFFER,h),l.bufferData(l.PIXEL_PACK_BUFFER,r.byteLength,l.STREAM_READ),l.readPixels(e,t,i,s,n,o,0),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),await this.clientWaitAsync(0,16),l.bindBuffer(l.PIXEL_PACK_BUFFER,h),l.getBufferSubData(l.PIXEL_PACK_BUFFER,0,r),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),l.deleteBuffer(h),r}readTextureAsync(e,t,i,s,r,a){let n=a.face??0,o=a.mipLevel??0,l=a.renderTarget??new iU({colorBuffer:e,depth:false,face:n,mipLevel:o}),h=(e=>{switch(e){case 52:return 1;case 53:return 2;default:return 0}})(e._format),c=h>0,d=a.data??new(e8(e._format))(is.calcLevelGpuSize(s,r,1,e._format)),u=c?new Uint8Array(s*r*4):d;return this.setRenderTarget(l),this.initRenderTarget(l),this.setFramebuffer(l.impl._glFrameBuffer),a.immediate&&this.gl.flush(),new Promise((e,n)=>{this.readPixelsAsync(t,i,s,r,u,c).then(t=>{if(!this._destroyed)if(a.renderTarget||l.destroy(),c){let i=s*r;for(let e=0;e<i;e++)for(let i=0;i<h;i++)d[e*h+i]=t[4*e+i];e(d);}else e(t);}).catch(n);})}async writeTextureAsync(e,t,i,s,r,a){let n=this.gl,o=e.impl,l=o?._glFormat??n.RGBA,h=o?._glPixelType??n.UNSIGNED_BYTE,c=n.createBuffer();n.bindBuffer(n.PIXEL_UNPACK_BUFFER,c),n.bufferData(n.PIXEL_UNPACK_BUFFER,a,n.STREAM_DRAW),n.bindTexture(n.TEXTURE_2D,o._glTexture),n.texSubImage2D(n.TEXTURE_2D,0,t,i,s,r,l,h,0),n.bindBuffer(n.PIXEL_UNPACK_BUFFER,null),e._needsUpload=false,e._mipmapsUploaded=false,await this.clientWaitAsync(0,16);}setAlphaToCoverage(e){this.alphaToCoverage!==e&&(this.alphaToCoverage=e,e?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE));}setTransformFeedbackBuffer(e){if(this.transformFeedbackBuffer!==e){this.transformFeedbackBuffer=e;let t=this.gl;e?(this.feedback||(this.feedback=t.createTransformFeedback()),t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,this.feedback)):t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,null);}}setRaster(e){this.raster!==e&&(this.raster=e,e?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD));}setStencilTest(e){if(this.stencil!==e){let t=this.gl;e?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this.stencil=e;}}setStencilFunc(e,t,i){(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==i||this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==i)&&(this.gl.stencilFunc(this.glComparison[e],t,i),this.stencilFuncFront=this.stencilFuncBack=e,this.stencilRefFront=this.stencilRefBack=t,this.stencilMaskFront=this.stencilMaskBack=i);}setStencilFuncFront(e,t,i){if(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==i){let s=this.gl;s.stencilFuncSeparate(s.FRONT,this.glComparison[e],t,i),this.stencilFuncFront=e,this.stencilRefFront=t,this.stencilMaskFront=i;}}setStencilFuncBack(e,t,i){if(this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==i){let s=this.gl;s.stencilFuncSeparate(s.BACK,this.glComparison[e],t,i),this.stencilFuncBack=e,this.stencilRefBack=t,this.stencilMaskBack=i;}}setStencilOperation(e,t,i,s){(this.stencilFailFront!==e||this.stencilZfailFront!==t||this.stencilZpassFront!==i||this.stencilFailBack!==e||this.stencilZfailBack!==t||this.stencilZpassBack!==i)&&(this.gl.stencilOp(this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[i]),this.stencilFailFront=this.stencilFailBack=e,this.stencilZfailFront=this.stencilZfailBack=t,this.stencilZpassFront=this.stencilZpassBack=i),(this.stencilWriteMaskFront!==s||this.stencilWriteMaskBack!==s)&&(this.gl.stencilMask(s),this.stencilWriteMaskFront=s,this.stencilWriteMaskBack=s);}setStencilOperationFront(e,t,i,s){(this.stencilFailFront!==e||this.stencilZfailFront!==t||this.stencilZpassFront!==i)&&(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[i]),this.stencilFailFront=e,this.stencilZfailFront=t,this.stencilZpassFront=i),this.stencilWriteMaskFront!==s&&(this.gl.stencilMaskSeparate(this.gl.FRONT,s),this.stencilWriteMaskFront=s);}setStencilOperationBack(e,t,i,s){(this.stencilFailBack!==e||this.stencilZfailBack!==t||this.stencilZpassBack!==i)&&(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[i]),this.stencilFailBack=e,this.stencilZfailBack=t,this.stencilZpassBack=i),this.stencilWriteMaskBack!==s&&(this.gl.stencilMaskSeparate(this.gl.BACK,s),this.stencilWriteMaskBack=s);}setBlendState(e){let t=this.blendState;if(!t.equals(e)){let i=this.gl,{blend:s,colorOp:r,alphaOp:a,colorSrcFactor:n,colorDstFactor:o,alphaSrcFactor:l,alphaDstFactor:h}=e;if(t.blend!==s&&(s?i.enable(i.BLEND):i.disable(i.BLEND)),t.colorOp!==r||t.alphaOp!==a){let e=this.glBlendEquation;i.blendEquationSeparate(e[r],e[a]);}(t.colorSrcFactor!==n||t.colorDstFactor!==o||t.alphaSrcFactor!==l||t.alphaDstFactor!==h)&&i.blendFuncSeparate(this.glBlendFunctionColor[n],this.glBlendFunctionColor[o],this.glBlendFunctionAlpha[l],this.glBlendFunctionAlpha[h]),t.allWrite!==e.allWrite&&this.gl.colorMask(e.redWrite,e.greenWrite,e.blueWrite,e.alphaWrite),t.copy(e);}}setBlendColor(e,t,i,s){let r=this.blendColor;(e!==r.r||t!==r.g||i!==r.b||s!==r.a)&&(this.gl.blendColor(e,t,i,s),r.set(e,t,i,s));}setStencilState(e,t){e||t?(this.setStencilTest(true),e===t?(this.setStencilFunc(e.func,e.ref,e.readMask),this.setStencilOperation(e.fail,e.zfail,e.zpass,e.writeMask)):(e??(e=iN.DEFAULT),this.setStencilFuncFront(e.func,e.ref,e.readMask),this.setStencilOperationFront(e.fail,e.zfail,e.zpass,e.writeMask),t??(t=iN.DEFAULT),this.setStencilFuncBack(t.func,t.ref,t.readMask),this.setStencilOperationBack(t.fail,t.zfail,t.zpass,t.writeMask))):this.setStencilTest(false);}setDepthState(e){let t=this.depthState;if(!t.equals(e)){let i=this.gl,s=e.write;t.write!==s&&i.depthMask(s);let{func:r,test:a}=e;!a&&s&&(a=true,r=7),t.func!==r&&i.depthFunc(this.glComparison[r]),t.test!==a&&(a?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST));let{depthBias:n,depthBiasSlope:o}=e;n||o?(this.depthBiasEnabled||(this.depthBiasEnabled=true,this.gl.enable(this.gl.POLYGON_OFFSET_FILL)),i.polygonOffset(o,n)):this.depthBiasEnabled&&(this.depthBiasEnabled=false,this.gl.disable(this.gl.POLYGON_OFFSET_FILL)),t.copy(e);}}setCullMode(e){if(this.cullMode!==e){if(0===e)this.gl.disable(this.gl.CULL_FACE);else {0===this.cullMode&&this.gl.enable(this.gl.CULL_FACE);let t=this.glCull[e];this.cullFace!==t&&(this.gl.cullFace(t),this.cullFace=t);}this.cullMode=e;}}setShader(e,t=false){e!==this.shader&&(this.shader=e,this.shaderAsyncCompile=t,this.shaderValid=void 0);}activateShader(){let{shader:e}=this,{impl:t}=e;void 0===this.shaderValid&&(e.failed?this.shaderValid=false:!e.ready&&(this.shaderAsyncCompile?t.isLinked(this)?t.finalize(this,e)||(e.failed=true,this.shaderValid=false):this.shaderValid=false:t.finalize(this,e)||(e.failed=true,this.shaderValid=false))),void 0===this.shaderValid&&(this.gl.useProgram(t.glProgram),this.shaderValid=true);}clearVertexArrayObjectCache(){let e=this.gl;this._vaoMap.forEach((t,i,s)=>{e.deleteVertexArray(t);}),this._vaoMap.clear();}set fullscreen(e){e?this.gl.canvas.requestFullscreen():document.exitFullscreen();}get fullscreen(){return !!document.fullscreenElement}constructor(e,t={}){let i,s,r,a,n;super(e,t),this._defaultFramebuffer=null,this._defaultFramebufferChanged=false,t=this.initOptions,this.updateClientRect(),this.initTextureUnits(),this.contextLost=false,this._contextLostHandler=e=>{e.preventDefault(),this.loseContext(),this.fire("devicelost");},this._contextRestoredHandler=()=>{this.restoreContext(),this.fire("devicerestored");};let o="undefined"!=typeof navigator&&navigator.userAgent;if(this.forceDisableMultisampling=o&&o.includes("AppleWebKit")&&(o.includes("15.4")||o.includes("15_4")),this.forceDisableMultisampling&&(t.antialias=false),"firefox"===k.browserName){let e=("undefined"!=typeof navigator?navigator.userAgent:"").match(/Firefox\/(\d+(\.\d+)*)/),i=e?e[1]:null;if(i){let e=parseFloat(i);("windows"===k.name&&(e>=120||115===e)||"android"===k.name&&e>=132)&&(t.antialias=false);}}this.backBufferAntialias=t.antialias??false,t.antialias=false;let l=t.gl??e.getContext("webgl2",t);if(!l)throw Error("WebGL not supported");this.gl=l,this.isWebGL2=true,this._deviceType=tY,this.updateBackbufferFormat(null);let h="chrome"===k.browserName,c="safari"===k.browserName,d=k.browser&&-1!==navigator.appVersion.indexOf("Mac");this._tempEnableSafariTextureUnitWorkaround=c,this._tempMacChromeBlitFramebufferWorkaround=d&&h&&!t.alpha,e.addEventListener("webglcontextlost",this._contextLostHandler,false),e.addEventListener("webglcontextrestored",this._contextRestoredHandler,false),this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches(),this.createBackbuffer(null),this.supportsImageBitmap=!c&&"undefined"!=typeof ImageBitmap,this._samplerTypes=new Set([l.SAMPLER_2D,l.SAMPLER_CUBE,l.UNSIGNED_INT_SAMPLER_2D,l.INT_SAMPLER_2D,l.SAMPLER_2D_SHADOW,l.SAMPLER_CUBE_SHADOW,l.SAMPLER_3D,l.INT_SAMPLER_3D,l.UNSIGNED_INT_SAMPLER_3D,l.SAMPLER_2D_ARRAY,l.INT_SAMPLER_2D_ARRAY,l.UNSIGNED_INT_SAMPLER_2D_ARRAY]),this.glAddress=[l.REPEAT,l.CLAMP_TO_EDGE,l.MIRRORED_REPEAT],this.glBlendEquation=[l.FUNC_ADD,l.FUNC_SUBTRACT,l.FUNC_REVERSE_SUBTRACT,l.MIN,l.MAX],this.glBlendFunctionColor=[l.ZERO,l.ONE,l.SRC_COLOR,l.ONE_MINUS_SRC_COLOR,l.DST_COLOR,l.ONE_MINUS_DST_COLOR,l.SRC_ALPHA,l.SRC_ALPHA_SATURATE,l.ONE_MINUS_SRC_ALPHA,l.DST_ALPHA,l.ONE_MINUS_DST_ALPHA,l.CONSTANT_COLOR,l.ONE_MINUS_CONSTANT_COLOR],this.glBlendFunctionAlpha=[l.ZERO,l.ONE,l.SRC_COLOR,l.ONE_MINUS_SRC_COLOR,l.DST_COLOR,l.ONE_MINUS_DST_COLOR,l.SRC_ALPHA,l.SRC_ALPHA_SATURATE,l.ONE_MINUS_SRC_ALPHA,l.DST_ALPHA,l.ONE_MINUS_DST_ALPHA,l.CONSTANT_ALPHA,l.ONE_MINUS_CONSTANT_ALPHA],this.glComparison=[l.NEVER,l.LESS,l.EQUAL,l.LEQUAL,l.GREATER,l.NOTEQUAL,l.GEQUAL,l.ALWAYS],this.glStencilOp=[l.KEEP,l.ZERO,l.REPLACE,l.INCR,l.INCR_WRAP,l.DECR,l.DECR_WRAP,l.INVERT],this.glClearFlag=[0,l.COLOR_BUFFER_BIT,l.DEPTH_BUFFER_BIT,l.COLOR_BUFFER_BIT|l.DEPTH_BUFFER_BIT,l.STENCIL_BUFFER_BIT,l.STENCIL_BUFFER_BIT|l.COLOR_BUFFER_BIT,l.STENCIL_BUFFER_BIT|l.DEPTH_BUFFER_BIT,l.STENCIL_BUFFER_BIT|l.COLOR_BUFFER_BIT|l.DEPTH_BUFFER_BIT],this.glCull=[0,l.BACK,l.FRONT,l.FRONT_AND_BACK],this.glFilter=[l.NEAREST,l.LINEAR,l.NEAREST_MIPMAP_NEAREST,l.NEAREST_MIPMAP_LINEAR,l.LINEAR_MIPMAP_NEAREST,l.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[l.POINTS,l.LINES,l.LINE_LOOP,l.LINE_STRIP,l.TRIANGLES,l.TRIANGLE_STRIP,l.TRIANGLE_FAN],this.glType=[l.BYTE,l.UNSIGNED_BYTE,l.SHORT,l.UNSIGNED_SHORT,l.INT,l.UNSIGNED_INT,l.FLOAT,l.HALF_FLOAT],this.pcUniformType={},this.pcUniformType[l.BOOL]=0,this.pcUniformType[l.INT]=1,this.pcUniformType[l.FLOAT]=2,this.pcUniformType[l.FLOAT_VEC2]=3,this.pcUniformType[l.FLOAT_VEC3]=4,this.pcUniformType[l.FLOAT_VEC4]=5,this.pcUniformType[l.INT_VEC2]=6,this.pcUniformType[l.INT_VEC3]=7,this.pcUniformType[l.INT_VEC4]=8,this.pcUniformType[l.BOOL_VEC2]=9,this.pcUniformType[l.BOOL_VEC3]=10,this.pcUniformType[l.BOOL_VEC4]=11,this.pcUniformType[l.FLOAT_MAT2]=12,this.pcUniformType[l.FLOAT_MAT3]=13,this.pcUniformType[l.FLOAT_MAT4]=14,this.pcUniformType[l.SAMPLER_2D]=15,this.pcUniformType[l.SAMPLER_CUBE]=16,this.pcUniformType[l.UNSIGNED_INT]=26,this.pcUniformType[l.UNSIGNED_INT_VEC2]=27,this.pcUniformType[l.UNSIGNED_INT_VEC3]=28,this.pcUniformType[l.UNSIGNED_INT_VEC4]=29,this.pcUniformType[l.SAMPLER_2D_SHADOW]=18,this.pcUniformType[l.SAMPLER_CUBE_SHADOW]=19,this.pcUniformType[l.SAMPLER_2D_ARRAY]=25,this.pcUniformType[l.SAMPLER_3D]=20,this.pcUniformType[l.INT_SAMPLER_2D]=42,this.pcUniformType[l.UNSIGNED_INT_SAMPLER_2D]=43,this.pcUniformType[l.INT_SAMPLER_CUBE]=44,this.pcUniformType[l.UNSIGNED_INT_SAMPLER_2D]=45,this.pcUniformType[l.INT_SAMPLER_3D]=46,this.pcUniformType[l.UNSIGNED_INT_SAMPLER_3D]=47,this.pcUniformType[l.INT_SAMPLER_2D_ARRAY]=48,this.pcUniformType[l.UNSIGNED_INT_SAMPLER_2D_ARRAY]=49,this.targetToSlot={},this.targetToSlot[l.TEXTURE_2D]=0,this.targetToSlot[l.TEXTURE_CUBE_MAP]=1,this.targetToSlot[l.TEXTURE_3D]=2,this.commitFunction=[],this.commitFunction[0]=function(e,t){e.value!==t&&(l.uniform1i(e.locationId,t),e.value=t);},this.commitFunction[1]=this.commitFunction[0],this.commitFunction[2]=function(e,t){e.value!==t&&(l.uniform1f(e.locationId,t),e.value=t);},this.commitFunction[3]=function(e,t){n=e.value,i=t[0],s=t[1],(n[0]!==i||n[1]!==s)&&(l.uniform2fv(e.locationId,t),n[0]=i,n[1]=s);},this.commitFunction[4]=function(e,t){n=e.value,i=t[0],s=t[1],r=t[2],(n[0]!==i||n[1]!==s||n[2]!==r)&&(l.uniform3fv(e.locationId,t),n[0]=i,n[1]=s,n[2]=r);},this.commitFunction[5]=function(e,t){n=e.value,i=t[0],s=t[1],r=t[2],a=t[3],(n[0]!==i||n[1]!==s||n[2]!==r||n[3]!==a)&&(l.uniform4fv(e.locationId,t),n[0]=i,n[1]=s,n[2]=r,n[3]=a);},this.commitFunction[6]=function(e,t){n=e.value,i=t[0],s=t[1],(n[0]!==i||n[1]!==s)&&(l.uniform2iv(e.locationId,t),n[0]=i,n[1]=s);},this.commitFunction[9]=this.commitFunction[6],this.commitFunction[7]=function(e,t){n=e.value,i=t[0],s=t[1],r=t[2],(n[0]!==i||n[1]!==s||n[2]!==r)&&(l.uniform3iv(e.locationId,t),n[0]=i,n[1]=s,n[2]=r);},this.commitFunction[10]=this.commitFunction[7],this.commitFunction[8]=function(e,t){n=e.value,i=t[0],s=t[1],r=t[2],a=t[3],(n[0]!==i||n[1]!==s||n[2]!==r||n[3]!==a)&&(l.uniform4iv(e.locationId,t),n[0]=i,n[1]=s,n[2]=r,n[3]=a);},this.commitFunction[11]=this.commitFunction[8],this.commitFunction[12]=function(e,t){l.uniformMatrix2fv(e.locationId,false,t);},this.commitFunction[13]=function(e,t){l.uniformMatrix3fv(e.locationId,false,t);},this.commitFunction[14]=function(e,t){l.uniformMatrix4fv(e.locationId,false,t);},this.commitFunction[17]=function(e,t){l.uniform1fv(e.locationId,t);},this.commitFunction[21]=function(e,t){l.uniform2fv(e.locationId,t);},this.commitFunction[22]=function(e,t){l.uniform3fv(e.locationId,t);},this.commitFunction[23]=function(e,t){l.uniform4fv(e.locationId,t);},this.commitFunction[26]=function(e,t){e.value!==t&&(l.uniform1ui(e.locationId,t),e.value=t);},this.commitFunction[27]=function(e,t){n=e.value,i=t[0],s=t[1],(n[0]!==i||n[1]!==s)&&(l.uniform2uiv(e.locationId,t),n[0]=i,n[1]=s);},this.commitFunction[28]=function(e,t){n=e.value,i=t[0],s=t[1],r=t[2],(n[0]!==i||n[1]!==s||n[2]!==r)&&(l.uniform3uiv(e.locationId,t),n[0]=i,n[1]=s,n[2]=r);},this.commitFunction[29]=function(e,t){n=e.value,i=t[0],s=t[1],r=t[2],a=t[3],(n[0]!==i||n[1]!==s||n[2]!==r||n[3]!==a)&&(l.uniform4uiv(e.locationId,t),n[0]=i,n[1]=s,n[2]=r,n[3]=a);},this.commitFunction[30]=function(e,t){l.uniform1iv(e.locationId,t);},this.commitFunction[31]=function(e,t){l.uniform1uiv(e.locationId,t);},this.commitFunction[32]=this.commitFunction[30],this.commitFunction[33]=function(e,t){l.uniform2iv(e.locationId,t);},this.commitFunction[34]=function(e,t){l.uniform2uiv(e.locationId,t);},this.commitFunction[35]=this.commitFunction[33],this.commitFunction[36]=function(e,t){l.uniform3iv(e.locationId,t);},this.commitFunction[37]=function(e,t){l.uniform3uiv(e.locationId,t);},this.commitFunction[38]=this.commitFunction[36],this.commitFunction[39]=function(e,t){l.uniform4iv(e.locationId,t);},this.commitFunction[40]=function(e,t){l.uniform4uiv(e.locationId,t);},this.commitFunction[41]=this.commitFunction[39],this.commitFunction[24]=function(e,t){l.uniformMatrix4fv(e.locationId,false,t);},this.constantTexSource=this.scope.resolve("source"),this.postInit();}}class rJ{unlock(e){}}class r0{destroy(e){}init(e,t){}loseContext(){}resolve(e,t,i,s){}}class r1{destroy(e){}loseContext(){}restoreContext(e,t){}}class r2{destroy(e){}propertyChanged(e){}loseContext(){}}class r3{destroy(e){}unlock(e){}}class r4{add(e,t,i,s){}}class r5 extends iB{destroy(){super.destroy();}initDeviceCaps(){this.disableParticleSystem=true,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=4096,this.maxCubeMapSize=4096,this.maxVolumeSize=4096,this.maxColorAttachments=8,this.maxPixelRatio=1,this.maxAnisotropy=16,this.supportsUniformBuffers=false,this.supportsAreaLights=true,this.supportsGpuParticles=false,this.textureFloatRenderable=true,this.textureHalfFloatRenderable=true,this.supportsImageBitmap=false;}postInit(){super.postInit();}frameStart(){super.frameStart();}frameEnd(){super.frameEnd();}updateBegin(){}updateEnd(){}readPixels(e,t,i,s,r){}createVertexBufferImpl(e,t){return new r3(e,t)}createIndexBufferImpl(e){return new rJ(e)}createShaderImpl(e){return new r1(e)}createTextureImpl(e){return new r2(e)}createRenderTargetImpl(e){return new r0(e)}createDrawCommandImpl(e){return new r4}createUploadStreamImpl(e){return null}draw(e,t,i,s,r=true,a=true){}setShader(e,t=false){}setBlendState(e){}setDepthState(e){}setStencilState(e,t){}setBlendColor(e,t,i,s){}setCullMode(e){}setAlphaToCoverage(e){}initializeContextCaches(){super.initializeContextCaches();}clear(e){}setViewport(e,t,i,s){}setScissor(e,t,i,s){}copyRenderTarget(e,t,i,s){return  true}constructor(e,t={}){super(e,t),t=this.initOptions,this.isNull=true,this._deviceType=t$,this.samples=1,this.backBuffer=new iU({name:"Framebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.initDeviceCaps();}}class r8{constructor(){this.scopeId=null;}}class r6{setParameter(e,t){let i=this.parameters.get(e);i||((i=new r8).scopeId=this.device.scope.resolve(e),this.parameters.set(e,i)),i.value=t;}getParameter(e){return this.parameters.get(e)?.value}deleteParameter(e){this.parameters.delete(e);}applyParameters(){for(let[,e]of this.parameters)e.scopeId.setValue(e.value);}setupDispatch(e,t,i){this.countX=e,this.countY=t,this.countZ=i,this.indirectSlotIndex=-1,this.indirectBuffer=null;}setupIndirectDispatch(e,t=null){this.indirectSlotIndex=e,this.indirectBuffer=t,this.indirectFrameStamp=this.device.renderVersion;}constructor(e,t,i="Unnamed"){this.shader=null,this.parameters=new Map,this.countX=1,this.indirectSlotIndex=-1,this.indirectBuffer=null,this.indirectFrameStamp=0,this.device=e,this.shader=t,this.name=i,e.supportsCompute&&(this.impl=e.createComputeImpl(this));}}class r9{get maxCount(){return this._maxCount}get count(){return this._count}destroy(){this.impl?.destroy?.(),this.impl=null;}allocate(e){this._maxCount=e,this.impl.allocate?.(e);}add(e,t,i,s,r=0,a=0){this.impl.add(e,t,i,s,r,a);}update(e){this._count=e,this.primitiveCount=this.impl.update?.(e)??0;}constructor(e,t=0){this._maxCount=0,this.impl=null,this._count=1,this.slotIndex=0,this.primitiveCount=0,this.device=e,this.indexSizeBytes=t,this.impl=e.createDrawCommandImpl(this);}}let r7=0;class ae{destroy(){let e=this.device;e.buffers.delete(this),this.device.indexBuffer===this&&(this.device.indexBuffer=null),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength));}adjustVramSizeTracking(e,t){e.ib+=t;}loseContext(){this.impl.loseContext();}getFormat(){return this.format}getNumIndices(){return this.numIndices}lock(){return this.storage}unlock(){this.impl.unlock(this);}setData(e){return e.byteLength===this.numBytes&&(this.storage=e,this.unlock(),true)}_lockTypedArray(){let e=this.lock();return 2===this.format?new Uint32Array(e):1===this.format?new Uint16Array(e):new Uint8Array(e)}writeData(e,t){let i=this._lockTypedArray();if(e.length>t)if(ArrayBuffer.isView(e))e=e.subarray(0,t),i.set(e);else for(let s=0;s<t;s++)i[s]=e[s];else i.set(e);this.unlock();}readData(e){let t=this._lockTypedArray(),i=this.numIndices;if(ArrayBuffer.isView(e))e.set(t);else {e.length=0;for(let s=0;s<i;s++)e[s]=t[s];}return i}constructor(e,t,i,s=0,r,a){this.device=e,this.format=t,this.numIndices=i,this.usage=s,this.id=r7++,this.impl=e.createIndexBufferImpl(this,a);let n=t2[t];this.bytesPerIndex=n,this.numBytes=this.numIndices*n,r?this.setData(r):this.storage=new ArrayBuffer(this.numBytes),this.adjustVramSizeTracking(e._vram,this.numBytes),this.device.buffers.add(this);}}class at{constructor(){this.clearValue=new es(0,0,0,1),this.clearValueLinear=new es(0,0,0,1),this.clear=false,this.store=false,this.resolve=true,this.genMipmaps=false;}}class ai{constructor(){this.clearDepthValue=1,this.clearStencilValue=0,this.clearDepth=false,this.clearStencil=false,this.storeDepth=false,this.resolveDepth=false,this.storeStencil=false;}}class as{get colorOps(){return this.colorArrayOps[0]}set name(e){this._name=e;}get name(){return this._name||(this._name=this.constructor.name),this._name}set scaleX(e){this._options.scaleX=e;}get scaleX(){return this._options.scaleX}set scaleY(e){this._options.scaleY=e;}get scaleY(){return this._options.scaleY}set options(e){this._options=e,e&&(this.scaleX=this.scaleX??1,this.scaleY=this.scaleY??1);}get options(){return this._options}init(e=null,t){this.options=t,this.renderTarget=e,this.samples=Math.max(this.renderTarget?this.renderTarget.samples:this.device.samples,1),this.allocateAttachments(),this.postInit();}allocateAttachments(){let e=this.renderTarget;this.depthStencilOps=new ai,e?.depthBuffer&&(this.depthStencilOps.storeDepth=true);let t=e?e._colorBuffers?.length??0:1;this.colorArrayOps.length=0;for(let e=0;e<t;e++){let t=new at;this.colorArrayOps[e]=t,1===this.samples&&(t.store=true,t.resolve=false);let i=this.renderTarget?._colorBuffers?.[e];this.renderTarget?.mipmaps&&i?.mipmaps&&(t.genMipmaps=!e$(i._format));}}destroy(){}postInit(){}frameUpdate(){if(this._options&&this.renderTarget){let e=this._options.resizeSource??this.device.backBuffer,t=Math.floor(e.width*this.scaleX),i=Math.floor(e.height*this.scaleY);this.renderTarget.resize(t,i);}}before(){}execute(){}after(){}onEnable(){}onDisable(){}set enabled(e){this._enabled!==e&&(this._enabled=e,e?this.onEnable():this.onDisable());}get enabled(){return this._enabled}setClearColor(e){let t=this.colorArrayOps.length;for(let i=0;i<t;i++){let t=this.colorArrayOps[i];e&&(t.clearValue.copy(e),t.clearValueLinear.linear(e)),t.clear=!!e;}}setClearDepth(e){ void 0!==e&&(this.depthStencilOps.clearDepthValue=e),this.depthStencilOps.clearDepth=void 0!==e;}setClearStencil(e){ void 0!==e&&(this.depthStencilOps.clearStencilValue=e),this.depthStencilOps.clearStencil=void 0!==e;}render(){if(this.enabled){let e=this.device,t=void 0!==this.renderTarget;this.before(),this.executeEnabled&&(t&&!this._skipStart&&e.startRenderPass(this),this.execute(),t&&!this._skipEnd&&e.endRenderPass(this)),this.after(),e.renderPassIndex++;}}constructor(e){this._enabled=true,this._skipStart=false,this._skipEnd=false,this.executeEnabled=true,this.samples=0,this.colorArrayOps=[],this.requiresCubemaps=true,this.fullSizeClearRect=true,this.beforePasses=[],this.afterPasses=[],this.device=e;}}function ar(e){this.array[this.index]=e;}function aa(e,t){this.array[this.index]=e,this.array[this.index+1]=t;}function an(e,t,i){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=i;}function ao(e,t,i,s){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=i,this.array[this.index+3]=s;}function al(e,t,i){this.array[e]=t[i];}function ah(e,t,i){this.array[e]=t[i],this.array[e+1]=t[i+1];}function ac(e,t,i){this.array[e]=t[i],this.array[e+1]=t[i+1],this.array[e+2]=t[i+2];}function ad(e,t,i){this.array[e]=t[i],this.array[e+1]=t[i+1],this.array[e+2]=t[i+2],this.array[e+3]=t[i+3];}function au(e,t,i){t[i]=this.array[e];}function af(e,t,i){t[i]=this.array[e],t[i+1]=this.array[e+1];}function ap(e,t,i){t[i]=this.array[e],t[i+1]=this.array[e+1],t[i+2]=this.array[e+2];}function am(e,t,i){t[i]=this.array[e],t[i+1]=this.array[e+1],t[i+2]=this.array[e+2],t[i+3]=this.array[e+3];}class a_{get(e){return this.array[this.index+e]}set(e,t,i,s){}getToArray(e,t,i){}setFromArray(e,t,i){}constructor(e,t,i){switch(this.index=0,this.numComponents=t.numComponents,i.interleaved?this.array=new tJ[t.dataType](e,t.offset):this.array=new tJ[t.dataType](e,t.offset,i.vertexCount*t.numComponents),this.stride=t.stride/this.array.constructor.BYTES_PER_ELEMENT,t.numComponents){case 1:this.set=ar,this.getToArray=au,this.setFromArray=al;break;case 2:this.set=aa,this.getToArray=af,this.setFromArray=ah;break;case 3:this.set=an,this.getToArray=ap,this.setFromArray=ac;break;case 4:this.set=ao,this.getToArray=am,this.setFromArray=ad;}}}class ag{next(e=1){let t=0,i=this.accessors,s=this.accessors.length;for(;t<s;){let s=i[t++];s.index+=e*s.stride;}}end(){this.vertexBuffer.unlock();}writeData(e,t,i){let s=this.element[e];if(s){i>this.vertexBuffer.numVertices&&(i=this.vertexBuffer.numVertices);let e=s.numComponents;if(this.vertexBuffer.getFormat().interleaved){let r=0;for(let a=0;a<i;a++)s.setFromArray(r,t,a*e),r+=s.stride;}else if(t.length>i*e){let r=i*e;if(ArrayBuffer.isView(t))t=t.subarray(0,r),s.array.set(t);else for(let e=0;e<r;e++)s.array[e]=t[e];}else s.array.set(t);}}readData(e,t){let i=this.element[e],s=0;if(i){let e;s=this.vertexBuffer.numVertices;let r=i.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(t)&&(t.length=0),i.index=0;let a=0;for(e=0;e<s;e++)i.getToArray(a,t,e*r),a+=i.stride;}else if(ArrayBuffer.isView(t))t.set(i.array);else {t.length=0;let a=s*r;for(e=0;e<a;e++)t[e]=i.array[e];}}return s}constructor(e){this.vertexBuffer=e,this.vertexFormatSize=e.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};let t=this.vertexBuffer.getFormat();for(let e=0;e<t.elements.length;e++){let i=t.elements[e];this.accessors[e]=new a_(this.buffer,i,t),this.element[i.name]=this.accessors[e];}}}let av="mouse",aS="keyboard",ay="gamepad";class ax{constructor(e,t){this.key=null,this.element=null,this.event=null,t&&(this.key=t.keyCode,this.element=t.target,this.event=t);}}let aT=new ax;function aE(e){return aT.key=e.keyCode,aT.element=e.target,aT.event=e,aT}function aw(e){return "string"==typeof e?e.toUpperCase().charCodeAt(0):e}let ab={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"};class aA extends X{attach(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("keydown",this._keyDownHandler,false),this._element.addEventListener("keypress",this._keyPressHandler,false),this._element.addEventListener("keyup",this._keyUpHandler,false),document.addEventListener("visibilitychange",this._visibilityChangeHandler,false),window.addEventListener("blur",this._windowBlurHandler,false);}detach(){this._element&&(this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null,document.removeEventListener("visibilitychange",this._visibilityChangeHandler,false),window.removeEventListener("blur",this._windowBlurHandler,false));}toKeyIdentifier(e){let t=ab[(e=aw(e)).toString()];if(t)return t;let i=e.toString(16).toUpperCase(),s=i.length;for(let e=0;e<4-s;e++)i=`0${i}`;return `U+${i}`}_handleKeyDown(e){let t=e.keyCode||e.charCode;if(void 0===t)return;let i=this.toKeyIdentifier(t);this._keymap[i]=true,this.fire("keydown",aE(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation();}_handleKeyUp(e){let t=e.keyCode||e.charCode;if(void 0===t)return;let i=this.toKeyIdentifier(t);delete this._keymap[i],this.fire("keyup",aE(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation();}_handleKeyPress(e){this.fire("keypress",aE(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation();}_handleVisibilityChange(){"hidden"===document.visibilityState&&this._handleWindowBlur();}_handleWindowBlur(){this._keymap={},this._lastmap={};}update(){for(let e in this._lastmap)delete this._lastmap[e];for(let e in this._keymap)this._keymap.hasOwnProperty(e)&&(this._lastmap[e]=this._keymap[e]);}isPressed(e){let t=aw(e),i=this.toKeyIdentifier(t);return !!this._keymap[i]}wasPressed(e){let t=aw(e),i=this.toKeyIdentifier(t);return !!this._keymap[i]&&!this._lastmap[i]}wasReleased(e){let t=aw(e),i=this.toKeyIdentifier(t);return !this._keymap[i]&&!!this._lastmap[i]}constructor(e,t={}){super(),this._element=null,this._keymap={},this._lastmap={},this._keyDownHandler=this._handleKeyDown.bind(this),this._keyUpHandler=this._handleKeyUp.bind(this),this._keyPressHandler=this._handleKeyPress.bind(this),this._visibilityChangeHandler=this._handleVisibilityChange.bind(this),this._windowBlurHandler=this._handleWindowBlur.bind(this),e&&this.attach(e),this.preventDefault=t.preventDefault||false,this.stopPropagation=t.stopPropagation||false;}}function aC(){return !!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}aA.EVENT_KEYDOWN="keydown",aA.EVENT_KEYUP="keyup";class aP{constructor(e,t){this.x=0,this.y=0,this.dx=0,this.dy=0,this.button=-1,this.wheelDelta=0,this.ctrlKey=false,this.altKey=false,this.shiftKey=false,this.metaKey=false;let i={x:0,y:0};if(t){if(t instanceof aP)throw Error("Expected MouseEvent");i=e._getTargetCoords(t);}else t={};if(i)this.x=i.x,this.y=i.y;else {if(!aC())return;this.x=0,this.y=0;}"wheel"===t.type&&(t.deltaY>0?this.wheelDelta=1:t.deltaY<0&&(this.wheelDelta=-1)),aC()?(this.dx=t.movementX||t.webkitMovementX||t.mozMovementX||0,this.dy=t.movementY||t.webkitMovementY||t.mozMovementY||0):(this.dx=this.x-e._lastX,this.dy=this.y-e._lastY),("mousedown"===t.type||"mouseup"===t.type)&&(this.button=t.button),this.buttons=e._buttons.slice(0),this.element=t.target,this.ctrlKey=t.ctrlKey??false,this.altKey=t.altKey??false,this.shiftKey=t.shiftKey??false,this.metaKey=t.metaKey??false,this.event=t;}}class aI extends X{static isPointerLocked(){return aC()}attach(e){if(this._target=e,this._attached)return;this._attached=true;let t=!!k.passiveEvents&&{passive:false};window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t);}detach(){if(!this._attached)return;this._attached=false,this._target=null;let e=!!k.passiveEvents&&{passive:false};window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e);}disableContextMenu(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler);}enableContextMenu(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler);}enablePointerLock(e,t){if(!document.body.requestPointerLock){t&&t();return}let i=()=>{e(),document.removeEventListener("pointerlockchange",i);},s=()=>{t(),document.removeEventListener("pointerlockerror",s);};e&&document.addEventListener("pointerlockchange",i,false),t&&document.addEventListener("pointerlockerror",s,false),document.body.requestPointerLock();}disablePointerLock(e){if(!document.exitPointerLock)return;let t=()=>{e(),document.removeEventListener("pointerlockchange",t);};e&&document.addEventListener("pointerlockchange",t,false),document.exitPointerLock();}update(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2];}isPressed(e){return this._buttons[e]}wasPressed(e){return this._buttons[e]&&!this._lastbuttons[e]}wasReleased(e){return !this._buttons[e]&&this._lastbuttons[e]}_handleUp(e){this._buttons[e.button]=false;let t=new aP(this,e);t.event&&this.fire("mouseup",t);}_handleDown(e){this._buttons[e.button]=true;let t=new aP(this,e);t.event&&this.fire("mousedown",t);}_handleMove(e){let t=new aP(this,e);t.event&&(this.fire("mousemove",t),this._lastX=t.x,this._lastY=t.y);}_handleWheel(e){let t=new aP(this,e);t.event&&this.fire("mousewheel",t);}_getTargetCoords(e){let t=this._target.getBoundingClientRect(),i=Math.floor(t.left),s=Math.floor(t.top);return e.clientX<i||e.clientX>=i+this._target.clientWidth||e.clientY<s||e.clientY>=s+this._target.clientHeight?null:{x:e.clientX-i,y:e.clientY-s}}constructor(e){super(),this._lastX=0,this._lastY=0,this._buttons=[false,false,false],this._lastbuttons=[false,false,false],this._target=null,this._attached=false,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=e=>{e.preventDefault();},this.attach(e);}}aI.EVENT_MOUSEMOVE="mousemove",aI.EVENT_MOUSEDOWN="mousedown",aI.EVENT_MOUSEUP="mouseup",aI.EVENT_MOUSEWHEEL="mousewheel";let aD=Object.freeze([]),aR=function(){return aD};"undefined"!=typeof navigator&&(aR=(navigator.getGamepads||navigator.webkitGetGamepads||aR).bind(navigator));let aL={PAD_FACE_1:0,PAD_FACE_2:1,PAD_FACE_3:2,PAD_FACE_4:3,PAD_L_SHOULDER_1:4,PAD_R_SHOULDER_1:5,PAD_L_SHOULDER_2:6,PAD_R_SHOULDER_2:7,PAD_SELECT:8,PAD_START:9,PAD_L_STICK_BUTTON:10,PAD_R_STICK_BUTTON:11,PAD_UP:12,PAD_DOWN:13,PAD_LEFT:14,PAD_RIGHT:15,PAD_VENDOR:16,XRPAD_TRIGGER:0,XRPAD_SQUEEZE:1,XRPAD_TOUCHPAD_BUTTON:2,XRPAD_STICK_BUTTON:3,XRPAD_A:4,XRPAD_B:5},aM={PAD_L_STICK_X:0,PAD_L_STICK_Y:1,PAD_R_STICK_X:2,PAD_R_STICK_Y:3,XRPAD_TOUCHPAD_X:0,XRPAD_TOUCHPAD_Y:1,XRPAD_STICK_X:2,XRPAD_STICK_Y:3},aO={DEFAULT:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},DEFAULT_DUAL:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"],synthesizedButtons:{PAD_UP:{axis:0,min:0,max:1},PAD_DOWN:{axis:0,min:-1,max:0},PAD_LEFT:{axis:0,min:-1,max:0},PAD_RIGHT:{axis:0,min:0,max:1}}},PS3:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_4","PAD_FACE_3","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"],mapping:"standard"},DEFAULT_XR:{buttons:["XRPAD_TRIGGER","XRPAD_SQUEEZE","XRPAD_TOUCHPAD_BUTTON","XRPAD_STICK_BUTTON","XRPAD_A","XRPAD_B"],axes:["XRPAD_TOUCHPAD_X","XRPAD_TOUCHPAD_Y","XRPAD_STICK_X","XRPAD_STICK_Y"],mapping:"xr-standard"}},aF={"Product: 0268":"PS3"},aN={};function aB(e){let t=aN[e.id];if(t)return t;for(let t in aF)if(-1!==e.id.indexOf(t)){let i=aF[t];if(!e.mapping){let e=aO[`RAW_${i}`];if(e)return e}return aO[i]}if("xr-standard"===e.mapping)return aO.DEFAULT_XR;let i=aO.DEFAULT,s=e.buttons.length<i.buttons.length?aO.DEFAULT_DUAL:i;return s.mapping=e.mapping,s}let ak=.25;class aU{update(e){let{value:t,pressed:i}=e,s=e.touched??t>0;this.wasPressed=!this.pressed&&i,this.wasReleased=this.pressed&&!i,this.wasTouched=!this.touched&&s,this.value=t,this.pressed=i,this.touched=s;}constructor(e,t){this.value=0,this.pressed=false,this.touched=false,this.wasPressed=false,this.wasReleased=false,this.wasTouched=false,"number"==typeof e?(this.value=e,this.pressed=1===e,this.touched=e>0):(this.value=e.value,this.pressed=e.pressed,this.touched=e.touched??e.value>0),t&&("number"==typeof t?(this.wasPressed=1!==t&&this.pressed,this.wasReleased=1===t&&!this.pressed,this.wasTouched=0===t&&this.touched):(this.wasPressed=!t.pressed&&this.pressed,this.wasReleased=t.pressed&&!this.pressed,this.wasTouched=!(t.touched??t.value>0)&&this.touched));}}let az=Object.freeze(new aU(0));class aV{get connected(){return this.pad.connected}_compileMapping(){let{axes:e,buttons:t}=this._compiledMapping;e.length=0,t.length=0,this.map.axes&&this.map.axes.forEach((t,i)=>{e[aM[t]]=()=>this.pad.axes[i]||0;});for(let t=0,i=e.length;t<i;t++)e[t]||(e[t]=()=>0);let i=this.map.buttons;i&&i.forEach((e,i)=>{t[aL[e]]=()=>this._buttons[i]||az;});let s=this.map.synthesizedButtons;s&&Object.entries(s).forEach(e=>{let{axis:i,max:s,min:r}=e[1];t[aL[e[0]]]=()=>new aU(Math.abs(ei.clamp(this._axes[i]??0,r,s)),Math.abs(ei.clamp(this._previousAxes[i]??0,r,s)));});for(let e=0,i=t.length;e<i;e++)t[e]||(t[e]=()=>az);}update(e){this.pad=e;let t=this._previousAxes,i=this._axes;t.length=0,t.push(...i),i.length=0,i.push(...e.axes);let s=this._buttons;for(let t=0,i=s.length;t<i;t++)s[t].update(e.buttons[t]);return this}updateMap(e){e.mapping="custom",aN[this.id]=e,this.map=e,this.mapping="custom",this._compileMapping();}resetMap(){if(aN[this.id]){delete aN[this.id];let e=aB(this.pad);this.map=e,this.mapping=e.mapping,this._compileMapping();}}get axes(){return this._compiledMapping.axes.map(e=>e())}get buttons(){return this._compiledMapping.buttons.map(e=>e())}async pulse(e,t,i){let s=this.pad.vibrationActuator?[this.pad.vibrationActuator]:this.pad.hapticActuators||aD;if(s.length){let r=i?.startDelay??0,a=i?.strongMagnitude??e,n=i?.weakMagnitude??e;return (await Promise.all(s.map(async i=>{if(!i)return  true;if(i.playEffect)return i.playEffect(i.type,{duration:t,startDelay:r,strongMagnitude:a,weakMagnitude:n});if(i.pulse)return await new Promise(e=>{setTimeout(e,r);}),i.pulse(e,t);return  false}))).some(e=>true===e||"complete"===e)}return  false}getButton(e){let t=this._compiledMapping.buttons[e];return t?t():az}isPressed(e){return this.getButton(e).pressed}wasPressed(e){return this.getButton(e).wasPressed}wasReleased(e){return this.getButton(e).wasReleased}isTouched(e){return this.getButton(e).touched}wasTouched(e){return this.getButton(e).wasTouched}getValue(e){return this.getButton(e).value}getAxis(e){let t=this.axes[e];return t&&Math.abs(t)>ak?t:0}constructor(e,t){this._compiledMapping={buttons:[],axes:[]},this.id=e.id,this.index=e.index,this._buttons=e.buttons.map(e=>new aU(e)),this._axes=[...e.axes],this._previousAxes=[...e.axes],this.mapping=t.mapping,this.map=t,this.hand=e.hand||"none",this.pad=e,this._compileMapping();}}class aG extends X{set deadZone(e){ak=e;}get deadZone(){return ak}get previous(){let e=this.current;for(let t=0,i=e.length;t<i;t++){let i=e[t]._buttons;this._previous[t]||(this._previous[t]=[]);for(let e=0,s=i.length;e<s;e++){let s=i[t];this.previous[t][e]=!!s&&(!s.wasPressed&&s.pressed||s.wasReleased);}}return this._previous.length=this.current.length,this._previous}_ongamepadconnected(e){let t=new aV(e.gamepad,this.getMap(e.gamepad)),i=this.current,s=i.findIndex(e=>e.index===t.index);for(;-1!==s;)i.splice(s,1),s=i.findIndex(e=>e.index===t.index);i.push(t),this.fire("gamepadconnected",t);}_ongamepaddisconnected(e){let t=this.current,i=t.findIndex(t=>t.index===e.gamepad.index);-1!==i&&(this.fire("gamepaddisconnected",t[i]),t.splice(i,1));}update(){this.poll();}poll(e=[]){e.length>0&&(e.length=0);let t=aR();for(let i=0,s=t.length;i<s;i++)if(t[i]){let s=this.findByIndex(t[i].index);if(s)e.push(s.update(t[i]));else {let s=new aV(t[i],this.getMap(t[i]));this.current.push(s),e.push(s);}}return e}destroy(){window.removeEventListener("gamepadconnected",this._ongamepadconnectedHandler,false),window.removeEventListener("gamepaddisconnected",this._ongamepaddisconnectedHandler,false);}getMap(e){return aB(e)}isPressed(e,t){return this.current[e]?.isPressed(t)||false}wasPressed(e,t){return this.current[e]?.wasPressed(t)||false}wasReleased(e,t){return this.current[e]?.wasReleased(t)||false}getAxis(e,t){return this.current[e]?.getAxis(t)||0}pulse(e,t,i,s){let r=this.current[e];return r?r.pulse(t,i,s):Promise.resolve(false)}pulseAll(e,t,i){return Promise.all(this.current.map(s=>s.pulse(e,t,i)))}findById(e){return this.current.find(t=>t&&t.id===e)||null}findByIndex(e){return this.current.find(t=>t&&t.index===e)||null}constructor(){super(),this.gamepadsSupported=k.gamepads,this.current=[],this._previous=[],this._ongamepadconnectedHandler=this._ongamepadconnected.bind(this),this._ongamepaddisconnectedHandler=this._ongamepaddisconnected.bind(this),window.addEventListener("gamepadconnected",this._ongamepadconnectedHandler,false),window.addEventListener("gamepaddisconnected",this._ongamepaddisconnectedHandler,false),this.poll();}}function aH(e){let t=0,i=0,s=e.target;for(;!(s instanceof HTMLElement)&&s;)s=s.parentNode;for(;s;)t+=s.offsetLeft-s.scrollLeft,i+=s.offsetTop-s.scrollTop,s=s.offsetParent;return {x:e.pageX-t,y:e.pageY-i}}aG.EVENT_GAMEPADCONNECTED="gamepadconnected",aG.EVENT_GAMEPADDISCONNECTED="gamepaddisconnected";class aW{constructor(e){let t=aH(e);this.id=e.identifier,this.x=t.x,this.y=t.y,this.target=e.target,this.touch=e;}}class aX{getTouchById(e,t){return t.find(t=>t.id===e)||null}constructor(e,t){this.touches=[],this.changedTouches=[],this.element=t.target,this.event=t,this.touches=Array.from(t.touches).map(e=>new aW(e)),this.changedTouches=Array.from(t.changedTouches).map(e=>new aW(e));}}class aY extends X{attach(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("touchstart",this._startHandler,false),this._element.addEventListener("touchend",this._endHandler,false),this._element.addEventListener("touchmove",this._moveHandler,false),this._element.addEventListener("touchcancel",this._cancelHandler,false);}detach(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,false),this._element.removeEventListener("touchend",this._endHandler,false),this._element.removeEventListener("touchmove",this._moveHandler,false),this._element.removeEventListener("touchcancel",this._cancelHandler,false)),this._element=null;}_handleTouchStart(e){this.fire("touchstart",new aX(this,e));}_handleTouchEnd(e){this.fire("touchend",new aX(this,e));}_handleTouchMove(e){e.preventDefault(),this.fire("touchmove",new aX(this,e));}_handleTouchCancel(e){this.fire("touchcancel",new aX(this,e));}constructor(e){super(),this._element=null,this._startHandler=this._handleTouchStart.bind(this),this._endHandler=this._handleTouchEnd.bind(this),this._moveHandler=this._handleTouchMove.bind(this),this._cancelHandler=this._handleTouchCancel.bind(this),this.attach(e);}}aY.EVENT_TOUCHSTART="touchstart",aY.EVENT_TOUCHEND="touchend",aY.EVENT_TOUCHMOVE="touchmove",aY.EVENT_TOUCHCANCEL="touchcancel";class aq{get(e,t,i){"function"==typeof t&&(i=t,t={});let s=this.request("GET",e,t,i),{progress:r}=t;if(r){let e=e=>{e.lengthComputable&&r.fire("progress",e.loaded,e.total);},t=i=>{e(i),s.removeEventListener("loadstart",e),s.removeEventListener("progress",e),s.removeEventListener("loadend",t);};s.addEventListener("loadstart",e),s.addEventListener("progress",e),s.addEventListener("loadend",t);}return s}post(e,t,i,s){return "function"==typeof i&&(s=i,i={}),i.postdata=t,this.request("POST",e,i,s)}put(e,t,i,s){return "function"==typeof i&&(s=i,i={}),i.postdata=t,this.request("PUT",e,i,s)}del(e,t,i){return "function"==typeof t&&(i=t,t={}),this.request("DELETE",e,t,i)}request(e,t,i,s){let r,a,n,o=false;if("function"==typeof i&&(s=i,i={}),i.retry&&(i=Object.assign({retries:0,maxRetries:5},i)),i.callback=s,null==i.async&&(i.async=true),null==i.headers&&(i.headers={}),null!=i.postdata)if(i.postdata instanceof Document)n=i.postdata;else if(i.postdata instanceof FormData)n=i.postdata;else if(i.postdata instanceof Object){let e=i.headers["Content-Type"];switch(void 0===e&&(i.headers["Content-Type"]=aq.ContentType.FORM_URLENCODED,e=i.headers["Content-Type"]),e){case aq.ContentType.FORM_URLENCODED:{n="";let e=true;for(let t in i.postdata)if(i.postdata.hasOwnProperty(t)){e?e=false:n+="&";let s=encodeURIComponent(t),r=encodeURIComponent(i.postdata[t]);n+=`${s}=${r}`;}break}default:case aq.ContentType.JSON:null==e&&(i.headers["Content-Type"]=aq.ContentType.JSON),n=JSON.stringify(i.postdata);}}else n=i.postdata;if(false===i.cache){let e=Q();(r=new ee(t)).query?r.query=`${r.query}&ts=${e}`:r.query=`ts=${e}`,t=r.toString();}i.query&&(a=A((r=new ee(t)).getQuery(),i.query),r.setQuery(a),t=r.toString());let l=new XMLHttpRequest;for(let s in l.open(e,t,i.async),l.withCredentials=void 0!==i.withCredentials&&i.withCredentials,l.responseType=i.responseType||this._guessResponseType(t),i.headers)i.headers.hasOwnProperty(s)&&l.setRequestHeader(s,i.headers[s]);l.onreadystatechange=()=>{this._onReadyStateChange(e,t,i,l);},l.onerror=()=>{this._onError(e,t,i,l),o=true;};try{l.send(n);}catch(e){o||i.error(l.status,l,e);}return l}_guessResponseType(e){let t=new ee(e),i=P.getExtension(t.path).toLowerCase();return aq.binaryExtensions.indexOf(i)>=0?aq.ResponseType.ARRAY_BUFFER:".json"===i?aq.ResponseType.JSON:".xml"===i?aq.ResponseType.DOCUMENT:aq.ResponseType.TEXT}_isBinaryContentType(e){return [aq.ContentType.BASIS,aq.ContentType.BIN,aq.ContentType.DDS,aq.ContentType.GLB,aq.ContentType.MP3,aq.ContentType.MP4,aq.ContentType.OGG,aq.ContentType.OPUS,aq.ContentType.WAV].indexOf(e)>=0}_isBinaryResponseType(e){return e===aq.ResponseType.ARRAY_BUFFER||e===aq.ResponseType.BLOB||e===aq.ResponseType.JSON}_onReadyStateChange(e,t,i,s){if(4===s.readyState)switch(s.status){case 0:s.responseURL&&s.responseURL.startsWith("file:///")?this._onSuccess(e,t,i,s):this._onError(e,t,i,s);break;case 200:case 201:case 206:case 304:this._onSuccess(e,t,i,s);break;default:this._onError(e,t,i,s);}}_onSuccess(e,t,i,s){let r,a,n=s.getResponseHeader("Content-Type");n&&(a=n.split(";")[0].trim());try{r=this._isBinaryContentType(a)||this._isBinaryResponseType(s.responseType)?s.response:a===aq.ContentType.JSON||t.split("?")[0].endsWith(".json")?JSON.parse(s.responseText):s.responseType===aq.ResponseType.DOCUMENT||a===aq.ContentType.XML?s.responseXML:s.responseText,i.callback(null,r);}catch(e){i.callback(e);}}_onError(e,t,i,s){i.retrying||(i.retry&&i.retries<i.maxRetries?(i.retries++,i.retrying=true,setTimeout(()=>{i.retrying=false,this.request(e,t,i,i.callback);},ei.clamp(Math.pow(2,i.retries)*aq.retryDelay,0,i.maxRetryDelay||5e3))):i.callback(0===s.status?"Network error":s.status,null));}}aq.ContentType={AAC:"audio/aac",BASIS:"image/basis",BIN:"application/octet-stream",DDS:"image/dds",FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",GLB:"model/gltf-binary",JPEG:"image/jpeg",JSON:"application/json",MP3:"audio/mpeg",MP4:"audio/mp4",OGG:"audio/ogg",OPUS:'audio/ogg; codecs="opus"',PNG:"image/png",TEXT:"text/plain",WAV:"audio/x-wav",XML:"application/xml"},aq.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},aq.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb",".opus"],aq.retryDelay=100;let a$=new aq,aj="linear",aK="inverse",aZ="exponential";class aQ{getPosition(){return this.position}setPosition(e){this.position.copy(e);let t=this.listener;t&&("positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z));}setOrientation(e){this.orientation.copy(e);let t=this.listener;if(t){let i=e.data;"forwardX"in t?(t.forwardX.value=-i[8],t.forwardY.value=-i[9],t.forwardZ.value=-i[10],t.upX.value=i[4],t.upY.value=i[5],t.upZ.value=i[6]):t.setOrientation&&t.setOrientation(-i[8],-i[9],-i[10],i[4],i[5],i[6]);}}getOrientation(){return this.orientation}get listener(){let e=this._manager.context;return e?e.listener:null}constructor(e){this.position=new ed,this.orientation=new ey,this._manager=e;}}let aJ="running",a0=["click","touchstart","mousedown"];class a1 extends X{set volume(e){e=ei.clamp(e,0,1),this._volume=e,this.fire("volumechange",e);}get volume(){return this._volume}get suspended(){return this._userSuspended}get context(){return !this._context&&this.AudioContext&&(this._context=new this.AudioContext,this._context.state!==aJ&&this._registerUnlockListeners()),this._context}suspend(){!this._userSuspended&&(this._userSuspended=true,this._context&&this._context.state===aJ&&this._suspend());}resume(){this._userSuspended&&(this._userSuspended=false,this._context&&this._context.state!==aJ&&this._resume());}destroy(){this.fire("destroy"),this._context&&(this._removeUnlockListeners(),this._context?.close(),this._context=null);}_resume(){this._context.resume().then(()=>{let e=this._context.createBufferSource();e.buffer=this._context.createBuffer(1,1,this._context.sampleRate),e.connect(this._context.destination),e.start(0),e.onended=t=>{e.disconnect(0),this.fire("resume");};},e=>{}).catch(e=>{});}_suspend(){this._context.suspend().then(()=>{this.fire("suspend");},e=>{}).catch(e=>{});}_unlockHandler(){this._removeUnlockListeners(),this._userSuspended||this._context.state===aJ||this._resume();}_registerUnlockListeners(){a0.forEach(e=>{window.addEventListener(e,this._unlockHandlerFunc,false);});}_removeUnlockListeners(){a0.forEach(e=>{window.removeEventListener(e,this._unlockHandlerFunc,false);});}constructor(){super(),this._context=null,this.AudioContext="undefined"!=typeof AudioContext&&AudioContext||"undefined"!=typeof webkitAudioContext&&webkitAudioContext,this.AudioContext,this._unlockHandlerFunc=this._unlockHandler.bind(this),this._userSuspended=false,this.listener=new aQ(this),this._volume=1;}}class a2{get duration(){let e=0;return this.buffer?e=this.buffer.duration:this.audio&&(e=this.audio.duration),e||0}constructor(e){e instanceof Audio?this.audio=e:this.buffer=e;}}function a3(){return "undefined"!=typeof AudioContext||"undefined"!=typeof webkitAudioContext}class a4 extends X{set currentTime(e){if(!(e<0))if(0===this._state){let t=this._suspendInstanceEvents;this._suspendInstanceEvents=true,this.stop(),this._startOffset=e,this.play(),this._suspendInstanceEvents=t;}else this._startOffset=e,this._currentTime=e;}get currentTime(){return null!==this._startOffset?this._startOffset:1===this._state?this._currentTime:2!==this._state&&this.source?(this._updateCurrentTime(),this._currentTime):0}set duration(e){this._duration=Math.max(0,Number(e)||0);let t=0===this._state;this.stop(),t&&this.play();}get duration(){if(!this._sound)return 0;if(this._duration)return this._duration%this._sound.duration||0;return this._sound.duration}get isPaused(){return 1===this._state}get isPlaying(){return 0===this._state}get isStopped(){return 2===this._state}get isSuspended(){return this._suspended}set loop(e){this._loop=!!e,this.source&&(this.source.loop=this._loop);}get loop(){return this._loop}set pitch(e){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch);}get pitch(){return this._pitch}set sound(e){this._sound=e,2!==this._state?this.stop():this._createSource();}get sound(){return this._sound}set startTime(e){this._startTime=Math.max(0,Number(e)||0);let t=0===this._state;this.stop(),t&&this.play();}get startTime(){return this._startTime}set volume(e){e=ei.clamp(e,0,1),this._volume=e,this.gain&&(this.gain.gain.value=e*this._manager.volume);}get volume(){return this._volume}_onPlay(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this);}_onPause(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this);}_onResume(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this);}_onStop(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this);}_onEnded(){this._suspendEndEvent>0?this._suspendEndEvent--:(this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop());}_onManagerVolumeChange(){this.volume=this._volume;}_onManagerSuspend(){0!==this._state||this._suspended||(this._suspended=true,this.pause());}_onManagerResume(){this._suspended&&(this._suspended=false,this.resume());}_initializeNodes(){this.gain=this._manager.context.createGain(),this._inputNode=this.gain,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination);}play(){return 2!==this._state&&this.stop(),this._state=0,this._playWhenLoaded=false,!this._waitingContextSuspension&&(this._manager.suspended?(this._manager.once("resume",this._playAudioImmediate,this),this._waitingContextSuspension=true,false):(this._playAudioImmediate(),true))}_playAudioImmediate(){if(this._waitingContextSuspension=false,0!==this._state)return;this.source||this._createSource();let e=this._startOffset%this.duration||0;e=(this._startTime+e)%this._sound.duration||0,this._startOffset=null,this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._suspendInstanceEvents||this._onPlay();}pause(){return this._playWhenLoaded=false,0===this._state&&(this._state=1,!!this._waitingContextSuspension||(this._updateCurrentTime(),this._suspendEndEvent++,this.source.stop(0),this.source=null,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),true))}resume(){if(1!==this._state)return  false;let e=this.currentTime;if(this._state=0,this._waitingContextSuspension)return  true;(this.source||this._createSource(),null!==this._startOffset)&&(e=this._startOffset%this.duration||0,e=(this._startTime+e)%this._sound.duration||0,this._startOffset=null);return this._duration?this.source.start(0,e,this._duration):this.source.start(0,e),this._startedAt=this._manager.context.currentTime,this._currentOffset=e,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=false,this._suspendInstanceEvents||this._onResume(),true}stop(){if(this._playWhenLoaded=false,2===this._state)return  false;let e=0===this._state;return this._state=2,!!this._waitingContextSuspension||(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._startOffset=null,this._suspendEndEvent++,e&&this.source&&this.source.stop(0),this.source=null,this._suspendInstanceEvents||this._onStop(),true)}setExternalNodes(e,t){if(!e)return;t||(t=e);let i=this._manager.context.destination;this._firstNode!==e&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(i),this._firstNode=e,this._connectorNode.connect(e)),this._lastNode!==t&&(this._lastNode&&this._lastNode.disconnect(i),this._lastNode=t,this._lastNode.connect(i));}clearExternalNodes(){let e=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(e),this._lastNode=null),this._connectorNode.connect(e);}getExternalNodes(){return [this._firstNode,this._lastNode]}_createSource(){if(!this._sound)return null;let e=this._manager.context;this._sound.buffer&&(this.source=e.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=this._startTime%this.source.buffer.duration||0,this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,(this._startTime+this._duration)%this.source.buffer.duration||0)));return this.source}_updateCurrentTime(){this._currentTime=((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset)%this.duration||0;}_onManagerDestroy(){this.source&&0===this._state&&(this.source.stop(0),this.source=null);}constructor(e,t,i){super(),this.source=null,this._manager=e,this._volume=void 0!==i.volume?ei.clamp(Number(i.volume)||0,0,1):1,this._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,this._loop=!!(void 0!==i.loop&&i.loop),this._sound=t,this._state=2,this._suspended=false,this._suspendEndEvent=0,this._suspendInstanceEvents=false,this._playWhenLoaded=true,this._startTime=Math.max(0,Number(i.startTime)||0),this._duration=Math.max(0,Number(i.duration)||0),this._startOffset=null,this._onPlayCallback=i.onPlay,this._onPauseCallback=i.onPause,this._onResumeCallback=i.onResume,this._onStopCallback=i.onStop,this._onEndCallback=i.onEnd,a3()?(this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._inputNode=null,this._connectorNode=null,this._firstNode=null,this._lastNode=null,this._waitingContextSuspension=false,this._initializeNodes(),this._endedHandler=this._onEnded.bind(this)):(this._isReady=false,this._loadedMetadataHandler=this._onLoadedMetadata.bind(this),this._timeUpdateHandler=this._onTimeUpdate.bind(this),this._endedHandler=this._onEnded.bind(this),this._createSource());}}a4.EVENT_PLAY="play",a4.EVENT_PAUSE="pause",a4.EVENT_RESUME="resume",a4.EVENT_STOP="stop",a4.EVENT_END="end",a3()||(Object.assign(a4.prototype,{play:function(){return 2!==this._state&&this.stop(),(!!this.source||!!this._createSource())&&(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=0,this._playWhenLoaded=false,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),true)},pause:function(){return !!this.source&&0===this._state&&(this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=false,this._state=1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),true)},resume:function(){return !!this.source&&1===this._state&&(this._state=0,this._playWhenLoaded=false,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),true)},stop:function(){return !!this.source&&2!==this._state&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent++,this.source.pause(),this._playWhenLoaded=false,this._state=2,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),true)},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return [null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=true;let e=this._startOffset%this.duration||0;e=(this._startTime+e)%this._sound.duration||0,this._startOffset=null,this.source.currentTime=e;},_createSource:function(){return this._sound&&this._sound.audio&&(this._isReady=false,this.source=this._sound.audio.cloneNode(true),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>((this._startTime+this._duration)%this.source.duration||0)&&(this.loop?this.source.currentTime=this._startTime%this.source.duration||0:(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()));},_onManagerDestroy:function(){this.source&&this.source.pause();}}),Object.defineProperty(a4.prototype,"volume",{get:function(){return this._volume},set:function(e){e=ei.clamp(e,0,1),this._volume=e,this.source&&(this.source.volume=e*this._manager.volume);}}),Object.defineProperty(a4.prototype,"pitch",{get:function(){return this._pitch},set:function(e){this._pitch=Math.max(Number(e)||0,.01),this.source&&(this.source.playbackRate=this._pitch);}}),Object.defineProperty(a4.prototype,"sound",{get:function(){return this._sound},set:function(e){this.stop(),this._sound=e;}}),Object.defineProperty(a4.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:2!==this._state&&this.source?this.source.currentTime-this._startTime:0},set:function(e){!(e<0)&&(this._startOffset=e,this.source&&this._isReady)&&(this.source.currentTime=(this._startTime+(e%this.duration||0))%this._sound.duration||0,this._startOffset=null);}}));class a5 extends a4{_initializeNodes(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination);}set position(e){this._position.copy(e);let t=this.panner;"positionX"in t?(t.positionX.value=e.x,t.positionY.value=e.y,t.positionZ.value=e.z):t.setPosition&&t.setPosition(e.x,e.y,e.z);}get position(){return this._position}set velocity(e){this._velocity.copy(e);}get velocity(){return this._velocity}set maxDistance(e){this.panner.maxDistance=e;}get maxDistance(){return this.panner.maxDistance}set refDistance(e){this.panner.refDistance=e;}get refDistance(){return this.panner.refDistance}set rollOffFactor(e){this.panner.rolloffFactor=e;}get rollOffFactor(){return this.panner.rolloffFactor}set distanceModel(e){this.panner.distanceModel=e;}get distanceModel(){return this.panner.distanceModel}constructor(e,t,i={}){super(e,t,i),this._position=new ed,this._velocity=new ed,i.position&&(this.position=i.position),this.maxDistance=void 0!==i.maxDistance?Number(i.maxDistance):1e4,this.refDistance=void 0!==i.refDistance?Number(i.refDistance):1,this.rollOffFactor=void 0!==i.rollOffFactor?Number(i.rollOffFactor):1,this.distanceModel=void 0!==i.distanceModel?i.distanceModel:aj;}}if(!a3()){let e=new ed,t=function(t,i,s,r,a,n){let o=(e=e.sub2(t,i)).length();if(o<s)return 1;if(o>r)return 0;let l=0;return n===aj?l=1-a*(o-s)/(r-s):n===aK?l=s/(s+a*(o-s)):n===aZ&&(l=Math.pow(o/s,-a)),ei.clamp(l,0,1)};Object.defineProperty(a5.prototype,"position",{get:function(){return this._position},set:function(e){if(this._position.copy(e),this.source){let e=t(this._manager.listener.getPosition(),this._position,this.refDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),i=this.volume;this.source.volume=i*e*this._manager.volume;}}}),Object.defineProperty(a5.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(e){this._maxDistance=e;}}),Object.defineProperty(a5.prototype,"refDistance",{get:function(){return this._refDistance},set:function(e){this._refDistance=e;}}),Object.defineProperty(a5.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(e){this._rollOffFactor=e;}}),Object.defineProperty(a5.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(e){this._distanceModel=e;}});}let a8={0:"SUBTRACTIVE",1:"ADDITIVE",2:"NORMAL",3:"NONE",4:"PREMULTIPLIED",5:"MULTIPLICATIVE",6:"ADDITIVEALPHA",7:"MULTIPLICATIVE2X",8:"SCREEN",9:"MIN",10:"MAX"},a6="none",a9="linear",a7={0:"NONE",2:"SCHLICK"},ne={0:"DIRECTIONAL",1:"OMNI",2:"SPOT"},nt={0:"PUNCTUAL",1:"RECT",2:"DISK",3:"SPHERE"},ni={0:"LINEAR",1:"INVERSESQUARED"},ns=new Map([[5,{name:"PCF1_32F",kind:"PCF1",format:16,pcf:true}],[0,{name:"PCF3_32F",kind:"PCF3",format:16,pcf:true}],[4,{name:"PCF5_32F",kind:"PCF5",format:16,pcf:true}],[7,{name:"PCF1_16F",kind:"PCF1",format:69,pcf:true}],[8,{name:"PCF3_16F",kind:"PCF3",format:69,pcf:true}],[9,{name:"PCF5_16F",kind:"PCF5",format:69,pcf:true}],[2,{name:"VSM_16F",kind:"VSM",format:12,vsm:true}],[3,{name:"VSM_32F",kind:"VSM",format:14,vsm:true}],[6,{name:"PCSS_32F",kind:"PCSS",format:15,pcss:true}]]),nr={0:"NONE",1:"BOX"},na={0:"NONE",1:"SRGB"},nn=["LINEAR","FILMIC","HEJL","ACES","ACES2","NEUTRAL","NONE"],no={0:"NONE",1:"AO",2:"GLOSSDEPENDENT"},nl="none",nh="envAtlas",nc="envAtlasHQ",nd="cubeMap",nu="sphereMap",nf={[nl]:"NONE",[nh]:"ENVATLAS",[nc]:"ENVATLASHQ",[nd]:"CUBEMAP",[nu]:"SPHEREMAP"},np="ambientSH",nm="envAtlas",n_="constant",ng={[np]:"AMBIENTSH",[nm]:"ENVALATLAS",[n_]:"CONSTANT"},nv={0:"SIMPLE",1:"SLICED",2:"TILED"},nS="infinite",ny="dome",nx="none",nT="bayer8",nE="bluenoise",nw="ignnoise",nb={[nx]:"NONE",[nT]:"BAYER8",[nE]:"BLUENOISE",[nw]:"IGNNOISE"},nA="prerender",nC="postrender",nP="prerender:layer",nI="postrender:layer",nD="precull",nR="postcull",nL="cull:end",nM="pcShadowCamera";class nO{hasUniform(e){for(let t=0;t<this.uniformFormats.length;t++){let i=this.uniformFormats[t];if(i?.get(e))return  true}return  false}hasTexture(e){for(let t=0;t<this.bindGroupFormats.length;t++){let i=this.bindGroupFormats[t];if(i?.getTexture(e))return  true}return  false}getVertexElement(e){return this.vertexFormat?.elements.find(t=>t.name===e)}generateKey(e){let t=JSON.stringify(this.uniformFormats)+JSON.stringify(this.bindGroupFormats);return e.isWebGPU&&(t+=this.vertexFormat?.shaderProcessingHashString),t}constructor(e,t,i){this.uniformFormats=[],this.bindGroupFormats=[],this.uniformFormats[0]=e,this.bindGroupFormats[0]=t,this.vertexFormat=i;}}let nF=new ii;function nN(e){return nF.get(e)}class nB{static definesHash(e){return iI(JSON.stringify(Array.from(e).sort((e,t)=>e[0]>t[0]?1:-1)))}}let nk=new ii;class nU{buildShaderDefines(){let e;this.isShadow?e="SHADOW":this.isForward?e="FORWARD":3===this.index?e="PICK":4===this.index&&(e="PICK",this.defines.set("DEPTH_PICK_PASS","")),this.defines.set(`${e}_PASS`,""),this.defines.set(`${this.name.toUpperCase()}_PASS`,"");}constructor(e,t,i={}){this.defines=new Map,this.name=e,this.index=t,Object.assign(this,i),this.buildShaderDefines();}}class nz{static get(e){return nk.get(e,()=>new nz)}allocate(e,t){let i=this.passesNamed.get(e);return void 0===i&&(i=new nU(e,this.nextIndex,t),this.passesNamed.set(i.name,i),this.passesIndexed[i.index]=i,this.nextIndex++),i}getByIndex(e){return this.passesIndexed[e]}getByName(e){return this.passesNamed.get(e)}constructor(){this.passesNamed=new Map,this.passesIndexed=[],this.nextIndex=0;let e=(e,t,i)=>{this.allocate(e,i);};e("forward",0,{isForward:true}),e("prepass"),e("shadow"),e("pick"),e("depth_pick");}}class nV extends Map{set(e,t){return this.has(e)&&this.get(e)===t||this.markDirty(),super.set(e,t)}add(e,t=true){for(let[i,s]of Object.entries(e))(t||!this.has(i))&&this.set(i,s);return this}delete(e){let t=this.has(e),i=super.delete(e);return t&&i&&this.markDirty(),i}clear(){this.size>0&&this.markDirty(),super.clear();}markDirty(){this._dirty=true,this._keyDirty=true;}isDirty(){return this._dirty}resetDirty(){this._dirty=false;}get key(){return this._keyDirty&&(this._keyDirty=false,this._key=Array.from(this.entries()).sort(([e],[t])=>e<t?-1:+(e>t)).map(([e,t])=>`${e}=${iI(t)}`).join(",")),this._key}copy(e){for(let[t,i]of(this.clear(),e))this.set(t,i);return this}constructor(e){super(),this._keyDirty=false,this._key="",this._validations=e;}}let nG=new ii;class nH{static get(e,t=tz){let i=nG.get(e,()=>new nH);return t===tz?i.glsl:i.wgsl}static registerValidation(e,t){}get useWGSL(){return 0===this.glsl.size||this.wgsl.size>0}get key(){return `GLSL:${this.glsl.key}|WGSL:${this.wgsl.key}|API:${this.version}`}isDirty(){return this.glsl.isDirty()||this.wgsl.isDirty()}resetDirty(){this.glsl.resetDirty(),this.wgsl.resetDirty();}copy(e){return this.version=e.version,this.glsl.copy(e.glsl),this.wgsl.copy(e.wgsl),this}constructor(){this.glsl=new nV(nH._validations),this.wgsl=new nV(nH._validations),this.version="";}}nH._validations=new Map;class nW{static merge(...e){let t=new Map(e[0]??[]);for(let i=1;i<e.length;i++){let s=e[i];if(s)for(let[e,i]of s)t.set(e,i);}return t}}class nX extends nB{generateKey(e){return this.key}createShaderDefinition(e,t){return this.shaderDefinition}constructor(e,t){super(),this.key=e,this.shaderDefinition=t;}}class nY{static createShader(e,t){let i=nN(e),s=i.getCachedShader(t.uniqueName);if(!s){let r=e.isWebGPU&&(!!t.vertexWGSL||!!t.vertexChunk)&&(!!t.fragmentWGSL||!!t.fragmentChunk),a=nH.get(e,r?tV:tz),n=t.vertexChunk?a.get(t.vertexChunk):r?t.vertexWGSL:t.vertexGLSL,o=t.fragmentChunk?a.get(t.fragmentChunk):r?t.fragmentWGSL:t.fragmentGLSL,l=nW.merge(a,t.fragmentIncludes),h=nW.merge(a,t.vertexIncludes);s=new rd(e,rh.createDefinition(e,{name:t.uniqueName,shaderLanguage:r?tV:tz,attributes:t.attributes,vertexCode:n,fragmentCode:o,useTransformFeedback:t.useTransformFeedback,vertexIncludes:h,vertexDefines:t.vertexDefines,fragmentIncludes:l,fragmentDefines:t.fragmentDefines,fragmentOutputTypes:t.fragmentOutputTypes})),i.setCachedShader(t.uniqueName,s);}return s}static getCoreDefines(e,t){let i=new Map(e.defines);return t.cameraShaderParams.defines.forEach((e,t)=>i.set(t,e)),nz.get(t.device).getByIndex(t.pass).defines.forEach((e,t)=>i.set(t,e)),i}static processShader(e,t){let i=e.definition,s=i.name??"shader",r=new nX(`${s}-id-${e.id}`,i),a="shader",n=nN(e.device);n.register(a,r);let o=n.getProgram(a,{},t);return n.unregister(a),o}static addScreenDepthChunkDefines(e,t,i){t.sceneDepthMapLinear&&i.set("SCENE_DEPTHMAP_LINEAR",""),e.textureFloatRenderable&&i.set("SCENE_DEPTHMAP_FLOAT","");}}let nq={type:5,base:0,baseVertex:0,count:4,indexed:false},n$=new ep,nj=new ep,nK=new i_;class nZ{destroy(){this.uniformBuffer?.destroy(),this.uniformBuffer=null,this.bindGroup?.destroy(),this.bindGroup=null;}render(e,t){let i=this.shader.device;e&&(n$.set(i.vx,i.vy,i.vw,i.vh),nj.set(i.sx,i.sy,i.sw,i.sh),t=t??e,i.setViewport(e.x,e.y,e.z,e.w),i.setScissor(t.x,t.y,t.z,t.w)),i.setVertexBuffer(i.quadVertexBuffer);let s=this.shader;if(i.setShader(s),i.supportsUniformBuffers){i.setBindGroup(0,i.emptyBindGroup);let e=this.bindGroup;e.update(),i.setBindGroup(1,e);let t=this.uniformBuffer;t?(t.update(nK),i.setBindGroup(2,nK.bindGroup,nK.offsets)):i.setBindGroup(2,i.emptyBindGroup);}i.draw(nq),e&&(i.setViewport(n$.x,n$.y,n$.z,n$.w),i.setScissor(nj.x,nj.y,nj.z,nj.w));}constructor(e){let t=e.device;if(this.shader=e,t.supportsUniformBuffers){let i=new nO;this.shader=nY.processShader(e,i);let s=this.shader.meshUniformBufferFormat;s&&(this.uniformBuffer=new r_(t,s,false));let r=this.shader.meshBindGroupFormat;this.bindGroup=new ig(t,r);}}}class nQ extends as{execute(){let{device:e}=this;e.setCullMode(0),e.setDepthState(ix.NODEPTH),e.setStencilState(null,null),this.quad.render(this.rect,this.scissorRect);}constructor(e,t,i,s){super(e),this.quad=t,this.rect=i,this.scissorRect=s;}}let nJ=new ep;function n0(e,t,i,s,r){let a=new nZ(i);s||((s=nJ).x=0,s.y=0,s.z=t?t.width:e.width,s.w=t?t.height:e.height);let n=new nQ(e,a,s,r);n.init(t),n.colorOps.clear=false,n.depthStencilOps.clearDepth=false,e.isWebGPU&&null===t&&e.samples>1&&(n.colorOps.store=true),n.render(),a.destroy();}class n1{destroy(e,t){this.meshInstance&&(this.removeFromLayers(e,t),this.meshInstance.destroy(),this.meshInstance=null);}addToLayers(e,t){for(let i=0;i<t.length;i++){let s=e.layers.getLayerById(t[i]);s&&s.addMeshInstances([this.meshInstance]);}}removeFromLayers(e,t){for(let i=0;i<t.length;i++){let s=e.layers.getLayerById(t[i]);s&&s.removeMeshInstances([this.meshInstance]);}}updateBoundingBox(){this._aabb.copy(this.origMeshInstances[0].aabb);for(let e=1;e<this.origMeshInstances.length;e++)this._aabb.add(this.origMeshInstances[e].aabb);this.meshInstance.aabb=this._aabb,this.meshInstance._aabbVer=0;}get model(){}constructor(e,t,i){this._aabb=new eC,this.meshInstance=null,this.origMeshInstances=e,this.dynamic=t,this.batchGroupId=i;}}class n2{constructor(e,t,i,s,r=[0]){this._ui=false,this._sprite=false,this._obj={model:[],element:[],sprite:[],render:[]},this.id=e,this.name=t,this.dynamic=i,this.maxAabbSize=s,this.layers=r;}}n2.MODEL="model",n2.ELEMENT="element",n2.SPRITE="sprite",n2.RENDER="render";let n3=new ey;class n4{set rootBone(e){this._rootBone=e;}get rootBone(){return this._rootBone}init(e,t){let i=3*t,s=Math.ceil(Math.sqrt(i)),r=Math.ceil(i/(s=ei.roundUp(s,3)));this.boneTexture=new ih(e,{width:s,height:r,format:14,mipmaps:false,minFilter:0,magFilter:0,name:"skin"}),this.matrixPalette=this.boneTexture.lock({mode:1}),this.boneTexture.unlock();}destroy(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null);}resolve(e,t){this.rootBone=e;let i=this.skin,s=[];for(let r=0;r<i.boneNames.length;r++){let a=i.boneNames[r],n=e.findByName(a);n||(n=t),s.push(n);}this.bones=s;}initSkin(e){this.skin=e,this.bones=[];let t=e.inverseBindPose.length;this.init(e.device,t),this.matrices=[];for(let e=0;e<t;e++)this.matrices[e]=new ey;}uploadBones(e){this.boneTexture.upload();}_updateMatrices(e,t){if(this._skinUpdateIndex!==t){this._skinUpdateIndex=t,n3.copy(e.getWorldTransform()).invert();for(let e=this.bones.length-1;e>=0;e--)this.matrices[e].mulAffine2(n3,this.bones[e].getWorldTransform()),this.matrices[e].mulAffine2(this.matrices[e],this.skin.inverseBindPose[e]);}}updateMatrices(e,t){this._updateBeforeCull&&this._updateMatrices(e,t);}updateMatrixPalette(e,t){this._updateMatrices(e,t);let i=this.matrixPalette,s=this.bones.length;for(let e=0;e<s;e++){let t=this.matrices[e].data,s=12*e;i[s]=t[0],i[s+1]=t[4],i[s+2]=t[8],i[s+3]=t[12],i[s+4]=t[1],i[s+5]=t[5],i[s+6]=t[9],i[s+7]=t[13],i[s+8]=t[2],i[s+9]=t[6],i[s+10]=t[10],i[s+11]=t[14];}this.uploadBones(this.skin.device);}constructor(e){this._dirty=true,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=true,e&&this.initSkin(e);}}class n5 extends n4{updateMatrices(e,t){}updateMatrixPalette(e,t){let i=this.matrixPalette,s=this.bones.length;for(let e=0;e<s;e++){let t=this.bones[e].getWorldTransform().data,s=12*e;i[s]=t[0],i[s+1]=t[4],i[s+2]=t[8],i[s+3]=t[12],i[s+4]=t[1],i[s+5]=t[5],i[s+6]=t[9],i[s+7]=t[13],i[s+8]=t[2],i[s+9]=t[6],i[s+10]=t[10],i[s+11]=t[14];}this.uploadBones(this.device);}constructor(e,t,i){super();let s=t.length;this.init(e,s),this.device=e,this.rootNode=i,this.bones=t;}}let n8=0;class n6{initDefaults(){this.recreate=false,this.verticesUsage=0,this.indicesUsage=0,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=false,this.indexStreamUpdated=false,this.vertexStreamDictionary={},this.indices=null;}_changeVertexCount(e,t){this.vertexCount||(this.vertexCount=e);}constructor(){this.initDefaults();}}n6.DEFAULT_COMPONENTS_POSITION=3,n6.DEFAULT_COMPONENTS_NORMAL=3,n6.DEFAULT_COMPONENTS_UV=2,n6.DEFAULT_COMPONENTS_COLORS=4;class n9{constructor(e,t,i,s,r){this.data=e,this.componentCount=t,this.dataType=i,this.dataTypeNormalize=s,this.asInt=r;}}class n7 extends st{static fromGeometry(e,t,i={}){let s=new n7(e,i),{positions:r,normals:a,tangents:n,colors:o,uvs:l,uvs1:h,blendIndices:c,blendWeights:d,indices:u}=t;return r&&s.setPositions(r),a&&s.setNormals(a),n&&s.setVertexStream(e7,n,4),o&&s.setColors32(o),l&&s.setUvs(0,l),h&&s.setUvs(1,h),c&&s.setVertexStream(tt,c,4,c.length/4,1),d&&s.setVertexStream(te,d,4),u&&s.setIndices(u),s.update(),s}set morph(e){e!==this._morph&&(this._morph&&this._morph.decRefCount(),this._morph=e,e&&e.incRefCount());}get morph(){return this._morph}set aabb(e){this._aabb=e,this._aabbVer++;}get aabb(){return this._aabb}destroy(){let e=this.morph;e&&(this.morph=null,e.refCount<1&&e.destroy()),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(let e=0;e<this.indexBuffer.length;e++)this._destroyIndexBuffer(e);this.indexBuffer.length=0,this._geometryData=null;}_destroyIndexBuffer(e){this.indexBuffer[e]&&(this.indexBuffer[e].destroy(),this.indexBuffer[e]=null);}_initBoneAabbs(e){let t,i,s,r,a,n,o,l;this.boneAabb=[],this.boneUsed=[];let h=[],c=[],d=this.boneUsed,u=this.skin.boneNames.length;for(let e=0;e<u;e++)h[e]=new ed(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),c[e]=new ed(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);let f=new ag(this.vertexBuffer),p=f.element[e6],m=f.element[te],_=f.element[tt],g=this.vertexBuffer.numVertices;for(let u=0;u<g;u++){for(let f=0;f<4;f++)if(m.array[m.index+f]>0){let m=_.array[_.index+f];if(d[m]=true,t=p.array[p.index],i=p.array[p.index+1],s=p.array[p.index+2],r=c[m],(a=h[m]).x>t&&(a.x=t),a.y>i&&(a.y=i),a.z>s&&(a.z=s),r.x<t&&(r.x=t),r.y<i&&(r.y=i),r.z<s&&(r.z=s),e){let h=n=t,c=o=i,d=l=s;for(let t=0;t<e.length;t++){let i=e[t],s=i.deltaPositions[3*u],r=i.deltaPositions[3*u+1],a=i.deltaPositions[3*u+2];s<0?h+=s:n+=s,r<0?c+=r:o+=r,a<0?d+=a:l+=a;}a.x>h&&(a.x=h),a.y>c&&(a.y=c),a.z>d&&(a.z=d),r.x<n&&(r.x=n),r.y<o&&(r.y=o),r.z<l&&(r.z=l);}}f.next();}let v=this.vertexBuffer.getFormat().elements.find(e=>e.name===e6);if(v&&v.normalize){let e=(()=>{switch(v.dataType){case 0:return e=>Math.max(e/127,-1);case 1:return e=>e/255;case 2:return e=>Math.max(e/32767,-1);case 3:return e=>e/65535;default:return e=>e}})();for(let t=0;t<u;t++)if(d[t]){let i=h[t],s=c[t];i.set(e(i.x),e(i.y),e(i.z)),s.set(e(s.x),e(s.y),e(s.z));}}for(let e=0;e<u;e++){let t=new eC;t.setMinMax(h[e],c[e]),this.boneAabb.push(t);}}_initGeometryData(){!this._geometryData&&(this._geometryData=new n6,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices));}clear(e,t,i=0,s=0){this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=true,this._geometryData.maxVertices=i,this._geometryData.maxIndices=s,this._geometryData.verticesUsage=+!e,this._geometryData.indicesUsage=+!t;}setVertexStream(e,t,i,s,r=6,a=false,n=false){this._initGeometryData();let o=s||t.length/i;this._geometryData._changeVertexCount(o,e),this._geometryData.vertexStreamsUpdated=true,this._geometryData.vertexStreamDictionary[e]=new n9(t,i,r,a,n);}getVertexStream(e,t){let i=0,s=false;if(this._geometryData){let r=this._geometryData.vertexStreamDictionary[e];r&&(s=true,i=this._geometryData.vertexCount,ArrayBuffer.isView(t)?t.set(r.data):(t.length=0,t.push(r.data)));}return !s&&this.vertexBuffer&&(i=new ag(this.vertexBuffer).readData(e,t)),i}setPositions(e,t=n6.DEFAULT_COMPONENTS_POSITION,i){this.setVertexStream(e6,e,t,i,6,false);}setNormals(e,t=n6.DEFAULT_COMPONENTS_NORMAL,i){this.setVertexStream(e9,e,t,i,6,false);}setUvs(e,t,i=n6.DEFAULT_COMPONENTS_UV,s){this.setVertexStream(ts+e,t,i,s,6,false);}setColors(e,t=n6.DEFAULT_COMPONENTS_COLORS,i){this.setVertexStream(ti,e,t,i,6,false);}setColors32(e,t){this.setVertexStream(ti,e,n6.DEFAULT_COMPONENTS_COLORS,t,1,true);}setIndices(e,t){this._initGeometryData(),this._geometryData.indexStreamUpdated=true,this._geometryData.indices=e,this._geometryData.indexCount=t||e.length;}getPositions(e){return this.getVertexStream(e6,e)}getNormals(e){return this.getVertexStream(e9,e)}getUvs(e,t){return this.getVertexStream(ts+e,t)}getColors(e){return this.getVertexStream(ti,e)}getIndices(e){let t=0;if(this._geometryData&&this._geometryData.indices){let i=this._geometryData.indices;if(t=this._geometryData.indexCount,ArrayBuffer.isView(e))e.set(i);else {e.length=0;for(let t=0,s=i.length;t<s;t++)e.push(i[t]);}}else this.indexBuffer.length>0&&this.indexBuffer[0]&&(t=this.indexBuffer[0].readData(e));return t}update(e=4,t=true){if(this._geometryData){if(t){let e=this._geometryData.vertexStreamDictionary[e6];e&&3===e.componentCount&&(this._aabb.compute(e.data,this._geometryData.vertexCount),this._aabbVer++);}let i=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(i=true,this._geometryData.maxVertices=this._geometryData.vertexCount),i&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);let s=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(s=true,this._geometryData.maxIndices=this._geometryData.indexCount),s&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=e,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=true):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=false),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=false,this._geometryData.indexStreamUpdated=false,this._geometryData.recreate=false,this.updateRenderStates();}}_buildVertexFormat(e){let t=[];for(let e in this._geometryData.vertexStreamDictionary){let i=this._geometryData.vertexStreamDictionary[e];t.push({semantic:e,components:i.componentCount,type:i.dataType,normalize:i.dataTypeNormalize,asInt:i.asInt});}return new iO(this.device,t,e)}_updateVertexBuffer(){if(!this.vertexBuffer){let e=this._geometryData.maxVertices,t=this._buildVertexFormat(e);this.vertexBuffer=new iP(this.device,t,e,{usage:this._geometryData.verticesUsage,storage:this._storageVertex});}let e=new ag(this.vertexBuffer),t=this._geometryData.vertexCount;for(let i in this._geometryData.vertexStreamDictionary){let s=this._geometryData.vertexStreamDictionary[i];e.writeData(i,s.data,t),delete this._geometryData.vertexStreamDictionary[i];}e.end();}_updateIndexBuffer(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){let e=this._geometryData.maxVertices,t=this._storageIndex?{storage:true}:void 0;this.indexBuffer[0]=new ae(this.device,e>65535||0===e?2:1,this._geometryData.maxIndices,this._geometryData.indicesUsage,void 0,t);}let e=this._geometryData.indices;e&&(this.indexBuffer[0].writeData(e,this._geometryData.indexCount),this._geometryData.indices=null);}prepareRenderState(e){1===e?this.generateWireframe():2===e&&(this.primitive[2]={type:0,base:0,baseVertex:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:false});}updateRenderStates(){this.primitive[2]&&this.prepareRenderState(2),this.primitive[1]&&this.prepareRenderState(1);}generateWireframe(){let e,t;this._destroyIndexBuffer(1);let i=this.vertexBuffer.numVertices;if(this.indexBuffer.length>0&&this.indexBuffer[0]){let s=[[0,1],[1,2],[2,0]],r=this.primitive[0].base,a=this.primitive[0].count,n=this.primitive[0].baseVertex||0,o=this.indexBuffer[0],l=t1[o.format],h=new l(o.storage),c=new l(2*a),d=new Set,u=0;for(let e=r;e<r+a;e+=3)for(let t=0;t<3;t++){let r=h[e+s[t][0]]+n,a=h[e+s[t][1]]+n,o=r>a?a*i+r:r*i+a;d.has(o)||(d.add(o),c[u++]=r,c[u++]=a);}d.clear(),t=o.format,e=c.slice(0,u);}else {let s=i-i%3,r=s/3*6;t=r>65535?2:1,e=r>65535?new Uint32Array(r):new Uint16Array(r);let a=0;for(let t=0;t<s;t+=3)e[a++]=t,e[a++]=t+1,e[a++]=t+1,e[a++]=t+2,e[a++]=t+2,e[a++]=t;}let s=new ae(this.vertexBuffer.device,t,e.length,0,e.buffer);this.primitive[1]={type:1,base:0,baseVertex:0,count:e.length,indexed:true},this.indexBuffer[1]=s;}constructor(e,t){super(),this.indexBuffer=[null],this.vertexBuffer=null,this.primitive=[{type:0,base:0,baseVertex:0,count:0}],this.skin=null,this.boneAabb=null,this._aabbVer=0,this._aabb=new eC,this._geometryData=null,this._morph=null,this._storageIndex=false,this._storageVertex=false,this.id=n8++,this.device=e,this._storageIndex=t?.storageIndex||false,this._storageVertex=t?.storageVertex||false;}}let oe=new ii;function ot(e){return oe.get(e)}class oi{static incRef(e){this.cache.incRef(e);}static decRef(e){this.cache.decRef(e);}static destroy(){this.cache.destroy();}}oi.cache=new class{destroy(){this.cache.forEach((e,t)=>{t.destroy();}),this.cache.clear();}incRef(e){let t=(this.cache.get(e)||0)+1;this.cache.set(e,t);}decRef(e){if(e){let t=this.cache.get(e);t&&(0==--t?(this.cache.delete(e),e.destroy()):this.cache.set(e,t));}}constructor(){this.cache=new Map;}};class os{static get(){return this._counter++}}os._counter=0;let or=new eC,oa=new eC,on=new eD,oo=new Set,ol=new Uint32Array(4);class oh{destroy(){this._destroyVertexBuffer&&this.vertexBuffer?.destroy(),this.vertexBuffer=null;}constructor(e){this.vertexBuffer=null,this._destroyVertexBuffer=false,this.count=e;}}class oc{getBindGroup(e){if(!this.bindGroup){let t=this.shader.meshBindGroupFormat;this.bindGroup=new ig(e,t);}return this.bindGroup}getUniformBuffer(e){if(!this.uniformBuffer){let t=this.shader.meshUniformBufferFormat;this.uniformBuffer=new r_(e,t,false);}return this.uniformBuffer}destroy(){this.bindGroup?.destroy(),this.bindGroup=null,this.uniformBuffer?.destroy(),this.uniformBuffer=null;}constructor(){this.bindGroup=null,this.uniformBuffer=null;}}class od{set drawBucket(e){this._drawBucket=255&Math.floor(e),this.updateKey();}get drawBucket(){return this._drawBucket}set renderStyle(e){this._renderStyle=e,this.mesh.prepareRenderState(e);}get renderStyle(){return this._renderStyle}set mesh(e){e!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=e,e&&e.incRefCount());}get mesh(){return this._mesh}set aabb(e){this._aabb=e;}get aabb(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);let e=this._customAabb,t=!!e;if(!e){if(e=or,this.skinInstance){if(!this.mesh.boneAabb){let e=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(e);}let i=this.mesh.boneUsed,s=true;for(let t=0;t<this.mesh.boneAabb.length;t++)i[t]&&(oa.setFromTransformedAabb(this.mesh.boneAabb[t],this.skinInstance.matrices[t]),s?(s=false,e.center.copy(oa.center),e.halfExtents.copy(oa.halfExtents)):e.add(oa));t=true;}else if(this.node._aabbVer!==this._aabbVer||this.mesh._aabbVer!==this._aabbMeshVer){if(this.mesh?(e.center.copy(this.mesh.aabb.center),e.halfExtents.copy(this.mesh.aabb.halfExtents)):(e.center.set(0,0,0),e.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph){let t=this.mesh.morph.aabb;e._expand(t.getMin(),t.getMax());}t=true,this._aabbVer=this.node._aabbVer,this._aabbMeshVer=this.mesh._aabbVer;}}return t&&this._aabb.setFromTransformedAabb(e,this.node.getWorldTransform()),this._aabb}clearShaders(){this._shaderCache.forEach(e=>{e.destroy();}),this._shaderCache.clear();}getShaderInstance(e,t,i,s,r,a,n){let o=this._shaderDefs;ol[0]=e,ol[1]=t,ol[2]=o,ol[3]=s.hash;let l=iD(ol),h=this._shaderCache.get(l);if(!h){let t=this._material;if((h=new oc).shader=t.variants.get(l),h.hashes=new Uint32Array(ol),!h.shader){let c=t.getShaderVariant({device:this.mesh.device,scene:i,objDefs:o,cameraShaderParams:s,pass:e,sortedLights:n,viewUniformFormat:r,viewBindGroupFormat:a,vertexFormat:this.mesh.vertexBuffer?.format});t.variants.set(l,c),h.shader=c;}this._shaderCache.set(l,h);}return h}set material(e){this.clearShaders();let t=this._material;t&&t.removeMeshInstanceRef(this),this._material=e,e&&(e.addMeshInstanceRef(this),this.transparent=e.transparent,this.updateKey());}get material(){return this._material}_updateShaderDefs(e){e!==this._shaderDefs&&(this._shaderDefs=e,this.clearShaders());}set calculateSortDistance(e){this._calculateSortDistance=e;}get calculateSortDistance(){return this._calculateSortDistance}set receiveShadow(e){this._receiveShadow!==e&&(this._receiveShadow=e,this._updateShaderDefs(e?-2&this._shaderDefs:1|this._shaderDefs));}get receiveShadow(){return this._receiveShadow}set batching(e){this._updateShaderDefs(e?16384|this._shaderDefs:-16385&this._shaderDefs);}get batching(){return (16384&this._shaderDefs)!=0}set skinInstance(e){this._skinInstance=e,this._updateShaderDefs(e?2|this._shaderDefs:-3&this._shaderDefs),this._setupSkinUpdate();}get skinInstance(){return this._skinInstance}set morphInstance(e){this._morphInstance?.destroy(),this._morphInstance=e;let t=this._shaderDefs;t=e&&e.morph.morphPositions?1024|t:-1025&t,t=e&&e.morph.morphNormals?2048|t:-2049&t,t=e&&e.morph.intRenderFormat?8192|t:-8193&t,this._updateShaderDefs(t);}get morphInstance(){return this._morphInstance}set screenSpace(e){this._screenSpace!==e&&(this._screenSpace=e,this._updateShaderDefs(e?256|this._shaderDefs:-257&this._shaderDefs));}get screenSpace(){return this._screenSpace}set key(e){this._sortKeyForward=e;}get key(){return this._sortKeyForward}set mask(e){let t=65535&this._shaderDefs;this._updateShaderDefs(t|e<<16);}get mask(){return this._shaderDefs>>16}set instancingCount(e){this.instancingData&&(this.instancingData.count=e);}get instancingCount(){return this.instancingData?this.instancingData.count:0}destroy(){let e=this.mesh;e&&(this.mesh=null,e.refCount<1&&e.destroy()),this.setRealtimeLightmap(od.lightmapParamNames[0],null),this.setRealtimeLightmap(od.lightmapParamNames[1],null),this._skinInstance?.destroy(),this._skinInstance=null,this.morphInstance?.destroy(),this.morphInstance=null,this.clearShaders(),this.material=null,this.instancingData?.destroy(),this.destroyDrawCommands();}destroyDrawCommands(){if(this.drawCommands){for(let e of this.drawCommands.values())e?.destroy();this.drawCommands=null;}}static _prepareRenderStyleForArray(e,t){if(e){for(let i=0;i<e.length;i++){e[i]._renderStyle=t;let s=e[i].mesh;oo.has(s)||(oo.add(s),s.prepareRenderState(t));}oo.clear();}}_isVisible(e){return !!this.visible&&(this.isVisibleFunc?this.isVisibleFunc(e):(on.center=this.aabb.center,on.radius=this._aabb.halfExtents.length(),e.frustum.containsSphere(on)>0))}updateKey(){let{material:e}=this;this._sortKeyForward=this._drawBucket<<23|(e.alphaToCoverage||e.alphaTest?4194304:0)|4194303&e.id;}setInstancing(e,t=false){e?(this.instancingData=new oh(e.numVertices),this.instancingData.vertexBuffer=e,e.format.instancing=true,this.cull=t):(this.instancingData=null,this.cull=true),this._updateShaderDefs(e?32|this._shaderDefs:-33&this._shaderDefs);}setIndirect(e,t,i=1){let s=e?.camera??null;if(-1===t)this._deleteDrawCommandsKey(s);else {this.drawCommands??(this.drawCommands=new Map);let e=this.drawCommands.get(s)??new r9(this.mesh.device);e.slotIndex=t,e.update(i),this.drawCommands.set(s,e),this.mesh.device.mapsToClear.add(this.drawCommands);}}setMultiDraw(e,t=1){let i,s=e?.camera??null;if(0===t)this._deleteDrawCommandsKey(s);else {if(this.drawCommands??(this.drawCommands=new Map),!(i=this.drawCommands.get(s))){let e=this.mesh.indexBuffer?.[0],t=e?.format,r=void 0!==t?eW[t]:0;i=new r9(this.mesh.device,r),this.drawCommands.set(s,i);}i.allocate(t);}return i}_deleteDrawCommandsKey(e){let t=this.drawCommands;if(t){let i=t.get(e);i?.destroy(),t.delete(e),0===t.size&&this.destroyDrawCommands();}}getDrawCommands(e){let t=this.drawCommands;if(t)return t.get(e)??t.get(null)}getIndirectMetaData(){let e=this.mesh?.primitive[this.renderStyle],t=this.meshMetaData??(this.meshMetaData=new Int32Array(4));return t[0]=e.count,t[1]=e.base,t[2]=e.baseVertex,t}ensureMaterial(e){this.material||(this.material=ot(e));}clearParameters(){this.parameters={};}getParameters(){return this.parameters}getParameter(e){return this.parameters[e]}setParameter(e,t,i=0xffffffff){let s=this.parameters[e];s?(s.data=t,s.passFlags=i):this.parameters[e]={scopeId:null,data:t,passFlags:i};}setRealtimeLightmap(e,t){let i=this.getParameter(e);i!==t&&(i&&oi.decRef(i.data),t?(oi.incRef(t),this.setParameter(e,t)):this.deleteParameter(e));}deleteParameter(e){this.parameters[e]&&delete this.parameters[e];}setParameters(e,t){let i=this.parameters;for(let s in i){let r=i[s];r.passFlags&t&&(r.scopeId||(r.scopeId=e.scope.resolve(s)),r.scopeId.setValue(r.data));}}setLightmapped(e){e?this.mask=(2|this.mask)&-6:(this.setRealtimeLightmap(od.lightmapParamNames[0],null),this.setRealtimeLightmap(od.lightmapParamNames[1],null),this._shaderDefs&=-4289,this.mask=(1|this.mask)&-7);}setCustomAabb(e){e?this._customAabb?this._customAabb.copy(e):this._customAabb=e.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate();}_setupSkinUpdate(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb);}constructor(e,t,i=null){if(this.castShadow=false,this.shadowCascadeMask=255,this.cull=true,this.drawOrder=0,this._drawBucket=127,this.visible=true,this.visibleThisFrame=false,this.flipFacesFactor=1,this.gsplatInstance=null,this.id=os.get(),this.isVisibleFunc=null,this.instancingData=null,this.indirectData=null,this.drawCommands=null,this.meshMetaData=null,this.parameters={},this.pick=true,this.stencilFront=null,this.stencilBack=null,this.transparent=false,this._aabb=new eC,this._aabbVer=-1,this._aabbMeshVer=-1,this._customAabb=null,this._updateAabb=true,this._updateAabbFunc=null,this._sortKeyShadow=0,this._sortKeyForward=0,this._sortKeyDynamic=0,this._layer=15,this._material=null,this._skinInstance=null,this._morphInstance=null,this._receiveShadow=true,this._renderStyle=0,this._screenSpace=false,this._shaderCache=new Map,this._shaderDefs=65536,this._calculateSortDistance=null,this.node=i,this._mesh=e,e.incRefCount(),this.material=t,e.vertexBuffer){let t=e.vertexBuffer.format;this._shaderDefs|=4*!!t.hasUv0,this._shaderDefs|=8*!!t.hasUv1,this._shaderDefs|=16*!!t.hasColor,this._shaderDefs|=512*!!t.hasTangents;}this.updateKey();}}od.lightmapParamNames=["texture_lightMap","texture_dirLightMap"];let ou=[0,1,3,2,3,1],of=[0,1,3,0,3,2],op=new eu;function om(e,t){if(e&&!t||!e&&t)return  false;if((e=e.data)===(t=t.data))return  true;if(e instanceof Float32Array&&t instanceof Float32Array){if(e.length!==t.length)return  false;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return  false;return  true}return  false}function o_(e){return e.node.worldTransform.scaleSign}class og{destroy(){this.device=null,this.rootNode=null,this.scene=null,this._batchGroups={},this._batchList=[],this._dirtyGroups=[];}addGroup(e,t,i,s,r){if(void 0===s&&(s=this._batchGroupCounter,this._batchGroupCounter++),this._batchGroups[s])return;let a=new n2(s,e,t,i,r);return this._batchGroups[s]=a,a}removeGroup(e){if(!this._batchGroups[e])return;let t=[];for(let i=0;i<this._batchList.length;i++)this._batchList[i].batchGroupId===e?this.destroyBatch(this._batchList[i]):t.push(this._batchList[i]);this._batchList=t,this._removeModelsFromBatchGroup(this.rootNode,e),delete this._batchGroups[e];}markGroupDirty(e){0>this._dirtyGroups.indexOf(e)&&this._dirtyGroups.push(e);}getGroupByName(e){let t=this._batchGroups;for(let i in t)if(t.hasOwnProperty(i)&&t[i].name===e)return t[i];return null}getGroupById(e){return this._batchGroups[e]??null}getBatches(e){let t=[],i=this._batchList.length;for(let s=0;s<i;s++){let i=this._batchList[s];i.batchGroupId===e&&t.push(i);}return t}_removeModelsFromBatchGroup(e,t){if(e.enabled){e.model&&e.model.batchGroupId===t&&(e.model.batchGroupId=-1),e.render&&e.render.batchGroupId===t&&(e.render.batchGroupId=-1),e.element&&e.element.batchGroupId===t&&(e.element.batchGroupId=-1),e.sprite&&e.sprite.batchGroupId===t&&(e.sprite.batchGroupId=-1);for(let i=0;i<e._children.length;i++)this._removeModelsFromBatchGroup(e._children[i],t);}}insert(e,t,i){let s=this._batchGroups[t];s&&0>s._obj[e].indexOf(i)&&(s._obj[e].push(i),this.markGroupDirty(t));}remove(e,t,i){let s=this._batchGroups[t];if(s){let r=s._obj[e].indexOf(i);r>=0&&(s._obj[e].splice(r,1),this.markGroupDirty(t));}}_extractRender(e,t,i,s){return e.render&&(t=s[e.render.batchGroupId]=t.concat(e.render.meshInstances),e.render.removeFromLayers()),t}_extractModel(e,t,i,s){return e.model&&e.model.model&&(t=s[e.model.batchGroupId]=t.concat(e.model.meshInstances),e.model.removeModelFromLayers()),t}_extractElement(e,t,i){if(!e.element)return;let s=false;e.element._text&&e.element._text._model.meshInstances.length>0?(t.push(e.element._text._model.meshInstances[0]),e.element.removeModelFromLayers(e.element._text._model),s=true):e.element._image&&(t.push(e.element._image._renderable.meshInstance),e.element.removeModelFromLayers(e.element._image._renderable.model),e.element._image._renderable.unmaskMeshInstance&&(t.push(e.element._image._renderable.unmaskMeshInstance),e.element._image._renderable.unmaskMeshInstance.stencilFront&&e.element._image._renderable.unmaskMeshInstance.stencilBack||(e.element._dirtifyMask(),e.element._onPrerender())),s=true),s&&(i._ui=true);}_collectAndRemoveMeshInstances(e,t){for(let i=0;i<t.length;i++){let s=t[i],r=this._batchGroups[s];if(!r)continue;let a=e[s];a||(a=e[s]=[]);for(let t=0;t<r._obj.model.length;t++)a=this._extractModel(r._obj.model[t],a,r,e);for(let t=0;t<r._obj.render.length;t++)a=this._extractRender(r._obj.render[t],a,r,e);for(let e=0;e<r._obj.element.length;e++)this._extractElement(r._obj.element[e],a,r);for(let e=0;e<r._obj.sprite.length;e++){let t=r._obj.sprite[e];t.sprite&&t.sprite._meshInstance&&(r.dynamic||0===t.sprite.sprite._renderMode)&&(a.push(t.sprite._meshInstance),t.sprite.removeModelFromLayers(),r._sprite=true,t.sprite._batchGroup=r);}}}generate(e){let t,i,s,r,a={};e||(e=Object.keys(this._batchGroups));let n=[];for(let t=0;t<this._batchList.length;t++){if(0>e.indexOf(this._batchList[t].batchGroupId)){n.push(this._batchList[t]);continue}this.destroyBatch(this._batchList[t]);}if(this._batchList=n,this._collectAndRemoveMeshInstances(a,e),e===this._dirtyGroups)this._dirtyGroups.length=0;else {let t=[];for(let i=0;i<this._dirtyGroups.length;i++)0>e.indexOf(this._dirtyGroups[i])&&t.push(this._dirtyGroups[i]);this._dirtyGroups=t;}for(let e in a)if(a.hasOwnProperty(e)&&(t=a[e],s=this._batchGroups[e])){i=this.prepare(t,s.dynamic,s.maxAabbSize,s._ui||s._sprite);for(let t=0;t<i.length;t++)(r=this.create(i[t],s.dynamic,parseInt(e,10)))&&r.addToLayers(this.scene,s.layers);}}prepare(e,t,i=1/0,s){let r,a;if(0===e.length)return [];let n=.5*i,o=new eC,l=new eC,h=null,c=[],d=0;s&&e.sort((e,t)=>e.drawOrder-t.drawOrder);let u=e,f=s?function(e){h?h.add(e.aabb):h=e.aabb.clone(),a.push(e);}:function(e){a.push(e);};for(;u.length>0;){c[d]=[u[0]],a=[];let e=u[0].material,i=u[0].layer,p=u[0]._shaderDefs,m=u[0].parameters,_=u[0].stencilFront,g=u[0].mesh.vertexBuffer.getNumVertices(),v=u[0].drawOrder;o.copy(u[0].aabb);let S=o_(u[0]),y=u[0].mesh.vertexBuffer.format.batchingHash,x=u[0].mesh.primitive[0].indexed;h=null;for(let T=1;T<u.length;T++){let E=u[T];if(t&&c[d].length>=1024){a=a.concat(u.slice(T));break}if(e!==E.material||i!==E.layer||y!==E.mesh.vertexBuffer.format.batchingHash||x!==E.mesh.primitive[0].indexed||p!==E._shaderDefs||g+E.mesh.vertexBuffer.getNumVertices()>0xffffffff||(l.copy(o),l.add(E.aabb),l.halfExtents.x>n||l.halfExtents.y>n||l.halfExtents.z>n||_&&(!(r=E.stencilFront)||_.func!==r.func||_.zpass!==r.zpass)||S!==o_(E)||!function(e,t){for(let i in e)if(e.hasOwnProperty(i)&&!om(e[i],t[i]))return  false;for(let i in t)if(t.hasOwnProperty(i)&&!om(t[i],e[i]))return  false;return  true}(m,E.parameters)||s&&h&&h.intersects(E.aabb)&&E.drawOrder!==v)){f(E);continue}o.add(E.aabb),g+=E.mesh.vertexBuffer.getNumVertices(),c[d].push(E);}d++,u=a;}return c}collectBatchedMeshData(e,t){let i=null,s=0,r=0,a=null;for(let n=0;n<e.length;n++)if(e[n].visible){let o=e[n].mesh;if(s+=o.vertexBuffer.numVertices,o.primitive[0].indexed)r+=o.primitive[0].count;else {let e=o.primitive[0].type;(6===e||5===e)&&4===o.primitive[0].count&&(r+=6);}if(!i){a=e[n].material,i={};let s=o.vertexBuffer.format.elements;for(let e=0;e<s.length;e++)i[s[e].name]={numComponents:s[e].numComponents,dataType:s[e].dataType,normalize:s[e].normalize,count:0};t&&(i[tt]={numComponents:1,dataType:6,normalize:false,count:0});}}return {streams:i,batchNumVerts:s,batchNumIndices:r,material:a}}create(e,t,i){let s,r,a;this._init||(this.vertexFormats={},this._init=true);let n=null,o=null,l=this.collectBatchedMeshData(e,t);if(l.streams){let h,c,d,u,f,p=l.streams,m=l.material,_=l.batchNumVerts,g=l.batchNumIndices;o=new n1(e,t,i),this._batchList.push(o);let v=0,S=0,y=new(_<=65535?Uint16Array:Uint32Array)(g);for(s in p)(n=p[s]).typeArrayType=tJ[n.dataType],n.elementByteSize=t0[n.dataType],n.buffer=new n.typeArrayType(_*n.numComponents);for(let i=0;i<e.length;i++)if(e[i].visible){for(s in a=(r=e[i].mesh).vertexBuffer.numVertices,t||(f=e[i].node.getWorldTransform()),p)if(s!==tt){let e=new(n=p[s]).typeArrayType(n.buffer.buffer,n.elementByteSize*n.count),i=r.getVertexStream(s,e)*n.numComponents;if(n.count+=i,!t&&n.numComponents>=3){if(s===e6){let t,s,r,a=f.data,o=a[0],l=a[1],h=a[2],c=a[4],d=a[5],u=a[6],p=a[8],m=a[9],_=a[10],g=a[12],v=a[13],S=a[14];for(let a=0;a<i;a+=n.numComponents)t=e[a],s=e[a+1],r=e[a+2],e[a]=t*o+s*c+r*p+g,e[a+1]=t*l+s*d+r*m+v,e[a+2]=t*h+s*u+r*_+S;}else if(s===e9||s===e7){let t,s,r;op.invertMat4(f).transpose();let[a,o,l,h,c,d,u,p,m]=op.data;for(let f=0;f<i;f+=n.numComponents)t=e[f],s=e[f+1],r=e[f+2],e[f]=t*a+s*h+r*u,e[f+1]=t*o+s*c+r*p,e[f+2]=t*l+s*d+r*m;}}}if(t){n=p[tt];for(let e=0;e<a;e++)n.buffer[n.count++]=i;}if(r.primitive[0].indexed)h=r.primitive[0].base,c=r.primitive[0].baseVertex||0,d=r.primitive[0].count,u=new t1[r.indexBuffer[0].getFormat()](r.indexBuffer[0].storage);else {c=0;let e=r.primitive[0].type;if(6===e||5===e)if(4===r.primitive[0].count)h=0,d=6,u=6===e?ou:of;else {d=0;continue}}for(let e=0;e<d;e++)y[e+S]=u[h+e]+c+v;S+=d,v+=a;}for(s in r=new n7(this.device),p)n=p[s],r.setVertexStream(s,n.buffer,n.numComponents,void 0,n.dataType,n.normalize);y.length>0&&r.setIndices(y),r.update(4,false),t&&(m=m.clone()).update();let x=new od(r,m,this.rootNode);x.castShadow=o.origMeshInstances[0].castShadow,x.parameters=o.origMeshInstances[0].parameters,x.layer=o.origMeshInstances[0].layer,x._shaderDefs=o.origMeshInstances[0]._shaderDefs,x.batching=true,x.cull=o.origMeshInstances[0].cull;let T=this._batchGroups[i];if(T&&T._ui&&(x.cull=false),t){let e=[];for(let t=0;t<o.origMeshInstances.length;t++)e.push(o.origMeshInstances[t].node);x.skinInstance=new n5(this.device,e,this.rootNode);}x._updateAabb=false,x.drawOrder=o.origMeshInstances[0].drawOrder,x.stencilFront=o.origMeshInstances[0].stencilFront,x.stencilBack=o.origMeshInstances[0].stencilBack,x.flipFacesFactor=o_(o.origMeshInstances[0]),x.castShadow=o.origMeshInstances[0].castShadow,o.meshInstance=x,o.updateBoundingBox();}return o}updateAll(){this._dirtyGroups.length>0&&this.generate(this._dirtyGroups);for(let e=0;e<this._batchList.length;e++)this._batchList[e].dynamic&&this._batchList[e].updateBoundingBox();}clone(e,t){let i=new n1(t,e.dynamic,e.batchGroupId);this._batchList.push(i);let s=[];for(let e=0;e<t.length;e++)s.push(t[e].node);return i.meshInstance=new od(e.meshInstance.mesh,e.meshInstance.material,e.meshInstance.node),i.meshInstance._updateAabb=false,i.meshInstance.parameters=t[0].parameters,i.meshInstance.cull=t[0].cull,i.meshInstance.layer=t[0].layer,e.dynamic&&(i.meshInstance.skinInstance=new n5(this.device,s,this.rootNode)),i.meshInstance.castShadow=e.meshInstance.castShadow,i}destroyBatch(e){e.destroy(this.scene,this._batchGroups[e.batchGroupId].layers);}constructor(e,t,i){this.device=e,this.rootNode=t,this.scene=i,this._init=false,this._batchGroups={},this._batchGroupCounter=0,this._batchList=[],this._dirtyGroups=[];}}let ov="uSceneColorMap";class oS extends as{destroy(){super.destroy(),this.releaseRenderTarget(this.colorRenderTarget);}shouldReallocate(e,t,i){if(e?.colorBuffer.format!==i)return  true;let s=t?.width||this.device.width,r=t?.height||this.device.height;return !e||s!==e.width||r!==e.height}allocateRenderTarget(e,t,i,s){let r=new ih(i,{name:ov,format:s,width:t?t.colorBuffer.width:i.width,height:t?t.colorBuffer.height:i.height,mipmaps:true,minFilter:5,magFilter:1,addressU:1,addressV:1});return e?(e.destroyFrameBuffers(),e._colorBuffer=r,e._colorBuffers=[r],e.evaluateDimensions()):e=new iU({name:"ColorGrabRT",colorBuffer:r,depth:false,stencil:false,autoResolve:false}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy());}frameUpdate(){let e=this.device,t=this.source,i=t?.colorBuffer.format??this.device.backBufferFormat;this.shouldReallocate(this.colorRenderTarget,t?.colorBuffer,i)&&(this.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=this.allocateRenderTarget(this.colorRenderTarget,t,e,i));let s=this.colorRenderTarget.colorBuffer;e.scope.resolve(ov).setValue(s);}execute(){let e=this.device,t=this.source,i=this.colorRenderTarget.colorBuffer;e.isWebGPU?(e.copyRenderTarget(t,this.colorRenderTarget,true,false),e.mipmapRenderer.generate(this.colorRenderTarget.colorBuffer.impl)):(e.copyRenderTarget(t,this.colorRenderTarget,true,false),e.activeTexture(e.maxCombinedTextures-1),e.bindTexture(i),e.gl.generateMipmap(i.impl._glTarget));}constructor(...e){super(...e),this.colorRenderTarget=null,this.source=null;}}let oy="uSceneDepthMap";class ox extends as{destroy(){super.destroy(),this.releaseRenderTarget(this.depthRenderTarget);}shouldReallocate(e,t){let i=t?.width||this.device.width,s=t?.height||this.device.height;return !e||i!==e.width||s!==e.height}allocateRenderTarget(e,t,i,s,r){let a=new ih(i,{name:oy,format:s,width:t?t.colorBuffer.width:i.width,height:t?t.colorBuffer.height:i.height,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1});return e?(e.destroyFrameBuffers(),r?e._depthBuffer=a:(e._colorBuffer=a,e._colorBuffers=[a]),e.evaluateDimensions()):e=new iU({name:"DepthGrabRT",colorBuffer:r?null:a,depthBuffer:r?a:null,depth:!r,stencil:i.supportsStencil,autoResolve:false}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy());}before(){let e=this.camera,t=this.device,i=e?.renderTarget??t.backBuffer,s=true,r=i.stencil?17:16;t.isWebGPU&&i.samples>1&&(r=15,s=false);let a=e.renderTarget?.depthBuffer??e.renderTarget?.colorBuffer;this.shouldReallocate(this.depthRenderTarget,a)&&(this.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=this.allocateRenderTarget(this.depthRenderTarget,e.renderTarget,t,r,s));let n=s?this.depthRenderTarget.depthBuffer:this.depthRenderTarget.colorBuffer;t.scope.resolve(oy).setValue(n);}execute(){let e=this.device;if(e.isWebGL2&&e.renderTarget.samples>1){let t=e.renderTarget.impl._glFrameBuffer,i=this.depthRenderTarget;e.renderTarget=i,e.updateBegin(),this.depthRenderTarget.impl.internalResolve(e,t,i.impl._glFrameBuffer,this.depthRenderTarget,e.gl.DEPTH_BUFFER_BIT);}else e.copyRenderTarget(e.renderTarget,this.depthRenderTarget,false,true);}constructor(e,t){super(e),this.depthRenderTarget=null,this.camera=null,this.camera=t;}}class oT{get hash(){if(void 0===this._hash){let e=`${this.gammaCorrection}_${this.toneMapping}_${this.srgbRenderTarget}_${this.fog}_${this.ssaoEnabled}_${this.sceneDepthMapLinear}`;this._hash=iI(e);}return this._hash}get defines(){let e=this._defines;return this._definesDirty&&(this._definesDirty=false,e.clear(),this._sceneDepthMapLinear&&e.set("SCENE_DEPTHMAP_LINEAR",""),1===this.shaderOutputGamma&&e.set("SCENE_COLORMAP_GAMMA",""),e.set("FOG",this._fog.toUpperCase()),e.set("TONEMAP",nn[this._toneMapping]),e.set("GAMMA",na[this.shaderOutputGamma])),e}markDirty(){this._hash=void 0,this._definesDirty=true;}set fog(e){this._fog!==e&&(this._fog=e,this.markDirty());}get fog(){return this._fog}set ssaoEnabled(e){this._ssaoEnabled!==e&&(this._ssaoEnabled=e,this.markDirty());}get ssaoEnabled(){return this._ssaoEnabled}set gammaCorrection(e){this._gammaCorrectionAssigned=true,this._gammaCorrection!==e&&(this._gammaCorrection=e,this.markDirty());}get gammaCorrection(){return this._gammaCorrection}set toneMapping(e){this._toneMapping!==e&&(this._toneMapping=e,this.markDirty());}get toneMapping(){return this._toneMapping}set srgbRenderTarget(e){this._srgbRenderTarget!==e&&(this._srgbRenderTarget=e,this.markDirty());}get srgbRenderTarget(){return this._srgbRenderTarget}set sceneDepthMapLinear(e){this._sceneDepthMapLinear!==e&&(this._sceneDepthMapLinear=e,this.markDirty());}get sceneDepthMapLinear(){return this._sceneDepthMapLinear}get shaderOutputGamma(){return +(1===this._gammaCorrection&&!this._srgbRenderTarget)}constructor(){this._gammaCorrection=1,this._toneMapping=0,this._srgbRenderTarget=false,this._ssaoEnabled=false,this._fog=a6,this._sceneDepthMapLinear=false,this._defines=new Map,this._definesDirty=true;}}let oE=new ed,ow=new ed,ob=new ed,oA=new ey,oC=[new ed,new ed,new ed,new ed,new ed,new ed,new ed,new ed];class oP{destroy(){this.renderPassColorGrab?.destroy(),this.renderPassColorGrab=null,this.renderPassDepthGrab?.destroy(),this.renderPassDepthGrab=null,this.renderPasses.length=0;}_storeShaderMatrices(e,t,i,s){this._shaderMatricesVersion!==s&&(this._shaderMatricesVersion=s,this._viewProjPrevious.copy(this._viewProjCurrent??e),this._viewProjCurrent??(this._viewProjCurrent=new ey),this._viewProjCurrent.copy(e),this._viewProjInverse.invert(e),this._jitters[2]=this._jitters[0],this._jitters[3]=this._jitters[1],this._jitters[0]=t,this._jitters[1]=i);}get fullSizeClearRect(){let e=this._scissorRectClear?this.scissorRect:this._rect;return 0===e.x&&0===e.y&&1===e.z&&1===e.w}set aspectRatio(e){this._aspectRatio!==e&&(this._aspectRatio=e,this._projMatDirty=true);}get aspectRatio(){return this.xr?.active?this._xrProperties.aspectRatio:this._aspectRatio}set aspectRatioMode(e){this._aspectRatioMode!==e&&(this._aspectRatioMode=e,this._projMatDirty=true);}get aspectRatioMode(){return this._aspectRatioMode}set calculateProjection(e){this._calculateProjection=e,this._projMatDirty=true;}get calculateProjection(){return this._calculateProjection}set calculateTransform(e){this._calculateTransform=e;}get calculateTransform(){return this._calculateTransform}set clearColor(e){this._clearColor.copy(e);}get clearColor(){return this._clearColor}set clearColorBuffer(e){this._clearColorBuffer=e;}get clearColorBuffer(){return this._clearColorBuffer}set clearDepth(e){this._clearDepth=e;}get clearDepth(){return this._clearDepth}set clearDepthBuffer(e){this._clearDepthBuffer=e;}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencil(e){this._clearStencil=e;}get clearStencil(){return this._clearStencil}set clearStencilBuffer(e){this._clearStencilBuffer=e;}get clearStencilBuffer(){return this._clearStencilBuffer}set cullFaces(e){this._cullFaces=e;}get cullFaces(){return this._cullFaces}set farClip(e){this._farClip!==e&&(this._farClip=e,this._projMatDirty=true);}get farClip(){return this.xr?.active?this._xrProperties.farClip:this._farClip}set flipFaces(e){this._flipFaces=e;}get flipFaces(){return this._flipFaces}set fov(e){this._fov!==e&&(this._fov=e,this._projMatDirty=true);}get fov(){return this.xr?.active?this._xrProperties.fov:this._fov}set frustumCulling(e){this._frustumCulling=e;}get frustumCulling(){return this._frustumCulling}set horizontalFov(e){this._horizontalFov!==e&&(this._horizontalFov=e,this._projMatDirty=true);}get horizontalFov(){return this.xr?.active?this._xrProperties.horizontalFov:this._horizontalFov}set layers(e){this._layers=e.slice(0),this._layersSet=new Set(this._layers);}get layers(){return this._layers}get layersSet(){return this._layersSet}set nearClip(e){this._nearClip!==e&&(this._nearClip=e,this._projMatDirty=true);}get nearClip(){return this.xr?.active?this._xrProperties.nearClip:this._nearClip}set node(e){this._node=e;}get node(){return this._node}set orthoHeight(e){this._orthoHeight!==e&&(this._orthoHeight=e,this._projMatDirty=true);}get orthoHeight(){return this._orthoHeight}set projection(e){this._projection!==e&&(this._projection=e,this._projMatDirty=true);}get projection(){return this._projection}get projectionMatrix(){return this._evaluateProjectionMatrix(),this._projMat}set rect(e){this._rect.copy(e);}get rect(){return this._rect}set renderTarget(e){this._renderTarget=e;}get renderTarget(){return this._renderTarget}set scissorRect(e){this._scissorRect.copy(e);}get scissorRect(){return this._scissorRect}get viewMatrix(){if(this._viewMatDirty){let e=this._node.getWorldTransform();this._viewMat.copy(e).invert(),this._viewMatDirty=false;}return this._viewMat}set aperture(e){this._aperture=e;}get aperture(){return this._aperture}set sensitivity(e){this._sensitivity=e;}get sensitivity(){return this._sensitivity}set shutter(e){this._shutter=e;}get shutter(){return this._shutter}set xr(e){this._xr!==e&&(this._xr=e,this._projMatDirty=true);}get xr(){return this._xr}clone(){return new oP().copy(this)}copy(e){return this._aspectRatio=e._aspectRatio,this._farClip=e._farClip,this._fov=e._fov,this._horizontalFov=e._horizontalFov,this._nearClip=e._nearClip,this._xrProperties.aspectRatio=e._xrProperties.aspectRatio,this._xrProperties.farClip=e._xrProperties.farClip,this._xrProperties.fov=e._xrProperties.fov,this._xrProperties.horizontalFov=e._xrProperties.horizontalFov,this._xrProperties.nearClip=e._xrProperties.nearClip,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepth=e.clearDepth,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencil=e.clearStencil,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.flipFaces=e.flipFaces,this.frustumCulling=e.frustumCulling,this.layers=e.layers,this.orthoHeight=e.orthoHeight,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.aperture=e.aperture,this.shutter=e.shutter,this.sensitivity=e.sensitivity,this.shaderPassInfo=e.shaderPassInfo,this.jitter=e.jitter,this._projMatDirty=true,this}_enableRenderPassColorGrab(e,t){t?this.renderPassColorGrab||(this.renderPassColorGrab=new oS(e)):(this.renderPassColorGrab?.destroy(),this.renderPassColorGrab=null);}_enableRenderPassDepthGrab(e,t,i){i?this.renderPassDepthGrab||(this.renderPassDepthGrab=new ox(e,this)):(this.renderPassDepthGrab?.destroy(),this.renderPassDepthGrab=null);}_updateViewProjMat(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=false);}worldToScreen(e,t,i,s=new ed){this._updateViewProjMat(),this._viewProjMat.transformPoint(e,s);let r=this._viewProjMat.data,a=e.x*r[3]+e.y*r[7]+e.z*r[11]+ +r[15];s.x=(s.x/a+1)*.5,s.y=(1-s.y/a)*.5;let{x:n,y:o,z:l,w:h}=this._rect;return s.x=s.x*l*t+n*t,s.y=s.y*h*i+(1-o-h)*i,s}screenToWorld(e,t,i,s,r,a=new ed){let{x:n,y:o,z:l,w:h}=this._rect,c=this.farClip-this.nearClip;if(oE.set((e-n*s)/(l*s),1-(t-(1-o-h)*r)/(h*r),i/c),oE.mulScalar(2),oE.sub(ed.ONE),0===this._projection){ey._getPerspectiveHalfSize(ow,this.fov,this.aspectRatio,this.nearClip,this.horizontalFov),ow.x*=oE.x,ow.y*=oE.y;let e=this._node.getWorldTransform();ow.z=-this.nearClip,e.transformPoint(ow,ob);let t=this._node.getPosition();a.sub2(ob,t),a.normalize(),a.mulScalar(i),a.add(t);}else this._updateViewProjMat(),oA.copy(this._viewProjMat).invert(),oA.transformPoint(oE,a);return a}_evaluateProjectionMatrix(){if(this._projMatDirty){if(0===this._projection)this._projMat.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip,this.horizontalFov),this._projMatSkybox.copy(this._projMat);else {let e=this._orthoHeight,t=e*this.aspectRatio;this._projMat.setOrtho(-t,t,-e,e,this.nearClip,this.farClip),this._projMatSkybox.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip);}this._projMatDirty=false;}}getProjectionMatrixSkybox(){return this._evaluateProjectionMatrix(),this._projMatSkybox}getExposure(){return 1/(1.2*Math.pow(2,Math.log2(this._aperture*this._aperture/this._shutter*100/this._sensitivity)))}getScreenSize(e){if(0===this._projection){let t=this._node.getPosition().distance(e.center);return t<e.radius?1:Math.min(Math.tan(Math.asin(e.radius/t))/Math.tan(this.fov/2*ei.DEG_TO_RAD),1)}return ei.clamp(e.radius/this._orthoHeight,0,1)}getFrustumCorners(e=this.nearClip,t=this.farClip){let i,s,r=this.fov*ei.DEG_TO_RAD;return 0===this.projection?this.horizontalFov?s=(i=e*Math.tan(r/2))/this.aspectRatio:i=(s=e*Math.tan(r/2))*this.aspectRatio:i=(s=this._orthoHeight)*this.aspectRatio,oC[0].x=i,oC[0].y=-s,oC[0].z=-e,oC[1].x=i,oC[1].y=s,oC[1].z=-e,oC[2].x=-i,oC[2].y=s,oC[2].z=-e,oC[3].x=-i,oC[3].y=-s,oC[3].z=-e,0===this._projection&&(this.horizontalFov?s=(i=t*Math.tan(r/2))/this.aspectRatio:i=(s=t*Math.tan(r/2))*this.aspectRatio),oC[4].x=i,oC[4].y=-s,oC[4].z=-t,oC[5].x=i,oC[5].y=s,oC[5].z=-t,oC[6].x=-i,oC[6].y=s,oC[6].z=-t,oC[7].x=-i,oC[7].y=-s,oC[7].z=-t,oC}setXrProperties(e){Object.assign(this._xrProperties,e),this._projMatDirty=true;}fillShaderParams(e){let t=this._farClip;return e[0]=1/t,e[1]=t,e[2]=this._nearClip,e[3]=+(1===this._projection),e}constructor(){this.shaderPassInfo=null,this.renderPassColorGrab=null,this.renderPassDepthGrab=null,this.fogParams=null,this.shaderParams=new oT,this.renderPasses=[],this.jitter=0,this._aspectRatio=16/9,this._aspectRatioMode=0,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new es(.75,.75,.75,1),this._clearColorBuffer=true,this._clearDepth=1,this._clearDepthBuffer=true,this._clearStencil=0,this._clearStencilBuffer=true,this._cullFaces=true,this._farClip=1e3,this._flipFaces=false,this._fov=45,this._frustumCulling=true,this._horizontalFov=false,this._layers=[0,1,2,4,3],this._layersSet=new Set(this._layers),this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=0,this._rect=new ep(0,0,1,1),this._renderTarget=null,this._scissorRect=new ep(0,0,1,1),this._scissorRectClear=false,this._aperture=16,this._shutter=.001,this._sensitivity=1e3,this._projMat=new ey,this._projMatDirty=true,this._projMatSkybox=new ey,this._viewMat=new ey,this._viewMatDirty=true,this._viewProjMat=new ey,this._viewProjMatDirty=true,this._shaderMatricesVersion=0,this._viewProjInverse=new ey,this._viewProjCurrent=null,this._viewProjPrevious=new ey,this._jitters=[0,0,0,0],this.frustum=new eL,this._xr=null,this._xrProperties={horizontalFov:this._horizontalFov,fov:this._fov,aspectRatio:this._aspectRatio,farClip:this._farClip,nearClip:this._nearClip};}}let oI=new ey,oD=new ed,oR=new ex,oL=new ex,oM=new ed,oO=new ed,oF=new ey,oN=new ex,oB=new ed,ok=new ey,oU=new ex,oz=new ex,oV=new ey,oG=new ed,oH=new ed;function oW(e,t){return e instanceof Function?e:i=>{let s=i[e];return s instanceof Function&&(s=s()),s===t}}class oX extends X{get right(){return this._right||(this._right=new ed),this.getWorldTransform().getX(this._right).normalize()}get up(){return this._up||(this._up=new ed),this.getWorldTransform().getY(this._up).normalize()}get forward(){return this._forward||(this._forward=new ed),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}get normalMatrix(){let e=this._normalMatrix;return this._dirtyNormal&&(e.invertMat4(this.getWorldTransform()).transpose(),this._dirtyNormal=false),e}set enabled(e){this._enabled!==e&&(this._enabled=e,(e&&this._parent?.enabled||!e)&&this._notifyHierarchyStateChanged(this,e));}get enabled(){return this._enabled&&this._enabledInHierarchy}get parent(){return this._parent}get path(){let e=this._parent;if(!e)return "";let t=this.name;for(;e&&e._parent;)t=`${e.name}/${t}`,e=e._parent;return t}get root(){let e=this;for(;e._parent;)e=e._parent;return e}get children(){return this._children}get graphDepth(){return this._graphDepth}_notifyHierarchyStateChanged(e,t){e._onHierarchyStateChanged(t);let i=e._children;for(let e=0,s=i.length;e<s;e++)i[e]._enabled&&this._notifyHierarchyStateChanged(i[e],t);}_onHierarchyStateChanged(e){this._enabledInHierarchy=e,e&&!this._frozen&&this._unfreezeParentToRoot();}_cloneInternal(e){e.name=this.name;let t=this.tags._list;e.tags.clear();for(let i=0;i<t.length;i++)e.tags.add(t[i]);e.localPosition.copy(this.localPosition),e.localRotation.copy(this.localRotation),e.localScale.copy(this.localScale),e.localEulerAngles.copy(this.localEulerAngles),e.position.copy(this.position),e.rotation.copy(this.rotation),e.eulerAngles.copy(this.eulerAngles),e.localTransform.copy(this.localTransform),e._dirtyLocal=this._dirtyLocal,e.worldTransform.copy(this.worldTransform),e._dirtyWorld=this._dirtyWorld,e._dirtyNormal=this._dirtyNormal,e._aabbVer=this._aabbVer+1,e._enabled=this._enabled,e.scaleCompensation=this.scaleCompensation,e._enabledInHierarchy=false;}clone(){let e=new this.constructor;return this._cloneInternal(e),e}copy(e){return e._cloneInternal(this),this}destroy(){this.remove();let e=this._children;for(;e.length;){let t=e.pop();t._parent=null,t.destroy();}this.fire("destroy",this),this.off();}find(e,t){let i=[],s=oW(e,t);return this.forEach(e=>{s(e)&&i.push(e);}),i}findOne(e,t){return function e(t,i){if(i(t))return t;let s=t._children,r=s.length;for(let t=0;t<r;++t){let r=e(s[t],i);if(r)return r}return null}(this,oW(e,t))}findByTag(...e){let t=[],i=(s,r)=>{r&&s.tags.has(...e)&&t.push(s);for(let e=0;e<s._children.length;e++)i(s._children[e],true);};return i(this,false),t}findByName(e){return this.findOne("name",e)}findByPath(e){let t=Array.isArray(e)?e:e.split("/"),i=this;for(let e=0,s=t.length;e<s;++e)if(!(i=i.children.find(i=>i.name===t[e])))return null;return i}forEach(e,t){e.call(t,this);let i=this._children,s=i.length;for(let r=0;r<s;++r)i[r].forEach(e,t);}isDescendantOf(e){let t=this._parent;for(;t;){if(t===e)return  true;t=t._parent;}return  false}isAncestorOf(e){return e.isDescendantOf(this)}getEulerAngles(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles}getLocalEulerAngles(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles}getLocalPosition(){return this.localPosition}getLocalRotation(){return this.localRotation}getLocalScale(){return this.localScale}getLocalTransform(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=false),this.localTransform}getPosition(){return this.getWorldTransform().getTranslation(this.position),this.position}getRotation(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation}getScale(){return this._scale||(this._scale=new ed),this.getWorldTransform().getScale(this._scale)}getWorldTransform(){return (this._dirtyLocal||this._dirtyWorld)&&(this._parent&&this._parent.getWorldTransform(),this._sync()),this.worldTransform}get worldScaleSign(){return 0===this._worldScaleSign&&(this._worldScaleSign=this.getWorldTransform().scaleSign),this._worldScaleSign}remove(){this._parent?.removeChild(this);}reparent(e,t){this.remove(),e&&(t>=0?e.insertChild(this,t):e.addChild(this));}setLocalEulerAngles(e,t,i){this.localRotation.setFromEulerAngles(e,t,i),this._dirtyLocal||this._dirtifyLocal();}setLocalPosition(e,t,i){e instanceof ed?this.localPosition.copy(e):this.localPosition.set(e,t,i),this._dirtyLocal||this._dirtifyLocal();}setLocalRotation(e,t,i,s){e instanceof ex?this.localRotation.copy(e):this.localRotation.set(e,t,i,s),this._dirtyLocal||this._dirtifyLocal();}setLocalScale(e,t,i){e instanceof ed?this.localScale.copy(e):this.localScale.set(e,t,i),this._dirtyLocal||this._dirtifyLocal();}_dirtifyLocal(){!this._dirtyLocal&&(this._dirtyLocal=true,this._dirtyWorld||this._dirtifyWorld());}_unfreezeParentToRoot(){let e=this._parent;for(;e;)e._frozen=false,e=e._parent;}_dirtifyWorld(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal();}_dirtifyWorldInternal(){if(!this._dirtyWorld){this._frozen=false,this._dirtyWorld=true;for(let e=0;e<this._children.length;e++)this._children[e]._dirtyWorld||this._children[e]._dirtifyWorldInternal();}this._dirtyNormal=true,this._worldScaleSign=0,this._aabbVer++;}setPosition(e,t,i){e instanceof ed?oB.copy(e):oB.set(e,t,i),null===this._parent?this.localPosition.copy(oB):(ok.copy(this._parent.getWorldTransform()).invert(),ok.transformPoint(oB,this.localPosition)),this._dirtyLocal||this._dirtifyLocal();}setRotation(e,t,i,s){if(e instanceof ex?oU.copy(e):oU.set(e,t,i,s),null===this._parent)this.localRotation.copy(oU);else {let e=this._parent.getRotation();oz.copy(e).invert(),this.localRotation.copy(oz).mul(oU);}this._dirtyLocal||this._dirtifyLocal();}setPositionAndRotation(e,t){if(null===this._parent)this.localPosition.copy(e),this.localRotation.copy(t);else {let i=this._parent.getWorldTransform();ok.copy(i).invert(),ok.transformPoint(e,this.localPosition),this.localRotation.setFromMat4(ok).mul(t);}this._dirtyLocal||this._dirtifyLocal();}setEulerAngles(e,t,i){if(this.localRotation.setFromEulerAngles(e,t,i),null!==this._parent){let e=this._parent.getRotation();oz.copy(e).invert(),this.localRotation.mul2(oz,this.localRotation);}this._dirtyLocal||this._dirtifyLocal();}addChild(e){this._prepareInsertChild(e),this._children.push(e),this._onInsertChild(e);}addChildAndSaveTransform(e){let t=e.getPosition(),i=e.getRotation();this._prepareInsertChild(e),e.setPosition(oF.copy(this.worldTransform).invert().transformPoint(t)),e.setRotation(oN.copy(this.getRotation()).invert().mul(i)),this._children.push(e),this._onInsertChild(e);}insertChild(e,t){this._prepareInsertChild(e),this._children.splice(t,0,e),this._onInsertChild(e);}_prepareInsertChild(e){e.remove();}_fireOnHierarchy(e,t,i){this.fire(e,i);for(let e=0;e<this._children.length;e++)this._children[e]._fireOnHierarchy(t,t,i);}_onInsertChild(e){e._parent=this;let t=e._enabled&&this.enabled;e._enabledInHierarchy!==t&&(e._enabledInHierarchy=t,e._notifyHierarchyStateChanged(e,t)),e._updateGraphDepth(),e._dirtifyWorld(),this._frozen&&e._unfreezeParentToRoot(),e._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",e);}_updateGraphDepth(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(let e=0,t=this._children.length;e<t;e++)this._children[e]._updateGraphDepth();}removeChild(e){let t=this._children.indexOf(e);-1!==t&&(this._children.splice(t,1),e._parent=null,e._fireOnHierarchy("remove","removehierarchy",this),this.fire("childremove",e));}_sync(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=false),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){let e,t=this._parent,i=this.localScale,s=t;if(s){for(;s&&s.scaleCompensation;)s=s._parent;s&&(s=s._parent)&&(e=s.worldTransform.getScale(),oM.mul2(e,this.localScale),i=oM);}oL.setFromMat4(t.worldTransform),oR.mul2(oL,this.localRotation);let r=t.worldTransform;t.scaleCompensation&&(oO.mul2(e,t.getLocalScale()),oI.setTRS(t.worldTransform.getTranslation(oD),oL,oO),r=oI),r.transformPoint(this.localPosition,oD),this.worldTransform.setTRS(oD,oR,i);}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=false;}}syncHierarchy(){if(!this._enabled||this._frozen)return;this._frozen=true,(this._dirtyLocal||this._dirtyWorld)&&this._sync();let e=this._children;for(let t=0,i=e.length;t<i;t++)e[t].syncHierarchy();}lookAt(e,t,i,s=0,r=1,a=0){if(e instanceof ed)oG.copy(e),t instanceof ed?oH.copy(t):oH.copy(ed.UP);else {if(void 0===i)return;oG.set(e,t,i),oH.set(s,r,a);}oV.setLookAt(this.getPosition(),oG,oH),oU.setFromMat4(oV),this.setRotation(oU);}translate(e,t,i){e instanceof ed?oB.copy(e):oB.set(e,t,i),oB.add(this.getPosition()),this.setPosition(oB);}translateLocal(e,t,i){e instanceof ed?oB.copy(e):oB.set(e,t,i),this.localRotation.transformVector(oB,oB),this.localPosition.add(oB),this._dirtyLocal||this._dirtifyLocal();}rotate(e,t,i){if(oU.setFromEulerAngles(e,t,i),null===this._parent)this.localRotation.mul2(oU,this.localRotation);else {let e=this.getRotation(),t=this._parent.getRotation();oz.copy(t).invert(),oU.mul2(oz,oU),this.localRotation.mul2(oU,e);}this._dirtyLocal||this._dirtifyLocal();}rotateLocal(e,t,i){oU.setFromEulerAngles(e,t,i),this.localRotation.mul(oU),this._dirtyLocal||this._dirtifyLocal();}constructor(e="Untitled"){super(),this.tags=new Z(this),this.localPosition=new ed,this.localRotation=new ex,this.localScale=new ed(1,1,1),this.localEulerAngles=new ed,this.position=new ed,this.rotation=new ex,this.eulerAngles=new ed,this._scale=null,this.localTransform=new ey,this._dirtyLocal=false,this._aabbVer=0,this._frozen=false,this.worldTransform=new ey,this._dirtyWorld=false,this._worldScaleSign=0,this._normalMatrix=new eu,this._dirtyNormal=true,this._right=null,this._up=null,this._forward=null,this._parent=null,this._children=[],this._graphDepth=0,this._enabled=true,this._enabledInHierarchy=false,this.scaleCompensation=false,this.name=e;}}let oY=new ey,oq=new ey,o$=new ey;class oj{static create(e,t,i){let s=new oP;switch(s.node=new oX(e),s.aspectRatio=1,s.aspectRatioMode=1,s._scissorRectClear=true,t){case 1:s.node.setRotation(oj.pointLightRotations[i]),s.fov=90,s.projection=0;break;case 2:s.projection=0;break;case 0:s.projection=1;}return s}static evalSpotCookieMatrix(e){let t=oj._spotCookieCamera;t||(t=oj.create("SpotCookieCamera",2),oj._spotCookieCamera=t),t.fov=2*e._outerConeAngle;let i=t._node;i.setPosition(e._node.getPosition()),i.setRotation(e._node.getRotation()),i.rotateLocal(-90,0,0),oY.setTRS(i.getPosition(),i.getRotation(),ed.ONE).invert(),oq.mul2(t.projectionMatrix,oY);let s=e.cookieMatrix,r=e.atlasViewport;return o$.setViewport(r.x,r.y,r.z,r.w),s.mul2(o$,oq),s}}oj.pointLightRotations=[new ex().setFromEulerAngles(0,90,180),new ex().setFromEulerAngles(0,-90,180),new ex().setFromEulerAngles(90,0,0),new ex().setFromEulerAngles(-90,0,0),new ex().setFromEulerAngles(0,180,180),new ex().setFromEulerAngles(0,0,180)],oj._spotCookieCamera=null;let oK=new ed,oZ=new Float32Array(6),oQ=new ed(-0.5,0,0),oJ=new ed(0,0,.5),o0={POSITION_RANGE:0,DIRECTION_FLAGS:1,COLOR_ANGLES_BIAS:2,PROJ_MAT_0:3,ATLAS_VIEWPORT:3,PROJ_MAT_1:4,PROJ_MAT_2:5,PROJ_MAT_3:6,AREA_DATA_WIDTH:7,AREA_DATA_HEIGHT:8,COUNT:9},o1=(e,t)=>Object.keys(e).map(i=>`#define {${t}${i}} ${e[i]}`).join("\n"),o2=`

		${o1(o0,"CLUSTER_TEXTURE_")}
		${o1({LIGHTSHAPE_PUNCTUAL:"0u",LIGHTSHAPE_RECT:"1u",LIGHTSHAPE_DISK:"2u",LIGHTSHAPE_SPHERE:"3u",LIGHT_COLOR_DIVIDER:"100.0"},"")}
`;class o3{destroy(){this.lightsTexture?.destroy(),this.lightsTexture=null;}createTexture(e,t,i,s,r){return new ih(e,{name:r,width:t,height:i,mipmaps:false,format:s,addressU:1,addressV:1,type:tP,magFilter:0,minFilter:0,anisotropy:1})}setBounds(e,t){this.boundsMin.copy(e),this.boundsDelta.copy(t);}uploadTextures(){this.lightsTexture.lock().set(this.lightsFloat),this.lightsTexture.unlock();}updateUniforms(){this._lightsTextureId.setValue(this.lightsTexture);}getSpotDirection(e,t){t._node.getWorldTransform().getY(e).mulScalar(-1),e.normalize();}getLightAreaSizes(e){let t=e._node.getWorldTransform();return t.transformVector(oQ,oK),oZ[0]=oK.x,oZ[1]=oK.y,oZ[2]=oK.z,t.transformVector(oJ,oK),oZ[3]=oK.x,oZ[4]=oK.y,oZ[5]=oK.z,oZ}addLightData(e,t){let i=2===e._type,s=e.atlasViewportAllocated,r=this.cookiesEnabled&&!!e._cookie&&s,a=this.areaLightsEnabled&&0!==e.shape,n=this.shadowsEnabled&&e.castShadows&&s,o=e._node.getPosition(),l=null,h=null;i?n?l=e.getRenderData(null,0).shadowMatrix:r&&(l=oj.evalSpotCookieMatrix(e)):(n||r)&&(h=e.atlasViewport);let c=this.lightsFloat,d=this.lightsUint,u=t*this.lightsTexture.width*4;c[u+4*o0.POSITION_RANGE+0]=o.x,c[u+4*o0.POSITION_RANGE+1]=o.y,c[u+4*o0.POSITION_RANGE+2]=o.z,c[u+4*o0.POSITION_RANGE+3]=e.attenuationEnd;let f=e.clusteredData;if(d[u+4*o0.COLOR_ANGLES_BIAS+0]=f[0],d[u+4*o0.COLOR_ANGLES_BIAS+1]=f[1],d[u+4*o0.COLOR_ANGLES_BIAS+2]=f[2],e.castShadows){let t=e.getRenderData(null,0),i=e._getUniformBiasValues(t),s=eh.float2Half(i.bias),r=eh.float2Half(i.normalBias);d[u+4*o0.COLOR_ANGLES_BIAS+3]=s|r<<16;}if(i&&(this.getSpotDirection(oK,e),c[u+4*o0.DIRECTION_FLAGS+0]=oK.x,c[u+4*o0.DIRECTION_FLAGS+1]=oK.y,c[u+4*o0.DIRECTION_FLAGS+2]=oK.z),d[u+4*o0.DIRECTION_FLAGS+3]=e.getClusteredFlags(n,r),l){let e=l.data;for(let t=0;t<16;t++)c[u+4*o0.PROJ_MAT_0+t]=e[t];}if(h&&(c[u+4*o0.ATLAS_VIEWPORT+0]=h.x,c[u+4*o0.ATLAS_VIEWPORT+1]=h.y,c[u+4*o0.ATLAS_VIEWPORT+2]=h.z/3),a){let t=this.getLightAreaSizes(e);c[u+4*o0.AREA_DATA_WIDTH+0]=t[0],c[u+4*o0.AREA_DATA_WIDTH+1]=t[1],c[u+4*o0.AREA_DATA_WIDTH+2]=t[2],c[u+4*o0.AREA_DATA_HEIGHT+0]=t[3],c[u+4*o0.AREA_DATA_HEIGHT+1]=t[4],c[u+4*o0.AREA_DATA_HEIGHT+2]=t[5];}}constructor(e){this.areaLightsEnabled=false,this.device=e,nH.get(e,tz).set("lightBufferDefinesPS",o2),nH.get(e,tV).set("lightBufferDefinesPS",o2),this.cookiesEnabled=false,this.shadowsEnabled=false,this.areaLightsEnabled=false,this.maxLights=255;let t=o0.COUNT;this.lightsFloat=new Float32Array(4*t*this.maxLights),this.lightsUint=new Uint32Array(this.lightsFloat.buffer),this.lightsTexture=this.createTexture(this.device,t,this.maxLights,14,"LightsTexture"),this._lightsTextureId=this.device.scope.resolve("lightsTexture"),this.invMaxColorValue=0,this.invMaxAttenuation=0,this.boundsMin=new ed,this.boundsDelta=new ed;}}let o4=new ed,o5=new ed,o8=new ed,o6=new eC;class o9{constructor(){this.light=null,this.min=new ed,this.max=new ed;}}class o7{set maxCellLightCount(e){e!==this._maxCellLightCount&&(this._maxCellLightCount=e,this._cellsDirty=true);}get maxCellLightCount(){return this._maxCellLightCount}set cells(e){o4.copy(e).floor(),this._cells.equals(o4)||(this._cells.copy(o4),this._cellsLimit.copy(o4).sub(ed.ONE),this._cellsDirty=true);}get cells(){return this._cells}destroy(){this.lightsBuffer.destroy(),this.releaseClusterTexture();}releaseClusterTexture(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null);}registerUniforms(e){this._numClusteredLightsId=e.scope.resolve("numClusteredLights"),this._clusterMaxCellsId=e.scope.resolve("clusterMaxCells"),this._clusterWorldTextureId=e.scope.resolve("clusterWorldTexture"),this._clusterBoundsMinId=e.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=e.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=e.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=e.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Int32Array(3),this._clusterCellsMaxId=e.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Int32Array(3),this._clusterTextureWidthId=e.scope.resolve("clusterTextureWidth");}updateParams(e){e&&(this.cells=e.cells,this.maxCellLightCount=e.maxLightsPerCell,this.lightsBuffer.cookiesEnabled=e.cookiesEnabled,this.lightsBuffer.shadowsEnabled=e.shadowsEnabled,this.lightsBuffer.areaLightsEnabled=e.areaLightsEnabled);}updateCells(){if(this._cellsDirty){this._cellsDirty=false;let e=this._cells.x,t=this._cells.y,i=this._cells.z,s=e*t*i,r=this.maxCellLightCount*s,a=Math.ceil(Math.sqrt(r)),n=Math.ceil(r/(a=ei.roundUp(a,this.maxCellLightCount)));this._clusterCellsMaxData[0]=e,this._clusterCellsMaxData[1]=t,this._clusterCellsMaxData[2]=i,this._clusterCellsDotData[0]=this.maxCellLightCount,this._clusterCellsDotData[1]=e*i*this.maxCellLightCount,this._clusterCellsDotData[2]=e*this.maxCellLightCount,this.clusters=new Uint8ClampedArray(r),this.counts=new Int32Array(s),this.releaseClusterTexture(),this.clusterTexture=this.lightsBuffer.createTexture(this.device,a,n,33,"ClusterTexture");}}uploadTextures(){this.clusterTexture.lock().set(this.clusters),this.clusterTexture.unlock(),this.lightsBuffer.uploadTextures();}updateUniforms(){this._numClusteredLightsId.setValue(this._usedLights.length),this.lightsBuffer.updateUniforms(),this._clusterWorldTextureId.setValue(this.clusterTexture),this._clusterMaxCellsId.setValue(this.maxCellLightCount);let e=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/e.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/e.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/e.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=e.x,this._clusterBoundsDeltaData[1]=e.y,this._clusterBoundsDeltaData[2]=e.z,this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData),this._clusterTextureWidthId.setValue(this.clusterTexture.width);}evalLightCellMinMax(e,t,i){t.copy(e.min),t.sub(this.boundsMin),t.div(this.boundsDelta),t.mul2(t,this.cells),t.floor(),i.copy(e.max),i.sub(this.boundsMin),i.div(this.boundsDelta),i.mul2(i,this.cells),i.ceil(),t.max(ed.ZERO),i.min(this._cellsLimit);}collectLights(e){let t=this.lightsBuffer.maxLights,i=this._usedLights,s=1;e.forEach(e=>{let r=!!(3&e.mask),a=2===e.type&&0===e._outerConeAngle;if(e.enabled&&0!==e.type&&e.visibleThisFrame&&e.intensity>0&&r&&!a&&s<t){let t;s<i.length?t=i[s]:(t=new o9,i.push(t)),t.light=e,e.getBoundingBox(o6),t.min.copy(o6.getMin()),t.max.copy(o6.getMax()),s++;}}),i.length=s;}evaluateBounds(){let e=this._usedLights,t=this.boundsMin,i=this.boundsMax;if(e.length>1){t.copy(e[1].min),i.copy(e[1].max);for(let s=2;s<e.length;s++)t.min(e[s].min),i.max(e[s].max);}else t.set(0,0,0),i.set(1,1,1);this.boundsDelta.sub2(i,t),this.lightsBuffer.setBounds(t,this.boundsDelta);}updateClusters(e){this.counts.fill(0),this.clusters.fill(0),this.lightsBuffer.areaLightsEnabled=!!e&&e.areaLightsEnabled;let t=this._cells.x,i=this._cells.z,s=this.counts,r=this._maxCellLightCount,a=this.clusters,n=this.maxCellLightCount,o=this._usedLights;for(let e=1;e<o.length;e++){let l=o[e],h=l.light;this.lightsBuffer.addLightData(h,e),this.evalLightCellMinMax(l,o5,o8);let c=o5.x,d=o8.x,u=o5.y,f=o8.y,p=o5.z,m=o8.z;for(let o=c;o<=d;o++)for(let l=p;l<=m;l++)for(let h=u;h<=f;h++){let c=o+t*(l+h*i),d=s[c];d<r&&(a[n*c+d]=e,s[c]=d+1);}}}update(e,t=null){this.updateParams(t),this.updateCells(),this.collectLights(e),this.evaluateBounds(),this.updateClusters(t),this.uploadTextures();}activate(){this.updateUniforms();}constructor(e){this.device=e,this.name="Untitled",this.reportCount=0,this.boundsMin=new ed,this.boundsMax=new ed,this.boundsDelta=new ed,this._cells=new ed(1,1,1),this._cellsLimit=new ed,this.cells=this._cells,this.maxCellLightCount=4,this._usedLights=[],this._usedLights.push(new o9),this.lightsBuffer=new o3(e),this.registerUniforms(e);}}let le=null,lt=()=>{if(!le){let e=atob("muPIHORMLNDCz4DxVR/ZvYfAUVEFR47KRIC4nwAAAAAP7WxlhD6Ci+2HCe7BF8jRAPZwdH2UPpI5PdLCJdkvG4UTaNDJ/0crAzne71GCrb4kbdMjjCEGzdX6fNxDMLJq5xkeoIVTdfiZkodEeArmZmp/FQzFjD4x8iOW7Dg64n+3mWqyEwLxXT8zoJXfbw8QJKDCaarUYyTlMzNFHbgUe9IQV7g4YOgtSKpIFZJ0qERm7u4PpmiF89ktHWCywaGmD6h+hfh2/Zd8KYlKqqo4Cem4T42bT/Z9FpCQF1hhSjfBzZ5XFn/y3jegWC6u86KuELRundQS/1Rp+XuKKGIgRv3CvP5y749yqLlFO495JOT3+f2CXgd71npU0/KjjpkZucbJ5m78IVyuSrSozc9jgBUhDrz0hFsyb7LFUH9//wJbBgLdNWJZObfKxrNt8TliLA9w9sXFv6g26iXpf6r/BqcAusj/QzGBZuoUGeEtw8BCXCZ3jUiw4hvM18ZVqlUD3C40LAFXW6FRjuAZGRNstb0/qVk4skwyT+MHrvRorI4rKHVMWZmKyAkzL/78u/9pMQuX14pZN50b2PHn6fRxeaCQLsfT4dpvIkWWFuFVENZIh+8xgR6lU+85W0PPdAu1j99kcCG40JBQa4JMyRzq6qriOBLtqF87vpCJan0WEduVr/mOYkS00urVA0mA6M3031+GmGmW48PaJDYOEIb3bIXWPaLoAOEinX1TN3+/vwhG6nqJu0TdHpedS7QsGZIoxH3nQYYjQP1jmbahlbNngw5ogsGk1y50XZyUmQBY+/JBJ3Unu4dApm+WmPwHPU9gLb+4mHh4BiY6M86pq+WeTyWdI3s0CXPEtHGXZ8zMZgUoyRomBi1VdazzuN+WOmQ9Pa0Z0tlNopUi8AJ4x2Xn4mmOKEbXLxlbVsWu8XhuDGYFOGCRVdSqDPXrHU5SDdUlti3k5///SBwzTMwK3L4a1H7w4lnpEas6////AfX8asyIBfeFXVJ3tgvxQ/blZuUKyIODIfr/UzdWNu7pciLBpdZRZ4pIfZ1R6szq+XNxkGG///8EZFpu7VHAhFWqHEOrB9unw+YQa5o8/9IR/V5/zq+986rJSyfgJKt2u9hxU1wzyQWPjJGvzG9+eWWxGFOHVKqI4jBQALwZZswesnvZ2UmmkEXdiRpz8B+oWE7PY70ZTMndisYSXg2TqoI+3y9BxbnY2Y4EfbdcRhAvG59NqDENNYbxKvK5HJfPG5M+Wi2AcpLVJrD6caiEOzgSoVNSgQK8fm2M3zGcF4xtClv/8Hs9oD7C3jitTATYNQxmKqKf1LhIxzf1bmfiNn7UKFmcJu4sLqVLwxGSue3taBEyknkw5hXTsUCvqmmL/f8n/w0giR7Hu/9EHvpkz3yuu64TioMkzdTJ30i0+hFnQqW1+v9mMwq+z9qGX0UFu9MomvVG2xod6vc12AAAAACq7sGa5qptFR0jF3nQt/D+7PibKYahaxP3hEixPbGi9nwNf2LAa7LkEZRKxzXeCD64Xpii5n+8Kpg8eHIv7AWXZltgMoGltmoJ0XGdOCL8WkzphvR9N2o3ARSZ42l5e5Pe4B58MCRlP3EKv+mcloknH+fto5BWsmEutW6KvjOVsznFCktkSczVk4aGvj9VXlRcLeDoKG8RkBgdcNG2bf8HUL4MT2DM+ar7NImJhKpxakX4Vk0CnP+/XNhl5UsP0lXgeZXPoDBMSW5An+DXlTCO5FQGwSPYwHLKYVIimEdAoVe49rQLaaNcye5LxU2/c5TijTgJtD5eQQIe1snxauj5jZsxJBUJdoP/zqpjqv8qBruoPsVsP8N44PCUW5Dd0DzqjSS/Dl5mI9cn1w2ndN/0KAEm1QAAAACwu6KM/083IBbH5bPa/9oHUwcU8I9v3j6/v18QYammrf+P6VL///8BrpuM3fOLCxaLNOFNF1zPbPYTP65ni6njft4eVcyrVXRQFrs52tr35StiSp55edVDCBC0H5rIfac6nzUwxQSt7y15QoKb+5zebEQUmVbrPjXuUa19Ey7sqXMiSUKHaw72PJKDdrutJoQr3u6lEYJ8K0MakWKj9zjTFi4X94TsKYco0GrLeB60M6D8M/80rhXUW8iMequg8y5F838WI0+gp3GBN5Kj/xIOxTWQuUaPV/LwvARr1VH93BFgGZR1MFW0Ua30GbYmdnAgo9VWy8SQtpDUgGE2r2zq2eTEMCL7sMKmE1hchVhuF/TCq9iXKEm86kzOf3Rp9ZnCxbpDUj+FKNxVyXe6pVZkRXv/m95SnB/EB8aME29N85MtAcDoXWlor8De2Q5Dg1tar+8wgiZufbMam81j//ASUohoR/zSh2KG4bvT6mkIPz6C5/98DC3LaWlaEZ1zA5JORZRu6J/a0GY285sEYzw71YqOT1ihAG0z5SDt1xNiDQWZdFpndArp6xWhqSDkRb4kSJEHb9liPvw7uLV/6i5MVf//A9Qjr8xkAEUh+KDI+zdtJ68d6MBOktg1iyp/SCq8O9f5pbamn1VVVQPRTWqNBvhQKa07s6P0lc9Luu/3gw4HeyOUfz8MxMwV4UQhua+t9cr4bz/nIB2wnDSK1K7I94M+s6C84htaX/CNlMQUSs2KJO+yaebfTbkNX5yWcqEJevo0vbKUiETuFXiL019A3E+lmsyZMwXrXLLiQAZ5t9+jI3JobhJTMiDH5ZOQ+8Jau5555NMjHSscP9qCVaa40doh+1a3Ukf6jqBmLddgh79/fwTfCyqiuldNkUoy+nUp+4nerwg0OjtGv2x485PJOJvUEokNhYIdWjpx7BWk0VZGWOp3jSFTJ2bnu6KCduZtG/UcBC9RZ3W/jMSfSMw4Etr/DoD/XYP2V5Ovw+YoM3F5g2dGLdvuG6ZkVGLE6Dk5Zr+sdSyGliJP1y2OFf/KFO0RWO+3gsGhesTnfZVpTd8/HwgO216gwaqo+vY3TljfJWowY+i0p0Os4SLn/1wLqDHMlszggmT/D8MRFzs+pLv6LNJSsNZ/r41mWi/rF6ZcKp/yzJdK0VU44hskq3RGpgO6mIpJDsf/mZkFrz0yYOMLbuaj/wp1v7JMFM5eqvBhmTd7U8frQAtHtys4zgpjZmzUhOVTfNNLifElGXADlqHGKrkBT/nYwX8ZRm3RjvyPvjKyEqEGKUpVnvOGx+NKPHiWM//ZDpDVGvvrjmk8RPF/wiYZD3+Us8YCXjrVOfjdd1UPAfjLp8jgSn4me7DPTpz1Ggy9XL80guFO7ECT10AvILKfD18Qx+KY/f8aRqu0oOO8hfKRFZa9PUJwCsp6VdZz6LFkm2b9Pl2LIifCwzRy7TpdG2uAtOxP2OemY26bJMa9ZGSLIRlMsgpDpnDJwd0oa5pQ13x1hrHf52HpulUWonGWsfXZbSQYKu9bnEN76ciQih0opN3deDVrbrxorfVlnCmL1R9zq3ePGWIv21c7pW8kEiFTM5JX8dAw867s/60cf79/BH+MDFCZBHlz1L+qGOJf/1txhhmrf3//As+RIJwevDb+fgNXVeHw67QptZegayhrEwr5Gy+EPo1RLaMtPbqOZYoVzXzwzjMFWZxyUG9YUIf6////AQWy84iAygLk9COtXt92+0mT/xg0zMzMBeLkb8y9SL2TDXgSX422hDgpGNLJyuPioA+YJ91G8znrpNqHkwYyscaJDEc9Vc+j4cXle3hvcd2JqDQH2lBZxDn6mUTs0b75raMvbs727codX01Anj8f3wir9P2xQaQ22v/TxCMglKDFoTjaP01XTLgxnTvPv02JgEUrW6UDgOnobFpLdvKdlypgIzPcq14fgXU5tvVW0FEs7VRlsG1IyA69fN4n+awHhT34cE+xUvdj86C8LgAsFheTjI9Ht9EyYAAAAAAVBVKRx2wLgUTI0/2QfyJo2riRw3JDqzEShmx/Lifo6mRkQVbS7X53t+EvKxcXogtdts31e9MRHdcHgsA8rt4/mt2unlzQ/wsU8Gu7+W6Oj7eD8EQdDp5XlCsVaS/AV/t5ZpPOHR3rGpyAJe9IPV+xMrBL1Oz/8MQhFs31h0N1cVnq371uqIJYHyafKH1jteAK3VpMXBcuC+yt0ZeKyRUY4QhdrJJ4tJ1wg3Hu6kDsbovxupTMkGdRrm8oZSoYPbJ+PwH/xotgTdkA1205vUEfnqkI04T/fnnd1fiZW5AwNcggd7fi4j5zasmcntZexIxqFZQMzMJpfndmI5jn17cgn5EV5t9XN0C///8Q9wlJpMGXdoiaMTG2sVyHQsn8mWRISCLNG777S0OuDRP2GlLcJ2UeOg7Fo8hTNPeJ//iTJhyqxhKRUntdXOihq2wfKfH///8B0GGrwT+fSOQRdctKxjjGCSS11d6BlQ9BDfE0J6Z25FaNTKGpFKNCMr2G/041KpWwBLVe1k08vncseQbKZdXi8x1t9XA45U/Wd43D9wAh3Tal0aiLVzGPusOZ1F+W3TWoqlX/A95+dNef11TsuGful+ctGssldk3fqpfqh+43XTxL42+leSHoF/dWHYGX6maqUEuLX7UB+r/6Llr4LKocbVIeu+hB9QTPfz9fCP8RyWmX4SmbhMFsNtCijV7lVcwejLKlvl0GfCndnWV7/39VBrtTRuUx92oke3GBgKkC5fdGK0YvNK+xenKaDmsHDjNFUM3NMz3ZiXXFuLgojosPVCDEl2W5BjX3Ms+j0GSqACHmh0+RPWyuNm/Qe8vFf9AW7N1uRaxWirrUytqEJnJ4/Flm8hSoiZ2NQBsS6w/yQlC4gCaFo8q4nyY6AFdo4hiwhBXzbNKKvZvktCjSCukRR/BbYVbNwZi2Yh3hGodEacLW8qijiWJODf0P2bhfaiPspPT4lYJBgi/KfcFwCfvyUIgkJOv///8CG/JEepRBLaMFE+2TgrqsJXOVOWHt6g/bFwVLLMVBsMR50dis/39/AlBX+/rMTJkUQrnlxpR2iu0Tp8tATkRYGmDIrcAiRP8PjoWIlb7/0ecTdSCE9Y58+a+n/FovJQTVF4F2jAxMZhTgrM/KVS5BQu6bVbkWY5HXnxRshks3urDdW4RkWp4M4TeLmFK5KF/uHkkiO5Kv96RioH984v/CSDBnG+BwlnU9B+o7Y+0X0Nob+0pLsStxjvPXMy2eCpzhOWV4XbObBHN4UE2sLQ/DIqXhOzxVf38GlTi6aG7EnePO7TRJm9yOfUUcqq1I2iQHrVDqn3TUNRi/lMw8KbMW/3/nqCz/Ef8PoW5Qxcz2yHR/f78EPB2Stbd+ZFmfNTUYILzsb9YNhpaHcaymYrBiNHmFE3Y4ccYJ25Prqm7zHobGHED8/93ZNlWro9vcKivGZs31UiK1k5zjUhexUgbqJb+fUTjxce/7Zly8a5KMC1fX5nfjPgibdvzbXV1jRT2asXvmSAusaLdq1TSIJ8fXINk5AtT34EWPAsfP9IFQqM5K11O6saoHJA==");le=Uint8Array.from(e,e=>e.charCodeAt(0));}};class li{_next(){this.seed=(this.seed+4)%le.length;}value(){return this._next(),le[this.seed]/255}vec4(e=new ep){return this._next(),e.set(le[this.seed],le[this.seed+1],le[this.seed+2],le[this.seed+3]).mulScalar(1/255)}constructor(e=0){this.seed=0,this.seed=4*e,lt();}}let ls=[new ed(-1,0,0),new ed(1,0,0),new ed(0,-1,0),new ed(0,1,0),new ed(0,0,-1),new ed(0,0,1)];class lr{update(e,t){let i=this.colors,{r:s,g:r,b:a}=e;for(let e=0;e<6;e++)i[3*e]=s,i[3*e+1]=r,i[3*e+2]=a;for(let e=0;e<t.length;e++){let s=t[e];if(0===s._type)for(let e=0;e<6;e++){let t=Math.max(ls[e].dot(s._direction),0)*s._intensity,r=s._color;i[3*e]+=r.r*t,i[3*e+1]+=r.g*t,i[3*e+2]+=r.b*t;}}}constructor(){this.colors=new Float32Array(18);}}let la=new ii;class ln{destroy(){this.texture&&(this.texture.destroy(),this.texture=null);let e=this.renderTargets;for(let t=0;t<e.length;t++)e[t].destroy();this.renderTargets.length=0;}static create(e,t){return 1===t._type?this.createCubemap(e,t._shadowResolution,t._shadowType):this.create2dMap(e,t._shadowResolution,t._shadowType)}static createAtlas(e,t,i){let s=this.create2dMap(e,t,i),r=s.renderTargets,a=r[0];for(let e=0;e<5;e++)r.push(a);return s}static create2dMap(e,t,i){let s=ns.get(i),r=s.format;15===r&&!e.textureFloatRenderable&&e.textureHalfFloatRenderable&&(r=50);let a=eX.get(r)?.name,n=1;3===i&&(n=+!!e.extTextureFloatLinear),6===i&&(n=0);let o=new ih(e,{format:r,width:t,height:t,mipmaps:false,minFilter:n,magFilter:n,addressU:1,addressV:1,name:`ShadowMap2D_${a}`}),l=null;return s?.pcf?(o.compareOnRead=true,o.compareFunc=1,l=new iU({depthBuffer:o})):l=new iU({colorBuffer:o,depth:true}),e.isWebGPU&&(l.flipY=true),new ln(o,[l])}static createCubemap(e,t,i){let s=ns.get(i),r=eX.get(s.format)?.name,a=6===i,n=+!a,o=new ih(e,{format:s?.format,width:t,height:t,cubemap:true,mipmaps:false,minFilter:n,magFilter:n,addressU:1,addressV:1,name:`ShadowMapCube_${r}`});a||(o.compareOnRead=true,o.compareFunc=1);let l=[];for(let e=0;e<6;e++)a?l.push(new iU({colorBuffer:o,face:e,depth:true})):l.push(new iU({depthBuffer:o,face:e}));return new ln(o,l)}constructor(e,t){this.texture=e,this.cached=false,this.renderTargets=t;}}let lo=[],ll=[],lh=new ep,lc=new ep;class ld{constructor(e){this.size=Math.floor(1024*e.w),this.used=false,this.lightId=-1,this.rect=e;}}class lu{destroy(){this.destroyShadowAtlas(),this.destroyCookieAtlas();}destroyShadowAtlas(){this.shadowAtlas?.destroy(),this.shadowAtlas=null;}destroyCookieAtlas(){this.cookieAtlas?.destroy(),this.cookieAtlas=null,this.cookieRenderTarget?.destroy(),this.cookieRenderTarget=null;}allocateShadowAtlas(e,t=0){let i=this.shadowAtlas?.texture.format,s=ns.get(t).format;if(!this.shadowAtlas||this.shadowAtlas.texture.width!==e||i!==s){this.version++,this.destroyShadowAtlas(),this.shadowAtlas=ln.createAtlas(this.device,e,t),this.shadowAtlas.cached=true;let i=4/this.shadowAtlasResolution;this.scissorVec.set(i,i,-2*i,-2*i);}}allocateCookieAtlas(e){this.cookieAtlas.width!==e&&(this.cookieRenderTarget.resize(e,e),this.version++);}allocateUniforms(){this._shadowAtlasTextureId=this.device.scope.resolve("shadowAtlasTexture"),this._shadowAtlasParamsId=this.device.scope.resolve("shadowAtlasParams"),this._shadowAtlasParams=new Float32Array(2),this._cookieAtlasTextureId=this.device.scope.resolve("cookieAtlasTexture");}updateUniforms(){let e=this.shadowAtlas.renderTargets[0].depthBuffer;this._shadowAtlasTextureId.setValue(e),this._shadowAtlasParams[0]=this.shadowAtlasResolution,this._shadowAtlasParams[1]=this.shadowEdgePixels,this._shadowAtlasParamsId.setValue(this._shadowAtlasParams),this._cookieAtlasTextureId.setValue(this.cookieAtlas);}subdivide(e,t){let i,s,r=t.atlasSplit;if(!r){let t=Math.ceil(Math.sqrt(e));(r=ll)[0]=t,r.length=1;}if(i=r,s=this.atlasSplit,!(i.length===s.length&&i.every((e,t)=>e===s[t]))){this.version++,this.slots.length=0,this.atlasSplit.length=0,this.atlasSplit.push(...r);let e=this.atlasSplit[0];if(e>1){let t=1/e;for(let i=0;i<e;i++)for(let s=0;s<e;s++){let r=new ep(i*t,s*t,t,t),a=this.atlasSplit[1+i*e+s];if(a>1)for(let e=0;e<a;e++)for(let i=0;i<a;i++){let s=t/a,n=new ep(r.x+e*s,r.y+i*s,s,s);this.slots.push(new ld(n));}else this.slots.push(new ld(r));}}else this.slots.push(new ld(new ep(0,0,1,1)));this.slots.sort((e,t)=>t.size-e.size);}}collectLights(e,t){let i=t.cookiesEnabled,s=t.shadowsEnabled,r=false,a=false;return lo.length=0,(i||s)&&(e=>{for(let t=0;t<e.length;t++){let n=e[t];if(n.visibleThisFrame){let e=s&&n.castShadows,t=i&&!!n.cookie;r||(r=e),a||(a=t),(e||t)&&lo.push(n);}}})(e),lo.sort((e,t)=>t.maxScreenSize-e.maxScreenSize),r&&this.allocateShadowAtlas(this.shadowAtlasResolution,t.shadowType),a&&this.allocateCookieAtlas(this.cookieAtlasResolution),(r||a)&&this.subdivide(lo.length,t),lo}setupSlot(e,t){e.atlasViewport.copy(t);let i=e.numShadowFaces;for(let s=0;s<i;s++)if(e.castShadows||e._cookie){if(lh.copy(t),lc.copy(t),2===e._type&&lh.add(this.scissorVec),1===e._type){let e=lh.z/3,t=this.cubeSlotsOffsets[s];lh.x+=e*t.x,lh.y+=e*t.y,lh.z=e,lh.w=e,lc.copy(lh);}if(e.castShadows){let t=e.getRenderData(null,s);t.shadowViewport.copy(lh),t.shadowScissor.copy(lc);}}}assignSlot(e,t,i){e.atlasViewportAllocated=true;let s=this.slots[t];s.lightId=e.id,s.used=true,i&&(e.atlasSlotUpdated=true,e.atlasVersion=this.version,e.atlasSlotIndex=t);}update(e,t){this.shadowAtlasResolution=t.shadowAtlasResolution,this.cookieAtlasResolution=t.cookieAtlasResolution;let i=this.collectLights(e,t);if(i.length>0){let e=this.slots;for(let t=0;t<e.length;t++)e[t].used=false;let t=Math.min(i.length,e.length);for(let s=0;s<t;s++){let t=i[s];t.castShadows&&(t._shadowMap=this.shadowAtlas);let r=e[t.atlasSlotIndex];if(t.atlasVersion===this.version&&t.id===r?.lightId){let i=e[t.atlasSlotIndex];i.size!==e[s].size||i.used||this.assignSlot(t,t.atlasSlotIndex,false);}}let s=0;for(let r=0;r<t;r++){for(;s<e.length&&e[s].used;)s++;let t=i[r];t.atlasViewportAllocated||this.assignSlot(t,s,true);let a=e[t.atlasSlotIndex];this.setupSlot(t,a.rect);}}this.updateUniforms();}constructor(e){this.device=e,this.version=1,this.shadowAtlasResolution=2048,this.shadowAtlas=null,this.shadowEdgePixels=3,this.cookieAtlasResolution=4,this.cookieAtlas=new ih(this.device,{name:"CookieAtlas",width:this.cookieAtlasResolution,height:this.cookieAtlasResolution,format:20,cubemap:false,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1}),this.cookieRenderTarget=new iU({colorBuffer:this.cookieAtlas,depth:false,flipY:true}),this.slots=[],this.atlasSplit=[],this.cubeSlotsOffsets=[new ef(0,0),new ef(0,1),new ef(1,0),new ef(1,1),new ef(2,0),new ef(2,1)],this.scissorVec=new ep,this.allocateShadowAtlas(1),this.allocateCookieAtlas(1),this.allocateUniforms();}}let lf=[];lf[0]={src:1,dst:1,op:2},lf[3]={src:1,dst:0,op:0},lf[2]={src:6,dst:8,op:0,alphaSrc:1},lf[4]={src:1,dst:8,op:0},lf[1]={src:1,dst:1,op:0},lf[6]={src:6,dst:1,op:0},lf[7]={src:4,dst:2,op:0},lf[8]={src:5,dst:1,op:0},lf[5]={src:4,dst:0,op:0},lf[9]={src:1,dst:1,op:3},lf[10]={src:1,dst:1,op:4};let lp=0;class lm{get hasShaderChunks(){return null!=this._shaderChunks}get shaderChunks(){return this._shaderChunks||(this._shaderChunks=new nH),this._shaderChunks}getShaderChunks(e=tz){let t=this.shaderChunks;return e===tz?t.glsl:t.wgsl}set shaderChunksVersion(e){this.shaderChunks.version=e;}get shaderChunksVersion(){return this.shaderChunks.version}set chunks(e){this._oldChunks=e;}get chunks(){return Object.assign(this._oldChunks,Object.fromEntries(this.shaderChunks.glsl)),this._oldChunks}set depthBias(e){this._depthState.depthBias=e;}get depthBias(){return this._depthState.depthBias}set slopeDepthBias(e){this._depthState.depthBiasSlope=e;}get slopeDepthBias(){return this._depthState.depthBiasSlope}set redWrite(e){this._blendState.redWrite=e;}get redWrite(){return this._blendState.redWrite}set greenWrite(e){this._blendState.greenWrite=e;}get greenWrite(){return this._blendState.greenWrite}set blueWrite(e){this._blendState.blueWrite=e;}get blueWrite(){return this._blendState.blueWrite}set alphaWrite(e){this._blendState.alphaWrite=e;}get alphaWrite(){return this._blendState.alphaWrite}get transparent(){return this._blendState.blend}_updateTransparency(){let e=this.transparent,t=this.meshInstances;for(let i=0;i<t.length;i++)t[i].transparent=e;}set blendState(e){this._blendState.copy(e),this._updateTransparency();}get blendState(){return this._blendState}set blendType(e){let t=lf[e];this._blendState.setColorBlend(t.op,t.src,t.dst),this._blendState.setAlphaBlend(t.alphaOp??t.op,t.alphaSrc??t.src,t.alphaDst??t.dst);let i=3!==e;this._blendState.blend!==i&&(this._blendState.blend=i,this._updateTransparency()),this._updateMeshInstanceKeys();}get blendType(){if(!this.transparent)return 3;let{colorOp:e,colorSrcFactor:t,colorDstFactor:i,alphaOp:s,alphaSrcFactor:r,alphaDstFactor:a}=this._blendState;for(let n=0;n<lf.length;n++){let o=lf[n];if(o.src===t&&o.dst===i&&o.op===e&&o.src===r&&o.dst===a&&o.op===s)return n}return 2}set depthState(e){this._depthState.copy(e);}get depthState(){return this._depthState}set depthTest(e){this._depthState.test=e;}get depthTest(){return this._depthState.test}set depthFunc(e){this._depthState.func=e;}get depthFunc(){return this._depthState.func}set depthWrite(e){this._depthState.write=e;}get depthWrite(){return this._depthState.write}copy(e){for(let t in this.name=e.name,this.alphaTest=e.alphaTest,this.alphaToCoverage=e.alphaToCoverage,this._blendState.copy(e._blendState),this._depthState.copy(e._depthState),this.cull=e.cull,this.stencilFront=e.stencilFront?.clone(),e.stencilBack&&(this.stencilBack=e.stencilFront===e.stencilBack?this.stencilFront:e.stencilBack.clone()),this.clearParameters(),e.parameters)e.parameters.hasOwnProperty(t)&&this._setParameterSimple(t,e.parameters[t].data);return this.defines.clear(),e.defines.forEach((e,t)=>this.defines.set(t,e)),this._shaderChunks=e.hasShaderChunks?new nH:null,this._shaderChunks?.copy(e._shaderChunks),this}clone(){return new this.constructor().copy(this)}_updateMeshInstanceKeys(){let e=this.meshInstances;for(let t=0;t<e.length;t++)e[t].updateKey();}updateUniforms(e,t){this._dirtyShader&&this.clearVariants();}getShaderVariant(e){}update(){if(Object.keys(this._oldChunks).length>0)for(let[e,t]of Object.entries(this._oldChunks))this.shaderChunks.glsl.set(e,t),delete this._oldChunks[e];(this._definesDirty||this._shaderChunks?.isDirty())&&(this._definesDirty=false,this._shaderChunks?.resetDirty(),this.clearVariants()),this.dirty=true;}clearParameters(){this.parameters={};}getParameters(){return this.parameters}clearVariants(){this.variants.clear();let e=this.meshInstances,t=e.length;for(let i=0;i<t;i++)e[i].clearShaders();}getParameter(e){return this.parameters[e]}_setParameterSimple(e,t){let i=this.parameters[e];i?i.data=t:this.parameters[e]={scopeId:null,data:t};}setParameter(e,t){if(void 0===t&&"object"==typeof e){let i=e;if(i.length){for(let e=0;e<i.length;e++)this.setParameter(i[e]);return}e=i.name,t=i.value;}this._setParameterSimple(e,t);}deleteParameter(e){this.parameters[e]&&delete this.parameters[e];}setParameters(e,t){let i=this.parameters;for(let s in void 0===t&&(t=i),t){let t=i[s];t&&(t.scopeId||(t.scopeId=e.scope.resolve(s)),t.scopeId.setValue(t.data));}}setDefine(e,t){let i=false,{defines:s}=this;void 0!==t&&false!==t?(i=!s.has(e)||s.get(e)!==t,s.set(e,t)):(i=s.has(e),s.delete(e)),this._definesDirty||(this._definesDirty=i);}getDefine(e){return this.defines.has(e)}destroy(){this.variants.clear();for(let e=0;e<this.meshInstances.length;e++){let t=this.meshInstances[e];if(t.clearShaders(),t._material=null,t.mesh){let e=ot(t.mesh.device);this!==e&&(t.material=e);}}this.meshInstances.length=0;}addMeshInstanceRef(e){this.meshInstances.push(e);}removeMeshInstanceRef(e){let t=this.meshInstances,i=t.indexOf(e);-1!==i&&t.splice(i,1);}constructor(){this.meshInstances=[],this.name="Untitled",this.userId="",this.id=lp++,this.variants=new Map,this.defines=new Map,this._definesDirty=false,this.parameters={},this.alphaTest=0,this.alphaToCoverage=false,this._blendState=new iS,this._depthState=new ix,this.cull=1,this.stencilFront=null,this.stencilBack=null,this._shaderChunks=null,this._oldChunks={},this._dirtyShader=true,this._shaderVersion=0,this._scene=null,this.dirty=true;}}class l_{destroy(){this.clear(),this.cache=null;}clear(){this.cache.forEach(e=>{e.forEach(e=>{e.destroy();});}),this.cache.clear();}getKey(e){let t=1===e._type,i=e._shadowType,s=e._shadowResolution;return `${t}-${i}-${s}`}get(e,t){let i=this.getKey(t),s=this.cache.get(i);if(s&&s.length)return s.pop();let r=ln.create(e,t);return r.cached=true,r}add(e,t){let i=this.getKey(e),s=this.cache.get(i);s?s.push(t):this.cache.set(i,[t]);}constructor(){this.cache=new Map;}}class lg extends as{execute(){this.shadowRenderer.renderFace(this.light,null,this.face,false);}after(){this.applyVsm&&this.shadowRenderer.renderVsm(this.light,this.shadowCamera);}constructor(e,t,i,s,r){super(e),this.requiresCubemaps=false,this.shadowRenderer=t,this.light=i,this.face=s,this.applyVsm=r,this.shadowCamera=t.prepareFace(i,null,s),t.setupRenderPass(this,this.shadowCamera,true);}}class lv{cull(e,t,i=null){let s=this.renderer.scene.clusteredLightingEnabled;e.visibleThisFrame=true,s||e._shadowMap||(e._shadowMap=ln.create(this.device,e));let r=e._type,a=2===r?1:6;for(let n=0;n<a;n++){let a=e.getRenderData(null,n),o=a.shadowCamera;o.nearClip=e.attenuationEnd/1e3,o.farClip=e.attenuationEnd;let l=o._node,h=e._node;l.setPosition(h.getPosition()),2===r?(o.fov=2*e._outerConeAngle,l.setRotation(h.getRotation()),l.rotateLocal(-90,0,0)):1===r&&(s?o.fov=Math.atan(1+2/(this.shadowRenderer.lightTextureAtlas.shadowAtlasResolution*e.atlasViewport.z/3)*this.shadowRenderer.lightTextureAtlas.shadowEdgePixels)*ei.RAD_TO_DEG*2:o.fov=90),this.renderer.updateCameraFrustum(o),this.shadowRenderer.cullShadowCasters(t,e,a.visibleCasters,o,i);}}prepareLights(e,t){let i;for(let s=0;s<t.length;s++){let r=t[s];if(this.shadowRenderer.needsShadowRendering(r)&&r.atlasViewportAllocated){e.push(r);for(let e=0;e<r.numShadowFaces;e++)i=this.shadowRenderer.prepareFace(r,null,e);}}return i}buildNonClusteredRenderPasses(e,t){for(let i=0;i<t.length;i++){let s=t[i];if(this.shadowRenderer.needsShadowRendering(s)){let t=2===s._type,i=s.numShadowFaces;for(let r=0;r<i;r++){let i=new lg(this.device,this.shadowRenderer,s,r,t);e.addRenderPass(i);}}}}constructor(e,t){this.shadowLights=[],this.renderer=e,this.shadowRenderer=t,this.device=e.device;}}class lS extends as{execute(){let{light:e,camera:t,shadowRenderer:i,allCascadesRendering:s}=this,r=e.numShadowFaces,a=e.shadowUpdateOverrides;for(let n=0;n<r;n++)a?.[n]!==0&&i.renderFace(e,t,n,!s),a?.[n]===1&&(a[n]=0);}after(){this.shadowRenderer.renderVsm(this.light,this.camera);}constructor(e,t,i,s,r){super(e),this.shadowRenderer=t,this.light=i,this.camera=s,this.allCascadesRendering=r;}}let ly=new eC,lx=new ed,lT=new ey,lE=[new ed,new ed,new ed,new ed,new ed,new ed,new ed,new ed],lw={min:0,max:0};class lb{cull(e,t,i,s=null){e.visibleThisFrame=true,e._shadowMap||(e._shadowMap=ln.create(this.device,e));let r=i._nearClip;this.generateSplitDistances(e,r,Math.min(i._farClip,e.shadowDistance));let a=e.shadowUpdateOverrides;for(let n=0;n<e.numCascades&&a?.[n]!==0;n++){let a=e.getRenderData(i,n),o=a.shadowCamera;o.renderTarget=e._shadowMap.renderTargets[0],a.shadowViewport.copy(e.cascades[n]),a.shadowScissor.copy(e.cascades[n]);let l=o._node,h=e._node;l.setPosition(h.getPosition()),l.setRotation(h.getRotation()),l.rotateLocal(-90,0,0);let c=0===n?r:e._shadowCascadeDistances[n-1],d=e._shadowCascadeDistances[n],u=i.getFrustumCorners(c,d);lx.set(0,0,0);let f=i.node.getWorldTransform();for(let e=0;e<8;e++)f.transformPoint(u[e],u[e]),lx.add(u[e]);lx.mulScalar(1/8);let p=0;for(let e=0;e<8;e++){let t=u[e].sub(lx).length();t>p&&(p=t);}let m=l.right,_=l.up,g=l.forward,v=.25*e._shadowResolution/p,S=Math.ceil(lx.dot(_)*v)/v,y=Math.ceil(lx.dot(m)*v)/v,x=_.mulScalar(S),T=m.mulScalar(y),E=lx.dot(g),w=g.mulScalar(E);lx.add2(x,T).add(w),l.setPosition(lx),l.translateLocal(0,0,1e6),o.nearClip=.01,o.farClip=2e6,o.orthoHeight=p,this.renderer.updateCameraFrustum(o),this.shadowRenderer.cullShadowCasters(t,e,a.visibleCasters,o,s);let b=1<<n,A=a.visibleCasters,C=A.length,P=0;for(let e=0;e<C;e++){let t=A[e];t.shadowCascadeMask&b&&(A[P++]=t,1===P?ly.copy(t.aabb):ly.add(t.aabb));}C!==P&&(A.length=P),lT.copy(l.getWorldTransform()).invert();let I=function(e,t,i){lE[0].x=lE[1].x=lE[2].x=lE[3].x=t.x,lE[1].y=lE[3].y=lE[7].y=lE[5].y=t.y,lE[2].z=lE[3].z=lE[6].z=lE[7].z=t.z,lE[4].x=lE[5].x=lE[6].x=lE[7].x=i.x,lE[0].y=lE[2].y=lE[4].y=lE[6].y=i.y,lE[0].z=lE[1].z=lE[4].z=lE[5].z=i.z;let s=0x2540be3ff,r=-9999999999;for(let t=0;t<8;++t){e.transformPoint(lE[t],lE[t]);let i=lE[t].z;i<s&&(s=i),i>r&&(r=i);}return lw.min=s,lw.max=r,lw}(lT,ly.getMin(),ly.getMax());l.translateLocal(0,0,I.max+.1),o.farClip=I.max-I.min+.2,a.projectionCompensation=p;}}generateSplitDistances(e,t,i){e._shadowCascadeDistances.fill(i);for(let s=1;s<e.numCascades;s++){let r=s/e.numCascades,a=t+(i-t)*r,n=t*(i/t)**r,o=ei.lerp(a,n,e.cascadeDistribution);e._shadowCascadeDistances[s-1]=o;}}getLightRenderPass(e,t){let i=null;if(this.shadowRenderer.needsShadowRendering(e)){let s,r=e.numShadowFaces,a=e.shadowUpdateOverrides,n=true;for(let i=0;i<r;i++)a?.[i]===0&&(n=false),s=this.shadowRenderer.prepareFace(e,t,i);i=new lS(this.device,this.shadowRenderer,e,t,n),this.shadowRenderer.setupRenderPass(i,s,n);}return i}constructor(e,t){this.renderer=e,this.shadowRenderer=t,this.device=e.device;}}let lA=new Set,lC=new ey,lP=new ey,lI=new Float32Array(2),lD=new ep(1,1,0,0),lR=new ey;class lL{static createShadowCamera(e,t,i){let s=oj.create(nM,t,i),r=ns.get(e),a=r?.vsm??false,n=r?.pcf??false;return a?s.clearColor=new es(0,0,0,0):s.clearColor=new es(1,1,1,1),s.clearDepthBuffer=true,s.clearStencilBuffer=false,s.clearColorBuffer=!n,s}_cullShadowCastersInternal(e,t,i){let s=e.length;for(let r=0;r<s;r++){let s=e[r];s.castShadow&&(!s.cull||s._isVisible(i))&&(s.visibleThisFrame=true,t.push(s));}}cullShadowCasters(e,t,i,s,r){if(this.renderer.scene?.fire(nD,s),i.length=0,r)this._cullShadowCastersInternal(r,i,s);else {let r=e.layerList,a=r.length;for(let e=0;e<a;e++){let a=r[e];a._lightsSet.has(t)&&!lA.has(a)&&(lA.add(a),this._cullShadowCastersInternal(a.shadowCasters,i,s));}lA.clear();}i.sort(this.sortCompareShader),this.renderer.scene?.fire(nR,s);}sortCompareShader(e,t){let i=e._sortKeyShadow,s=t._sortKeyShadow;return i===s?t.mesh.id-e.mesh.id:s-i}setupRenderState(e,t){let i=this.renderer.scene.clusteredLightingEnabled?t._isPcf:t._isPcf&&1!==t._type;e.setBlendState(i?this.blendStateNoWrite:this.blendStateWrite),e.setDepthState(t.shadowDepthState),e.setStencilState(null,null);}dispatchUniforms(e,t,i,s){let r=t._node;0!==e._type&&(this.renderer.dispatchViewPos(r.getPosition()),this.shadowMapLightRadiusId.setValue(e.attenuationEnd)),lC.setTRS(r.getPosition(),r.getRotation(),ed.ONE).invert(),lP.mul2(t.projectionMatrix,lC);let a=i.shadowViewport;t.rect=a,t.scissorRect=i.shadowScissor,lR.setViewport(a.x,a.y,a.z,a.w),i.shadowMatrix.mul2(lR,lP),0===e._type&&e._shadowMatrixPalette.set(i.shadowMatrix.data,16*s);}getShadowPass(e){let t=e._type,i=e._shadowType,s=this.shadowPassCache[t]?.[i];if(!s){let e=`ShadowPass_${t}_${i}`;s=nz.get(this.device).allocate(e,{isShadow:true,lightType:t,shadowType:i}),this.shadowPassCache[t]||(this.shadowPassCache[t]=[]),this.shadowPassCache[t][i]=s;}return s.index}submitCasters(e,t,i){let s=this.device,r=this.renderer,a=r.scene,n=this.getShadowPass(t),o=i.shaderParams,l=i.renderTarget.flipY?-1:1,h=e.length;for(let t=0;t<h;t++){let h=e[t],c=h.mesh,d=h.instancingData;if(d&&d.count<=0)continue;h.ensureMaterial(s);let u=h.material;r.setBaseConstants(s,u),r.setSkinning(s,h),u.dirty&&(u.updateUniforms(s,a),u.dirty=false),r.setupCullMode(true,l,h),u.setParameters(s),h.setParameters(s,4);let f=h.getShaderInstance(n,0,a,o,this.viewUniformFormat,this.viewBindGroupFormat),p=f.shader;if(p.failed)continue;h._sortKeyShadow=p.id,s.setShader(p),r.setVertexBuffers(s,c),r.setMorphing(s,h.morphInstance),d&&s.setVertexBuffer(d.vertexBuffer),r.setMeshInstanceMatrices(h),r.setupMeshUniformBuffers(f);let m=h.renderStyle,_=h.getDrawCommands(i);s.draw(c.primitive[m],c.indexBuffer[m],d?.count,_),r._shadowDrawCalls++,d&&r._instancedDrawCalls++;}}needsShadowRendering(e){let t=e.enabled&&e.castShadows&&0!==e.shadowUpdateMode&&e.visibleThisFrame;return 1===e.shadowUpdateMode&&(e.shadowUpdateMode=0),t&&(this.renderer._shadowMapUpdates+=e.numShadowFaces),t}getLightRenderData(e,t,i){return e.getRenderData(0===e._type?t:null,i)}setupRenderPass(e,t,i){let s=t.renderTarget;e.init(s),e.depthStencilOps.clearDepthValue=1,e.depthStencilOps.clearDepth=i,s.depthBuffer?e.depthStencilOps.storeDepth=true:(e.colorOps.clearValue.copy(t.clearColor),e.colorOps.clear=i,e.depthStencilOps.storeDepth=false),e.requiresCubemaps=false;}prepareFace(e,t,i){let s=e._type,r=this.getLightRenderData(e,t,i).shadowCamera,a=0===s?0:i;return r.renderTarget=e._shadowMap.renderTargets[a],r}renderFace(e,t,i,s){let r=this.device,a=this.getLightRenderData(e,t,i),n=a.shadowCamera;this.dispatchUniforms(e,n,a,i);let o=n.renderTarget,l=this.renderer;l.setCameraUniforms(n,o),r.supportsUniformBuffers&&l.setupViewUniformBuffers(a.viewBindGroups,this.viewUniformFormat,this.viewBindGroupFormat,null),l.setupViewport(n,o),s&&l.clear(n),this.setupRenderState(r,e),this.submitCasters(a.visibleCasters,e,n);}renderVsm(e,t){e._isVsm&&e._vsmBlurSize>1&&(this.renderer.scene.clusteredLightingEnabled&&0!==e._type||this.applyVsmBlur(e,t));}getVsmBlurShader(e,t){let i=this.blurVsmShader,s=i[e][t];if(!s){this.blurVsmWeights[t]=function(e){let t=(e-1)/6,i=(e-1)*.5,s=Array(e),r=0;for(let n=0;n<e;++n){var a;s[n]=Math.exp(-((a=n-i)*a)/(2*t*t)),r+=s[n];}for(let t=0;t<e;++t)s[t]/=r;return s}(t);let r=new Map;r.set("{SAMPLES}",t),1===e&&r.set("GAUSS",""),s=nY.createShader(this.device,{uniqueName:`blurVsm${e}${t}`,attributes:{vertex_position:e6},vertexChunk:"fullscreenQuadVS",fragmentChunk:"blurVSMPS",fragmentDefines:r}),i[e][t]=s;}return s}applyVsmBlur(e,t){let i=this.device;i.setBlendState(iS.NOBLEND);let s=e.getRenderData(0===e._type?t:null,0).shadowCamera.renderTarget,r=this.renderer.shadowMapCache.get(i,e),a=r.renderTargets[0],n=e.vsmBlurMode,o=e._vsmBlurSize,l=this.getVsmBlurShader(n,o);lD.z=e._shadowResolution-2,lD.w=lD.z,this.sourceId.setValue(s.colorBuffer),lI[0]=1/e._shadowResolution,lI[1]=0,this.pixelOffsetId.setValue(lI),1===n&&this.weightId.setValue(this.blurVsmWeights[o]),n0(i,a,l,null,lD),this.sourceId.setValue(a.colorBuffer),lI[1]=lI[0],lI[0]=0,this.pixelOffsetId.setValue(lI),n0(i,s,l,null,lD),this.renderer.shadowMapCache.add(e,r);}initViewBindGroupFormat(){this.device.supportsUniformBuffers&&!this.viewUniformFormat&&(this.viewUniformFormat=new sf(this.device,[new su("matrix_viewProjection",14)]),this.viewBindGroupFormat=new it(this.device,[new t6(tZ,3)]));}frameUpdate(){this.initViewBindGroupFormat();}constructor(e,t){this.shadowPassCache=[],this.device=e.device,this.renderer=e,this.lightTextureAtlas=t;let i=this.device.scope;this.sourceId=i.resolve("source"),this.pixelOffsetId=i.resolve("pixelOffset"),this.weightId=i.resolve("weight[0]"),this.blurVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=i.resolve("light_radius"),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this.blendStateWrite=new iS,this.blendStateNoWrite=new iS,this.blendStateNoWrite.setColorWrite(false,false,false,false);}}let lM=[];class lO{destroy(){this._empty&&(this._empty.destroy(),this._empty=null),this._allocated.forEach(e=>{e.destroy();}),this._allocated.length=0;}get count(){return this._allocated.length}get empty(){if(!this._empty){let e=new o7(this.device);e.name="ClusterEmpty",e.update([]),this._empty=e;}return this._empty}assign(e){lM.push(...this._allocated),this._allocated.length=0,this._clusters.clear();let t=e.length;for(let i=0;i<t;i++){let t=e[i].renderActions;if(t){let e=t.length;for(let i=0;i<e;i++){let e=t[i];e.lightClusters=null;let s=e.layer;if(s.hasClusteredLights&&s.meshInstances.length){let t=s.getLightIdHash(),i=this._clusters.get(t),r=i?.lightClusters;r||(r=lM.pop()??new o7(this.device),this._allocated.push(r),this._clusters.set(t,e)),e.lightClusters=r;}e.lightClusters||(e.lightClusters=this.empty);}}}lM.forEach(e=>e.destroy()),lM.length=0;}update(e,t){this.assign(e),this._clusters.forEach(e=>{let i=e.layer;e.lightClusters.update(i.clusteredLightsSet,t);});}constructor(e){this._empty=null,this._allocated=[],this._clusters=new Map,this.device=e;}}let lF=new ep,lN=[];class lB extends as{destroy(){this._quadRenderer2D?.destroy(),this._quadRenderer2D=null,this._quadRendererCube?.destroy(),this._quadRendererCube=null,this._evtDeviceRestored?.off(),this._evtDeviceRestored=null;}static create(e,t){let i=new lB(e.device,t);return i.init(e),i.colorOps.clear=false,i.depthStencilOps.clearDepth=false,i}onDeviceRestored(){this._forceCopy=true;}update(e){let t=this._filteredLights;this.filter(e,t),this.executeEnabled=t.length>0;}filter(e,t){for(let i=0;i<e.length;i++){let s=e[i];0!==s._type&&s.atlasViewportAllocated&&(s.atlasSlotUpdated||this._forceCopy)&&s.enabled&&s.cookie&&s.visibleThisFrame&&t.push(s);}this._forceCopy=false;}initInvViewProjMatrices(){if(!lN.length)for(let e=0;e<6;e++){let t=oj.create(null,1,e),i=t.projectionMatrix,s=t.node.getLocalTransform().clone().invert();lN[e]=new ey().mul2(i,s).invert();}}get quadRenderer2D(){if(!this._quadRenderer2D){let e=nY.createShader(this.device,{uniqueName:"cookieRenderer2d",attributes:{vertex_position:e6},vertexChunk:"cookieBlitVS",fragmentChunk:"cookieBlit2DPS"});this._quadRenderer2D=new nZ(e);}return this._quadRenderer2D}get quadRendererCube(){if(!this._quadRendererCube){let e=nY.createShader(this.device,{uniqueName:"cookieRendererCube",attributes:{vertex_position:e6},vertexChunk:"cookieBlitVS",fragmentChunk:"cookieBlitCubePS"});this._quadRendererCube=new nZ(e);}return this._quadRendererCube}execute(){let e=this.device;e.setBlendState(iS.NOBLEND),e.setCullMode(0),e.setDepthState(ix.NODEPTH),e.setStencilState();let t=this.renderTarget.colorBuffer.width,i=this._cubeSlotsOffsets,s=this._filteredLights;for(let e=0;e<s.length;e++){let r=s[e],a=r.numShadowFaces,n=a>1?this.quadRendererCube:this.quadRenderer2D;a>1&&this.initInvViewProjMatrices(),this.blitTextureId.setValue(r.cookie);for(let e=0;e<a;e++){if(lF.copy(r.atlasViewport),a>1){let t=lF.z/3,s=i[e];lF.x+=t*s.x,lF.y+=t*s.y,lF.z=t,lF.w=t,this.invViewProjId.setValue(lN[e].data);}lF.mulScalar(t),n.render(lF);}}s.length=0;}constructor(e,t){super(e),this._quadRenderer2D=null,this._quadRendererCube=null,this._filteredLights=[],this._forceCopy=false,this._evtDeviceRestored=null,this._cubeSlotsOffsets=t,this.requiresCubemaps=false,this.blitTextureId=e.scope.resolve("blitTexture"),this.invViewProjId=e.scope.resolve("invViewProj"),this._evtDeviceRestored=e.on("devicerestored",this.onDeviceRestored,this);}}class lk extends as{update(e){let t=this.shadowRendererLocal.shadowLights,i=this.shadowRendererLocal.prepareLights(t,e),s=t.length;this.enabled=s>0,s&&this.shadowRenderer.setupRenderPass(this,i,false);}execute(){let e=this.shadowRendererLocal.shadowLights,t=e.length;for(let i=0;i<t;i++){let t=e[i];for(let e=0;e<t.numShadowFaces;e++)this.shadowRenderer.renderFace(t,null,e,true);}e.length=0;}constructor(e,t,i){super(e),this.requiresCubemaps=false,this.shadowRenderer=t,this.shadowRendererLocal=i;}}class lU extends as{update(e,t,i,s,r){this.frameGraph=e,this.cookiesRenderPass.enabled=i,i&&this.cookiesRenderPass.update(s),this.shadowRenderPass.enabled=t,t&&this.shadowRenderPass.update(r);}destroy(){this.cookiesRenderPass.destroy(),this.cookiesRenderPass=null;}execute(){let{renderer:e}=this,{scene:t}=e;e.worldClustersAllocator.update(this.frameGraph.renderPasses,t.lighting);}constructor(e,t,i,s,r){super(e),this.renderer=t,this.frameGraph=null,this.cookiesRenderPass=lB.create(r.cookieRenderTarget,r.cubeSlotsOffsets),this.beforePasses.push(this.cookiesRenderPass),this.shadowRenderPass=new lk(e,i,s),this.beforePasses.push(this.shadowRenderPass);}}let lz=0,lV=new ey,lG=new ey,lH=new ey,lW=new eu,lX=new eD,lY=new eL,lq=new ey().setScale(1,-1,1),l$=new Set,lj=new Set,lK=new i_,lZ=new ey().set([1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1]),lQ=[new ef(.5,.333333),new ef(.25,.666667),new ef(.75,.111111),new ef(.125,.444444),new ef(.625,.777778),new ef(.375,.222222),new ef(.875,.555556),new ef(.0625,.888889),new ef(.5625,.037037),new ef(.3125,.37037),new ef(.8125,.703704),new ef(.1875,.148148),new ef(.6875,.481481),new ef(.4375,.814815),new ef(.9375,.259259),new ef(.03125,.592593)],lJ=new ey,l0=new ey,l1=new ey,l2=new ey,l3=new ey,l4=new ey,l5=new Set,l8=[],l6=[];class l9{destroy(){this.shadowRenderer=null,this._shadowRendererLocal=null,this._shadowRendererDirectional=null,this.shadowMapCache.destroy(),this.shadowMapCache=null,this._renderPassUpdateClustered?.destroy(),this._renderPassUpdateClustered=null,this.lightTextureAtlas.destroy(),this.lightTextureAtlas=null,this.gsplatDirector?.destroy(),this.gsplatDirector=null;}setupViewport(e,t){let i=this.device,s=t?t.width:i.width,r=t?t.height:i.height,a=e.rect,n=Math.floor(a.x*s),o=Math.floor(a.y*r),l=Math.floor(a.z*s),h=Math.floor(a.w*r);if(i.setViewport(n,o,l,h),e._scissorRectClear){let t=e.scissorRect;n=Math.floor(t.x*s),o=Math.floor(t.y*r),l=Math.floor(t.z*s),h=Math.floor(t.w*r);}i.setScissor(n,o,l,h);}setCameraUniforms(e,t){let i=t?.flipY,s=null;if(e.xr&&e.xr.session){let t=e._node?.parent?.getWorldTransform()||null;s=e.xr.views.list;for(let e=0;e<s.length;e++)s[e].updateTransforms(t);}else {let s=e.projectionMatrix;e.calculateProjection&&e.calculateProjection(s,0);let r=e.getProjectionMatrixSkybox();i&&(s=lJ.mul2(lq,s),r=l0.mul2(lq,r)),this.device.isWebGPU&&(s=l1.mul2(lZ,s),r=l2.mul2(lZ,r));let{jitter:a}=e,n=0,o=0;if(a>0){let e=t?t.width:this.device.width,i=t?t.height:this.device.height,l=lQ[this.device.renderVersion%lQ.length];n=a*(2*l.x-1)/e,o=a*(2*l.y-1)/i,(s=l3.copy(s)).data[8]=n,s.data[9]=o,(r=l4.copy(r)).data[8]=n,r.data[9]=o,this.blueNoiseJitterVersion!==this.device.renderVersion&&(this.blueNoiseJitterVersion=this.device.renderVersion,this.blueNoise.vec4(this.blueNoiseJitterVec));}let l=a>0?this.blueNoiseJitterVec:ep.ZERO;if(this.blueNoiseJitterData[0]=l.x,this.blueNoiseJitterData[1]=l.y,this.blueNoiseJitterData[2]=l.z,this.blueNoiseJitterData[3]=l.w,this.blueNoiseJitterId.setValue(this.blueNoiseJitterData),this.projId.setValue(s.data),this.projSkyboxId.setValue(r.data),e.calculateTransform)e.calculateTransform(lG,0);else {let t=e._node.getPosition(),i=e._node.getRotation();lG.setTRS(t,i,ed.ONE);}this.viewInvId.setValue(lG.data),lH.copy(lG).invert(),this.viewId.setValue(lH.data),lW.setFromMat4(lH),this.viewId3.setValue(lW.data),lV.mul2(s,lH),this.viewProjId.setValue(lV.data),e._storeShaderMatrices(lV,n,o,this.device.renderVersion),this.flipYId.setValue(i?-1:1),this.dispatchViewPos(e._node.getPosition()),e.frustum.setFromMat4(lV);}this.tbnBasis.setValue(i?-1:1),this.cameraParamsId.setValue(e.fillShaderParams(this.cameraParams));let r=t?t.width:this.device.width,a=t?t.height:this.device.height;return r*=e.rect.z,a*=e.rect.w,e.xr?.active&&2===e.xr.views.list.length&&(r*=.5),this.viewportSize[0]=r,this.viewportSize[1]=a,this.viewportSize[2]=1/r,this.viewportSize[3]=1/a,this.viewportSizeId.setValue(this.viewportSize),this.exposureId.setValue(this.scene.physicalUnits?e.getExposure():this.scene.exposure),s}clear(e,t,i,s){let r=(t??e._clearColorBuffer?1:0)|(i??e._clearDepthBuffer?2:0)|(s??e._clearStencilBuffer?4:0);r&&this.device.clear({color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,stencil:e._clearStencil,flags:r});}setupCullMode(e,t,i){let s=i.material,r=0;if(e){let e=1;(2===s.cull||1===s.cull)&&(e=t*i.flipFacesFactor*i.node.worldScaleSign),r=e<0?2===s.cull?1:2:s.cull;}this.device.setCullMode(r),0===r&&0===s.cull&&this.twoSidedLightingNegScaleFactorId.setValue(i.node.worldScaleSign);}updateCameraFrustum(e){if(e.xr&&e.xr.views.list.length){let t=e.xr.views.list;lV.mul2(t[0].projMat,t[0].viewOffMat),e.frustum.setFromMat4(lV);for(let i=1;i<t.length;i++)lV.mul2(t[i].projMat,t[i].viewOffMat),lY.setFromMat4(lV),e.frustum.add(lY);return}let t=e.projectionMatrix;if(e.calculateProjection&&e.calculateProjection(t,0),e.calculateTransform)e.calculateTransform(lG,0);else {let t=e._node.getPosition(),i=e._node.getRotation();lG.setTRS(t,i,ed.ONE),this.viewInvId.setValue(lG.data);}lH.copy(lG).invert(),lV.mul2(t,lH),e.frustum.setFromMat4(lV);}setBaseConstants(e,t){e.setCullMode(t.cull),t.opacityMap&&this.opacityMapId.setValue(t.opacityMap),(t.opacityMap||t.alphaTest>0)&&this.alphaTestId.setValue(t.alphaTest);}updateCpuSkinMatrices(e){lz++;let t=e.length;if(0!==t)for(let i=0;i<t;i++){let t=e[i].skinInstance;t&&(t.updateMatrices(e[i].node,lz),t._dirty=true);}}updateGpuSkinMatrices(e){for(let t of e){let e=t.skinInstance;e&&e._dirty&&(e.updateMatrixPalette(t.node,lz),e._dirty=false);}}updateMorphing(e){for(let t of e){let e=t.morphInstance;e&&e._dirty&&e.update();}}updateGSplats(e){for(let t of e)t.gsplatInstance?.update();}gpuUpdate(e){this.updateGpuSkinMatrices(e),this.updateMorphing(e),this.updateGSplats(e);}setVertexBuffers(e,t){e.setVertexBuffer(t.vertexBuffer);}setMorphing(e,t){t&&(t.prepareRendering(e),e.setVertexBuffer(t.morph.vertexBufferIds),this.morphPositionTex.setValue(t.texturePositions),this.morphNormalTex.setValue(t.textureNormals),this.morphTexParams.setValue(t._textureParams));}setSkinning(e,t){let i=t.skinInstance;if(i){this._skinDrawCalls++;let e=i.boneTexture;this.boneTextureId.setValue(e);}}dispatchViewPos(e){let t=this.viewPos;t[0]=e.x,t[1]=e.y,t[2]=e.z,this.viewPosId.setValue(t);}initViewBindGroupFormat(e){if(this.device.supportsUniformBuffers&&!this.viewUniformFormat){let t=[new su("matrix_view",14),new su("matrix_viewInverse",14),new su("matrix_projection",14),new su("matrix_projectionSkybox",14),new su("matrix_viewProjection",14),new su("matrix_view3",13),new su("cubeMapRotationMatrix",13),new su("view_position",4),new su("viewport_size",5),new su("skyboxIntensity",2),new su("exposure",2),new su("textureBias",2),new su("view_index",2)];e&&t.push(new su("clusterCellsCountByBoundsSize",4),new su("clusterBoundsMin",4),new su("clusterBoundsDelta",4),new su("clusterCellsDot",7),new su("clusterCellsMax",7),new su("shadowAtlasParams",3),new su("clusterMaxCells",1),new su("numClusteredLights",1),new su("clusterTextureWidth",1)),this.viewUniformFormat=new sf(this.device,t);let i=[new t6(tZ,3)];this.viewBindGroupFormat=new it(this.device,i);}}setupViewUniforms(e,t){this.projId.setValue(e.projMat.data),this.projSkyboxId.setValue(e.projMat.data),this.viewId.setValue(e.viewOffMat.data),this.viewInvId.setValue(e.viewInvOffMat.data),this.viewId3.setValue(e.viewMat3.data),this.viewProjId.setValue(e.projViewOffMat.data),this.viewPosId.setValue(e.positionData),this.viewIndexId.setValue(t);}setupViewUniformBuffers(e,t,i,s){let{device:r}=this,a=s?.length??1;for(;e.length<a;){let s=new r_(r,t,false),a=new ig(r,i,s);e.push(a);}if(s)for(let t=0;t<a;t++){let i=s[t];this.setupViewUniforms(i,t);let r=e[t];r.defaultUniformBuffer.update(),r.update();}else {let t=e[0];t.defaultUniformBuffer.update(),t.update();}s||r.setBindGroup(0,e[0]);}setupMeshUniformBuffers(e){let t=this.device;if(t.supportsUniformBuffers){let i=e.getBindGroup(t);i.update(),t.setBindGroup(1,i),e.getUniformBuffer(t).update(lK),t.setBindGroup(2,lK.bindGroup,lK.offsets);}}setMeshInstanceMatrices(e,t=false){let i=e.node.worldTransform;this.modelMatrixId.setValue(i.data),t&&this.normalMatrixId.setValue(e.node.normalMatrix.data);}cull(e,t,i){let s=i.opaque;s.length=0;let r=i.transparent;r.length=0;let a=e.frustumCulling,n=t.length;for(let i=0;i<n;i++){let n=t[i];n.visible&&(!a||!n.cull||n._isVisible(e))&&(n.visibleThisFrame=true,(n.transparent?r:s).push(n),(n.skinInstance||n.morphInstance||n.gsplatInstance)&&(this.processingMeshInstances.add(n),n.gsplatInstance&&n.gsplatInstance.cameras.push(e)));}}collectLights(e){this.lights.length=0,this.localLights.length=0;let t=this.scene._stats,i=e.layerList.length;for(let t=0;t<i;t++){let i=e.layerList[t];if(!lj.has(i)){lj.add(i);let e=i._lights;for(let t=0;t<e.length;t++){let i=e[t];l$.has(i)||(l$.add(i),this.lights.push(i),0!==i._type&&this.localLights.push(i));}}}t.lights=this.lights.length,l$.clear(),lj.clear();}cullLights(e,t){let i=this.scene.clusteredLightingEnabled,s=this.scene.physicalUnits;for(let r=0;r<t.length;r++){let a=t[r];if(a.enabled)if(0!==a._type)if(a.getBoundingSphere(lX),e.frustum.containsSphere(lX)){a.visibleThisFrame=true,a.usePhysicalUnits=s;let t=e.getScreenSize(lX);a.maxScreenSize=Math.max(a.maxScreenSize,t);}else i||!a.castShadows||a.shadowMap||(a.visibleThisFrame=true);else a.usePhysicalUnits=this.scene.physicalUnits;}}cullShadowmaps(e){let t=this.scene.clusteredLightingEnabled;for(let i=0;i<this.localLights.length;i++){let s=this.localLights[i];0!==s._type&&(t?s.atlasSlotUpdated&&0===s.shadowUpdateMode&&(s.shadowUpdateMode=1):0===s.shadowUpdateMode&&s.castShadows&&!s.getRenderData(null,0).shadowCamera.renderTarget&&(s.shadowUpdateMode=1),s.visibleThisFrame&&s.castShadows&&0!==s.shadowUpdateMode&&this._shadowRendererLocal.cull(s,e));}this.cameraDirShadowLights.clear();let i=e.cameras;for(let t=0;t<i.length;t++){let s=i[t];if(s.enabled){let t,i=s.camera,r=i.layers;for(let s=0;s<r.length;s++){let a=e.getLayerById(r[s]);if(a){let s=a.splitLights[0];for(let r=0;r<s.length;r++){let a=s[r];a.castShadows&&!l5.has(a)&&(l5.add(a),(t=t??[]).push(a),this._shadowRendererDirectional.cull(a,e,i));}}}t&&this.cameraDirShadowLights.set(i,t),l5.clear();}}}cullComposition(e){let{scene:t}=this;this.processingMeshInstances.clear();let i=e.cameras.length;this._camerasRendered+=i;for(let s=0;s<i;s++){let i=e.cameras[s];t?.fire(nD,i);let r=i.renderTarget;i.frameUpdate(r),this.updateCameraFrustum(i.camera);let a=i.layers;for(let t=0;t<a.length;t++){let s=e.getLayerById(a[t]);if(s&&s.enabled){this.cullLights(i.camera,s._lights);let e=s.getCulledInstances(i.camera);this.cull(i.camera,s.meshInstances,e);}}t?.fire(nR,i);}t.clusteredLightingEnabled&&this.updateLightTextureAtlas(),this.cullShadowmaps(e),t?.fire(nL);}updateShaders(e,t){let i=e.length;for(let s=0;s<i;s++){let i=e[s].material;if(i&&!l5.has(i)&&(l5.add(i),i.getShaderVariant!==lm.prototype.getShaderVariant)){if(t&&(!i.useLighting||i.emitter&&!i.emitter.lighting))continue;i.clearVariants();}}l5.clear();}updateFrameUniforms(){let e;this.blueNoiseTextureId.setValue((e=this.device,la.get(e,()=>{let t,i=(lt(),le),s=Math.sqrt(i.length/4);return (t=new ih(e,{name:`BlueNoise${s}`,width:s,height:s,format:7,addressU:0,addressV:0,type:tP,magFilter:0,minFilter:0,anisotropy:1,mipmaps:false})).lock().set(i),t.unlock(),t})));}beginFrame(e){let t=this.scene,i=t.updateShaders||this.device._shadersDirty,s=e.layerList,r=s.length;for(let e=0;e<r;e++){let t=s[e].meshInstances,r=t.length;for(let e=0;e<r;e++){let s=t[e];s.visibleThisFrame=false,i&&l8.push(s),s.skinInstance&&l6.push(s);}}if(i){let e=!t.updateShaders||!this.device._shadersDirty;this.updateShaders(l8,e),t.updateShaders=false,this.device._shadersDirty=false,t._shaderVersion++;}this.updateFrameUniforms(),this.updateCpuSkinMatrices(l6),l8.length=0,l6.length=0;let a=this.lights,n=a.length;for(let e=0;e<n;e++)a[e].beginFrame();}updateLightTextureAtlas(){this.lightTextureAtlas.update(this.localLights,this.scene.lighting);}updateLayerComposition(e){let t=e.layerList.length,i=this.scene._shaderVersion;for(let s=0;s<t;s++)e.layerList[s]._shaderVersion=i;e._update();}frameUpdate(){this.clustersDebugRendered=false,this.initViewBindGroupFormat(this.scene.clusteredLightingEnabled),this.dirLightShadows.clear();}constructor(e,t){this.clustersDebugRendered=false,this.processingMeshInstances=new Set,this.lights=[],this.localLights=[],this.cameraDirShadowLights=new Map,this.dirLightShadows=new Map,this.blueNoise=new li(123),this.gsplatDirector=null,this.device=e,this.scene=t,this.worldClustersAllocator=new lO(e),this.lightTextureAtlas=new lu(e),this.shadowMapCache=new l_,this.shadowRenderer=new lL(this,this.lightTextureAtlas),this._shadowRendererLocal=new lv(this,this.shadowRenderer),this._shadowRendererDirectional=new lb(this,this.shadowRenderer),this.scene.clusteredLightingEnabled&&(this._renderPassUpdateClustered=new lU(this.device,this,this.shadowRenderer,this._shadowRendererLocal,this.lightTextureAtlas)),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this._skinTime=0,this._morphTime=0,this._cullTime=0,this._shadowMapTime=0,this._lightClustersTime=0,this._layerCompositionUpdateTime=0,this._shadowDrawCalls=0,this._skinDrawCalls=0,this._instancedDrawCalls=0,this._shadowMapUpdates=0,this._numDrawCallsCulled=0,this._camerasRendered=0,this._lightClusters=0,this._gsplatCount=0;let i=e.scope;this.boneTextureId=i.resolve("texture_poseMap"),this.modelMatrixId=i.resolve("matrix_model"),this.normalMatrixId=i.resolve("matrix_normal"),this.viewInvId=i.resolve("matrix_viewInverse"),this.viewPos=new Float32Array(3),this.viewPosId=i.resolve("view_position"),this.projId=i.resolve("matrix_projection"),this.projSkyboxId=i.resolve("matrix_projectionSkybox"),this.viewId=i.resolve("matrix_view"),this.viewId3=i.resolve("matrix_view3"),this.viewProjId=i.resolve("matrix_viewProjection"),this.flipYId=i.resolve("projectionFlipY"),this.tbnBasis=i.resolve("tbnBasis"),this.cameraParams=new Float32Array(4),this.cameraParamsId=i.resolve("camera_params"),this.viewportSize=new Float32Array(4),this.viewportSizeId=i.resolve("viewport_size"),this.viewIndexId=i.resolve("view_index"),this.viewIndexId.setValue(0),this.blueNoiseJitterVersion=0,this.blueNoiseJitterVec=new ep,this.blueNoiseJitterData=new Float32Array(4),this.blueNoiseJitterId=i.resolve("blueNoiseJitter"),this.blueNoiseTextureId=i.resolve("blueNoiseTex32"),this.alphaTestId=i.resolve("alpha_ref"),this.opacityMapId=i.resolve("texture_opacityMap"),this.exposureId=i.resolve("exposure"),this.twoSidedLightingNegScaleFactorId=i.resolve("twoSidedLightingNegScaleFactor"),this.twoSidedLightingNegScaleFactorId.setValue(0),this.morphPositionTex=i.resolve("morphPositionTex"),this.morphNormalTex=i.resolve("morphNormalTex"),this.morphTexParams=i.resolve("morph_tex_params"),this.lightCube=new lr,this.constantLightCube=i.resolve("lightCube[0]");}}class l7{destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy();}),this.viewBindGroups.length=0;}setupClears(e,t){this.clearColor=e?.clearColorBuffer||t.clearColorBuffer,this.clearDepth=e?.clearDepthBuffer||t.clearDepthBuffer,this.clearStencil=e?.clearStencilBuffer||t.clearStencilBuffer;}constructor(){this.camera=null,this.layer=null,this.transparent=false,this.renderTarget=null,this.lightClusters=null,this.clearColor=false,this.clearDepth=false,this.clearStencil=false,this.triggerPostprocess=false,this.firstCameraUse=false,this.lastCameraUse=false,this.viewBindGroups=[],this.useCameraPasses=false;}}class he extends as{get rendersAnything(){return this.renderActions.length>0}addRenderAction(e){this.renderActions.push(e);}addLayer(e,t,i,s=true){let r=new l7;if(r.renderTarget=this.renderTarget,r.camera=e,r.layer=t,r.transparent=i,s){let i=0===this.renderActions.length;r.setupClears(i?e:void 0,t);}this.addRenderAction(r);}addLayers(e,t,i,s,r,a=true){let{layerList:n,subLayerList:o}=e,l=s,h=i;for(;h<n.length;){let e=n[h],i=o[h];if(t.camera.layersSet.has(e.id)&&(this.addLayer(t,e,i,l),l=false),h++,e.id===r&&i===a)break}return h}updateDirectionalShadows(){let{renderer:e,renderActions:t}=this;for(let i=0;i<t.length;i++){let s=t[i].camera.camera,r=this.renderer.cameraDirShadowLights.get(s);if(r)for(let t=0;t<r.length;t++){let i=r[t];if(e.dirLightShadows.get(i)!==s){e.dirLightShadows.set(i,s);let t=e._shadowRendererDirectional.getLightRenderPass(i,s);t&&this.beforePasses.push(t);}}}}updateClears(){let e=this.renderActions[0];if(e){let t=e.camera.camera,i=t.fullSizeClearRect;this.setClearColor(i&&e.clearColor?t.clearColor:void 0),this.setClearDepth(i&&e.clearDepth&&!this.noDepthClear?t.clearDepth:void 0),this.setClearStencil(i&&e.clearStencil?t.clearStencil:void 0);}}frameUpdate(){super.frameUpdate(),this.updateDirectionalShadows(),this.updateClears();}before(){let{renderActions:e}=this;for(let t=0;t<e.length;t++){let i=e[t];i.firstCameraUse&&this.scene.fire(nA,i.camera);}}execute(){let{layerComposition:e,renderActions:t}=this;for(let i=0;i<t.length;i++){let s=t[i],r=s.layer;e.isEnabled(r,s.transparent)&&this.renderRenderAction(s,0===i);}}after(){for(let e=0;e<this.renderActions.length;e++){let t=this.renderActions[e];t.lastCameraUse&&this.scene.fire(nC,t.camera);}this.beforePasses.length=0;}renderRenderAction(e,t){let{renderer:i,scene:s}=this,r=i.device,{layer:a,transparent:n,camera:o}=e;if(o){let l=o.gammaCorrection,h=o.toneMapping;void 0!==this.gammaCorrection&&(o.gammaCorrection=this.gammaCorrection),void 0!==this.toneMapping&&(o.toneMapping=this.toneMapping),s.fire(nP,o,a,n);let c={lightClusters:e.lightClusters},d=o.camera.shaderPassInfo?.index??0;t&&o.camera.fullSizeClearRect||(c.clearColor=e.clearColor,c.clearDepth=e.clearDepth,c.clearStencil=e.clearStencil);let u=e.renderTarget??r.backBuffer;i.renderForwardLayer(o.camera,u,a,n,d,e.viewBindGroups,c),r.setBlendState(iS.NOBLEND),r.setStencilState(null,null),r.setAlphaToCoverage(false),s.fire(nI,o,a,n),void 0!==this.gammaCorrection&&(o.gammaCorrection=l),void 0!==this.toneMapping&&(o.toneMapping=h);}}constructor(e,t,i,s){super(e),this.renderActions=[],this.noDepthClear=false,this.layerComposition=t,this.scene=i,this.renderer=s;}}class ht extends as{execute(){this.renderAction.camera.onPostprocessing();}constructor(e,t,i){super(e),this.renderer=t,this.renderAction=i,this.requiresCubemaps=false;}}let hi=[[],[],[]],hs=new es,hr={drawCalls:[],shaderInstances:[],isNewMaterial:[],lightMaskChanged:[],clear:function(){this.drawCalls.length=0,this.shaderInstances.length=0,this.isNewMaterial.length=0,this.lightMaskChanged.length=0;}};class ha extends l9{destroy(){super.destroy();}dispatchGlobalLights(e){let t=this.ambientColor;if(hs.linear(e.ambientLight),t[0]=hs.r,t[1]=hs.g,t[2]=hs.b,e.physicalUnits)for(let i=0;i<3;i++)t[i]*=e.ambientLuminance;this.ambientId.setValue(t),this.skyboxIntensityId.setValue(e.physicalUnits?e.skyboxLuminance:e.skyboxIntensity),this.cubeMapRotationMatrixId.setValue(e._skyboxRotationMat3.data);}_resolveLight(e,t){let i=`light${t}`;this.lightColorId[t]=e.resolve(`${i}_color`),this.lightDir[t]=new Float32Array(3),this.lightDirId[t]=e.resolve(`${i}_direction`),this.lightShadowMapId[t]=e.resolve(`${i}_shadowMap`),this.lightShadowMatrixId[t]=e.resolve(`${i}_shadowMatrix`),this.lightShadowParamsId[t]=e.resolve(`${i}_shadowParams`),this.lightShadowIntensity[t]=e.resolve(`${i}_shadowIntensity`),this.lightShadowSearchAreaId[t]=e.resolve(`${i}_shadowSearchArea`),this.lightRadiusId[t]=e.resolve(`${i}_radius`),this.lightPos[t]=new Float32Array(3),this.lightPosId[t]=e.resolve(`${i}_position`),this.lightWidth[t]=new Float32Array(3),this.lightWidthId[t]=e.resolve(`${i}_halfWidth`),this.lightHeight[t]=new Float32Array(3),this.lightHeightId[t]=e.resolve(`${i}_halfHeight`),this.lightInAngleId[t]=e.resolve(`${i}_innerConeAngle`),this.lightOutAngleId[t]=e.resolve(`${i}_outerConeAngle`),this.lightCookieId[t]=e.resolve(`${i}_cookie`),this.lightCookieIntId[t]=e.resolve(`${i}_cookieIntensity`),this.lightCookieMatrixId[t]=e.resolve(`${i}_cookieMatrix`),this.lightCookieOffsetId[t]=e.resolve(`${i}_cookieOffset`),this.lightCameraParamsId[t]=e.resolve(`${i}_cameraParams`),this.lightSoftShadowParamsId[t]=e.resolve(`${i}_softShadowParams`),this.shadowMatrixPaletteId[t]=e.resolve(`${i}_shadowMatrixPalette[0]`),this.shadowCascadeDistancesId[t]=e.resolve(`${i}_shadowCascadeDistances`),this.shadowCascadeCountId[t]=e.resolve(`${i}_shadowCascadeCount`),this.shadowCascadeBlendId[t]=e.resolve(`${i}_shadowCascadeBlend`);}setLTCDirectionalLight(e,t,i,s,r){this.lightPos[t][0]=s.x-i.x*r,this.lightPos[t][1]=s.y-i.y*r,this.lightPos[t][2]=s.z-i.z*r,this.lightPosId[t].setValue(this.lightPos[t]);let a=e.transformVector(new ed(-0.5,0,0));this.lightWidth[t][0]=a.x*r,this.lightWidth[t][1]=a.y*r,this.lightWidth[t][2]=a.z*r,this.lightWidthId[t].setValue(this.lightWidth[t]);let n=e.transformVector(new ed(0,0,.5));this.lightHeight[t][0]=n.x*r,this.lightHeight[t][1]=n.y*r,this.lightHeight[t][2]=n.z*r,this.lightHeightId[t].setValue(this.lightHeight[t]);}dispatchDirectLights(e,t,i){let s=0,r=this.device.scope;for(let a=0;a<e.length;a++){if(!(e[a].mask&t))continue;let n=e[a],o=n._node.getWorldTransform();if(this.lightColorId[s]||this._resolveLight(r,s),this.lightColorId[s].setValue(n._colorLinear),o.getY(n._direction).mulScalar(-1),n._direction.normalize(),this.lightDir[s][0]=n._direction.x,this.lightDir[s][1]=n._direction.y,this.lightDir[s][2]=n._direction.z,this.lightDirId[s].setValue(this.lightDir[s]),0!==n.shape&&this.setLTCDirectionalLight(o,s,n._direction,i._node.getPosition(),i.farClip),n.castShadows){let e=n.getRenderData(i,0),t=n._getUniformBiasValues(e);this.lightShadowMapId[s].setValue(e.shadowBuffer),this.lightShadowMatrixId[s].setValue(e.shadowMatrix.data),this.shadowMatrixPaletteId[s].setValue(n._shadowMatrixPalette),this.shadowCascadeDistancesId[s].setValue(n._shadowCascadeDistances),this.shadowCascadeCountId[s].setValue(n.numCascades),this.shadowCascadeBlendId[s].setValue(1-n.cascadeBlend),this.lightShadowIntensity[s].setValue(n.shadowIntensity),this.lightSoftShadowParamsId[s].setValue(n._softShadowParams),e.shadowCamera.renderTarget&&this.lightShadowSearchAreaId[s].setValue(n.penumbraSize/e.shadowCamera.renderTarget.width*e.projectionCompensation);let r=n._shadowCameraParams;r.length=4,r[0]=0,r[1]=e.shadowCamera._farClip,r[2]=e.shadowCamera._nearClip,r[3]=1,this.lightCameraParamsId[s].setValue(r);let a=n._shadowRenderParams;a.length=4,a[0]=n._shadowResolution,a[1]=t.normalBias,a[2]=t.bias,a[3]=0,this.lightShadowParamsId[s].setValue(a);}s++;}return s}setLTCPositionalLight(e,t){let i=e.transformVector(new ed(-0.5,0,0));this.lightWidth[t][0]=i.x,this.lightWidth[t][1]=i.y,this.lightWidth[t][2]=i.z,this.lightWidthId[t].setValue(this.lightWidth[t]);let s=e.transformVector(new ed(0,0,.5));this.lightHeight[t][0]=s.x,this.lightHeight[t][1]=s.y,this.lightHeight[t][2]=s.z,this.lightHeightId[t].setValue(this.lightHeight[t]);}dispatchOmniLight(e,t,i){let s=t._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(e,i),this.lightRadiusId[i].setValue(t.attenuationEnd),this.lightColorId[i].setValue(t._colorLinear),s.getTranslation(t._position),this.lightPos[i][0]=t._position.x,this.lightPos[i][1]=t._position.y,this.lightPos[i][2]=t._position.z,this.lightPosId[i].setValue(this.lightPos[i]),0!==t.shape&&this.setLTCPositionalLight(s,i),t.castShadows){let e=t.getRenderData(null,0);this.lightShadowMapId[i].setValue(e.shadowBuffer);let s=t._getUniformBiasValues(e),r=t._shadowRenderParams;r.length=4,r[0]=t._shadowResolution,r[1]=s.normalBias,r[2]=s.bias,r[3]=1/t.attenuationEnd,this.lightShadowParamsId[i].setValue(r),this.lightShadowIntensity[i].setValue(t.shadowIntensity);let a=t.penumbraSize/e.shadowCamera.renderTarget.width;this.lightShadowSearchAreaId[i].setValue(a);let n=t._shadowCameraParams;n.length=4,n[0]=0,n[1]=e.shadowCamera._farClip,n[2]=e.shadowCamera._nearClip,n[3]=0,this.lightCameraParamsId[i].setValue(n);}t._cookie&&(this.lightCookieId[i].setValue(t._cookie),this.lightShadowMatrixId[i].setValue(s.data),this.lightCookieIntId[i].setValue(t.cookieIntensity));}dispatchSpotLight(e,t,i){let s=t._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(e,i),this.lightInAngleId[i].setValue(t._innerConeAngleCos),this.lightOutAngleId[i].setValue(t._outerConeAngleCos),this.lightRadiusId[i].setValue(t.attenuationEnd),this.lightColorId[i].setValue(t._colorLinear),s.getTranslation(t._position),this.lightPos[i][0]=t._position.x,this.lightPos[i][1]=t._position.y,this.lightPos[i][2]=t._position.z,this.lightPosId[i].setValue(this.lightPos[i]),0!==t.shape&&this.setLTCPositionalLight(s,i),s.getY(t._direction).mulScalar(-1),t._direction.normalize(),this.lightDir[i][0]=t._direction.x,this.lightDir[i][1]=t._direction.y,this.lightDir[i][2]=t._direction.z,this.lightDirId[i].setValue(this.lightDir[i]),t.castShadows){let e=t.getRenderData(null,0);this.lightShadowMapId[i].setValue(e.shadowBuffer),this.lightShadowMatrixId[i].setValue(e.shadowMatrix.data);let s=t._getUniformBiasValues(e),r=t._shadowRenderParams;r.length=4,r[0]=t._shadowResolution,r[1]=s.normalBias,r[2]=s.bias,r[3]=1/t.attenuationEnd,this.lightShadowParamsId[i].setValue(r),this.lightShadowIntensity[i].setValue(t.shadowIntensity);let a=t.penumbraSize/e.shadowCamera.renderTarget.width,n=1/Math.tan(e.shadowCamera._fov*ei.DEG_TO_RAD/2);this.lightShadowSearchAreaId[i].setValue(a*n);let o=t._shadowCameraParams;o.length=4,o[0]=0,o[1]=e.shadowCamera._farClip,o[2]=e.shadowCamera._nearClip,o[3]=0,this.lightCameraParamsId[i].setValue(o);}if(t._cookie){if(!t.castShadows){let e=oj.evalSpotCookieMatrix(t);this.lightShadowMatrixId[i].setValue(e.data);}this.lightCookieId[i].setValue(t._cookie),this.lightCookieIntId[i].setValue(t.cookieIntensity),t._cookieTransform&&(t._cookieTransformUniform[0]=t._cookieTransform.x,t._cookieTransformUniform[1]=t._cookieTransform.y,t._cookieTransformUniform[2]=t._cookieTransform.z,t._cookieTransformUniform[3]=t._cookieTransform.w,this.lightCookieMatrixId[i].setValue(t._cookieTransformUniform),t._cookieOffsetUniform[0]=t._cookieOffset.x,t._cookieOffsetUniform[1]=t._cookieOffset.y,this.lightCookieOffsetId[i].setValue(t._cookieOffsetUniform));}}dispatchLocalLights(e,t,i){let s=i,r=this.device.scope,a=e[1],n=a.length;for(let e=0;e<n;e++){let i=a[e];i.mask&t&&(this.dispatchOmniLight(r,i,s),s++);}let o=e[2],l=o.length;for(let e=0;e<l;e++){let i=o[e];i.mask&t&&(this.dispatchSpotLight(r,i,s),s++);}}renderForwardPrepareMaterials(e,t,i,s,r,a){let n=e.fogParams??this.scene.fog,o=e.shaderParams;o.fog=n.type,o.srgbRenderTarget=t?.isColorBufferSrgb(0)??false;let l=(e,t,i,s)=>{hr.drawCalls.push(e),hr.shaderInstances.push(t),hr.isNewMaterial.push(i),hr.lightMaskChanged.push(s);};hr.clear();let h=this.device,c=this.scene,d=c.clusteredLightingEnabled,u=r?.getLightHash(d)??0,f=null,p,m,_=i.length;for(let e=0;e<_;e++){let t=i[e],r=t.instancingData;if(r&&r.count<=0)continue;t.ensureMaterial(h);let n=t.material,d=t._shaderDefs,_=t.mask;n&&n===f&&d!==p&&(f=null),n!==f&&(this._materialSwitches++,n._scene=c,n.dirty&&(n.updateUniforms(h,c),n.dirty=false));let g=t.getShaderInstance(a,u,c,o,this.viewUniformFormat,this.viewBindGroupFormat,s);l(t,g,n!==f,!f||_!==m),f=n,p=d,m=_;}return hr}renderForwardInternal(e,t,i,s,r,a,n){let o=this.device,l=this.scene,h=1<<s,c=a?-1:1,d=l.clusteredLightingEnabled,u=e.xr?.session&&e.xr.views.list.length?e.xr.views.list:null,f=t.drawCalls.length;for(let s=0;s<f;s++){let a=t.drawCalls[s],l=t.isNewMaterial[s],p=t.lightMaskChanged[s],m=t.shaderInstances[s],_=a.material,g=a.mask;if(m.shader.failed)continue;if(l){if(o.setShader(m.shader,false),_.setParameters(o),p){let t=this.dispatchDirectLights(i[0],g,e);d||this.dispatchLocalLights(i,g,t);}this.alphaTestId.setValue(_.alphaTest),o.setBlendState(_.blendState),o.setDepthState(_.depthState),o.setAlphaToCoverage(_.alphaToCoverage);}this.setupCullMode(e._cullFaces,c,a);let v=a.stencilFront??_.stencilFront,S=a.stencilBack??_.stencilBack;o.setStencilState(v,S),a.setParameters(o,h),o.scope.resolve("meshInstanceId").setValue(a.id);let y=a.mesh;this.setVertexBuffers(o,y),this.setMorphing(o,a.morphInstance),this.setSkinning(o,a);let x=a.instancingData;x&&o.setVertexBuffer(x.vertexBuffer),this.setMeshInstanceMatrices(a,true),this.setupMeshUniformBuffers(m);let T=a.renderStyle,E=y.indexBuffer[T];r?.(a,s);let w=a.getDrawCommands(e);if(u)for(let e=0;e<u.length;e++){let t=u[e];if(o.setViewport(t.viewport.x,t.viewport.y,t.viewport.z,t.viewport.w),o.supportsUniformBuffers){let t=n[e];o.setBindGroup(0,t);}else this.setupViewUniforms(t,e);let i=0===e,s=e===u.length-1;o.draw(y.primitive[T],E,x?.count,w,i,s),this._forwardDrawCalls++,a.instancingData&&this._instancedDrawCalls++;}else o.draw(y.primitive[T],E,x?.count,w),this._forwardDrawCalls++,a.instancingData&&this._instancedDrawCalls++;s<f-1&&!t.isNewMaterial[s+1]&&_.setParameters(o,a.parameters);}}renderForward(e,t,i,s,r,a,n,o,l){let h=this.renderForwardPrepareMaterials(e,t,i,s,n,r);this.renderForwardInternal(e,h,s,r,a,o,l),hr.clear();}renderForwardLayer(e,t,i,s,r,a,n={}){let o,l,{scene:h,device:c}=this,d=h.clusteredLightingEnabled;if(this.setupViewport(e,t),i){i.sortVisible(e,s);let t=i.getCulledInstances(e);o=s?t.transparent:t.opaque,h.immediate.onPreRenderLayer(i,o,s),i.requiresLightCube&&(this.lightCube.update(h.ambientLight,i._lights),this.constantLightCube.setValue(this.lightCube.colors)),l=i.splitLights;}else o=n.meshInstances,l=n.splitLights??hi;d&&((n.lightClusters??this.worldClustersAllocator.empty).activate(),i&&!this.clustersDebugRendered&&h.lighting.debugLayer===i.id&&(this.clustersDebugRendered=true)),h._activeCamera=e;let u=e.fogParams??this.scene.fog;this.setFogConstants(u);let f=this.setCameraUniforms(e,t);c.supportsUniformBuffers&&this.setupViewUniformBuffers(a,this.viewUniformFormat,this.viewBindGroupFormat,f);let p=n.clearColor??false,m=n.clearDepth??false,_=n.clearStencil??false;(p||m||_)&&this.clear(e,p,m,_);let g=!!(e._flipFaces^t?.flipY),v=this._forwardDrawCalls;this.renderForward(e,t,o,l,r,null,i,g,a),i&&(i._forwardDrawCalls+=this._forwardDrawCalls-v);}setFogConstants(e){if(e.type!==a6){hs.linear(e.color);let t=this.fogColor;t[0]=hs.r,t[1]=hs.g,t[2]=hs.b,this.fogColorId.setValue(t),e.type===a9?(this.fogStartId.setValue(e.start),this.fogEndId.setValue(e.end)):this.fogDensityId.setValue(e.density);}}setSceneConstants(){let e=this.scene;this.dispatchGlobalLights(e);let t=this.device;this._screenSize[0]=t.width,this._screenSize[1]=t.height,this._screenSize[2]=1/t.width,this._screenSize[3]=1/t.height,this.screenSizeId.setValue(this._screenSize),this.pcssDiskSamplesId.setValue(this.pcssDiskSamples),this.pcssSphereSamplesId.setValue(this.pcssSphereSamples);}buildFrameGraph(e,t){let i=this.scene;if(e.reset(),i.clusteredLightingEnabled){let{shadowsEnabled:t,cookiesEnabled:s}=i.lighting;this._renderPassUpdateClustered.update(e,t,s,this.lights,this.localLights),e.addRenderPass(this._renderPassUpdateClustered);}else this._shadowRendererLocal.buildNonClusteredRenderPasses(e,this.localLights);let s=0,r=true,a=null,n=t._renderActions;for(let i=s;i<n.length;i++){let o=n[i],{layer:l,camera:h}=o;if(o.useCameraPasses)h.camera.renderPasses.forEach(t=>{e.addRenderPass(t);});else {let c=1===l.id,d=c&&(h.renderSceneColorMap||h.renderSceneDepthMap);r&&(r=false,s=i,a=o.renderTarget);let u=n[i+1],f=!!u&&!u.useCameraPasses&&1===u.layer.id&&(h.renderSceneColorMap||h.renderSceneDepthMap),p=!!u&&u.firstCameraUse&&this.cameraDirShadowLights.has(u.camera.camera);if(!u||u.renderTarget!==a||p||f||d){if(c&&s===i||this.addMainRenderPass(e,t,a,s,i),c){if(h.renderSceneColorMap){let t=h.camera.renderPassColorGrab;t.source=h.renderTarget,e.addRenderPass(t);}h.renderSceneDepthMap&&e.addRenderPass(h.camera.renderPassDepthGrab);}if(o.triggerPostprocess&&h?.onPostprocessing){let t=new ht(this.device,this,o);e.addRenderPass(t);}r=true;}}}}addMainRenderPass(e,t,i,s,r){let a=new he(this.device,t,this.scene,this);a.init(i);let n=t._renderActions;for(let e=s;e<=r;e++)a.addRenderAction(n[e]);e.addRenderPass(a);}update(e){this.frameUpdate(),this.shadowRenderer.frameUpdate(),this.scene._updateSkyMesh(),this.updateLayerComposition(e),this.collectLights(e),this.beginFrame(e),this.setSceneConstants(),this.gsplatDirector?.update(e),this.cullComposition(e),this.gpuUpdate(this.processingMeshInstances);}constructor(e,t){super(e,t);let i=this.device;this._forwardDrawCalls=0,this._materialSwitches=0,this._depthMapTime=0,this._forwardTime=0,this._sortTime=0;let s=i.scope;this.fogColorId=s.resolve("fog_color"),this.fogStartId=s.resolve("fog_start"),this.fogEndId=s.resolve("fog_end"),this.fogDensityId=s.resolve("fog_density"),this.ambientId=s.resolve("light_globalAmbient"),this.skyboxIntensityId=s.resolve("skyboxIntensity"),this.cubeMapRotationMatrixId=s.resolve("cubeMapRotationMatrix"),this.pcssDiskSamplesId=s.resolve("pcssDiskSamples[0]"),this.pcssSphereSamplesId=s.resolve("pcssSphereSamples[0]"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightShadowIntensity=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightWidth=[],this.lightWidthId=[],this.lightHeight=[],this.lightHeightId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.lightShadowSearchAreaId=[],this.lightCameraParamsId=[],this.lightSoftShadowParamsId=[],this.shadowMatrixPaletteId=[],this.shadowCascadeDistancesId=[],this.shadowCascadeCountId=[],this.shadowCascadeBlendId=[],this.screenSizeId=s.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.pcssDiskSamples=function(e){let t=[];for(let e=0;e<16;++e){let i=Math.sqrt(e+.5)/Math.sqrt(16);t.push(i);}return t}(),this.pcssSphereSamples=function(e){let t=[];for(let e=0;e<16;e++){let i=e/16,s=Math.sqrt(i*i);t.push(s);}return t}();}}let hn=0,ho=[],hl=new Set,hh=[null,function(e,t){return e.drawOrder-t.drawOrder},function(e,t){let i=e._sortKeyForward,s=t._sortKeyForward;return i===s?t.mesh.id-e.mesh.id:s-i},function(e,t){return t._sortKeyDynamic-e._sortKeyDynamic},function(e,t){return e._sortKeyDynamic-t._sortKeyDynamic}];class hc{constructor(){this.opaque=[],this.transparent=[];}}class hd{set enabled(e){e!==this._enabled&&(this._dirtyComposition=true,this.gsplatPlacementsDirty=true,this._enabled=e,e?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()));}get enabled(){return this._enabled}set clearColorBuffer(e){this._clearColorBuffer=e,this._dirtyComposition=true;}get clearColorBuffer(){return this._clearColorBuffer}set clearDepthBuffer(e){this._clearDepthBuffer=e,this._dirtyComposition=true;}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencilBuffer(e){this._clearStencilBuffer=e,this._dirtyComposition=true;}get clearStencilBuffer(){return this._clearStencilBuffer}get hasClusteredLights(){return this._clusteredLightsSet.size>0}get clusteredLightsSet(){return this._clusteredLightsSet}incrementCounter(){0===this._refCounter&&(this._enabled=true,this.onEnable&&this.onEnable()),this._refCounter++;}decrementCounter(){if(1===this._refCounter)this._enabled=false,this.onDisable&&this.onDisable();else if(0===this._refCounter)return;this._refCounter--;}addGSplatPlacement(e){this.gsplatPlacementsSet.has(e)||(this.gsplatPlacements.push(e),this.gsplatPlacementsSet.add(e),this.gsplatPlacementsDirty=true);}removeGSplatPlacement(e){let t=this.gsplatPlacements.indexOf(e);t>=0&&(this.gsplatPlacements.splice(t,1),this.gsplatPlacementsSet.delete(e),this.gsplatPlacementsDirty=true);}addGSplatShadowCaster(e){this.gsplatShadowCastersSet.has(e)||(this.gsplatShadowCasters.push(e),this.gsplatShadowCastersSet.add(e),this.gsplatPlacementsDirty=true);}removeGSplatShadowCaster(e){let t=this.gsplatShadowCasters.indexOf(e);t>=0&&(this.gsplatShadowCasters.splice(t,1),this.gsplatShadowCastersSet.delete(e),this.gsplatPlacementsDirty=true);}addMeshInstances(e,t){let i=this.meshInstances,s=this.meshInstancesSet;for(let t=0;t<e.length;t++){let r=e[t];s.has(r)||(i.push(r),s.add(r),hl.add(r.material));}if(t||this.addShadowCasters(e),hl.size>0){let e=this._shaderVersion;hl.forEach(t=>{e>=0&&t._shaderVersion!==e&&(t.getShaderVariant!==lm.prototype.getShaderVariant&&t.clearVariants(),t._shaderVersion=e);}),hl.clear();}}removeMeshInstances(e,t){let i=this.meshInstances,s=this.meshInstancesSet;for(let t=0;t<e.length;t++){let r=e[t];if(s.has(r)){s.delete(r);let e=i.indexOf(r);e>=0&&i.splice(e,1);}}t||this.removeShadowCasters(e);}addShadowCasters(e){let t=this.shadowCasters,i=this.shadowCastersSet;for(let s=0;s<e.length;s++){let r=e[s];r.castShadow&&!i.has(r)&&(i.add(r),t.push(r));}}removeShadowCasters(e){let t=this.shadowCasters,i=this.shadowCastersSet;for(let s=0;s<e.length;s++){let r=e[s];if(i.has(r)){i.delete(r);let e=t.indexOf(r);e>=0&&t.splice(e,1);}}}clearMeshInstances(e=false){this.meshInstances.length=0,this.meshInstancesSet.clear(),e||(this.shadowCasters.length=0,this.shadowCastersSet.clear());}markLightsDirty(){this._lightHashDirty=true,this._lightIdHashDirty=true,this._splitLightsDirty=true;}hasLight(e){return this._lightsSet.has(e)}addLight(e){let t=e.light;this._lightsSet.has(t)||(this._lightsSet.add(t),this._lights.push(t),this.markLightsDirty()),0!==t.type&&this._clusteredLightsSet.add(t);}removeLight(e){let t=e.light;this._lightsSet.has(t)&&(this._lightsSet.delete(t),this._lights.splice(this._lights.indexOf(t),1),this.markLightsDirty()),0!==t.type&&this._clusteredLightsSet.delete(t);}clearLights(){this._lightsSet.forEach(e=>e.removeLayer(this)),this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this.markLightsDirty();}get splitLights(){if(this._splitLightsDirty){this._splitLightsDirty=false;let e=this._splitLights;for(let t=0;t<e.length;t++)e[t].length=0;let t=this._lights;for(let i=0;i<t.length;i++){let s=t[i];s.enabled&&e[s._type].push(s);}for(let t=0;t<e.length;t++)e[t].sort((e,t)=>e.key-t.key);}return this._splitLights}evaluateLightHash(e,t,i){let s=0,r=this._lights;for(let s=0;s<r.length;s++){let a=0!==r[s].type;(e&&a||t&&!a)&&ho.push(i?r[s].id:r[s].key);}return ho.length>0&&(ho.sort(),s=iD(ho),ho.length=0),s}getLightHash(e){return this._lightHashDirty&&(this._lightHashDirty=false,this._lightHash=this.evaluateLightHash(!e,true,false)),this._lightHash}getLightIdHash(){return this._lightIdHashDirty&&(this._lightIdHashDirty=false,this._lightIdHash=this.evaluateLightHash(true,false,true)),this._lightIdHash}addCamera(e){this.camerasSet.has(e.camera)||(this.camerasSet.add(e.camera),this.cameras.push(e),this._dirtyComposition=true);}removeCamera(e){if(this.camerasSet.has(e.camera)){this.camerasSet.delete(e.camera);let t=this.cameras.indexOf(e);this.cameras.splice(t,1),this._dirtyComposition=true;}}clearCameras(){this.cameras.length=0,this.camerasSet.clear(),this._dirtyComposition=true;}_calculateSortDistances(e,t,i){let s=e.length,{x:r,y:a,z:n}=t,{x:o,y:l,z:h}=i;for(let c=0;c<s;c++){let s,d=e[c];if(d.calculateSortDistance)s=d.calculateSortDistance(d,t,i);else {let e=d.aabb.center;s=(e.x-r)*o+(e.y-a)*l+(e.z-n)*h;}let u=1e9*d._drawBucket;d._sortKeyDynamic=u+s;}}getCulledInstances(e){let t=this._visibleInstances.get(e);return t||(t=new hc,this._visibleInstances.set(e,t)),t}sortVisible(e,t){let i=t?this.transparentSortMode:this.opaqueSortMode;if(0===i)return;let s=this.getCulledInstances(e),r=t?s.transparent:s.opaque,a=e.node;if(5===i){let e=a.getPosition(),t=a.forward;this.customCalculateSortValues&&this.customCalculateSortValues(r,r.length,e,t),this.customSortCallback&&r.sort(this.customSortCallback);}else {if(3===i||4===i){let e=a.getPosition(),t=a.forward;this._calculateSortDistances(r,e,t);}r.sort(hh[i]);}}constructor(e={}){this.meshInstances=[],this.meshInstancesSet=new Set,this.shadowCasters=[],this.shadowCastersSet=new Set,this._visibleInstances=new WeakMap,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this._splitLightsDirty=true,this.requiresLightCube=false,this.cameras=[],this.camerasSet=new Set,this.gsplatPlacements=[],this.gsplatPlacementsSet=new Set,this.gsplatShadowCasters=[],this.gsplatShadowCastersSet=new Set,this.gsplatPlacementsDirty=true,this._dirtyComposition=false,void 0!==e.id?(this.id=e.id,hn=Math.max(this.id+1,hn)):this.id=hn++,this.name=e.name,this._enabled=e.enabled??true,this._refCounter=+!!this._enabled,this.opaqueSortMode=e.opaqueSortMode??2,this.transparentSortMode=e.transparentSortMode??3,e.renderTarget&&(this.renderTarget=e.renderTarget),this._clearColorBuffer=!!e.clearColorBuffer,this._clearDepthBuffer=!!e.clearDepthBuffer,this._clearStencilBuffer=!!e.clearStencilBuffer,this.onEnable=e.onEnable,this.onDisable=e.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.customSortCallback=null,this.customCalculateSortValues=null,this._lightHash=0,this._lightHashDirty=false,this._lightIdHash=0,this._lightIdHashDirty=false,this._shaderVersion=-1;}}let hu=(e,t)=>e.priority-t.priority;class hf extends X{destroy(){this.destroyRenderActions();}destroyRenderActions(){this._renderActions.forEach(e=>e.destroy()),this._renderActions.length=0;}markDirty(){this._dirty=true;}_update(){let e=this.layerList.length;if(!this._dirty){for(let t=0;t<e;t++)if(this.layerList[t]._dirtyComposition){this._dirty=true;break}}if(this._dirty){this._dirty=false,this.cameras.length=0,this.camerasSet.clear();for(let t=0;t<e;t++){let e=this.layerList[t];e._dirtyComposition=false;for(let t=0;t<e.cameras.length;t++){let i=e.cameras[t];this.camerasSet.has(i.camera)||(this.camerasSet.add(i.camera),this.cameras.push(i));}}this.cameras.length>1&&this.cameras.sort(hu);let t=0;this.destroyRenderActions();for(let i=0;i<this.cameras.length;i++){let s=this.cameras[i];if(s.camera.renderPasses.length>0){this.addDummyRenderAction(t,s),t++;continue}let r=true,a=t,n=null,o=false;for(let i=0;i<e;i++){let e=this.layerList[i];if(e.enabled&&this.subLayerEnabled[i]&&e.cameras.length>0&&s.layers.indexOf(e.id)>=0){!o&&e.id===s.disablePostEffectsLayer&&(o=true,n&&(n.triggerPostprocess=true));let a=this.subLayerList[i];n=this.addRenderAction(t,e,a,s,r,o),t++,r=false;}}a<t&&(n.lastCameraUse=true),!o&&n&&(n.triggerPostprocess=true),s.renderTarget&&s.postEffectsEnabled&&this.propagateRenderTarget(a-1,s);}this._logRenderActions();}}getNextRenderAction(e){let t=new l7;return this._renderActions.push(t),t}addDummyRenderAction(e,t){let i=this.getNextRenderAction(e);i.camera=t,i.useCameraPasses=true;}addRenderAction(e,t,i,s,r,a){let n=1!==t.id?s.renderTarget:null,o=false,l=this._renderActions;for(let t=e-1;t>=0;t--)if(l[t].camera===s&&l[t].renderTarget===n){o=true;break}a&&s.postEffectsEnabled&&(n=null);let h=this.getNextRenderAction(e);h.triggerPostprocess=false,h.layer=t,h.transparent=i,h.camera=s,h.renderTarget=n,h.firstCameraUse=r,h.lastCameraUse=false;let c=r||!o,d=t.clearColorBuffer||t.clearDepthBuffer||t.clearStencilBuffer;return (c||d)&&h.setupClears(c?s:void 0,t),h}propagateRenderTarget(e,t){for(let i=e;i>=0;i--){let e=this._renderActions[i],s=e.layer;if(e.renderTarget&&1!==s.id)break;if(1===s.id)continue;if(e.useCameraPasses)break;let r=e?.camera.camera;if(r&&(!t.camera.rect.equals(r.rect)||!t.camera.scissorRect.equals(r.scissorRect)))break;e.renderTarget=t.renderTarget;}}_logRenderActions(){}_isLayerAdded(e){return this.layerIdMap.get(e.id)===e}_isSublayerAdded(e,t){return void 0!==(t?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).get(e)}push(e){this._isLayerAdded(e)||(this.layerList.push(e),this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(false)-1,this._transparentOrder[e.id]=this.subLayerList.push(true)-1,this.subLayerEnabled.push(true),this.subLayerEnabled.push(true),this._updateLayerMaps(),this._dirty=true,this.fire("add",e));}insert(e,t){if(this._isLayerAdded(e))return;this.layerList.splice(t,0,e,e),this.subLayerList.splice(t,0,false,true);let i=this.layerList.length;this._updateOpaqueOrder(t,i-1),this._updateTransparentOrder(t,i-1),this.subLayerEnabled.splice(t,0,true,true),this._updateLayerMaps(),this._dirty=true,this.fire("add",e);}remove(e){let t=this.layerList.indexOf(e);for(delete this._opaqueOrder[t],delete this._transparentOrder[t];t>=0;)this.layerList.splice(t,1),this.subLayerList.splice(t,1),this.subLayerEnabled.splice(t,1),t=this.layerList.indexOf(e),this._dirty=true,this.fire("remove",e);let i=this.layerList.length;this._updateOpaqueOrder(0,i-1),this._updateTransparentOrder(0,i-1),this._updateLayerMaps();}pushOpaque(e){this._isSublayerAdded(e,false)||(this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(false)-1,this.subLayerEnabled.push(true),this._updateLayerMaps(),this._dirty=true,this.fire("add",e));}insertOpaque(e,t){if(this._isSublayerAdded(e,false))return;this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,false);let i=this.subLayerList.length;this._updateOpaqueOrder(t,i-1),this.subLayerEnabled.splice(t,0,true),this._updateLayerMaps(),this._dirty=true,this.fire("add",e);}removeOpaque(e){for(let t=0,i=this.layerList.length;t<i;t++)if(this.layerList[t]===e&&!this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),i--,this._updateOpaqueOrder(t,i-1),this.subLayerEnabled.splice(t,1),this._dirty=true,0>this.layerList.indexOf(e)&&this.fire("remove",e);break}this._updateLayerMaps();}pushTransparent(e){this._isSublayerAdded(e,true)||(this.layerList.push(e),this._transparentOrder[e.id]=this.subLayerList.push(true)-1,this.subLayerEnabled.push(true),this._updateLayerMaps(),this._dirty=true,this.fire("add",e));}insertTransparent(e,t){if(this._isSublayerAdded(e,true))return;this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,true);let i=this.subLayerList.length;this._updateTransparentOrder(t,i-1),this.subLayerEnabled.splice(t,0,true),this._updateLayerMaps(),this._dirty=true,this.fire("add",e);}removeTransparent(e){for(let t=0,i=this.layerList.length;t<i;t++)if(this.layerList[t]===e&&this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),i--,this._updateTransparentOrder(t,i-1),this.subLayerEnabled.splice(t,1),this._dirty=true,0>this.layerList.indexOf(e)&&this.fire("remove",e);break}this._updateLayerMaps();}getOpaqueIndex(e){return this.layerOpaqueIndexMap.get(e)??-1}getTransparentIndex(e){return this.layerTransparentIndexMap.get(e)??-1}isEnabled(e,t){if(e.enabled){let i=t?this.getTransparentIndex(e):this.getOpaqueIndex(e);if(i>=0)return this.subLayerEnabled[i]}return  false}_updateLayerMaps(){this.layerIdMap.clear(),this.layerNameMap.clear(),this.layerOpaqueIndexMap.clear(),this.layerTransparentIndexMap.clear();for(let e=0;e<this.layerList.length;e++){let t=this.layerList[e];this.layerIdMap.set(t.id,t),this.layerNameMap.set(t.name,t),(this.subLayerList[e]?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).set(t,e);}}getLayerById(e){return this.layerIdMap.get(e)??null}getLayerByName(e){return this.layerNameMap.get(e)??null}_updateOpaqueOrder(e,t){for(let i=e;i<=t;i++) false===this.subLayerList[i]&&(this._opaqueOrder[this.layerList[i].id]=i);}_updateTransparentOrder(e,t){for(let i=e;i<=t;i++) true===this.subLayerList[i]&&(this._transparentOrder[this.layerList[i].id]=i);}_sortLayersDescending(e,t,i){let s=-1,r=-1;for(let t=0,r=e.length;t<r;t++){let r=e[t];i.hasOwnProperty(r)&&(s=Math.max(s,i[r]));}for(let e=0,s=t.length;e<s;e++){let s=t[e];i.hasOwnProperty(s)&&(r=Math.max(r,i[s]));}return -1===s&&-1!==r?1:-1===r&&-1!==s?-1:r-s}sortTransparentLayers(e,t){return this._sortLayersDescending(e,t,this._transparentOrder)}sortOpaqueLayers(e,t){return this._sortLayersDescending(e,t,this._opaqueOrder)}constructor(e="Untitled"){super(),this.layerList=[],this.layerIdMap=new Map,this.layerNameMap=new Map,this.layerOpaqueIndexMap=new Map,this.layerTransparentIndexMap=new Map,this.subLayerList=[],this.subLayerEnabled=[],this.cameras=[],this.camerasSet=new Set,this._renderActions=[],this._dirty=false,this.name=e,this._opaqueOrder={},this._transparentOrder={};}}let hp=new ed,hm={bias:0,normalBias:0},h_=new es,hg={r:0,g:1,b:2,a:3},hv={directional:0,omni:1,point:1,spot:2},hS=[[new ep(0,0,1,1)],[new ep(0,0,.5,.5),new ep(0,.5,.5,.5)],[new ep(0,0,.5,.5),new ep(0,.5,.5,.5),new ep(.5,0,.5,.5)],[new ep(0,0,.5,.5),new ep(0,.5,.5,.5),new ep(.5,0,.5,.5),new ep(.5,.5,.5,.5)]],hy={rrr:1,ggg:2,bbb:4,aaa:8,rgb:7},hx=0;class hT{destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy();}),this.viewBindGroups.length=0;}get shadowBuffer(){let e=this.shadowCamera.renderTarget;return e?this.light._isPcf?e.depthBuffer:e.colorBuffer:null}constructor(e,t,i){this.light=i,this.camera=e,this.shadowCamera=lL.createShadowCamera(i._shadowType,i._type,t),this.shadowMatrix=new ey,this.shadowViewport=new ep(0,0,1,1),this.shadowScissor=new ep(0,0,1,1),this.projectionCompensation=0,this.face=t,this.visibleCasters=[],this.viewBindGroups=[];}}class hE{destroy(){this._evtDeviceRestored?.off(),this._evtDeviceRestored=null,this._destroyShadowMap(),this.releaseRenderData(),this._renderData=null;}onDeviceRestored(){0===this.shadowUpdateMode&&(this.shadowUpdateMode=1);}releaseRenderData(){if(this._renderData){for(let e=0;e<this._renderData.length;e++)this._renderData[e].destroy();this._renderData.length=0;}}addLayer(e){this.layers.add(e);}removeLayer(e){this.layers.delete(e);}set shadowSamples(e){this._softShadowParams[0]=e;}get shadowSamples(){return this._softShadowParams[0]}set shadowBlockerSamples(e){this._softShadowParams[1]=e;}get shadowBlockerSamples(){return this._softShadowParams[1]}set shadowBias(e){this._shadowBias!==e&&(this._shadowBias=e,this._updateShadowBias());}get shadowBias(){return this._shadowBias}set numCascades(e){this.cascades&&this.numCascades===e||(this.cascades=hS[e-1],this._shadowMatrixPalette=new Float32Array(64),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey());}get numCascades(){return this.cascades.length}set cascadeBlend(e){this._cascadeBlend!==e&&(this._cascadeBlend=e,this.updateKey());}get cascadeBlend(){return this._cascadeBlend}set shadowMap(e){this._shadowMap!==e&&(this._destroyShadowMap(),this._shadowMap=e);}get shadowMap(){return this._shadowMap}set mask(e){this._mask!==e&&(this._mask=e,this.updateKey(),this.updateClusteredFlags());}get mask(){return this._mask}get numShadowFaces(){let e=this._type;return 0===e?this.numCascades:1===e?6:1}set type(e){if(this._type===e)return;this._type=e,this._destroyShadowMap(),this._updateShadowBias(),this.updateKey(),this.updateClusteredFlags();let t=this._shadowType;this._shadowType=null,this.shadowUpdateOverrides=null,this.shadowType=t;}get type(){return this._type}set shape(e){if(this._shape===e)return;this._shape=e,this._destroyShadowMap(),this.updateKey(),this.updateClusteredFlags();let t=this._shadowType;this._shadowType=null,this.shadowType=t;}get shape(){return this._shape}set usePhysicalUnits(e){this._usePhysicalUnits!==e&&(this._usePhysicalUnits=e,this._updateLinearColor());}get usePhysicalUnits(){return this._usePhysicalUnits}set shadowType(e){if(this._shadowType===e)return;let t=ns.get(e);t||(e=0);let i=this.device;6!==e||i.textureFloatRenderable&&i.textureFloatFilterable||(e=0),1===this._type&&5!==e&&0!==e&&7!==e&&8!==e&&6!==e&&(e=0),3!==e||i.textureFloatRenderable&&i.textureFloatFilterable||(e=2),2!==e||i.textureHalfFloatRenderable||(e=0),t=ns.get(e),this._isVsm=t?.vsm??false,this._isPcf=t?.pcf??false,this._shadowType=e,this._destroyShadowMap(),this.updateKey();}get shadowType(){return this._shadowType}set enabled(e){this._enabled!==e&&(this._enabled=e,this.layersDirty());}get enabled(){return this._enabled}set castShadows(e){this._castShadows!==e&&(this._castShadows=e,this._destroyShadowMap(),this.layersDirty(),this.updateKey());}get castShadows(){return this._castShadows&&4!==this._mask&&0!==this._mask}set shadowIntensity(e){this._shadowIntensity!==e&&(this._shadowIntensity=e,this.updateKey());}get shadowIntensity(){return this._shadowIntensity}get bakeShadows(){return this._castShadows&&4===this._mask}set shadowResolution(e){this._shadowResolution!==e&&(e=1===this._type?Math.min(e,this.device.maxCubeMapSize):Math.min(e,this.device.maxTextureSize),this._shadowResolution=e,this._destroyShadowMap());}get shadowResolution(){return this._shadowResolution}set vsmBlurSize(e){this._vsmBlurSize!==e&&(e%2==0&&e++,this._vsmBlurSize=e);}get vsmBlurSize(){return this._vsmBlurSize}set normalOffsetBias(e){if(this._normalOffsetBias!==e){let t=!this._normalOffsetBias&&e||this._normalOffsetBias&&!e;this._normalOffsetBias=e,t&&this.updateKey();}}get normalOffsetBias(){return this._normalOffsetBias}set falloffMode(e){this._falloffMode!==e&&(this._falloffMode=e,this.updateKey(),this.updateClusteredFlags());}get falloffMode(){return this._falloffMode}set innerConeAngle(e){this._innerConeAngle!==e&&(this._innerConeAngle=e,this._innerConeAngleCos=Math.cos(e*ei.DEG_TO_RAD),this.updateClusterData(false,true),this._usePhysicalUnits&&this._updateLinearColor());}get innerConeAngle(){return this._innerConeAngle}set outerConeAngle(e){this._outerConeAngle!==e&&(this._outerConeAngle=e,this._updateOuterAngle(e),this._usePhysicalUnits&&this._updateLinearColor());}get outerConeAngle(){return this._outerConeAngle}set penumbraSize(e){this._penumbraSize=e,this._softShadowParams[2]=e;}get penumbraSize(){return this._penumbraSize}set penumbraFalloff(e){this._softShadowParams[3]=e;}get penumbraFalloff(){return this._softShadowParams[3]}_updateOuterAngle(e){let t=e*ei.DEG_TO_RAD;this._outerConeAngleCos=Math.cos(t),this._outerConeAngleSin=Math.sin(t),this.updateClusterData(false,true);}set intensity(e){this._intensity!==e&&(this._intensity=e,this._updateLinearColor());}get intensity(){return this._intensity}set affectSpecularity(e){0===this._type&&(this._affectSpecularity=e,this.updateKey());}get affectSpecularity(){return this._affectSpecularity}set luminance(e){this._luminance!==e&&(this._luminance=e,this._updateLinearColor());}get luminance(){return this._luminance}get cookieMatrix(){return this._cookieMatrix||(this._cookieMatrix=new ey),this._cookieMatrix}get atlasViewport(){return this._atlasViewport||(this._atlasViewport=new ep(0,0,1,1)),this._atlasViewport}set cookie(e){this._cookie!==e&&(this._cookie=e,this.updateKey());}get cookie(){return this._cookie}set cookieFalloff(e){this._cookieFalloff!==e&&(this._cookieFalloff=e,this.updateKey());}get cookieFalloff(){return this._cookieFalloff}set cookieChannel(e){if(this._cookieChannel!==e){if(e.length<3){let t=e.charAt(e.length-1),i=3-e.length;for(let s=0;s<i;s++)e+=t;}this._cookieChannel=e,this.updateKey(),this.updateClusteredFlags();}}get cookieChannel(){return this._cookieChannel}set cookieTransform(e){this._cookieTransform!==e&&(this._cookieTransform=e,this._cookieTransformSet=!!e,e&&!this._cookieOffset&&(this.cookieOffset=new ef,this._cookieOffsetSet=false),this.updateKey());}get cookieTransform(){return this._cookieTransform}set cookieOffset(e){this._cookieOffset===e||((this._cookieTransformSet||e)&&!e&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=e,this._cookieOffsetSet=!!e,e&&!this._cookieTransform&&(this.cookieTransform=new ep(1,1,0,0),this._cookieTransformSet=false),this.updateKey());}get cookieOffset(){return this._cookieOffset}beginFrame(){this.visibleThisFrame=0===this._type&&this._enabled,this.maxScreenSize=0,this.atlasViewportAllocated=false,this.atlasSlotUpdated=false;}_destroyShadowMap(){if(this.releaseRenderData(),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),0===this.shadowUpdateMode&&(this.shadowUpdateMode=1),this.shadowUpdateOverrides)for(let e=0;e<this.shadowUpdateOverrides.length;e++)0===this.shadowUpdateOverrides[e]&&(this.shadowUpdateOverrides[e]=1);}getRenderData(e,t){for(let i=0;i<this._renderData.length;i++){let s=this._renderData[i];if(s.camera===e&&s.face===t)return s}let i=new hT(e,t,this);return this._renderData.push(i),i}clone(){let e=new hE(this.device,this.clusteredLighting);return e.type=this._type,e.setColor(this._color),e.intensity=this._intensity,e.affectSpecularity=this._affectSpecularity,e.luminance=this._luminance,e.castShadows=this.castShadows,e._enabled=this._enabled,e.attenuationStart=this.attenuationStart,e.attenuationEnd=this.attenuationEnd,e.falloffMode=this._falloffMode,e.shadowType=this._shadowType,e.vsmBlurSize=this._vsmBlurSize,e.vsmBlurMode=this.vsmBlurMode,e.vsmBias=this.vsmBias,e.shadowUpdateMode=this.shadowUpdateMode,e.mask=this.mask,this.shadowUpdateOverrides&&(e.shadowUpdateOverrides=this.shadowUpdateOverrides.slice()),e.innerConeAngle=this._innerConeAngle,e.outerConeAngle=this._outerConeAngle,e.numCascades=this.numCascades,e.cascadeDistribution=this.cascadeDistribution,e.cascadeBlend=this._cascadeBlend,e.shape=this._shape,e.shadowDepthState.copy(this.shadowDepthState),e.shadowBias=this.shadowBias,e.normalOffsetBias=this._normalOffsetBias,e.shadowResolution=this._shadowResolution,e.shadowDistance=this.shadowDistance,e.shadowIntensity=this.shadowIntensity,e.shadowSamples=this.shadowSamples,e.shadowBlockerSamples=this.shadowBlockerSamples,e.penumbraSize=this.penumbraSize,e.penumbraFalloff=this.penumbraFalloff,e}static getLightUnitConversion(e,t=Math.PI/4,i=0){switch(e){case 2:{let e=Math.cos(i);return 2*Math.PI*(1-e+(e-Math.cos(t))/2)}case 1:return 4*Math.PI;case 0:return 1}}_getUniformBiasValues(e){let t=e.shadowCamera._farClip;switch(this._type){case 1:hm.bias=this.shadowBias,hm.normalBias=this._normalOffsetBias;break;case 2:this._isVsm?hm.bias=-2e-4:hm.bias=20*this.shadowBias,hm.normalBias=this._isVsm?this.vsmBias/(this.attenuationEnd/7):this._normalOffsetBias;break;case 0:this._isVsm?hm.bias=-2e-4:hm.bias=this.shadowBias/t*100,hm.normalBias=this._isVsm?this.vsmBias/(t/7):this._normalOffsetBias;}return hm}getColor(){return this._color}getBoundingSphere(e){if(2===this._type){let t=this.attenuationEnd,i=this._outerConeAngle,s=this._outerConeAngleCos,r=this._node;hp.copy(r.up),i>45?(e.radius=t*this._outerConeAngleSin,hp.mulScalar(-t*s)):(e.radius=t/(2*s),hp.mulScalar(-e.radius)),e.center.add2(r.getPosition(),hp);}else 1===this._type&&(e.center=this._node.getPosition(),e.radius=this.attenuationEnd);}getBoundingBox(e){if(2===this._type){let t=this.attenuationEnd,i=this._outerConeAngle,s=this._node,r=Math.abs(Math.sin(i*ei.DEG_TO_RAD)*t);e.center.set(0,-(.5*t),0),e.halfExtents.set(r,.5*t,r),e.setFromTransformedAabb(e,s.getWorldTransform(),true);}else 1===this._type&&(e.center.copy(this._node.getPosition()),e.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd));}_updateShadowBias(){if(1!==this._type||this.clusteredLighting){let e=-1e3*this.shadowBias;this.shadowDepthState.depthBias=e,this.shadowDepthState.depthBiasSlope=e;}else this.shadowDepthState.depthBias=0,this.shadowDepthState.depthBiasSlope=0;}_updateLinearColor(){let e=this._intensity;this._usePhysicalUnits&&(e=this._luminance/hE.getLightUnitConversion(this._type,this._outerConeAngle*ei.DEG_TO_RAD,this._innerConeAngle*ei.DEG_TO_RAD));let t=this._color,i=this._colorLinear;e>=1?h_.linear(t).mulScalar(e):h_.copy(t).mulScalar(e).linear(),i[0]=h_.r,i[1]=h_.g,i[2]=h_.b,this.updateClusterData(true);}setColor(){1==arguments.length?this._color.set(arguments[0].r,arguments[0].g,arguments[0].b):3==arguments.length&&this._color.set(arguments[0],arguments[1],arguments[2]),this._updateLinearColor();}layersDirty(){this.layers.forEach(e=>{e.hasLight(this)&&e.markLightsDirty();});}updateKey(){let e=this._type<<29|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias)<<22|!!this._cookie<<21|!!this._cookieFalloff<<20|hg[this._cookieChannel.charAt(0)]<<18|!!this._cookieTransform<<12|this._shape<<10|(this.numCascades>0)<<9|(this._cascadeBlend>0)<<8|!!this.affectSpecularity<<7|this.mask<<6|!!this._castShadows<<3;3===this._cookieChannel.length&&(e|=hg[this._cookieChannel.charAt(1)]<<16,e|=hg[this._cookieChannel.charAt(2)]<<14),e!==this.key&&this.layersDirty(),this.key=e;}updateClusteredFlags(){let e=!!(1&this.mask),t=!!(2&this.mask);this.clusteredFlags=(2===this.type)<<30|(3&this._shape)<<28|(1&this._falloffMode)<<27|(hy[this._cookieChannel]??0)<<23|!!e<<22|!!t<<21;}getClusteredFlags(e,t){return this.clusteredFlags|(e?Math.floor(255*this.shadowIntensity):0)&255|((t?Math.floor(255*this.cookieIntensity):0)&255)<<8}updateClusterData(e,t){let{clusteredData16:i}=this,s=eh.float2Half;if(e&&(i[0]=s(ei.clamp(this._colorLinear[0]/100,0,65504)),i[1]=s(ei.clamp(this._colorLinear[1]/100,0,65504)),i[2]=s(ei.clamp(this._colorLinear[2]/100,0,65504))),t){let e=0,t=Math.cos(.99*this._innerConeAngle*ei.DEG_TO_RAD);t>.5&&(t=1-t,e|=1);let r=Math.cos(.99*this._outerConeAngle*ei.DEG_TO_RAD);r>.5&&(r=1-r,e|=2),i[3]=e,i[4]=s(t),i[5]=s(r);}}constructor(e,t){this.layers=new Set,this.shadowDepthState=ix.DEFAULT.clone(),this.clusteredFlags=0,this.clusteredData=new Uint32Array(3),this.clusteredData16=new Uint16Array(this.clusteredData.buffer),this._evtDeviceRestored=null,this.device=e,this.clusteredLighting=t,this.id=hx++,this._evtDeviceRestored=e.on("devicerestored",this.onDeviceRestored,this),this._type=0,this._color=new es(.8,.8,.8),this._intensity=1,this._affectSpecularity=true,this._luminance=0,this._castShadows=false,this._enabled=false,this._mask=1,this.isStatic=false,this.key=0,this.bakeDir=true,this.bakeNumSamples=1,this.bakeArea=0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=0,this._shadowType=0,this._vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=true,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=false,this._cookieOffsetSet=false,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this._cascadeBlend=0,this.cascadeDistribution=.5,this._shape=0,this._colorLinear=new Float32Array(3),this._updateLinearColor(),this._position=new ed(0,0,0),this._direction=new ed(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*ei.DEG_TO_RAD),this._updateOuterAngle(this._outerConeAngle),this._usePhysicalUnits=void 0,this._shadowMap=null,this._shadowRenderParams=[],this._shadowCameraParams=[],this.shadowDistance=40,this._shadowResolution=1024,this._shadowBias=-5e-4,this._shadowIntensity=1,this._normalOffsetBias=0,this.shadowUpdateMode=2,this.shadowUpdateOverrides=null,this._isVsm=false,this._isPcf=true,this._softShadowParams=new Float32Array(4),this.shadowSamples=16,this.shadowBlockerSamples=16,this.penumbraSize=1,this.penumbraFalloff=1,this._cookieMatrix=null,this._atlasViewport=null,this.atlasViewportAllocated=false,this.atlasVersion=0,this.atlasSlotIndex=0,this.atlasSlotUpdated=false,this._node=null,this._renderData=[],this.visibleThisFrame=false,this.maxScreenSize=0,this._updateShadowBias();}}class hw{applySettings(e){this.shadowsEnabled=e.lightingShadowsEnabled??this.shadowsEnabled,this.cookiesEnabled=e.lightingCookiesEnabled??this.cookiesEnabled,this.areaLightsEnabled=e.lightingAreaLightsEnabled??this.areaLightsEnabled,this.shadowAtlasResolution=e.lightingShadowAtlasResolution??this.shadowAtlasResolution,this.cookieAtlasResolution=e.lightingCookieAtlasResolution??this.cookieAtlasResolution,this.maxLightsPerCell=e.lightingMaxLightsPerCell??this.maxLightsPerCell,this.shadowType=e.lightingShadowType??this.shadowType,e.lightingCells&&(this.cells=new ed(e.lightingCells));}set cells(e){this._cells.copy(e);}get cells(){return this._cells}set maxLightsPerCell(e){this._maxLightsPerCell=ei.clamp(e,1,255);}get maxLightsPerCell(){return this._maxLightsPerCell}set cookieAtlasResolution(e){this._cookieAtlasResolution=ei.clamp(e,32,this._maxTextureSize);}get cookieAtlasResolution(){return this._cookieAtlasResolution}set shadowAtlasResolution(e){this._shadowAtlasResolution=ei.clamp(e,32,this._maxTextureSize);}get shadowAtlasResolution(){return this._shadowAtlasResolution}set shadowType(e){this._shadowType!==e&&(this._shadowType=e,this._dirtyLightsFnc());}get shadowType(){return this._shadowType}set cookiesEnabled(e){this._cookiesEnabled!==e&&(this._cookiesEnabled=e,this._dirtyLightsFnc());}get cookiesEnabled(){return this._cookiesEnabled}set areaLightsEnabled(e){this._supportsAreaLights&&this._areaLightsEnabled!==e&&(this._areaLightsEnabled=e,this._dirtyLightsFnc());}get areaLightsEnabled(){return this._areaLightsEnabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this._dirtyLightsFnc());}get shadowsEnabled(){return this._shadowsEnabled}constructor(e,t,i){this._areaLightsEnabled=false,this._cells=new ed(10,3,10),this._maxLightsPerCell=255,this._shadowsEnabled=true,this._shadowType=0,this._shadowAtlasResolution=2048,this._cookiesEnabled=false,this._cookieAtlasResolution=2048,this.atlasSplit=null,this._supportsAreaLights=e,this._maxTextureSize=t,this._dirtyLightsFnc=i;}}class hb{destroy(){this.shader=null;let e=this.morph;e&&(this.morph=null,e.decRefCount(),e.refCount<1&&e.destroy()),this.rtPositions?.destroy(),this.rtPositions=null,this.texturePositions?.destroy(),this.texturePositions=null,this.rtNormals?.destroy(),this.rtNormals=null,this.textureNormals?.destroy(),this.textureNormals=null;}clone(){return new hb(this.morph)}_getWeightIndex(e){return "string"==typeof e?this._weightMap.get(e):e}getWeight(e){let t=this._getWeightIndex(e);return this._weights[t]}setWeight(e,t){let i=this._getWeightIndex(e);this._weights[i]=t,this._dirty=true;}_createShader(e){let t=new Map;t.set("{MORPH_TEXTURE_MAX_COUNT}",e),this.morph.intRenderFormat&&t.set("MORPH_INT","");let i=this.morph.intRenderFormat?"uvec4":"vec4";return nY.createShader(this.device,{uniqueName:`TextureMorphShader_${e}-${this.morph.intRenderFormat?"int":"float"}`,attributes:{vertex_position:e6},vertexChunk:"morphVS",fragmentChunk:"morphPS",fragmentDefines:t,fragmentOutputTypes:[i]})}_updateTextureRenderTarget(e,t,i){let{morph:s,device:r}=this;this.setAabbUniforms(i),this.morphTextureId.setValue(i?s.targetsTexturePositions:s.targetsTextureNormals),r.setBlendState(iS.NOBLEND),this.countId.setValue(t),this.morphFactor.setValue(this._shaderMorphWeights),this.morphIndex.setValue(this._shaderMorphIndex),n0(r,e,this.shader);}_updateTextureMorph(e){this.device,(e>0||!this.zeroTextures)&&(this.rtPositions&&this._updateTextureRenderTarget(this.rtPositions,e,true),this.rtNormals&&this._updateTextureRenderTarget(this.rtNormals,e,false),this.zeroTextures=0===e);}setAabbUniforms(e=true){this.aabbSizeId.setValue(e?this._aabbSize:this._aabbNrmSize),this.aabbMinId.setValue(e?this._aabbMin:this._aabbNrmMin);}prepareRendering(e){this.setAabbUniforms();}update(){this._dirty=false;let e=this.morph._targets,t=this._shaderMorphWeights,i=this._shaderMorphIndex,s=0;for(let r=0;r<e.length;r++)Math.abs(this.getWeight(r))>1e-5&&(t[s]=this.getWeight(r),i[s]=r,s++);this._updateTextureMorph(s);}constructor(e){this.morph=e,e.incRefCount(),this.device=e.device;let t=e._targets.length;this.shader=this._createShader(t),this._weights=[],this._weightMap=new Map;for(let t=0;t<e._targets.length;t++){let i=e._targets[t];i.name&&this._weightMap.set(i.name,t),this.setWeight(t,i.defaultWeight);}this._shaderMorphWeights=new Float32Array(t),this._shaderMorphIndex=new Uint32Array(t);let i=(t,i)=>(this[i]=e._createTexture(t,e._renderTextureFormat),new iU({colorBuffer:this[i],depth:false}));e.morphPositions&&(this.rtPositions=i("MorphRTPos","texturePositions")),e.morphNormals&&(this.rtNormals=i("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([e.morphTextureWidth,e.morphTextureHeight]);let s=e.aabb.halfExtents;this._aabbSize=new Float32Array([4*s.x,4*s.y,4*s.z]);let r=e.aabb.getMin();this._aabbMin=new Float32Array([2*r.x,2*r.y,2*r.z]),this._aabbNrmSize=new Float32Array([2,2,2]),this._aabbNrmMin=new Float32Array([-1,-1,-1]),this.aabbSizeId=this.device.scope.resolve("aabbSize"),this.aabbMinId=this.device.scope.resolve("aabbMin"),this.morphTextureId=this.device.scope.resolve("morphTexture"),this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.morphIndex=this.device.scope.resolve("morphIndex[0]"),this.countId=this.device.scope.resolve("count"),this.zeroTextures=false;}}class hA{getGraph(){return this.graph}setGraph(e){this.graph=e;}getCameras(){return this.cameras}setCameras(e){this.cameras=e;}getLights(){return this.lights}setLights(e){this.lights=e;}getMaterials(){let e=[];for(let t=0;t<this.meshInstances.length;t++){let i=this.meshInstances[t];-1===e.indexOf(i.material)&&e.push(i.material);}return e}clone(){let e=[],t=[],i=function(s){let r=s.clone();e.push(s),t.push(r);for(let e=0;e<s._children.length;e++)r.addChild(i(s._children[e]));return r},s=i(this.graph),r=[],a=[],n=[];for(let e=0;e<this.skinInstances.length;e++){let t=this.skinInstances[e].skin,i=new n4(t),r=[];for(let e=0;e<t.boneNames.length;e++){let i=t.boneNames[e],a=s.findByName(i);r.push(a);}i.bones=r,a.push(i);}for(let e=0;e<this.morphInstances.length;e++){let t=new hb(this.morphInstances[e].morph);n.push(t);}for(let i=0;i<this.meshInstances.length;i++){let s=this.meshInstances[i],o=e.indexOf(s.node),l=new od(s.mesh,s.material,t[o]);s.skinInstance&&(l.skinInstance=a[this.skinInstances.indexOf(s.skinInstance)]),s.morphInstance&&(l.morphInstance=n[this.morphInstances.indexOf(s.morphInstance)]),r.push(l);}let o=new hA;return o.graph=s,o.meshInstances=r,o.skinInstances=a,o.morphInstances=n,o.getGraph().syncHierarchy(),o}destroy(){let e=this.meshInstances;for(let t=0;t<e.length;t++)e[t].destroy();this.meshInstances.length=0;}generateWireframe(){od._prepareRenderStyleForArray(this.meshInstances,1);}constructor(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=false;}}class hC extends st{destroy(){this.vertexBufferIds?.destroy(),this.vertexBufferIds=null,this.targetsTexturePositions?.destroy(),this.targetsTexturePositions=null,this.targetsTextureNormals?.destroy(),this.targetsTextureNormals=null;}get aabb(){if(!this._aabb){let e=new ed,t=new ed;for(let i=0;i<this._targets.length;i++){let s=this._targets[i].aabb;e.min(s.getMin()),t.max(s.getMax());}this._aabb=new eC,this._aabb.setMinMax(e,t);}return this._aabb}get morphPositions(){return this._morphPositions}get morphNormals(){return this._morphNormals}_init(){this._initTextureBased();for(let e=0;e<this._targets.length;e++)this._targets[e]._postInit();}_findSparseSet(e,t,i){let s=1,r=e[0].length;for(let a=0;a<r;a+=3){let r=false;for(let t=0;t<e.length;t++){let i=e[t];if(0!==i[a]||0!==i[a+1]||0!==i[a+2]){r=true;break}}r?(t.push(s),i.push(a/3),s++):t.push(0);}return s}_initTextureBased(){let e=[],t=[],i=this._targets;for(let s=0;s<i.length;s++){let r=i[s];r.options.deltaPositions&&(e.push(r.options.deltaPositions),t.push(true)),r.options.deltaNormals&&(e.push(r.options.deltaNormals),t.push(false));}let s=[],r=[],a=this._findSparseSet(e,s,r),n=this.device.maxTextureSize,o=Math.ceil(Math.sqrt(a)),l=Math.ceil(a/(o=Math.min(o,n)));if(l>n)return;this.morphTextureWidth=o,this.morphTextureHeight=l;let h=false,c=eh.float2Half;12===this._textureFormat&&(h=true);let d=[],u=[],f=o*l*4;for(let i=0;i<e.length;i++){let s=e[i],a=12===this._textureFormat?new Uint16Array(f):new Float32Array(f);if((t[i]?d:u).push(a),h)for(let e=0;e<r.length;e++){let t=3*r[e],i=4*e+4;a[i]=c(s[t]),a[i+1]=c(s[t+1]),a[i+2]=c(s[t+2]);}else for(let e=0;e<r.length;e++){let t=3*r[e],i=4*e+4;a[i]=s[t],a[i+1]=s[t+1],a[i+2]=s[t+2];}}d.length>0&&(this.targetsTexturePositions=this._createTexture("MorphPositionsTexture",this._textureFormat,i.length,[d])),u.length>0&&(this.targetsTextureNormals=this._createTexture("MorphNormalsTexture",this._textureFormat,i.length,[u]));let p=[{semantic:tC,components:1,type:5,asInt:true}];return this.vertexBufferIds=new iP(this.device,new iO(this.device,p,s.length),s.length,{data:new Uint32Array(s)}),true}get targets(){return this._targets}_updateMorphFlags(){this._morphPositions=false,this._morphNormals=false;for(let e=0;e<this._targets.length;e++){let t=this._targets[e];t.morphPositions&&(this._morphPositions=true),t.morphNormals&&(this._morphNormals=true);}}_createTexture(e,t,i,s){return new ih(this.device,{levels:s,arrayLength:i,width:this.morphTextureWidth,height:this.morphTextureHeight,format:t,cubemap:false,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1,name:e})}constructor(e,t,{preferHighPrecision:i=false}={}){super(),this.device=t,this.preferHighPrecision=i,this._targets=e.slice();let s=t.textureHalfFloatRenderable?12:void 0,r=t.textureFloatRenderable?14:void 0;this._renderTextureFormat=this.preferHighPrecision?r??s:s??r,this._renderTextureFormat=this._renderTextureFormat??47,this.intRenderFormat=e$(this._renderTextureFormat),this._textureFormat=this.preferHighPrecision?14:12,this._init(),this._updateMorphFlags();}}class hP{get name(){return this._name}get defaultWeight(){return this._defaultWeight}get aabb(){return !this._aabb&&(this._aabb=new eC,this.deltaPositions&&this._aabb.compute(this.deltaPositions)),this._aabb}clone(){return new hP(this.options)}_postInit(){this.options.preserveData||(this.options=null),this.used=true;}constructor(e){this.used=false,this.options=e,this._name=e.name,this._defaultWeight=e.defaultWeight||0,this._aabb=e.aabb,this.deltaPositions=e.deltaPositions,this.morphPositions=!!e.deltaPositions,this.morphNormals=!!e.deltaNormals;}}let hI=1,hD=new ey,hR=new ey,hL=new ed,hM=new ed,hO=new ed,hF=new ed,hN=new ed,hB=new ed,hk=new ed,hU=new ed,hz=new ed,hV=new ed,hG=new ed,hH=new ed,hW=new ed;function hX(e){return e-Math.floor(e)}function hY(e,t){return e-t*Math.floor(e/t)}function hq(e){let t=hX(e),i=hX(255*e);return [t-=i/255,i-=i/255]}class h${calcSpawnPosition(e,t,i,s,r){let a=this._emitter,n=Math.random(),o=Math.random(),l=Math.random(),h=Math.random();if(a.useCpu&&(e[4*r+0+2*a.numParticlesPot*4]=n,e[4*r+1+2*a.numParticlesPot*4]=o,e[4*r+2+2*a.numParticlesPot*4]=l),hM.x=n-.5,hM.y=o-.5,hM.z=l-.5,0===a.emitterShape){let e=Math.max(Math.abs(hM.x),Math.max(Math.abs(hM.y),Math.abs(hM.z))),r=e+(.5-e)*i[0],n=e+(.5-e)*i[1],o=e+(.5-e)*i[2];hM.x=r*(e===Math.abs(hM.x)?Math.sign(hM.x):2*hM.x),hM.y=n*(e===Math.abs(hM.y)?Math.sign(hM.y):2*hM.y),hM.z=o*(e===Math.abs(hM.z)?Math.sign(hM.z):2*hM.z),a.localSpace?hL.copy(t.transformPoint(hM)):hL.copy(s).add(t.transformPoint(hM));}else {hM.normalize();let e=0===a.emitterRadius?0:a.emitterRadiusInner/a.emitterRadius,t=h*(1-e)+e;a.localSpace?hL.copy(hM.mulScalar(t*a.emitterRadius)):hL.copy(s).add(hM.mulScalar(t*a.emitterRadius));}let c=-ei.lerp(a.rate,a.rate2,n)*r;if(a.pack8){var d;let t,i,s,o,l=(hL.x-a.worldBounds.center.x)/a.worldBoundsSize.x+.5,h=(hL.y-a.worldBounds.center.y)/a.worldBoundsSize.y+.5,u=(hL.z-a.worldBounds.center.z)/a.worldBoundsSize.z+.5,f=ei.lerp(a.startAngle*ei.DEG_TO_RAD,a.startAngle2*ei.DEG_TO_RAD,n);f=f%(2*Math.PI)/(2*Math.PI);let p=hq(l);e[4*r]=p[0],e[4*r+1]=p[1];let m=hq(h);e[4*r+2]=m[0],e[4*r+3]=m[1];let _=hq(u);e[4*r+0+4*a.numParticlesPot]=_[0],e[4*r+1+4*a.numParticlesPot]=_[1];let g=hq(f);e[4*r+2+4*a.numParticlesPot]=g[0],e[4*r+3+4*a.numParticlesPot]=g[1],e[4*r+3+4*a.numParticlesPot*2]=1;let v=Math.max(a.lifetime,a.numParticles*Math.max(a.rate,a.rate2)),S=(t=hX(d=c=(c+v)/(v+(a.lifetime+1))),i=hX(255*d),s=hX(65025*d),o=hX(0x99246ff*d),[t-=i/255,i-=s/255,s-=o/255,o-=o/255]);e[4*r+0+4*a.numParticlesPot*3]=S[0],e[4*r+1+4*a.numParticlesPot*3]=S[1],e[4*r+2+4*a.numParticlesPot*3]=S[2],e[4*r+3+4*a.numParticlesPot*3]=S[3];}else e[4*r]=hL.x,e[4*r+1]=hL.y,e[4*r+2]=hL.z,e[4*r+3]=ei.lerp(a.startAngle*ei.DEG_TO_RAD,a.startAngle2*ei.DEG_TO_RAD,n),e[4*r+3+4*a.numParticlesPot]=c;}update(e,i,s,r,a,n,o,l){let h,c,d,u,f,p,m,_,g,v,S,y,x=this._emitter;if(x.meshInstance.node){let e=x.meshInstance.node.worldTransform;for(let t=0;t<12;t++)hD.data[t]=e.data[t];hR.copy(hD),hR.invert(),hI=Math.max(Math.max((t=x.meshInstance.node.localScale).x,t.y),t.z);}n=null===x.meshInstance.node||x.localSpace?ed.ZERO:x.meshInstance.node.getPosition();let T=x.camera?x.camera._node.getPosition():ed.ZERO,E=x.useMesh?17:15,w=x.precision-1;for(let i=0;i<x.numParticles;i++){let b=Math.floor(x.vbCPU[i*x.numParticleVerts*(x.useMesh?6:4)+3]),A=s[4*b+0+2*x.numParticlesPot*4];hO.x=A,hO.y=s[4*b+1+2*x.numParticlesPot*4],hO.z=s[4*b+2+2*x.numParticlesPot*4];let C=x.rate+(x.rate2-x.rate)*A,P=x.lifetime,I=s[4*b+3+4*x.numParticlesPot]+o,D=Math.max(Math.min(I/P,1),0),R=0,L=0;(I-o<=0||I>=P)&&this.calcSpawnPosition(s,r,a,n,b);let M=I>0&&I<P;M&&(u=Math.floor(d=D*w),f=Math.ceil(d),d%=1,p=(h=x.qRotSpeed[u])+((c=x.qRotSpeed[f])-h)*d,m=(h=x.qRotSpeed2[u])+((c=x.qRotSpeed2[f])-h)*d,R=(h=x.qScale[u])+((c=x.qScale[f])-h)*d,_=(h=x.qScale2[u])+((c=x.qScale2[f])-h)*d,g=(h=x.qAlpha[u])+((c=x.qAlpha[f])-h)*d,v=(h=x.qAlpha2[u])+((c=x.qAlpha2[f])-h)*d,S=(h=x.qRadialSpeed[u])+((c=x.qRadialSpeed[f])-h)*d,y=(h=x.qRadialSpeed2[u])+((c=x.qRadialSpeed2[f])-h)*d,S+=100*A%1*(y-S),hF.x=s[4*b],hF.y=s[4*b+1],hF.z=s[4*b+2],x.localSpace?hz.copy(hF):hz.copy(hF).sub(n),hz.normalize().mulScalar(S),u*=3,f*=3,h=x.qLocalVelocity[u],c=x.qLocalVelocity[f],hB.x=h+(c-h)*d,h=x.qLocalVelocity[u+1],c=x.qLocalVelocity[f+1],hB.y=h+(c-h)*d,h=x.qLocalVelocity[u+2],c=x.qLocalVelocity[f+2],hB.z=h+(c-h)*d,h=x.qLocalVelocity2[u],c=x.qLocalVelocity2[f],hU.x=h+(c-h)*d,h=x.qLocalVelocity2[u+1],c=x.qLocalVelocity2[f+1],hU.y=h+(c-h)*d,h=x.qLocalVelocity2[u+2],c=x.qLocalVelocity2[f+2],hU.z=h+(c-h)*d,h=x.qVelocity[u],c=x.qVelocity[f],hN.x=h+(c-h)*d,h=x.qVelocity[u+1],c=x.qVelocity[f+1],hN.y=h+(c-h)*d,h=x.qVelocity[u+2],c=x.qVelocity[f+2],hN.z=h+(c-h)*d,h=x.qVelocity2[u],c=x.qVelocity2[f],hk.x=h+(c-h)*d,h=x.qVelocity2[u+1],c=x.qVelocity2[f+1],hk.y=h+(c-h)*d,h=x.qVelocity2[u+2],c=x.qVelocity2[f+2],hk.z=h+(c-h)*d,hB.x+=(hU.x-hB.x)*hO.x,hB.y+=(hU.y-hB.y)*hO.y,hB.z+=(hU.z-hB.z)*hO.z,x.initialVelocity>0&&(1===x.emitterShape?(hM.copy(hO).mulScalar(2).sub(ed.ONE).normalize(),hB.add(hM.mulScalar(x.initialVelocity))):hB.add(ed.FORWARD.mulScalar(x.initialVelocity))),hN.x+=(hk.x-hN.x)*hO.x,hN.y+=(hk.y-hN.y)*hO.y,hN.z+=(hk.z-hN.z)*hO.z,p+=(m-p)*hO.y,R=(R+1e4*A%1*(_-R))*hI,L=1e3*A%1*(v-g),x.meshInstance.node&&(x.localSpace?(hB.x/=t.x,hB.y/=t.y,hB.z/=t.z):hD.transformPoint(hB,hB)),x.localSpace?(hR.transformPoint(hN,hN),hB.add(hN).add(hz)):(hB.add(hN.mul(t)),hB.add(hz.mul(t))),hH.copy(hB),hV.copy(hF).add(hB.mulScalar(o)),hG.copy(hV),s[4*b]=hG.x,s[4*b+1]=hG.y,s[4*b+2]=hG.z,s[4*b+3]+=p*o,x.wrap&&x.wrapBounds&&(x.localSpace||hG.sub(n),hG.x=hY(hG.x,x.wrapBounds.x)-.5*x.wrapBounds.x,hG.y=hY(hG.y,x.wrapBounds.y)-.5*x.wrapBounds.y,hG.z=hY(hG.z,x.wrapBounds.z)-.5*x.wrapBounds.z,x.localSpace||hG.add(n)),x.sort>0&&(1===x.sort?(hW.copy(hG).sub(T),x.particleDistance[b]=-(hW.x*hW.x+hW.y*hW.y+hW.z*hW.z)):2===x.sort?x.particleDistance[b]=I:3===x.sort&&(x.particleDistance[b]=-I))),l?I<0&&(s[4*b+3+2*x.numParticlesPot*4]=-1):(I>=P&&(I-=Math.max(P,x.numParticles*C),s[4*b+3+2*x.numParticlesPot*4]=x.loop?1:-1),I<0&&x.loop&&(s[4*b+3+2*x.numParticlesPot*4]=1)),s[4*b+3+2*x.numParticlesPot*4]<0&&(M=false),s[4*b+3+4*x.numParticlesPot]=I;for(let t=0;t<x.numParticleVerts;t++){let r=(i*x.numParticleVerts+t)*(x.useMesh?6:4),a=x.vbCPU[r],n=x.vbCPU[r+1],o=x.vbCPU[r+2];M||(a=n=o=0);let l=i*x.numParticleVerts*E+t*E;e[l]=hG.x,e[l+1]=hG.y,e[l+2]=hG.z,e[l+3]=D,e[l+4]=x.alignToMotion?0:s[4*b+3],e[l+5]=R,e[l+6]=L,e[l+7]=hH.x,e[l+8]=a,e[l+9]=n,e[l+10]=o,e[l+11]=hH.y,e[l+12]=b,e[l+13]=hH.z,e[l+14]=x.vbCPU[r+3],x.useMesh&&(e[l+15]=x.vbCPU[r+4],e[l+16]=x.vbCPU[r+5]);}}if(x.sort>0&&x.camera){let e=x.useMesh?6:4,t=x.particleDistance;for(let s=0;s<x.numParticles;s++)i[s][0]=s,i[s][1]=t[Math.floor(x.vbCPU[s*x.numParticleVerts*e+3])];x.vbOld.set(x.vbCPU),i.sort((e,t)=>e[1]-t[1]);for(let t=0;t<x.numParticles;t++){let s=i[t][0]*x.numParticleVerts*e,r=t*x.numParticleVerts*e;for(let t=0;t<x.numParticleVerts*e;t++)x.vbCPU[r+t]=x.vbOld[s+t];}}}constructor(e){this._emitter=e;}}let hj=new eu,hK=new eu,hZ=new eu;class hQ{_setInputBounds(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x,this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y,this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z,this.constantInBoundsSize.setValue(this.inBoundsSizeUniform),this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x,this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y,this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z,this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform);}randomize(){this.frameRandomUniform[0]=Math.random(),this.frameRandomUniform[1]=Math.random(),this.frameRandomUniform[2]=Math.random();}update(e,t,i,s,r){let a=this._emitter;e.setBlendState(iS.NOBLEND),e.setDepthState(ix.NODEPTH),e.setCullMode(0),this.randomize(),this.constantRadialSpeedDivMult.setValue(a.material.getParameter("radialSpeedDivMult").data),this.constantGraphSampleSize.setValue(1/a.precision),this.constantGraphNumSamples.setValue(a.precision),this.constantNumParticles.setValue(a.numParticles),this.constantNumParticlesPot.setValue(a.numParticlesPot),this.constantInternalTex0.setValue(a.internalTex0),this.constantInternalTex1.setValue(a.internalTex1),this.constantInternalTex2.setValue(a.internalTex2),this.constantInternalTex3.setValue(a.internalTex3);let n=a.meshInstance.node,o=null===n?ed.ONE:n.localScale;if(a.pack8){this.worldBoundsMulUniform[0]=a.worldBoundsMul.x,this.worldBoundsMulUniform[1]=a.worldBoundsMul.y,this.worldBoundsMulUniform[2]=a.worldBoundsMul.z,this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform),this.worldBoundsAddUniform[0]=a.worldBoundsAdd.x,this.worldBoundsAddUniform[1]=a.worldBoundsAdd.y,this.worldBoundsAddUniform[2]=a.worldBoundsAdd.z,this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform),this._setInputBounds();let e=a.maxVel*Math.max(Math.max(o.x,o.y),o.z);e=Math.max(e,1),this.constantMaxVel.setValue(e);}let l=null===n||a.localSpace?ed.ZERO:n.getPosition(),h=null===n?ey.IDENTITY:n.getWorldTransform();0===a.emitterShape?(hj.setFromMat4(t),this.constantSpawnBounds.setValue(hj.data),this.constantSpawnPosInnerRatio.setValue(i)):(this.constantSpawnBoundsSphere.setValue(a.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(0===a.emitterRadius?0:a.emitterRadiusInner/a.emitterRadius)),this.constantInitialVelocity.setValue(a.initialVelocity),hK.setFromMat4(h),hZ.invertMat4(h),this.emitterPosUniform[0]=l.x,this.emitterPosUniform[1]=l.y,this.emitterPosUniform[2]=l.z,this.constantEmitterPos.setValue(this.emitterPosUniform),this.constantFrameRandom.setValue(this.frameRandomUniform),this.constantDelta.setValue(s),this.constantRate.setValue(a.rate),this.constantRateDiv.setValue(a.rate2-a.rate),this.constantStartAngle.setValue(a.startAngle*ei.DEG_TO_RAD),this.constantStartAngle2.setValue(a.startAngle2*ei.DEG_TO_RAD),this.constantSeed.setValue(a.seed),this.constantLifetime.setValue(a.lifetime),this.emitterScaleUniform[0]=o.x,this.emitterScaleUniform[1]=o.y,this.emitterScaleUniform[2]=o.z,this.constantEmitterScale.setValue(this.emitterScaleUniform),this.constantEmitterMatrix.setValue(hK.data),this.constantEmitterMatrixInv.setValue(hZ.data),this.constantLocalVelocityDivMult.setValue(a.localVelocityUMax),this.constantVelocityDivMult.setValue(a.velocityUMax),this.constantRotSpeedDivMult.setValue(a.rotSpeedUMax[0]);let c=a.swapTex?a.particleTexOUT:a.particleTexIN;c=a.beenReset?a.particleTexStart:c;let d=a.swapTex?a.particleTexIN:a.particleTexOUT;this.constantParticleTexIN.setValue(c),n0(e,a.swapTex?a.rtParticleTexIN:a.rtParticleTexOUT,r?a.shaderParticleUpdateOnStop:a.loop?a.shaderParticleUpdateRespawn:a.shaderParticleUpdateNoRespawn),a.material.setParameter("particleTexOUT",c),a.material.setParameter("particleTexIN",d),a.beenReset=false,a.swapTex=!a.swapTex,a.prevWorldBoundsSize.copy(a.worldBoundsSize),a.prevWorldBoundsCenter.copy(a.worldBounds.center),a.pack8&&this._setInputBounds();}constructor(e,t){this._emitter=e,this.frameRandomUniform=new Float32Array(3),this.emitterPosUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),this.worldBoundsMulUniform=new Float32Array(3),this.worldBoundsAddUniform=new Float32Array(3),this.inBoundsSizeUniform=new Float32Array(3),this.inBoundsCenterUniform=new Float32Array(3),this.constantParticleTexIN=t.scope.resolve("particleTexIN"),this.constantParticleTexOUT=t.scope.resolve("particleTexOUT"),this.constantEmitterPos=t.scope.resolve("emitterPos"),this.constantEmitterScale=t.scope.resolve("emitterScale"),this.constantSpawnBounds=t.scope.resolve("spawnBounds"),this.constantSpawnPosInnerRatio=t.scope.resolve("spawnPosInnerRatio"),this.constantSpawnBoundsSphere=t.scope.resolve("spawnBoundsSphere"),this.constantSpawnBoundsSphereInnerRatio=t.scope.resolve("spawnBoundsSphereInnerRatio"),this.constantInitialVelocity=t.scope.resolve("initialVelocity"),this.constantFrameRandom=t.scope.resolve("frameRandom"),this.constantDelta=t.scope.resolve("delta"),this.constantRate=t.scope.resolve("rate"),this.constantRateDiv=t.scope.resolve("rateDiv"),this.constantLifetime=t.scope.resolve("lifetime"),this.constantGraphSampleSize=t.scope.resolve("graphSampleSize"),this.constantGraphNumSamples=t.scope.resolve("graphNumSamples"),this.constantInternalTex0=t.scope.resolve("internalTex0"),this.constantInternalTex1=t.scope.resolve("internalTex1"),this.constantInternalTex2=t.scope.resolve("internalTex2"),this.constantInternalTex3=t.scope.resolve("internalTex3"),this.constantEmitterMatrix=t.scope.resolve("emitterMatrix"),this.constantEmitterMatrixInv=t.scope.resolve("emitterMatrixInv"),this.constantNumParticles=t.scope.resolve("numParticles"),this.constantNumParticlesPot=t.scope.resolve("numParticlesPot"),this.constantLocalVelocityDivMult=t.scope.resolve("localVelocityDivMult"),this.constantVelocityDivMult=t.scope.resolve("velocityDivMult"),this.constantRotSpeedDivMult=t.scope.resolve("rotSpeedDivMult"),this.constantSeed=t.scope.resolve("seed"),this.constantStartAngle=t.scope.resolve("startAngle"),this.constantStartAngle2=t.scope.resolve("startAngle2"),this.constantOutBoundsMul=t.scope.resolve("outBoundsMul"),this.constantOutBoundsAdd=t.scope.resolve("outBoundsAdd"),this.constantInBoundsSize=t.scope.resolve("inBoundsSize"),this.constantInBoundsCenter=t.scope.resolve("inBoundsCenter"),this.constantMaxVel=t.scope.resolve("maxVel"),this.constantFaceTangent=t.scope.resolve("faceTangent"),this.constantFaceBinorm=t.scope.resolve("faceBinorm"),this.constantRadialSpeedDivMult=t.scope.resolve("radialSpeedDivMult");}}let hJ=["NONE","VERTEX","MAP"],h0=new class extends nB{generateKey(e){let t=nB.definesHash(e.defines),i=`particle_${t}_`;for(let t in e)e.hasOwnProperty(t)&&(i+=e[t]);return i}createVertexDefines(e,t){let i=new Map(e.defines);return e.mesh&&i.set("USE_MESH",""),e.meshUv&&i.set("USE_MESH_UV",""),e.localSpace&&i.set("LOCAL_SPACE",""),e.screenSpace&&i.set("SCREEN_SPACE",""),e.animTex&&i.set("ANIMTEX",""),e.soft>0&&i.set("SOFT",""),e.stretch>0&&i.set("STRETCH",""),e.customFace&&i.set("CUSTOM_FACE",""),e.pack8&&i.set("PACK8",""),e.localSpace&&i.set("LOCAL_SPACE",""),e.animTexLoop&&i.set("ANIMTEX_LOOP",""),e.wrap&&i.set("WRAP",""),e.alignToMotion&&i.set("ALIGN_TO_MOTION",""),i.set("NORMAL",hJ[e.normal]),t.particle_vertexData=e6,e.mesh&&e.meshUv&&(t.particle_uv=tr),e.useCpu&&(t.particle_vertexData2=tf,t.particle_vertexData3=tp,t.particle_vertexData4=tm,t.particle_vertexData5=t_),i}createFragmentDefines(e){let t=new Map(e.defines);return e.soft>0&&t.set("SOFT",""),e.halflambert&&t.set("HALF_LAMBERT",""),t.set("NORMAL",hJ[e.normal]),t.set("BLEND",a8[e.blend]),t}createShaderDefinition(e,t){let i=e.isWebGPU?tV:tz,s=nH.get(e,i),r={},a=this.createVertexDefines(t,r),n=this.createFragmentDefines(t),o=`PARTICLE_${t.useCpu?"CPU":"GPU"}
`;a.set(o,""),n.set(o,"");let l=new Map(s);return rh.createDefinition(e,{name:"ParticleShader",shaderLanguage:i,attributes:r,vertexCode:s.get("particle_shaderVS"),fragmentCode:s.get("particle_shaderPS"),fragmentDefines:n,fragmentIncludes:l,vertexIncludes:l,vertexDefines:a})}};class h1 extends lm{getShaderVariant(e){let{device:t,scene:i,cameraShaderParams:s,objDefs:r}=e,{emitter:a}=this,n={defines:nY.getCoreDefines(this,e),pass:0,useCpu:this.emitter.useCpu,normal:a.lighting?null!==a.normalMap?2:1:0,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,meshUv:4&r,gamma:s?.shaderOutputGamma??0,toneMap:s?.toneMapping??0,fog:i&&!this.emitter.noFog?i.fog.type:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,screenSpace:!a.inTools&&this.emitter.screenSpace,blend:this.emitter.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:0!==this.emitter.orientation},o=new nO(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),l=nN(t);return l.register("particle",h0),l.getProgram("particle",n,o,this.userId)}constructor(e){super(),this.emitter=null,this.emitter=e;}}let h2=[[-1,-1],[1,-1],[1,1],[-1,1]];function h3(e,t,i,s,r=14,a,n){let o=0;n&&(7===r||20===r)&&(o=1);let l=new ih(e,{width:t,height:i,format:r,cubemap:false,mipmaps:false,minFilter:o,magFilter:o,addressU:1,addressV:1,name:"ParticleSystemTexture"}),h=l.lock();if(7===r||20===r){let e=new Uint8Array(s.length);for(let t=0;t<s.length;t++)e[t]=s[t]*a*255;s=e;}return h.set(s),l.unlock(),l}function h4(e){return Math.max(Math.min(e,1),0)}let h5=new ea([0,0,1,0]),h8=new ea([0,1,1,1]),h6=new en([0,0,1,0],[0,0,1,0],[0,0,1,0]),h9=new en([0,1,1,1],[0,1,1,1],[0,1,1,1]),h7=2,ce=new Float32Array(3),ct=new ey,ci=new ed,cs=new ed,cr=new ed;function ca(e,t){ void 0!==s[e]&&null!==s[e]?i[e]=s[e]:i[e]=t;}function cn(e,t,i){return (255*e<<16|255*t<<8|255*i)/0x1000000}function co(e,t){let i=e.length/3,s=Array(4*i);for(let r=0;r<i;r++)s[4*r]=e[3*r],s[4*r+1]=e[3*r+1],s[4*r+2]=e[3*r+2],s[4*r+3]=cn(t[3*r],t[3*r+1],t[3*r+2]);return s}function cl(e,t){let i=t.length,s=e.length/i;for(let r=0;r<s;r++)for(let s=0;s<i;s++){let a=Math.abs(e[r*i+s]);t[s]=Math.max(t[s],a);}}function ch(e,t,i){let s=function(e,t){let i=new Float32Array(e.length);for(let s=0;s<e.length;s++)i[s]=e[s]-t[s];return i}(t,e);cl(s,i);let r=i.length,a=s.length/r;for(let e=0;e<a;e++)for(let t=0;t<r;t++)s[e*r+t]/=0===i[t]?1:i[t],s[e*r+t]*=.5,s[e*r+t]+=.5;return s}let cc=new ii;class cd{get defaultParamTexture(){return cc.get(this.graphicsDevice,()=>{let e=new Float32Array(1024);for(let t=0;t<16;t++)for(let i=0;i<16;i++){let s=i+1-8.5,r=t+1-8.5,a=h4(1-h4(Math.sqrt(s*s+r*r)/16)-.5),n=16*t+i;e[4*n]=1,e[4*n+1]=1,e[4*n+2]=1,e[4*n+3]=a;}let t=h3(this.graphicsDevice,16,16,e,20,1,true);return t.minFilter=1,t.magFilter=1,t})}onChangeCamera(){this.resetMaterial();}calculateBoundsMad(){this.worldBoundsMul.x=1/this.worldBoundsSize.x,this.worldBoundsMul.y=1/this.worldBoundsSize.y,this.worldBoundsMul.z=1/this.worldBoundsSize.z,this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).mulScalar(-1),this.worldBoundsAdd.x+=.5,this.worldBoundsAdd.y+=.5,this.worldBoundsAdd.z+=.5;}calculateWorldBounds(){if(!this.node)return;(this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),!this.useCpu)&&((0===this.emitterShape?this.emitterExtents.equals(this.prevEmitterExtents):this.emitterRadius===this.prevEmitterRadius)||this.calculateLocalBounds());let e=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,e),this.worldBoundsTrail[0].add(this.worldBoundsNoTrail),this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);let t=this.simTimeTotal;t>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=t+this.lifetime),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,e),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,e)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds)),this.meshInstance._aabbVer=1-this.meshInstance._aabbVer,this.pack8&&this.calculateBoundsMad();}resetWorldBounds(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?ey.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.simTimeTotal=0,this.timeToSwitchBounds=0);}calculateLocalBounds(){let e,t,i,s=Number.MAX_VALUE,r=Number.MAX_VALUE,a=Number.MAX_VALUE,n=-Number.MAX_VALUE,o=-Number.MAX_VALUE,l=-Number.MAX_VALUE,h=0,c=0,d=this.lifetime/this.precision,u=[this.qVelocity,this.qVelocity2],f=[this.qLocalVelocity,this.qLocalVelocity2],p=[0,0],m=[0,0],_=[0,0],g=[0,0],v=[0,0];for(let S=0;S<this.precision+1;S++){let y=Math.min(S,this.precision-1);for(let h=0;h<2;h++)e=f[h][3*y+0]*d+p[h],t=f[h][3*y+1]*d+m[h],i=f[h][3*y+2]*d+_[h],s=Math.min(e,s),r=Math.min(t,r),a=Math.min(i,a),n=Math.max(e,n),o=Math.max(t,o),l=Math.max(i,l),p[h]=e,m[h]=t,_[h]=i;for(let e=0;e<2;e++)v[e]+=d*Math.sqrt(u[e][3*y+0]*u[e][3*y+0]+u[e][3*y+1]*u[e][3*y+1]+u[e][3*y+2]*u[e][3*y+2]);g[0]+=this.qRadialSpeed[y]*d,g[1]+=this.qRadialSpeed2[y]*d,h=Math.max(h,Math.max(Math.abs(g[0]),Math.abs(g[1]))),c=Math.max(c,this.qScale[y]);}0===this.emitterShape?(e=.5*this.emitterExtents.x,t=.5*this.emitterExtents.y,i=.5*this.emitterExtents.z):(e=this.emitterRadius,t=this.emitterRadius,i=this.emitterRadius);let S=Math.max(v[0],v[1]);cs.x=s-c-e-h-S,cs.y=r-c-t-h-S,cs.z=a-c-i-h-S,cr.x=n+c+e+h+S,cr.y=o+c+t+h+S,cr.z=l+c+i+h+S,this.localBounds.setMinMax(cs,cr);}rebuild(){let e=this.graphicsDevice;null===this.colorMap&&(this.colorMap=this.defaultParamTexture),this.spawnBounds=0===this.emitterShape?this.emitterExtents:this.emitterRadius,this.useCpu=this.useCpu||this.sort>0||e.maxVertexTextures<=1||e.fragmentUniformsCount<64||e.forceCpuParticles;let t=this._destroyResources();this.pack8=(this.pack8||!e.textureFloatRenderable)&&!this.useCpu,h7=this.useCpu||this.pack8?4:2,this.useMesh=!!this.mesh,this.numParticlesPot=ei.nextPowerOfTwo(this.numParticles),this.rebuildGraphs(),this.calculateLocalBounds(),this.resetWorldBounds(),this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?ey.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad()),this.vbToSort=Array(this.numParticles);for(let e=0;e<this.numParticles;e++)this.vbToSort[e]=[0,0];this.particleDistance=new Float32Array(this.numParticles),this._gpuUpdater.randomize(),this.particleTex=new Float32Array(this.numParticlesPot*h7*4);let i=null===this.node||this.localSpace?ed.ZERO:this.node.getPosition();0===this.emitterShape&&(null===this.node||this.localSpace?ct.setTRS(ed.ZERO,ex.IDENTITY,this.spawnBounds):ct.setTRS(ed.ZERO,this.node.getRotation(),ci.copy(this.spawnBounds).mul(this.node.localScale)),ce[0]=0!==this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,ce[1]=0!==this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,ce[2]=0!==this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0);for(let e=0;e<this.numParticles;e++)this._cpuUpdater.calcSpawnPosition(this.particleTex,ct,ce,i,e),this.useCpu&&(this.particleTex[4*e+3+2*this.numParticlesPot*4]=1);this.particleTexStart=new Float32Array(this.numParticlesPot*h7*4);for(let e=0;e<this.particleTexStart.length;e++)this.particleTexStart[e]=this.particleTex[e];this.useCpu||(this.pack8?(this.particleTexIN=h3(e,this.numParticlesPot,h7,this.particleTex,7,1,false),this.particleTexOUT=h3(e,this.numParticlesPot,h7,this.particleTex,7,1,false),this.particleTexStart=h3(e,this.numParticlesPot,h7,this.particleTexStart,7,1,false)):(this.particleTexIN=h3(e,this.numParticlesPot,h7,this.particleTex),this.particleTexOUT=h3(e,this.numParticlesPot,h7,this.particleTex),this.particleTexStart=h3(e,this.numParticlesPot,h7,this.particleTexStart)),this.rtParticleTexIN=new iU({colorBuffer:this.particleTexIN,depth:false}),this.rtParticleTexOUT=new iU({colorBuffer:this.particleTexOUT,depth:false}),this.swapTex=false);let s=new Map;this.localSpace&&s.set("LOCAL_SPACE",""),this.pack8&&s.set("PACK8",""),0===this.emitterShape&&s.set("EMITTERSHAPE_BOX","");let r=`Shape:${this.emitterShape}-Pack:${this.pack8}-Local:${this.localSpace}`,a={attributes:{vertex_position:e6},vertexChunk:"fullscreenQuadVS",fragmentChunk:"particle_simulationPS",fragmentDefines:s,fragmentIncludes:new Map(nH.get(e,e.isWebGPU?tV:tz))};a.uniqueName=`ParticleUpdateRespawn-${r}`,s.set("RESPAWN",""),this.shaderParticleUpdateRespawn=nY.createShader(e,a),s.delete("RESPAWN"),a.uniqueName=`ParticleUpdateNoRespawn-${r}`,s.set("NO_RESPAWN",""),this.shaderParticleUpdateNoRespawn=nY.createShader(e,a),s.delete("NO_RESPAWN"),a.uniqueName=`ParticleUpdateStop-${r}`,s.set("ON_STOP",""),this.shaderParticleUpdateOnStop=nY.createShader(e,a),this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4,this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6,this._allocate(this.numParticles);let n=new n7(e);n.vertexBuffer=this.vertexBuffer,n.indexBuffer[0]=this.indexBuffer,n.primitive[0].type=4,n.primitive[0].base=0,n.primitive[0].count=this.numParticles*this.numParticleIndices,n.primitive[0].indexed=true,this.material=this._createMaterial(),this.resetMaterial(),this.meshInstance=new od(n,this.material,this.node),this.meshInstance.pick=false,this.meshInstance.updateKey(),this.meshInstance.cull=true,this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance._updateAabb=false,this.meshInstance.visible=t,this._setMaterialTextures(),this.resetTime(),this.addTime(0,false),this.preWarm&&this.prewarm(this.lifetime);}_isAnimated(){return this.animNumFrames>=1&&(this.animTilesX>1||this.animTilesY>1)&&(this.colorMap&&this.colorMap!==this.defaultParamTexture||this.normalMap)}rebuildGraphs(){let e=this.precision,t=this.graphicsDevice;this.qLocalVelocity=this.localVelocityGraph.quantize(e),this.qVelocity=this.velocityGraph.quantize(e),this.qColor=this.colorGraph.quantizeClamped(e,0,1),this.qRotSpeed=this.rotationSpeedGraph.quantize(e),this.qScale=this.scaleGraph.quantize(e),this.qAlpha=this.alphaGraph.quantize(e),this.qRadialSpeed=this.radialSpeedGraph.quantize(e),this.qLocalVelocity2=this.localVelocityGraph2.quantize(e),this.qVelocity2=this.velocityGraph2.quantize(e),this.qColor2=this.colorGraph2.quantizeClamped(e,0,1),this.qRotSpeed2=this.rotationSpeedGraph2.quantize(e),this.qScale2=this.scaleGraph2.quantize(e),this.qAlpha2=this.alphaGraph2.quantize(e),this.qRadialSpeed2=this.radialSpeedGraph2.quantize(e);for(let t=0;t<e;t++)this.qRotSpeed[t]*=ei.DEG_TO_RAD,this.qRotSpeed2[t]*=ei.DEG_TO_RAD;if(this.localVelocityUMax=new Float32Array(3),this.velocityUMax=new Float32Array(3),this.colorUMax=new Float32Array(3),this.rotSpeedUMax=[0],this.scaleUMax=[0],this.alphaUMax=[0],this.radialSpeedUMax=[0],this.qLocalVelocityDiv=ch(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax),this.qVelocityDiv=ch(this.qVelocity,this.qVelocity2,this.velocityUMax),this.qColorDiv=ch(this.qColor,this.qColor2,this.colorUMax),this.qRotSpeedDiv=ch(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax),this.qScaleDiv=ch(this.qScale,this.qScale2,this.scaleUMax),this.qAlphaDiv=ch(this.qAlpha,this.qAlpha2,this.alphaUMax),this.qRadialSpeedDiv=ch(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax),this.pack8){let e=[0,0,0];cl(this.qVelocity,e);let t=[0,0,0];cl(this.qVelocity2,t);let i=[0,0,0];cl(this.qLocalVelocity,i);let s=[0,0,0];cl(this.qLocalVelocity2,s);let r=[0];cl(this.qRadialSpeed,r);let a=[0];cl(this.qRadialSpeed2,a);let n=Math.max(e[0],t[0]);n=Math.max(n=Math.max(n=Math.max(n=Math.max(n,e[1]),t[1]),e[2]),t[2]);let o=Math.max(i[0],s[0]);o=Math.max(o=Math.max(o=Math.max(o=Math.max(o,i[1]),s[1]),i[2]),s[2]);let l=Math.max(r[0],a[0]);this.maxVel=n+o+l;}this.useCpu||(this.internalTex0=h3(t,e,1,co(this.qLocalVelocity,this.qLocalVelocityDiv)),this.internalTex1=h3(t,e,1,co(this.qVelocity,this.qVelocityDiv)),this.internalTex2=h3(t,e,1,function(e,t,i,s,r){let a=Array(4*e.length);for(let n=0;n<e.length;n++)a[4*n]=e[n],a[4*n+1]=t[n],a[4*n+2]=0,a[4*n+3]=cn(i[n],s[n],r[n]);return a}(this.qRotSpeed,this.qScale,this.qScaleDiv,this.qRotSpeedDiv,this.qAlphaDiv)),this.internalTex3=h3(t,e,1,function(e,t){let i=Array(4*e.length);for(let s=0;s<e.length;s++)i[4*s]=e[s],i[4*s+1]=t[s],i[4*s+2]=0,i[4*s+3]=0;return i}(this.qRadialSpeed,this.qRadialSpeedDiv))),this.colorParam=h3(t,e,1,function(e,t){let i=Array(4*t.length);for(let s=0;s<t.length;s++)i[4*s]=e[3*s],i[4*s+1]=e[3*s+1],i[4*s+2]=e[3*s+2],i[4*s+3]=t[s];return i}(this.qColor,this.qAlpha),20,1,true);}_setMaterialTextures(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap));}_createMaterial(){let e=new h1(this);return e.name=`EmitterMaterial:${this.node.name}`,e.cull=0,e.alphaWrite=false,e.blendType=this.blendType,e.depthWrite=this.depthWrite,e}resetMaterial(){let e=this.material;e.setParameter("stretch",this.stretch),this._isAnimated()&&(e.setParameter("animTexTilesParams",this.animTilesParams),e.setParameter("animTexParams",this.animParams),e.setParameter("animTexIndexParams",this.animIndexParams)),e.setParameter("colorMult",this.intensity),this.useCpu||(e.setParameter("internalTex0",this.internalTex0),e.setParameter("internalTex1",this.internalTex1),e.setParameter("internalTex2",this.internalTex2),e.setParameter("internalTex3",this.internalTex3)),e.setParameter("colorParam",this.colorParam),e.setParameter("numParticles",this.numParticles),e.setParameter("numParticlesPot",this.numParticlesPot),e.setParameter("lifetime",this.lifetime),e.setParameter("rate",this.rate),e.setParameter("rateDiv",this.rate2-this.rate),e.setParameter("seed",this.seed),e.setParameter("scaleDivMult",this.scaleUMax[0]),e.setParameter("alphaDivMult",this.alphaUMax[0]),e.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]),e.setParameter("graphNumSamples",this.precision),e.setParameter("graphSampleSize",1/this.precision),e.setParameter("emitterScale",new Float32Array([1,1,1])),this.pack8&&(this._gpuUpdater._setInputBounds(),e.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),e.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),e.setParameter("maxVel",this.maxVel)),this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,e.setParameter("wrapBounds",this.wrapBoundsUniform)),this._setMaterialTextures(),this.depthSoftening>0&&e.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100)),this.stretch>0&&(e.cull=0),this._compParticleFaceParams();}_compParticleFaceParams(){let e,t;if(0===this.orientation)e=new Float32Array([1,0,0]),t=new Float32Array([0,0,1]);else {let i;i=1===this.orientation?this.particleNormal.normalize():(null===this.node?ey.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize();let s=new ed(1,0,0);1===Math.abs(s.dot(i))&&s.set(0,0,1);let r=new ed().cross(i,s).normalize();s.cross(r,i).normalize(),e=new Float32Array([s.x,s.y,s.z]),t=new Float32Array([r.x,r.y,r.z]);}this.material.setParameter("faceTangent",e),this.material.setParameter("faceBinorm",t);}getVertexInfo(){let e=[];return this.useCpu?e.push({semantic:tu,components:4,type:6},{semantic:tf,components:4,type:6},{semantic:tp,components:4,type:6},{semantic:tm,components:1,type:6},{semantic:t_,components:this.useMesh?4:2,type:6}):(e.push({semantic:tu,components:4,type:6}),this.useMesh&&e.push({semantic:tf,components:2,type:6})),e}_allocate(e){let t=e*this.numParticleVerts,i=e*this.numParticleIndices;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==t){let s,r,a,n=this.getVertexInfo(),o=new iO(this.graphicsDevice,n);this.vertexBuffer=new iP(this.graphicsDevice,o,t,{usage:1}),this.indexBuffer=new ae(this.graphicsDevice,2,i);let l=new Float32Array(this.vertexBuffer.lock());if(this.useMesh){r=(s=new Float32Array(this.mesh.vertexBuffer.lock())).length/this.mesh.vertexBuffer.numVertices;for(let e=0;e<this.mesh.vertexBuffer.format.elements.length;e++)if(this.mesh.vertexBuffer.format.elements[e].name===tr){a=this.mesh.vertexBuffer.format.elements[e].offset/4;break}}for(let e=0;e<t;e++){let t=Math.floor(e/this.numParticleVerts);if(this.useMesh){let i=e%this.numParticleVerts;l[6*e]=s[i*r],l[6*e+1]=s[i*r+1],l[6*e+2]=s[i*r+2],l[6*e+3]=t,l[6*e+4]=s[i*r+a+0],l[6*e+5]=1-s[i*r+a+1];}else {let i=e%4;l[4*e]=h2[i][0],l[4*e+1]=h2[i][1],l[4*e+2]=0,l[4*e+3]=t;}}this.useCpu&&(this.vbCPU=new Float32Array(l),this.vbOld=new Float32Array(this.vbCPU.length)),this.vertexBuffer.unlock(),this.useMesh&&this.mesh.vertexBuffer.unlock();let h=0,c=new Uint32Array(this.indexBuffer.lock());if(this.useMesh){let e=this.mesh.indexBuffer[0];s=new t1[e.format](e.lock());}for(let t=0;t<e;t++)if(this.useMesh)for(let e=0;e<this.numParticleIndices;e++)c[t*this.numParticleIndices+e]=s[e]+t*this.numParticleVerts;else {let e=4*t;c[h++]=e,c[h++]=e+1,c[h++]=e+2,c[h++]=e,c[h++]=e+2,c[h++]=e+3;}this.indexBuffer.unlock(),this.useMesh&&this.mesh.indexBuffer[0].unlock();}}reset(){if(this.beenReset=true,this.seed=Math.random(),this.material.setParameter("seed",this.seed),this.useCpu)for(let e=0;e<this.particleTexStart.length;e++)this.particleTex[e]=this.particleTexStart[e];else this._setMaterialTextures();this.resetWorldBounds(),this.resetTime();let e=this.loop;this.loop=true,this.addTime(0,false),this.loop=e,this.preWarm&&this.prewarm(this.lifetime);}prewarm(e){let t=Math.min(Math.floor(e/this.lifetime*this.precision),this.precision),i=e/t;for(let e=0;e<t;e++)this.addTime(i,false);}resetTime(){let e;this.endTime=(e=Math.max(this.rate,this.rate2)*this.numParticles+this.lifetime,Date.now()+1e3*e);}finishFrame(){this.useCpu&&this.vertexBuffer.unlock();}addTime(e,t){let i,s=this.graphicsDevice;if(this.simTimeTotal+=e,this.calculateWorldBounds(),this._isAnimated()){let e=this.animTilesParams;e[0]=1/this.animTilesX,e[1]=1/this.animTilesY;let t=this.animParams;t[0]=this.animStartFrame,t[1]=this.animNumFrames*this.animSpeed,t[2]=this.animNumFrames-1,t[3]=this.animNumAnimations-1;let i=this.animIndexParams;i[0]=this.animIndex,i[1]=this.randomizeAnimIndex;}this.scene&&this.camera!==this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera()),0===this.emitterShape&&(ce[0]=0!==this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,ce[1]=0!==this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,ce[2]=0!==this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0,null===this.meshInstance.node?ct.setTRS(ed.ZERO,ex.IDENTITY,this.emitterExtents):ct.setTRS(ed.ZERO,this.meshInstance.node.getRotation(),ci.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));let r=null===this.meshInstance.node?ed.ONE:this.meshInstance.node.localScale;if(this.emitterScaleUniform[0]=r.x,this.emitterScaleUniform[1]=r.y,this.emitterScaleUniform[2]=r.z,this.material.setParameter("emitterScale",this.emitterScaleUniform),this.localSpace&&this.meshInstance.node&&(i=this.meshInstance.node.getPosition(),this.emitterPosUniform[0]=i.x,this.emitterPosUniform[1]=i.y,this.emitterPosUniform[2]=i.z,this.material.setParameter("emitterPos",this.emitterPosUniform)),this._compParticleFaceParams(),this.useCpu){let s=new Float32Array(this.vertexBuffer.lock());this._cpuUpdater.update(s,this.vbToSort,this.particleTex,ct,ce,i,e,t);}else this._gpuUpdater.update(s,ct,ce,e,t);!this.loop&&Date.now()>this.endTime&&(this.onFinished&&this.onFinished(),this.meshInstance.visible=false),this.meshInstance&&(this.meshInstance.drawOrder=this.drawOrder);}_destroyResources(){this.particleTexIN?.destroy(),this.particleTexIN=null,this.particleTexOUT?.destroy(),this.particleTexOUT=null,this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=null),this.rtParticleTexIN?.destroy(),this.rtParticleTexIN=null,this.rtParticleTexOUT?.destroy(),this.rtParticleTexOUT=null,this.internalTex0?.destroy(),this.internalTex0=null,this.internalTex1?.destroy(),this.internalTex1=null,this.internalTex2?.destroy(),this.internalTex2=null,this.internalTex3?.destroy(),this.internalTex3=null,this.colorParam?.destroy(),this.colorParam=null,this.vertexBuffer=void 0,this.indexBuffer=void 0;let e=this.meshInstance?.visible??true;return this.meshInstance?.destroy(),this.meshInstance=null,this.material?.destroy(),this.material=null,e}destroy(){this.camera=null,this._destroyResources();}constructor(e,t){this.material=null,this.internalTex0=null,this.internalTex1=null,this.internalTex2=null,this.colorParam=null,this.graphicsDevice=e,this.precision=32,this._addTimeTime=0,i=this,s=t,ca("numParticles",1),this.numParticles>e.maxTextureSize&&(this.numParticles=e.maxTextureSize),ca("rate",1),ca("rate2",this.rate),ca("lifetime",50),ca("emitterExtents",new ed(0,0,0)),ca("emitterExtentsInner",new ed(0,0,0)),ca("emitterRadius",0),ca("emitterRadiusInner",0),ca("emitterShape",0),ca("initialVelocity",1),ca("wrap",false),ca("localSpace",false),ca("screenSpace",false),ca("wrapBounds",null),ca("colorMap",this.defaultParamTexture),ca("normalMap",null),ca("loop",true),ca("preWarm",false),ca("sort",0),ca("mode",0),ca("scene",null),ca("lighting",false),ca("halfLambert",false),ca("intensity",1),ca("stretch",0),ca("alignToMotion",false),ca("depthSoftening",0),ca("mesh",null),ca("particleNormal",new ed(0,1,0)),ca("orientation",0),ca("depthWrite",false),ca("noFog",false),ca("blendType",2),ca("node",null),ca("startAngle",0),ca("startAngle2",this.startAngle),ca("animTilesX",1),ca("animTilesY",1),ca("animStartFrame",0),ca("animNumFrames",1),ca("animNumAnimations",1),ca("animIndex",0),ca("randomizeAnimIndex",false),ca("animSpeed",1),ca("animLoop",true),this._gpuUpdater=new hQ(this,e),this._cpuUpdater=new h$(this),this.emitterPosUniform=new Float32Array(3),this.wrapBoundsUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),ca("colorGraph",h9),ca("colorGraph2",this.colorGraph),ca("scaleGraph",h8),ca("scaleGraph2",this.scaleGraph),ca("alphaGraph",h8),ca("alphaGraph2",this.alphaGraph),ca("localVelocityGraph",h6),ca("localVelocityGraph2",this.localVelocityGraph),ca("velocityGraph",h6),ca("velocityGraph2",this.velocityGraph),ca("rotationSpeedGraph",h5),ca("rotationSpeedGraph2",this.rotationSpeedGraph),ca("radialSpeedGraph",h5),ca("radialSpeedGraph2",this.radialSpeedGraph),this.animTilesParams=new Float32Array(2),this.animParams=new Float32Array(4),this.animIndexParams=new Float32Array(2),this.vbToSort=null,this.vbOld=null,this.particleDistance=null,this.camera=null,this.swapTex=false,this.useMesh=true,this.useCpu=!e.supportsGpuParticles,this.pack8=true,this.localBounds=new eC,this.worldBoundsNoTrail=new eC,this.worldBoundsTrail=[new eC,new eC],this.worldBounds=new eC,this.worldBoundsSize=new ed,this.prevWorldBoundsSize=new ed,this.prevWorldBoundsCenter=new ed,this.prevEmitterExtents=this.emitterExtents,this.prevEmitterRadius=this.emitterRadius,this.worldBoundsMul=new ed,this.worldBoundsAdd=new ed,this.timeToSwitchBounds=0,this.shaderParticleUpdateRespawn=null,this.shaderParticleUpdateNoRespawn=null,this.shaderParticleUpdateOnStop=null,this.numParticleVerts=0,this.numParticleIndices=0,this.material=null,this.meshInstance=null,this.drawOrder=0,this.seed=Math.random(),this.fixedTimeStep=1/60,this.maxSubSteps=10,this.simTime=0,this.simTimeTotal=0,this.beenReset=false,this._layer=null,this.rebuild();}}let cu=new class extends nB{generateKey(e){let t=e.shaderDesc,i=t.vertexGLSL?iI(t.vertexGLSL):0,s=t.fragmentGLSL?iI(t.fragmentGLSL):0,r=t.vertexWGSL?iI(t.vertexWGSL):0,a=t.fragmentWGSL?iI(t.fragmentWGSL):0,n=nB.definesHash(e.defines),o=e.shaderChunks?.key??"",l=`${t.uniqueName}_${n}_${i}_${s}_${r}_${a}_${o}`;return e.skin&&(l+="_skin"),e.useInstancing&&(l+="_inst"),e.useMorphPosition&&(l+="_morphp"),e.useMorphNormal&&(l+="_morphn"),e.useMorphTextureBasedInt&&(l+="_morphi"),l}createAttributesDefinition(e,t){let i=t.shaderDesc.attributes,s=i?{...i}:void 0;t.skin&&(s.vertex_boneWeights=te,s.vertex_boneIndices=tt),(t.useMorphPosition||t.useMorphNormal)&&(s.morph_vertex_id=tC),e.attributes=s;}createVertexDefinition(e,t,i,s){let r=t.shaderDesc,a=new Map(i);a.set("transformInstancingVS","");let n=new Map(t.defines);t.skin&&n.set("SKIN",true),t.useInstancing&&n.set("INSTANCING",true),(t.useMorphPosition||t.useMorphNormal)&&(n.set("MORPHING",true),t.useMorphTextureBasedInt&&n.set("MORPHING_INT",true),t.useMorphPosition&&n.set("MORPHING_POSITION",true),t.useMorphNormal&&n.set("MORPHING_NORMAL",true)),e.vertexCode=s?r.vertexWGSL:r.vertexGLSL,e.vertexIncludes=a,e.vertexDefines=n;}createFragmentDefinition(e,t,i,s){let r=t.shaderDesc,a=new Map(i),n=new Map(t.defines);e.fragmentCode=s?r.fragmentWGSL:r.fragmentGLSL,e.fragmentIncludes=a,e.fragmentDefines=n;}createShaderDefinition(e,t){let i=t.shaderDesc,s=e.isWebGPU&&!!i.vertexWGSL&&!!i.fragmentWGSL&&(t.shaderChunks?.useWGSL??true),r={name:`ShaderMaterial-${i.uniqueName}`,shaderLanguage:s?tV:tz,fragmentOutputTypes:i.fragmentOutputTypes,meshUniformBufferFormat:i.meshUniformBufferFormat,meshBindGroupFormat:i.meshBindGroupFormat},a=s?tV:tz,n=nW.merge(nH.get(e,a),t.shaderChunks[a]);return this.createAttributesDefinition(r,t),this.createVertexDefinition(r,t,n,s),this.createFragmentDefinition(r,t,n,s),rh.createDefinition(e,r)}};class cf extends lm{set shaderDesc(e){if(this._shaderDesc=void 0,e&&(this._shaderDesc={uniqueName:e.uniqueName,attributes:e.attributes,fragmentOutputTypes:e.fragmentOutputTypes,vertexGLSL:e.vertexGLSL,fragmentGLSL:e.fragmentGLSL,vertexWGSL:e.vertexWGSL,fragmentWGSL:e.fragmentWGSL},e.vertexCode||e.fragmentCode||e.shaderLanguage)){let t=e.shaderLanguage??tz;t===tz?(this._shaderDesc.vertexGLSL=e.vertexCode,this._shaderDesc.fragmentGLSL=e.fragmentCode):t===tV&&(this._shaderDesc.vertexWGSL=e.vertexCode,this._shaderDesc.fragmentWGSL=e.fragmentCode);}this.clearVariants();}get shaderDesc(){return this._shaderDesc}copy(e){return super.copy(e),this.shaderDesc=e.shaderDesc,this}getShaderVariant(e){let{objDefs:t}=e,i={defines:nY.getCoreDefines(this,e),skin:(2&t)!=0,useInstancing:(32&t)!=0,useMorphPosition:(1024&t)!=0,useMorphNormal:(2048&t)!=0,useMorphTextureBasedInt:(8192&t)!=0,pass:e.pass,gamma:e.cameraShaderParams.shaderOutputGamma,toneMapping:e.cameraShaderParams.toneMapping,fog:e.cameraShaderParams.fog,shaderDesc:this.shaderDesc,shaderChunks:this.shaderChunks},s=new nO(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),r=nN(e.device);return r.register("shader-material",cu),r.getProgram("shader-material",i,s,this.userId)}constructor(e){super(),this.shaderDesc=e;}}var cp=`
uniform highp {sampler} {name};
{returnType} load{funcName}() { return texelFetch({name}, splat.uv, 0); }
{returnType} load{funcName}WithIndex(uint index) { return texelFetch({name}, ivec2(index % splatTextureSize, index / splatTextureSize), 0); }
`,cm=`
var {name}: {textureType};
fn load{funcName}() -> {returnType} { return textureLoad({name}, splat.uv, 0); }
fn load{funcName}WithIndex(index: u32) -> {returnType} { return textureLoad({name}, vec2i(i32(index % uniform.splatTextureSize), i32(index / uniform.splatTextureSize)), 0); }
`,c_=`
void write{funcName}({returnType} value) {
#if {defineGuard}
	pcFragColor{index} = value;
#endif
}
`,cg=`
fn write{funcName}(value: {returnType}) {
#if {defineGuard}
	processOutput.{colorSlot} = value;
#endif
}
`,cv=`
vec3 getCenter() { return loadDataCenter().xyz; }
vec4 getColor() { return loadDataColor(); }
vec3 getScale() { return loadDataScale().xyz; }
vec4 getRotation() { return loadDataRotation(); }
`,cS=`
fn getCenter() -> vec3f { return loadDataCenter().xyz; }
fn getColor() -> vec4f { return loadDataColor(); }
fn getScale() -> vec3f { return loadDataScale().xyz; }
fn getRotation() -> vec4f { return loadDataRotation(); }
`,cy=`
	vec3 getCenter() { return loadDataCenter().xyz; }
	vec4 getColor() { return loadDataColor(); }
	vec3 getScale() { return vec3(loadDataCenter().w); }
	vec4 getRotation() { return vec4(0.0, 0.0, 0.0, 1.0); }
`,cx=`
	fn getCenter() -> vec3f { return loadDataCenter().xyz; }
	fn getColor() -> vec4f { return loadDataColor(); }
	fn getScale() -> vec3f { return vec3f(loadDataCenter().w); }
	fn getRotation() -> vec4f { return vec4f(0.0, 0.0, 0.0, 1.0); }
`;let cT=e=>e.map(e=>`${e.name}:${e.format}:${e.storage}`).join(","),cE=/\{name\}/g,cw=/\{sampler\}/g,cb=/\{textureType\}/g,cA=/\{returnType\}/g,cC=/\{funcName\}/g,cP=/\{index\}/g,cI=/\{colorSlot\}/g,cD=/\{defineGuard\}/g;class cR{get hash(){if(void 0===this._hash){let e=cT(this.streams),t=cT(this._extraStreams);this._hash=iI(e+t+this._read);}return this._hash}get extraStreamsVersion(){return this._extraStreamsVersion}get extraStreams(){return this._extraStreams}get resourceStreams(){return null===this._resourceStreams&&(this._resourceStreams=[...this.streams.filter(e=>1!==e.storage),...this._extraStreams.filter(e=>1!==e.storage)]),this._resourceStreams}get instanceStreams(){return null===this._instanceStreams&&(this._instanceStreams=this._extraStreams.filter(e=>1===e.storage)),this._instanceStreams}addExtraStreams(e){if(!e||0===e.length)return;let t=false;for(let i of e)this._streamNames.has(i.name)||(this._extraStreams.push({name:i.name,format:i.format,storage:i.storage??0}),this._streamNames.add(i.name),t=true);t&&(this._extraStreamsVersion++,this._invalidateCaches());}getInputDeclarations(e){let t=this._device.isWebGPU,i=t?cm:cp,s=t?e2:e1,r=[],a=[...this.streams,...this._extraStreams];for(let t of(e&&(a=a.filter(t=>e.includes(t.name))),a)){let e=s(t.format),a=t.name.charAt(0).toUpperCase()+t.name.slice(1),n=i.replace(cE,t.name).replace(cw,e.sampler??"").replace(cb,e.textureType??"").replace(cA,e.returnType).replace(cC,a);r.push(n);}return r.join("\n")}getReadCode(){return this._read}getOutputDeclarations(e){let t=this._device.isWebGPU,i=[],s=t?cg:c_,r=t?e2:e1;for(let t=0;t<e.length;t++){let a=e[t],n=r(a.format),o=a.name.charAt(0).toUpperCase()+a.name.slice(1),l=0===t?"color":`color${t}`,h=s.replace(cC,o).replace(cA,n.returnType).replace(cP,String(t)).replace(cI,l).replace(cD,"1");i.push(h);}return i.join("\n")}getOutputStubs(e){let t=this._device.isWebGPU,i=[],s=t?cg:c_,r=t?e2:e1;for(let t of e){let e=r(t.format),a=t.name.charAt(0).toUpperCase()+t.name.slice(1),n=s.replace(cC,a).replace(cA,e.returnType).replace(cD,"0");i.push(n);}return i.join("\n")}getStream(e){let t=this.streams.find(t=>t.name===e);return t||(t=this._extraStreams.find(t=>t.name===e)),t}_invalidateCaches(){this._hash=void 0,this._resourceStreams=null,this._instanceStreams=null;}static createDefaultFormat(e){return new cR(e,[{name:"dataColor",format:12},{name:"dataCenter",format:14},{name:"dataScale",format:12},{name:"dataRotation",format:12}],{readGLSL:cv,readWGSL:cS})}static createSimpleFormat(e){return new cR(e,[{name:"dataCenter",format:14},{name:"dataColor",format:12}],{readGLSL:cy,readWGSL:cx})}constructor(e,t,i){this._extraStreams=[],this._streamNames=new Set,this._extraStreamsVersion=0,this._resourceStreams=null,this._instanceStreams=null,this._device=e,this.streams=[...t],this._streamNames=new Set(this.streams.map(e=>e.name));let s=e.isWebGPU;this._read=s?i.readWGSL:i.readGLSL;}}class cL{set colorizeLod(e){this._colorizeLod!==e&&(this._colorizeLod=e,this.dirty=true);}get colorizeLod(){return this._colorizeLod}set enableIds(e){e&&!this._enableIds&&(this._enableIds=true,this._format.getStream("pcId")||this._format.addExtraStreams([{name:"pcId",format:37}]),this.dirty=true);}get enableIds(){return this._enableIds}set lodBehindPenalty(e){this._lodBehindPenalty!==e&&(this._lodBehindPenalty=e,this.dirty=true);}get lodBehindPenalty(){return this._lodBehindPenalty}set lodRangeMin(e){this._lodRangeMin!==e&&(this._lodRangeMin=e,this.dirty=true);}get lodRangeMin(){return this._lodRangeMin}set lodRangeMax(e){this._lodRangeMax!==e&&(this._lodRangeMax=e,this.dirty=true);}get lodRangeMax(){return this._lodRangeMax}set lodUnderfillLimit(e){this._lodUnderfillLimit!==e&&(this._lodUnderfillLimit=e,this.dirty=true);}get lodUnderfillLimit(){return this._lodUnderfillLimit}set splatBudget(e){}get splatBudget(){return 0}set colorRamp(e){this._colorRamp!==e&&(this._colorRamp=e,this.dirty=true);}get colorRamp(){return this._colorRamp}get material(){return this._material}get format(){return this._format}frameEnd(){this._material.dirty=false,this.dirty=false;}constructor(e){this._material=new cf,this.debugAabbs=false,this.radialSorting=false,this.gpuSorting=false,this.debugNodeAabbs=false,this.dirty=false,this._colorizeLod=false,this._enableIds=false,this.lodUpdateDistance=1,this.lodUpdateAngle=0,this._lodBehindPenalty=1,this._lodRangeMin=0,this._lodRangeMax=10,this._lodUnderfillLimit=0,this._colorRamp=null,this.colorRampIntensity=1,this.colorizeColorUpdate=false,this.colorUpdateDistance=.2,this.colorUpdateAngle=2,this.colorUpdateDistanceLodScale=2,this.colorUpdateAngleLodScale=2,this.cooldownTicks=100;let t=e.getRenderableHdrFormat([12])||47;this._format=new cR(e,[{name:"dataColor",format:t},{name:"dataTransformA",format:49},{name:"dataTransformB",format:43}],{readGLSL:'#include "gsplatContainerPackedReadVS"',readWGSL:'#include "gsplatContainerPackedReadVS"'});}}let cM={linear:"decodeLinear",srgb:"decodeGamma",rgbm:"decodeRGBM",rgbe:"decodeRGBE",rgbp:"decodeRGBP",xy:"unpackNormalXY",xyz:"unpackNormalXYZ"},cO={linear:"encodeLinear",srgb:"encodeGamma",rgbm:"encodeRGBM",rgbe:"encodeRGBE",rgbp:"encodeRGBP"};class cF{static decodeFunc(e){return cM[e]??"decodeGamma"}static encodeFunc(e){return cO[e]??"encodeGamma"}}let cN=(e,t)=>{let i=t.length/3,s=e.length/3,r=new ed,a=new ed,n=new ed,o=new ed,l=new ed,h=new ed,c=[];for(let t=0;t<e.length;t++)c[t]=0;for(let s=0;s<i;s++){let i=t[3*s],d=t[3*s+1],u=t[3*s+2];r.set(e[3*i],e[3*i+1],e[3*i+2]),a.set(e[3*d],e[3*d+1],e[3*d+2]),n.set(e[3*u],e[3*u+1],e[3*u+2]),o.sub2(a,r),l.sub2(n,r),h.cross(o,l).normalize(),c[3*i]+=h.x,c[3*i+1]+=h.y,c[3*i+2]+=h.z,c[3*d]+=h.x,c[3*d+1]+=h.y,c[3*d+2]+=h.z,c[3*u]+=h.x,c[3*u+1]+=h.y,c[3*u+2]+=h.z;}for(let e=0;e<s;e++){let t=c[3*e],i=c[3*e+1],s=c[3*e+2],r=1/Math.sqrt(t*t+i*i+s*s);c[3*e]*=r,c[3*e+1]*=r,c[3*e+2]*=r;}return c},cB=(e,t,i,s)=>{let r=s.length/3,a=e.length/3,n=new ed,o=new ed,l=new ed,h=new ef,c=new ef,d=new ef,u=new ed,f=new ed,p=new Float32Array(3*a),m=new Float32Array(3*a),_=[];for(let t=0;t<r;t++){let r=s[3*t],a=s[3*t+1],_=s[3*t+2];n.set(e[3*r],e[3*r+1],e[3*r+2]),o.set(e[3*a],e[3*a+1],e[3*a+2]),l.set(e[3*_],e[3*_+1],e[3*_+2]),h.set(i[2*r],i[2*r+1]),c.set(i[2*a],i[2*a+1]),d.set(i[2*_],i[2*_+1]);let g=o.x-n.x,v=l.x-n.x,S=o.y-n.y,y=l.y-n.y,x=o.z-n.z,T=l.z-n.z,E=c.x-h.x,w=d.x-h.x,b=c.y-h.y,A=d.y-h.y,C=E*A-w*b;if(0===C)u.set(0,1,0),f.set(1,0,0);else {let e=1/C;u.set((A*g-b*v)*e,(A*S-b*y)*e,(A*x-b*T)*e),f.set((E*v-w*g)*e,(E*y-w*S)*e,(E*T-w*x)*e);}p[3*r+0]+=u.x,p[3*r+1]+=u.y,p[3*r+2]+=u.z,p[3*a+0]+=u.x,p[3*a+1]+=u.y,p[3*a+2]+=u.z,p[3*_+0]+=u.x,p[3*_+1]+=u.y,p[3*_+2]+=u.z,m[3*r+0]+=f.x,m[3*r+1]+=f.y,m[3*r+2]+=f.z,m[3*a+0]+=f.x,m[3*a+1]+=f.y,m[3*a+2]+=f.z,m[3*_+0]+=f.x,m[3*_+1]+=f.y,m[3*_+2]+=f.z;}let g=new ed,v=new ed,S=new ed,y=new ed;for(let e=0;e<a;e++){S.set(t[3*e],t[3*e+1],t[3*e+2]),g.set(p[3*e],p[3*e+1],p[3*e+2]),v.set(m[3*e],m[3*e+1],m[3*e+2]);let i=S.dot(g);y.copy(S).mulScalar(i),y.sub2(g,y).normalize(),_[4*e]=y.x,_[4*e+1]=y.y,_[4*e+2]=y.z,y.cross(S,g),_[4*e+3]=0>y.dot(v)?-1:1;}return _};class ck{calculateNormals(){this.normals=cN(this.positions,this.indices);}calculateTangents(){this.tangents=cB(this.positions,this.normals,this.uvs,this.indices);}}class cU extends ck{constructor(e={}){super();let t=e.halfExtents??new ed(.5,.5,.5),i=e.widthSegments??1,s=e.lengthSegments??1,r=e.heightSegments??1,a=e.yOffset??0,n=-t.y+a,o=t.y+a,l=[new ed(-t.x,n,t.z),new ed(t.x,n,t.z),new ed(t.x,o,t.z),new ed(-t.x,o,t.z),new ed(t.x,n,-t.z),new ed(-t.x,n,-t.z),new ed(-t.x,o,-t.z),new ed(t.x,o,-t.z)],h=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],c=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],d=[],u=[],f=[],p=[],m=[],_=0,g=(e,t,i)=>{let s=new ed,r=new ed,a=new ed,n=new ed;for(let o=0;o<=t;o++)for(let g=0;g<=i;g++){s.lerp(l[h[e][0]],l[h[e][1]],o/t),r.lerp(l[h[e][0]],l[h[e][2]],g/i),a.sub2(r,l[h[e][0]]),n.add2(s,a);let v=o/t,S=g/i;d.push(n.x,n.y,n.z),u.push(c[e][0],c[e][1],c[e][2]),f.push(v,1-S),S=(.75*S+.125)/3,v=(.75*v+.125)/3+e%3/3,S+=Math.floor(e/3)/3,p.push(v,1-S),o<t&&g<i&&(m.push(_+i+1,_+1,_),m.push(_+i+1,_+i+2,_+1)),_++;}};g(0,i,r),g(1,i,r),g(2,i,s),g(3,i,s),g(4,s,r),g(5,s,r),this.positions=d,this.normals=u,this.uvs=f,this.uvs1=p,this.indices=m,e.calculateTangents&&(this.tangents=cB(d,u,f,m));}}class cz extends ck{constructor(e={}){super();let t=e.radius??.5,i=e.latitudeBands??16,s=e.longitudeBands??16,r=[],a=[],n=[],o=[];for(let e=0;e<=i;e++){let o=e*Math.PI/i,l=Math.sin(o),h=Math.cos(o);for(let o=0;o<=s;o++){let c=2*o*Math.PI/s-Math.PI/2,d=Math.sin(c),u=Math.cos(c)*l,f=d*l,p=1-o/s,m=1-e/i;r.push(u*t,h*t,f*t),a.push(u,h,f),n.push(p,1-m);}}for(let e=0;e<i;++e)for(let t=0;t<s;++t){let i=e*(s+1)+t,r=i+s+1;o.push(i+1,r,i),o.push(i+1,r+1,r);}this.positions=r,this.normals=a,this.uvs=n,this.uvs1=n,this.indices=o,e.calculateTangents&&(this.tangents=cB(r,a,n,o));}}class cV extends cz{constructor(e={}){super({radius:.5,latitudeBands:e.latitudeBands??16,longitudeBands:e.longitudeBands??16});let t=this.positions;for(let e=0;e<t.length;e+=3){let i=t[e]/.5,s=t[e+1]/.5,r=t[e+2]/.5;s<0&&(s*=.3,i*i+r*r<.9025&&(s=-0.1)),s+=.1,s*=.5,t[e+1]=s;}}}class cG{static create(e,t){switch(t){case "box":return cG.box(e);case ny:return cG.dome(e)}return cG.infinite(e)}static infinite(e){return n7.fromGeometry(e,new cU(e))}static box(e){return n7.fromGeometry(e,new cU({yOffset:.5}))}static dome(e){let t=new cV({latitudeBands:50,longitudeBands:50});return t.normals=void 0,t.uvs=void 0,n7.fromGeometry(e,t)}}class cH{destroy(){this.meshInstance&&(this.skyLayer&&this.skyLayer.removeMeshInstances([this.meshInstance]),this.meshInstance.destroy(),this.meshInstance=null);}set depthWrite(e){this._depthWrite=e,this.meshInstance&&(this.meshInstance.material.depthWrite=e);}get depthWrite(){return this._depthWrite}constructor(e,t,i,s,r){this.meshInstance=null,this._depthWrite=false;let a=new cf({uniqueName:"SkyMaterial",vertexGLSL:nH.get(e,tz).get("skyboxVS"),fragmentGLSL:nH.get(e,tz).get("skyboxPS"),vertexWGSL:nH.get(e,tV).get("skyboxVS"),fragmentWGSL:nH.get(e,tV).get("skyboxPS"),attributes:{aPosition:e6}});a.setDefine("{SKYBOX_DECODE_FNC}",cF.decodeFunc(s.encoding)),r!==nS&&a.setDefine("SKYMESH",""),s.cubemap&&a.setDefine("SKY_CUBEMAP",""),a.setParameter("skyboxHighlightMultiplier",t.skyboxHighlightMultiplier),s.cubemap?a.setParameter("texture_cubeMap",s):(a.setParameter("texture_envAtlas",s),a.setParameter("mipLevel",t.skyboxMip)),a.cull=2,a.depthWrite=this._depthWrite;let n=t.layers.getLayerById(2);if(n){let t=new od(cG.create(e,r),a,i);this.meshInstance=t,t.cull=false,t.pick=false,n.addMeshInstances([t]),this.skyLayer=n;}}}class cW{applySettings(e){this.type=e.skyType??nS,this.node.setLocalPosition(new ed(e.skyMeshPosition??[0,0,0])),this.node.setLocalEulerAngles(new ed(e.skyMeshRotation??[0,0,0])),this.node.setLocalScale(new ed(e.skyMeshScale??[1,1,1])),e.skyCenter&&(this._center=new ed(e.skyCenter));}set type(e){this._type!==e&&(this._type=e,this.scene.updateShaders=true,this.updateSkyMesh());}get type(){return this._type}set center(e){this._center.copy(e);}get center(){return this._center}set depthWrite(e){this._depthWrite!==e&&(this._depthWrite=e,this.skyMesh&&(this.skyMesh.depthWrite=e));}get depthWrite(){return this._depthWrite}updateSkyMesh(){let e=this.scene._getSkyboxTex();e&&(this.resetSkyMesh(),this.skyMesh=new cH(this.device,this.scene,this.node,e,this.type),this.skyMesh.depthWrite=this._depthWrite,this.scene.fire("set:skybox",e));}resetSkyMesh(){this.skyMesh?.destroy(),this.skyMesh=null;}update(){if(this.type!==nS){let{center:e,centerArray:t}=this,i=new ed;this.node.getWorldTransform().transformPoint(e,i),t[0]=i.x,t[1]=i.y,t[2]=i.z,this.projectedSkydomeCenterId.setValue(t);}}constructor(e){this._type=nS,this._center=new ed(0,1,0),this.skyMesh=null,this._depthWrite=false,this.node=new oX("SkyMeshNode"),this.device=e.device,this.scene=e,this.center=new ed(0,1,0),this.centerArray=new Float32Array(3),this.projectedSkydomeCenterId=this.device.scope.resolve("projectedSkydomeCenter");}}let cX=new oX;cX.worldTransform=ey.IDENTITY,cX._dirtyWorld=cX._dirtyNormal=false;class cY{addLines(e,t){let i=this.positions,s=e.length;for(let t=0;t<s;t++){let s=e[t];i.push(s.x,s.y,s.z);}let r=this.colors;if(t.length)for(let e=0;e<s;e++){let i=t[e];r.push(i.r,i.g,i.b,i.a);}else for(let e=0;e<s;e++)r.push(t.r,t.g,t.b,t.a);}addLinesArrays(e,t){let i=this.positions;for(let t=0;t<e.length;t+=3)i.push(e[t],e[t+1],e[t+2]);let s=this.colors;if(t.length)for(let e=0;e<t.length;e+=4)s.push(t[e],t[e+1],t[e+2],t[e+3]);else {let i=e.length/3;for(let e=0;e<i;e++)s.push(t.r,t.g,t.b,t.a);}}onPreRender(e,t){this.positions.length>0&&this.material.transparent===t&&(this.mesh.setPositions(this.positions),this.mesh.setColors(this.colors),this.mesh.update(1,false),this.meshInstance||(this.meshInstance=new od(this.mesh,this.material,cX)),e.push(this.meshInstance));}clear(){this.positions.length=0,this.colors.length=0;}constructor(e,t,i){this.material=t,this.layer=i,this.positions=[],this.colors=[],this.mesh=new n7(e),this.meshInstance=null;}}class cq{getBatch(e,t){let i=this.map.get(e);return i||(i=new cY(this.device,e,t),this.map.set(e,i)),i}onPreRender(e,t){this.map.forEach(i=>{i.onPreRender(e,t);});}clear(){this.map.forEach(e=>e.clear());}constructor(e){this.device=e,this.map=new Map;}}let c$=[],cj=new ed;class cK{createMaterial(e){let t=new cf({uniqueName:"ImmediateLine",vertexGLSL:nH.get(this.device,tz).get("immediateLineVS"),fragmentGLSL:nH.get(this.device,tz).get("immediateLinePS"),vertexWGSL:nH.get(this.device,tV).get("immediateLineVS"),fragmentWGSL:nH.get(this.device,tV).get("immediateLinePS"),attributes:{vertex_position:e6,vertex_color:ti}});return t.blendType=2,t.depthTest=e,t.update(),t}get materialDepth(){return this._materialDepth||(this._materialDepth=this.createMaterial(true)),this._materialDepth}get materialNoDepth(){return this._materialNoDepth||(this._materialNoDepth=this.createMaterial(false)),this._materialNoDepth}getBatch(e,t){let i=this.batchesMap.get(e);i||(i=new cq(this.device),this.batchesMap.set(e,i)),this.allBatches.add(i);let s=t?this.materialDepth:this.materialNoDepth;return i.getBatch(s,e)}getShaderDesc(e,t,i){return this.shaderDescs.has(e)||this.shaderDescs.set(e,{uniqueName:`DebugShader:${e}`,vertexGLSL:`
					attribute vec2 vertex_position;
					uniform mat4 matrix_model;
					varying vec2 uv0;
					void main(void) {
						gl_Position = matrix_model * vec4(vertex_position, 0, 1);
						uv0 = vertex_position.xy + 0.5;
					}
				`,vertexWGSL:`
					attribute vertex_position: vec2f;
					uniform matrix_model: mat4x4f;
					varying uv0: vec2f;
					@vertex fn vertexMain(input: VertexInput) -> VertexOutput {
						var output: VertexOutput;
						output.position = uniform.matrix_model * vec4f(input.vertex_position, 0.0, 1.0);
						output.uv0 = input.vertex_position.xy + vec2f(0.5);
						return output;
					}
				`,fragmentGLSL:t,fragmentWGSL:i,attributes:{vertex_position:e6}}),this.shaderDescs.get(e)}getTextureShaderDesc(e){let t=cF.decodeFunc(e);return this.getShaderDesc(`textureShader-${e}`,`
			#include "gammaPS"
			varying vec2 uv0;
			uniform sampler2D colorMap;
			void main (void) {
				vec3 linearColor = ${t}(texture2D(colorMap, uv0));
				gl_FragColor = vec4(gammaCorrectOutput(linearColor), 1);
			}
		`,`
			#include "gammaPS"
			varying uv0: vec2f;
			var colorMap: texture_2d<f32>;
			var colorMapSampler: sampler;
			@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {
				var output: FragmentOutput;
				let sampledTex = textureSample(colorMap, colorMapSampler, input.uv0);
				let linearColor: vec3f = ${t}(sampledTex);
				output.color = vec4f(gammaCorrectOutput(linearColor), 1.0);
				return output;
			}
		`)}getUnfilterableTextureShaderDesc(){return this.getShaderDesc("textureShaderUnfilterable",`
			varying vec2 uv0;
			uniform highp sampler2D colorMap;
			void main (void) {
				ivec2 uv = ivec2(uv0 * textureSize(colorMap, 0));
				gl_FragColor = vec4(texelFetch(colorMap, uv, 0).xyz, 1);
			}
		`,`
			varying uv0: vec2f;
			var colorMap: texture_2d<uff>;
			@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {
				var output: FragmentOutput;
				let uv : vec2<i32> = vec2<i32>(input.uv0 * vec2f(textureDimensions(colorMap, 0)));
				let fetchedColor : vec4f = textureLoad(colorMap, uv, 0);
				output.color = vec4f(fetchedColor.xyz, 1.0);
				return output;
			}
		`)}getDepthTextureShaderDesc(){return this.getShaderDesc("depthTextureShader",`
			#include "screenDepthPS"
			#include "gammaPS"
			varying vec2 uv0;
			void main() {
				float depth = getLinearScreenDepth(getImageEffectUV(uv0)) * camera_params.x;
				gl_FragColor = vec4(gammaCorrectOutput(vec3(depth)), 1.0);
			}
		`,`
			#include "screenDepthPS"
			#include "gammaPS"
			varying uv0: vec2f;
			@fragment fn fragmentMain(input: FragmentInput) -> FragmentOutput {
				var output: FragmentOutput;
				let depth: f32 = getLinearScreenDepth(getImageEffectUV(input.uv0)) * uniform.camera_params.x;
				output.color = vec4f(gammaCorrectOutput(vec3f(depth)), 1.0);
				return output;
			}
		`)}getQuadMesh(){return this.quadMesh||(this.quadMesh=new n7(this.device),this.quadMesh.setPositions([-0.5,-0.5,0,.5,-0.5,0,-0.5,.5,0,.5,.5,0]),this.quadMesh.update(5)),this.quadMesh}drawMesh(e,t,i,s,r){s||(s=new od(i,e,this.getGraphNode(t)));let a=this.layerMeshInstances.get(r);a||(a=[],this.layerMeshInstances.set(r,a)),a.push(s);}drawWireAlignedBox(e,t,i,s,r,a){if(a){let i=(e,t,i)=>{cj.set(e,t,i),a.transformPoint(cj,cj),c$.push(cj.x,cj.y,cj.z);};i(e.x,e.y,e.z),i(e.x,t.y,e.z),i(e.x,t.y,e.z),i(t.x,t.y,e.z),i(t.x,t.y,e.z),i(t.x,e.y,e.z),i(t.x,e.y,e.z),i(e.x,e.y,e.z),i(e.x,e.y,t.z),i(e.x,t.y,t.z),i(e.x,t.y,t.z),i(t.x,t.y,t.z),i(t.x,t.y,t.z),i(t.x,e.y,t.z),i(t.x,e.y,t.z),i(e.x,e.y,t.z),i(e.x,e.y,e.z),i(e.x,e.y,t.z),i(e.x,t.y,e.z),i(e.x,t.y,t.z),i(t.x,t.y,e.z),i(t.x,t.y,t.z),i(t.x,e.y,e.z),i(t.x,e.y,t.z);}else c$.push(e.x,e.y,e.z,e.x,t.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,t.x,t.y,e.z,t.x,e.y,e.z,t.x,e.y,e.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,t.z,t.x,e.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,e.z,e.x,t.y,t.z,t.x,t.y,e.z,t.x,t.y,t.z,t.x,e.y,e.z,t.x,e.y,t.z);this.getBatch(r,s).addLinesArrays(c$,i),c$.length=0;}drawWireSphere(e,t,i,s,r,a){let n=2*Math.PI/s,o=0;for(let i=0;i<s;i++){let i=Math.sin(o),s=Math.cos(o),r=Math.sin(o+=n),a=Math.cos(o);c$.push(e.x+t*i,e.y,e.z+t*s),c$.push(e.x+t*r,e.y,e.z+t*a),c$.push(e.x+t*i,e.y+t*s,e.z),c$.push(e.x+t*r,e.y+t*a,e.z),c$.push(e.x,e.y+t*i,e.z+t*s),c$.push(e.x,e.y+t*r,e.z+t*a);}this.getBatch(a,r).addLinesArrays(c$,i),c$.length=0;}getGraphNode(e){let t=new oX("ImmediateDebug");return t.worldTransform=e,t._dirtyWorld=t._dirtyNormal=false,t}onPreRenderLayer(e,t,i){if(this.batchesMap.forEach((s,r)=>{r===e&&s.onPreRender(t,i);}),!this.updatedLayers.has(e)){this.updatedLayers.add(e);let i=this.layerMeshInstances.get(e);if(i){for(let e=0;e<i.length;e++)t.push(i[e]);i.length=0;}}}onPostRender(){this.allBatches.forEach(e=>e.clear()),this.allBatches.clear(),this.updatedLayers.clear();}constructor(e){this.shaderDescs=new Map,this.device=e,this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.batchesMap=new Map,this.allBatches=new Set,this.updatedLayers=new Set,this._materialDepth=null,this._materialNoDepth=null,this.layerMeshInstances=new Map;}}let cZ={circlePoint(e){let t=Math.sqrt(Math.random()),i=2*Math.random()*Math.PI;e.x=t*Math.cos(i),e.y=t*Math.sin(i);},circlePointDeterministic(e,t,i){let s=2.399963229728653*t,r=Math.sqrt(t/i);e.x=r*Math.cos(s),e.y=r*Math.sin(s);},spherePointDeterministic(e,t,i,s=0,r=1){s=1-2*s,r=1-2*r;let a=ei.lerp(s,r,t/i),n=Math.sqrt(1-a*a),o=2.399963229728653*t;e.x=Math.cos(o)*n,e.y=a,e.z=Math.sin(o)*n;},radicalInverse(e){let t=(e<<16|e>>>16)>>>0;return 23283064365386963e-26*(t=((0xff00ff&(t=((0xf0f0f0f&(t=((0x33333333&(t=((0x55555555&t)<<1|(0xaaaaaaaa&t)>>>1)>>>0))<<2|(0xcccccccc&t)>>>2)>>>0))<<4|(0xf0f0f0f0&t)>>>4)>>>0))<<8|(0xff00ff00&t)>>>8)>>>0)}},cQ=e=>{switch(e){case tB:return "Cubemap";case tU:return "Octahedral";default:return "Equirect"}},cJ=(e,t,i)=>{if(e<=0)t[i+0]=0,t[i+1]=0,t[i+2]=0,t[i+3]=0;else if(e>=1)t[i+0]=255,t[i+1]=0,t[i+2]=0,t[i+3]=0;else {let s=e%1,r=255*e%1,a=65025*e%1,n=0xfd02ff*e%1;s-=r/255,r-=a/255,a-=n/255,t[i+0]=Math.min(255,Math.floor(256*s)),t[i+1]=Math.min(255,Math.floor(256*r)),t[i+2]=Math.min(255,Math.floor(256*a)),t[i+3]=Math.min(255,Math.floor(256*n));}},c0=(e,t,i,s)=>{let r=2*i*Math.PI,a=Math.pow(1-t,1/(s+1)),n=Math.sqrt(1-a*a);e.set(Math.cos(r)*n,Math.sin(r)*n,a).normalize();},c1=(e,t,i)=>{let s=2*i*Math.PI,r=Math.sqrt(1-t),a=Math.sqrt(t);e.set(Math.cos(s)*a,Math.sin(s)*a,r).normalize();},c2=(e,t,i,s)=>{let r=2*i*Math.PI,a=Math.sqrt((1-t)/(1+(s*s-1)*t)),n=Math.sqrt(1-a*a);e.set(Math.cos(r)*n,Math.sin(r)*n,a).normalize();},c3=(e,t)=>{let i=e*t,s=t/(1-e*e+i*i);return s*s*(1/Math.PI)},c4={16:{2:26,8:20,32:17,128:16,512:16},32:{2:53,8:40,32:34,128:32,512:32},128:{2:214,8:163,32:139,128:130,512:128},1024:{2:1722,8:1310,32:1114,128:1041,512:1025}};class c5{destroy(){this.destroyContent&&this.map.forEach((e,t)=>{e.destroy();});}get(e,t){if(!this.map.has(e)){let i=t();return this.map.set(e,i),i}return this.map.get(e)}constructor(e=true){this.map=new Map,this.destroyContent=e;}}let c8=new c5(false),c6=new ii,c9=(e,t,i)=>c6.get(e,()=>new c5).get(t,()=>{let s;return s=(e=>{let t=e.length,i=Math.min(t,512),s=Math.ceil(t/i),r=new Uint8Array(i*s*4),a=0;for(let i=0;i<t;i+=4)cJ(.5*e[i+0]+.5,r,a+0),cJ(.5*e[i+1]+.5,r,a+4),cJ(.5*e[i+2]+.5,r,a+8),cJ(e[i+3]/8,r,a+12),a+=16;return {width:i,height:s,data:r}})(c8.get(t,i)),new ih(e,{name:t,width:s.width,height:s.height,mipmaps:false,minFilter:0,magFilter:0,levels:[s.data]})});function c7(e,t,i={}){let s=i.seamPixels??0,r=(i.rect?.z??t.width)-2*s,a=(i.rect?.w??t.height)-2*s;if(r<1||a<1)return  false;let n=i.hasOwnProperty("specularPower")?i.specularPower:1,o=i.hasOwnProperty("face")?i.face:null,l=i.hasOwnProperty("distribution")?i.distribution:1===n?"none":"phong",h={none:"reproject",lambert:"prefilterSamplesUnweighted",phong:"prefilterSamplesUnweighted",ggx:"prefilterSamples"}[l]||"reproject",c=h.startsWith("prefilterSamples"),d=cF.decodeFunc(e.encoding),u=cF.encodeFunc(t.encoding),f=`sample${cQ(e.projection)}`,p=`getDirection${cQ(t.projection)}`,m=i.hasOwnProperty("numSamples")?i.numSamples:1024,_=`ReprojectShader:${h}_${d}_${u}_${f}_${p}_${m}`,g=e.device,v=nN(g).getCachedShader(_);if(!v){let t=new Map;c&&t.set("USE_SAMPLES_TEX",""),e.cubemap&&t.set("CUBEMAP_SOURCE",""),t.set("{PROCESS_FUNC}",h),t.set("{DECODE_FUNC}",d),t.set("{ENCODE_FUNC}",u),t.set("{SOURCE_FUNC}",f),t.set("{TARGET_FUNC}",p),t.set("{NUM_SAMPLES}",m),t.set("{NUM_SAMPLES_SQRT}",Math.round(Math.sqrt(m)).toFixed(1));let i=g.isWebGPU,s=nH.get(g,i?tV:tz),r=new Map;r.set("decodePS",s.get("decodePS")),r.set("encodePS",s.get("encodePS")),v=nY.createShader(g,{uniqueName:_,attributes:{vertex_position:e6},vertexChunk:"reprojectVS",fragmentChunk:"reprojectPS",fragmentIncludes:r,fragmentDefines:t});}g.setBlendState(iS.NOBLEND),g.scope.resolve(e.cubemap?"sourceCube":"sourceTex").setValue(e);let S=g.scope.resolve("params"),y=g.scope.resolve("uvMod");s>0?y.setValue([(r+2*s)/r,(a+2*s)/a,-s/r,-s/a]):y.setValue([1,1,0,0]);let x=[0,t.width*t.height*(t.cubemap?6:1),e.width*e.height*(e.cubemap?6:1)];if(c){let t=e.width*e.height*(e.cubemap?6:1),i="ggx"===l?c9(g,`ggx-samples-${m}-${n}-${t}`,()=>((e,t,i)=>{let s,r=i/e,a=1-Math.log2(t)/11,n=a*a,o=new ed,l=new ed,h=new ed(0,0,1),c=[],d=(s=c4[e])&&s[t]||e;for(let e=0;e<d;++e){c2(o,e/d,cZ.radicalInverse(e),n);let t=o.z;if(l.set(o.x,o.y,o.z).mulScalar(2*t).sub(h),l.z>0){let e=.5*Math.log2(r/(c3(Math.min(1,t),n)/4+.001));c.push(l.x,l.y,l.z,e);}}for(;c.length<4*e;)c.push(0,0,0,0);return c})(m,n,t)):"lambert"===l?c9(g,`lambert-samples-${m}-${t}`,()=>((e,t)=>{let i=t/e,s=new ed,r=[];for(let t=0;t<e;++t){c1(s,t/e,cZ.radicalInverse(t));let a=.5*Math.log2(i/(s.z/Math.PI));r.push(s.x,s.y,s.z,a);}return r})(m,t)):c9(g,`phong-samples-${m}-${n}`,()=>((e,t)=>{let i=new ed,s=[];for(let r=0;r<e;++r)c0(i,r/e,cZ.radicalInverse(r),t),s.push(i.x,i.y,i.z,0);return s})(m,n));g.scope.resolve("samplesTex").setValue(i),g.scope.resolve("samplesTexInverseSize").setValue([1/i.width,1/i.height]);}for(let e=0;e<(t.cubemap?6:1);e++)if(null===o||e===o){let s=new iU({colorBuffer:t,face:e,depth:false,flipY:g.isWebGPU});x[0]=e,S.setValue(x),n0(g,s,v,i?.rect),s.destroy();}return  true}let de=(e,t=0)=>1+Math.floor(Math.log2(Math.max(e,t)));class dt{static generateSkyboxCubemap(e,t){let i,s,r=(i=e.device,s=t||(e.cubemap?e.width:e.width/4),new ih(i,{name:`lighting-${s}`,cubemap:true,width:s,height:s,format:7,type:tR,addressU:1,addressV:1,mipmaps:false}));return c7(e,r,{numSamples:1024}),r}static generateLightingSource(e,t){let i,s=e.device,r=(i=s).textureHalfFloatRenderable?12:i.textureFloatRenderable?14:7,a=t?.target||new ih(s,{name:"lighting-source",cubemap:true,width:t?.size||128,height:t?.size||128,format:r,type:7===r?tR:tP,addressU:1,addressV:1,mipmaps:true});return c7(e,a,{numSamples:e.mipmaps?1:1024}),a}static generateAtlas(e,t){let i=e.device,s=t?.target||new ih(i,{name:"envAtlas",width:t?.size||512,height:t?.size||512,format:7,type:tR,projection:tk,addressU:1,addressV:1,mipmaps:false}),r=s.width/512,a=new ep(0,0,512*r,256*r),n=de(256)-de(4);for(let t=0;t<n;++t)c7(e,s,{numSamples:1,rect:a,seamPixels:r}),a.x+=a.w,a.y+=a.w,a.z=Math.max(1,Math.floor(.5*a.z)),a.w=Math.max(1,Math.floor(.5*a.w));a.set(0,256*r,256*r,128*r);for(let i=1;i<7;++i)c7(e,s,{numSamples:t?.numReflectionSamples||1024,distribution:t?.distribution||"ggx",specularPower:Math.max(1,2048>>2*i),rect:a,seamPixels:r}),a.y+=a.w,a.z=Math.max(1,Math.floor(.5*a.z)),a.w=Math.max(1,Math.floor(.5*a.w));return a.set(128*r,384*r,64*r,32*r),c7(e,s,{numSamples:t?.numAmbientSamples||2048,distribution:"lambert",rect:a,seamPixels:r}),s}static generatePrefilteredAtlas(e,t){let i=e[0].device,s=e[0].format,r=e[0].type,a=t?.target||new ih(i,{name:"envPrefilteredAtlas",width:t?.size||512,height:t?.size||512,format:s,type:r,projection:tk,addressU:1,addressV:1,mipmaps:false}),n=a.width/512,o=new ep(0,0,512*n,256*n),l=de(512);for(let t=0;t<l;++t)c7(e[0],a,{numSamples:1,rect:o,seamPixels:n}),o.x+=o.w,o.y+=o.w,o.z=Math.max(1,Math.floor(.5*o.z)),o.w=Math.max(1,Math.floor(.5*o.w));o.set(0,256*n,256*n,128*n);for(let t=1;t<e.length;++t)c7(e[t],a,{numSamples:1,rect:o,seamPixels:n}),o.y+=o.w,o.z=Math.max(1,Math.floor(.5*o.z)),o.w=Math.max(1,Math.floor(.5*o.w));return o.set(128*n,384*n,64*n,32*n),t?.legacyAmbient?c7(e[5],a,{numSamples:1,rect:o,seamPixels:n}):c7(e[0],a,{numSamples:t?.numSamples||2048,distribution:"lambert",rect:o,seamPixels:n}),a}}class di{constructor(){this.type=a6,this.color=new es(0,0,0),this.density=0,this.start=1,this.end=1e3;}}class ds extends X{get defaultDrawLayer(){return this.layers.getLayerById(3)}set ambientBakeNumSamples(e){this._ambientBakeNumSamples=ei.clamp(Math.floor(e),1,255);}get ambientBakeNumSamples(){return this._ambientBakeNumSamples}set ambientBakeSpherePart(e){this._ambientBakeSpherePart=ei.clamp(e,.001,1);}get ambientBakeSpherePart(){return this._ambientBakeSpherePart}set clusteredLightingEnabled(e){this.device.isWebGPU&&!e||(this._clusteredLightingEnabled||!e)&&(this._clusteredLightingEnabled=e);}get clusteredLightingEnabled(){return this._clusteredLightingEnabled}set envAtlas(e){e!==this._envAtlas&&(this._envAtlas=e,e&&(e.addressU=1,e.addressV=1,e.minFilter=1,e.magFilter=1,e.mipmaps=false),this._prefilteredCubemaps=[],this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._resetSkyMesh());}get envAtlas(){return this._envAtlas}set layers(e){let t=this._layers;this._layers=e,this.fire("set:layers",t,e);}get layers(){return this._layers}get sky(){return this._sky}get lighting(){return this._lightingParams}get gsplat(){return this._gsplatParams}get fog(){return this._fogParams}set lightmapFilterRange(e){this._lightmapFilterRange=Math.max(e,.001);}get lightmapFilterRange(){return this._lightmapFilterRange}set lightmapFilterSmoothness(e){this._lightmapFilterSmoothness=Math.max(e,.001);}get lightmapFilterSmoothness(){return this._lightmapFilterSmoothness}set prefilteredCubemaps(e){e=e||[];let t=this._prefilteredCubemaps;(t.length!==e.length||t.some((t,i)=>t!==e[i]))&&(6===e.length&&e.every(e=>!!e)?(this._internalEnvAtlas=dt.generatePrefilteredAtlas(e,{target:this._internalEnvAtlas}),this._envAtlas=this._internalEnvAtlas):(this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._envAtlas=null),this._prefilteredCubemaps=e.slice(),this._resetSkyMesh());}get prefilteredCubemaps(){return this._prefilteredCubemaps}set skybox(e){e!==this._skyboxCubeMap&&(this._skyboxCubeMap=e,this._resetSkyMesh());}get skybox(){return this._skyboxCubeMap}set skyboxIntensity(e){e!==this._skyboxIntensity&&(this._skyboxIntensity=e,this._resetSkyMesh());}get skyboxIntensity(){return this._skyboxIntensity}set skyboxLuminance(e){e!==this._skyboxLuminance&&(this._skyboxLuminance=e,this._resetSkyMesh());}get skyboxLuminance(){return this._skyboxLuminance}set skyboxMip(e){e!==this._skyboxMip&&(this._skyboxMip=e,this._resetSkyMesh());}get skyboxMip(){return this._skyboxMip}set skyboxHighlightMultiplier(e){e!==this._skyboxHighlightMultiplier&&(this._skyboxHighlightMultiplier=e,this._resetSkyMesh());}get skyboxHighlightMultiplier(){return this._skyboxHighlightMultiplier}set skyboxRotation(e){if(!this._skyboxRotation.equals(e)){let t=e.equals(ex.IDENTITY);this._skyboxRotation.copy(e),t?this._skyboxRotationMat3.setIdentity():(this._skyboxRotationMat4.setTRS(ed.ZERO,e,ed.ONE),this._skyboxRotationMat3.invertMat4(this._skyboxRotationMat4)),this._skyboxRotationShaderInclude||t||(this._skyboxRotationShaderInclude=true,this._resetSkyMesh());}}get skyboxRotation(){return this._skyboxRotation}destroy(){this._resetSkyMesh(),this.root=null,this.off();}drawLine(e,t,i=es.WHITE,s=true,r=this.defaultDrawLayer){this.immediate.getBatch(r,s).addLines([e,t],[i,i]);}drawLines(e,t,i=true,s=this.defaultDrawLayer){this.immediate.getBatch(s,i).addLines(e,t);}drawLineArrays(e,t,i=true,s=this.defaultDrawLayer){this.immediate.getBatch(s,i).addLinesArrays(e,t);}applySettings(e){let t=e.physics,i=e.render;this._gravity.set(t.gravity[0],t.gravity[1],t.gravity[2]),this.ambientLight.set(i.global_ambient[0],i.global_ambient[1],i.global_ambient[2]),this.ambientLuminance=i.ambientLuminance,this.fog.type=i.fog,this.fog.color.set(i.fog_color[0],i.fog_color[1],i.fog_color[2]),this.fog.start=i.fog_start,this.fog.end=i.fog_end,this.fog.density=i.fog_density,this.lightmapSizeMultiplier=i.lightmapSizeMultiplier,this.lightmapMaxResolution=i.lightmapMaxResolution,this.lightmapMode=i.lightmapMode,this.exposure=i.exposure,this._skyboxIntensity=i.skyboxIntensity??1,this._skyboxLuminance=i.skyboxLuminance??2e4,this._skyboxMip=i.skyboxMip??0,i.skyboxRotation&&(this.skyboxRotation=new ex().setFromEulerAngles(i.skyboxRotation[0],i.skyboxRotation[1],i.skyboxRotation[2])),this.sky.applySettings(i),this.clusteredLightingEnabled=i.clusteredLightingEnabled??false,this.lighting.applySettings(i),["lightmapFilterEnabled","lightmapFilterRange","lightmapFilterSmoothness","ambientBake","ambientBakeNumSamples","ambientBakeSpherePart","ambientBakeOcclusionBrightness","ambientBakeOcclusionContrast"].forEach(e=>{i.hasOwnProperty(e)&&(this[e]=i[e]);}),this._resetSkyMesh();}_getSkyboxTex(){let e=this._prefilteredCubemaps;return this._skyboxMip?e[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||e[0]||this._skyboxCubeMap:this._skyboxCubeMap||e[0]||this._envAtlas}_updateSkyMesh(){this.sky.skyMesh||this.sky.updateSkyMesh(),this.sky.update();}_resetSkyMesh(){this.sky.resetSkyMesh(),this.updateShaders=true;}setSkybox(e){e?(this.skybox=e[0]||null,e[1]&&!e[1].cubemap?this.envAtlas=e[1]:this.prefilteredCubemaps=e.slice(1)):(this.skybox=null,this.envAtlas=null);}get lightmapPixelFormat(){return this.lightmapHDR&&this.device.getRenderableHdrFormat()||7}constructor(e){super(),this.ambientBake=false,this.ambientBakeOcclusionBrightness=0,this.ambientBakeOcclusionContrast=0,this.ambientLight=new es(0,0,0),this.ambientLuminance=0,this.exposure=1,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=1,this.lightmapFilterEnabled=false,this.lightmapHDR=false,this.root=null,this.physicalUnits=false,this._envAtlas=null,this._skyboxCubeMap=null,this._fogParams=new di,this.forcePassThroughSpecular=false,this.device=e,this._gravity=new ed(0,-9.8,0),this._layers=null,this._prefilteredCubemaps=[],this._internalEnvAtlas=null,this._skyboxIntensity=1,this._skyboxLuminance=0,this._skyboxMip=0,this._skyboxHighlightMultiplier=1,this._skyboxRotationShaderInclude=false,this._skyboxRotation=new ex,this._skyboxRotationMat3=new eu,this._skyboxRotationMat4=new ey,this._ambientBakeNumSamples=1,this._ambientBakeSpherePart=.4,this._lightmapFilterRange=10,this._lightmapFilterSmoothness=.2,this._clusteredLightingEnabled=true,this._lightingParams=new hw(this.device.supportsAreaLights,this.device.maxTextureSize,()=>{this.updateShaders=true;}),this._gsplatParams=new cL(this.device),this._sky=new cW(this),this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,updateShadersTime:0},this.updateShaders=true,this._shaderVersion=0,this.immediate=new cK(this.device);}}ds.EVENT_SETLAYERS="set:layers",ds.EVENT_SETSKYBOX="set:skybox",ds.EVENT_PRERENDER="prerender",ds.EVENT_POSTRENDER="postrender",ds.EVENT_PRERENDER_LAYER="prerender:layer",ds.EVENT_POSTRENDER_LAYER="postrender:layer",ds.EVENT_PRECULL="precull",ds.EVENT_POSTCULL="postcull";class dr{constructor(e,t,i){this.device=e,this.inverseBindPose=t,this.boneNames=i;}}let da=[0,0,1,0,0,1,0,0,1,0,0,1],dn=[0,1,3,2,3,1];class dl extends X{set frameKeys(e){this._frameKeys=e,this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=true:this._createMeshes()),this.fire("set:frameKeys",e);}get frameKeys(){return this._frameKeys}set atlas(e){e!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),this._atlas=e,this._atlas&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=true:this._createMeshes()),this.fire("set:atlas",e));}get atlas(){return this._atlas}set pixelsPerUnit(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this.fire("set:pixelsPerUnit",e),this._atlas&&this._frameKeys&&0===this.renderMode&&(this._updatingProperties?this._meshesDirty=true:this._createMeshes()));}get pixelsPerUnit(){return this._pixelsPerUnit}set renderMode(e){if(this._renderMode===e)return;let t=this._renderMode;this._renderMode=e,this.fire("set:renderMode",e),(0===t||0===e)&&this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=true:this._createMeshes());}get renderMode(){return this._renderMode}get meshes(){return this._meshes}_createMeshes(){let e=this._meshes.length;for(let t=0;t<e;t++){let e=this._meshes[t];e&&e.destroy();}let t=this._frameKeys.length;this._meshes=Array(t);let i=1===this.renderMode||2===this._renderMode?this._create9SliceMesh:this._createSimpleMesh;for(let e=0;e<t;e++){let t=this._atlas.frames[this._frameKeys[e]];this._meshes[e]=t?i.call(this,t):null;}this.fire("set:meshes");}_createSimpleMesh(e){let t=e.rect,i=this._atlas.texture.width,s=this._atlas.texture.height,r=t.z/this._pixelsPerUnit,a=t.w/this._pixelsPerUnit,n=e.pivot.x,o=e.pivot.y,l=t.x/i,h=1-t.y/s,c=(t.x+t.z)/i,d=1-(t.y+t.w)/s,u=new ck;return u.positions=[-n*r,-o*a,0,(1-n)*r,-o*a,0,(1-n)*r,(1-o)*a,0,-n*r,(1-o)*a,0],u.normals=da,u.uvs=[l,h,c,h,c,d,l,d],u.indices=dn,n7.fromGeometry(this._device,u)}_create9SliceMesh(){let e=ef.ONE,t=[],i=[],s=[],r=[],a=0;for(let n=0;n<=3;n++){let o=+(0!==n&&3!==n);for(let l=0;l<=3;l++){let h=-e.x+2*e.x*(n<=1?0:3)/3,c=-(-e.y+2*e.y*(l<=1?0:3)/3),d=+(0!==l&&3!==l);t.push(-h,0,c),i.push(0,1,0),s.push(o,d),n<3&&l<3&&(r.push(a+3+1,a+1,a),r.push(a+3+1,a+3+2,a+1)),a++;}}let n=new ck;return n.positions=t,n.normals=i,n.uvs=s,n.indices=r,n7.fromGeometry(this._device,n)}_onSetFrames(e){this._updatingProperties?this._meshesDirty=true:this._createMeshes();}_onFrameChanged(e,t){let i=this._frameKeys.indexOf(e);i<0||(t?0===this.renderMode&&(this._meshes[i]=this._createSimpleMesh(t)):this._meshes[i]=null,this.fire("set:meshes"));}_onFrameRemoved(e){let t=this._frameKeys.indexOf(e);t<0||(this._meshes[t]=null,this.fire("set:meshes"));}startUpdate(){this._updatingProperties=true,this._meshesDirty=false;}endUpdate(){this._updatingProperties=false,this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes(),this._meshesDirty=false;}destroy(){for(let e of this._meshes)e&&e.destroy();this._meshes.length=0;}constructor(e,t){super(),this._device=e,this._pixelsPerUnit=t&&void 0!==t.pixelsPerUnit?t.pixelsPerUnit:1,this._renderMode=t&&void 0!==t.renderMode?t.renderMode:0,this._atlas=t&&void 0!==t.atlas?t.atlas:null,this._frameKeys=t&&void 0!==t.frameKeys?t.frameKeys:null,this._meshes=[],this._updatingProperties=false,this._meshesDirty=false,this._atlas&&this._frameKeys&&this._createMeshes();}}class dh extends X{set texture(e){this._texture=e,this.fire("set:texture",e);}get texture(){return this._texture}set frames(e){this._frames=e,this.fire("set:frames",e);}get frames(){return this._frames}setFrame(e,t){let i=this._frames[e];i?(i.rect.copy(t.rect),i.pivot.copy(t.pivot),i.border.copy(t.border)):(i={rect:t.rect.clone(),pivot:t.pivot.clone(),border:t.border.clone()},this._frames[e]=i),this.fire("set:frame",e.toString(),i);}removeFrame(e){let t=this._frames[e];t&&(delete this._frames[e],this.fire("remove:frame",e.toString(),t));}destroy(){this._texture&&this._texture.destroy();}constructor(){super(),this._texture=null,this._frames=null;}}class dc{constructor(e,t,i,s){this.time=e,this.position=t,this.rotation=i,this.scale=s;}}class dd{constructor(){this._name="",this._keys=[];}}class du{getNode(e){return this._nodeDict[e]}addNode(e){this._nodes.push(e),this._nodeDict[e._name]=e;}get nodes(){return this._nodes}constructor(){this.name="",this.duration=0,this._nodes=[],this._nodeDict={};}}class df{getTarget(){return this._targetNode}setTarget(e){this._targetNode=e;}constructor(){this._written=false,this._name="",this._keyFrames=[],this._quat=new ex,this._pos=new ed,this._scale=new ed,this._targetNode=null;}}class dp{set animation(e){this._animation=e,this.currentTime=0;}get animation(){return this._animation}set currentTime(e){this._time=e;let t=this._interpolatedKeys.length;for(let e=0;e<t;e++){let t=this._interpolatedKeys[e]._name;this._currKeyIndices[t]=0;}this.addTime(0),this.updateGraph();}get currentTime(){return this._time}get numNodes(){return this._interpolatedKeys.length}addTime(e){if(null!==this._animation){let t=this._animation._nodes,i=this._animation.duration;if(this._time===i&&!this.looping)return;if(this._time+=e,this._time>i){this._time=this.looping?0:i;for(let e=0;e<t.length;e++){let i=t[e]._name;this._currKeyIndices[i]=0;}}else if(this._time<0){this._time=this.looping?i:0;for(let e=0;e<t.length;e++){let i=t[e],s=i._name;this._currKeyIndices[s]=i._keys.length-2;}}let s=e>=0?1:-1;for(let e=0;e<t.length;e++){let i=t[e],r=i._name,a=i._keys,n=this._interpolatedKeyDict[r];if(void 0===n)continue;let o=false;if(1!==a.length)for(let e=this._currKeyIndices[r];e<a.length-1&&e>=0;e+=s){let t=a[e],i=a[e+1];if(t.time<=this._time&&i.time>=this._time){let s=(this._time-t.time)/(i.time-t.time);n._pos.lerp(t.position,i.position,s),n._quat.slerp(t.rotation,i.rotation,s),n._scale.lerp(t.scale,i.scale,s),n._written=true,this._currKeyIndices[r]=e,o=true;break}}(1===a.length||!o&&0===this._time&&this.looping)&&(n._pos.copy(a[0].position),n._quat.copy(a[0].rotation),n._scale.copy(a[0].scale),n._written=true);}}}blend(e,t,i){let s=this._interpolatedKeys.length;for(let r=0;r<s;r++){let s=e._interpolatedKeys[r],a=t._interpolatedKeys[r],n=this._interpolatedKeys[r];s._written&&a._written?(n._quat.slerp(s._quat,t._interpolatedKeys[r]._quat,i),n._pos.lerp(s._pos,t._interpolatedKeys[r]._pos,i),n._scale.lerp(s._scale,a._scale,i),n._written=true):s._written?(n._quat.copy(s._quat),n._pos.copy(s._pos),n._scale.copy(s._scale),n._written=true):a._written&&(n._quat.copy(a._quat),n._pos.copy(a._pos),n._scale.copy(a._scale),n._written=true);}}setGraph(e){if(this.graph=e,e)for(let t=0;t<this._interpolatedKeys.length;t++){let i=this._interpolatedKeys[t],s=e.findByName(i._name);this._interpolatedKeys[t].setTarget(s);}else for(let e=0;e<this._interpolatedKeys.length;e++)this._interpolatedKeys[e].setTarget(null);}updateGraph(){if(this.graph)for(let e=0;e<this._interpolatedKeys.length;e++){let t=this._interpolatedKeys[e];if(t._written){let e=t.getTarget();e.localPosition.copy(t._pos),e.localRotation.copy(t._quat),e.localScale.copy(t._scale),e._dirtyLocal||e._dirtifyLocal(),t._written=false;}}}constructor(e){this.looping=true,this._animation=null,this._time=0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={},this.graph=null;let t=e=>{let i=new df;i._name=e.name,this._interpolatedKeys.push(i),this._interpolatedKeyDict[e.name]=i,this._currKeyIndices[e.name]=0;for(let i=0;i<e._children.length;i++)t(e._children[i]);};t(e);}}let dm=`
@group(0) @binding(0) var<storage, read_write> items: array<u32>;
@group(0) @binding(1) var<storage, read_write> blockSums: array<u32>;
struct PrefixSumUniforms {
	elementCount: u32
};
@group(0) @binding(2) var<uniform> uniforms: PrefixSumUniforms;
const WORKGROUP_SIZE_X: u32 = {WORKGROUP_SIZE_X}u;
const WORKGROUP_SIZE_Y: u32 = {WORKGROUP_SIZE_Y}u;
const THREADS_PER_WORKGROUP: u32 = {THREADS_PER_WORKGROUP}u;
const ITEMS_PER_WORKGROUP: u32 = {ITEMS_PER_WORKGROUP}u;
var<workgroup> temp: array<u32, ITEMS_PER_WORKGROUP * 2>;
@compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y, 1)
fn reduce_downsweep(
	@builtin(workgroup_id) w_id: vec3<u32>,
	@builtin(num_workgroups) w_dim: vec3<u32>,
	@builtin(local_invocation_index) TID: u32,
) {
	let WORKGROUP_ID = w_id.x + w_id.y * w_dim.x;
	let WID = WORKGROUP_ID * THREADS_PER_WORKGROUP;
	let GID = WID + TID;
	
	let ELM_TID = TID * 2;
	let ELM_GID = GID * 2;
	
	temp[ELM_TID] = select(items[ELM_GID], 0u, ELM_GID >= uniforms.elementCount);
	temp[ELM_TID + 1u] = select(items[ELM_GID + 1u], 0u, ELM_GID + 1u >= uniforms.elementCount);
	var offset: u32 = 1u;
	for (var d: u32 = ITEMS_PER_WORKGROUP >> 1u; d > 0u; d >>= 1u) {
		workgroupBarrier();
		if (TID < d) {
			var ai: u32 = offset * (ELM_TID + 1u) - 1u;
			var bi: u32 = offset * (ELM_TID + 2u) - 1u;
			temp[bi] += temp[ai];
		}
		offset *= 2u;
	}
	if (TID == 0u) {
		let last_offset = ITEMS_PER_WORKGROUP - 1u;
		blockSums[WORKGROUP_ID] = temp[last_offset];
		temp[last_offset] = 0u;
	}
	for (var d: u32 = 1u; d < ITEMS_PER_WORKGROUP; d *= 2u) {
		offset >>= 1u;
		workgroupBarrier();
		if (TID < d) {
			var ai: u32 = offset * (ELM_TID + 1u) - 1u;
			var bi: u32 = offset * (ELM_TID + 2u) - 1u;
			let t: u32 = temp[ai];
			temp[ai] = temp[bi];
			temp[bi] += t;
		}
	}
	workgroupBarrier();
	if (ELM_GID < uniforms.elementCount) {
		items[ELM_GID] = temp[ELM_TID];
	}
	if (ELM_GID + 1u < uniforms.elementCount) {
		items[ELM_GID + 1u] = temp[ELM_TID + 1u];
	}
}
@compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y, 1)
fn add_block_sums(
	@builtin(workgroup_id) w_id: vec3<u32>,
	@builtin(num_workgroups) w_dim: vec3<u32>,
	@builtin(local_invocation_index) TID: u32,
) {
	let WORKGROUP_ID = w_id.x + w_id.y * w_dim.x;
	let WID = WORKGROUP_ID * THREADS_PER_WORKGROUP;
	let GID = WID + TID;
	let ELM_ID = GID * 2u;
	if (ELM_ID >= uniforms.elementCount) {
		return;
	}
	let blockSum = blockSums[WORKGROUP_ID];
	items[ELM_ID] += blockSum;
	if (ELM_ID + 1u >= uniforms.elementCount) {
		return;
	}
	items[ELM_ID + 1u] += blockSum;
}
`;class d_{destroy(){this._destroyPasses(),this._scanShader?.destroy(),this._addBlockShader?.destroy(),this._bindGroupFormat?.destroy(),this._scanShader=null,this._addBlockShader=null,this._bindGroupFormat=null,this._uniformBufferFormat=null;}_createFormatsAndShaders(){this._uniformBufferFormat=new sf(this.device,[new su("elementCount",26)]),this._bindGroupFormat=new it(this.device,[new t9("items",4,false),new t9("blockSums",4,false),new t6("uniforms",4)]),this._scanShader=this._createShader("PrefixSumScan","reduce_downsweep"),this._addBlockShader=this._createShader("PrefixSumAddBlock","add_block_sums");}createPassesRecursive(e,t){let i=Math.ceil(t/512),{x:s,y:r}=this.findOptimalDispatchSize(i),a=new rI(this.device,4*i),n=new r6(this.device,this._scanShader,"PrefixSumScan");n.setParameter("items",e),n.setParameter("blockSums",a);let o={scanCompute:n,addBlockCompute:null,blockSumBuffer:a,dispatchX:s,dispatchY:r,count:t,allocatedCount:t};if(this.passes.push(o),i>1){this.createPassesRecursive(a,i);let t=new r6(this.device,this._addBlockShader,"PrefixSumAddBlock");t.setParameter("items",e),t.setParameter("blockSums",a),o.addBlockCompute=t;}}_createShader(e,t){let i=new Map;return i.set("{WORKGROUP_SIZE_X}",16),i.set("{WORKGROUP_SIZE_Y}",16),i.set("{THREADS_PER_WORKGROUP}",256),i.set("{ITEMS_PER_WORKGROUP}",512),new rd(this.device,{name:e,shaderLanguage:tV,cshader:dm,cdefines:i,computeEntryPoint:t,computeBindGroupFormat:this._bindGroupFormat,computeUniformBufferFormats:{uniforms:this._uniformBufferFormat}})}findOptimalDispatchSize(e){if(e<=(this.device.limits.maxComputeWorkgroupsPerDimension||65535))return {x:e,y:1};let t=Math.floor(Math.sqrt(e)),i=Math.ceil(e/t);return {x:t,y:i}}resize(e,t){if(this._countPassesNeeded(t)>this.passes.length){this._destroyPasses(),this.createPassesRecursive(e,t);return}let i=t;for(let e=0;e<this.passes.length;e++){let t=Math.ceil(i/512),{x:s,y:r}=this.findOptimalDispatchSize(t);if(this.passes[e].count=i,this.passes[e].dispatchX=s,this.passes[e].dispatchY=r,i=t,t<=1)break}}_destroyPasses(){for(let e of this.passes)e.blockSumBuffer?.destroy();this.passes.length=0;}_countPassesNeeded(e){let t=0,i=e;for(;i>0;){t++;let e=Math.ceil(i/512);if(e<=1)break;i=e;}return t}dispatch(e){for(let t=0;t<this.passes.length;t++){let i=this.passes[t];i.scanCompute.setParameter("elementCount",i.count),i.scanCompute.setupDispatch(i.dispatchX,i.dispatchY,1),e.computeDispatch([i.scanCompute],"PrefixSumScan");}for(let t=this.passes.length-1;t>=0;t--){let i=this.passes[t];i.addBlockCompute&&(i.addBlockCompute.setParameter("elementCount",i.count),i.addBlockCompute.setupDispatch(i.dispatchX,i.dispatchY,1),e.computeDispatch([i.addBlockCompute],"PrefixSumAddBlock"));}}constructor(e){this.passes=[],this._uniformBufferFormat=null,this._bindGroupFormat=null,this._scanShader=null,this._addBlockShader=null,this.device=e,this._createFormatsAndShaders();}}let dg=`
@group(0) @binding(0) var<storage, read> input: array<u32>;
@group(0) @binding(1) var<storage, read_write> local_prefix_sums: array<u32>;
@group(0) @binding(2) var<storage, read_write> block_sums: array<u32>;
struct RadixSortUniforms {
	workgroupCount: u32,
	elementCount: u32
};
@group(0) @binding(3) var<uniform> uniforms: RadixSortUniforms;
const THREADS_PER_WORKGROUP: u32 = {THREADS_PER_WORKGROUP}u;
const WORKGROUP_SIZE_X: u32 = {WORKGROUP_SIZE_X}u;
const WORKGROUP_SIZE_Y: u32 = {WORKGROUP_SIZE_Y}u;
const CURRENT_BIT: u32 = {CURRENT_BIT}u;
var<workgroup> histogram: array<atomic<u32>, 16>;
var<workgroup> thread_digits: array<u32, 256>;
@compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y, 1)
fn radix_sort(
	@builtin(workgroup_id) w_id: vec3<u32>,
	@builtin(num_workgroups) w_dim: vec3<u32>,
	@builtin(local_invocation_index) TID: u32,
) {
	let WORKGROUP_ID = w_id.x + w_id.y * w_dim.x;
	let WID = WORKGROUP_ID * THREADS_PER_WORKGROUP;
	let GID = WID + TID;
	if (TID < 16u) {
		atomicStore(&histogram[TID], 0u);
	}
	workgroupBarrier();
	let is_valid = GID < uniforms.elementCount && WORKGROUP_ID < uniforms.workgroupCount;
	let elm = select(0u, input[GID], is_valid);
	let digit: u32 = select(16u, (elm >> CURRENT_BIT) & 0xFu, is_valid);
	thread_digits[TID] = digit;
	if (is_valid) {
		atomicAdd(&histogram[digit], 1u);
	}
	workgroupBarrier();
	var local_prefix: u32 = 0u;
	if (is_valid) {
		let digit_vec = vec4<u32>(digit, digit, digit, digit);
		let ones = vec4<u32>(1u, 1u, 1u, 1u);
		let zeros = vec4<u32>(0u, 0u, 0u, 0u);
		
		var i: u32 = 0u;
		let limit = TID & ~3u;
		for (; i < limit; i += 4u) {
			let d = vec4<u32>(
				thread_digits[i],
				thread_digits[i + 1u],
				thread_digits[i + 2u],
				thread_digits[i + 3u]
			);
			let matches = select(zeros, ones, d == digit_vec);
			local_prefix += matches.x + matches.y + matches.z + matches.w;
		}
		
		for (; i < TID; i++) {
			local_prefix += select(0u, 1u, thread_digits[i] == digit);
		}
	}
	if (is_valid) {
		local_prefix_sums[GID] = local_prefix;
	}
	if (TID < 16u && WORKGROUP_ID < uniforms.workgroupCount) {
		block_sums[TID * uniforms.workgroupCount + WORKGROUP_ID] = atomicLoad(&histogram[TID]);
	}
}
`,dv=`
@group(0) @binding(0) var<storage, read> inputKeys: array<u32>;
@group(0) @binding(1) var<storage, read_write> outputKeys: array<u32>;
@group(0) @binding(2) var<storage, read> local_prefix_sum: array<u32>;
@group(0) @binding(3) var<storage, read> prefix_block_sum: array<u32>;
@group(0) @binding(4) var<storage, read> inputValues: array<u32>;
@group(0) @binding(5) var<storage, read_write> outputValues: array<u32>;
struct RadixSortUniforms {
	workgroupCount: u32,
	elementCount: u32
};
@group(0) @binding(6) var<uniform> uniforms: RadixSortUniforms;
const THREADS_PER_WORKGROUP: u32 = {THREADS_PER_WORKGROUP}u;
const WORKGROUP_SIZE_X: u32 = {WORKGROUP_SIZE_X}u;
const WORKGROUP_SIZE_Y: u32 = {WORKGROUP_SIZE_Y}u;
const CURRENT_BIT: u32 = {CURRENT_BIT}u;
const IS_FIRST_PASS: u32 = {IS_FIRST_PASS}u;
@compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y, 1)
fn radix_sort_reorder(
	@builtin(workgroup_id) w_id: vec3<u32>,
	@builtin(num_workgroups) w_dim: vec3<u32>,
	@builtin(local_invocation_index) TID: u32,
) {
	let WORKGROUP_ID = w_id.x + w_id.y * w_dim.x;
	let WID = WORKGROUP_ID * THREADS_PER_WORKGROUP;
	let GID = WID + TID;
	if (GID >= uniforms.elementCount) {
		return;
	}
	let k = inputKeys[GID];
	let v = select(inputValues[GID], GID, IS_FIRST_PASS == 1u);
	let local_prefix = local_prefix_sum[GID];
	let extract_bits = (k >> CURRENT_BIT) & 0xFu;
	
	let pid = extract_bits * uniforms.workgroupCount + WORKGROUP_ID;
	let sorted_position = prefix_block_sum[pid] + local_prefix;
	outputKeys[sorted_position] = k;
	outputValues[sorted_position] = v;
}
`;class dS{destroy(){this._destroyBuffers(),this._destroyPasses(),this._blockSumBindGroupFormat?.destroy(),this._reorderBindGroupFormat?.destroy(),this._blockSumBindGroupFormat=null,this._reorderBindGroupFormat=null,this._uniformBufferFormat=null;}_destroyPasses(){for(let e of this._passes)e.blockSumCompute.shader?.destroy(),e.reorderCompute.shader?.destroy();this._passes.length=0,this._numBits=0;}_destroyBuffers(){this._keys0?.destroy(),this._keys1?.destroy(),this._values0?.destroy(),this._values1?.destroy(),this._localPrefixSums?.destroy(),this._blockSums?.destroy(),this._sortedIndices?.destroy(),this._prefixSumKernel?.destroy(),this._keys0=null,this._keys1=null,this._values0=null,this._values1=null,this._localPrefixSums=null,this._blockSums=null,this._sortedIndices=null,this._prefixSumKernel=null,this._workgroupCount=0,this._allocatedWorkgroupCount=0;}get sortedIndices(){return this._sortedIndices}_createBindGroupFormats(){let e=this.device;this._uniformBufferFormat=new sf(e,[new su("workgroupCount",26),new su("elementCount",26)]),this._blockSumBindGroupFormat=new it(e,[new t9("input",4,true),new t9("local_prefix_sums",4,false),new t9("block_sums",4,false),new t6("uniforms",4)]),this._reorderBindGroupFormat=new it(e,[new t9("inputKeys",4,true),new t9("outputKeys",4,false),new t9("local_prefix_sum",4,true),new t9("prefix_block_sum",4,true),new t9("inputValues",4,true),new t9("outputValues",4,false),new t6("uniforms",4)]);}_createPasses(e){this._destroyPasses(),this._numBits=e;let t=e/4;for(let e=0;e<t;e++){let t=4*e,i=0===e,s=this._createShader(`RadixSort4bit-BlockSum-${t}`,dg,"radix_sort",t,false,this._blockSumBindGroupFormat),r=this._createShader(`RadixSort4bit-Reorder-${t}`,dv,"radix_sort_reorder",t,i,this._reorderBindGroupFormat),a=new r6(this.device,s,`RadixSort4bit-BlockSum-${t}`),n=new r6(this.device,r,`RadixSort4bit-Reorder-${t}`);this._passes.push({blockSumCompute:a,reorderCompute:n});}}_allocateBuffers(e,t){let i=Math.ceil(e/256),s=i>this._allocatedWorkgroupCount||!this._keys0,r=t!==this._numBits;if(this._workgroupCount=i,this._dispatchSize=this._findOptimalDispatchSize(i),s){this._destroyBuffers(),this._allocatedWorkgroupCount=i,this._workgroupCount=i,this._dispatchSize=this._findOptimalDispatchSize(i);let t=4*e;this._keys0=new rI(this.device,t,12),this._keys1=new rI(this.device,t,12),this._values0=new rI(this.device,t,12),this._values1=new rI(this.device,t,12),this._localPrefixSums=new rI(this.device,t,12),this._blockSums=new rI(this.device,16*i*4,12),this._sortedIndices=new rI(this.device,t,12),this._prefixSumKernel=new d_(this.device);}this._prefixSumKernel.resize(this._blockSums,16*i),r&&this._createPasses(t);}_findOptimalDispatchSize(e){if(e<=(this.device.limits.maxComputeWorkgroupsPerDimension||65535))return {x:e,y:1};let t=Math.floor(Math.sqrt(e)),i=Math.ceil(e/t);return {x:t,y:i}}_createShader(e,t,i,s,r,a){let n=new Map;return n.set("{WORKGROUP_SIZE_X}",16),n.set("{WORKGROUP_SIZE_Y}",16),n.set("{THREADS_PER_WORKGROUP}",256),n.set("{CURRENT_BIT}",s),n.set("{IS_FIRST_PASS}",+!!r),new rd(this.device,{name:e,shaderLanguage:tV,cshader:t,cdefines:n,computeEntryPoint:i,computeBindGroupFormat:a,computeUniformBufferFormats:{uniforms:this._uniformBufferFormat}})}sort(e,t,i=16){this._elementCount=t,this._allocateBuffers(t,i);let s=this.device,r=i/4,a=e,n=this._values0,o=this._keys0,l=this._values1;for(let e=0;e<r;e++){let{blockSumCompute:i,reorderCompute:h}=this._passes[e],c=e===r-1;i.setParameter("input",a),i.setParameter("local_prefix_sums",this._localPrefixSums),i.setParameter("block_sums",this._blockSums),i.setParameter("workgroupCount",this._workgroupCount),i.setParameter("elementCount",t),i.setupDispatch(this._dispatchSize.x,this._dispatchSize.y,1),s.computeDispatch([i],"RadixSort-BlockSum"),this._prefixSumKernel.dispatch(s);let d=c?this._sortedIndices:l;if(h.setParameter("inputKeys",a),h.setParameter("outputKeys",o),h.setParameter("local_prefix_sum",this._localPrefixSums),h.setParameter("prefix_block_sum",this._blockSums),h.setParameter("inputValues",n),h.setParameter("outputValues",d),h.setParameter("workgroupCount",this._workgroupCount),h.setParameter("elementCount",t),h.setupDispatch(this._dispatchSize.x,this._dispatchSize.y,1),s.computeDispatch([h],"RadixSort-Reorder"),!c){o=(a=o)===this._keys0?this._keys1:this._keys0;let e=n;n=l,l=e;}}return this._sortedIndices}constructor(e){this._elementCount=0,this._workgroupCount=0,this._allocatedWorkgroupCount=0,this._numBits=0,this._keys0=null,this._keys1=null,this._values0=null,this._values1=null,this._localPrefixSums=null,this._blockSums=null,this._sortedIndices=null,this._prefixSumKernel=null,this._dispatchSize={x:1,y:1},this._blockSumBindGroupFormat=null,this._reorderBindGroupFormat=null,this._uniformBufferFormat=null,this._passes=[],this.device=e,this._createBindGroupFormats();}}let dy=new ep;class dx{render(e,t,i){}drawQuad(e,t,i){let s;if(i){let t=e?e.width:this.device.width,r=e?e.height:this.device.height;s=dy.set(i.x*t,i.y*r,i.z*t,i.w*r);}this.device.setBlendState(iS.NOBLEND),n0(this.device,e,t,s);}constructor(e){this.device=e,this.needsDepthBuffer=false;}}dx.quadVertexShader=`
				attribute vec2 aPosition;
				varying vec2 vUv0;
				void main(void)
				{
						gl_Position = vec4(aPosition, 0.0, 1.0);
						vUv0 = getImageEffectUV((aPosition.xy + 1.0) * 0.5);
				}
		`;class dT extends as{set shader(e){this.quadRender?.destroy(),this.quadRender=null,this._shader=e,e&&(this.quadRender=new nZ(e));}get shader(){return this._shader}execute(){let e=this.device;e.setBlendState(this.blendState),e.setCullMode(this.cullMode),e.setDepthState(this.depthState),e.setStencilState(this.stencilFront,this.stencilBack),this.quadRender?.render(this.viewport,this.scissor);}constructor(...e){super(...e),this._shader=null,this.quadRender=null,this.cullMode=0,this.blendState=iS.NOBLEND,this.depthState=ix.NODEPTH,this.stencilFront=null,this.stencilBack=null;}}var dE=`
uniform highp usampler2D keysTexture;
uniform int bitsPerStep;
uniform int groupSize;
uniform int elementCount;
uniform int imageElementsLog2;
uniform int currentBit;
varying vec2 uv0;
uint interleaveWithZero(uint word) {
	word = (word ^ (word << 8u)) & 0x00ff00ffu;
	word = (word ^ (word << 4u)) & 0x0f0f0f0fu;
	word = (word ^ (word << 2u)) & 0x33333333u;
	word = (word ^ (word << 1u)) & 0x55555555u;
	return word;
}
uint deinterleaveWithZero(uint word) {
	word &= 0x55555555u;
	word = (word | (word >> 1u)) & 0x33333333u;
	word = (word | (word >> 2u)) & 0x0f0f0f0fu;
	word = (word | (word >> 4u)) & 0x00ff00ffu;
	word = (word | (word >> 8u)) & 0x0000ffffu;
	return word;
}
ivec2 indexToUV(uint index) {
	return ivec2(deinterleaveWithZero(index), deinterleaveWithZero(index >> 1u));
}
uint uvToIndex(ivec2 uv) {
	return interleaveWithZero(uint(uv.x)) | (interleaveWithZero(uint(uv.y)) << 1u);
}
void main() {
	ivec2 pixel = ivec2(gl_FragCoord.xy);
	uint morton = uvToIndex(pixel);
	
	uint elementsLog2 = uint(imageElementsLog2);
	uint groupsLog2 = elementsLog2 - uint(groupSize);
	uint digitIndex = morton >> groupsLog2;
	uint keyIndex = (morton - (digitIndex << groupsLog2)) << uint(groupSize);
	uint elemCount = uint(elementCount);
	
	if (keyIndex >= elemCount) {
		pcFragColor0 = 0.0;
		return;
	}
	
	uint count = 0u;
	uint mask = (1u << uint(bitsPerStep)) - 1u;
	uint cBit = uint(currentBit);
	uvec4 digitIdx4 = uvec4(digitIndex);
	uvec4 mask4 = uvec4(mask);
	uvec4 elemCount4 = uvec4(elemCount);
	const uvec4 QUAD_OFFSETS = uvec4(0u, 1u, 2u, 3u);
	
	bool isPartialGroup = (keyIndex + 16u) > elemCount;
	
	#ifdef SOURCE_LINEAR
		int sw = int(textureSize(keysTexture, 0).x);
	#endif
	
	#define QUAD_COUNT 4
	if (isPartialGroup) {
		#define BOUNDS_CHECK
		#include "radixSortCountQuad, QUAD_COUNT"
		#undef BOUNDS_CHECK
	} else {
		#include "radixSortCountQuad, QUAD_COUNT"
	}
	
	pcFragColor0 = float(count);
}
`,dw=`
{
	uint base = {i}u * 4u;
	uvec4 mi4 = (keyIndex + base) + QUAD_OFFSETS;
	#ifdef SOURCE_LINEAR
		uvec4 y4 = mi4 / uint(sw);
		uvec4 x4 = mi4 - y4 * uint(sw);
		uvec4 keys = uvec4(
			texelFetch(keysTexture, ivec2(x4.x, y4.x), 0).r,
			texelFetch(keysTexture, ivec2(x4.y, y4.y), 0).r,
			texelFetch(keysTexture, ivec2(x4.z, y4.z), 0).r,
			texelFetch(keysTexture, ivec2(x4.w, y4.w), 0).r
		);
	#else
		uvec4 keys = uvec4(
			texelFetch(keysTexture, indexToUV(mi4.x), 0).r,
			texelFetch(keysTexture, indexToUV(mi4.y), 0).r,
			texelFetch(keysTexture, indexToUV(mi4.z), 0).r,
			texelFetch(keysTexture, indexToUV(mi4.w), 0).r
		);
	#endif
	uvec4 digits = (keys >> cBit) & mask4;
	uvec4 m4 = uvec4(equal(digits, digitIdx4));
	#ifdef BOUNDS_CHECK
		m4 *= uvec4(lessThan(mi4, elemCount4));
	#endif
	count += m4.x + m4.y + m4.z + m4.w;
}
`,db=`
var keysTexture: texture_2d<u32>;
uniform bitsPerStep: i32;
uniform groupSize: i32;
uniform elementCount: i32;
uniform imageElementsLog2: i32;
uniform currentBit: i32;
varying uv0: vec2f;
fn interleaveWithZero(word_in: u32) -> u32 {
	var word = word_in;
	word = (word ^ (word << 8u)) & 0x00ff00ffu;
	word = (word ^ (word << 4u)) & 0x0f0f0f0fu;
	word = (word ^ (word << 2u)) & 0x33333333u;
	word = (word ^ (word << 1u)) & 0x55555555u;
	return word;
}
fn deinterleaveWithZero(word_in: u32) -> u32 {
	var word = word_in & 0x55555555u;
	word = (word | (word >> 1u)) & 0x33333333u;
	word = (word | (word >> 2u)) & 0x0f0f0f0fu;
	word = (word | (word >> 4u)) & 0x00ff00ffu;
	word = (word | (word >> 8u)) & 0x0000ffffu;
	return word;
}
fn indexToUV(index: u32) -> vec2i {
	return vec2i(i32(deinterleaveWithZero(index)), i32(deinterleaveWithZero(index >> 1u)));
}
fn uvToIndex(uv: vec2i) -> u32 {
	return interleaveWithZero(u32(uv.x)) | (interleaveWithZero(u32(uv.y)) << 1u);
}
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	
	let pixel = vec2i(input.position.xy);
	let morton = uvToIndex(pixel);
	
	let elementsLog2 = u32(uniform.imageElementsLog2);
	let groupsLog2 = elementsLog2 - u32(uniform.groupSize);
	let digitIndex = morton >> groupsLog2;
	let keyIndex = (morton - (digitIndex << groupsLog2)) << u32(uniform.groupSize);
	let elemCount = u32(uniform.elementCount);
	
	if (keyIndex >= elemCount) {
		output.color = 0.0;
		return output;
	}
	
	var count: u32 = 0u;
	let mask = (1u << u32(uniform.bitsPerStep)) - 1u;
	let cBit = u32(uniform.currentBit);
	let digitIdx4 = vec4u(digitIndex);
	let mask4 = vec4u(mask);
	let elemCount4 = vec4u(elemCount);
	let QUAD_OFFSETS = vec4u(0u, 1u, 2u, 3u);
	
	let isPartialGroup = (keyIndex + 16u) > elemCount;
	
	#ifdef SOURCE_LINEAR
		let sw = i32(textureDimensions(keysTexture, 0).x);
	#endif
	
	#define QUAD_COUNT 4
	if (isPartialGroup) {
		#define BOUNDS_CHECK
		#include "radixSortCountQuad, QUAD_COUNT"
		#undef BOUNDS_CHECK
	} else {
		#include "radixSortCountQuad, QUAD_COUNT"
	}
	
	output.color = f32(count);
	return output;
}
`,dA=`
{
	let base = {i}u * 4u;
	var mi4 = (keyIndex + base) + QUAD_OFFSETS;
	#ifdef SOURCE_LINEAR
		var y4 = vec4i(mi4) / sw;
		var x4 = vec4i(mi4) - y4 * sw;
		var keys = vec4u(
			textureLoad(keysTexture, vec2i(x4.x, y4.x), 0).r,
			textureLoad(keysTexture, vec2i(x4.y, y4.y), 0).r,
			textureLoad(keysTexture, vec2i(x4.z, y4.z), 0).r,
			textureLoad(keysTexture, vec2i(x4.w, y4.w), 0).r
		);
	#else
		var keys = vec4u(
			textureLoad(keysTexture, indexToUV(mi4.x), 0).r,
			textureLoad(keysTexture, indexToUV(mi4.y), 0).r,
			textureLoad(keysTexture, indexToUV(mi4.z), 0).r,
			textureLoad(keysTexture, indexToUV(mi4.w), 0).r
		);
	#endif
	var digits = (keys >> vec4u(cBit)) & mask4;
	var m4 = select(vec4u(0u), vec4u(1u), digits == digitIdx4);
	#ifdef BOUNDS_CHECK
		m4 = select(m4, vec4u(0u), mi4 >= elemCount4);
	#endif
	count += m4.x + m4.y + m4.z + m4.w;
}
`;class dC extends dT{setKeysTexture(e){this._keysTexture=e;}setDynamicParams(e,t){this._dynamicParams.elementCount=e,this._dynamicParams.imageElementsLog2=t;}execute(){this.keysTextureId.setValue(this._keysTexture),this.bitsPerStepId.setValue(this.bitsPerStep),this.groupSizeId.setValue(this.groupSize),this.elementCountId.setValue(this._dynamicParams.elementCount),this.imageElementsLog2Id.setValue(this._dynamicParams.imageElementsLog2),this.currentBitId.setValue(this.currentBit),super.execute();}constructor(e,t,i,s,r){super(e),this.sourceLinear=false,this.bitsPerStep=0,this.groupSize=0,this.currentBit=0,this._dynamicParams={elementCount:0,imageElementsLog2:0},this.sourceLinear=t,this.bitsPerStep=i,this.groupSize=s,this.currentBit=r,nH.get(e,tz).set("radixSortCountPS",dE),nH.get(e,tz).set("radixSortCountQuad",dw),nH.get(e,tV).set("radixSortCountPS",db),nH.get(e,tV).set("radixSortCountQuad",dA);let a=new Map;t&&a.set("SOURCE_LINEAR",""),this.shader=nY.createShader(e,{uniqueName:t?"RadixSortCountShaderLinear":"RadixSortCountShader",attributes:{aPosition:e6},vertexChunk:"quadVS",fragmentChunk:"radixSortCountPS",fragmentDefines:a,fragmentOutputTypes:"float"}),this.keysTextureId=e.scope.resolve("keysTexture"),this.bitsPerStepId=e.scope.resolve("bitsPerStep"),this.groupSizeId=e.scope.resolve("groupSize"),this.elementCountId=e.scope.resolve("elementCount"),this.imageElementsLog2Id=e.scope.resolve("imageElementsLog2"),this.currentBitId=e.scope.resolve("currentBit");}}var dP=`
uniform highp usampler2D keysTexture;
#ifdef SOURCE_LINEAR
	#define FIRST_PASS
#else
	uniform highp usampler2D indicesTexture;
#endif
uniform highp sampler2D prefixSums;
uniform int bitsPerStep;
uniform int groupSize;
uniform int elementCount;
uniform int imageElementsLog2;
uniform int currentBit;
uniform int imageSize;
varying vec2 uv0;
uint interleaveWithZero(uint word) {
	word = (word ^ (word << 8u)) & 0x00ff00ffu;
	word = (word ^ (word << 4u)) & 0x0f0f0f0fu;
	word = (word ^ (word << 2u)) & 0x33333333u;
	word = (word ^ (word << 1u)) & 0x55555555u;
	return word;
}
uint deinterleaveWithZero(uint word) {
	word &= 0x55555555u;
	word = (word | (word >> 1u)) & 0x33333333u;
	word = (word | (word >> 2u)) & 0x0f0f0f0fu;
	word = (word | (word >> 4u)) & 0x00ff00ffu;
	word = (word | (word >> 8u)) & 0x0000ffffu;
	return word;
}
ivec2 indexToUV(uint index) {
	return ivec2(deinterleaveWithZero(index), deinterleaveWithZero(index >> 1u));
}
uint uvToIndex(ivec2 uv) {
	return interleaveWithZero(uint(uv.x)) | (interleaveWithZero(uint(uv.y)) << 1u);
}
float countActiveTexels(ivec3 uv, ivec2 offset) {
	float scale = float(1u << (uint(uv.z) * 2u));
	return scale * texelFetch(prefixSums, uv.xy + offset, uv.z).r;
}
ivec2 activeTexelIndexToUV(float prefixWidth, float index, out float activePrevTexelSum) {
	float maxLod = round(log2(prefixWidth));
	ivec3 uv = ivec3(0, 0, int(maxLod));
	
	float countTotal = countActiveTexels(uv, ivec2(0, 0));
	activePrevTexelSum = 0.0;
	
	if (index >= countTotal) {
		activePrevTexelSum = countTotal;
		return ivec2(-1, -1);
	}
	
	while (uv.z >= 1) {
		uv = ivec3(uv.xy * 2, uv.z - 1);
		
		float count00 = countActiveTexels(uv, ivec2(0, 0));
		float count01 = countActiveTexels(uv, ivec2(1, 0));
		float count10 = countActiveTexels(uv, ivec2(0, 1));
		
		float sum00 = activePrevTexelSum + count00;
		float sum01 = sum00 + count01;
		float sum10 = sum01 + count10;
		
		bool in00 = index < sum00;
		bool in01 = index < sum01;
		bool in10 = index < sum10;
		
		if (in00) {
		} else if (in01) {
			uv.xy += ivec2(1, 0);
			activePrevTexelSum += count00;
		} else if (in10) {
			uv.xy += ivec2(0, 1);
			activePrevTexelSum += count00 + count01;
		} else {
			uv.xy += ivec2(1, 1);
			activePrevTexelSum += count00 + count01 + count10;
		}
	}
	
	return uv.xy;
}
void main() {
	ivec2 pixel = ivec2(gl_FragCoord.xy);
	
	#ifdef OUTPUT_LINEAR
		uint index = uint(pixel.y) * uint(imageSize) + uint(pixel.x);
	#else
		uint index = uvToIndex(pixel);
	#endif
	
	if (index >= uint(elementCount)) {
		pcFragColor0 = uvec4(0xFFFFFFFFu, 0u, 0u, 1u);
		pcFragColor1 = uvec4(0xFFFFFFFFu, 0u, 0u, 1u);
		return;
	}
	
	float prefixWidth = float(imageSize * (1 << (bitsPerStep >> 1))) / float(1 << (groupSize >> 1));
	
	float count;
	ivec2 activePixel = activeTexelIndexToUV(prefixWidth, float(index), count);
	
	if (activePixel.x < 0) {
		pcFragColor0 = uvec4(0xFFFFFFFFu, 0u, 0u, 1u);
		pcFragColor1 = uvec4(0xFFFFFFFFu, 0u, 0u, 1u);
		return;
	}
	
	uint activeIndex = uvToIndex(activePixel);
	uint elementsLog2 = uint(imageElementsLog2);
	uint groupsLog2 = elementsLog2 - uint(groupSize);
	uint digitIndex = activeIndex >> groupsLog2;
	uint keyIndex = (activeIndex - (digitIndex << groupsLog2)) << uint(groupSize);
	
	uint outKey = 0u;
	uint mask = (1u << uint(bitsPerStep)) - 1u;
	uint localIndexU = uint(float(index) - count);
	uint localCountU = 0u;
	uint foundMortonIndex = keyIndex;
	
	#ifdef SOURCE_LINEAR
		uint sw = uint(textureSize(keysTexture, 0).x);
		uint baseY = keyIndex / sw;
		uint baseX = keyIndex - baseY * sw;
		uint x = baseX;
		uint y = baseY;
		
		for (uint i = 0u; i < 16u; ++i) {
			ivec2 groupPixel = ivec2(int(x), int(y));
			outKey = texelFetch(keysTexture, groupPixel, 0).r;
			
			uint digit = (outKey >> uint(currentBit)) & mask;
			
			if (digit == digitIndex) {
				localCountU++;
				if (localCountU > localIndexU) {
					foundMortonIndex = keyIndex + i;
					break;
				}
			}
			
			x++;
			if (x >= sw) {
				x = 0u;
				y++;
			}
		}
	#else
		for (uint i = 0u; i < 16u; ++i) {
			uint mortonIndex = keyIndex + i;
			ivec2 groupPixel = indexToUV(mortonIndex);
			outKey = texelFetch(keysTexture, groupPixel, 0).r;
			
			uint digit = (outKey >> uint(currentBit)) & mask;
			
			if (digit == digitIndex) {
				localCountU++;
				if (localCountU > localIndexU) {
					foundMortonIndex = mortonIndex;
					break;
				}
			}
		}
	#endif
	
	#ifdef FIRST_PASS
		uint outIndex = foundMortonIndex;
	#else
		ivec2 indicesPixel = indexToUV(foundMortonIndex);
		uint outIndex = texelFetch(indicesTexture, indicesPixel, 0).r;
	#endif
	
	pcFragColor0 = uvec4(outKey, 0u, 0u, 1u);
	pcFragColor1 = uvec4(outIndex, 0u, 0u, 1u);
}
`,dI=`
var keysTexture: texture_2d<u32>;
#ifdef SOURCE_LINEAR
	#define FIRST_PASS
#else
	var indicesTexture: texture_2d<u32>;
#endif
var prefixSums: texture_2d<f32>;
uniform bitsPerStep: i32;
uniform groupSize: i32;
uniform elementCount: i32;
uniform imageElementsLog2: i32;
uniform currentBit: i32;
uniform imageSize: i32;
varying uv0: vec2f;
fn interleaveWithZero(word_in: u32) -> u32 {
	var word = word_in;
	word = (word ^ (word << 8u)) & 0x00ff00ffu;
	word = (word ^ (word << 4u)) & 0x0f0f0f0fu;
	word = (word ^ (word << 2u)) & 0x33333333u;
	word = (word ^ (word << 1u)) & 0x55555555u;
	return word;
}
fn deinterleaveWithZero(word_in: u32) -> u32 {
	var word = word_in & 0x55555555u;
	word = (word | (word >> 1u)) & 0x33333333u;
	word = (word | (word >> 2u)) & 0x0f0f0f0fu;
	word = (word | (word >> 4u)) & 0x00ff00ffu;
	word = (word | (word >> 8u)) & 0x0000ffffu;
	return word;
}
fn indexToUV(index: u32) -> vec2i {
	return vec2i(i32(deinterleaveWithZero(index)), i32(deinterleaveWithZero(index >> 1u)));
}
fn uvToIndex(uv: vec2i) -> u32 {
	return interleaveWithZero(u32(uv.x)) | (interleaveWithZero(u32(uv.y)) << 1u);
}
fn countActiveTexels(uv: vec3i, offset: vec2i) -> f32 {
	let scale = f32(1u << (u32(uv.z) * 2u));
	return scale * textureLoad(prefixSums, uv.xy + offset, uv.z).r;
}
struct BinarySearchResult {
	pixel: vec2i,
	prefixSum: f32
}
fn activeTexelIndexToUV(prefixWidth: f32, index: f32) -> BinarySearchResult {
	var result: BinarySearchResult;
	
	let maxLod = i32(round(log2(prefixWidth)));
	var uv = vec3i(0, 0, maxLod);
	
	let countTotal = countActiveTexels(uv, vec2i(0, 0));
	result.prefixSum = 0.0;
	
	if (index >= countTotal) {
		result.prefixSum = countTotal;
		result.pixel = vec2i(-1, -1);
		return result;
	}
	
	while (uv.z >= 1) {
		uv = vec3i(uv.xy * 2, uv.z - 1);
		
		let count00 = countActiveTexels(uv, vec2i(0, 0));
		let count01 = countActiveTexels(uv, vec2i(1, 0));
		let count10 = countActiveTexels(uv, vec2i(0, 1));
		
		let in00 = index < (result.prefixSum + count00);
		let in01 = index < (result.prefixSum + count00 + count01);
		let in10 = index < (result.prefixSum + count00 + count01 + count10);
		
		if (in00) {
		} else if (in01) {
			uv = vec3i(uv.x + 1, uv.y, uv.z);
			result.prefixSum += count00;
		} else if (in10) {
			uv = vec3i(uv.x, uv.y + 1, uv.z);
			result.prefixSum += count00 + count01;
		} else {
			uv = vec3i(uv.x + 1, uv.y + 1, uv.z);
			result.prefixSum += count00 + count01 + count10;
		}
	}
	
	result.pixel = uv.xy;
	return result;
}
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	
	let pixel = vec2i(input.position.xy);
	
	#ifdef OUTPUT_LINEAR
		let index = u32(pixel.y) * u32(uniform.imageSize) + u32(pixel.x);
	#else
		let index = uvToIndex(pixel);
	#endif
	
	if (index >= u32(uniform.elementCount)) {
		output.color = vec4u(0xFFFFFFFFu, 0u, 0u, 1u);
		output.color1 = vec4u(0xFFFFFFFFu, 0u, 0u, 1u);
		return output;
	}
	
	let prefixWidth = f32(uniform.imageSize * (1i << u32(uniform.bitsPerStep >> 1))) / f32(1i << u32(uniform.groupSize >> 1));
	let searchResult = activeTexelIndexToUV(prefixWidth, f32(index));
	
	if (searchResult.pixel.x < 0) {
		output.color = vec4u(0xFFFFFFFFu, 0u, 0u, 1u);
		output.color1 = vec4u(0xFFFFFFFFu, 0u, 0u, 1u);
		return output;
	}
	
	let activeIndex = uvToIndex(searchResult.pixel);
	let elementsLog2 = u32(uniform.imageElementsLog2);
	let groupsLog2 = elementsLog2 - u32(uniform.groupSize);
	let digitIndex = activeIndex >> groupsLog2;
	let keyIndex = (activeIndex - (digitIndex << groupsLog2)) << u32(uniform.groupSize);
	
	var outKey: u32 = 0u;
	let mask = (1u << u32(uniform.bitsPerStep)) - 1u;
	let localIndexU = u32(f32(index) - searchResult.prefixSum);
	var localCountU: u32 = 0u;
	var foundMortonIndex: u32 = keyIndex;
	
	#ifdef SOURCE_LINEAR
		let sw = textureDimensions(keysTexture, 0).x;
		let baseY = keyIndex / sw;
		let baseX = keyIndex - baseY * sw;
		var x = baseX;
		var y = baseY;
		
		for (var i: u32 = 0u; i < 16u; i = i + 1u) {
			let groupPixel = vec2i(i32(x), i32(y));
			outKey = textureLoad(keysTexture, groupPixel, 0).r;
			
			let digit = (outKey >> u32(uniform.currentBit)) & mask;
			
			if (digit == digitIndex) {
				localCountU = localCountU + 1u;
				if (localCountU > localIndexU) {
					foundMortonIndex = keyIndex + i;
					break;
				}
			}
			
			x = x + 1u;
			if (x >= sw) {
				x = 0u;
				y = y + 1u;
			}
		}
	#else
		for (var i: u32 = 0u; i < 16u; i = i + 1u) {
			let mortonIndex = keyIndex + i;
			let groupPixel = indexToUV(mortonIndex);
			outKey = textureLoad(keysTexture, groupPixel, 0).r;
			
			let digit = (outKey >> u32(uniform.currentBit)) & mask;
			
			if (digit == digitIndex) {
				localCountU = localCountU + 1u;
				if (localCountU > localIndexU) {
					foundMortonIndex = mortonIndex;
					break;
				}
			}
		}
	#endif
	
	#ifdef FIRST_PASS
		let outIndex = foundMortonIndex;
	#else
		let indicesPixel = indexToUV(foundMortonIndex);
		let outIndex = textureLoad(indicesTexture, indicesPixel, 0).r;
	#endif
	
	output.color = vec4u(outKey, 0u, 0u, 1u);
	output.color1 = vec4u(outIndex, 0u, 0u, 1u);
	return output;
}
`;class dD extends dT{setKeysTexture(e){this._keysTexture=e;}setIndicesTexture(e){this._indicesTexture=e;}setPrefixSumsTexture(e){this._prefixSums=e;}setDynamicParams(e,t,i){this._dynamicParams.elementCount=e,this._dynamicParams.imageElementsLog2=t,this._dynamicParams.imageSize=i;}execute(){this.keysTextureId.setValue(this._keysTexture),this.sourceLinear||this.indicesTextureId.setValue(this._indicesTexture),this.prefixSumsId.setValue(this._prefixSums),this.bitsPerStepId.setValue(this.bitsPerStep),this.groupSizeId.setValue(this.groupSize),this.elementCountId.setValue(this._dynamicParams.elementCount),this.imageElementsLog2Id.setValue(this._dynamicParams.imageElementsLog2),this.currentBitId.setValue(this.currentBit),this.imageSizeId.setValue(this._dynamicParams.imageSize),super.execute();}constructor(e,t,i,s,r,a){super(e),this.sourceLinear=false,this.outputLinear=false,this.bitsPerStep=0,this.groupSize=0,this.currentBit=0,this._dynamicParams={elementCount:0,imageElementsLog2:0,imageSize:0},this.sourceLinear=t,this.outputLinear=i,this.bitsPerStep=s,this.groupSize=r,this.currentBit=a,nH.get(e,tz).set("radixSortReorderPS",dP),nH.get(e,tV).set("radixSortReorderPS",dI);let n=new Map;t&&n.set("SOURCE_LINEAR",""),i&&n.set("OUTPUT_LINEAR","");let o="RadixSortReorderShader";t&&(o+="SourceLinear"),i&&(o+="OutputLinear"),this.shader=nY.createShader(e,{uniqueName:o,attributes:{aPosition:e6},vertexChunk:"quadVS",fragmentChunk:"radixSortReorderPS",fragmentDefines:n,fragmentOutputTypes:["uvec4","uvec4"]}),this.keysTextureId=e.scope.resolve("keysTexture"),t||(this.indicesTextureId=e.scope.resolve("indicesTexture")),this.prefixSumsId=e.scope.resolve("prefixSums"),this.bitsPerStepId=e.scope.resolve("bitsPerStep"),this.groupSizeId=e.scope.resolve("groupSize"),this.elementCountId=e.scope.resolve("elementCount"),this.imageElementsLog2Id=e.scope.resolve("imageElementsLog2"),this.currentBitId=e.scope.resolve("currentBit"),this.imageSizeId=e.scope.resolve("imageSize");}}class dR{constructor(){this.hasTangents=false,this.shaderChunks=null,this.pass=0,this.alphaTest=false,this.blendType=3,this.separateAmbient=false,this.screenSpace=false,this.skin=false,this.batch=false,this.useInstancing=false,this.useMorphPosition=false,this.useMorphNormal=false,this.useMorphTextureBasedInt=false,this.nineSlicedMode=0,this.clusteredLightingEnabled=true,this.clusteredLightingCookiesEnabled=false,this.clusteredLightingShadowsEnabled=false,this.clusteredLightingShadowType=0,this.clusteredLightingAreaLightsEnabled=false,this.vertexColors=false,this.useVertexColorGamma=false,this.lightMapEnabled=false,this.dirLightMapEnabled=false,this.useHeights=false,this.useNormals=false,this.useClearCoatNormals=false,this.useAo=false,this.diffuseMapEnabled=false,this.pixelSnap=false,this.ambientSH=false,this.ssao=false,this.twoSidedLighting=false,this.occludeDirect=false,this.occludeSpecular=0,this.occludeSpecularFloat=false,this.useMsdf=false,this.msdfTextAttribute=false,this.alphaToCoverage=false,this.opacityFadesSpecular=false,this.opacityDither=nx,this.opacityShadowDither=nx,this.cubeMapProjection=0,this.useSpecular=false,this.useSpecularityFactor=false,this.enableGGXSpecular=false,this.fresnelModel=0,this.useRefraction=false,this.useClearCoat=false,this.useSheen=false,this.useIridescence=false,this.useMetalness=false,this.useDynamicRefraction=false,this.dispersion=false,this.fog=a6,this.gamma=0,this.toneMap=-1,this.reflectionSource=nl,this.reflectionEncoding=null,this.reflectionCubemapEncoding=null,this.ambientSource="constant",this.ambientEncoding=null,this.skyboxIntensity=1,this.useCubeMapRotation=false,this.lightMapWithoutAmbient=false,this.lights=[],this.noShadow=false,this.lightMaskDynamic=0,this.userAttributes={},this.linearDepth=false,this.shadowCatcher=false;}}class dL{static update(e,t,i,s,r,a,n){dL.updateSharedOptions(e,t,i,r,a),dL.updateMaterialOptions(e,t),dL.updateEnvOptions(e,t,i,s),dL.updateLightingOptions(e,t,i,r,n);}static updateSharedOptions(e,t,i,s,r){e.shaderChunks=t.shaderChunks,e.pass=r,e.alphaTest=t.alphaTest>0,e.blendType=t.blendType,e.screenSpace=s&&(256&s)!=0,e.skin=s&&(2&s)!=0,e.useInstancing=s&&(32&s)!=0,e.useMorphPosition=s&&(1024&s)!=0,e.useMorphNormal=s&&(2048&s)!=0,e.useMorphTextureBasedInt=s&&(8192&s)!=0,e.hasTangents=s&&(512&s)!=0,e.nineSlicedMode=t.nineSlicedMode||0,t.useLighting&&i.clusteredLightingEnabled?(e.clusteredLightingEnabled=true,e.clusteredLightingCookiesEnabled=i.lighting.cookiesEnabled,e.clusteredLightingShadowsEnabled=i.lighting.shadowsEnabled,e.clusteredLightingShadowType=i.lighting.shadowType,e.clusteredLightingAreaLightsEnabled=i.lighting.areaLightsEnabled):(e.clusteredLightingEnabled=false,e.clusteredLightingCookiesEnabled=false,e.clusteredLightingShadowsEnabled=false,e.clusteredLightingAreaLightsEnabled=false);}static updateMaterialOptions(e,t){e.separateAmbient=false,e.pixelSnap=t.pixelSnap,e.ambientSH=t.ambientSH,e.twoSidedLighting=t.twoSidedLighting,e.occludeDirect=t.occludeDirect,e.occludeSpecular=t.occludeSpecular,e.occludeSpecularFloat=1!==t.occludeSpecularIntensity,e.useMsdf=false,e.msdfTextAttribute=false,e.alphaToCoverage=t.alphaToCoverage,e.opacityFadesSpecular=t.opacityFadesSpecular,e.opacityDither=t.opacityDither,e.cubeMapProjection=0,e.useSpecular=t.hasSpecular,e.useSpecularityFactor=t.hasSpecularityFactor,e.enableGGXSpecular=t.ggxSpecular,e.useAnisotropy=false,e.fresnelModel=t.fresnelModel,e.useRefraction=t.hasRefraction,e.useClearCoat=t.hasClearCoat,e.useSheen=t.hasSheen,e.useIridescence=t.hasIrridescence,e.useMetalness=t.hasMetalness,e.useDynamicRefraction=t.dynamicRefraction,e.dispersion=t.dispersion>0,e.vertexColors=false,e.lightMapEnabled=t.hasLighting,e.dirLightMapEnabled=t.dirLightMap,e.useHeights=t.hasHeights,e.useNormals=t.hasNormals,e.useClearCoatNormals=t.hasClearCoatNormals,e.useAo=t.hasAo,e.diffuseMapEnabled=t.hasDiffuseMap;}static updateEnvOptions(e,t,i,s){e.fog=t.useFog?s.fog:a6,e.gamma=s.shaderOutputGamma,e.toneMap=t.useTonemap?s.toneMapping:6,t.useSkybox&&i.envAtlas&&i.skybox?(e.reflectionSource=nc,e.reflectionEncoding=i.envAtlas.encoding,e.reflectionCubemapEncoding=i.skybox.encoding):t.useSkybox&&i.envAtlas?(e.reflectionSource=nh,e.reflectionEncoding=i.envAtlas.encoding):t.useSkybox&&i.skybox?(e.reflectionSource=nd,e.reflectionEncoding=i.skybox.encoding):(e.reflectionSource=nl,e.reflectionEncoding=null),t.ambientSH?(e.ambientSource=np,e.ambientEncoding=null):e.reflectionSource!==nl&&i.envAtlas?(e.ambientSource=nm,e.ambientEncoding=i.envAtlas.encoding):(e.ambientSource=n_,e.ambientEncoding=null);let r=e.reflectionSource!==nl;e.skyboxIntensity=r,e.useCubeMapRotation=r&&i._skyboxRotationShaderInclude;}static updateLightingOptions(e,t,i,s,r){if(e.lightMapWithoutAmbient=false,t.useLighting){let t=[],a=s?s>>16:1;e.lightMaskDynamic=!!(1&a),e.lightMapWithoutAmbient=false,r&&(dL.collectLights(0,r[0],t,a),i.clusteredLightingEnabled||(dL.collectLights(1,r[1],t,a),dL.collectLights(2,r[2],t,a))),e.lights=t;}else e.lights=[];(0!==e.lights.length||i.clusteredLightingEnabled)&&(1&s)==0||(e.noShadow=true);}static collectLights(e,t,i,s){for(let e=0;e<t.length;e++){let r=t[e];r.enabled&&r.mask&s&&i.push(r);}}}let dM={vertex_normal:e9,vertex_tangent:e7,vertex_texCoord0:tr,vertex_texCoord1:ta,vertex_color:ti,vertex_boneWeights:te,vertex_boneIndices:tt};class dO{fDefineSet(e,t,i=""){e&&this.fDefines.set(t,i);}generateVertexShader(e,t,i){let{options:s,vDefines:r,attributes:a}=this,n=new Map;if(n.set("vPositionW","vec3"),(1===s.nineSlicedMode||2===s.nineSlicedMode)&&r.set("NINESLICED",true),this.options.linearDepth&&(r.set("LINEAR_DEPTH",true),n.set("vLinearDepth","float")),this.needsNormal&&r.set("NORMALS",true),this.options.useInstancing){let e=nH.get(this.device,this.shaderLanguage);this.chunks.get("transformInstancingVS")===e.get("transformInstancingVS")&&(a.instance_line1=tE,a.instance_line2=tw,a.instance_line3=tA,a.instance_line4=tC);}this.needsNormal&&(a.vertex_normal=e9,n.set("vNormalW","vec3"),s.hasTangents&&(s.useHeights||s.useNormals||s.useClearCoatNormals||s.enableGGXSpecular)?(r.set("TANGENTS",true),a.vertex_tangent=e7,n.set("vTangentW","vec3"),n.set("vBinormalW","vec3")):s.enableGGXSpecular&&(r.set("GGX_SPECULAR",true),n.set("vObjectSpaceUpW","vec3")));for(let i=0;i<2;i++)e[i]&&(r.set(`UV${i}`,true),a[`vertex_texCoord${i}`]=`TEXCOORD${i}`),t[i]&&(r.set(`UV${i}_UNMODIFIED`,true),n.set(`vUv${i}`,"vec2"));let o=0,l=new Set;i.forEach(e=>{let{id:t,uv:i,name:s}=e,a=t+100*i;if(!l.has(a)){l.add(a),n.set(`vUV${i}_${t}`,"vec2");let e=`texture_${s}MapTransform`;r.set(`{TRANSFORM_NAME_${o}}`,e),r.set(`{TRANSFORM_UV_${o}}`,i),r.set(`{TRANSFORM_ID_${o}}`,t),o++;}}),r.set("UV_TRANSFORMS_COUNT",o),s.vertexColors&&(a.vertex_color=ti,r.set("VERTEX_COLOR",true),n.set("vVertexColor","vec4"),s.useVertexColorGamma&&r.set("STD_VERTEX_COLOR_GAMMA","")),s.useMsdf&&s.msdfTextAttribute&&(a.vertex_outlineParameters=ty,a.vertex_shadowParameters=tx,r.set("MSDF",true)),(s.useMorphPosition||s.useMorphNormal)&&(r.set("MORPHING",true),s.useMorphTextureBasedInt&&r.set("MORPHING_INT",true),s.useMorphPosition&&r.set("MORPHING_POSITION",true),s.useMorphNormal&&r.set("MORPHING_NORMAL",true),a.morph_vertex_id=tC),s.skin&&(a.vertex_boneIndices=tt,s.batch?r.set("BATCH",true):(a.vertex_boneWeights=te,r.set("SKIN",true))),s.useInstancing&&r.set("INSTANCING",true),s.screenSpace&&r.set("SCREENSPACE",true),s.pixelSnap&&r.set("PIXELSNAP",true),n.forEach((e,t)=>{this.varyingsCode+=`#define VARYING_${t.toUpperCase()}
`,this.varyingsCode+=this.shaderLanguage===tV?`varying ${t}: ${t3.get(e)};
`:`varying ${e} ${t};
`;}),this.includes.set("varyingsVS",this.varyingsCode),this.includes.set("varyingsPS",this.varyingsCode),this.vshader=`
						#include "litMainVS"
				`;}_setupLightingDefines(e,t){let i=this.fDefines,s=this.options;if(this.fDefines.set("LIGHT_COUNT",s.lights.length),e&&i.set("AREA_LIGHTS",true),t&&this.lighting&&(i.set("LIT_CLUSTERED_LIGHTS",true),s.clusteredLightingCookiesEnabled&&i.set("CLUSTER_COOKIES",true),s.clusteredLightingAreaLightsEnabled&&i.set("CLUSTER_AREALIGHTS",true),s.lightMaskDynamic&&i.set("CLUSTER_MESH_DYNAMIC_LIGHTS",true),s.clusteredLightingShadowsEnabled&&!s.noShadow)){let e=ns.get(s.clusteredLightingShadowType);i.set("CLUSTER_SHADOWS",true),i.set(`SHADOW_KIND_${e.kind}`,true),i.set(`CLUSTER_SHADOW_TYPE_${e.kind}`,true);}for(let r=0;r<s.lights.length;r++){let a=s.lights[r],n=a._type;if(t&&0!==n)continue;let o=e&&a._shape?a._shape:0,l=a._shadowType,h=a.castShadows&&!s.noShadow,c=ns.get(l);i.set(`LIGHT${r}`,true),i.set(`LIGHT${r}TYPE`,`${ne[n]}`),i.set(`LIGHT${r}SHADOWTYPE`,`${c.name}`),i.set(`LIGHT${r}SHAPE`,`${nt[o]}`),i.set(`LIGHT${r}FALLOFF`,`${ni[a._falloffMode]}`),a.affectSpecularity&&i.set(`LIGHT${r}AFFECT_SPECULARITY`,true),a._cookie&&(2===n&&!a._cookie._cubemap||1===n&&a._cookie._cubemap)&&(i.set(`LIGHT${r}COOKIE`,true),i.set(`{LIGHT${r}COOKIE_CHANNEL}`,a._cookieChannel),2===n&&(a._cookieTransform&&i.set(`LIGHT${r}COOKIE_TRANSFORM`,true),a._cookieFalloff&&i.set(`LIGHT${r}COOKIE_FALLOFF`,true))),h&&(i.set(`LIGHT${r}CASTSHADOW`,true),c.pcf&&i.set(`LIGHT${r}SHADOW_PCF`,true),a._normalOffsetBias&&!a._isVsm&&i.set(`LIGHT${r}_SHADOW_SAMPLE_NORMAL_OFFSET`,true),0===n&&(i.set(`LIGHT${r}_SHADOW_SAMPLE_ORTHO`,true),a.cascadeBlend>0&&i.set(`LIGHT${r}_SHADOW_CASCADE_BLEND`,true),a.numCascades>1&&i.set(`LIGHT${r}_SHADOW_CASCADES`,true)),(c.pcf||c.pcss||this.device.isWebGPU)&&i.set(`LIGHT${r}_SHADOW_SAMPLE_SOURCE_ZBUFFER`,true),1===n&&i.set(`LIGHT${r}_SHADOW_SAMPLE_POINT`,true)),h&&(i.set(`SHADOW_KIND_${c.kind}`,true),0===n&&i.set("SHADOW_DIRECTIONAL",true));}}prepareForwardPass(e){let{options:t}=this,i=t.clusteredLightingEnabled&&t.clusteredLightingAreaLightsEnabled||t.lights.some(e=>e._shape&&0!==e._shape),s=!t.lightMapEnabled||t.lightMapWithoutAmbient,r=this.needsNormal&&(t.useNormals||t.useClearCoatNormals||t.enableGGXSpecular&&!t.useHeights);t.useSpecular&&(this.fDefineSet(true,"LIT_SPECULAR"),this.fDefineSet(this.reflections,"LIT_REFLECTIONS"),this.fDefineSet(t.useClearCoat,"LIT_CLEARCOAT"),this.fDefineSet(t.fresnelModel>0,"LIT_SPECULAR_FRESNEL"),this.fDefineSet(t.useSheen,"LIT_SHEEN"),this.fDefineSet(t.useIridescence,"LIT_IRIDESCENCE")),this.fDefineSet(this.lighting&&t.useSpecular||this.reflections,"LIT_SPECULAR_OR_REFLECTION"),this.fDefineSet(this.needsSceneColor,"LIT_SCENE_COLOR"),this.fDefineSet(this.needsScreenSize,"LIT_SCREEN_SIZE"),this.fDefineSet(this.needsTransforms,"LIT_TRANSFORMS"),this.fDefineSet(this.needsNormal,"LIT_NEEDS_NORMAL"),this.fDefineSet(this.lighting,"LIT_LIGHTING"),this.fDefineSet(t.useMetalness,"LIT_METALNESS"),this.fDefineSet(t.enableGGXSpecular,"LIT_GGX_SPECULAR"),this.fDefineSet(t.useAnisotropy,"LIT_ANISOTROPY"),this.fDefineSet(t.useSpecularityFactor,"LIT_SPECULARITY_FACTOR"),this.fDefineSet(t.useCubeMapRotation,"CUBEMAP_ROTATION"),this.fDefineSet(t.occludeSpecularFloat,"LIT_OCCLUDE_SPECULAR_FLOAT"),this.fDefineSet(t.separateAmbient,"LIT_SEPARATE_AMBIENT"),this.fDefineSet(t.twoSidedLighting,"LIT_TWO_SIDED_LIGHTING"),this.fDefineSet(t.lightMapEnabled,"LIT_LIGHTMAP"),this.fDefineSet(t.dirLightMapEnabled,"LIT_DIR_LIGHTMAP"),this.fDefineSet(t.skyboxIntensity>0,"LIT_SKYBOX_INTENSITY"),this.fDefineSet(t.clusteredLightingShadowsEnabled,"LIT_CLUSTERED_SHADOWS"),this.fDefineSet(t.clusteredLightingAreaLightsEnabled,"LIT_CLUSTERED_AREA_LIGHTS"),this.fDefineSet(r,"LIT_TBN"),this.fDefineSet(s,"LIT_ADD_AMBIENT"),this.fDefineSet(t.hasTangents,"LIT_TANGENTS"),this.fDefineSet(t.useNormals,"LIT_USE_NORMALS"),this.fDefineSet(t.useClearCoatNormals,"LIT_USE_CLEARCOAT_NORMALS"),this.fDefineSet(t.useRefraction,"LIT_REFRACTION"),this.fDefineSet(t.useDynamicRefraction,"LIT_DYNAMIC_REFRACTION"),this.fDefineSet(t.dispersion,"LIT_DISPERSION"),this.fDefineSet(t.useHeights,"LIT_HEIGHTS"),this.fDefineSet(t.opacityFadesSpecular,"LIT_OPACITY_FADES_SPECULAR"),this.fDefineSet(t.alphaToCoverage,"LIT_ALPHA_TO_COVERAGE"),this.fDefineSet(t.alphaTest,"LIT_ALPHA_TEST"),this.fDefineSet(t.useMsdf,"LIT_MSDF"),this.fDefineSet(t.ssao,"LIT_SSAO"),this.fDefineSet(t.useAo,"LIT_AO"),this.fDefineSet(t.occludeDirect,"LIT_OCCLUDE_DIRECT"),this.fDefineSet(t.msdfTextAttribute,"LIT_MSDF_TEXT_ATTRIBUTE"),this.fDefineSet(t.diffuseMapEnabled,"LIT_DIFFUSE_MAP"),this.fDefineSet(t.shadowCatcher,"LIT_SHADOW_CATCHER"),this.fDefineSet(true,"LIT_FRESNEL_MODEL",a7[t.fresnelModel]),this.fDefineSet(true,"LIT_NONE_SLICE_MODE",nv[t.nineSlicedMode]),this.fDefineSet(true,"LIT_BLEND_TYPE",a8[t.blendType]),this.fDefineSet(true,"LIT_CUBEMAP_PROJECTION",nr[t.cubeMapProjection]),this.fDefineSet(true,"LIT_OCCLUDE_SPECULAR",no[t.occludeSpecular]),this.fDefineSet(true,"LIT_REFLECTION_SOURCE",nf[t.reflectionSource]),this.fDefineSet(true,"LIT_AMBIENT_SOURCE",ng[t.ambientSource]),this.fDefineSet(true,"{lightingUv}",e??""),this.fDefineSet(true,"{reflectionDecode}",cF.decodeFunc(t.reflectionEncoding)),this.fDefineSet(true,"{reflectionCubemapDecode}",cF.decodeFunc(t.reflectionCubemapEncoding)),this.fDefineSet(true,"{ambientDecode}",cF.decodeFunc(t.ambientEncoding)),this._setupLightingDefines(i,t.clusteredLightingEnabled);}prepareShadowPass(){let{options:e}=this,t=this.shaderPassInfo.lightType,i=this.shaderPassInfo.shadowType,s=ns.get(i),r=0===t||!s.vsm&&2===t;this.fDefineSet(r,"PERSPECTIVE_DEPTH"),this.fDefineSet(true,"LIGHT_TYPE",`${ne[t]}`),this.fDefineSet(true,"SHADOW_TYPE",`${s.name}`),this.fDefineSet(e.alphaTest,"LIT_ALPHA_TEST");}generateFragmentShader(e,t,i){let s=this.options;this.includes.set("frontendDeclPS",e??""),this.includes.set("frontendCodePS",t??""),3===s.pass||1===s.pass||(this.shadowPass?this.prepareShadowPass():this.prepareForwardPass(i)),this.fshader=`
						#include "litMainPS"
				`;}constructor(e,t,i=true){this.varyingsCode="",this.vDefines=new Map,this.fDefines=new Map,this.includes=new Map,this.chunks=null,this.device=e,this.options=t;let s=t.shaderChunks;if(this.shaderLanguage=e.isWebGPU&&i&&(!s||s.useWGSL)?tV:tz,e.isWebGPU&&this.shaderLanguage===tz&&!e.hasTranspilers,this.attributes={vertex_position:e6},t.userAttributes)for(let[e,i]of Object.entries(t.userAttributes))this.attributes[i]=e;let r=nH.get(e,this.shaderLanguage);this.chunks=new Map(r),s&&(this.shaderLanguage===tz?s.glsl:s.wgsl).forEach((e,t)=>{for(let t in dM)dM.hasOwnProperty(t)&&e.indexOf(t)>=0&&(this.attributes[t]=dM[t]);this.chunks.set(t,e);}),this.shaderPassInfo=nz.get(this.device).getByIndex(t.pass),this.shadowPass=this.shaderPassInfo.isShadow,this.lighting=t.lights.length>0||t.dirLightMapEnabled||t.clusteredLightingEnabled,this.reflections=t.reflectionSource!==nl,this.needsNormal=this.lighting||this.reflections||t.useSpecular||t.ambientSH||t.useHeights||t.enableGGXSpecular||t.clusteredLightingEnabled&&!this.shadowPass||t.useClearCoatNormals,this.needsNormal=this.needsNormal&&!this.shadowPass,this.needsSceneColor=t.useDynamicRefraction,this.needsScreenSize=t.useDynamicRefraction,this.needsTransforms=t.useDynamicRefraction,this.vshader=null,this.fshader=null;}}let dF={generateKey:e=>`lit${Object.keys(e).sort().map(t=>"shaderChunks"===t?e.shaderChunks?.key??"":"lights"===t?dF.generateLightsKey(e):t+e[t]).join("\n")}`,generateLightsKey:e=>`lights:${e.lights.map(t=>e.clusteredLightingEnabled&&0!==t._type?"":`${t.key},`).join("")}`},dN=[0,1,2,3,4,5,6,7],dB=new class extends nB{generateKey(e){let t=nB.definesHash(e.defines),i=iI(e.shaderChunkGLSL??""),s=iI(e.shaderChunkWGSL??""),r=dF.generateKey(e.litOptions),a=`${dN.map((t,i)=>e.usedUvs[i]?"1":"0").join("")}`;return `lit_${t}_${a}_${i}_${s}_${r}`}createShaderDefinition(e,t){let i=!!t.shaderChunkWGSL,s=new dO(e,t.litOptions,i),r={name:"LitShader",shaderLanguage:s.shaderLanguage,tag:s.shaderPassInfo.isForward?1:void 0},a=t.usedUvs||[true];s.generateVertexShader(a,a,[]),s.generateFragmentShader("",s.shaderLanguage===tV?t.shaderChunkWGSL:t.shaderChunkGLSL,"vUv0");let n=nW.merge(s.chunks,s.includes),o=s.vDefines;t.defines.forEach((e,t)=>o.set(t,e));let l=s.fDefines;return t.defines.forEach((e,t)=>l.set(t,e)),r.attributes=s.attributes,r.vertexCode=s.vshader,r.vertexIncludes=n,r.vertexDefines=o,r.fragmentCode=s.fshader,r.fragmentIncludes=n,r.fragmentDefines=l,rh.createDefinition(e,r)}},dk=new class{constructor(){this.litOptions=new dR;}};class dU{get pass(){return this.litOptions.pass}constructor(){this.defines=new Map,this.forceUv1=false,this.specularTint=false,this.metalnessTint=false,this.glossTint=false,this.emissiveEncoding="linear",this.lightMapEncoding="linear",this.vertexColorGamma=false,this.packedNormal=false,this.normalDetailPackedNormal=false,this.clearCoatPackedNormal=false,this.glossInvert=false,this.sheenGlossInvert=false,this.clearCoatGlossInvert=false,this.useAO=false,this.litOptions=new dR;}}let dz=[],dV=e=>Object.keys(e).filter(e=>"litOptions"!==e).sort(),dG=new class extends nB{generateKey(e){let t;e===this.optionsContextMin?(this.propsMin||(this.propsMin=dV(e)),t=this.propsMin):e===this.optionsContext?(this.props||(this.props=dV(e)),t=this.props):t=dV(e);let i=nB.definesHash(e.defines);return `standard:
${i}
${t.map(t=>t+e[t]).join("\n")}${dF.generateKey(e.litOptions)}`}_getUvSourceExpression(e,t,i){let s,r=i[e],a=i[t],n=0===i.litOptions.pass;return n&&1===i.litOptions.nineSlicedMode||n&&2===i.litOptions.nineSlicedMode?s="nineSlicedUv":(s=0===r?`vUv${a}`:`vUV${a}_${r}`,i.heightMap&&"heightMapTransform"!==e&&(s+=" + dUvOffset")),s}_validateMapChunk(e,t,i,s){}_addMapDefines(e,t,i,s,r,a,n=null){let o=`${t}Map`,l=t.toUpperCase(),h=`${o}Uv`,c=`${o}Identifier`,d=`${o}Transform`,u=`${o}Channel`,f=`${t}VertexColorChannel`,p=`${t}Tint`,m=`${t}VertexColor`,_=`${t}Mode`,g=`${t}Invert`,v=s[p],S=s[m],y=s[o],x=s[c],T=s[_],E=r.get(i);if(y){e.set(`STD_${l}_TEXTURE`,"");let t=this._getUvSourceExpression(d,h,s);e.set(`{STD_${l}_TEXTURE_UV}`,t),e.set(`{STD_${l}_TEXTURE_CHANNEL}`,s[u]);let i=`{STD_${l}_TEXTURE_NAME}`;if(E.includes(i)){let t=`texture_${o}`,s=a[x];s?t=s:(a[x]=t,e.set(`STD_${l}_TEXTURE_ALLOCATE`,"")),e.set(i,t);}if(n){let t="aaa"===s[u]?"passThrough":cF.decodeFunc(n);e.set(`{STD_${l}_TEXTURE_DECODE}`,t);}}S&&(e.set(`STD_${l}_VERTEX`,""),e.set(`{STD_${l}_VERTEX_CHANNEL}`,s[f])),T&&e.set(`{STD_${l}_DETAILMODE}`,T),v&&e.set(`STD_${l}_CONSTANT`,""),s[g]&&e.set(`STD_${l}_INVERT`,"");}_correctChannel(e,t,i){if(i[e]>0){if(i[e]<t.length)return t.substring(0,i[e]);if(i[e]>t.length){let s=t,r=s.charAt(s.length-1),a=i[e]-s.length;for(let e=0;e<a;e++)s+=r;return s}return t}}createVertexShader(e,t){let i=[],s=[],r=[];for(let e in dz){let a=`${e}Map`;if(t[`${e}VertexColor`]){let i=`${e}VertexColorChannel`;t[i]=this._correctChannel(e,t[i],dz);}if(t[a]){let n=`${a}Channel`,o=`${a}Transform`,l=`${a}Uv`;t[l]=Math.min(t[l],1),t[n]=this._correctChannel(e,t[n],dz);let h=t[l];i[h]=true,s[h]=s[h]||t[a]&&!t[o],t[o]&&r.push({name:e,id:t[o],uv:t[l]});}}t.forceUv1&&(i[1]=true,s[1]=void 0===s[1]||s[1]),e.generateVertexShader(i,s,r);}prepareFragmentDefines(e,t,i){let s=(e,i,s="")=>{e&&t.set(i,s);};s(e.lightMap,"STD_LIGHTMAP",""),s(e.lightVertexColor,"STD_LIGHT_VERTEX_COLOR",""),s(e.dirLightMap&&e.litOptions.useSpecular,"STD_LIGHTMAP_DIR",""),s(e.heightMap,"STD_HEIGHT_MAP",""),s(e.useSpecularColor,"STD_SPECULAR_COLOR",""),s(e.aoMap||e.aoVertexColor||e.useAO,"STD_AO",""),s(true,"STD_OPACITY_DITHER",nb[i.isForward?e.litOptions.opacityDither:e.litOptions.opacityShadowDither]);}createShaderDefinition(e,t){let i=nz.get(e).getByIndex(t.litOptions.pass),s=i.isForward,r=new dO(e,t.litOptions);this.createVertexShader(r,t);let a={};t.litOptions.fresnelModel=0===t.litOptions.fresnelModel?2:t.litOptions.fresnelModel;let n=r.fDefines;this.prepareFragmentDefines(t,n,i);let o="";if(s){if(t.heightMap&&this._addMapDefines(n,"height","parallaxPS",t,r.chunks,a),(3!==t.litOptions.blendType||t.litOptions.alphaTest||t.litOptions.alphaToCoverage||t.litOptions.opacityDither!==nx)&&this._addMapDefines(n,"opacity","opacityPS",t,r.chunks,a),r.needsNormal){if((t.normalMap||t.clearCoatNormalMap)&&!t.litOptions.hasTangents){let e=t.normalMap?"normalMap":"clearCoatNormalMap";o=this._getUvSourceExpression(`${e}Transform`,`${e}Uv`,t);}this._addMapDefines(n,"normalDetail","normalMapPS",t,r.chunks,a,t.normalDetailPackedNormal?"xy":"xyz"),this._addMapDefines(n,"normal","normalMapPS",t,r.chunks,a,t.packedNormal?"xy":"xyz");}t.diffuseDetail&&this._addMapDefines(n,"diffuseDetail","diffusePS",t,r.chunks,a,t.diffuseDetailEncoding),this._addMapDefines(n,"diffuse","diffusePS",t,r.chunks,a,t.diffuseEncoding),t.litOptions.useRefraction&&(this._addMapDefines(n,"refraction","transmissionPS",t,r.chunks,a),this._addMapDefines(n,"thickness","thicknessPS",t,r.chunks,a)),t.litOptions.useIridescence&&(this._addMapDefines(n,"iridescence","iridescencePS",t,r.chunks,a),this._addMapDefines(n,"iridescenceThickness","iridescenceThicknessPS",t,r.chunks,a)),(r.lighting&&t.litOptions.useSpecular||r.reflections)&&(t.litOptions.useSheen&&(this._addMapDefines(n,"sheen","sheenPS",t,r.chunks,a,t.sheenEncoding),this._addMapDefines(n,"sheenGloss","sheenGlossPS",t,r.chunks,a)),t.litOptions.useMetalness&&(this._addMapDefines(n,"metalness","metalnessPS",t,r.chunks,a),this._addMapDefines(n,"ior","iorPS",t,r.chunks,a)),t.litOptions.useSpecularityFactor&&this._addMapDefines(n,"specularityFactor","specularityFactorPS",t,r.chunks,a),t.useSpecularColor&&this._addMapDefines(n,"specular","specularPS",t,r.chunks,a,t.specularEncoding),this._addMapDefines(n,"gloss","glossPS",t,r.chunks,a)),t.aoDetail&&this._addMapDefines(n,"aoDetail","aoPS",t,r.chunks,a),(t.aoMap||t.aoVertexColor||t.useAO)&&this._addMapDefines(n,"ao","aoPS",t,r.chunks,a),this._addMapDefines(n,"emissive","emissivePS",t,r.chunks,a,t.emissiveEncoding),t.litOptions.useClearCoat&&(this._addMapDefines(n,"clearCoat","clearCoatPS",t,r.chunks,a),this._addMapDefines(n,"clearCoatGloss","clearCoatGlossPS",t,r.chunks,a),this._addMapDefines(n,"clearCoatNormal","clearCoatNormalPS",t,r.chunks,a,t.clearCoatPackedNormal?"xy":"xyz")),t.litOptions.enableGGXSpecular&&this._addMapDefines(n,"anisotropy","anisotropyPS",t,r.chunks,a),(t.lightMap||t.lightVertexColor)&&this._addMapDefines(n,"light","lightmapPS",t,r.chunks,a,t.lightMapEncoding);}else {let e=t.litOptions.opacityShadowDither;(t.litOptions.alphaTest||e)&&this._addMapDefines(n,"opacity","opacityPS",t,r.chunks,a);}r.generateFragmentShader(r.chunks.get("stdDeclarationPS"),r.chunks.get("stdFrontEndPS"),o);let l=nW.merge(r.chunks,r.includes),h=r.vDefines;t.defines.forEach((e,t)=>h.set(t,e)),t.defines.forEach((e,t)=>n.set(t,e));let c=rh.createDefinition(e,{name:"StandardShader",attributes:r.attributes,shaderLanguage:r.shaderLanguage,vertexCode:r.vshader,fragmentCode:r.fshader,vertexIncludes:l,fragmentIncludes:l,fragmentDefines:n,vertexDefines:h});return r.shaderPassInfo.isForward&&(c.tag=1),c}constructor(...e){super(...e),this.optionsContext=new dU,this.optionsContextMin=new dU;}},dH=(e,t)=>{if(e.length!==t.length)return  false;for(let i=0;i<e.length;++i)if(e[i]!==t[i])return  false;return  true};class dW{updateMinRef(e,t,i,s,r,a){this._updateSharedOptions(e,t,i,s,r),this._updateMinOptions(e,i,r),this._updateUVOptions(e,i,s,true);}updateRef(e,t,i,s,r,a,n){this._updateSharedOptions(e,t,s,r,a),this._updateEnvOptions(e,s,t,i),this._updateMaterialOptions(e,s,t),e.litOptions.hasTangents=r&&(512&r)!=0,this._updateLightOptions(e,t,s,r,n),this._updateUVOptions(e,s,r,false,i);}_updateSharedOptions(e,t,i,s,r){e.forceUv1=i.forceUv1,i.userAttributes&&(e.litOptions.userAttributes=Object.fromEntries(i.userAttributes.entries())),e.litOptions.shaderChunks=i.shaderChunks,e.litOptions.pass=r,e.litOptions.alphaTest=i.alphaTest>0,e.litOptions.blendType=i.blendType,e.litOptions.screenSpace=s&&(256&s)!=0,e.litOptions.skin=s&&(2&s)!=0,e.litOptions.batch=s&&(16384&s)!=0,e.litOptions.useInstancing=s&&(32&s)!=0,e.litOptions.useMorphPosition=s&&(1024&s)!=0,e.litOptions.useMorphNormal=s&&(2048&s)!=0,e.litOptions.useMorphTextureBasedInt=s&&(8192&s)!=0,e.litOptions.nineSlicedMode=i.nineSlicedMode||0,t.clusteredLightingEnabled&&i.useLighting?(e.litOptions.clusteredLightingEnabled=true,e.litOptions.clusteredLightingCookiesEnabled=t.lighting.cookiesEnabled,e.litOptions.clusteredLightingShadowsEnabled=t.lighting.shadowsEnabled,e.litOptions.clusteredLightingShadowType=t.lighting.shadowType,e.litOptions.clusteredLightingAreaLightsEnabled=t.lighting.areaLightsEnabled):(e.litOptions.clusteredLightingEnabled=false,e.litOptions.clusteredLightingCookiesEnabled=false,e.litOptions.clusteredLightingShadowsEnabled=false,e.litOptions.clusteredLightingAreaLightsEnabled=false);}_updateUVOptions(e,t,i,s,r){let a=false,n=false,o=false;i&&(a=(4&i)!=0,n=(8&i)!=0,o=(16&i)!=0),e.litOptions.vertexColors=false,this._mapXForms=[];let l={};for(let i in dz)this._updateTexOptions(e,t,i,a,n,o,s,l);this._mapXForms=null,e.litOptions.ssao=r?.ssaoEnabled,e.useAO=e.litOptions.ssao,e.litOptions.lightMapEnabled=e.lightMap,e.litOptions.dirLightMapEnabled=e.dirLightMap,e.litOptions.useHeights=e.heightMap,e.litOptions.useNormals=e.normalMap,e.litOptions.useClearCoatNormals=e.clearCoatNormalMap,e.litOptions.useAo=e.aoMap||e.aoVertexColor||e.litOptions.ssao,e.litOptions.diffuseMapEnabled=e.diffuseMap;}_updateTexOptions(e,t,i,s,r,a,n,o){let l="opacity"===i;if(!n||l){let n=`${i}Map`,h=`${i}VertexColor`,c=`${i}VertexColorChannel`,d=`${n}Channel`,u=`${n}Transform`,f=`${n}Uv`,p=`${n}Identifier`;if("light"!==i&&(e[n]=false,e[p]=void 0,e[d]="",e[u]=0,e[f]=0),e[h]=false,e[c]="",l&&3===t.blendType&&0===t.alphaTest&&!t.alphaToCoverage&&t.opacityDither===nx)return;if("height"!==i&&t[h]&&a&&(e[h]=t[h],e[c]=t[c],e.litOptions.vertexColors=true),t[n]){let a=true;if(0!==t[f]||s||(a=false),1!==t[f]||r||(a=false),a){let s=t[n].id,r=o[s];void 0===r&&(o[s]=i,r=i),e[n]=!!t[n],e[p]=r,e[u]=this._getMapTransformID(t.getUniform(u),t[f]),e[d]=t[d],e[f]=t[f];}}}}_updateMinOptions(e,t,i){let s=1===i;e.litOptions.opacityShadowDither=s?t.opacityDither:t.opacityShadowDither,e.litOptions.linearDepth=s,e.litOptions.lights=[];}_updateMaterialOptions(e,t,i){let s,r,a=!!(t.useMetalness||t.specularMap||t.sphereMap||t.cubeMap||0!==(s=t.specular).r||0!==s.g||0!==s.b||t.specularityFactor>0&&t.useMetalness||t.enableGGXSpecular||t.clearCoat>0),n=!t.useMetalness||t.useMetalnessSpecularColor,o=a&&(t.specularTint||!t.specularMap&&!t.specularVertexColor)&&(1!==(r=t.specular).r||1!==r.g||1!==r.b),l=a&&t.useMetalnessSpecularColor&&(t.specularityFactorTint||t.specularityFactor<1&&!t.specularityFactorMap),h=e=>!!e&&(10===e.format||e.type===tL),c=(e,t)=>1e-4>Math.abs(e-t);e.specularTint=o,e.specularityFactorTint=l,e.metalnessTint=t.useMetalness&&t.metalness<1,e.glossTint=true,e.diffuseEncoding=t.diffuseMap?.encoding,e.diffuseDetailEncoding=t.diffuseDetailMap?.encoding,e.emissiveEncoding=t.emissiveMap?.encoding,e.lightMapEncoding=t.lightMap?.encoding,e.packedNormal=h(t.normalMap),e.refractionTint=!c(t.refraction,1),e.refractionIndexTint=!c(t.refractionIndex,1/1.5),e.thicknessTint=t.useDynamicRefraction&&1!==t.thickness,e.specularEncoding=t.specularMap?.encoding,e.sheenEncoding=t.sheenMap?.encoding,e.aoMapUv=t.aoUvSet,e.aoDetail=!!t.aoDetailMap,e.diffuseDetail=!!t.diffuseDetailMap,e.normalDetail=!!t.normalMap,e.normalDetailPackedNormal=h(t.normalDetailMap),e.diffuseDetailMode=t.diffuseDetailMode,e.aoDetailMode=t.aoDetailMode,e.clearCoatGloss=!!t.clearCoatGloss,e.clearCoatPackedNormal=h(t.clearCoatNormalMap),e.iorTint=!c(t.refractionIndex,1/1.5),i.forcePassThroughSpecular&&(e.specularEncoding="linear",e.sheenEncoding="linear"),e.iridescenceTint=1!==t.iridescence,e.glossInvert=t.glossInvert,e.sheenGlossInvert=t.sheenGlossInvert,e.clearCoatGlossInvert=t.clearCoatGlossInvert,e.useSpecularColor=n,e.litOptions.separateAmbient=false,e.litOptions.pixelSnap=t.pixelSnap,e.litOptions.ambientSH=!!t.ambientSH,e.litOptions.twoSidedLighting=t.twoSidedLighting,e.litOptions.occludeSpecular=t.occludeSpecular,e.litOptions.occludeSpecularFloat=1!==t.occludeSpecularIntensity,e.litOptions.useMsdf=!!t.msdfMap,e.litOptions.msdfTextAttribute=!!t.msdfTextAttribute,e.litOptions.alphaToCoverage=t.alphaToCoverage,e.litOptions.opacityFadesSpecular=t.opacityFadesSpecular,e.litOptions.opacityDither=t.opacityDither,e.litOptions.cubeMapProjection=t.cubeMapProjection,e.litOptions.occludeDirect=t.occludeDirect,e.litOptions.useSpecular=a,e.litOptions.useSpecularityFactor=(l||!!t.specularityFactorMap)&&t.useMetalnessSpecularColor,e.litOptions.enableGGXSpecular=t.enableGGXSpecular,e.litOptions.useAnisotropy=t.enableGGXSpecular&&(t.anisotropyIntensity>0||!!t.anisotropyMap),e.litOptions.fresnelModel=t.fresnelModel,e.litOptions.useRefraction=(t.refraction||!!t.refractionMap)&&(t.useDynamicRefraction||e.litOptions.reflectionSource!==nl),e.litOptions.useClearCoat=!!t.clearCoat,e.litOptions.useSheen=t.useSheen,e.litOptions.useIridescence=t.useIridescence&&0!==t.iridescence,e.litOptions.useMetalness=t.useMetalness,e.litOptions.useDynamicRefraction=t.useDynamicRefraction,e.litOptions.dispersion=t.dispersion>0,e.litOptions.shadowCatcher=t.shadowCatcher,e.litOptions.useVertexColorGamma=t.vertexColorGamma;}_updateEnvOptions(e,t,i,s){e.litOptions.fog=t.useFog?s.fog:a6,e.litOptions.gamma=s.shaderOutputGamma,e.litOptions.toneMap=t.useTonemap?s.toneMapping:6;let r=false;if(t.envAtlas&&t.cubeMap?(e.litOptions.reflectionSource=nc,e.litOptions.reflectionEncoding=t.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=t.cubeMap.encoding):t.envAtlas?(e.litOptions.reflectionSource=nh,e.litOptions.reflectionEncoding=t.envAtlas.encoding):t.cubeMap?(e.litOptions.reflectionSource=nd,e.litOptions.reflectionEncoding=t.cubeMap.encoding):t.sphereMap?(e.litOptions.reflectionSource=nu,e.litOptions.reflectionEncoding=t.sphereMap.encoding):t.useSkybox&&i.envAtlas&&i.skybox?(e.litOptions.reflectionSource=nc,e.litOptions.reflectionEncoding=i.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=i.skybox.encoding,r=true):t.useSkybox&&i.envAtlas?(e.litOptions.reflectionSource=nh,e.litOptions.reflectionEncoding=i.envAtlas.encoding,r=true):t.useSkybox&&i.skybox?(e.litOptions.reflectionSource=nd,e.litOptions.reflectionEncoding=i.skybox.encoding,r=true):(e.litOptions.reflectionSource=nl,e.litOptions.reflectionEncoding=null),t.ambientSH)e.litOptions.ambientSource=np,e.litOptions.ambientEncoding=null;else {let s=t.envAtlas||(t.useSkybox&&i.envAtlas?i.envAtlas:null);s&&!t.sphereMap?(e.litOptions.ambientSource=nm,e.litOptions.ambientEncoding=s.encoding):(e.litOptions.ambientSource=n_,e.litOptions.ambientEncoding=null);}e.litOptions.skyboxIntensity=r,e.litOptions.useCubeMapRotation=r&&i._skyboxRotationShaderInclude;}_updateLightOptions(e,t,i,s,r){if(e.lightMap=false,e.lightMapChannel="",e.lightMapUv=0,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=false,e.dirLightMap=false,s&&(e.litOptions.noShadow=(1&s)!=0,(64&s)!=0&&(e.lightMapEncoding=7===t.lightmapPixelFormat?"rgbm":"linear",e.lightMap=true,e.lightMapChannel="rgb",e.lightMapUv=1,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=!i.lightMap,(128&s)!=0&&(e.dirLightMap=true),(4096&s)!=0&&(e.litOptions.lightMapWithoutAmbient=false))),i.useLighting){let i=[],a=s?s>>16:1;e.litOptions.lightMaskDynamic=!!(1&a),r&&(dL.collectLights(0,r[0],i,a),t.clusteredLightingEnabled||(dL.collectLights(1,r[1],i,a),dL.collectLights(2,r[2],i,a))),e.litOptions.lights=i;}else e.litOptions.lights=[];0!==e.litOptions.lights.length||t.clusteredLightingEnabled||(e.litOptions.noShadow=true);}_getMapTransformID(e,t){if(!e)return 0;let i=this._mapXForms[t];i||(i=[],this._mapXForms[t]=i);for(let t=0;t<i.length;t++)if(dH(i[t][0].value,e[0].value)&&dH(i[t][1].value,e[1].value))return t+1;return i.push(e)}constructor(){this._mapXForms=null;}}function dX(e,t=true,i=true){let s={};return s[`${e}Map`]="texture",s[`${e}MapTiling`]="vec2",s[`${e}MapOffset`]="vec2",s[`${e}MapRotation`]="number",s[`${e}MapUv`]="number",t&&(s[`${e}MapChannel`]="string",i&&(s[`${e}VertexColor`]="boolean",s[`${e}VertexColorChannel`]="string")),s}let dY={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",...dX("ao"),...dX("aoDetail",true,false),aoDetailMode:"string",aoIntensity:"number",diffuse:"rgb",...dX("diffuse"),...dX("diffuseDetail",true,false),diffuseDetailMode:"string",vertexColorGamma:"boolean",specular:"rgb",specularTint:"boolean",...dX("specular"),occludeSpecular:"enum:occludeSpecular",specularityFactor:"number",specularityFactorTint:"boolean",...dX("specularityFactor"),useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",metalnessTint:"boolean",...dX("metalness"),useMetalnessSpecularColor:"boolean",anisotropyIntensity:"number",anisotropyRotation:"number",...dX("anisotropy"),shininess:"number",gloss:"number",glossInvert:"boolean",...dX("gloss"),clearCoat:"number",...dX("clearCoat"),clearCoatGloss:"number",clearCoatGlossInvert:"boolean",...dX("clearCoatGloss"),clearCoatBumpiness:"number",...dX("clearCoatNormal",false),useSheen:"boolean",sheen:"rgb",...dX("sheen"),sheenGloss:"number",sheenGlossInvert:"boolean",...dX("sheenGloss"),fresnelModel:"number",emissive:"rgb",...dX("emissive"),emissiveIntensity:"number",...dX("normal",false),bumpiness:"number",...dX("normalDetail",false),normalDetailMapBumpiness:"number",...dX("height",true,false),heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number",...dX("opacity"),opacityFadesSpecular:"boolean",opacityDither:"string",opacityShadowDither:"string",reflectivity:"number",refraction:"number",refractionTint:"boolean",...dX("refraction"),refractionIndex:"number",dispersion:"number",thickness:"number",thicknessTint:"boolean",...dX("thickness"),attenuation:"rgb",attenuationDistance:"number",useDynamicRefraction:"boolean",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",useIridescence:"boolean",iridescence:"number",iridescenceTint:"boolean",...dX("iridescence"),iridescenceThicknessTint:"boolean",iridescenceThicknessMin:"number",iridescenceThicknessMax:"number",iridescenceRefractionIndex:"number",...dX("iridescenceThickness"),...dX("light"),depthTest:"boolean",depthFunc:"enum:depthFunc",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useTonemap:"boolean",envAtlas:"texture",twoSidedLighting:"boolean",shadowCatcher:"boolean"},dq=[];for(let e in dY)"texture"===dY[e]&&dq.push(e);let d$=[];for(let e in dY)"cubemap"===dY[e]&&d$.push(e);let dj={aoMapVertexColor:"boolean",diffuseMapTint:"boolean",diffuseMapVertexColor:"boolean",emissiveMapTint:"boolean",emissiveMapVertexColor:"boolean",glossMapVertexColor:"boolean",metalnessMapVertexColor:"boolean",opacityMapVertexColor:"boolean",specularAntialias:"boolean",specularMapTint:"boolean",specularMapVertexColor:"boolean",ambientTint:"boolean",emissiveTint:"boolean",diffuseTint:"boolean",sheenTint:"boolean",conserveEnergy:"boolean",useGamma:"boolean",useGammaTonemap:"boolean",sheenGlossTint:"boolean",anisotropy:"boolean"},dK={},dZ={},dQ=new Set,dJ=new es;class d0 extends lm{reset(){Object.keys(dK).forEach(e=>{this[`_${e}`]=dK[e].value();}),this._uniformCache={};}copy(e){return super.copy(e),Object.keys(dK).forEach(t=>{this[t]=e[t];}),this.userAttributes=new Map(e.userAttributes),this}setAttribute(e,t){this.userAttributes.set(t,e);}_setParameter(e,t){dQ.add(e),this.setParameter(e,t);}_setParameters(e){e.forEach(e=>{this._setParameter(e.name,e.value);});}_processParameters(e){let t=this[e];t.forEach(e=>{dQ.has(e)||delete this.parameters[e];}),this[e]=dQ,(dQ=t).clear();}_updateMap(e){let t=`${e}Map`,i=this[t];if(i){this._setParameter(`texture_${t}`,i);let e=`${t}Transform`,s=this.getUniform(e);s&&this._setParameters(s);}}_allocUniform(e,t){let i=this._uniformCache[e];return i||(i=t(),this._uniformCache[e]=i),i}getUniform(e,t,i){return dZ[e](this,t,i)}updateUniforms(e,t){let i=i=>this.getUniform(i,e,t);for(let e in this._setParameter("material_ambient",i("ambient")),this._setParameter("material_diffuse",i("diffuse")),this._setParameter("material_aoIntensity",this.aoIntensity),this.useMetalness?((!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness),(!this.specularMap||this.specularTint)&&this._setParameter("material_specular",i("specular")),(!this.specularityFactorMap||this.specularityFactorTint)&&this._setParameter("material_specularityFactor",this.specularityFactor),this._setParameter("material_sheen",i("sheen")),this._setParameter("material_sheenGloss",this.sheenGloss),this._setParameter("material_refractionIndex",this.refractionIndex)):(!this.specularMap||this.specularTint)&&this._setParameter("material_specular",i("specular")),this.enableGGXSpecular&&(this._setParameter("material_anisotropyIntensity",this.anisotropyIntensity),this._setParameter("material_anisotropyRotation",[Math.cos(this.anisotropyRotation*ei.DEG_TO_RAD),Math.sin(this.anisotropyRotation*ei.DEG_TO_RAD)])),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGloss",this.clearCoatGloss),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_gloss",this.gloss),this._setParameter("material_emissive",i("emissive")),this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&this._setParameter("material_refraction",this.refraction),this.dispersion>0&&this._setParameter("material_dispersion",this.dispersion),this.useDynamicRefraction&&(this._setParameter("material_thickness",this.thickness),this._setParameter("material_attenuation",i("attenuation")),this._setParameter("material_invAttenuationDistance",0===this.attenuationDistance?0:1/this.attenuationDistance)),this.useIridescence&&(this._setParameter("material_iridescence",this.iridescence),this._setParameter("material_iridescenceRefractionIndex",this.iridescenceRefractionIndex),this._setParameter("material_iridescenceThicknessMin",this.iridescenceThicknessMin),this._setParameter("material_iridescenceThicknessMax",this.iridescenceThicknessMax)),this._setParameter("material_opacity",this.opacity),false===this.opacityFadesSpecular&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),1===this.cubeMapProjection&&this._setParameter(i("cubeMapProjectionBox")),dz)this._updateMap(e);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",i("heightMapFactor")),this.envAtlas&&this.cubeMap?(this._setParameter("texture_envAtlas",this.envAtlas),this._setParameter("texture_cubeMap",this.cubeMap)):this.envAtlas?this._setParameter("texture_envAtlas",this.envAtlas):this.cubeMap?this._setParameter("texture_cubeMap",this.cubeMap):this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),super.updateUniforms(e,t);}updateEnvUniforms(e,t){!(this.envAtlas||this.cubeMap||this.sphereMap)&&this.useSkybox&&(t.envAtlas&&t.skybox?(this._setParameter("texture_envAtlas",t.envAtlas),this._setParameter("texture_cubeMap",t.skybox)):t.envAtlas?this._setParameter("texture_envAtlas",t.envAtlas):t.skybox&&this._setParameter("texture_cubeMap",t.skybox)),this._processParameters("_activeLightingParams");}getShaderVariant(e){let{device:t,scene:i,pass:s,objDefs:r,sortedLights:a,cameraShaderParams:n}=e;this.updateEnvUniforms(t,i);let o=nz.get(t).getByIndex(s),l=3===s||1===s||o.isShadow,h=l?dG.optionsContextMin:dG.optionsContext;h.defines=nY.getCoreDefines(this,e),l?this.shaderOptBuilder.updateMinRef(h,i,this,r,s,a):this.shaderOptBuilder.updateRef(h,i,n,this,r,s,a),this.useFog||h.defines.set("FOG","NONE"),h.defines.set("TONEMAP",nn[h.litOptions.toneMap]),this.onUpdateShader&&(h=this.onUpdateShader(h));let c=new nO(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),d=nN(t);d.register("standard",dG);let u=d.getProgram("standard",h,c,this.userId);return this._dirtyShader=false,u}destroy(){for(let e in this._assetReferences)this._assetReferences[e]._unbind();this._assetReferences=null,super.destroy();}constructor(){super(),this.userAttributes=new Map,this._assetReferences={},this._activeParams=new Set,this._activeLightingParams=new Set,this.shaderOptBuilder=new dW,this.reset();}}d0.TEXTURE_PARAMETERS=dq,d0.CUBEMAP_PARAMETERS=d$;let d1=(e,t)=>{dZ[e]=t;},d2=(e,t,i,s)=>{Object.defineProperty(d0.prototype,e,{get:s||function(){return this[`_${e}`]},set:i}),dK[e]={value:t};},d3=e=>{let t,i,s,r;return e.defaultValue&&e.defaultValue.clone?(t=`_${e.name}`,i=e.dirtyShaderFunc||(()=>true),void d2(e.name,()=>e.defaultValue.clone(),function(e){let s=this[t];s.equals(e)||(this._dirtyShader=this._dirtyShader||i(s,e),this[t]=s.copy(e));},e.getterFunc)):(s=`_${e.name}`,r=e.dirtyShaderFunc||(()=>true),void d2(e.name,()=>e.defaultValue,function(e){let t=this[s];t!==e&&(this._dirtyShader=this._dirtyShader||r(t,e),this[s]=e);},e.getterFunc))};function d4(e,t="rgb",i=true,s=0){dz[e]=t.length||-1,d3({name:`${e}Map`,defaultValue:null,dirtyShaderFunc:(e,t)=>!!e!=!!t||e&&(e.type!==t.type||e.format!==t.format)}),d3({name:`${e}MapTiling`,defaultValue:new ef(1,1)}),d3({name:`${e}MapOffset`,defaultValue:new ef(0,0)}),d3({name:`${e}MapRotation`,defaultValue:0}),d3({name:`${e}MapUv`,defaultValue:s}),t&&(d3({name:`${e}MapChannel`,defaultValue:t}),i&&(d3({name:`${e}VertexColor`,defaultValue:false}),d3({name:`${e}VertexColorChannel`,defaultValue:t})));let r=`${e}MapTiling`,a=`${e}MapOffset`,n=`${e}MapRotation`,o=`${e}MapTransform`;d1(o,(e,t,i)=>{let s=e[r],l=e[a],h=e[n];if(1===s.x&&1===s.y&&0===l.x&&0===l.y&&0===h)return null;let c=e._allocUniform(o,()=>[{name:`texture_${o}0`,value:new Float32Array(3)},{name:`texture_${o}1`,value:new Float32Array(3)}]),d=Math.cos(h*ei.DEG_TO_RAD),u=Math.sin(h*ei.DEG_TO_RAD),f=c[0].value;f[0]=d*s.x,f[1]=-u*s.y,f[2]=l.x;let p=c[1].value;return p[0]=u*s.x,p[1]=d*s.y,p[2]=1-s.y-l.y,c});}function d5(e,t){d3({name:e,defaultValue:t,getterFunc:function(){return this._dirtyShader=true,this[`_${e}`]}}),d1(e,(t,i,s)=>{let r=t._allocUniform(e,()=>new Float32Array(3)),a=t[e];return dJ.linear(a),r[0]=dJ.r,r[1]=dJ.g,r[2]=dJ.b,r});}function d8(e,t,i){d3({name:e,defaultValue:t,dirtyShaderFunc:(e,t)=>(0===e||1===e)!=(0===t||1===t)}),d1(e,i);}function d6(e,t){d3({name:e,defaultValue:null,dirtyShaderFunc:(e,t)=>!!e==!!t}),d1(e,t);}function d9(e,t){d3({name:e,defaultValue:t});}d5("ambient",new es(1,1,1)),d5("diffuse",new es(1,1,1)),d5("specular",new es(0,0,0)),d5("emissive",new es(0,0,0)),d5("sheen",new es(1,1,1)),d5("attenuation",new es(1,1,1)),d8("emissiveIntensity",1),d8("specularityFactor",1),d8("sheenGloss",0),d8("gloss",.25),d8("aoIntensity",1),d8("heightMapFactor",1,(e,t,i)=>.025*e.heightMapFactor),d8("opacity",1),d8("alphaFade",1),d8("alphaTest",0),d8("bumpiness",1),d8("normalDetailMapBumpiness",1),d8("reflectivity",1),d8("occludeSpecularIntensity",1),d8("refraction",0),d8("refractionIndex",1/1.5,(e,t,i)=>Math.max(.001,e.refractionIndex)),d8("dispersion",0),d8("thickness",0),d8("attenuationDistance",0),d8("metalness",1),d8("anisotropyIntensity",0),d8("anisotropyRotation",0),d8("clearCoat",0),d8("clearCoatGloss",1),d8("clearCoatBumpiness",1),d8("aoUvSet",0,null),d8("iridescence",0),d8("iridescenceRefractionIndex",1/1.5),d8("iridescenceThicknessMin",0),d8("iridescenceThicknessMax",0),d6("ambientSH"),d6("cubeMapProjectionBox",(e,t,i)=>{let s=e._allocUniform("cubeMapProjectionBox",()=>[{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}]),r=e.cubeMapProjectionBox.getMin(),a=s[0].value;a[0]=r.x,a[1]=r.y,a[2]=r.z;let n=e.cubeMapProjectionBox.getMax(),o=s[1].value;return o[0]=n.x,o[1]=n.y,o[2]=n.z,s}),d9("specularTint",false),d9("specularityFactorTint",false),d9("useMetalness",false),d9("useMetalnessSpecularColor",false),d9("useSheen",false),d9("enableGGXSpecular",false),d9("occludeDirect",false),d9("opacityFadesSpecular",true),d9("occludeSpecular",1),d9("fresnelModel",2),d9("useDynamicRefraction",false),d9("cubeMapProjection",0),d9("useFog",true),d9("useLighting",true),d9("useTonemap",true),d9("useSkybox",true),d9("forceUv1",false),d9("pixelSnap",false),d9("twoSidedLighting",false),d9("nineSlicedMode",void 0),d9("msdfTextAttribute",false),d9("useIridescence",false),d9("glossInvert",false),d9("sheenGlossInvert",false),d9("clearCoatGlossInvert",false),d9("opacityDither",nx),d9("opacityShadowDither",nx),d9("shadowCatcher",false),d9("vertexColorGamma",false),d4("diffuse"),d4("specular"),d4("emissive"),d4("thickness","g"),d4("specularityFactor","g"),d4("normal",""),d4("metalness","g"),d4("gloss","g"),d4("opacity","a"),d4("refraction","g"),d4("height","g",false),d4("ao","g"),d4("light","rgb",true,1),d4("msdf",""),d4("diffuseDetail","rgb",false),d4("normalDetail",""),d4("aoDetail","g",false),d4("clearCoat","g"),d4("clearCoatGloss","g"),d4("clearCoatNormal",""),d4("sheen","rgb"),d4("sheenGloss","g"),d4("iridescence","g"),d4("iridescenceThickness","g"),d4("anisotropy",""),d9("diffuseDetailMode","mul"),d9("aoDetailMode","mul"),d6("cubeMap"),d6("sphereMap"),d6("envAtlas"),x=[null,null,null,null,null,null],d2("prefilteredCubemaps",()=>x.slice(),function(e){let t=this._prefilteredCubemaps;e=e||[];let i=false,s=true;for(let r=0;r<6;++r){let a=e[r]||null;t[r]!==a&&(t[r]=a,i=true),s=s&&!!t[r];}i&&(s?this.envAtlas=dt.generatePrefilteredAtlas(t,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=true);},function(){return this._prefilteredCubemaps});class d7 extends ck{constructor(e,t,i,s,r,a){let n;super();let o=new ed,l=new ed,h=new ed,c=new ed,d=new ed,u=new ed,f=[],p=[],m=[],_=[],g=[];if(i>0)for(let a=0;a<=s;a++)for(let n=0;n<=r;n++){let v=n/r*2*Math.PI-Math.PI,S=Math.sin(v),y=Math.cos(v);d.set(S*e,-i/2,y*e),c.set(S*t,i/2,y*t),o.lerp(d,c,a/s),l.sub2(c,d).normalize(),u.set(y,0,-S),h.cross(u,l).normalize(),f.push(o.x,o.y,o.z),p.push(h.x,h.y,h.z);let x=n/r,T=a/s;m.push(x,1-T);let E=T;if(T=x,x=.75*(x=E)+.125,T=.75*T+.125,x/=3,_.push(x,1-T),a<s&&n<r){let e=a*(r+1)+n,t=a*(r+1)+(n+1),i=(a+1)*(r+1)+n,s=(a+1)*(r+1)+(n+1);g.push(e,t,i),g.push(t,s,i);}}if(a){let e=Math.floor(r/2),a=i/2;for(let i=0;i<=e;i++){let s=i*Math.PI*.5/e,n=Math.sin(s),o=Math.cos(s);for(let s=0;s<=r;s++){let l=2*s*Math.PI/r-Math.PI/2,h=Math.sin(l),c=Math.cos(l)*n,d=h*n,u=1-s/r,g=1-i/e;f.push(c*t,o*t+a,d*t),p.push(c,o,d),m.push(u,1-g),g=(.75*g+.125)/3,u=(.75*u+.125)/3+1/3,_.push(u,1-g);}}n=(s+1)*(r+1);for(let t=0;t<e;++t)for(let e=0;e<r;++e){let i=t*(r+1)+e,s=i+r+1;g.push(n+i+1,n+s,n+i),g.push(n+i+1,n+s+1,n+s);}for(let i=0;i<=e;i++){let s=.5*Math.PI+i*Math.PI*.5/e,n=Math.sin(s),o=Math.cos(s);for(let s=0;s<=r;s++){let l=2*s*Math.PI/r-Math.PI/2,h=Math.sin(l),c=Math.cos(l)*n,d=h*n,u=1-s/r,g=1-i/e;f.push(c*t,o*t-a,d*t),p.push(c,o,d),m.push(u,1-g),g=(.75*g+.125)/3,u=(.75*u+.125)/3+2/3,_.push(u,1-g);}}n=(s+1)*(r+1)+(r+1)*(e+1);for(let t=0;t<e;++t)for(let e=0;e<r;++e){let i=t*(r+1)+e,s=i+r+1;g.push(n+i+1,n+s,n+i),g.push(n+i+1,n+s+1,n+s);}}else {if(n=(s+1)*(r+1),e>0)for(let t=0;t<r;t++){let s=t/r*2*Math.PI,a=Math.sin(s),o=-i/2,l=Math.cos(s),h=1-(a+1)/2,c=(l+1)/2;f.push(a*e,o,l*e),p.push(0,-1,0),m.push(h,1-c),c=(.75*c+.125)/3,h=(.75*h+.125)/3+1/3,_.push(h,1-c),t>1&&g.push(n,n+t,n+t-1);}if(n+=r,t>0)for(let e=0;e<r;e++){let s=e/r*2*Math.PI,a=Math.sin(s),o=i/2,l=Math.cos(s),h=1-(a+1)/2,c=(l+1)/2;f.push(a*t,o,l*t),p.push(0,1,0),m.push(h,1-c),c=(.75*c+.125)/3,h=(.75*h+.125)/3+2/3,_.push(h,1-c),e>1&&g.push(n,n+e-1,n+e);}}this.positions=f,this.normals=p,this.uvs=m,this.uvs1=_,this.indices=g;}}class ue extends d7{constructor(e={}){let t=e.radius??.3;super(t,t,(e.height??1)-2*t,e.heightSegments??1,e.sides??20,true),e.calculateTangents&&(this.tangents=cB(this.positions,this.normals,this.uvs,this.indices));}}class ut extends d7{constructor(e={}){super(e.baseRadius??.5,e.peakRadius??0,e.height??1,e.heightSegments??5,e.capSegments??18,false),e.calculateTangents&&(this.tangents=cB(this.positions,this.normals,this.uvs,this.indices));}}class ui extends d7{constructor(e={}){let t=e.radius??.5;super(t,t,e.height??1,e.heightSegments??5,e.capSegments??20,false),e.calculateTangents&&(this.tangents=cB(this.positions,this.normals,this.uvs,this.indices));}}class us extends ck{constructor(e={}){super();let t=e.halfExtents??new ef(.5,.5),i=e.widthSegments??5,s=e.lengthSegments??5,r=[],a=[],n=[],o=[],l=0;for(let e=0;e<=i;e++)for(let h=0;h<=s;h++){let c=-t.x+2*t.x*e/i,d=-(-t.y+2*t.y*h/s),u=e/i,f=h/s;r.push(c,0,d),a.push(0,1,0),n.push(u,1-f),e<i&&h<s&&(o.push(l+s+1,l+1,l),o.push(l+s+1,l+s+2,l+1)),l++;}this.positions=r,this.normals=a,this.uvs=n,this.uvs1=n,this.indices=o,e.calculateTangents&&(this.tangents=cB(r,a,n,o));}}class ur extends ck{constructor(e={}){super();let t=e.tubeRadius??.2,i=e.ringRadius??.3,s=(e.sectorAngle??360)*ei.DEG_TO_RAD,r=e.segments??30,a=e.sides??20,n=[],o=[],l=[],h=[];for(let e=0;e<=a;e++)for(let c=0;c<=r;c++){let d=Math.cos(s*c/r)*(i+t*Math.cos(2*Math.PI*e/a)),u=Math.sin(2*Math.PI*e/a)*t,f=Math.sin(s*c/r)*(i+t*Math.cos(2*Math.PI*e/a)),p=Math.cos(s*c/r)*Math.cos(2*Math.PI*e/a),m=Math.sin(2*Math.PI*e/a),_=Math.sin(s*c/r)*Math.cos(2*Math.PI*e/a),g=e/a,v=1-c/r;if(n.push(d,u,f),o.push(p,m,_),l.push(g,1-v),e<a&&c<r){let t=e*(r+1)+c,i=(e+1)*(r+1)+c,s=e*(r+1)+(c+1),a=(e+1)*(r+1)+(c+1);h.push(t,i,s),h.push(i,a,s);}}this.positions=n,this.normals=o,this.uvs=l,this.uvs1=l,this.indices=h,e.calculateTangents&&(this.tangents=cB(n,o,l,h));}}class ua{destroy(){this.clearCache();}register(e,t){this._generators.has(e)||this._generators.set(e,t);}unregister(e){this._generators.has(e)&&this._generators.delete(e);}isRegistered(e){return this._generators.has(e)}generateShaderDefinition(e,t,i,s){let r=this.definitionsCache.get(i);if(!r){let a;s.litOptions?.lights&&(a=s.litOptions.lights,s.litOptions.lights=a.map(e=>{let t=e.clone?e.clone():e;return t.key=e.key,t})),this.storeNewProgram(t,s),s.litOptions?.lights&&(s.litOptions.lights=a),this._precached;let n=this._device;(r=e.createShaderDefinition(n,s)).name=r.name??(s.pass?`${t}-pass:${s.pass}`:t),this.definitionsCache.set(i,r);}return r}getCachedShader(e){return this.processedCache.get(e)}setCachedShader(e,t){this.processedCache.set(e,t);}getProgram(e,t,i,s){let r=this._generators.get(e);if(!r)return null;let a=iI(r.generateKey(t)),n=iI(i.generateKey(this._device)),o=`${a}#${n}`,l=this.getCachedShader(o);if(!l){let n,h=this.generateShaderDefinition(r,e,a,t),c="";void 0!==t.pass&&(n=nz.get(this._device).getByIndex(t.pass),c=`-${n.name}`),this._device.fire("shader:generate",{userMaterialId:s,shaderPassInfo:n,definition:h});let d={name:`${h.name}${c}-proc`,attributes:h.attributes,vshader:h.vshader,vincludes:h.vincludes,fincludes:h.fincludes,fshader:h.fshader,processingOptions:i,shaderLanguage:h.shaderLanguage,meshUniformBufferFormat:h.meshUniformBufferFormat,meshBindGroupFormat:h.meshBindGroupFormat};l=new rd(this._device,d),this.setCachedShader(o,l);}return l}storeNewProgram(e,t){let i={};if("standard"===e){let e=this._getDefaultStdMatOptions(t.pass);for(let s in t)(t.hasOwnProperty(s)&&e[s]!==t[s]||"pass"===s)&&(i[s]=t[s]);for(let e in t.litOptions)i[e]=t.litOptions[e];}else i=t;this._programsCollection.push(JSON.stringify({name:e,options:i}));}dumpPrograms(){let e="let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\n";e+="let shaders = [",this._programsCollection[0]&&(e+=`
	${this._programsCollection[0]}`);for(let t=1;t<this._programsCollection.length;++t)e+=`,
	${this._programsCollection[t]}`;e+=`
];
pc.getProgramLibrary(device).precompile(shaders);
if (pc.version != "${w}" || pc.revision != "${b}")
	console.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");`;let t=document.createElement("a");t.setAttribute("href",`data:text/plain;charset=utf-8,${encodeURIComponent(e)}`),t.setAttribute("download","precompile-shaders.js"),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t);}clearCache(){this._isClearingCache=true,this.processedCache.forEach(e=>{e.destroy();}),this.processedCache.clear(),this._isClearingCache=false;}removeFromCache(e){this._isClearingCache||this.processedCache.forEach((t,i)=>{e===t&&this.processedCache.delete(i);});}_getDefaultStdMatOptions(e){let t=nz.get(this._device).getByIndex(e);return 3===e||1===e||t.isShadow?this._defaultStdMatOptionMin:this._defaultStdMatOption}precompile(e){if(e){let t=Array(e.length);for(let i=0;i<e.length;i++){if("standard"===e[i].name){let t=e[i].options,s=this._getDefaultStdMatOptions(t.pass);for(let e in s)s.hasOwnProperty(e)&&void 0===t[e]&&(t[e]=s[e]);}t[i]=this.getProgram(e[i].name,e[i].options);}}this._precached=true;}constructor(e,t){this.processedCache=new Map,this.definitionsCache=new Map,this._generators=new Map,this._device=e,this._isClearingCache=false,this._precached=false,this._programsCollection=[],this._defaultStdMatOption=new dU,this._defaultStdMatOptionMin=new dU;let i=new oT;t.shaderOptBuilder.updateRef(this._defaultStdMatOption,{},i,t,null,[],0,null),t.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,{},t,null,2,null),e.on("destroy:shader",e=>{this.removeFromCache(e);});}}class un{destroy(){this._deviceLostEvent?.off(),this._deviceLostEvent=null,this.impl?.destroy(),this.impl=null;}upload(e,t,i=0,s=e.length){this.impl?.upload(e,t,i,s);}_onDeviceLost(){this.impl?._onDeviceLost?.();}constructor(e,t=false){this._deviceLostEvent=null,this.device=e,this.useSingleBuffer=t,this.impl=e.createUploadStreamImpl(this),this._deviceLostEvent=this.device.on("devicelost",this._onDeviceLost,this);}}var uo=`
#define GSPLAT_CENTER_NOPROJ
#include "gsplatHelpersVS"
#include "gsplatFormatVS"
#include "gsplatStructsVS"
#include "gsplatDeclarationsVS"
#include "gsplatCenterVS"
#include "gsplatEvalSHVS"
#include "gsplatQuatToMat3VS"
#include "gsplatReadVS"
#include "gsplatWorkBufferOutputVS"
#include "gsplatModifyVS"
uniform int uStartLine;
uniform int uViewportWidth;
#ifdef GSPLAT_LOD
	uniform usampler2D uIntervalsTexture;
#endif
uniform vec3 uColorMultiply;
uniform int uActiveSplats;
uniform vec3 model_scale;
uniform vec4 model_rotation;
#ifdef GSPLAT_ID
	uniform uint uId;
#endif
void main(void) {
	ivec2 localFragCoords = ivec2(int(gl_FragCoord.x), int(gl_FragCoord.y) - uStartLine);
	int targetIndex = localFragCoords.y * uViewportWidth + localFragCoords.x;
	if (targetIndex >= uActiveSplats) {
		#ifdef GSPLAT_COLOR_UINT
			writeDataColor(uvec4(0u));
		#else
			writeDataColor(vec4(0.0));
		#endif
		#ifndef GSPLAT_COLOR_ONLY
			writeDataTransformA(uvec4(0u));
			writeDataTransformB(uvec4(0u));
		#endif
	} else {
		#ifdef GSPLAT_LOD
			int intervalsSize = int(textureSize(uIntervalsTexture, 0).x);
			ivec2 intervalUV = ivec2(targetIndex % intervalsSize, targetIndex / intervalsSize);
			uint originalIndex = texelFetch(uIntervalsTexture, intervalUV, 0).r;
		#else
			uint originalIndex = uint(targetIndex);
		#endif
		
		setSplat(originalIndex);
		vec3 modelCenter = getCenter();
		vec3 worldCenter = (matrix_model * vec4(modelCenter, 1.0)).xyz;
		SplatCenter center;
		initCenter(modelCenter, center);
		vec4 srcRotation = getRotation().yzwx;
		vec3 srcScale = getScale();
		vec4 worldRotation = quatMul(model_rotation, srcRotation);
		if (worldRotation.w < 0.0) {
			worldRotation = -worldRotation;
		}
		vec3 worldScale = model_scale * srcScale;
		vec3 originalCenter = worldCenter;
		modifySplatCenter(worldCenter);
		modifySplatRotationScale(originalCenter, worldCenter, worldRotation, worldScale);
		vec4 color = getColor();
		#if SH_BANDS > 0
			vec3 dir = normalize(center.view * mat3(center.modelView));
			vec3 sh[SH_COEFFS];
			float scale;
			readSHData(sh, scale);
			color.xyz += evalSH(sh, dir) * scale;
		#endif
		modifySplatColor(worldCenter, color);
		color.xyz *= uColorMultiply;
		#ifdef GSPLAT_COLOR_UINT
			uint packed_rg = packHalf2x16(color.rg);
			uint packed_ba = packHalf2x16(color.ba);
			writeDataColor(uvec4(
				packed_rg & 0xFFFFu,
				packed_rg >> 16u,
				packed_ba & 0xFFFFu,
				packed_ba >> 16u
			));
		#else
			writeDataColor(color);
		#endif
		#ifndef GSPLAT_COLOR_ONLY
			writeDataTransformA(uvec4(floatBitsToUint(worldCenter.x), floatBitsToUint(worldCenter.y), floatBitsToUint(worldCenter.z), packHalf2x16(worldRotation.xy)));
			writeDataTransformB(uvec4(packHalf2x16(vec2(worldRotation.z, worldScale.x)), packHalf2x16(worldScale.yz), 0u, 0u));
		#endif
		#ifdef GSPLAT_ID
			writePcId(uvec4(uId, 0u, 0u, 0u));
		#endif
	}
}
`,ul=`
#define GSPLAT_CENTER_NOPROJ
#include "gsplatHelpersVS"
#include "gsplatFormatVS"
#include "gsplatStructsVS"
#include "gsplatDeclarationsVS"
#include "gsplatCenterVS"
#include "gsplatEvalSHVS"
#include "gsplatQuatToMat3VS"
#include "gsplatReadVS"
var<private> processOutput: FragmentOutput;
#include "gsplatWorkBufferOutputVS"
#include "gsplatModifyVS"
uniform uStartLine: i32;
uniform uViewportWidth: i32;
#ifdef GSPLAT_LOD
	var uIntervalsTexture: texture_2d<u32>;
#endif
uniform uColorMultiply: vec3f;
uniform uActiveSplats: i32;
uniform model_scale: vec3f;
uniform model_rotation: vec4f;
#ifdef GSPLAT_ID
	uniform uId: u32;
#endif
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	let localFragCoords = vec2i(i32(input.position.x), i32(input.position.y) - uniform.uStartLine);
	let targetIndex = localFragCoords.y * uniform.uViewportWidth + localFragCoords.x;
	
	if (targetIndex >= uniform.uActiveSplats) {
		writeDataColor(vec4f(0.0));
		#ifndef GSPLAT_COLOR_ONLY
			writeDataTransformA(vec4u(0u));
			writeDataTransformB(vec4u(0u));
		#endif
	} else {
		#ifdef GSPLAT_LOD
			let intervalsSize = i32(textureDimensions(uIntervalsTexture, 0).x);
			let intervalUV = vec2i(targetIndex % intervalsSize, targetIndex / intervalsSize);
			let originalIndex = textureLoad(uIntervalsTexture, intervalUV, 0).r;
		#else
			let originalIndex = targetIndex;
		#endif
		
		setSplat(u32(originalIndex));
		var modelCenter = getCenter();
		var worldCenter = (uniform.matrix_model * vec4f(modelCenter, 1.0)).xyz;
		var center: SplatCenter;
		initCenter(modelCenter, &center);
		let srcRotation = getRotation().yzwx;
		let srcScale = getScale();
		var worldRotation = quatMul(uniform.model_rotation, srcRotation);
		if (worldRotation.w < 0.0) {
			worldRotation = -worldRotation;
		}
		var worldScale = uniform.model_scale * srcScale;
		let originalCenter = worldCenter;
		modifySplatCenter(&worldCenter);
		modifySplatRotationScale(originalCenter, worldCenter, &worldRotation, &worldScale);
		var color = getColor();
		#if SH_BANDS > 0
			let dir = normalize(center.view * mat3x3f(center.modelView[0].xyz, center.modelView[1].xyz, center.modelView[2].xyz));
			var sh: array<vec3f, SH_COEFFS>;
			var scale: f32;
			readSHData(&sh, &scale);
			color = vec4f(color.xyz + evalSH(&sh, dir) * scale, color.w);
		#endif
		modifySplatColor(worldCenter, &color);
		color = vec4f(color.xyz * uniform.uColorMultiply, color.w);
		writeDataColor(color);
		#ifndef GSPLAT_COLOR_ONLY
			writeDataTransformA(vec4u(bitcast<u32>(worldCenter.x), bitcast<u32>(worldCenter.y), bitcast<u32>(worldCenter.z), pack2x16float(worldRotation.xy)));
			writeDataTransformB(vec4u(pack2x16float(vec2f(worldRotation.z, worldScale.x)), pack2x16float(worldScale.yz), 0u, 0u));
		#endif
		#ifdef GSPLAT_ID
			writePcId(vec4u(uniform.uId, 0u, 0u, 0u));
		#endif
	}
	
	return processOutput;
}
`;let uh=new ey,uc=new ed,ud=new ex,uu=[1,1,1];class uf extends as{init(e){super.init(e),this.colorOps.clear=false,this.depthStencilOps.clearDepth=false;}update(e,t,i){this.splats.length=0,this.colorsByLod=i;for(let t=0;t<e.length;t++){let i=e[t];i.activeSplats>0&&this.splats.push(i);}return this.cameraNode=t,this.splats.length>0}execute(){let{device:e,splats:t,cameraNode:i}=this;e.setBlendState(iS.NOBLEND),e.setCullMode(0),e.setDepthState(ix.NODEPTH),e.setStencilState();let s=i.getWorldTransform(),r=uh.copy(s).invert();e.scope.resolve("matrix_view").setValue(r.data);for(let e=0;e<t.length;e++)this.renderSplat(t[e]);}renderSplat(e){let{device:t,resource:i}=e,s=t.scope,{activeSplats:r,lineStart:a,viewport:n,intervalTexture:o}=e,l=e.getWorkBufferModifier?.()??null,h=i.format.hash,c=i.format.getInputDeclarations(),d=i.getWorkBufferRenderInfo(null!==o,this.colorOnly,l,h,c,this.workBuffer.format);d.material.setParameters(t),o&&s.resolve("uIntervalsTexture").setValue(o.texture),s.resolve("uActiveSplats").setValue(r),s.resolve("uStartLine").setValue(a),s.resolve("uViewportWidth").setValue(n.z);let u=this.colorsByLod?.[e.lodIndex]??this.colorsByLod?.[0]??uu;s.resolve("uColorMultiply").setValue(u);let f=e.node.getWorldTransform();if(f.getScale(uc),ud.setFromMat4(f),ud.w<0&&ud.mulScalar(-1),this._modelScaleData[0]=uc.x,this._modelScaleData[1]=uc.y,this._modelScaleData[2]=uc.z,this._modelRotationData[0]=ud.x,this._modelRotationData[1]=ud.y,this._modelRotationData[2]=ud.z,this._modelRotationData[3]=ud.w,s.resolve("matrix_model").setValue(f.data),s.resolve("model_scale").setValue(this._modelScaleData),s.resolve("model_rotation").setValue(this._modelRotationData),s.resolve("uId").setValue(e.placementId),e.parameters)for(let t of e.parameters.values())t.scopeId.setValue(t.data);let p=e.getInstanceStreams?.();if(p)for(let[t,i]of(p.syncWithFormat(e.resource.format),p.textures))s.resolve(t).setValue(i);d.quadRender.render(n);}destroy(){this.splats.length=0,super.destroy();}constructor(e,t,i=false){super(e),this.splats=[],this.colorsByLod=void 0,this.cameraNode=null,this._modelScaleData=new Float32Array(3),this._modelRotationData=new Float32Array(4),this.workBuffer=t,this.colorOnly=i;}}class up{get textureDimensions(){return this._textureDimensions}destroy(){for(let e of this.textures.values())e.destroy();this.textures.clear();}init(e,t){for(let i of(this.format=e,this._textureDimensions=this.evalTextureSize(t),this._isInstance?e.instanceStreams:e.resourceStreams)){let e=this.createTexture(i.name,i.format,this._textureDimensions);this.textures.set(i.name,e);}this._formatVersion=e.extraStreamsVersion;}getTexture(e){return this.syncWithFormat(this.format),this.textures.get(e)}getTexturesInOrder(){let e=[];if(this.format)for(let t of this._isInstance?this.format.instanceStreams:this.format.resourceStreams){let i=this.textures.get(t.name);i&&e.push(i);}return e}syncWithFormat(e){if(e&&(this.format!==e||this._formatVersion!==e.extraStreamsVersion)){for(let t of(this.format=e,this._isInstance?e.instanceStreams:e.resourceStreams))if(!this.textures.has(t.name)){let e=this.createTexture(t.name,t.format,this._textureDimensions);this.textures.set(t.name,e);}this._formatVersion=e.extraStreamsVersion;}}evalTextureSize(e){let t=Math.ceil(Math.sqrt(e));return new ef(t,Math.ceil(e/t))}resize(e,t){for(let i of(this._textureDimensions.set(e,t),this.textures.values()))i.resize(e,t);}createTexture(e,t,i,s){let r={name:e,width:i.x,height:i.y,format:t,cubemap:false,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1};return s&&(r.levels=[s]),new ih(this.device,r)}constructor(e,t=false){this.format=null,this.textures=new Map,this._textureDimensions=new ef,this._isInstance=false,this._formatVersion=-1,this.device=e,this._isInstance=t;}}let um=0;class u_{destroy(){this.material?.destroy(),this.quadRender?.destroy();}constructor(e,t,i,s,r){this.device=e,this.material=i;let a=new Map(i.defines),n=r.getStream("dataColor");47===n.format&&a.set("GSPLAT_COLOR_UINT",""),s&&a.set("GSPLAT_COLOR_ONLY",""),r.getStream("pcId")&&a.set("GSPLAT_ID","");let o=i.hasShaderChunks?e.isWebGPU?i.shaderChunks.wgsl:i.shaderChunks.glsl:void 0,l=s?[n]:[...r.streams,...r.extraStreams],h=[];for(let e of l){let t=e1(e.format);h.push(t.returnType);}let c=nY.createShader(e,{uniqueName:`SplatCopyToWorkBuffer:${t}`,attributes:{vertex_position:e6},vertexDefines:a,fragmentDefines:a,vertexChunk:"fullscreenQuadVS",fragmentGLSL:uo,fragmentWGSL:ul,fragmentIncludes:o,fragmentOutputTypes:h});this.quadRender=new nZ(c);}}class ug{_createRenderTargets(){this.renderTarget?.destroy(),this.colorRenderTarget?.destroy();let e=this.streams.getTexturesInOrder();this.renderTarget=new iU({name:`GsplatWorkBuffer-MRT-${this.id}`,colorBuffers:e,depth:false,flipY:true});let t=this.streams.getTexture("dataColor");this.colorRenderTarget=new iU({name:`GsplatWorkBuffer-Color-${this.id}`,colorBuffer:t,depth:false,flipY:true}),this.renderPass?.init(this.renderTarget),this.colorRenderPass?.init(this.colorRenderTarget);}syncWithFormat(){let e=this.streams._formatVersion;this.streams.syncWithFormat(this.format),e!==this.streams._formatVersion&&this._createRenderTargets();}getTexture(e){return this.streams.getTexture(e)}destroy(){this.renderPass?.destroy(),this.colorRenderPass?.destroy(),this.streams.destroy(),this.orderTexture?.destroy(),this.orderBuffer?.destroy(),this.renderTarget?.destroy(),this.colorRenderTarget?.destroy(),this.uploadStream.destroy();}get textureSize(){return this.streams.textureDimensions.x}setOrderData(e){this.textureSize,this.device.isWebGPU?this.uploadStream.upload(e,this.orderBuffer,0,e.length):this.uploadStream.upload(e,this.orderTexture,0,e.length);}resize(e){if(this.renderTarget.resize(e,e),this.colorRenderTarget.resize(e,e),this.streams.resize(e,e),this.device.isWebGPU){let t=e*e*4;this.orderBuffer.byteSize<t&&(this.orderBuffer.destroy(),this.orderBuffer=new rI(this.device,t,8));}else this.orderTexture.resize(e,e);}render(e,t,i){this.renderPass.update(e,t,i)&&this.renderPass.render();}renderColor(e,t,i){this.colorRenderPass.update(e,t,i)&&this.colorRenderPass.render();}constructor(e,t){this.id=um++,this.device=e,this.format=t,this.streams=new up(e),this.streams.init(t,1),this._createRenderTargets(),this.uploadStream=new un(e),e.isWebGPU?this.orderBuffer=new rI(e,4,8):this.orderTexture=new ih(e,{name:"SplatGlobalOrder",width:1,height:1,format:37,mipmaps:false,addressU:1,addressV:1}),this.renderPass=new uf(e,this),this.renderPass.init(this.renderTarget),this.colorRenderPass=new uf(e,this,true),this.colorRenderPass.init(this.colorRenderTarget);}}class uv{static queueDestroy(e,t){this._cache.get(e,()=>new uv)._pendingDestroy.add(t);}static process(e){let t=this._cache.get(e,()=>new uv)._pendingDestroy;for(let e of t)0===e.refCount&&(e._actualDestroy(),t.delete(e));}destroy(){this._pendingDestroy.clear();}constructor(){this._pendingDestroy=new Set;}}uv._cache=new ii;let uS=0,uy=new Map;class ux{destroy(){this.refCount>0?uv.queueDestroy(this.device,this):this._actualDestroy();}_actualDestroy(){this.streams.destroy(),this.mesh?.destroy(),this.instanceIndices?.destroy(),this.workBufferRenderInfos.forEach(e=>e.destroy()),this.workBufferRenderInfos.clear();}incRefCount(){this._refCount++;}decRefCount(){this._refCount--;}get refCount(){return this._refCount}ensureMesh(){this.mesh||(this.mesh=ux.createMesh(this.device),this.mesh.aabb.copy(this.aabb),this.instanceIndices=ux.createInstanceIndices(this.device,this.gsplatData.numSplats)),this._meshRefCount++;}releaseMesh(){this._meshRefCount--,this._meshRefCount<1&&(this.mesh=null,this.instanceIndices?.destroy(),this.instanceIndices=null);}getWorkBufferRenderInfo(e,t,i,s,r,a){this.configureMaterialDefines(uy),e&&uy.set("GSPLAT_LOD",""),t&&uy.set("GSPLAT_COLOR_ONLY","");let n="";for(let[e,t]of uy)n&&(n+=";"),n+=`${e}=${t}`;let o=`${s};${a.hash};${i?.hash??0};${n}`,l=this.workBufferRenderInfos.get(o);if(!l){let e=new cf;this.configureMaterial(e,i,r);let s=this.device.isWebGPU?e.shaderChunks.wgsl:e.shaderChunks.glsl,n=t?[a.getStream("dataColor")]:[...a.streams,...a.extraStreams],h=a.getOutputDeclarations(n);t&&a.extraStreams.length>0&&(h+=`
${a.getOutputStubs(a.extraStreams)}`),s.set("gsplatWorkBufferOutputVS",h),uy.forEach((t,i)=>e.setDefine(i,t)),l=new u_(this.device,o,e,t,a),this.workBufferRenderInfos.set(o,l);}return uy.clear(),l}static createMesh(e){let t=ux.instanceSize,i=new Float32Array(12*t),s=new Uint32Array(6*t);for(let e=0;e<t;++e){i.set([-1,-1,e,1,-1,e,1,1,e,-1,1,e],12*e);let t=4*e;s.set([0+t,1+t,2+t,0+t,2+t,3+t],6*e);}let r=new n7(e);return r.setPositions(i,3),r.setIndices(s),r.update(),r}static createInstanceIndices(e,t){let i=ux.instanceSize,s=Math.ceil(t/i)*i/i,r=new Uint32Array(s);for(let e=0;e<s;++e)r[e]=e*i;let a=new iO(e,[{semantic:tb,components:1,type:5,asInt:true}]);return new iP(e,a,s,{usage:0,data:r.buffer})}static get instanceSize(){return 128}get numSplats(){return this.gsplatData.numSplats}get format(){return this._format}getTexture(e){return this.streams.getTexture(e)}get textureDimensions(){return this.streams.textureDimensions}configureMaterial(e,t,i){this.configureMaterialDefines(e.defines),this.streams.syncWithFormat(this.format);let s=this.device.isWebGPU?e.shaderChunks.wgsl:e.shaderChunks.glsl;for(let[r,a]of(s.set("gsplatDeclarationsVS",i),s.set("gsplatReadVS",this.format.getReadCode()),t?.code&&s.set("gsplatModifyVS",t.code),this.streams.textures))e.setParameter(r,a);for(let[t,i]of this.parameters)e.setParameter(t,i);this.textureDimensions.x>0&&e.setParameter("splatTextureSize",this.textureDimensions.x);}configureMaterialDefines(e){}instantiate(){}constructor(e,t){this.centersVersion=0,this.mesh=null,this.instanceIndices=null,this.id=uS++,this.workBufferRenderInfos=new Map,this._format=null,this.parameters=new Map,this._refCount=0,this._meshRefCount=0,this.device=e,this.gsplatData=t,this.streams=new up(e),this.centers=t.getCenters(),this.aabb=new eC,t.calcAabb(this.aabb);}}let uT=new ey,uE=new ex,uw=new eC,ub=new eC,uA=new es(1,1,0,.4);class uC{constructor(e,t,i,s,r){let a=e.getProp("x"),n=e.getProp("y"),o=e.getProp("z"),l=e.getProp("rot_1"),h=e.getProp("rot_2"),c=e.getProp("rot_3"),d=e.getProp("rot_0"),u=e.getProp("scale_0"),f=e.getProp("scale_1"),p=e.getProp("scale_2"),m=e.getProp("f_dc_0"),_=e.getProp("f_dc_1"),g=e.getProp("f_dc_2"),v=e.getProp("opacity");this.read=e=>{t&&(t.x=a[e],t.y=n[e],t.z=o[e]),i&&i.set(l[e],h[e],c[e],d[e]),s&&s.set(Math.exp(u[e]),Math.exp(f[e]),Math.exp(p[e])),r&&r.set(.5+.28209479177387814*m[e],.5+.28209479177387814*_[e],.5+.28209479177387814*g[e],(e=>{if(e>0)return 1/(1+Math.exp(-e));let t=Math.exp(e);return t/(1+t)})(v[e]));};}}let uP=(e,t,i)=>{uE.set(i.x,i.y,i.z,i.w).normalize(),e.setTRS(t,uE,ed.ONE);};class uI{static calcSplatAabb(e,t,i,s){uP(uT,t,i),uw.center.set(0,0,0),uw.halfExtents.set(2*s.x,2*s.y,2*s.z),e.setFromTransformedAabb(uw,uT);}getProp(e,t="vertex"){return this.getElement(t)?.properties.find(t=>t.name===e)?.storage}getElement(e){return this.elements.find(t=>t.name===e)}addProp(e,t){this.getElement("vertex").properties.push({type:"float",name:e,storage:t,byteSize:4});}createIter(e,t,i,s){return new uC(this,e,t,i,s)}calcAabb(e,t){let i,s,r,a,n,o,l=true,h=this.getProp("x"),c=this.getProp("y"),d=this.getProp("z"),u=this.getProp("scale_0"),f=this.getProp("scale_1"),p=this.getProp("scale_2");for(let e=0;e<this.numSplats;++e){if(t&&!t(e))continue;let m=h[e],_=c[e],g=d[e],v=Math.max(u[e],f[e],p[e]);if(!isFinite(m)||!isFinite(_)||!isFinite(g)||!isFinite(v))continue;let S=2*Math.exp(v);l?(l=false,i=m-S,s=_-S,r=g-S,a=m+S,n=_+S,o=g+S):(i=Math.min(i,m-S),s=Math.min(s,_-S),r=Math.min(r,g-S),a=Math.max(a,m+S),n=Math.max(n,_+S),o=Math.max(o,g+S));}return l||(e.center.set((i+a)*.5,(s+n)*.5,(r+o)*.5),e.halfExtents.set((a-i)*.5,(n-s)*.5,(o-r)*.5)),!l}calcAabbExact(e,t){let i=new ed,s=new ex,r=new ed,a=this.createIter(i,s,r),n=true;for(let o=0;o<this.numSplats;++o)(!t||t(o))&&(a.read(o),n?(n=false,uI.calcSplatAabb(e,i,s,r)):(uI.calcSplatAabb(ub,i,s,r),e.add(ub)));return !n}getCenters(){let e=this.getProp("x"),t=this.getProp("y"),i=this.getProp("z"),s=new Float32Array(3*this.numSplats);for(let r=0;r<this.numSplats;++r)s[3*r+0]=e[r],s[3*r+1]=t[r],s[3*r+2]=i[r];return s}calcFocalPoint(e,t){let i=this.getProp("x"),s=this.getProp("y"),r=this.getProp("z"),a=this.getProp("scale_0"),n=this.getProp("scale_1"),o=this.getProp("scale_2");e.x=0,e.y=0,e.z=0;let l=0;for(let h=0;h<this.numSplats;++h){if(t&&!t(h))continue;let c=i[h],d=s[h],u=r[h];if(!isFinite(c)||!isFinite(d)||!isFinite(u))continue;let f=1/(1+Math.exp(Math.max(a[h],n[h],o[h])));e.x+=c*f,e.y+=d*f,e.z+=u*f,l+=f;}e.mulScalar(1/l);}renderWireframeBounds(e,t){let i=new ed,s=new ex,r=new ed,a=new ed,n=new ed,o=this.createIter(i,s,r);for(let l=0;l<this.numSplats;++l)o.read(l),uP(uT,i,s),uT.mul2(t,uT),a.set(-2*r.x,-2*r.y,-2*r.z),n.set(2*r.x,2*r.y,2*r.z),e.immediate.drawWireAlignedBox(a,n,uA,true,e.defaultDrawLayer,uT);}get isCompressed(){return  false}get shBands(){return ({9:1,24:2,45:3})[(()=>{for(let e=0;e<45;++e)if(!this.getProp(`f_rest_${e}`))return e;return 45})()]??0}calcMortonOrder(){let e=e=>{let t=e[0],i=e[0];for(let s=1;s<e.length;s++)e[s]<t&&(t=e[s]),e[s]>i&&(i=e[s]);return {min:t,max:i}},t=(e,t,i)=>{let s=e=>(e&=1023,e=((e=((e=((e=(e^e<<16)&0xff0000ff)^e<<8)&0x300f00f)^e<<4)&0x30c30c3)^e<<2)&0x9249249);return (s(i)<<2)+(s(t)<<1)+s(e)},i=this.getProp("x"),s=this.getProp("y"),r=this.getProp("z"),{min:a,max:n}=e(i),{min:o,max:l}=e(s),{min:h,max:c}=e(r),d=a===n?0:1024/(n-a),u=o===l?0:1024/(l-o),f=h===c?0:1024/(c-h),p=new Map;for(let e=0;e<this.numSplats;e++){let n=t(Math.min(1023,Math.floor((i[e]-a)*d)),Math.min(1023,Math.floor((s[e]-o)*u)),Math.min(1023,Math.floor((r[e]-h)*f))),l=p.get(n);l?l.push(e):p.set(n,[e]);}let m=Array.from(p.keys()).sort((e,t)=>e-t),_=new Uint32Array(this.numSplats),g=0;for(let e=0;e<m.length;++e){let t=p.get(m[e]);for(let e=0;e<t.length;++e)_[g++]=t[e];}return _}reorder(e){let t=new Map;this.elements.forEach(i=>{i.properties.forEach(i=>{i.storage&&(i.storage=(i=>{var s;let r=new i.constructor((e=>{if(t.has(e)){let i=t.get(e);return t.delete(e),i}return new ArrayBuffer(e)})(i.byteLength));for(let t=0;t<e.length;t++)r[t]=i[e[t]];return s=i.buffer,t.set(s.byteLength,s),r})(i.storage));});});}reorderData(){this.reorder(this.calcMortonOrder());}constructor(e,t=[]){this.elements=e,this.numSplats=this.getElement("vertex").count,this.comments=t;}}let uD=`
	attribute vec2 vertex_position;
	void main(void) {
		gl_Position = vec4(vertex_position, 0.0, 1.0);
	}
`,uR=`
	#include "gsplatEvalSHVS"
	vec4 packRgb(vec3 v) {
		uvec3 vb = uvec3(clamp(v, vec3(0.0), vec3(1.0)) * vec3(2047.0, 2047.0, 1023.0));
		uint bits = (vb.x << 21) | (vb.y << 10) | vb.z;
		return vec4((uvec4(bits) >> uvec4(24, 16, 8, 0)) & uvec4(0xff)) / vec4(255.0);
	}
	uniform mediump vec3 dir;
	uniform mediump sampler2D centroids;
	uniform mediump float shN_mins;
	uniform mediump float shN_maxs;
	void main(void) {
		ivec2 uv = ivec2(gl_FragCoord.xy) * ivec2(SH_COEFFS, 1);
		mediump vec3 coefficients[SH_COEFFS];
		for (int i = 0; i < SH_COEFFS; i++) {
			vec3 s = texelFetch(centroids, ivec2(uv.x + i, uv.y), 0).xyz;
			coefficients[i] = mix(vec3(shN_mins), vec3(shN_maxs), s);
		}
		gl_FragColor = packRgb(evalSH(coefficients, dir) * 0.25 + 0.5);
	}
`,uL=`
	attribute vertex_position: vec2f;
	@vertex
	fn vertexMain(input: VertexInput) -> VertexOutput {
		var output: VertexOutput;
		output.position = vec4f(vertex_position, 0.0, 1.0);
		return output;
	}
`,uM=`
	#include "gsplatEvalSHVS"
	fn packRgb(v: vec3f) -> vec4f {
		let vb = vec3u(clamp(v, vec3f(0.0), vec3f(1.0)) * vec3f(2047.0, 2047.0, 1023.0));
		let bits = dot(vb, vec3u(1 << 21, 1 << 10, 1));
		return vec4f((vec4u(bits) >> vec4u(24, 16, 8, 0)) & vec4u(0xff)) / vec4f(255.0);
	}
	uniform dir: vec3f;
	uniform shN_mins: f32;
	uniform shN_maxs: f32;
	var centroids: texture_2d<f32>;
	@fragment
	fn fragmentMain(input: FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		var uv = vec2i(input.position.xy) * vec2i(SH_COEFFS, 1);
		var coefficients: array<vec3f, SH_COEFFS>;
		for (var i: i32 = 0; i < SH_COEFFS; i++) {
			let s: vec3f = textureLoad(centroids, vec2i(uv.x + i, uv.y), 0).xyz;
			coefficients[i] = mix(vec3f(uniform.shN_mins), vec3f(uniform.shN_maxs), s);
		}
		output.color = packRgb(evalSH(&coefficients, uniform.dir) * 0.25 + 0.5);
		return output;
	}
`,uO=`
	uniform mediump sampler2D sh0;
	uniform highp sampler2D sh_labels;
	uniform mediump sampler2D sh_result;
	uniform vec4 sh0_mins;
	uniform vec4 sh0_maxs;
	float SH_C0 = 0.28209479177387814;
	vec3 unpackRgb(vec4 v) {
		uvec4 uv = uvec4(v * 255.0);
		uint bits = (uv.x << 24) | (uv.y << 16) | (uv.z << 8) | uv.w;
		uvec3 vb = (uvec3(bits) >> uvec3(21, 10, 0)) & uvec3(0x7ffu, 0x7ffu, 0x3ffu);
		return vec3(vb) / vec3(2047.0, 2047.0, 1023.0);
	}
	vec4 getColor(in SplatSource source) {
		vec4 baseSample = mix(sh0_mins, sh0_maxs, texelFetch(sh0, source.uv, 0));
		vec4 base = vec4(vec3(0.5) + baseSample.xyz * SH_C0, 1.0 / (1.0 + exp(-baseSample.w)));
		ivec2 labelSample = ivec2(texelFetch(sh_labels, source.uv, 0).xy * 255.0);
		int n = labelSample.x + labelSample.y * 256;
		vec4 shSample = texelFetch(sh_result, ivec2(n % 64, n / 64), 0);
		vec3 sh = (unpackRgb(shSample) - vec3(0.5)) * 4.0;
		return vec4(base.xyz + sh, base.w);
	}
`,uF=`
	var sh0: texture_2d<f32>;
	var sh_labels: texture_2d<f32>;
	var sh_result: texture_2d<f32>;
	uniform sh0_mins: vec4f;
	uniform sh0_maxs: vec4f;
	const SH_C0: f32 = 0.28209479177387814;
	fn unpackRgb(v: vec4f) -> vec3f {
		let bits = dot(vec4u(v * 255.0), vec4u(1u << 24, 1u << 16, 1u << 8, 1u));
		let vb = (vec3u(bits) >> vec3u(21, 10, 0)) & vec3u(0x7ffu, 0x7ffu, 0x3ffu);
		return vec3f(vb) / vec3f(2047.0, 2047.0, 1023.0);
	}
	fn getColor(source: ptr<function, SplatSource>) -> vec4f {
		let baseSample: vec4f = mix(uniform.sh0_mins, uniform.sh0_maxs, textureLoad(sh0, source.uv, 0));
		let base = vec4f(vec3f(0.5) + baseSample.xyz * SH_C0, 1.0 / (1.0 + exp(-baseSample.w)));
		let labelSample: vec2i = vec2i(textureLoad(sh_labels, source.uv, 0).xy * 255.0);
		let n = labelSample.x + labelSample.y * 256;
		let shSample: vec4f = textureLoad(sh_result, vec2i(n % 64, n / 64), 0);
		let sh: vec3f = (unpackRgb(shSample) - vec3f(0.5)) * 4.0;
		return vec4f(base.xyz + sh, base.w);
	}
`;class uN extends as{execute(){this.executeCallback?.();}constructor(...e){super(...e),this.executeCallback=null;}}let uB=new ey,uk=new ed;class uU{destroy(){let{gsplatInstance:e}=this,{material:t}=e;t.setDefine("SH_BANDS",e.resource.gsplatData.shBands.toString());let{shaderChunks:i}=t;i.glsl.delete("gsplatSogColorVS"),i.wgsl.delete("gsplatSogColorVS"),t.update(),this.quadRender.destroy(),this.renderPass.destroy(),this.renderTarget.destroy(),this.texture.destroy(),this.shader.destroy();}render(e,t){let{prevDir:i,updateMode:s}=this;if("disable"===s||(uB.invert(t),uB.transformVector(e.forward,uk),uk.normalize(),"enable"===s&&uk.equalsApprox(i,.001)))return;i.copy(uk);let r=()=>{let{device:e}=this,{sh_centroids:t,meta:i}=this.gsplatInstance.resource.gsplatData;var s=e.scope,r={dir:uk.toArray(),centroids:t,shN_mins:i.shN.mins,shN_maxs:i.shN.maxs};for(let e in r)s.resolve(e).setValue(r[e]);e.setCullMode(0),e.setDepthState(ix.NODEPTH),e.setStencilState(null,null),e.setBlendState(iS.NOBLEND),this.quadRender.render();};this.renderPass.executeCallback=r,this.renderPass.render();}constructor(e,t){this.prevDir=new ed,this.updateMode="enable",this.device=e,this.gsplatInstance=t;let{resource:i}=t,s=new Map(nH.get(e,e.isWebGPU?"wgsl":"glsl"));this.shader=nY.createShader(e,{uniqueName:"gsplatResolveSH",vertexGLSL:uD,fragmentGLSL:uR,vertexWGSL:uL,fragmentWGSL:uM,vertexIncludes:s,fragmentIncludes:s,fragmentDefines:new Map([["SH_BANDS",i.gsplatData.shBands.toString()]]),attributes:{vertex_position:e6}}),this.texture=i.streams.createTexture("centroids",7,new ef(64,1024)),this.renderTarget=new iU({colorBuffer:this.texture,depth:false}),this.renderPass=new uN(e),this.renderPass.init(this.renderTarget,{}),this.renderPass.colorOps.clear=true,this.quadRender=new nZ(this.shader);let{material:r}=t;r.setDefine("SH_BANDS","0");let{shaderChunks:a}=r;a.glsl.set("gsplatSogColorVS",uO),a.wgsl.set("gsplatSogColorVS",uF),r.update(),e.scope.resolve("sh_result").setValue(this.texture);}}function uz(){let e,t,i,s,r,a,n,o,l="undefined"!=typeof self&&self||require("node:worker_threads").parentPort,h=false,c={x:0,y:0,z:0},d={x:0,y:0,z:0},u={x:0,y:0,z:0},f={x:0,y:0,z:0},p=Array(32).fill(0),m=Array(32).fill(0),_=Array(32).fill(0);l.addEventListener("message",g=>{let v=g.data??g;if(v.order&&(e=new Uint32Array(v.order)),v.centers)if(t=new Float32Array(v.centers),h=true,v.chunks){let e=new Float32Array(v.chunks);i=new Float32Array(v.chunks,0,4*e.length/6),u.x=e[0],u.y=e[1],u.z=e[2],f.x=e[3],f.y=e[4],f.z=e[5];for(let t=0;t<e.length/6;++t){let s=e[6*t+0],r=e[6*t+1],a=e[6*t+2],n=e[6*t+3],o=e[6*t+4],l=e[6*t+5];i[4*t+0]=(s+n)*.5,i[4*t+1]=(r+o)*.5,i[4*t+2]=(a+l)*.5,i[4*t+3]=.5*Math.sqrt((n-s)**2+(o-r)**2+(l-a)**2),s<u.x&&(u.x=s),r<u.y&&(u.y=r),a<u.z&&(u.z=a),n>f.x&&(f.x=n),o>f.y&&(f.y=o),l>f.z&&(f.z=l);}}else {let e,s,r,a,n,o,l=t.length/3,h=Math.ceil(l/256);i=new Float32Array(4*h),u.x=u.y=u.z=1/0,f.x=f.y=f.z=-1/0;for(let c=0;c<h;++c){e=s=r=1/0,a=n=o=-1/0;let h=256*c,d=Math.min(l,(c+1)*256);for(let i=h;i<d;++i){let l=t[3*i+0],h=t[3*i+1],c=t[3*i+2],d=Number.isFinite(l),p=Number.isFinite(h),m=Number.isFinite(c);d||(t[3*i+0]=0),p||(t[3*i+1]=0),m||(t[3*i+2]=0),d&&p&&m&&(l<e?e=l:l>a&&(a=l),h<s?s=h:h>n&&(n=h),c<r?r=c:c>o&&(o=c),l<u.x?u.x=l:l>f.x&&(f.x=l),h<u.y?u.y=h:h>f.y&&(f.y=h),c<u.z?u.z=c:c>f.z&&(f.z=c));}i[4*c+0]=(e+a)*.5,i[4*c+1]=(s+n)*.5,i[4*c+2]=(r+o)*.5,i[4*c+3]=.5*Math.sqrt((a-e)**2+(n-s)**2+(o-r)**2);}}v.hasOwnProperty("mapping")&&(s=v.mapping?new Uint32Array(v.mapping):null,h=true),v.cameraPosition&&(r=v.cameraPosition),v.cameraDirection&&(a=v.cameraDirection),(()=>{let g,v,S;if(!e||!t||0===t.length||!r||!a)return;let y=performance.now(),x=r.x,T=r.y,E=r.z,w=a.x,b=a.y,A=a.z;if(!h&&.001>Math.abs(x-c.x)&&.001>Math.abs(T-c.y)&&.001>Math.abs(E-c.z)&&.001>Math.abs(w-d.x)&&.001>Math.abs(b-d.y)&&.001>Math.abs(A-d.z))return;h=false,c.x=x,c.y=T,c.z=E,d.x=w,d.y=b,d.z=A;for(let e=0;e<8;++e){let t=(1&e?u.x:f.x)*w+(2&e?u.y:f.y)*b+(4&e?u.z:f.z)*A;0===e?g=v=t:(g=Math.min(g,t),v=Math.max(v,t));}let C=t.length/3,P=Math.max(10,Math.min(20,Math.round(Math.log2(C/4)))),I=2**P+1;n?.length!==C&&(n=new Uint32Array(C)),o&&o.length===I?o.fill(0):o=new Uint32Array(I);let D=v-g;if(D<1e-6)for(let e=0;e<C;++e)n[e]=0,o[0]++;else {let e=i.length/4;p.fill(0);for(let t=0;t<e;++t){let e=i[4*t+0],s=i[4*t+1],r=i[4*t+2],a=i[4*t+3],n=e*w+s*b+r*A-g,o=Math.max(0,Math.floor((n-a)*32/D)),l=Math.min(32,Math.ceil((n+a)*32/D));for(let e=o;e<l;++e)p[e]++;}let s=p.reduce((e,t)=>e+t,0);for(let e=0;e<32;++e)_[e]=p[e]/s*I>>>0;for(let e=0;e<32;++e)m[e]=0===e?0:m[e-1]+_[e-1];let r=D/32,a=0;for(let e=0;e<C;++e){let i=(t[a++]*w+t[a++]*b+t[a++]*A-g)/r,s=i>>>0,l=m[s]+_[s]*(i-s)>>>0;n[e]=l,o[l]++;}}for(let e=1;e<I;e++)o[e]+=o[e-1];for(let t=0;t<C;t++){let i=n[t];e[--o[i]]=t;}let R=x*w+T*b+E*A,L=i=>{let s=3*e[i];return t[s++]*w+t[s++]*b+t[s]*A-R},M=L(C-1)>=0?(S=((e,t,i)=>{for(;e<=t;){let s=t+e>>1,r=i(s);if(r>0)e=s+1;else {if(!(r<0))return s;t=s-1;}}return ~e})(0,C-1,e=>-L(e)),Math.min(C,Math.abs(S))):C;if(s)for(let t=0;t<C;++t)e[t]=s[e[t]];l.postMessage({order:e.buffer,count:M,sortTime:performance.now()-y},[e.buffer]),e=null;})();});}class uV extends X{destroy(){this.worker.terminate(),this.worker=null;}init(e,t,i){this.orderTexture=e,this.centers=t.slice();let s=this.orderTexture.lock({mode:1}).slice();this.orderTexture.unlock();for(let e=0;e<s.length;++e)s[e]=e;let r={order:s.buffer,centers:t.buffer,chunks:i?.buffer},a=[s.buffer,t.buffer].concat(i?[i.buffer]:[]);this.worker.postMessage(r,a);}setMapping(e){if(e){let t=new Float32Array(3*e.length);for(let i=0;i<e.length;++i){let s=3*e[i],r=3*i;t[r+0]=this.centers[s+0],t[r+1]=this.centers[s+1],t[r+2]=this.centers[s+2];}this.worker.postMessage({centers:t.buffer,mapping:e.buffer},[t.buffer,e.buffer]);}else {let e=this.centers.slice();this.worker.postMessage({centers:e.buffer,mapping:null},[e.buffer]);}}setCamera(e,t){this.worker.postMessage({cameraPosition:{x:e.x,y:e.y,z:e.z},cameraDirection:{x:t.x,y:t.y,z:t.z}});}constructor(e){super(),this.scene=e??null;let t=e=>{let t=e.data??e;this.scene&&void 0!==t.sortTime&&this.scene.fire("gsplat:sorted",t.sortTime);let i=t.order,s=this.orderTexture._levels[0].buffer;this.worker.postMessage({order:s},[s]),this.orderTexture._levels[0]=new Uint32Array(i),this.orderTexture.upload(),this.fire("updated",t.count);},i=`(${uz.toString()})()`;"node"===k.environment?(this.worker=new Worker(i,{eval:true}),this.worker.on("message",t)):(this.worker=new Worker(URL.createObjectURL(new Blob([i],{type:"application/javascript"}))),this.worker.addEventListener("message",t));}}var uG=`
#include "gsplatPackingPS"
uniform highp sampler2D means_l;
uniform highp sampler2D means_u;
uniform highp sampler2D quats;
uniform highp sampler2D scales;
uniform highp sampler2D sh0;
uniform highp sampler2D sh_labels;
uniform highp uint numSplats;
#ifdef REORDER_V1
	float sigmoid(float x) { return 1.0 / (1.0 + exp(-x)); }
	vec3 vmin(vec3 v) { return vec3(min(min(v.x, v.y), v.z)); }
	vec3 vmax(vec3 v) { return vec3(max(max(v.x, v.y), v.z)); }
	vec3 resolve(vec3 m, vec3 M, vec3 v) { return (mix(m, M, v) - vmin(m)) / (vmax(M) - vmin(m)); }
	
	uniform vec3 scalesMins;
	uniform vec3 scalesMaxs;
	uniform vec4 sh0Mins;
	uniform vec4 sh0Maxs;
#else
	uniform vec4 scales_codebook[64];
	uniform vec4 sh0_codebook[64];
#endif
void main(void) {
	int w = int(textureSize(means_l, 0).x);
	ivec2 uv = ivec2(gl_FragCoord.xy);
	if (uint(uv.x + uv.y * w) >= numSplats) {
		discard;
	}
	vec3 meansLSample   = texelFetch(means_l, uv, 0).xyz;
	vec3 meansUSample   = texelFetch(means_u, uv, 0).xyz;
	vec4 quatsSample	= texelFetch(quats, uv, 0);
	vec3 scalesSample   = texelFetch(scales, uv, 0).xyz;
	vec4 sh0Sample	  = texelFetch(sh0, uv, 0);
	vec2 shLabelsSample = texelFetch(sh_labels, uv, 0).xy;
	#ifdef REORDER_V1
		uint scale = pack101010(resolve(scalesMins, scalesMaxs, scalesSample));
		uint sh0 = pack111110(resolve(sh0Mins.xyz, sh0Maxs.xyz, sh0Sample.xyz));
		float alpha = sigmoid(mix(sh0Mins.w, sh0Maxs.w, sh0Sample.w));
	#else
		uint scale = pack101010(resolveCodebook(scalesSample, scales_codebook));
		uint sh0 = pack111110(resolveCodebook(sh0Sample.xyz, sh0_codebook));
		float alpha = sh0Sample.w;
	#endif
	uint qmode = uint(quatsSample.w * 255.0) - 252u;
	pcFragColor0 = uvec4(
		pack8888(vec4(meansLSample, shLabelsSample.x)),
		pack8888(vec4(meansUSample, shLabelsSample.y)),
		pack8888(vec4(quatsSample.xyz, alpha)),
		(scale << 2u) | qmode
	);
	pcFragColor1 = unpack8888(sh0);
}
`,uH=`
#include "gsplatPackingPS"
var means_l: texture_2d<f32>;
var means_u: texture_2d<f32>;
var quats: texture_2d<f32>;
var scales: texture_2d<f32>;
var sh0: texture_2d<f32>;
var sh_labels: texture_2d<f32>;
uniform numSplats: u32;
#ifdef REORDER_V1
	fn sigmoid(x: f32) -> f32 { return 1.0 / (1.0 + exp(-x)); }
	fn vmin(v: vec3f) -> vec3f { return vec3f(min(min(v.x, v.y), v.z)); }
	fn vmax(v: vec3f) -> vec3f { return vec3f(max(max(v.x, v.y), v.z)); }
	fn resolve(m: vec3f, M: vec3f, v: vec3f) -> vec3f { return (mix(m, M, v) - vmin(m)) / (vmax(M) - vmin(m)); }
	uniform scalesMins: vec3f;
	uniform scalesMaxs: vec3f;
	uniform sh0Mins: vec4f;
	uniform sh0Maxs: vec4f;
#else
	uniform scales_codebook: array<vec4f, 64>;
	uniform sh0_codebook: array<vec4f, 64>;
#endif
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let w: u32 = textureDimensions(means_l, 0).x;
	let uv: vec2<u32> = vec2<u32>(input.position.xy);
	if (uv.x + uv.y * w >= uniform.numSplats) {
		discard;
		return output;
	}
	let meansLSample: vec3<f32> = textureLoad(means_l, uv, 0).xyz;
	let meansUSample: vec3<f32> = textureLoad(means_u, uv, 0).xyz;
	let quatsSample: vec4<f32> = textureLoad(quats, uv, 0);
	let scalesSample: vec3<f32> = textureLoad(scales, uv, 0).xyz;
	let sh0Sample: vec4f = textureLoad(sh0, uv, 0);
	let shLabelsSample: vec2<f32> = textureLoad(sh_labels, uv, 0).xy;
	#ifdef REORDER_V1
		let scale = pack101010(resolve(uniform.scalesMins, uniform.scalesMaxs, scalesSample));
		let sh0 = pack111110(resolve(uniform.sh0Mins.xyz, uniform.sh0Maxs.xyz, sh0Sample.xyz));
		let alpha = sigmoid(mix(uniform.sh0Mins.w, uniform.sh0Maxs.w, sh0Sample.w));
	#else
		let scale = pack101010(resolveCodebook(scalesSample, &uniform.scales_codebook));
		let sh0 = pack111110(resolveCodebook(sh0Sample.xyz, &uniform.sh0_codebook));
		let alpha = sh0Sample.w;
	#endif
	let qmode = u32(quatsSample.w * 255.0) - 252u;
	output.color = vec4u(
		pack8888(vec4f(meansLSample, shLabelsSample.x)),
		pack8888(vec4f(meansUSample, shLabelsSample.y)),
		pack8888(vec4f(quatsSample.xyz, alpha)),
		(scale << 2u) | qmode
	);
	output.color1 = unpack8888(sh0);
	return output;
}
`,uW=`
#include "gsplatPackingPS"
uniform highp sampler2D sh_centroids;
uniform vec4 shN_codebook[64];
void main(void) {
	ivec2 uv = ivec2(gl_FragCoord.xy);
	vec3 shNSample = texelFetch(sh_centroids, uv, 0).xyz;
#ifdef REORDER_V1
	pcFragColor0 = unpack8888(pack111110(shNSample));
#else
	pcFragColor0 = unpack8888(pack111110(resolveCodebook(shNSample, shN_codebook)));
#endif
}
`,uX=`
uint pack8888(vec4 v) {
	uvec4 t = uvec4(v * 255.0) << uvec4(24u, 16u, 8u, 0u);
	return t.x | t.y | t.z | t.w;
}
uint pack101010(vec3 v) {
	uvec3 t = uvec3(v * 1023.0) << uvec3(20u, 10u, 0u);
	return t.x | t.y | t.z;
}
uint pack111110(vec3 v) {
	uvec3 t = uvec3(v * vec3(2047.0, 2047.0, 1023.0)) << uvec3(21u, 10u, 0u);
	return t.x | t.y | t.z;
}
vec4 unpack8888(uint v) {
	return vec4((uvec4(v) >> uvec4(24u, 16u, 8u, 0u)) & 0xffu) / 255.0;
}
vec3 unpack101010(uint v) {
	return vec3((uvec3(v) >> uvec3(20u, 10u, 0u)) & 0x3ffu) / 1023.0;
}
vec3 unpack111110(uint v) {
	return vec3((uvec3(v) >> uvec3(21u, 10u, 0u)) & uvec3(0x7ffu, 0x7ffu, 0x3ffu)) / vec3(2047.0, 2047.0, 1023.0);
}
vec3 resolveCodebook(vec3 s, vec4 codebook[64]) {
	uvec3 idx = uvec3(s * 255.0);
	vec3 v = vec3(
		codebook[idx.x >> 2u][idx.x & 3u],
		codebook[idx.y >> 2u][idx.y & 3u],
		codebook[idx.z >> 2u][idx.z & 3u]
	);
	return (v - codebook[0].x) / (codebook[63].w - codebook[0].x);
}
`,uY=`
#include "gsplatPackingPS"
var sh_centroids: texture_2d<f32>;
uniform shN_codebook: array<vec4f, 64>;
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	var uv = vec2i(input.position.xy);
	var shNSample = textureLoad(sh_centroids, uv, 0).xyz;
#ifdef REORDER_V1
	output.color = unpack8888(pack111110(shNSample));
#else
	output.color = unpack8888(pack111110(resolveCodebook(shNSample, &uniform.shN_codebook)));
#endif
	return output;
}
`,uq=`
fn pack8888(v: vec4f) -> u32 {
	let t = vec4u(v * 255.0) << vec4u(24u, 16u, 8u, 0u);
	return t.x | t.y | t.z | t.w;
}
fn pack101010(v: vec3f) -> u32 {
	let t = vec3u(v * vec3f(1023.0, 1023.0, 1023.0)) << vec3u(20u, 10u, 0u);
	return t.x | t.y | t.z;
}
fn pack111110(v: vec3f) -> u32 {
	let t = vec3u(v * vec3f(2047.0, 2047.0, 1023.0)) << vec3u(21u, 10u, 0u);
	return t.x | t.y | t.z;
}
fn unpack8888(v: u32) -> vec4f {
	return vec4f((vec4u(v) >> vec4u(24u, 16u, 8u, 0u)) & vec4u(0xffu)) / 255.0;
}
fn unpack101010(v: u32) -> vec3f {
	return vec3f((vec3u(v) >> vec3u(20u, 10u, 0u)) & vec3u(0x3ffu)) / 1023.0;
}
fn unpack111110(v: u32) -> vec3f {
	return vec3f((vec3u(v) >> vec3u(21u, 10u, 0u)) & vec3u(0x7ffu, 0x7ffu, 0x3ffu)) / vec3f(2047.0, 2047.0, 1023.0);
}
fn resolveCodebook(s: vec3f, codebook: ptr<uniform, array<vec4f, 64>>) -> vec3f {
	let idx = vec3u(s * 255.0);
	let v = vec3f(
		codebook[idx.x >> 2u][idx.x & 3u],
		codebook[idx.y >> 2u][idx.y & 3u],
		codebook[idx.z >> 2u][idx.z & 3u]
	);
	return (v - codebook[0].x) / (codebook[63].w - codebook[0].x);
}
`,u$=`
#include "gsplatPackingPS"
uniform highp sampler2D means_l;
uniform highp sampler2D means_u;
uniform highp uint numSplats;
uniform highp vec3 means_mins;
uniform highp vec3 means_maxs;
void main(void) {
	int w = int(textureSize(means_l, 0).x);
	ivec2 uv = ivec2(gl_FragCoord.xy);
	if (uint(uv.x + uv.y * w) >= numSplats) {
		discard;
	}
	vec3 l = texelFetch(means_l, uv, 0).xyz;
	vec3 u = texelFetch(means_u, uv, 0).xyz;
	vec3 n = (l + u * 256.0) / 257.0;
	vec3 v = mix(means_mins, means_maxs, n);
	vec3 center = sign(v) * (exp(abs(v)) - 1.0);
	pcFragColor0 = uvec4(floatBitsToUint(center), 0u);
}
`,uj=`
var means_l: texture_2d<f32>;
var means_u: texture_2d<f32>;
uniform numSplats: u32;
uniform means_mins: vec3f;
uniform means_maxs: vec3f;
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let w: u32 = textureDimensions(means_l, 0).x;
	let uv: vec2<i32> = vec2<i32>(input.position.xy);
	if (u32(uv.x + uv.y * i32(w)) >= uniform.numSplats) {
		discard;
		return output;
	}
	let l: vec3f = textureLoad(means_l, uv, 0).xyz;
	let u: vec3f = textureLoad(means_u, uv, 0).xyz;
	let n: vec3f = (l + u * 256.0) / 257.0;
	let v: vec3f = mix(uniform.means_mins, uniform.means_maxs, n);
	let center: vec3f = sign(v) * (exp(abs(v)) - 1.0);
	let packed: vec4<u32> = bitcast<vec4<u32>>(vec4f(center, 0.0));
	output.color = packed;
	return output;
}
`;let uK=e=>e.device.isNull?new Promise(t=>{t(new Uint8Array(e.width*e.height*4));}):e.read(0,0,e.width,e.height,{mipLevel:0,face:0,immediate:true}),uZ=(e,t)=>{for(let i in t)e.resolve(i).setValue(t[i]);};class uQ{constructor(e,t,i,s,r,a){let n=(e,t,i)=>e*(1-i)+t*i,{meta:o,shBands:l}=e,{means:h,scales:c,sh0:d,shN:u}=o,f=t&&e.means_l._levels[0],p=t&&e.means_u._levels[0],m=i&&e.quats._levels[0],_=s&&e.scales._levels[0],g=r&&e.sh0._levels[0],v=a&&e.sh_labels._levels[0],S=a&&e.sh_centroids._levels[0],y=Math.SQRT2,x={1:3,2:8,3:15}[l]??0;this.read=l=>{if(t){let e=n(h.mins[0],h.maxs[0],((p[4*l+0]<<8)+f[4*l+0])/65535),i=n(h.mins[1],h.maxs[1],((p[4*l+1]<<8)+f[4*l+1])/65535),s=n(h.mins[2],h.maxs[2],((p[4*l+2]<<8)+f[4*l+2])/65535);t.x=Math.sign(e)*(Math.exp(Math.abs(e))-1),t.y=Math.sign(i)*(Math.exp(Math.abs(i))-1),t.z=Math.sign(s)*(Math.exp(Math.abs(s))-1);}if(i){let e=(m[4*l+0]/255-.5)*y,t=(m[4*l+1]/255-.5)*y,s=(m[4*l+2]/255-.5)*y,r=Math.sqrt(Math.max(0,1-(e*e+t*t+s*s)));switch(m[4*l+3]-252){case 0:i.set(e,t,s,r);break;case 1:i.set(r,t,s,e);break;case 2:i.set(t,r,s,e);break;case 3:i.set(t,s,r,e);}}if(s)if(2===o.version){let e=c.codebook[_[4*l+0]],t=c.codebook[_[4*l+1]],i=c.codebook[_[4*l+2]];s.set(e,t,i);}else {let e=n(c.mins[0],c.maxs[0],_[4*l+0]/255),t=n(c.mins[1],c.maxs[1],_[4*l+1]/255),i=n(c.mins[2],c.maxs[2],_[4*l+2]/255);s.set(e,t,i);}if(r)if(2===o.version){let e=d.codebook[g[4*l+0]],t=d.codebook[g[4*l+1]],i=d.codebook[g[4*l+2]],s=g[4*l+3]/255;r.set(.5+.28209479177387814*e,.5+.28209479177387814*t,.5+.28209479177387814*i,s);}else {let e=n(d.mins[0],d.maxs[0],g[4*l+0]/255),t=n(d.mins[1],d.maxs[1],g[4*l+1]/255),i=n(d.mins[2],d.maxs[2],g[4*l+2]/255),s=n(d.mins[3],d.maxs[3],g[4*l+3]/255);r.set(.5+.28209479177387814*e,.5+.28209479177387814*t,.5+.28209479177387814*i,1/(1+Math.exp(-s)));}if(a){let t=v[4*l+0]+(v[4*l+1]<<8),i=t%64*x,s=Math.floor(t/64);if(2===o.version)for(let t=0;t<3;++t)for(let r=0;r<x;++r)a[15*t+r]=u.codebook[S[(i+r)*4+t+s*e.sh_centroids.width*4]];else for(let t=0;t<3;++t)for(let r=0;r<x;++r)a[15*t+r]=n(u.mins,u.maxs,S[(i+r)*4+t+s*e.sh_centroids.width*4]/255);}};}}class uJ{_destroyGpuResources(){this.means_l?.destroy(),this.means_u?.destroy(),this.quats?.destroy(),this.scales?.destroy(),this.sh0?.destroy(),this.sh_centroids?.destroy(),this.sh_labels?.destroy(),this.packedTexture?.destroy(),this.packedSh0?.destroy(),this.packedShN?.destroy();}static calcBands(e){return ({192:1,512:2,960:3})[e]??0}destroy(){this.deviceRestoredEvent?.off(),this.deviceRestoredEvent=null,this.destroyed=true,this._destroyGpuResources();}createIter(e,t,i,s,r){return new uQ(this,e,t,i,s,r)}calcAabb(e){let{mins:t,maxs:i}=this.meta.means,s=e=>Math.sign(e)*(Math.exp(Math.abs(e))-1);e.center.set((s(t[0])+s(i[0]))*.5,(s(t[1])+s(i[1]))*.5,(s(t[2])+s(i[2]))*.5),e.halfExtents.set((s(i[0])-s(t[0]))*.5,(s(i[1])-s(t[1]))*.5,(s(i[2])-s(t[2]))*.5);}getCenters(){let e=this._centers;return this._centers=null,e}calcFocalPoint(e,t){let{mins:i,maxs:s}=this.meta.means,r=e=>Math.sign(e)*(Math.exp(Math.abs(e))-1);e.set((r(i[0])+r(s[0]))*.5,(r(i[1])+r(s[1]))*.5,(r(i[2])+r(s[2]))*.5);}get isSog(){return  true}async decompress(){let e=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3"],{shBands:t}=this,{means_l:i,means_u:s,quats:r,scales:a,sh0:n,sh_labels:o,sh_centroids:l}=this;if(i._levels[0]=await uK(i),s._levels[0]=await uK(s),r._levels[0]=await uK(r),a._levels[0]=await uK(a),n._levels[0]=await uK(n),t>0){o._levels[0]=await uK(o),l._levels[0]=await uK(l);let t=[];for(let e=0;e<45;++e)t.push(`f_rest_${e}`);e.splice(e.indexOf("f_dc_0")+1,0,...t);}let h={};e.forEach(e=>{h[e]=new Float32Array(this.numSplats);});let c=new ed,d=new ex,u=new ed,f=new ep,p=t>0?new Float32Array(45):null,m=this.createIter(c,d,u,f,p);for(let e=0;e<this.numSplats;++e)if(m.read(e),h.x[e]=c.x,h.y[e]=c.y,h.z[e]=c.z,h.rot_1[e]=d.x,h.rot_2[e]=d.y,h.rot_3[e]=d.z,h.rot_0[e]=d.w,h.scale_0[e]=u.x,h.scale_1[e]=u.y,h.scale_2[e]=u.z,h.f_dc_0[e]=(f.x-.5)/.28209479177387814,h.f_dc_1[e]=(f.y-.5)/.28209479177387814,h.f_dc_2[e]=(f.z-.5)/.28209479177387814,h.opacity[e]=f.w<=0?-40:f.w>=1?40:-Math.log(1/f.w-1),p)for(let t=0;t<45;++t)h[`f_rest_${t}`][e]=p[t];return new uI([{name:"vertex",count:this.numSplats,properties:e.map(e=>({name:e,type:"float",byteSize:4,storage:h[e]}))}])}async generateCenters(){let{device:e,width:t,height:i}=this.means_l,{scope:s}=e,r=new ih(e,{name:"sogCentersTexture",width:t,height:i,format:49,mipmaps:false}),a=nY.createShader(e,{uniqueName:"GsplatSogCentersShader",attributes:{vertex_position:e6},vertexChunk:"fullscreenQuadVS",fragmentGLSL:u$,fragmentWGSL:uj,fragmentOutputTypes:["uvec4"],fragmentIncludes:new Map([["gsplatPackingPS",e.isWebGPU?uq:uX]])}),n=new iU({colorBuffer:r,depth:false,mipLevel:0});e.setCullMode(0),e.setBlendState(iS.NOBLEND),e.setDepthState(ix.NODEPTH),uZ(s,{means_l:this.means_l,means_u:this.means_u,numSplats:this.numSplats,means_mins:this.meta.means.mins,means_maxs:this.meta.means.maxs}),n0(e,n,a),n.destroy();let o=await uK(r);if(this.destroyed||e._destroyed)return void r.destroy();let l=new Float32Array(o.buffer),h=new Float32Array(3*this.numSplats);for(let e=0;e<this.numSplats;e++){let t=4*e;h[3*e+0]=l[t+0],h[3*e+1]=l[t+1],h[3*e+2]=l[t+2];}this._centers=h,r.destroy();}packGpuMemory(){let{meta:e,means_l:t,means_u:i,quats:s,scales:r,sh0:a,sh_labels:n,numSplats:o}=this,{device:l}=t,{scope:h}=l,c=2===e.version?"v2":"v1",d=nY.createShader(l,{uniqueName:`GsplatSogReorderShader-${c}`,attributes:{vertex_position:e6},vertexChunk:"fullscreenQuadVS",fragmentGLSL:uG,fragmentWGSL:uH,fragmentOutputTypes:["uvec4","vec4"],fragmentIncludes:new Map([["gsplatPackingPS",l.isWebGPU?uq:uX]]),fragmentDefines:2===e.version?void 0:new Map([["REORDER_V1","1"]])}),u=new iU({colorBuffers:[this.packedTexture,this.packedSh0],depth:false,mipLevel:0});l.setCullMode(0),l.setBlendState(iS.NOBLEND),l.setDepthState(ix.NODEPTH),uZ(h,{means_l:t,means_u:i,quats:s,scales:r,sh0:a,sh_labels:n??t,numSplats:o,"scales_codebook[0]":this.meta.scales.codebook,"sh0_codebook[0]":this.meta.sh0.codebook,scalesMins:e.scales.mins,scalesMaxs:e.scales.maxs,sh0Mins:e.sh0.mins,sh0Maxs:e.sh0.maxs}),n0(l,u,d),u.destroy();}packShMemory(){let{meta:e,sh_centroids:t}=this,{device:i}=t,{scope:s}=i,r=2===e.version?"v2":"v1",a=nY.createShader(i,{uniqueName:`GsplatSogReorderShShader-${r}`,attributes:{vertex_position:e6},vertexChunk:"fullscreenQuadVS",fragmentGLSL:uW,fragmentWGSL:uY,fragmentIncludes:new Map([["gsplatPackingPS",i.isWebGPU?uq:uX]]),fragmentDefines:2===e.version?void 0:new Map([["REORDER_V1","1"]])}),n=new iU({colorBuffer:this.packedShN,depth:false,mipLevel:0});i.setCullMode(0),i.setBlendState(iS.NOBLEND),i.setDepthState(ix.NODEPTH),uZ(s,{sh_centroids:t,"shN_codebook[0]":this.meta.shN.codebook}),n0(i,n,a),n.destroy();}async prepareGpuData(){let e=this.means_l.device,{height:t,width:i}=this.means_l;if(this.destroyed||!e||e._destroyed)return;let s=this.url?`_${this.url}`:"";if((this.packedTexture=new ih(e,{name:`sogPackedTexture${s}`,width:i,height:t,format:49,mipmaps:false}),this.packedSh0=new ih(e,{name:`sogPackedSh0${s}`,width:i,height:t,format:7,mipmaps:false}),this.packedShN=this.sh_centroids&&new ih(e,{name:`sogPackedShN${s}`,width:this.sh_centroids.width,height:this.sh_centroids.height,format:7,mipmaps:false}),this.minimalMemory||(this.deviceRestoredEvent=e.on("devicerestored",()=>{this.packGpuMemory(),this.packedShN&&this.packShMemory();})),["scales","sh0","shN"].forEach(e=>{let t=this.meta[e]?.codebook;t?.[0]===null&&(t[0]=t[1]+(t[1]-t[255])/255);}),e=this.means_l?.device,!this.destroyed&&e&&!e._destroyed)&&(await this.generateCenters(),e=this.means_l?.device,!this.destroyed&&e&&!e._destroyed)){if(this.packGpuMemory(),this.packedShN){if(e=this.means_l?.device,this.destroyed||!e||e._destroyed)return;this.packShMemory();}this.minimalMemory&&(this.means_l?.destroy(),this.means_u?.destroy(),this.quats?.destroy(),this.scales?.destroy(),this.sh0?.destroy(),this.sh_centroids?.destroy(),this.sh_labels?.destroy(),this.means_l=null,this.means_u=null,this.quats=null,this.scales=null,this.sh0=null,this.sh_centroids=null,this.sh_labels=null);}}reorderData(){return this.prepareGpuData()}constructor(){this.url="",this.minimalMemory=false,this.deviceRestoredEvent=null,this._centers=null,this.destroyed=false,this.shBands=0;}}let u0=new ey,u1=new ed,u2=new ed;class u3{destroy(){this.resource?.releaseMesh(),this.orderTexture?.destroy(),this.resolveSH?.destroy(),this.material?.destroy(),this.meshInstance?.destroy(),this.sorter?.destroy();}setMaterialOrderTexture(e){e.setParameter("splatOrder",this.orderTexture),e.setParameter("splatTextureSize",this.orderTexture.width);}set material(e){this._material!==e&&(this._material=e,this.setMaterialOrderTexture(this._material),this.meshInstance&&(this.meshInstance.material=e));}get material(){return this._material}configureMaterial(e,t={}){this.resource.configureMaterial(e,null,this.resource.format.getInputDeclarations()),e.setParameter("numSplats",0),this.setMaterialOrderTexture(e),e.setParameter("alphaClip",.3),e.setDefine(`DITHER_${t.dither?"BLUENOISE":"NONE"}`,""),e.cull=0,e.blendType=t.dither?3:4,e.depthWrite=!!t.dither;}sort(e){if(this.sorter){let t=e.getWorldTransform();t.getTranslation(u1),t.getZ(u2);let i=this.meshInstance.node.getWorldTransform(),s=u0.invert(i);s.transformPoint(u1,u1),s.transformVector(u2,u2),u1.equalsApprox(this.lastCameraPosition)&&u2.equalsApprox(this.lastCameraDirection)||(this.lastCameraPosition.copy(u1),this.lastCameraDirection.copy(u2),this.sorter.setCamera(u1,u2));}}update(){if(this.cameras.length>0){let e=this.cameras[0];this.sort(e._node),this.resolveSH?.render(e._node,this.meshInstance.node.getWorldTransform()),this.cameras.length=0;}}setHighQualitySH(e){let{resource:t}=this,{gsplatData:i}=t;i instanceof uJ&&i.shBands>0&&!!this.resolveSH===e&&(this.resolveSH?(this.resolveSH.destroy(),this.resolveSH=null):this.resolveSH=new uU(t.device,this));}constructor(e,t={}){this.options={},this.sorter=null,this.lastCameraPosition=new ed,this.lastCameraDirection=new ed,this.resolveSH=null,this.cameras=[],this.resource=e;let i=e.streams.textureDimensions;this.orderTexture=e.streams.createTexture("splatOrder",37,i),t.material?(this._material=t.material,this.setMaterialOrderTexture(this._material)):(this._material=new cf({uniqueName:"SplatMaterial",vertexGLSL:'#include "gsplatVS"',fragmentGLSL:'#include "gsplatPS"',vertexWGSL:'#include "gsplatVS"',fragmentWGSL:'#include "gsplatPS"',attributes:{vertex_position:e6,vertex_id_attrib:tb}}),this.configureMaterial(this._material),this._material.update()),e.ensureMesh(),this.meshInstance=new od(e.mesh,this._material),this.meshInstance.setInstancing(e.instanceIndices,true),this.meshInstance.gsplatInstance=this,this.meshInstance.instancingCount=0;let s=e.centers.slice(),r=e.chunks?.slice();this.sorter=new uV(t.scene),this.sorter.init(this.orderTexture,s,r),this.sorter.on("updated",e=>{this.meshInstance.instancingCount=Math.ceil(e/ux.instanceSize),this.material.setParameter("numSplats",e);}),this.setHighQualitySH(t.highQualitySH??false);}}var u4=`
uniform uint splatTextureSize;
uniform uint dstTextureSize;
uniform uint srcNumSplats;
uniform uint dstNumSplats;
#include "gsplatSplatVS"
#include "gsplatProcessInputVS"
#include "gsplatProcessOutputVS"
#include "gsplatProcessReadVS"
#include "gsplatProcessChunk"
void main(void) {
	ivec2 fragCoords = ivec2(gl_FragCoord.xy);
	
	uint splatIndex = uint(fragCoords.y * int(dstTextureSize) + fragCoords.x);
	
	if (splatIndex >= dstNumSplats) discard;
	
	setSplat(splatIndex);
	
	process();
}
`,u5=`
uniform splatTextureSize: u32;
uniform dstTextureSize: u32;
uniform srcNumSplats: u32;
uniform dstNumSplats: u32;
#include "gsplatSplatVS"
#include "gsplatProcessInputVS"
var<private> processOutput: FragmentOutput;
#include "gsplatProcessOutputVS"
#include "gsplatProcessReadVS"
#include "gsplatProcessChunk"
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	let fragCoords = vec2i(input.position.xy);
	
	let splatIndex = u32(fragCoords.y * i32(uniform.dstTextureSize) + fragCoords.x);
	
	if (splatIndex >= uniform.dstNumSplats) {
		discard;
	}
	
	setSplat(splatIndex);
	
	process();
	
	return processOutput;
}
`;class u8 extends ux{configureMaterialDefines(e){e.set("SH_BANDS",this.shBands);}updateColorData(e){let t=this.streams.getTexture("splatColor");if(!t)return;let i=eh.float2Half,s=t.lock(),r=e.getProp("f_dc_0"),a=e.getProp("f_dc_1"),n=e.getProp("f_dc_2"),o=e.getProp("opacity");for(let e=0;e<this.numSplats;++e){let t=.28209479177387814*r[e]+.5,l=.28209479177387814*a[e]+.5,h=.28209479177387814*n[e]+.5,c=1/(1+Math.exp(-o[e]));s[4*e+0]=i(t),s[4*e+1]=i(l),s[4*e+2]=i(h),s[4*e+3]=i(c);}t.unlock();}updateTransformData(e){let t=eh.float2Half,i=this.streams.getTexture("transformA"),s=this.streams.getTexture("transformB");if(!i)return;let r=i.lock(),a=new Float32Array(r.buffer),n=s.lock(),o=new ed,l=new ex,h=new ed,c=e.createIter(o,l,h);for(let e=0;e<this.numSplats;e++)c.read(e),l.normalize(),l.w<0&&l.mulScalar(-1),a[4*e+0]=o.x,a[4*e+1]=o.y,a[4*e+2]=o.z,r[4*e+3]=t(l.x)|t(l.y)<<16,n[4*e+0]=t(h.x),n[4*e+1]=t(h.y),n[4*e+2]=t(h.z),n[4*e+3]=t(l.z);i.unlock(),s.unlock();}updateSHData(e){let t=this.streams.getTexture("splatSH_1to3"),i=this.streams.getTexture("splatSH_4to7"),s=this.streams.getTexture("splatSH_8to11"),r=this.streams.getTexture("splatSH_12to15"),a=t.lock(),n=i?.lock(),o=s?.lock(),l=r?.lock(),h={1:3,2:8,3:15}[this.shBands],c=((e,t)=>{let i=[];for(let s=0;s<t;++s)i.push(e.getProp(`f_rest_${s}`));return i})(e,3*h),d=new Float32Array(1),u=new Uint32Array(d.buffer),f=Array(3*h).fill(0);for(let t=0;t<e.numSplats;++t){for(let e=0;e<h;++e)f[3*e]=c[e][t],f[3*e+1]=c[e+h][t],f[3*e+2]=c[e+2*h][t];let e=f[0];for(let t=1;t<3*h;++t)e=Math.max(e,Math.abs(f[t]));if(0!==e){for(let t=0;t<h;++t)f[3*t+0]=Math.max(0,Math.min(2047,Math.floor((f[3*t+0]/e*.5+.5)*2047+.5))),f[3*t+1]=Math.max(0,Math.min(1023,Math.floor((f[3*t+1]/e*.5+.5)*1023+.5))),f[3*t+2]=Math.max(0,Math.min(2047,Math.floor((f[3*t+2]/e*.5+.5)*2047+.5)));d[0]=e,a[4*t+0]=u[0],a[4*t+1]=f[0]<<21|f[1]<<11|f[2],a[4*t+2]=f[3]<<21|f[4]<<11|f[5],a[4*t+3]=f[6]<<21|f[7]<<11|f[8],this.shBands>1&&(n[4*t+0]=f[9]<<21|f[10]<<11|f[11],n[4*t+1]=f[12]<<21|f[13]<<11|f[14],n[4*t+2]=f[15]<<21|f[16]<<11|f[17],n[4*t+3]=f[18]<<21|f[19]<<11|f[20],this.shBands>2?(o[4*t+0]=f[21]<<21|f[22]<<11|f[23],o[4*t+1]=f[24]<<21|f[25]<<11|f[26],o[4*t+2]=f[27]<<21|f[28]<<11|f[29],o[4*t+3]=f[30]<<21|f[31]<<11|f[32],l[4*t+0]=f[33]<<21|f[34]<<11|f[35],l[4*t+1]=f[36]<<21|f[37]<<11|f[38],l[4*t+2]=f[39]<<21|f[40]<<11|f[41],l[4*t+3]=f[42]<<21|f[43]<<11|f[44]):o[t]=f[21]<<21|f[22]<<11|f[23]);}}t.unlock(),i?.unlock(),s?.unlock(),r?.unlock();}constructor(e,t){super(e,t);let i=t.numSplats;this.shBands=t.shBands;let s=[{name:"splatColor",format:12},{name:"transformA",format:49},{name:"transformB",format:12}];this.shBands>0&&(s.push({name:"splatSH_1to3",format:49}),this.shBands>1&&(s.push({name:"splatSH_4to7",format:49}),this.shBands>2?(s.push({name:"splatSH_8to11",format:49}),s.push({name:"splatSH_12to15",format:49})):s.push({name:"splatSH_8to11",format:37}))),this._format=new cR(e,s,{readGLSL:'#include "gsplatUncompressedVS"',readWGSL:'#include "gsplatUncompressedVS"'}),this.streams.init(this.format,i),this.updateColorData(t),this.updateTransformData(t),this.shBands>0&&this.updateSHData(t);}}class u6 extends ux{_actualDestroy(){this.streams.textures.delete("packedTexture"),this.streams.textures.delete("packedSh0"),this.streams.textures.delete("packedShN"),this.gsplatData.destroy(),super._actualDestroy();}_populateParameters(){let{meta:e}=this.gsplatData;e.means&&(this.parameters.set("means_mins",e.means.mins),this.parameters.set("means_maxs",e.means.maxs)),2===e.version?["scales","sh0","shN"].forEach(t=>{let i=e[t];i&&(this.parameters.set(`${t}_mins`,i.codebook[0]),this.parameters.set(`${t}_maxs`,i.codebook[255]));}):(["scales","sh0"].forEach(t=>{let i=e[t];i&&(this.parameters.set(`${t}_mins`,Math.min(...i.mins.slice(0,3))),this.parameters.set(`${t}_maxs`,Math.max(...i.maxs.slice(0,3))));}),["shN"].forEach(t=>{let i=e[t];i&&(this.parameters.set(`${t}_mins`,i.mins),this.parameters.set(`${t}_maxs`,i.maxs));}));}configureMaterialDefines(e){e.set("SH_BANDS",this.gsplatData.shBands);}constructor(e,t){super(e,t);let i=t.means_l||t.packedTexture;i&&this.streams.textureDimensions.set(i.width,i.height),t.packedTexture&&this.streams.textures.set("packedTexture",t.packedTexture),t.packedSh0&&this.streams.textures.set("packedSh0",t.packedSh0),t.packedShN&&this.streams.textures.set("packedShN",t.packedShN),this._format=new cR(e,[{name:"packedTexture",format:49}],{readGLSL:'#include "gsplatSogVS"',readWGSL:'#include "gsplatSogVS"'}),this._populateParameters();}}let u9="FILL_WINDOW",u7="KEEP_ASPECT",fe="AUTO",ft="FIXED",fi=false,fs={app:null,createLoadingScreen(e){fi||(fi=true,e(r));}};class fr{addRenderPass(e){e.frameUpdate();let t=e.beforePasses;for(let e=0;e<t.length;e++){let i=t[e];i.enabled&&this.addRenderPass(i);}e.enabled&&this.renderPasses.push(e);let i=e.afterPasses;for(let e=0;e<i.length;e++){let t=i[e];t.enabled&&this.addRenderPass(t);}}reset(){this.renderPasses.length=0;}compile(){let e=this.renderTargetMap,t=this.renderPasses;for(let i=0;i<t.length;i++){let s=t[i],r=s.renderTarget;if(void 0!==r){let t=e.get(r);if(t){let e=s.colorArrayOps.length;for(let i=0;i<e;i++)s.colorArrayOps[i].clear||(t.colorArrayOps[i].store=true);s.depthStencilOps.clearDepth||(t.depthStencilOps.storeDepth=true),s.depthStencilOps.clearStencil||(t.depthStencilOps.storeStencil=true);}e.set(r,s);}}for(let e=0;e<t.length-1;e++){let i=t[e],s=i.renderTarget,r=t[e+1];s!==r.renderTarget||void 0===s||r.depthStencilOps.clearDepth||r.depthStencilOps.clearStencil||r.colorArrayOps.some(e=>e.clear)||i.afterPasses.length>0||r.beforePasses.length>0||(i._skipEnd=true,r._skipStart=true);}let i=null,s=null;for(let e=0;e<t.length;e++){let r=t[e],a=r.renderTarget,n=a?.colorBuffer;if(n?.cubemap){if(i===n){let e=s.colorArrayOps.length;for(let t=0;t<e;t++)s.colorArrayOps[t].mipmaps=false;}i=a.colorBuffer,s=r;}else r.requiresCubemaps&&(i=null,s=null);}e.clear();}render(e){this.compile();let t=this.renderPasses;for(let e=0;e<t.length;e++)t[e].render();}constructor(){this.renderPasses=[],this.renderTargetMap=new Map;}}class fa{destroy(){this.texture0?.destroy(),this.texture1?.destroy();}constructor(e,t){this.texture0=e,this.texture1=t;}}let fn=new ii;class fo{static createTexture(e,t,i,s=""){return new ih(e,{name:`AreaLightLUT${s}`,width:i,height:i,format:t,addressU:1,addressV:1,type:tP,magFilter:1,minFilter:0,anisotropy:1,mipmaps:false})}static applyTextures(e,t,i){fn.remove(e),fn.get(e,()=>new fa(t,t===i?null:i)),e.scope.resolve("areaLightsLutTex1").setValue(t),e.scope.resolve("areaLightsLutTex2").setValue(i);}static createPlaceholder(e){let t=fo.createTexture(e,12,2,"placeholder");t.lock().fill(0),t.unlock(),fo.applyTextures(e,t,t);}static set(e,t,i){function s(e,t,i){let s=fo.createTexture(e,i,64);return s.lock().set(t),s.unlock(),s}function r(e){let t=e.length,i=new Uint16Array(t),s=eh.float2Half;for(let r=0;r<t;r++)i[r]=s(e[r]);return i}let a=r(t),n=r(i),o=s(e,a,12),l=s(e,n,12);fo.applyTextures(e,o,l);}}let fl="en-US",fh={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},fc={};function fd(e,t){for(let i=0,s=e.length;i<s;i++)fc[e[i]]=t;}function fu(e){let t=e.indexOf("-");return -1!==t?e.substring(0,t):e}function ff(e,t){if(t[e])return e;let i=fh[e];if(i&&t[i])return i;let s=fu(e);return t[i=fh[s]]?i:t[s]?s:fl}fd(["ja","ko","th","vi","zh","id"],e=>0),fd(["fa","hi"],e=>e>=0&&e<=1?0:1),fd(["fr","pt"],e=>e>=0&&e<2?0:1),fd(["da"],e=>1===e||!Number.isInteger(e)&&e>=0&&e<=1?0:1),fd(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],e=>+(1!==e)),fd(["ru","uk"],e=>{if(Number.isInteger(e)){let t=e%10,i=e%100;if(1===t&&11!==i)return 0;if(t>=2&&t<=4&&(i<12||i>14))return 1;if(0===t||t>=5&&t<=9||i>=11&&i<=14)return 2}return 3}),fd(["pl"],e=>{if(Number.isInteger(e)){if(1===e)return 0;let t=e%10,i=e%100;if(t>=2&&t<=4&&(i<12||i>14))return 1;if(t>=0&&t<=1||t>=5&&t<=9||i>=12&&i<=14)return 2}return 3}),fd(["ar"],e=>{if(0===e)return 0;if(1===e)return 1;if(2===e)return 2;if(Number.isInteger(e)){let t=e%100;if(t>=3&&t<=10)return 3;if(t>=11&&t<=99)return 4}return 5});let fp=fc[fu(fl)],fm=RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-+.]*:)?//|data:|blob:)","i");class f_{equals(e){return this.url===e.url&&this.filename===e.filename&&this.hash===e.hash&&this.size===e.size&&this.opt===e.opt&&this.contents===e.contents}constructor(e="",t="",i=null,s=null,r=null,a=null){this.url=e,this.filename=t,this.hash=i,this.size=s,this.opt=r,this.contents=a;}}let fg=-1,fv={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},fS=["pvr","dxt","etc2","etc1","basis"];class fy extends X{set name(e){if(this._name===e)return;let t=this._name;this._name=e,this.fire("name",this,this._name,t);}get name(){return this._name}set file(e){if(e&&e.variants&&-1!==["texture","textureatlas","bundle"].indexOf(this.type)){let t=this.registry?._loader?._app||r,i=t?.graphicsDevice;if(i)for(let s=0,r=fS.length;s<r;s++){let r=fS[s];if(e.variants[r]&&i[fv[r]]){e=e.variants[r];break}if(t.enableBundles){let e=t.bundles.listBundlesForAsset(this);if(e&&e.find(e=>e?.file?.variants[r]))break}}}let t=this._file,i=e?new f_(e.url,e.filename,e.hash,e.size,e.opt,e.contents):null;(!!i!=!!t||i&&!i.equals(t))&&(this._file=i,this.fire("change",this,"file",i,t),this.reload());}get file(){return this._file}set data(e){let t=this._data;this._data=e,e!==t&&(this.fire("change",this,"data",e,t),this.loaded&&this.registry._loader.patch(this,this.registry));}get data(){return this._data}set resource(e){let t=this._resources[0];this._resources[0]=e,this.fire("change",this,"resource",e,t);}get resource(){return this._resources[0]}set resources(e){let t=this._resources;this._resources=e,this.fire("change",this,"resources",e,t);}get resources(){return this._resources}set preload(e){e=!!e,this._preload!==e&&(this._preload=e,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this));}get preload(){return this._preload}set loadFaces(e){e=!!e,(!this.hasOwnProperty("_loadFaces")||e!==this._loadFaces)&&(this._loadFaces=e,this.loaded&&this.registry._loader.patch(this,this.registry));}get loadFaces(){return this._loadFaces}getFileUrl(){let e=this.file;if(!e||!e.url)return null;let t=e.url;if(this.registry&&this.registry.prefix&&!fm.test(t)&&(t=this.registry.prefix+t),"script"!==this.type&&e.hash){let i=-1!==t.indexOf("?")?"&":"?";t+=`${i}t=${e.hash}`;}return t}getAbsoluteUrl(e){if(e.startsWith("blob:")||e.startsWith("data:"))return e;let t=P.getDirectory(this.file.url);return P.join(t,e)}getLocalizedAssetId(e){return e=ff(e,this._i18n),this._i18n[e]||null}addLocalizedAssetId(e,t){this._i18n[e]=t,this.fire("add:localized",e,t);}removeLocalizedAssetId(e){let t=this._i18n[e];t&&(delete this._i18n[e],this.fire("remove:localized",e,t));}ready(e,t){t=t||this,this.loaded?e.call(t,this):this.once("load",i=>{e.call(t,i);});}reload(){this.loaded&&(this.loaded=false,this.registry.load(this));}unload(){if(!this.loaded&&0===this._resources.length)return;this.fire("unload",this),this.registry.fire(`unload:${this.id}`,this);let e=this._resources;this.urlObject&&(URL.revokeObjectURL(this.urlObject),this.urlObject=null),this.resources=[],this.loaded=false,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(let t=0;t<e.length;++t)e[t]?.destroy?.();}static fetchArrayBuffer(e,t,i,s=0){i?.file?.contents?setTimeout(()=>{t(null,i.file.contents);}):a$.get(e,{cache:true,responseType:"arraybuffer",retry:s>0,maxRetries:s,progress:i},t);}constructor(e,t,i,s={},r={}){super(),this._file=null,this._i18n={},this._preload=false,this._resources=[],this.id=fg--,this.loaded=false,this.loading=false,this.options={},this.registry=null,this.tags=new Z(this),this.urlObject=null,this._name=e||"",this.type=t,this._data=s||{},this.options=r||{},i&&(this.file=i);}}fy.EVENT_LOAD="load",fy.EVENT_UNLOAD="unload",fy.EVENT_REMOVE="remove",fy.EVENT_ERROR="error",fy.EVENT_CHANGE="change",fy.EVENT_PROGRESS="progress",fy.EVENT_ADDLOCALIZED="add:localized",fy.EVENT_REMOVELOCALIZED="remove:localized";class fx{addItem(e){for(let t of e.tags._list)this.add(t,e);}removeItem(e){for(let t of e.tags._list)this.remove(t,e);}add(e,t){(!this._index[e]||-1===this._index[e].list.indexOf(t))&&(!this._index[e]&&(this._index[e]={list:[]},this._key&&(this._index[e].keys={})),this._index[e].list.push(t),this._key&&(this._index[e].keys[t[this._key]]=t));}remove(e,t){if(!this._index[e]||this._key&&!this._index[e].keys[t[this._key]])return;let i=this._index[e].list.indexOf(t);-1!==i&&(this._index[e].list.splice(i,1),this._key&&delete this._index[e].keys[t[this._key]],0===this._index[e].list.length&&delete this._index[e]);}find(e){let t,i,s,r,a,n={},o=[],l=(e,t)=>this._index[e].list.length-this._index[t].list.length;for(let h=0;h<e.length;h++){if((i=e[h])instanceof Array){if(0===i.length)continue;if(1===i.length)i=i[0];else {a=false;for(let e=0;e<i.length;e++)if(!this._index[i[e]]){a=true;break}if(a)continue;1===(r=(s=i.slice(0).sort(l)).slice(1)).length&&(r=r[0]);for(let e=0;e<this._index[s[0]].list.length;e++)t=this._index[s[0]].list[e],(this._key?!n[t[this._key]]:-1===o.indexOf(t))&&t.tags.has(r)&&(this._key&&(n[t[this._key]]=true),o.push(t));continue}}if(i&&"string"==typeof i&&this._index[i])for(let e=0;e<this._index[i].list.length;e++)t=this._index[i].list[e],this._key?n[t[this._key]]||(n[t[this._key]]=true,o.push(t)):-1===o.indexOf(t)&&o.push(t);}return o}constructor(e=null){this._index={},this._key=e;}}class fT extends X{get loader(){return this._loader}list(e={}){let t=Array.from(this._assets);return void 0!==e.preload?t.filter(t=>t.preload===e.preload):t}add(e){!this._assets.has(e)&&(this._assets.add(e),this._idToAsset.set(e.id,e),e.file?.url&&this._urlToAsset.set(e.file.url,e),this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e),e.on("name",this._onNameChange,this),e.registry=this,this._tags.addItem(e),e.tags.on("add",this._onTagAdd,this),e.tags.on("remove",this._onTagRemove,this),this.fire("add",e),this.fire(`add:${e.id}`,e),e.file?.url&&this.fire(`add:url:${e.file.url}`,e),e.preload&&this.load(e));}remove(e){if(!this._assets.has(e))return  false;if(this._assets.delete(e),this._idToAsset.delete(e.id),e.file?.url&&this._urlToAsset.delete(e.file.url),e.off("name",this._onNameChange,this),this._nameToAsset.has(e.name)){let t=this._nameToAsset.get(e.name);t.delete(e),0===t.size&&this._nameToAsset.delete(e.name);}return this._tags.removeItem(e),e.tags.off("add",this._onTagAdd,this),e.tags.off("remove",this._onTagRemove,this),e.fire("remove",e),this.fire("remove",e),this.fire(`remove:${e.id}`,e),e.file?.url&&this.fire(`remove:url:${e.file.url}`,e),true}get(e){return this._idToAsset.get(Number(e))}getByUrl(e){return this._urlToAsset.get(e)}load(e,t){if((e.loading||e.loaded)&&!t?.force)return;let i=e.file,s=()=>{this.fire("load",e),this.fire(`load:${e.id}`,e),i&&i.url&&this.fire(`load:url:${i.url}`,e),e.fire("load",e);},r=t=>{if(t instanceof Array?e.resources=t:e.resource=t,this._loader.patch(e,this),"bundle"===e.type){let t=e.data.assets;for(let e=0;e<t.length;e++){let i=this._idToAsset.get(t[e]);i&&!i.loaded&&this.load(i,{force:true});}e.resource.loaded?s():(this.fire("load:start",e),this.fire(`load:start:${e.id}`,e),i&&i.url&&this.fire(`load:start:url:${i.url}`,e),e.fire("load:start",e),e.resource.on("load",s));}else s();},a=(t,i,s)=>{if(e.loaded=true,e.loading=false,t)this.fire("error",t,e),this.fire(`error:${e.id}`,t,e),e.fire("error",t,e);else {if("script"===e.type){let t=this._loader.getHandler("script");t._cache[e.id]&&t._cache[e.id].parentNode===document.head&&document.head.removeChild(t._cache[e.id]),s&&(t._cache[e.id]=s);}r(i);}};if(i||"cubemap"===e.type){this.fire("load:start",e),this.fire(`load:${e.id}:start`,e),e.loading=true;let i=e.getFileUrl();if("bundle"===e.type){let t=e.data.assets;for(let e=0;e<t.length;e++){let i=this._idToAsset.get(t[e]);i&&(i.loaded||i.resource||i.loading||(i.loading=true));}}this._loader.load(i,e.type,a,e,t);}else {let t=this._loader.open(e.type,e.data);e.loaded=true,r(t);}}loadFromUrl(e,t,i){this.loadFromUrlAndFilename(e,null,t,i);}loadFromUrlAndFilename(e,t,i,s){let r=P.getBasename(t||e),a=this.getByUrl(e);if(a){if(a.loaded)return void s(a.loadFromUrlError||null,a)}else a=new fy(r,i,{filename:t||r,url:e}),this.add(a);let n=e=>{e.once("load",e=>{"material"===i?this._loadTextures(e,(t,i)=>{s(t,e);}):s(null,e);}),e.once("error",t=>{t&&(this.loadFromUrlError=t),s(t,e);}),this.load(e);};a.resource?s(null,a):"model"===i?this._loadModel(a,n):n(a);}_loadModel(e,t){let i=e.getFileUrl(),s=P.getExtension(i);if(".json"===s||".glb"===s){let r=P.getDirectory(i),a=P.getBasename(i),n=P.join(r,a.replace(s,".mapping.json"));this._loader.load(n,"json",(i,s)=>{i?(e.data={mapping:[]},t(e)):this._loadMaterials(e,s,(i,r)=>{e.data=s,t(e);});});}else t(e);}_loadMaterials(e,t,i){let s=[],r=0,a=(e,t)=>{this._loadTextures(t,(e,a)=>{s.push(t),s.length===r&&i(null,s);});};for(let i=0;i<t.mapping.length;i++){let s=t.mapping[i].path;if(s){r++;let t=e.getAbsoluteUrl(s);this.loadFromUrl(t,"material",a);}}0===r&&i(null,s);}_loadTextures(e,t){let i=[],s=0,r=e.data;if("path"!==r.mappingFormat)return void t(null,i);let a=(e,r)=>{i.push(r),i.length===s&&t(null,i);};for(let t=0;t<dq.length;t++){let i=r[dq[t]];if(i&&"string"==typeof i){s++;let t=e.getAbsoluteUrl(i);this.loadFromUrl(t,"texture",a);}}0===s&&t(null,i);}_onTagAdd(e,t){this._tags.add(e,t);}_onTagRemove(e,t){this._tags.remove(e,t);}_onNameChange(e,t,i){if(this._nameToAsset.has(i)){let t=this._nameToAsset.get(i);t.delete(e),0===t.size&&this._nameToAsset.delete(i);}this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e);}findByTag(...e){return this._tags.find(e)}filter(e){return Array.from(this._assets).filter(t=>e(t))}find(e,t){let i=this._nameToAsset.get(e);if(!i)return null;for(let e of i)if(!t||e.type===t)return e;return null}findAll(e,t){let i=this._nameToAsset.get(e);if(!i)return [];let s=Array.from(i);return t?s.filter(e=>e.type===t):s}log(){}constructor(e){super(),this._assets=new Set,this._idToAsset=new Map,this._urlToAsset=new Map,this._nameToAsset=new Map,this._tags=new fx("id"),this.prefix=null,this.bundles=null,this._loader=e;}}fT.EVENT_LOAD="load",fT.EVENT_ADD="add",fT.EVENT_REMOVE="remove",fT.EVENT_ERROR="error";class fE{_onAssetAdd(e){if("bundle"===e.type){this._idToBundle.set(e.id,e),this._assets.on(`load:start:${e.id}`,this._onBundleLoadStart,this),this._assets.on(`load:${e.id}`,this._onBundleLoad,this),this._assets.on(`error:${e.id}`,this._onBundleError,this);let t=e.data.assets;for(let i=0;i<t.length;i++)this._indexAssetInBundle(t[i],e);}else this._assetToBundles.has(e.id)&&this._indexAssetFileUrls(e);}_unbindAssetEvents(e){this._assets.off(`load:start:${e}`,this._onBundleLoadStart,this),this._assets.off(`load:${e}`,this._onBundleLoad,this),this._assets.off(`error:${e}`,this._onBundleError,this);}_indexAssetInBundle(e,t){let i=this._assetToBundles.get(e);i||(i=new Set,this._assetToBundles.set(e,i)),i.add(t);let s=this._assets.get(e);s&&this._indexAssetFileUrls(s);}_indexAssetFileUrls(e){let t=this._getAssetFileUrls(e);if(t)for(let i=0;i<t.length;i++){let s=this._assetToBundles.get(e.id);s&&this._urlsToBundles.set(t[i],s);}}_getAssetFileUrls(e){let t=e.getFileUrl();if(!t)return null;let i=[t=t.split("?")[0]];if("font"===e.type){let s=e.data.info.maps.length;for(let e=1;e<s;e++)i.push(t.replace(".png",`${e}.png`));}return i}_onAssetRemove(e){if("bundle"===e.type){this._idToBundle.delete(e.id),this._unbindAssetEvents(e.id);let t=e.data.assets;for(let i=0;i<t.length;i++){let s=this._assetToBundles.get(t[i]);if(s&&(s.delete(e),0===s.size))for(let[e,r]of(this._assetToBundles.delete(t[i]),this._urlsToBundles))r===s&&this._urlsToBundles.delete(e);}this._onBundleError(`Bundle ${e.id} was removed`);}else {if(!this._assetToBundles.get(e.id))return;this._assetToBundles.delete(e.id);let t=this._getAssetFileUrls(e);if(!t)return;for(let e=0;e<t.length;e++)this._urlsToBundles.delete(t[e]);}}_onBundleLoadStart(e){e.resource.on("add",(e,t)=>{let i=this._fileRequests.get(e);if(i){for(let e=0;e<i.length;e++)i[e](null,t);this._fileRequests.delete(e);}});}_onBundleLoad(e){if(!e.resource)return void this._onBundleError(`Bundle ${e.id} failed to load`);if(this._fileRequests)for(let[t,i]of this._fileRequests){let s,r,a=this._urlsToBundles.get(t);if(!a||!a.has(e))continue;let n=decodeURIComponent(t);if(e.resource.has(n))r=e.resource.get(n);else {if(!e.resource.loaded)continue;s=`Bundle ${e.id} does not contain URL ${t}`;}for(let e=0;e<i.length;e++)i[e](s,s||r);this._fileRequests.delete(t);}}_onBundleError(e){for(let[t,i]of this._fileRequests)if(!this._findLoadedOrLoadingBundleForUrl(t)){for(let t=0;t<i.length;t++)i[t](e);this._fileRequests.delete(t);}}_findLoadedOrLoadingBundleForUrl(e){let t=this._urlsToBundles.get(e);if(!t)return null;let i=null;for(let e of t)if(e.loaded&&e.resource)return e;else e.loading&&(i=e);return i}listBundlesForAsset(e){let t=this._assetToBundles.get(e.id);return t?Array.from(t):null}list(){return Array.from(this._idToBundle.values())}hasUrl(e){return this._urlsToBundles.has(e)}urlIsLoadedOrLoading(e){return !!this._findLoadedOrLoadingBundleForUrl(e)}loadUrl(e,t){let i=this._findLoadedOrLoadingBundleForUrl(e);if(!i)return void t(`URL ${e} not found in any bundles`);if(i.loaded){let s=decodeURIComponent(e);if(i.resource.has(s))return void t(null,i.resource.get(s));if(i.resource.loaded)return void t(`Bundle ${i.id} does not contain URL ${e}`)}let s=this._fileRequests.get(e);s||(s=[],this._fileRequests.set(e,s)),s.push(t);}destroy(){for(let e of(this._assets.off("add",this._onAssetAdd,this),this._assets.off("remove",this._onAssetRemove,this),this._idToBundle.keys()))this._unbindAssetEvents(e);this._assets=null,this._idToBundle.clear(),this._idToBundle=null,this._assetToBundles.clear(),this._assetToBundles=null,this._urlsToBundles.clear(),this._urlsToBundles=null,this._fileRequests.clear(),this._fileRequests=null;}constructor(e){this._idToBundle=new Map,this._assetToBundles=new Map,this._urlsToBundles=new Map,this._fileRequests=new Map,this._assets=e,this._assets.bundles=this,this._assets.on("add",this._onAssetAdd,this),this._assets.on("remove",this._onAssetRemove,this);}}class fw extends X{add(e){let t=e.id;if(this[t])throw Error(`ComponentSystem name '${t}' already registered or not allowed`);this[t]=e,this.list.push(e);}remove(e){let t=e.id;if(!this[t])throw Error(`No ComponentSystem named '${t}' registered`);delete this[t];let i=this.list.indexOf(this[t]);-1!==i&&this.list.splice(i,1);}destroy(){this.off();for(let e=0;e<this.list.length;e++)this.list[e].destroy();}constructor(){super(),this.list=[];}}class fb extends X{addFile(e,t){this._index.has(e)||(this._index.set(e,t),this.fire("add",e,t));}has(e){return this._index.has(e)}get(e){return this._index.get(e)||null}destroy(){this._index.clear();}set loaded(e){e&&!this._loaded&&(this._loaded=true,this.fire("load"));}get loaded(){return this._loaded}constructor(...e){super(...e),this._index=new Map,this._loaded=false;}}fb.EVENT_ADD="add",fb.EVENT_LOAD="load";class fA extends X{pump(e,t){if(e)return this.fire("done"),null;this.bytesReceived+=t.byteLength;let i=new Uint8Array(this.data.length+t.length);for(i.set(this.data),i.set(t,this.data.length),this.data=i;this.readFile(););return this.reader.read().then(e=>{this.pump(e.done,e.value);}).catch(e=>{this.fire("error",e);})}readFile(){if(!this.headerRead&&this.bytesReceived>this.bytesRead+this.headerSize){this.headerRead=true;let e=new DataView(this.data.buffer,this.bytesRead,this.headerSize);this.decoder??(this.decoder=new TextDecoder("windows-1252"));let t=this.decoder.decode(e);if(this.fileName=t.substring(0,100).replace(/\0/g,""),this.fileSize=parseInt(t.substring(124,136),8),this.fileType=t.substring(156,157),this.ustarFormat=t.substring(257,263),-1!==this.ustarFormat.indexOf("ustar")){let e=t.substring(345,500).replace(/\0/g,"");e.length>0&&(this.fileName=e.trim()+this.fileName.trim());}this.bytesRead+=512;}if(this.headerRead){if(this.bytesReceived<this.bytesRead+this.fileSize)return  false;if(""===this.fileType||"0"===this.fileType){let e=new DataView(this.data.buffer,this.bytesRead,this.fileSize),t={name:this.prefix+this.fileName,size:this.fileSize,data:e};this.fire("file",t);}this.bytesRead+=this.fileSize,this.headerRead=false;let e=this.bytesRead%this.paddingSize;return 0!==e&&(this.bytesRead+=this.paddingSize-e),true}return  false}constructor(e,t=""){super(),this.headerSize=512,this.paddingSize=512,this.bytesRead=0,this.bytesReceived=0,this.headerRead=false,this.reader=null,this.data=new Uint8Array(0),this.decoder=null,this.prefix="",this.fileName="",this.fileSize=0,this.fileType="",this.ustarFormat="",this.prefix=t||"",this.reader=e.body.getReader(),this.reader.read().then(e=>{this.pump(e.done,e.value);}).catch(e=>{this.fire("error",e);});}}class fC{set maxRetries(e){this._maxRetries=e;}get maxRetries(){return this._maxRetries}load(e,t,i){}open(e,t,i){return t}patch(e,t){}constructor(e,t){this.handlerType="",this._maxRetries=0,this._app=e,this.handlerType=t;}}class fP extends fC{_fetchRetries(e,t,i=0){return new Promise((s,r)=>{let a=()=>{fetch(e,t).then(s).catch(e=>{++i<this.maxRetries?a():r(e);});};a();})}load(e,t){"string"==typeof e&&(e={load:e,original:e}),this._fetchRetries(e.load,{mode:"cors"},this.maxRetries).then(e=>{let i=new fb;t(null,i);let s=new fA(e,this._assets.prefix);s.on("file",e=>{i.addFile(e.name,e.data);}),s.on("done",()=>{i.loaded=true;}),s.on("error",e=>{t(e);});}).catch(e=>{t(e);});}open(e,t){return t}constructor(e){super(e,"bundle"),this._assets=e.assets;}}class fI{addHandler(e,t){this._handlers[e]=t,t._loader=this;}removeHandler(e){delete this._handlers[e];}getHandler(e){return this._handlers[e]}static makeKey(e,t){return `${e}-${t}`}load(e,t,i,s,r){let a=this._handlers[t];if(!a)return void i(`No resource handler for asset type: '${t}' when loading [${e}]`);if(!e)return void this._loadNull(a,i,s);let n=fI.makeKey(e,t);if(void 0!==this._cache[n])i(null,this._cache[n]);else if(this._requests[n])this._requests[n].push(i);else {this._requests[n]=[i];let t=this,o=function(e,i){if(e)return void t._onFailure(n,e);if(i.load instanceof DataView){if(a.openBinary){if(!t._requests[n])return;try{let e=a.openBinary(i.load);t._onSuccess(n,e);}catch(e){t._onFailure(n,e);}return}i.load=URL.createObjectURL(new Blob([i.load])),s&&(s.urlObject&&URL.revokeObjectURL(s.urlObject),s.urlObject=i.load);}a.load(i,(e,r,o)=>{if(t._requests[n]){if(e)return void t._onFailure(n,e);try{t._onSuccess(n,a.open(i.original,r,s),o);}catch(e){t._onFailure(n,e);}}},s);},l=e.split("?")[0];if(this._app.enableBundles&&this._app.bundles.hasUrl(l)&&!(r&&r.bundlesIgnore)){if(!this._app.bundles.urlIsLoadedOrLoading(l)){let e,t=this._app.bundles.listBundlesForAsset(s);r&&r.bundlesFilter&&(e=r.bundlesFilter(t)),e||(t?.sort((e,t)=>e.file.size-t.file.size),e=t?.[0]),e&&this._app.assets?.load(e);}this._app.bundles.loadUrl(l,(e,t)=>{o(e,{load:t,original:l});});}else o(null,{load:e,original:s&&s.file.filename||e});}}_loadNull(e,t,i){e.load(null,function(s,r,a){if(s)t(s);else try{t(null,e.open(null,r,i),a);}catch(e){t(e);}},i);}_onSuccess(e,t,i){null!==t?this._cache[e]=t:delete this._cache[e];for(let s=0;s<this._requests[e].length;s++)this._requests[e][s](null,t,i);delete this._requests[e];}_onFailure(e,t){if(this._requests[e]){for(let i=0;i<this._requests[e].length;i++)this._requests[e][i](t);delete this._requests[e];}}open(e,t){let i=this._handlers[e];return i?i.open(null,t):t}patch(e,t){let i=this._handlers[e.type];i&&i.patch&&i.patch(e,t);}clearCache(e,t){let i=fI.makeKey(e,t);delete this._cache[i];}getFromCache(e,t){let i=fI.makeKey(e,t);if(this._cache[i])return this._cache[i]}enableRetry(e=5){for(let t in e=Math.max(0,e)||0,this._handlers)this._handlers[t].maxRetries=e;}disableRetry(){for(let e in this._handlers)this._handlers[e].maxRetries=0;}destroy(){this._handlers={},this._requests={},this._cache={};}constructor(e){this._handlers={},this._requests={},this._cache={},this._app=e;}}class fD{_validate(e){if(!e.header)throw Error('pc.I18n#addData: Missing "header" field');if(!e.header.version)throw Error('pc.I18n#addData: Missing "header.version" field');if(1!==e.header.version)throw Error('pc.I18n#addData: Invalid "header.version" field');if(e.data){if(!Array.isArray(e.data))throw Error('pc.I18n#addData: "data" field must be an array')}else throw Error('pc.I18n#addData: Missing "data" field');for(let t=0,i=e.data.length;t<i;t++){let i=e.data[t];if(!i.info)throw Error(`pc.I18n#addData: missing "data[${t}].info" field`);if(!i.info.locale)throw Error(`pc.I18n#addData: missing "data[${t}].info.locale" field`);if("string"!=typeof i.info.locale)throw Error(`pc.I18n#addData: "data[${t}].info.locale" must be a string`);if(!i.messages)throw Error(`pc.I18n#addData: missing "data[${t}].messages" field`)}}parse(e){return e.data}}class fR extends X{set assets(e){let t={};for(let i=0,s=e.length;i<s;i++)t[e[i]instanceof fy?e[i].id:e[i]]=true;let i=this._assets.length;for(;i--;){let e=this._assets[i];if(!t[e]){this._app.assets.off(`add:${e}`,this._onAssetAdd,this);let t=this._app.assets.get(e);t&&this._onAssetRemove(t),this._assets.splice(i,1);}}for(let e in t){let t=parseInt(e,10);if(-1!==this._assets.indexOf(t))continue;this._assets.push(t);let i=this._app.assets.get(t);i?this._onAssetAdd(i):this._app.assets.once(`add:${t}`,this._onAssetAdd,this);}}get assets(){return this._assets}set locale(e){if(this._locale===e)return;let t=fu(e);if("in"===t){var i,s;let r;if(t="id",i=e,s=t,e=-1!==(r=i.indexOf("-"))?s+i.substring(r):s,this._locale===e)return}let r=this._locale;this._locale=e,this._lang=t,this._pluralFn=fc[this._lang]||fp,this.fire(fR.EVENT_CHANGE,e,r);}get locale(){return this._locale}static findAvailableLocale(e,t){return ff(e,t)}findAvailableLocale(e){if(this._translations[e])return e;let t=fu(e);return this._findFallbackLocale(e,t)}getText(e,t){let i,s=e;t||(t=this._locale,i=this._lang);let r=this._translations[t];return r||(i||(i=fu(t)),t=this._findFallbackLocale(t,i),r=this._translations[t]),r&&r.hasOwnProperty(e)&&(Array.isArray(s=r[e])&&(s=s[0]),null==s&&(s=e)),s}getPluralText(e,t,i){let s,r,a=e;i?r=fc[s=fu(i)]||fp:(i=this._locale,s=this._lang,r=this._pluralFn);let n=this._translations[i];if(n||(r=fc[s=fu(i=this._findFallbackLocale(i,s))]||fp,n=this._translations[i]),n&&n[e]&&r){let i=r(t);null==(a=n[e][i])&&(a=e);}return a}addData(e){let t;try{t=this._parser.parse(e);}catch(e){return}for(let e=0,i=t.length;e<i;e++){let i=t[e],s=i.info.locale,r=i.messages;if(!this._translations[s]){this._translations[s]={};let e=fu(s);this._availableLangs[e]||(this._availableLangs[e]=s);}Object.assign(this._translations[s],r),this.fire("data:add",s,r);}}removeData(e){let t;try{t=this._parser.parse(e);}catch(e){return}for(let e=0,i=t.length;e<i;e++){let i=t[e],s=i.info.locale,r=this._translations[s];if(!r)continue;let a=i.messages;for(let e in a)delete r[e];0===Object.keys(r).length&&(delete this._translations[s],delete this._availableLangs[fu(s)]),this.fire("data:remove",s,a);}}destroy(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off();}_findFallbackLocale(e,t){let i=fh[e];return i&&this._translations[i]||(i=fh[t])&&this._translations[i]||(i=this._availableLangs[t])&&this._translations[i]?i:fl}_onAssetAdd(e){e.on("load",this._onAssetLoad,this),e.on("change",this._onAssetChange,this),e.on("remove",this._onAssetRemove,this),e.on("unload",this._onAssetUnload,this),e.resource&&this._onAssetLoad(e);}_onAssetLoad(e){this.addData(e.resource);}_onAssetChange(e){e.resource&&this.addData(e.resource);}_onAssetRemove(e){e.off("load",this._onAssetLoad,this),e.off("change",this._onAssetChange,this),e.off("remove",this._onAssetRemove,this),e.off("unload",this._onAssetUnload,this),e.resource&&this.removeData(e.resource),this._app.assets.once(`add:${e.id}`,this._onAssetAdd,this);}_onAssetUnload(e){e.resource&&this.removeData(e.resource);}constructor(e){super(),this.locale=fl,this._translations={},this._availableLangs={},this._app=e,this._assets=[],this._parser=new fD;}}fR.EVENT_CHANGE="change";class fL extends X{destroy(){this.app=null,this.off();}addSchema(e,t){t&&this._scriptSchemas.set(e,t);}getSchema(e){return this._scriptSchemas.get(e)}add(e){let t=e.__name;return this._scripts.hasOwnProperty(t)?(setTimeout(()=>{if(e.prototype.swap){let i=this._scripts[t],s=this._list.indexOf(i);this._list[s]=e,this._scripts[t]=e,this.fire("swap",t,e),this.fire(`swap:${t}`,e);}}),false):(this._scripts[t]=e,this._list.push(e),this.fire("add",t,e),this.fire(`add:${t}`,e),setTimeout(()=>{let e;if(!this._scripts.hasOwnProperty(t)||!this.app||!this.app.systems||!this.app.systems.script)return;let i=this.app.systems.script._components,s=[],r=[];for(i.loopIndex=0;i.loopIndex<i.length;i.loopIndex++){let r=i.items[i.loopIndex];if(r._scriptsIndex[t]&&r._scriptsIndex[t].awaiting){r._scriptsData&&r._scriptsData[t]&&(e=r._scriptsData[t].attributes);let i=r.create(t,{preloading:true,ind:r._scriptsIndex[t].ind,attributes:e});for(let e of(i&&s.push(i),r.scripts))r.initializeAttributes(e);}}for(let e=0;e<s.length;e++)s[e].enabled&&(s[e]._initialized=true,r.push(s[e]),s[e].initialize&&s[e].initialize());for(let e=0;e<r.length;e++)r[e].enabled&&!r[e]._postInitialized&&(r[e]._postInitialized=true,r[e].postInitialize&&r[e].postInitialize());}),true)}remove(e){let t=e,i=e;if("string"!=typeof i?i=t.__name:t=this.get(i),this.get(i)!==t)return  false;delete this._scripts[i];let s=this._list.indexOf(t);return this._list.splice(s,1),this.fire("remove",i,t),this.fire(`remove:${i}`,t),true}get(e){return this._scripts[e]||null}has(e){if("string"==typeof e)return this._scripts.hasOwnProperty(e);if(!e)return  false;let t=e.__name;return this._scripts[t]===e}list(){return this._list}constructor(e){super(),this._scripts={},this._list=[],this._scriptSchemas=new Map,this.app=e;}}let fM=(e,t)=>e.constructor.order-t.constructor.order,fO=[],fF=[],fN=e=>{e.length=0,fF.push(e);};class fB extends oX{addComponent(e,t){let i=this._app.systems[e];return !i||this.c[e]?null:i.addComponent(this,t)}removeComponent(e){let t=this._app.systems[e];!t||this.c[e]&&t.removeComponent(this);}findComponent(e){let t=this.findOne(t=>t.c?.[e]);return t&&t.c[e]}findComponents(e){return this.find(t=>t.c?.[e]).map(t=>t.c[e])}findScript(e){let t=this.findOne(t=>t.c?.script?.has(e));return t?.c.script.get(e)}findScripts(e){return this.find(t=>t.c?.script?.has(e)).map(t=>t.c.script.get(e))}getGuid(){return this._guid||this.setGuid(C.create()),this._guid}setGuid(e){let t=this._app._entityIndex;this._guid&&delete t[this._guid],this._guid=e,t[this._guid]=this;}_notifyHierarchyStateChanged(e,t){let i=false;e===this&&0===fO.length&&(i=true),e._beingEnabled=true,e._onHierarchyStateChanged(t),e._onHierarchyStatePostChanged&&fO.push(e);let s=e._children;for(let e=0,i=s.length;e<i;e++)s[e]._enabled&&this._notifyHierarchyStateChanged(s[e],t);if(e._beingEnabled=false,i){for(let e=0;e<fO.length;e++)fO[e]._onHierarchyStatePostChanged();fO.length=0;}}_onHierarchyStateChanged(e){super._onHierarchyStateChanged(e);let t=this._getSortedComponents();for(let i=0;i<t.length;i++){let s=t[i];s.enabled&&(e?s.onEnable():s.onDisable());}fN(t);}_onHierarchyStatePostChanged(){let e=this._getSortedComponents();for(let t=0;t<e.length;t++)e[t].onPostStateChange();fN(e);}findByGuid(e){if(this._guid===e)return this;let t=this._app._entityIndex[e];return t&&(t===this||t.isDescendantOf(this))?t:null}destroy(){for(let e in this._destroying=true,this.c)this.c[e].enabled=false;for(let e in this.c)this.c[e].system.removeComponent(this);super.destroy(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=false;}clone(){let e={},t=this._cloneRecursively(e);return e[this.getGuid()]=t,function e(t,i,s,r){if(i instanceof fB){let a=i.c;for(let e in a){let i=a[e],n=i.system.getPropertiesOfType("entity");for(let a=0,o=n.length;a<o;a++){let o=n[a].name,l=i[o];if(t.findByGuid(l)){let t=r[l].getGuid();t&&(s.c[e][o]=t);}}}a.script&&s.script.resolveDuplicatedEntityReferenceProperties(a.script,r),a.render&&s.render.resolveDuplicatedEntityReferenceProperties(a.render,r),a.button&&s.button.resolveDuplicatedEntityReferenceProperties(a.button,r),a.scrollview&&s.scrollview.resolveDuplicatedEntityReferenceProperties(a.scrollview,r),a.scrollbar&&s.scrollbar.resolveDuplicatedEntityReferenceProperties(a.scrollbar,r),a.anim&&s.anim.resolveDuplicatedEntityReferenceProperties(a.anim,r);let n=i.children.filter(e=>e instanceof fB),o=s.children.filter(e=>e instanceof fB);for(let i=0,s=n.length;i<s;i++)e(t,n[i],o[i],r);}}(this,this,t,e),t}_getSortedComponents(){let e=this.c,t=fF.pop()??[],i=0;for(let s in e)if(e.hasOwnProperty(s)){let r=e[s];i|=0!==r.constructor.order,t.push(r);}return i&&t.length>1&&t.sort(fM),t}_cloneRecursively(e){let t=new this.constructor(void 0,this._app);for(let e in super._cloneInternal(t),this.c)this.c[e].system.cloneComponent(this,t);for(let i=0;i<this._children.length;i++){let s=this._children[i];if(s instanceof fB){let i=s._cloneRecursively(e);t.addChild(i),e[s.getGuid()]=i;}}return t}constructor(e,t=r){super(e),this.c={},this._destroying=false,this._guid=null,this._template=false,this._app=t;}}fB.EVENT_DESTROY="destroy";class fk{get loaded(){return !!this.data}get loading(){return this._loading}constructor(e,t){this.data=null,this._loading=false,this._onLoadedCallbacks=[],this.name=e,this.url=t;}}class fU{destroy(){this._app=null;}list(){return this._list}add(e,t){if(this._index.hasOwnProperty(e))return  false;let i=new fk(e,t),s=this._list.push(i);return this._index[i.name]=s-1,this._urlIndex[i.url]=s-1,true}find(e){return this._index.hasOwnProperty(e)?this._list[this._index[e]]:null}findByUrl(e){return this._urlIndex.hasOwnProperty(e)?this._list[this._urlIndex[e]]:null}remove(e){if(this._index.hasOwnProperty(e)){let t=this._index[e],i=this._list[t];delete this._urlIndex[i.url],delete this._index[e],this._list.splice(t,1);for(let e=0;e<this._list.length;e++)i=this._list[e],this._index[i.name]=e,this._urlIndex[i.url]=e;}}_loadSceneData(e,t,i){let s=this._app,r=e;("string"==typeof e&&(e=this.findByUrl(r)||this.find(r)||new fk("Untitled",r)),r=e.url)?e.loaded?i(null,e):(s.assets&&s.assets.prefix&&!fm.test(r)&&(r=P.join(s.assets.prefix,r)),e._onLoadedCallbacks.push(i),e._loading||s.loader.getHandler("hierarchy").load(r,(i,s)=>{e.data=s,e._loading=false;for(let t=0;t<e._onLoadedCallbacks.length;t++)e._onLoadedCallbacks[t](i,e);t||(e.data=null),e._onLoadedCallbacks.length=0;}),e._loading=true):i("Cannot find scene to load");}loadSceneData(e,t){this._loadSceneData(e,true,t);}unloadSceneData(e){"string"==typeof e&&(e=this.findByUrl(e)),e&&(e.data=null);}_loadSceneHierarchy(e,t,i){this._loadSceneData(e,false,(e,s)=>{if(e){i&&i(e);return}t&&t(s);let r=this._app;r._preloadScripts(s.data,()=>{let e=r.loader.getHandler("hierarchy");r.systems.script.preloading=true;let t=e.open(s.url,s.data);r.systems.script.preloading=false,r.loader.clearCache(s.url,"hierarchy"),r.root.addChild(t),r.systems.fire("initialize",t),r.systems.fire("postInitialize",t),r.systems.fire("postPostInitialize",t),i&&i(null,t);});});}loadSceneHierarchy(e,t){this._loadSceneHierarchy(e,null,t);}loadSceneSettings(e,t){this._loadSceneData(e,false,(e,i)=>{e?t&&t(e):(this._app.applySceneSettings(i.data.settings),t&&t(null));});}changeScene(e,t){let i=this._app;this._loadSceneHierarchy(e,e=>{let{children:t}=i.root;for(;t.length;)t[0].destroy();i.applySceneSettings(e.data.settings);},t);}loadScene(e,t){let i=this._app,s=i.loader.getHandler("scene");i.assets&&i.assets.prefix&&!fm.test(e)&&(e=P.join(i.assets.prefix,e)),s.load(e,(r,a)=>{if(r)t&&t(r);else {let r=()=>{i.systems.script.preloading=true;let r=s.open(e,a),n=this.findByUrl(e);n&&!n.loaded&&(n.data=a),i.systems.script.preloading=false,i.loader.clearCache(e,"scene"),i.loader.patch({resource:r,type:"scene"},i.assets),i.root.addChild(r.root),i.systems.rigidbody&&"undefined"!=typeof Ammo&&i.systems.rigidbody.gravity.set(r._gravity.x,r._gravity.y,r._gravity.z),t&&t(null,r);};i._preloadScripts(a,r);}});}constructor(e){this._list=[],this._index={},this._urlIndex={},this._app=e;}}class fz{get scene(){return r.scene._stats}get lightmapper(){return r.lightmapper?.stats}get batcher(){let e=r._batcher;return e?e._stats:null}frameEnd(){this.frame.gsplatSort=0;}constructor(e){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,scriptUpdateStart:0,scriptUpdate:0,scriptPostUpdateStart:0,scriptPostUpdate:0,animUpdateStart:0,animUpdate:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,gsplats:0,gsplatSort:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=e._shaderStats,this.vram=e._vram,this.gpu=e.gpuProfiler?.passTimings??new Map,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}});}}let fV={alphaTestPS:`
uniform float alpha_ref;
void alphaTest(float a) {
	if (a < alpha_ref) discard;
}
`,ambientPS:`
#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH
	uniform vec3 ambientSH[9];
#endif
#if LIT_AMBIENT_SOURCE == ENVALATLAS
	#include "envAtlasPS"
	#ifndef ENV_ATLAS
	#define ENV_ATLAS
		uniform sampler2D texture_envAtlas;
	#endif
#endif
void addAmbient(vec3 worldNormal) {
	#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH
		vec3 n = cubeMapRotate(worldNormal);
		vec3 color =
			ambientSH[0] +
			ambientSH[1] * n.x +
			ambientSH[2] * n.y +
			ambientSH[3] * n.z +
			ambientSH[4] * n.x * n.z +
			ambientSH[5] * n.z * n.y +
			ambientSH[6] * n.y * n.x +
			ambientSH[7] * (3.0 * n.z * n.z - 1.0) +
			ambientSH[8] * (n.x * n.x - n.y * n.y);
		dDiffuseLight += processEnvironment(max(color, vec3(0.0)));
	#endif
	#if LIT_AMBIENT_SOURCE == ENVALATLAS
		vec3 dir = normalize(cubeMapRotate(worldNormal) * vec3(-1.0, 1.0, 1.0));
		vec2 uv = mapUv(toSphericalUv(dir), vec4(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);
		vec4 raw = texture2D(texture_envAtlas, uv);
		vec3 linear = {ambientDecode}(raw);
		dDiffuseLight += processEnvironment(linear);
	#endif
	#if LIT_AMBIENT_SOURCE == CONSTANT
		dDiffuseLight += light_globalAmbient;
	#endif
}
`,anisotropyPS:`
#ifdef LIT_GGX_SPECULAR
	uniform float material_anisotropyIntensity;
	uniform vec2 material_anisotropyRotation;
#endif
void getAnisotropy() {
	dAnisotropy = 0.0;
	dAnisotropyRotation = vec2(1.0, 0.0);
#ifdef LIT_GGX_SPECULAR
	dAnisotropy = material_anisotropyIntensity;
	dAnisotropyRotation = material_anisotropyRotation;
#endif
	#ifdef STD_ANISOTROPY_TEXTURE
	vec3 anisotropyTex = texture2DBias({STD_ANISOTROPY_TEXTURE_NAME}, {STD_ANISOTROPY_TEXTURE_UV}, textureBias).rgb;
	dAnisotropy *= anisotropyTex.b;
	vec2 anisotropyRotationFromTex = anisotropyTex.rg * 2.0 - vec2(1.0);
	mat2 rotationMatrix = mat2(dAnisotropyRotation.x, dAnisotropyRotation.y, -dAnisotropyRotation.y, dAnisotropyRotation.x);
	dAnisotropyRotation = rotationMatrix * anisotropyRotationFromTex;
	#endif
	
	dAnisotropy = clamp(dAnisotropy, 0.0, 1.0);
}
`,aoPS:`
#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)
	uniform float material_aoIntensity;
#endif
#ifdef STD_AODETAIL_TEXTURE
	#include "detailModesPS"
#endif
void getAO() {
	dAo = 1.0;
	#ifdef STD_AO_TEXTURE
		float aoBase = texture2DBias({STD_AO_TEXTURE_NAME}, {STD_AO_TEXTURE_UV}, textureBias).{STD_AO_TEXTURE_CHANNEL};
		#ifdef STD_AODETAIL_TEXTURE
			float aoDetail = texture2DBias({STD_AODETAIL_TEXTURE_NAME}, {STD_AODETAIL_TEXTURE_UV}, textureBias).{STD_AODETAIL_TEXTURE_CHANNEL};
			aoBase = detailMode_{STD_AODETAIL_DETAILMODE}(vec3(aoBase), vec3(aoDetail)).r;
		#endif
		dAo *= aoBase;
	#endif
	#ifdef STD_AO_VERTEX
		dAo *= saturate(vVertexColor.{STD_AO_VERTEX_CHANNEL});
	#endif
	#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)
		dAo = mix(1.0, dAo, material_aoIntensity);
	#endif
}
`,aoDiffuseOccPS:`
void occludeDiffuse(float ao) {
	dDiffuseLight *= ao;
}
`,aoSpecOccPS:`
#if LIT_OCCLUDE_SPECULAR != NONE
	#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
		uniform float material_occludeSpecularIntensity;
	#endif
#endif
void occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {
	#if LIT_OCCLUDE_SPECULAR == AO
		#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
			float specOcc = mix(1.0, ao, material_occludeSpecularIntensity);
		#else
			float specOcc = ao;
		#endif
	#endif
	#if LIT_OCCLUDE_SPECULAR == GLOSSDEPENDENT
		float specPow = exp2(gloss * 11.0);
		float specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01 * specPow) - 1.0 + ao);
		#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
			specOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);
		#endif
	#endif
	#if LIT_OCCLUDE_SPECULAR != NONE
		dSpecularLight *= specOcc;
		dReflection *= specOcc;
		#ifdef LIT_SHEEN
			sSpecularLight *= specOcc;
			sReflection *= specOcc;
		#endif
	#endif
}
`,bakeDirLmEndPS:`
	vec4 dirLm = texture2D(texture_dirLightMap, vUv1);
	if (bakeDir > 0.5) {
		if (dAtten > 0.00001) {
			dirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);
			dAtten = saturate(dAtten);
			gl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);
			gl_FragColor.a = dirLm.w + dAtten;
			gl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);
		} else {
			gl_FragColor = dirLm;
		}
	} else {
		gl_FragColor.rgb = dirLm.xyz;
		gl_FragColor.a = max(dirLm.w, dAtten > 0.00001 ? (1.0/255.0) : 0.0);
	}
`,bakeLmEndPS:`
#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT
	dDiffuseLight = ((dDiffuseLight - 0.5) * max(ambientBakeOcclusionContrast + 1.0, 0.0)) + 0.5;
	dDiffuseLight += vec3(ambientBakeOcclusionBrightness);
	dDiffuseLight = saturate(dDiffuseLight);
	dDiffuseLight *= dAmbientLight;
#endif
#ifdef LIGHTMAP_RGBM
	gl_FragColor.rgb = dDiffuseLight;
	gl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));
	gl_FragColor.rgb /= 8.0;
	gl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );
	gl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;
	gl_FragColor.rgb /= gl_FragColor.a;
#else
	gl_FragColor = vec4(dDiffuseLight, 1.0);
#endif
`,basePS:`
uniform vec3 view_position;
uniform vec3 light_globalAmbient;
float square(float x) {
	return x*x;
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec3 saturate(vec3 x) {
	return clamp(x, vec3(0.0), vec3(1.0));
}
`,baseNineSlicedPS:`
#define NINESLICED
varying vec2 vMask;
varying vec2 vTiledUv;
uniform mediump vec4 innerOffset;
uniform mediump vec2 outerScale;
uniform mediump vec4 atlasRect;
vec2 nineSlicedUv;
`,baseNineSlicedTiledPS:`
#define NINESLICED
#define NINESLICETILED
varying vec2 vMask;
varying vec2 vTiledUv;
uniform mediump vec4 innerOffset;
uniform mediump vec2 outerScale;
uniform mediump vec4 atlasRect;
vec2 nineSlicedUv;
`,bayerPS:`
float bayer2(vec2 p) {
	return mod(2.0 * p.y + p.x + 1.0, 4.0);
}
float bayer4(vec2 p) {
	vec2 p1 = mod(p, 2.0);
	vec2 p2 = floor(0.5 * mod(p, 4.0));
	return 4.0 * bayer2(p1) + bayer2(p2);
}
float bayer8(vec2 p) {
	vec2 p1 = mod(p, 2.0);
	vec2 p2 = floor(0.5 * mod(p, 4.0));
	vec2 p4 = floor(0.25 * mod(p, 8.0));
	return 4.0 * (4.0 * bayer2(p1) + bayer2(p2)) + bayer2(p4);
}
`,blurVSMPS:`
varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
#ifdef GAUSS
	uniform float weight[{SAMPLES}];
#endif
void main(void) {
	vec3 moments = vec3(0.0);
	vec2 uv = vUv0 - pixelOffset * (float({SAMPLES}) * 0.5);
	for (int i = 0; i < {SAMPLES}; i++) {
		vec4 c = texture2D(source, uv + pixelOffset * float(i));
		#ifdef GAUSS
			moments += c.xyz * weight[i];
		#else
			moments += c.xyz;
		#endif
	}
	#ifndef GAUSS
		moments *= 1.0 / float({SAMPLES});
	#endif
	gl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);
}
`,clearCoatPS:`
uniform float material_clearCoat;
void getClearCoat() {
	ccSpecularity = material_clearCoat;
	#ifdef STD_CLEARCOAT_TEXTURE
	ccSpecularity *= texture2DBias({STD_CLEARCOAT_TEXTURE_NAME}, {STD_CLEARCOAT_TEXTURE_UV}, textureBias).{STD_CLEARCOAT_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_CLEARCOAT_VERTEX
	ccSpecularity *= saturate(vVertexColor.{STD_CLEARCOAT_VERTEX_CHANNEL});
	#endif
}
`,clearCoatGlossPS:`
uniform float material_clearCoatGloss;
void getClearCoatGlossiness() {
	ccGlossiness = material_clearCoatGloss;
	#ifdef STD_CLEARCOATGLOSS_TEXTURE
	ccGlossiness *= texture2DBias({STD_CLEARCOATGLOSS_TEXTURE_NAME}, {STD_CLEARCOATGLOSS_TEXTURE_UV}, textureBias).{STD_CLEARCOATGLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_CLEARCOATGLOSS_VERTEX
	ccGlossiness *= saturate(vVertexColor.{STD_CLEARCOATGLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_CLEARCOATGLOSS_INVERT
	ccGlossiness = 1.0 - ccGlossiness;
	#endif
	ccGlossiness += 0.0000001;
}
`,clearCoatNormalPS:`
#ifdef STD_CLEARCOATNORMAL_TEXTURE
uniform float material_clearCoatBumpiness;
#endif
void getClearCoatNormal() {
#ifdef STD_CLEARCOATNORMAL_TEXTURE
	vec3 normalMap = {STD_CLEARCOATNORMAL_TEXTURE_DECODE}(texture2DBias({STD_CLEARCOATNORMAL_TEXTURE_NAME}, {STD_CLEARCOATNORMAL_TEXTURE_UV}, textureBias));
	normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness);
	ccNormalW = normalize(dTBN * normalMap);
#else
	ccNormalW = dVertexNormalW;
#endif
}
`,clusteredLightCookiesPS:`
vec3 _getCookieClustered(TEXTURE_ACCEPT(tex), vec2 uv, float intensity, vec4 cookieChannel) {
	vec4 pixel = mix(vec4(1.0), texture2DLod(tex, uv, 0.0), intensity);
	bool isRgb = dot(cookieChannel.rgb, vec3(1.0)) == 3.0;
	return isRgb ? pixel.rgb : vec3(dot(pixel, cookieChannel));
}
vec3 getCookie2DClustered(TEXTURE_ACCEPT(tex), mat4 transform, vec3 worldPosition, float intensity, vec4 cookieChannel) {
	vec4 projPos = transform * vec4(worldPosition, 1.0);
	return _getCookieClustered(TEXTURE_PASS(tex), projPos.xy / projPos.w, intensity, cookieChannel);
}
vec3 getCookieCubeClustered(TEXTURE_ACCEPT(tex), vec3 dir, float intensity, vec4 cookieChannel, float shadowTextureResolution, float shadowEdgePixels, vec3 omniAtlasViewport) {
	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);
	return _getCookieClustered(TEXTURE_PASS(tex), uv, intensity, cookieChannel);
}
`,clusteredLightShadowsPS:`
vec3 _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {
	vec4 projPos = shadowMatrix * vec4(wPos, 1.0);
	projPos.xyz /= projPos.w;
	return projPos.xyz;
}
vec3 getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams, vec3 normal) {
	vec3 wPos = vPositionW + normal * shadowParams.y;
	return _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);
}
vec3 normalOffsetPointShadow(vec4 shadowParams, vec3 lightPos, vec3 lightDir, vec3 lightDirNorm, vec3 normal) {
	float distScale = length(lightDir);
	vec3 wPos = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
	vec3 dir = wPos - lightPos;
	return dir;
}
#if defined(CLUSTER_SHADOW_TYPE_PCF1)
float getShadowOmniClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
	float shadowTextureResolution = shadowParams.x;
	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
	return textureShadow(shadowMap, vec3(uv, shadowZ));
}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF3)
float getShadowOmniClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
	float shadowTextureResolution = shadowParams.x;
	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
	vec3 shadowCoord = vec3(uv, shadowZ);
	return getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF5)
float getShadowOmniClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {
	float shadowTextureResolution = shadowParams.x;
	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
	vec3 shadowCoord = vec3(uv, shadowZ);
	return getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF1)
float getShadowSpotClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return textureShadow(shadowMap, shadowCoord);
}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF3)
float getShadowSpotClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return getShadowSpotPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF5)
float getShadowSpotClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);
}
#endif
`,clusteredLightUtilsPS:`
vec2 getCubemapFaceCoordinates(const vec3 dir, out float faceIndex, out vec2 tileOffset)
{
	vec3 vAbs = abs(dir);
	float ma;
	vec2 uv;
	if (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {
		faceIndex = dir.z < 0.0 ? 5.0 : 4.0;
		ma = 0.5 / vAbs.z;
		uv = vec2(dir.z < 0.0 ? -dir.x : dir.x, -dir.y);
		tileOffset.x = 2.0;
		tileOffset.y = dir.z < 0.0 ? 1.0 : 0.0;
	} else if(vAbs.y >= vAbs.x) {
		faceIndex = dir.y < 0.0 ? 3.0 : 2.0;
		ma = 0.5 / vAbs.y;
		uv = vec2(dir.x, dir.y < 0.0 ? -dir.z : dir.z);
		tileOffset.x = 1.0;
		tileOffset.y = dir.y < 0.0 ? 1.0 : 0.0;
	} else {
		faceIndex = dir.x < 0.0 ? 1.0 : 0.0;
		ma = 0.5 / vAbs.x;
		uv = vec2(dir.x < 0.0 ? dir.z : -dir.z, -dir.y);
		tileOffset.x = 0.0;
		tileOffset.y = dir.x < 0.0 ? 1.0 : 0.0;
	}
	return uv * ma + 0.5;
}
vec2 getCubemapAtlasCoordinates(const vec3 omniAtlasViewport, float shadowEdgePixels, float shadowTextureResolution, const vec3 dir) {
	float faceIndex;
	vec2 tileOffset;
	vec2 uv = getCubemapFaceCoordinates(dir, faceIndex, tileOffset);
	float atlasFaceSize = omniAtlasViewport.z;
	float tileSize = shadowTextureResolution * atlasFaceSize;
	float offset = shadowEdgePixels / tileSize;
	uv = uv * vec2(1.0 - offset * 2.0) + vec2(offset * 1.0);
	uv *= atlasFaceSize;
	uv += tileOffset * atlasFaceSize;
	uv += omniAtlasViewport.xy;
	return uv;
}
`,clusteredLightPS:`
#include "lightBufferDefinesPS"
#include "clusteredLightUtilsPS"
#ifdef CLUSTER_COOKIES
	#include "clusteredLightCookiesPS"
#endif
#ifdef CLUSTER_SHADOWS
	#include "clusteredLightShadowsPS"
#endif
uniform highp usampler2D clusterWorldTexture;
uniform highp sampler2D lightsTexture;
#ifdef CLUSTER_SHADOWS
	uniform sampler2DShadow shadowAtlasTexture;
#endif
#ifdef CLUSTER_COOKIES
	uniform sampler2D cookieAtlasTexture;
#endif
uniform int clusterMaxCells;
uniform int numClusteredLights;
uniform int clusterTextureWidth;
uniform vec3 clusterCellsCountByBoundsSize;
uniform vec3 clusterBoundsMin;
uniform vec3 clusterBoundsDelta;
uniform ivec3 clusterCellsDot;
uniform ivec3 clusterCellsMax;
uniform vec2 shadowAtlasParams;
struct ClusterLightData {
	uint flags;
	vec3 halfWidth;
	bool isSpot;
	vec3 halfHeight;
	int lightIndex;
	vec3 position;
	uint shape;
	vec3 direction;
	bool falloffModeLinear;
	vec3 color;
	float shadowIntensity;
	vec3 omniAtlasViewport;
	float range;
	vec4 cookieChannelMask;
	float biasesData;
	uint colorBFlagsData;
	float shadowBias;
	float shadowNormalBias;
	float anglesData;
	float innerConeAngleCos;
	float outerConeAngleCos;
	float cookieIntensity;
	bool isDynamic;
	bool isLightmapped;
};
mat4 lightProjectionMatrix;
vec4 sampleLightTextureF(const ClusterLightData clusterLightData, int index) {
	return texelFetch(lightsTexture, ivec2(index, clusterLightData.lightIndex), 0);
}
void decodeClusterLightCore(inout ClusterLightData clusterLightData, int lightIndex) {
	clusterLightData.lightIndex = lightIndex;
	vec4 halfData = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_COLOR_ANGLES_BIAS});
	clusterLightData.anglesData = halfData.z;
	clusterLightData.biasesData = halfData.w;
	clusterLightData.colorBFlagsData = floatBitsToUint(halfData.y);
	vec2 colorRG = unpackHalf2x16(floatBitsToUint(halfData.x));
	vec2 colorB_flags = unpackHalf2x16(clusterLightData.colorBFlagsData);
	clusterLightData.color = vec3(colorRG, colorB_flags.x) * {LIGHT_COLOR_DIVIDER};
	vec4 lightPosRange = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_POSITION_RANGE});
	clusterLightData.position = lightPosRange.xyz;
	clusterLightData.range = lightPosRange.w;
	vec4 lightDir_Flags = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_DIRECTION_FLAGS});
	clusterLightData.direction = lightDir_Flags.xyz;
	clusterLightData.flags = floatBitsToUint(lightDir_Flags.w);
	clusterLightData.isSpot = (clusterLightData.flags & (1u << 30u)) != 0u;
	clusterLightData.shape = (clusterLightData.flags >> 28u) & 0x3u;
	clusterLightData.falloffModeLinear = (clusterLightData.flags & (1u << 27u)) == 0u;
	clusterLightData.shadowIntensity = float((clusterLightData.flags >> 0u) & 0xFFu) / 255.0;
	clusterLightData.cookieIntensity = float((clusterLightData.flags >> 8u) & 0xFFu) / 255.0;
	clusterLightData.isDynamic = (clusterLightData.flags & (1u << 22u)) != 0u;
	clusterLightData.isLightmapped = (clusterLightData.flags & (1u << 21u)) != 0u;
}
void decodeClusterLightSpot(inout ClusterLightData clusterLightData) {
	uint angleFlags = (clusterLightData.colorBFlagsData >> 16u) & 0xFFFFu;
	vec2 angleValues = unpackHalf2x16(floatBitsToUint(clusterLightData.anglesData));
	float innerVal = angleValues.x;
	float outerVal = angleValues.y;
	float innerIsVersine = float(angleFlags & 1u);
	float outerIsVersine = float((angleFlags >> 1u) & 1u);
	clusterLightData.innerConeAngleCos = mix(innerVal, 1.0 - innerVal, innerIsVersine);
	clusterLightData.outerConeAngleCos = mix(outerVal, 1.0 - outerVal, outerIsVersine);
}
void decodeClusterLightOmniAtlasViewport(inout ClusterLightData clusterLightData) {
	clusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_0}).xyz;
}
void decodeClusterLightAreaData(inout ClusterLightData clusterLightData) {
	clusterLightData.halfWidth = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_AREA_DATA_WIDTH}).xyz;
	clusterLightData.halfHeight = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_AREA_DATA_HEIGHT}).xyz;
}
void decodeClusterLightProjectionMatrixData(inout ClusterLightData clusterLightData) {
	
	vec4 m0 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_0});
	vec4 m1 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_1});
	vec4 m2 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_2});
	vec4 m3 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_3});
	lightProjectionMatrix = mat4(m0, m1, m2, m3);
}
void decodeClusterLightShadowData(inout ClusterLightData clusterLightData) {
	
	vec2 biases = unpackHalf2x16(floatBitsToUint(clusterLightData.biasesData));
	clusterLightData.shadowBias = biases.x;
	clusterLightData.shadowNormalBias = biases.y;
}
void decodeClusterLightCookieData(inout ClusterLightData clusterLightData) {
	uint cookieFlags = (clusterLightData.flags >> 23u) & 0x0Fu;
	clusterLightData.cookieChannelMask = vec4(uvec4(cookieFlags) & uvec4(1u, 2u, 4u, 8u));
	clusterLightData.cookieChannelMask = step(1.0, clusterLightData.cookieChannelMask);
}
void evaluateLight(
	ClusterLightData light, 
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir,
#if defined(LIT_CLEARCOAT)
	vec3 clearcoatReflectionDir,
#endif
	float gloss, 
	vec3 specularity, 
	vec3 geometricNormal, 
	mat3 tbn, 
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel,
#endif
	vec3 clearcoat_worldNormal,
	float clearcoat_gloss,
	float sheen_gloss,
	float iridescence_intensity
) {
	vec3 cookieAttenuation = vec3(1.0);
	float diffuseAttenuation = 1.0;
	float falloffAttenuation = 1.0;
	vec3 lightDirW = evalOmniLight(light.position);
	vec3 lightDirNormW = normalize(lightDirW);
	#ifdef CLUSTER_AREALIGHTS
	if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
		decodeClusterLightAreaData(light);
		if (light.shape == {LIGHTSHAPE_RECT}) {
			calcRectLightValues(light.position, light.halfWidth, light.halfHeight);
		} else if (light.shape == {LIGHTSHAPE_DISK}) {
			calcDiskLightValues(light.position, light.halfWidth, light.halfHeight);
		} else {
			calcSphereLightValues(light.position, light.halfWidth, light.halfHeight);
		}
		falloffAttenuation = getFalloffWindow(light.range, lightDirW);
	} else
	#endif
	{
		if (light.falloffModeLinear)
			falloffAttenuation = getFalloffLinear(light.range, lightDirW);
		else
			falloffAttenuation = getFalloffInvSquared(light.range, lightDirW);
	}
	if (falloffAttenuation > 0.00001) {
		#ifdef CLUSTER_AREALIGHTS
		if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
			if (light.shape == {LIGHTSHAPE_RECT}) {
				diffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			} else if (light.shape == {LIGHTSHAPE_DISK}) {
				diffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			} else {
				diffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			}
		} else
		#endif
		{
			falloffAttenuation *= getLightDiffuse(worldNormal, viewDir, lightDirNormW); 
		}
		if (light.isSpot) {
			decodeClusterLightSpot(light);
			falloffAttenuation *= getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, lightDirNormW);
		}
		#if defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)
		if (falloffAttenuation > 0.00001) {
			if (light.shadowIntensity > 0.0 || light.cookieIntensity > 0.0) {
				if (light.isSpot) {
					decodeClusterLightProjectionMatrixData(light);
				} else {
					decodeClusterLightOmniAtlasViewport(light);
				}
				float shadowTextureResolution = shadowAtlasParams.x;
				float shadowEdgePixels = shadowAtlasParams.y;
				#ifdef CLUSTER_COOKIES
				if (light.cookieIntensity > 0.0) {
					decodeClusterLightCookieData(light);
					if (light.isSpot) {
						cookieAttenuation = getCookie2DClustered(TEXTURE_PASS(cookieAtlasTexture), lightProjectionMatrix, vPositionW, light.cookieIntensity, light.cookieChannelMask);
					} else {
						cookieAttenuation = getCookieCubeClustered(TEXTURE_PASS(cookieAtlasTexture), lightDirW, light.cookieIntensity, light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);
					}
				}
				#endif
				#ifdef CLUSTER_SHADOWS
				if (light.shadowIntensity > 0.0) {
					decodeClusterLightShadowData(light);
					vec4 shadowParams = vec4(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);
					if (light.isSpot) {
						vec3 shadowCoord = getShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);
						
						#if defined(CLUSTER_SHADOW_TYPE_PCF1)
							float shadow = getShadowSpotClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)
							float shadow = getShadowSpotClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)
							float shadow = getShadowSpotClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCSS)
							float shadow = getShadowSpotClusteredPCSS(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);
						#endif
						falloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);
					} else {
						vec3 dir = normalOffsetPointShadow(shadowParams, light.position, lightDirW, lightDirNormW, geometricNormal);
						#if defined(CLUSTER_SHADOW_TYPE_PCF1)
							float shadow = getShadowOmniClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)
							float shadow = getShadowOmniClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)
							float shadow = getShadowOmniClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#endif
						falloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);
					}
				}
				#endif
			}
		}
		#endif
		#ifdef CLUSTER_AREALIGHTS
		if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
			{
				vec3 areaDiffuse = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;
				#if defined(LIT_SPECULAR)
					areaDiffuse = mix(areaDiffuse, vec3(0), dLTCSpecFres);
				#endif
				dDiffuseLight += areaDiffuse;
			}
			#ifdef LIT_SPECULAR
				float areaLightSpecular;
				if (light.shape == {LIGHTSHAPE_RECT}) {
					areaLightSpecular = getRectLightSpecular(worldNormal, viewDir);
				} else if (light.shape == {LIGHTSHAPE_DISK}) {
					areaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);
				} else {
					areaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);
				}
				dSpecularLight += dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;
				#ifdef LIT_CLEARCOAT
					float areaLightSpecularCC;
					if (light.shape == {LIGHTSHAPE_RECT}) {
						areaLightSpecularCC = getRectLightSpecular(clearcoat_worldNormal, viewDir);
					} else if (light.shape == {LIGHTSHAPE_DISK}) {
						areaLightSpecularCC = getDiskLightSpecular(clearcoat_worldNormal, viewDir);
					} else {
						areaLightSpecularCC = getSphereLightSpecular(clearcoat_worldNormal, viewDir);
					}
					ccSpecularLight += ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;
				#endif
			#endif
		} else
		#endif
		{
			{
				vec3 punctualDiffuse = falloffAttenuation * light.color * cookieAttenuation;
				#if defined(CLUSTER_AREALIGHTS)
				#if defined(LIT_SPECULAR)
					punctualDiffuse = mix(punctualDiffuse, vec3(0), specularity);
				#endif
				#endif
				dDiffuseLight += punctualDiffuse;
			}
	 
			#ifdef LIT_SPECULAR
				vec3 halfDir = normalize(-lightDirNormW + viewDir);
				
				#ifdef LIT_SPECULAR_FRESNEL
					dSpecularLight += 
						getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * 
						getFresnel(
							dot(viewDir, halfDir), 
							gloss, 
							specularity
						#if defined(LIT_IRIDESCENCE)
							, iridescenceFresnel,
							iridescence_intensity
						#endif
							);
				#else
					dSpecularLight += getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;
				#endif
				#ifdef LIT_CLEARCOAT
					#ifdef LIT_SPECULAR_FRESNEL
						ccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));
					#else
						ccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation; 
					#endif
				#endif
				#ifdef LIT_SHEEN
					sSpecularLight += getLightSpecularSheen(halfDir, worldNormal, viewDir, lightDirNormW, sheen_gloss) * falloffAttenuation * light.color * cookieAttenuation;
				#endif
			#endif
		}
	}
	dAtten = falloffAttenuation;
	dLightDirNormW = lightDirNormW;
}
void evaluateClusterLight(
	int lightIndex, 
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir, 
#if defined(LIT_CLEARCOAT)
	vec3 clearcoatReflectionDir,
#endif
	float gloss, 
	vec3 specularity, 
	vec3 geometricNormal, 
	mat3 tbn, 
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel,
#endif
	vec3 clearcoat_worldNormal,
	float clearcoat_gloss,
	float sheen_gloss,
	float iridescence_intensity
) {
	ClusterLightData clusterLightData;
	decodeClusterLightCore(clusterLightData, lightIndex);
	#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS
		bool acceptLightMask = clusterLightData.isDynamic;
	#else
		bool acceptLightMask = clusterLightData.isLightmapped;
	#endif
	if (acceptLightMask)
		evaluateLight(
			clusterLightData, 
			worldNormal, 
			viewDir, 
			reflectionDir, 
#if defined(LIT_CLEARCOAT)
			clearcoatReflectionDir, 
#endif
			gloss, 
			specularity, 
			geometricNormal, 
			tbn, 
#if defined(LIT_IRIDESCENCE)
			iridescenceFresnel,
#endif
			clearcoat_worldNormal,
			clearcoat_gloss,
			sheen_gloss,
			iridescence_intensity
		);
}
void addClusteredLights(
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir, 
#if defined(LIT_CLEARCOAT)
	vec3 clearcoatReflectionDir,
#endif
	float gloss, 
	vec3 specularity, 
	vec3 geometricNormal, 
	mat3 tbn, 
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel,
#endif
	vec3 clearcoat_worldNormal,
	float clearcoat_gloss,
	float sheen_gloss,
	float iridescence_intensity
) {
	if (numClusteredLights <= 1)
		return;
	ivec3 cellCoords = ivec3(floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize));
	if (!(any(lessThan(cellCoords, ivec3(0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {
		int cellIndex = cellCoords.x * clusterCellsDot.x + cellCoords.y * clusterCellsDot.y + cellCoords.z * clusterCellsDot.z;
		int clusterV = cellIndex / clusterTextureWidth;
		int clusterU = cellIndex - clusterV * clusterTextureWidth;
		for (int lightCellIndex = 0; lightCellIndex < clusterMaxCells; lightCellIndex++) {
			uint lightIndex = texelFetch(clusterWorldTexture, ivec2(clusterU + lightCellIndex, clusterV), 0).x;
			if (lightIndex == 0u)
				break;
			evaluateClusterLight(
				int(lightIndex), 
				worldNormal, 
				viewDir, 
				reflectionDir,
#if defined(LIT_CLEARCOAT)
				clearcoatReflectionDir,
#endif
				gloss, 
				specularity, 
				geometricNormal, 
				tbn, 
#if defined(LIT_IRIDESCENCE)
				iridescenceFresnel,
#endif
				clearcoat_worldNormal,
				clearcoat_gloss,
				sheen_gloss,
				iridescence_intensity
			); 
		}
	}
}
`,combinePS:`
vec3 combineColor(vec3 albedo, vec3 sheenSpecularity, float clearcoatSpecularity) {
	vec3 ret = vec3(0);
#ifdef LIT_OLD_AMBIENT
	ret += (dDiffuseLight - light_globalAmbient) * albedo + material_ambient * light_globalAmbient;
#else
	ret += albedo * dDiffuseLight;
#endif
#ifdef LIT_SPECULAR
	ret += dSpecularLight;
#endif
#ifdef LIT_REFLECTIONS
	ret += dReflection.rgb * dReflection.a;
#endif
#ifdef LIT_SHEEN
	float sheenScaling = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;
	ret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;
#endif
#ifdef LIT_CLEARCOAT
	float clearCoatScaling = 1.0 - ccFresnel * clearcoatSpecularity;
	ret = ret * clearCoatScaling + (ccSpecularLight + ccReflection) * clearcoatSpecularity;
#endif
	return ret;
}
`,cookieBlit2DPS:`
	varying vec2 uv0;
	uniform sampler2D blitTexture;
	void main(void) {
		gl_FragColor = texture2D(blitTexture, uv0);
	}
`,cookieBlitCubePS:`
	varying vec2 uv0;
	uniform samplerCube blitTexture;
	uniform mat4 invViewProj;
	void main(void) {
		vec4 projPos = vec4(uv0 * 2.0 - 1.0, 0.5, 1.0);
		vec4 worldPos = invViewProj * projPos;
		gl_FragColor = textureCube(blitTexture, worldPos.xyz);
	}
`,cookieBlitVS:`
	attribute vec2 vertex_position;
	varying vec2 uv0;
	void main(void) {
		gl_Position = vec4(vertex_position, 0.5, 1.0);
		uv0 = vertex_position.xy * 0.5 + 0.5;
		#ifndef WEBGPU
			uv0.y = 1.0 - uv0.y;
		#endif
	}
`,cookiePS:`
vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);
}
vec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);
	return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);
}
vec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	projPos.xy += cookieOffset;
	vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);
	return mix(vec4(1.0), texture2D(tex, uv), intensity);
}
vec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	projPos.xy += cookieOffset;
	if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);
	vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);
	return mix(vec4(1.0), texture2D(tex, uv), intensity);
}
vec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {
	return mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);
}
`,cubeMapProjectPS:`
#if LIT_CUBEMAP_PROJECTION == BOX
	uniform vec3 envBoxMin;
	uniform vec3 envBoxMax;
#endif
vec3 cubeMapProject(vec3 nrdir) {
	#if LIT_CUBEMAP_PROJECTION == NONE
		return cubeMapRotate(nrdir);
	#endif
	#if LIT_CUBEMAP_PROJECTION == BOX
		nrdir = cubeMapRotate(nrdir);
		vec3 rbmax = (envBoxMax - vPositionW) / nrdir;
		vec3 rbmin = (envBoxMin - vPositionW) / nrdir;
		vec3 rbminmax = mix(rbmin, rbmax, vec3(greaterThan(nrdir, vec3(0.0))));
		float fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);
		vec3 posonbox = vPositionW + nrdir * fa;
		vec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;
		return normalize(posonbox - envBoxPos);
	#endif
}
`,cubeMapRotatePS:`
#ifdef CUBEMAP_ROTATION
uniform mat3 cubeMapRotationMatrix;
#endif
vec3 cubeMapRotate(vec3 refDir) {
#ifdef CUBEMAP_ROTATION
	return refDir * cubeMapRotationMatrix;
#else
	return refDir;
#endif
}
`,debugOutputPS:`
#ifdef DEBUG_ALBEDO_PASS
gl_FragColor = vec4(gammaCorrectOutput(dAlbedo), 1.0);
#endif
#ifdef DEBUG_UV0_PASS
gl_FragColor = vec4(litArgs_albedo , 1.0);
#endif
#ifdef DEBUG_WORLD_NORMAL_PASS
gl_FragColor = vec4(litArgs_worldNormal * 0.5 + 0.5, 1.0);
#endif
#ifdef DEBUG_OPACITY_PASS
gl_FragColor = vec4(vec3(litArgs_opacity) , 1.0);
#endif
#ifdef DEBUG_SPECULARITY_PASS
gl_FragColor = vec4(litArgs_specularity, 1.0);
#endif
#ifdef DEBUG_GLOSS_PASS
gl_FragColor = vec4(vec3(litArgs_gloss) , 1.0);
#endif
#ifdef DEBUG_METALNESS_PASS
gl_FragColor = vec4(vec3(litArgs_metalness) , 1.0);
#endif
#ifdef DEBUG_AO_PASS
gl_FragColor = vec4(vec3(litArgs_ao) , 1.0);
#endif
#ifdef DEBUG_EMISSION_PASS
gl_FragColor = vec4(gammaCorrectOutput(litArgs_emission), 1.0);
#endif
`,debugProcessFrontendPS:`
#ifdef DEBUG_LIGHTING_PASS
litArgs_albedo = vec3(0.5);
#endif
#ifdef DEBUG_UV0_PASS
#ifdef VARYING_VUV0
litArgs_albedo = vec3(vUv0, 0);
#else
litArgs_albedo = vec3(0);
#endif
#endif
`,detailModesPS:`
#ifndef _DETAILMODES_INCLUDED_
#define _DETAILMODES_INCLUDED_
vec3 detailMode_mul(vec3 c1, vec3 c2) {
	return c1 * c2;
}
vec3 detailMode_add(vec3 c1, vec3 c2) {
	return c1 + c2;
}
vec3 detailMode_screen(vec3 c1, vec3 c2) {
	return 1.0 - (1.0 - c1)*(1.0 - c2);
}
vec3 detailMode_overlay(vec3 c1, vec3 c2) {
	return mix(1.0 - 2.0 * (1.0 - c1)*(1.0 - c2), 2.0 * c1 * c2, step(c1, vec3(0.5)));
}
vec3 detailMode_min(vec3 c1, vec3 c2) {
	return min(c1, c2);
}
vec3 detailMode_max(vec3 c1, vec3 c2) {
	return max(c1, c2);
}
#endif
`,diffusePS:`
uniform vec3 material_diffuse;
#ifdef STD_DIFFUSEDETAIL_TEXTURE
	#include "detailModesPS"
#endif
void getAlbedo() {
	dAlbedo = material_diffuse.rgb;
	#ifdef STD_DIFFUSE_TEXTURE
		vec3 albedoTexture = {STD_DIFFUSE_TEXTURE_DECODE}(texture2DBias({STD_DIFFUSE_TEXTURE_NAME}, {STD_DIFFUSE_TEXTURE_UV}, textureBias)).{STD_DIFFUSE_TEXTURE_CHANNEL};
		#ifdef STD_DIFFUSEDETAIL_TEXTURE
			vec3 albedoDetail = {STD_DIFFUSEDETAIL_TEXTURE_DECODE}(texture2DBias({STD_DIFFUSEDETAIL_TEXTURE_NAME}, {STD_DIFFUSEDETAIL_TEXTURE_UV}, textureBias)).{STD_DIFFUSEDETAIL_TEXTURE_CHANNEL};
			albedoTexture = detailMode_{STD_DIFFUSEDETAIL_DETAILMODE}(albedoTexture, albedoDetail);
		#endif
		dAlbedo *= albedoTexture;
	#endif
	#ifdef STD_DIFFUSE_VERTEX
		dAlbedo *= saturate(vVertexColor.{STD_DIFFUSE_VERTEX_CHANNEL});
	#endif
}
`,decodePS:`
#ifndef _DECODE_INCLUDED_
#define _DECODE_INCLUDED_
vec3 decodeLinear(vec4 raw) {
	return raw.rgb;
}
float decodeGamma(float raw) {
	return pow(raw, 2.2);
}
vec3 decodeGamma(vec3 raw) {
	return pow(raw, vec3(2.2));
}
vec3 decodeGamma(vec4 raw) {
	return pow(raw.xyz, vec3(2.2));
}
vec3 decodeRGBM(vec4 raw) {
	vec3 color = (8.0 * raw.a) * raw.rgb;
	return color * color;
}
vec3 decodeRGBP(vec4 raw) {
	vec3 color = raw.rgb * (-raw.a * 7.0 + 8.0);
	return color * color;
}
vec3 decodeRGBE(vec4 raw) {
	if (raw.a == 0.0) {
		return vec3(0.0, 0.0, 0.0);
	} else {
		return raw.xyz * pow(2.0, raw.w * 255.0 - 128.0);
	}
}
vec4 passThrough(vec4 raw) {
	return raw;
}
vec3 unpackNormalXYZ(vec4 nmap) {
	return nmap.xyz * 2.0 - 1.0;
}
vec3 unpackNormalXY(vec4 nmap) {
	vec3 normal;
	normal.xy = nmap.wy * 2.0 - 1.0;
	normal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));
	return normal;
}
#endif
`,emissivePS:`
uniform vec3 material_emissive;
uniform float material_emissiveIntensity;
void getEmission() {
	dEmission = material_emissive * material_emissiveIntensity;
	#ifdef STD_EMISSIVE_TEXTURE
	dEmission *= {STD_EMISSIVE_TEXTURE_DECODE}(texture2DBias({STD_EMISSIVE_TEXTURE_NAME}, {STD_EMISSIVE_TEXTURE_UV}, textureBias)).{STD_EMISSIVE_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_EMISSIVE_VERTEX
	dEmission *= saturate(vVertexColor.{STD_EMISSIVE_VERTEX_CHANNEL});
	#endif
}
`,encodePS:`
vec4 encodeLinear(vec3 source) {
	return vec4(source, 1.0);
}
vec4 encodeGamma(vec3 source) {
	return vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);
}
vec4 encodeRGBM(vec3 source) {
	vec4 result;
	result.rgb = pow(source.rgb, vec3(0.5));
	result.rgb *= 1.0 / 8.0;
	result.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );
	result.a = ceil(result.a * 255.0) / 255.0;
	result.rgb /= result.a;
	return result;
}
vec4 encodeRGBP(vec3 source) {
	vec3 gamma = pow(source, vec3(0.5));
	float maxVal = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));
	float v = 1.0 - ((maxVal - 1.0) / 7.0);
	v = ceil(v * 255.0) / 255.0;
	return vec4(gamma / (-v * 7.0 + 8.0), v);	
}
vec4 encodeRGBE(vec3 source) {
	float maxVal = max(source.x, max(source.y, source.z));
	if (maxVal < 1e-32) {
		return vec4(0, 0, 0, 0);
	} else {
		float e = ceil(log2(maxVal));
		return vec4(source / pow(2.0, e), (e + 128.0) / 255.0);
	}
}
`,endPS:`
	gl_FragColor.rgb = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);
	gl_FragColor.rgb += litArgs_emission;
	gl_FragColor.rgb = addFog(gl_FragColor.rgb);
	gl_FragColor.rgb = toneMap(gl_FragColor.rgb);
	gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);
`,envAtlasPS:`
#ifndef _ENVATLAS_INCLUDED_
#define _ENVATLAS_INCLUDED_
const float atlasSize = 512.0;
const float seamSize = 1.0 / atlasSize;
vec2 mapUv(vec2 uv, vec4 rect) {
	return vec2(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),
				mix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));
}
vec2 mapRoughnessUv(vec2 uv, float level) {
	float t = 1.0 / exp2(level);
	return mapUv(uv, vec4(0, 1.0 - t, t, t * 0.5));
}
vec2 mapShinyUv(vec2 uv, float level) {
	float t = 1.0 / exp2(level);
	return mapUv(uv, vec4(1.0 - t, 1.0 - t, t, t * 0.5));
}
#endif
`,envProcPS:`
#ifdef LIT_SKYBOX_INTENSITY
	uniform float skyboxIntensity;
#endif
vec3 processEnvironment(vec3 color) {
	#ifdef LIT_SKYBOX_INTENSITY
		return color * skyboxIntensity;
	#else
		return color;
	#endif
}
`,falloffInvSquaredPS:`
float getFalloffWindow(float lightRadius, vec3 lightDir) {
	float sqrDist = dot(lightDir, lightDir);
	float invRadius = 1.0 / lightRadius;
	return square(saturate(1.0 - square(sqrDist * square(invRadius))));
}
float getFalloffInvSquared(float lightRadius, vec3 lightDir) {
	float sqrDist = dot(lightDir, lightDir);
	float falloff = 1.0 / (sqrDist + 1.0);
	float invRadius = 1.0 / lightRadius;
	falloff *= 16.0;
	falloff *= square(saturate(1.0 - square(sqrDist * square(invRadius))));
	return falloff;
}
`,falloffLinearPS:`
float getFalloffLinear(float lightRadius, vec3 lightDir) {
	float d = length(lightDir);
	return max(((lightRadius - d) / lightRadius), 0.0);
}
`,floatAsUintPS:`
#ifndef FLOAT_AS_UINT
#define FLOAT_AS_UINT
vec4 float2uint(float value) {
	uint intBits = floatBitsToUint(value);
	return vec4(
		float((intBits >> 24u) & 0xFFu) / 255.0,
		float((intBits >> 16u) & 0xFFu) / 255.0,
		float((intBits >> 8u) & 0xFFu) / 255.0,
		float(intBits & 0xFFu) / 255.0
	);
}
float uint2float(vec4 value) {
	uint intBits = 
		(uint(value.r * 255.0) << 24u) |
		(uint(value.g * 255.0) << 16u) |
		(uint(value.b * 255.0) << 8u) |
		uint(value.a * 255.0);
	return uintBitsToFloat(intBits);
}
vec4 float2vec4(float value) {
	#if defined(CAPS_TEXTURE_FLOAT_RENDERABLE)
		return vec4(value, 1.0, 1.0, 1.0);
	#else
		return float2uint(value);
	#endif
}
#endif
`,fogPS:`
float dBlendModeFogFactor = 1.0;
#if (FOG != NONE)
	uniform vec3 fog_color;
	#if (FOG == LINEAR)
		uniform float fog_start;
		uniform float fog_end;
	#else
		uniform float fog_density;
	#endif
#endif
float getFogFactor() {
	float depth = gl_FragCoord.z / gl_FragCoord.w;
	float fogFactor = 0.0;
	#if (FOG == LINEAR)
		fogFactor = (fog_end - depth) / (fog_end - fog_start);
	#elif (FOG == EXP)
		fogFactor = exp(-depth * fog_density);
	#elif (FOG == EXP2)
		fogFactor = exp(-depth * depth * fog_density * fog_density);
	#endif
	return clamp(fogFactor, 0.0, 1.0);
}
vec3 addFog(vec3 color) {
	#if (FOG != NONE)
		return mix(fog_color * dBlendModeFogFactor, color, getFogFactor());
	#endif
	return color;
}
`,fresnelSchlickPS:`
vec3 getFresnel(
		float cosTheta, 
		float gloss, 
		vec3 specularity
#if defined(LIT_IRIDESCENCE)
		, vec3 iridescenceFresnel, 
		float iridescenceIntensity
#endif
	) {
	float fresnel = pow(1.0 - saturate(cosTheta), 5.0);
	float glossSq = gloss * gloss;
	float specIntensity = max(specularity.r, max(specularity.g, specularity.b));
	vec3 ret = specularity + (max(vec3(glossSq * specIntensity), specularity) - specularity) * fresnel;
#if defined(LIT_IRIDESCENCE)
	return mix(ret, iridescenceFresnel, iridescenceIntensity);
#else
	return ret;
#endif	
}
float getFresnelCC(float cosTheta) {
	float fresnel = pow(1.0 - saturate(cosTheta), 5.0);
	return 0.04 + (1.0 - 0.04) * fresnel;
}
`,frontendCodePS:"",frontendDeclPS:"",fullscreenQuadVS:`
attribute vec2 vertex_position;
varying vec2 vUv0;
void main(void)
{
	gl_Position = vec4(vertex_position, 0.5, 1.0);
	vUv0 = vertex_position.xy * 0.5 + 0.5;
}
`,gammaPS:`
#include "decodePS"
#if (GAMMA == SRGB)
	float gammaCorrectInput(float color) {
		return decodeGamma(color);
	}
	vec3 gammaCorrectInput(vec3 color) {
		return decodeGamma(color);
	}
	vec4 gammaCorrectInput(vec4 color) {
		return vec4(decodeGamma(color.xyz), color.w);
	}
	vec3 gammaCorrectOutput(vec3 color) {
		return pow(color + 0.0000001, vec3(1.0 / 2.2));
	}
#else
	float gammaCorrectInput(float color) {
		return color;
	}
	vec3 gammaCorrectInput(vec3 color) {
		return color;
	}
	vec4 gammaCorrectInput(vec4 color) {
		return color;
	}
	vec3 gammaCorrectOutput(vec3 color) {
		return color;
	}
#endif
`,gles3PS:re,gles3VS:rt,glossPS:`
#ifdef STD_GLOSS_CONSTANT
uniform float material_gloss;
#endif
void getGlossiness() {
	dGlossiness = 1.0;
	#ifdef STD_GLOSS_CONSTANT
	dGlossiness *= material_gloss;
	#endif
	#ifdef STD_GLOSS_TEXTURE
	dGlossiness *= texture2DBias({STD_GLOSS_TEXTURE_NAME}, {STD_GLOSS_TEXTURE_UV}, textureBias).{STD_GLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_GLOSS_VERTEX
	dGlossiness *= saturate(vVertexColor.{STD_GLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_GLOSS_INVERT
	dGlossiness = 1.0 - dGlossiness;
	#endif
	dGlossiness += 0.0000001;
}
`,quadVS:`
	attribute vec2 aPosition;
	varying vec2 uv0;
	void main(void)
	{
		gl_Position = vec4(aPosition, 0.0, 1.0);
		uv0 = getImageEffectUV((aPosition.xy + 1.0) * 0.5);
	}
`,immediateLinePS:`
		#include "gammaPS"
		varying vec4 color;
		void main(void) {
			gl_FragColor = vec4(gammaCorrectOutput(decodeGamma(color.rgb)), color.a);
		}
`,immediateLineVS:`
	attribute vec4 vertex_position;
	attribute vec4 vertex_color;
	uniform mat4 matrix_model;
	uniform mat4 matrix_viewProjection;
	varying vec4 color;
	void main(void) {
		color = vertex_color;
		gl_Position = matrix_viewProjection * matrix_model * vertex_position;
	}
`,iridescenceDiffractionPS:`
uniform float material_iridescenceRefractionIndex;
float iridescence_iorToFresnel(float transmittedIor, float incidentIor) {
	return pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);
}
vec3 iridescence_iorToFresnel(vec3 transmittedIor, float incidentIor) {
	return pow((transmittedIor - vec3(incidentIor)) / (transmittedIor + vec3(incidentIor)), vec3(2.0));
}
vec3 iridescence_fresnelToIor(vec3 f0) {
	vec3 sqrtF0 = sqrt(f0);
	return (vec3(1.0) + sqrtF0) / (vec3(1.0) - sqrtF0);
}
vec3 iridescence_sensitivity(float opd, vec3 shift) {
	float PI = 3.141592653589793;
	float phase = 2.0 * PI * opd * 1.0e-9;
	const vec3 val = vec3(5.4856e-13, 4.4201e-13, 5.2481e-13);
	const vec3 pos = vec3(1.6810e+06, 1.7953e+06, 2.2084e+06);
	const vec3 var = vec3(4.3278e+09, 9.3046e+09, 6.6121e+09);
	vec3 xyz = val * sqrt(2.0 * PI * var) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var);
	xyz.x += 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));
	xyz /= vec3(1.0685e-07);
	const mat3 XYZ_TO_REC709 = mat3(
		3.2404542, -0.9692660,  0.0556434,
	   -1.5371385,  1.8760108, -0.2040259,
	   -0.4985314,  0.0415560,  1.0572252
	);
	return XYZ_TO_REC709 * xyz;
}
float iridescence_fresnel(float cosTheta, float f0) {
	float x = clamp(1.0 - cosTheta, 0.0, 1.0);
	float x2 = x * x;
	float x5 = x * x2 * x2;
	return f0 + (1.0 - f0) * x5;
} 
vec3 iridescence_fresnel(float cosTheta, vec3 f0) {
	float x = clamp(1.0 - cosTheta, 0.0, 1.0);
	float x2 = x * x;
	float x5 = x * x2 * x2; 
	return f0 + (vec3(1.0) - f0) * x5;
}
vec3 calcIridescence(float outsideIor, float cosTheta, vec3 base_f0, float iridescenceThickness) {
	float PI = 3.141592653589793;
	float iridescenceIor = mix(outsideIor, material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));
	float sinTheta2Sq = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));
	float cosTheta2Sq = 1.0 - sinTheta2Sq;
	if (cosTheta2Sq < 0.0) {
		return vec3(1.0);
	}
	float cosTheta2 = sqrt(cosTheta2Sq);
	float r0 = iridescence_iorToFresnel(iridescenceIor, outsideIor);
	float r12 = iridescence_fresnel(cosTheta, r0);
	float r21 = r12;
	float t121 = 1.0 - r12;
	float phi12 = iridescenceIor < outsideIor ? PI : 0.0;
	float phi21 = PI - phi12;
	vec3 baseIor = iridescence_fresnelToIor(base_f0 + vec3(0.0001));
	vec3 r1 = iridescence_iorToFresnel(baseIor, iridescenceIor);
	vec3 r23 = iridescence_fresnel(cosTheta2, r1);
	vec3 phi23 = vec3(0.0);
	if (baseIor[0] < iridescenceIor) phi23[0] = PI;
	if (baseIor[1] < iridescenceIor) phi23[1] = PI;
	if (baseIor[2] < iridescenceIor) phi23[2] = PI;
	float opd = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;
	vec3 phi = vec3(phi21) + phi23; 
	vec3 r123Sq = clamp(r12 * r23, 1e-5, 0.9999);
	vec3 r123 = sqrt(r123Sq);
	vec3 rs = pow(t121, 2.0) * r23 / (1.0 - r123Sq);
	vec3 c0 = r12 + rs;
	vec3 i = c0;
	vec3 cm = rs - t121;
	for (int m = 1; m <= 2; m++) {
		cm *= r123;
		vec3 sm = 2.0 * iridescence_sensitivity(float(m) * opd, float(m) * phi);
		i += cm * sm;
	}
	return max(i, vec3(0.0));
}
vec3 getIridescence(float cosTheta, vec3 specularity, float iridescenceThickness) {
	return calcIridescence(1.0, cosTheta, specularity, iridescenceThickness);
}
`,iridescencePS:`
#ifdef STD_IRIDESCENCE_CONSTANT
uniform float material_iridescence;
#endif
void getIridescence() {
	float iridescence = 1.0;
	#ifdef STD_IRIDESCENCE_CONSTANT
	iridescence *= material_iridescence;
	#endif
	#ifdef STD_IRIDESCENCE_TEXTURE
	iridescence *= texture2DBias({STD_IRIDESCENCE_TEXTURE_NAME}, {STD_IRIDESCENCE_TEXTURE_UV}, textureBias).{STD_IRIDESCENCE_TEXTURE_CHANNEL};
	#endif
	dIridescence = iridescence; 
}
`,iridescenceThicknessPS:`
uniform float material_iridescenceThicknessMax;
#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE
uniform float material_iridescenceThicknessMin;
#endif
void getIridescenceThickness() {
	#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE
		float blend = texture2DBias({STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}, {STD_IRIDESCENCETHICKNESS_TEXTURE_UV}, textureBias).{STD_IRIDESCENCETHICKNESS_TEXTURE_CHANNEL};
		float iridescenceThickness = mix(material_iridescenceThicknessMin, material_iridescenceThicknessMax, blend);
	#else
		float iridescenceThickness = material_iridescenceThicknessMax;
	#endif
	dIridescenceThickness = iridescenceThickness; 
}
`,iorPS:`
#ifdef STD_IOR_CONSTANT
uniform float material_refractionIndex;
#endif
void getIor() {
#ifdef STD_IOR_CONSTANT
	dIor = material_refractionIndex;
#else
	dIor = 1.0 / 1.5;
#endif
}
`,lightDeclarationPS:`
#if defined(LIGHT{i})
	uniform vec3 light{i}_color;
	#if LIGHT{i}TYPE == DIRECTIONAL
		uniform vec3 light{i}_direction;
	#else
		#define LIT_CODE_LIGHTS_POINT
		uniform vec3 light{i}_position;
		uniform float light{i}_radius;
		#if LIGHT{i}TYPE == SPOT
			#define LIT_CODE_LIGHTS_SPOT
			uniform vec3 light{i}_direction;
			uniform float light{i}_innerConeAngle;
			uniform float light{i}_outerConeAngle;
		#endif
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#define LIT_CODE_FALLOFF_SQUARED
		#if LIGHT{i}TYPE == DIRECTIONAL
			uniform vec3 light{i}_position;
		#endif
		uniform vec3 light{i}_halfWidth;
		uniform vec3 light{i}_halfHeight;
	#else
		#if LIGHT{i}FALLOFF == LINEAR
			#define LIT_CODE_FALLOFF_LINEAR
		#endif
		#if LIGHT{i}FALLOFF == INVERSESQUARED
			#define LIT_CODE_FALLOFF_SQUARED
		#endif
	#endif
	#if defined(LIGHT{i}CASTSHADOW)
		#if LIGHT{i}TYPE != OMNI
			uniform mat4 light{i}_shadowMatrix;
		#endif
		uniform float light{i}_shadowIntensity;
		uniform vec4 light{i}_shadowParams;
		#if LIGHT{i}SHADOWTYPE == PCSS_32F
			uniform float light{i}_shadowSearchArea;
			uniform vec4 light{i}_cameraParams;
			#if LIGHT{i}TYPE == DIRECTIONAL
				uniform vec4 light{i}_softShadowParams;
			#endif
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			uniform mat4 light{i}_shadowMatrixPalette[4];
			uniform vec4 light{i}_shadowCascadeDistances;
			uniform int light{i}_shadowCascadeCount;
			uniform float light{i}_shadowCascadeBlend;
		#endif
		#if LIGHT{i}TYPE == OMNI
			#if defined(LIGHT{i}SHADOW_PCF)
				uniform samplerCubeShadow light{i}_shadowMap;
			#else
				uniform samplerCube light{i}_shadowMap;
			#endif
		#else
			#if defined(LIGHT{i}SHADOW_PCF)
				uniform sampler2DShadow light{i}_shadowMap;
			#else
				uniform sampler2D light{i}_shadowMap;
			#endif
		#endif
	#endif
	#if defined(LIGHT{i}COOKIE)
		#define LIT_CODE_COOKIE
		#if LIGHT{i}TYPE == OMNI
			uniform samplerCube light{i}_cookie;
			uniform float light{i}_cookieIntensity;
			uniform mat4 light{i}_shadowMatrix;
		#endif
		#if LIGHT{i}TYPE == SPOT
			uniform sampler2D light{i}_cookie;
			uniform float light{i}_cookieIntensity;
			#if !defined(LIGHT{i}CASTSHADOW)
				uniform mat4 light{i}_shadowMatrix;
			#endif
			#if defined(LIGHT{i}COOKIE_TRANSFORM)
				uniform vec4 light{i}_cookieMatrix;
				uniform vec2 light{i}_cookieOffset;
			#endif
		#endif
	#endif
#endif
`,lightDiffuseLambertPS:`
float getLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm) {
	return max(dot(worldNormal, -lightDirNorm), 0.0);
}
`,lightDirPointPS:`
vec3 evalOmniLight(vec3 lightPosW) {
	return vPositionW - lightPosW;
}
`,lightEvaluationPS:`
#if defined(LIGHT{i})
	evaluateLight{i}(
		#if defined(LIT_IRIDESCENCE)
			iridescenceFresnel
		#endif
	);
#endif
`,lightFunctionLightPS:`
#if defined(LIGHT{i})
void evaluateLight{i}(
	#if defined(LIT_IRIDESCENCE)
		vec3 iridescenceFresnel
	#endif
) {
	vec3 lightColor = light{i}_color;
	#if LIGHT{i}TYPE == DIRECTIONAL && !defined(LIT_SHADOW_CATCHER)
		if (all(equal(lightColor, vec3(0.0)))) {
			return;
		}
	#endif
	#if LIGHT{i}TYPE == DIRECTIONAL
		dLightDirNormW = light{i}_direction;
		dAtten = 1.0;
	#else
		
		vec3 lightDirW = evalOmniLight(light{i}_position);
		dLightDirNormW = normalize(lightDirW);
		#if defined(LIGHT{i}COOKIE)
			#if LIGHT{i}TYPE == SPOT
				#ifdef LIGHT{i}COOKIE_FALLOFF
					#ifdef LIGHT{i}COOKIE_TRANSFORM
						vec3 cookieAttenuation = getCookie2DXform(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity, light{i}_cookieMatrix, light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};
					#else
						vec3 cookieAttenuation = getCookie2D(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
					#endif
				#else
					#ifdef LIGHT{i}COOKIE_TRANSFORM
						vec3 cookieAttenuation = getCookie2DClipXform(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity, light{i}_cookieMatrix, light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};
					#else
						vec3 cookieAttenuation = getCookie2DClip(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
					#endif
				#endif
			#endif
			#if LIGHT{i}TYPE == OMNI
				vec3 cookieAttenuation = getCookieCube(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
			#endif
			lightColor *= cookieAttenuation;
		#endif
		#if LIGHT{i}SHAPE == PUNCTUAL
			#if LIGHT{i}FALLOFF == LINEAR
				dAtten = getFalloffLinear(light{i}_radius, lightDirW);
			#else
				dAtten = getFalloffInvSquared(light{i}_radius, lightDirW);
			#endif
		#else
			dAtten = getFalloffWindow(light{i}_radius, lightDirW);
		#endif
		#if LIGHT{i}TYPE == SPOT
			#if !defined(LIGHT{i}COOKIE) || defined(LIGHT{i}COOKIE_FALLOFF)
				dAtten *= getSpotEffect(light{i}_direction, light{i}_innerConeAngle, light{i}_outerConeAngle, dLightDirNormW);
			#endif
		#endif
	#endif
	if (dAtten < 0.00001) {
		return;
	}
	#if LIGHT{i}SHAPE != PUNCTUAL
		#if LIGHT{i}SHAPE == RECT
			calcRectLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);
		#elif LIGHT{i}SHAPE == DISK
			calcDiskLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);
		#elif LIGHT{i}SHAPE == SPHERE
			calcSphereLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);
		#endif
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#if LIGHT{i}TYPE == DIRECTIONAL
			float attenDiffuse = getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirNormW);
		#else
			#if LIGHT{i}SHAPE == RECT
				float attenDiffuse = getRectLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#elif LIGHT{i}SHAPE == DISK
				float attenDiffuse = getDiskLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#elif LIGHT{i}SHAPE == SPHERE
				float attenDiffuse = getSphereLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#endif
		#endif
	#else
		dAtten *= getLightDiffuse(litArgs_worldNormal, vec3(0.0), dLightDirNormW);
	#endif
	#ifdef LIGHT{i}CASTSHADOW
		#if LIGHT{i}TYPE == DIRECTIONAL
			float shadow = getShadow{i}(vec3(0.0));
		#else
			float shadow = getShadow{i}(lightDirW);
		#endif
		shadow = mix(1.0, shadow, light{i}_shadowIntensity);
		dAtten *= shadow;
		#if defined(LIT_SHADOW_CATCHER) && LIGHT{i}TYPE == DIRECTIONAL
			dShadowCatcher *= shadow;
		#endif			
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#ifdef LIT_SPECULAR
			dDiffuseLight += ((attenDiffuse * dAtten) * lightColor) * (1.0 - dLTCSpecFres);
		#else
			dDiffuseLight += (attenDiffuse * dAtten) * lightColor;
		#endif						
	#else
		#if defined(AREA_LIGHTS) && defined(LIT_SPECULAR)
			dDiffuseLight += (dAtten * lightColor) * (1.0 - litArgs_specularity);
		#else
			dDiffuseLight += dAtten * lightColor;
		#endif
	#endif
	#ifdef LIGHT{i}AFFECT_SPECULARITY
		#if LIGHT{i}SHAPE != PUNCTUAL
			#ifdef LIT_CLEARCOAT
				#if LIGHT{i}SHAPE == RECT
					ccSpecularLight += ccLTCSpecFres * getRectLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;
				#elif LIGHT{i}SHAPE == DISK
					ccSpecularLight += ccLTCSpecFres * getDiskLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;
				#elif LIGHT{i}SHAPE == SPHERE
					ccSpecularLight += ccLTCSpecFres * getSphereLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;
				#endif
			#endif
			#ifdef LIT_SPECULAR
				#if LIGHT{i}SHAPE == RECT
					dSpecularLight += dLTCSpecFres * getRectLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;
				#elif LIGHT{i}SHAPE == DISK
					dSpecularLight += dLTCSpecFres * getDiskLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;
				#elif LIGHT{i}SHAPE == SPHERE
					dSpecularLight += dLTCSpecFres * getSphereLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;
				#endif
			#endif
		#else
			#if LIGHT{i}TYPE == DIRECTIONAL && LIT_FRESNEL_MODEL != NONE
				#define LIGHT{i}FRESNEL
			#endif
			#ifdef LIT_SPECULAR
				vec3 halfDirW = normalize(-dLightDirNormW + dViewDirW);
			#endif
			#ifdef LIT_CLEARCOAT
				vec3 lightspecularCC = getLightSpecular(halfDirW, ccReflDirW, litArgs_clearcoat_worldNormal, dViewDirW, dLightDirNormW, litArgs_clearcoat_gloss, dTBN) * dAtten * lightColor;
				#ifdef LIGHT{i}FRESNEL
					lightspecularCC *= getFresnelCC(dot(dViewDirW, halfDirW));
				#endif
				ccSpecularLight += lightspecularCC;
			#endif
			#ifdef LIT_SHEEN
				sSpecularLight += getLightSpecularSheen(halfDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_sheen_gloss) * dAtten * lightColor;
			#endif
			#ifdef LIT_SPECULAR
				vec3 lightSpecular = getLightSpecular(halfDirW, dReflDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_gloss, dTBN) * dAtten * lightColor;
				#ifdef LIGHT{i}FRESNEL
					#if defined(LIT_IRIDESCENCE)
						lightSpecular *= getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity, iridescenceFresnel, litArgs_iridescence_intensity);
					#else
						lightSpecular *= getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity);
					#endif
				#else
					lightSpecular *= litArgs_specularity;
				#endif
				
				dSpecularLight += lightSpecular;
			#endif
		#endif
	#endif
}
#endif
`,lightFunctionShadowPS:`
#ifdef LIGHT{i}CASTSHADOW
	#ifdef LIGHT{i}_SHADOW_SAMPLE_POINT
		vec3 getShadowSampleCoordOmni{i}(vec4 shadowParams, vec3 worldPosition, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {
			#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
				float distScale = length(lightDir);
				vec3 surfacePosition = worldPosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
				lightDir = surfacePosition - lightPos;
			#endif
			return lightDir;
		}
	#endif
	#ifndef LIGHT{i}_SHADOW_SAMPLE_POINT
		vec3 getShadowSampleCoord{i}(mat4 shadowTransform, vec4 shadowParams, vec3 worldPosition, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {
			vec3 surfacePosition = worldPosition;
			#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER
				#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
					surfacePosition = surfacePosition + normal * shadowParams.y;
				#endif
			#else
				#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
					#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO
						float distScale = 1.0;
					#else
						float distScale = abs(dot(vPositionW - lightPos, lightDirNorm));
					#endif
					surfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
				#endif
			#endif
			vec4 positionInShadowSpace = shadowTransform * vec4(surfacePosition, 1.0);
			#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO
				positionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;
			#else
				#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER
					positionInShadowSpace.xyz /= positionInShadowSpace.w;
				#else
					positionInShadowSpace.xy /= positionInShadowSpace.w;
					positionInShadowSpace.z = length(lightDir) * shadowParams.w;
				#endif
			#endif
			return positionInShadowSpace.xyz;
		}
	#endif
	float getShadow{i}(vec3 lightDirW) {
		#if LIGHT{i}TYPE == OMNI
			vec3 shadowCoord = getShadowSampleCoordOmni{i}(light{i}_shadowParams, vPositionW, light{i}_position, lightDirW, dLightDirNormW, dVertexNormalW);
		#else
			#ifdef LIGHT{i}_SHADOW_CASCADES
				int cascadeIndex = getShadowCascadeIndex(light{i}_shadowCascadeDistances, light{i}_shadowCascadeCount);
				#ifdef LIGHT{i}_SHADOW_CASCADE_BLEND
					cascadeIndex = ditherShadowCascadeIndex(cascadeIndex, light{i}_shadowCascadeDistances, light{i}_shadowCascadeCount, light{i}_shadowCascadeBlend);
				#endif
				mat4 shadowMatrix = light{i}_shadowMatrixPalette[cascadeIndex];
			#else
				mat4 shadowMatrix = light{i}_shadowMatrix;
			#endif
			#if LIGHT{i}TYPE == DIRECTIONAL
				vec3 shadowCoord = getShadowSampleCoord{i}(shadowMatrix, light{i}_shadowParams, vPositionW, vec3(0.0), lightDirW, dLightDirNormW, dVertexNormalW);
			#else
				vec3 shadowCoord = getShadowSampleCoord{i}(shadowMatrix, light{i}_shadowParams, vPositionW, light{i}_position, lightDirW, dLightDirNormW, dVertexNormalW);
			#endif
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			shadowCoord = fadeShadow(shadowCoord, light{i}_shadowCascadeDistances);
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			#if LIGHT{i}SHADOWTYPE == VSM_16F
				return getShadowVSM16(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 5.54);
			#endif
			#if LIGHT{i}SHADOWTYPE == VSM_32F
				return getShadowVSM32(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 15.0);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				#if LIGHT{i}SHAPE != PUNCTUAL
					vec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;
					return getShadowPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);
				#else
					return getShadowPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, light{i}_softShadowParams, lightDirW);
				#endif
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F
				return getShadowPCF5x5(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
		#endif
		#if LIGHT{i}TYPE == SPOT
			#if LIGHT{i}SHADOWTYPE == VSM_16F
				return getShadowSpotVSM16(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 5.54, lightDirW);
			#endif
			#if LIGHT{i}SHADOWTYPE == VSM_32F
				return getShadowSpotVSM32(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 15.0, lightDirW);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				#if LIGHT{i}SHAPE != PUNCTUAL
					vec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;
				#else
					vec2 shadowSearchArea = vec2(light{i}_shadowSearchArea);
				#endif
				return getShadowSpotPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowSpotPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowSpotPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F
				return getShadowSpotPCF5x5(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);
			#endif
		#endif
		#if LIGHT{i}TYPE == OMNI
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				#if LIGHT{i}SHAPE != PUNCTUAL
					vec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;
				#else
					vec2 shadowSearchArea = vec2(light{i}_shadowSearchArea);
				#endif
				return getShadowOmniPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowOmniPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, lightDirW);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowOmniPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, lightDirW);
			#endif
		#endif
	}
#endif
`,lightingPS:`
#ifdef LIT_CLUSTERED_LIGHTS
	#define LIT_CODE_FALLOFF_LINEAR
	#define LIT_CODE_FALLOFF_SQUARED
	#define LIT_CODE_LIGHTS_POINT
	#define LIT_CODE_LIGHTS_SPOT
#endif
#ifdef AREA_LIGHTS
	uniform highp sampler2D areaLightsLutTex1;
	uniform highp sampler2D areaLightsLutTex2;
#endif
#ifdef LIT_LIGHTING
	#include "lightDiffuseLambertPS"
	#if defined(AREA_LIGHTS) || defined(LIT_CLUSTERED_AREA_LIGHTS)
		#include "ltcPS"
	#endif
#endif
#ifdef SHADOW_DIRECTIONAL
	#include "shadowCascadesPS"
#endif
#if defined(SHADOW_KIND_PCF1)
	#include "shadowPCF1PS"
#endif
#if defined(SHADOW_KIND_PCF3)
	#include "shadowPCF3PS"
#endif
#if defined(SHADOW_KIND_PCF5)
	#include "shadowPCF5PS"
#endif
#if defined(SHADOW_KIND_PCSS)
	#include "linearizeDepthPS"
	#include "shadowPCSSPS"
	#include "shadowSoftPS"
#endif
#if defined(SHADOW_KIND_VSM)
	#include "shadowEVSMPS"
#endif
#ifdef LIT_CODE_FALLOFF_LINEAR
	#include "falloffLinearPS"
#endif
#ifdef LIT_CODE_FALLOFF_SQUARED
	#include "falloffInvSquaredPS"
#endif
#ifdef LIT_CODE_LIGHTS_POINT
	#include "lightDirPointPS"
#endif
#ifdef LIT_CODE_LIGHTS_SPOT
	#include "spotPS"
#endif
#ifdef LIT_CODE_COOKIE
	#include "cookiePS"
#endif
#ifdef LIT_CLUSTERED_LIGHTS
	#include "clusteredLightPS"
#endif
#ifdef LIGHT_COUNT > 0
	#include "lightFunctionShadowPS, LIGHT_COUNT"
	#include "lightFunctionLightPS, LIGHT_COUNT"
#endif
`,lightmapAddPS:`
void addLightMap(
	vec3 lightmap, 
	vec3 dir, 
	vec3 worldNormal, 
	vec3 viewDir, 
	vec3 reflectionDir, 
	float gloss, 
	vec3 specularity, 
	vec3 vertexNormal, 
	mat3 tbn
#if defined(LIT_IRIDESCENCE)
	vec3 iridescenceFresnel, 
	float iridescenceIntensity
#endif
) {
	#if defined(LIT_SPECULAR) && defined(LIT_DIR_LIGHTMAP)
		if (dot(dir, dir) < 0.0001) {
				dDiffuseLight += lightmap;
		} else {
			float vlight = saturate(dot(dir, -vertexNormal));
			float flight = saturate(dot(dir, -worldNormal));
			float nlight = (flight / max(vlight, 0.01)) * 0.5;
			dDiffuseLight += lightmap * nlight * 2.0;
			vec3 halfDir = normalize(-dir + viewDir);
			vec3 specularLight = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);
			#ifdef LIT_SPECULAR_FRESNEL
				specularLight *= 
					getFresnel(dot(viewDir, halfDir), 
					gloss, 
					specularity
				#if defined(LIT_IRIDESCENCE)
					, iridescenceFresnel,
					iridescenceIntensity
				#endif
					);
			#endif
			dSpecularLight += specularLight;
		}
	#else
		dDiffuseLight += lightmap;
	#endif
}
`,lightmapPS:`
#ifdef STD_LIGHTMAP_DIR
	vec3 dLightmapDir;
	uniform sampler2D texture_dirLightMap;
#endif
void getLightMap() {
	dLightmap = vec3(1.0);
	#ifdef STD_LIGHT_TEXTURE
		dLightmap *= {STD_LIGHT_TEXTURE_DECODE}(texture2DBias({STD_LIGHT_TEXTURE_NAME}, {STD_LIGHT_TEXTURE_UV}, textureBias)).{STD_LIGHT_TEXTURE_CHANNEL};
		#ifdef STD_LIGHTMAP_DIR
			vec3 dir = texture2DBias(texture_dirLightMap, {STD_LIGHT_TEXTURE_UV}, textureBias).xyz * 2.0 - 1.0;
			float dirDot = dot(dir, dir);
			dLightmapDir = (dirDot > 0.001) ? dir / sqrt(dirDot) : vec3(0.0);
		#endif
	#endif
	#ifdef STD_LIGHT_VERTEX
		dLightmap *= saturate(vVertexColor.{STD_LIGHT_VERTEX_CHANNEL});
	#endif
}
`,lightSpecularAnisoGGXPS:`
float calcLightSpecular(float gloss, vec3 worldNormal, vec3 viewDir, vec3 h, vec3 lightDirNorm, mat3 tbn) {
	float PI = 3.141592653589793;
	float roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);
	float alphaRoughness = roughness * roughness;
	float anisotropy = dAnisotropy;
	vec2 direction = dAnisotropyRotation;
	float at = mix(alphaRoughness, 1.0, anisotropy * anisotropy);
	float ab = clamp(alphaRoughness, 0.001, 1.0);
	vec3 anisotropicT = normalize(tbn * vec3(direction, 0.0));
	vec3 anisotropicB = normalize(cross(tbn[2], anisotropicT));
	float NoH = dot(worldNormal, h);
	float ToH = dot(anisotropicT, h);
	float BoH = dot(anisotropicB, h);
	float a2 = at * ab;
	vec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);
	float v2 = dot(v, v);
	float w2 = a2 / v2;
	float D = a2 * w2 * w2 * (1.0 / PI);
	float ToV = dot(anisotropicT, viewDir);
	float BoV = dot(anisotropicB, viewDir);
	float ToL = dot(anisotropicT, -lightDirNorm);
	float BoL = dot(anisotropicB, -lightDirNorm);
	float NoV = dot(worldNormal, viewDir);
	float NoL = dot(worldNormal, -lightDirNorm);
	float lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));
	float lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));
	float G = 0.5 / (lambdaV + lambdaL);
	return D * G;
}
float getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {
	return calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);
}
`,lightSpecularGGXPS:`
float calcLightSpecular(float gloss, vec3 worldNormal, vec3 viewDir, vec3 h, vec3 lightDirNorm) {
	const float PI = 3.141592653589793;
	float roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);
	float alpha = roughness * roughness;
	float NoH = max(dot(worldNormal, h), 0.0);
	float NoV = max(dot(worldNormal, viewDir), 0.0);
	float NoL = max(dot(worldNormal, -lightDirNorm), 0.0);
	float NoH2 = NoH * NoH;
	float denom = NoH2 * (alpha - 1.0) + 1.0;
	float D = alpha / (PI * denom * denom);
	float alpha2 = alpha * alpha;
	float lambdaV = NoL * sqrt(NoV * NoV * (1.0 - alpha2) + alpha2);
	float lambdaL = NoV * sqrt(NoL * NoL * (1.0 - alpha2) + alpha2);
	float G = 0.5 / max(lambdaV + lambdaL, 0.00001);
	return D * G;
}
float getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {
	return calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm);
}
`,lightSpecularBlinnPS:`
float calcLightSpecular(float gloss, vec3 worldNormal, vec3 h) {
	float nh = max( dot( h, worldNormal ), 0.0 );
	float specPow = exp2(gloss * 11.0);
	specPow = max(specPow, 0.0001);
	return pow(nh, specPow) * (specPow + 2.0) / 8.0;
}
float getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {
	return calcLightSpecular(gloss, worldNormal, h);
}
`,lightSheenPS:`
float sheenD(vec3 normal, vec3 h, float roughness) {
	const float PI = 3.141592653589793;
	float invR = 1.0 / (roughness * roughness);
	float cos2h = max(dot(normal, h), 0.0);
	cos2h *= cos2h;
	float sin2h = max(1.0 - cos2h, 0.0078125);
	return (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);
}
float sheenV(vec3 normal, vec3 viewDir, vec3 light) {
	float NoV = max(dot(normal, viewDir), 0.000001);
	float NoL = max(dot(normal, light), 0.000001);
	return 1.0 / (4.0 * (NoL + NoV - NoL * NoV));
}
float getLightSpecularSheen(vec3 h, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float sheenGloss) {
	float D = sheenD(worldNormal, h, sheenGloss);
	float V = sheenV(worldNormal, viewDir, -lightDirNorm);
	return D * V;
}
`,linearizeDepthPS:`
#ifndef LINEARIZE_DEPTH
#define LINEARIZE_DEPTH
float linearizeDepthWithParams(float z, vec4 cameraParams) {
	if (cameraParams.w == 0.0)
		return (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));
	else
		return cameraParams.z + z * (cameraParams.y - cameraParams.z);
}
#ifndef CAMERAPLANES
	#define CAMERAPLANES
	uniform vec4 camera_params;
#endif
float linearizeDepth(float z) {
	return linearizeDepthWithParams(z, camera_params);
}
#endif
`,litForwardBackendPS:`
void evaluateBackend() {
	#ifdef LIT_SSAO
		litArgs_ao *= texture2DLod(ssaoTexture, gl_FragCoord.xy * ssaoTextureSizeInv, 0.0).r;
	#endif
	#ifdef LIT_NEEDS_NORMAL
		#ifdef LIT_SPECULAR
			getReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);
		#endif
		#ifdef LIT_CLEARCOAT
			ccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));
		#endif
	#endif
	#ifdef LIT_SPECULAR_OR_REFLECTION
		#ifdef LIT_METALNESS
			float f0 = 1.0 / litArgs_ior;
			f0 = (f0 - 1.0) / (f0 + 1.0);
			f0 *= f0;
			#ifdef LIT_SPECULARITY_FACTOR
				litArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0, litArgs_specularityFactor);
			#else
				litArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0, 1.0);
			#endif
			litArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);
		#endif
		#ifdef LIT_IRIDESCENCE
			vec3 iridescenceFresnel = getIridescence(saturate(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);
		#endif
	#endif
	#ifdef LIT_ADD_AMBIENT
		addAmbient(litArgs_worldNormal);
		#ifdef LIT_SPECULAR
			dDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);
		#endif
		#ifdef LIT_SEPARATE_AMBIENT
			vec3 dAmbientLight = dDiffuseLight;
			dDiffuseLight = vec3(0);
		#endif
	#endif
	#ifndef LIT_OLD_AMBIENT
		dDiffuseLight *= material_ambient;
	#endif
	#ifdef LIT_AO
		#ifndef LIT_OCCLUDE_DIRECT
			occludeDiffuse(litArgs_ao);
		#endif
	#endif
	#ifdef LIT_LIGHTMAP
		addLightMap(
			litArgs_lightmap, 
			litArgs_lightmapDir, 
			litArgs_worldNormal, 
			dViewDirW, 
			dReflDirW, 
			litArgs_gloss, 
			litArgs_specularity, 
			dVertexNormalW,
			dTBN
		#if defined(LIT_IRIDESCENCE)
			, iridescenceFresnel,
			litArgs_iridescence_intensity
		#endif
		);
	#endif
	#ifdef LIT_LIGHTING || LIT_REFLECTIONS
		#ifdef LIT_REFLECTIONS
			#ifdef LIT_CLEARCOAT
				addReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);
			
				#ifdef LIT_SPECULAR_FRESNEL
					ccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));
					ccReflection *= ccFresnel;
				#else
					ccFresnel = 0.0;
				#endif
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				ccReflection *= litArgs_specularityFactor;
			#endif
			#ifdef LIT_SHEEN
				addReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);
			#endif
			addReflection(dReflDirW, litArgs_gloss);
			#ifdef LIT_FRESNEL_MODEL
				dReflection.rgb *= getFresnel(
					dot(dViewDirW, litArgs_worldNormal), 
					litArgs_gloss, 
					litArgs_specularity
				#if defined(LIT_IRIDESCENCE)
					, iridescenceFresnel,
					litArgs_iridescence_intensity
				#endif
					);
			#else
				dReflection.rgb *= litArgs_specularity;
			#endif
		#endif
		#ifdef AREA_LIGHTS
			dSpecularLight *= litArgs_specularity;
			#ifdef LIT_SPECULAR
				calcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);
			#endif
		#endif
		
		#ifdef LIGHT_COUNT > 0
			#include "lightEvaluationPS, LIGHT_COUNT"
		#endif
		#ifdef LIT_CLUSTERED_LIGHTS
			addClusteredLights(litArgs_worldNormal, dViewDirW, dReflDirW,
				#if defined(LIT_CLEARCOAT)
						ccReflDirW,
				#endif
						litArgs_gloss, litArgs_specularity, dVertexNormalW, dTBN, 
				#if defined(LIT_IRIDESCENCE)
						iridescenceFresnel,
				#endif
						litArgs_clearcoat_worldNormal, litArgs_clearcoat_gloss, litArgs_sheen_gloss, litArgs_iridescence_intensity
			);
		#endif
		#ifdef AREA_LIGHTS
			#ifdef LIT_CLEARCOAT
				litArgs_clearcoat_specularity = 1.0;
			#endif
			#ifdef LIT_SPECULAR
				litArgs_specularity = vec3(1);
			#endif
		#endif
		#ifdef LIT_REFRACTION
			addRefraction(
				litArgs_worldNormal, 
				dViewDirW, 
				litArgs_thickness, 
				litArgs_gloss, 
				litArgs_specularity, 
				litArgs_albedo, 
				litArgs_transmission,
				litArgs_ior,
				litArgs_dispersion
				#if defined(LIT_IRIDESCENCE)
					, iridescenceFresnel, 
					litArgs_iridescence_intensity
				#endif
			);
		#endif
	#endif
	#ifdef LIT_AO
		#ifdef LIT_OCCLUDE_DIRECT
			occludeDiffuse(litArgs_ao);
		#endif
		#if LIT_OCCLUDE_SPECULAR != NONE
			occludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);
		#endif
	#endif
	#if !defined(LIT_OPACITY_FADES_SPECULAR)
		#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == PREMULTIPLIED
			float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3( 0.2126, 0.7152, 0.0722 ));
			#ifdef LIT_CLEARCOAT
				specLum += dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection * litArgs_clearcoat_specularity, vec3( 0.2126, 0.7152, 0.0722 ));
			#endif
			litArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);
		#endif
		litArgs_opacity *= material_alphaFade;
	#endif
	#ifdef LIT_LIGHTMAP_BAKING
		#ifdef LIT_LIGHTMAP_BAKING_COLOR
			#include "bakeLmEndPS"
		#endif
		#ifdef LIT_LIGHTMAP_BAKING_DIR
			#include "bakeDirLmEndPS"
		#endif
	#else
		#include "endPS"
		#include "outputAlphaPS"
	#endif
	#ifdef LIT_MSDF
		gl_FragColor = applyMsdf(gl_FragColor);
	#endif
	#include "outputPS"
	#include "debugOutputPS"
	#ifdef LIT_SHADOW_CATCHER
		gl_FragColor.rgb = vec3(dShadowCatcher);
	#endif
}
`,litForwardDeclarationPS:`
vec3 sReflection;
vec3 dVertexNormalW;
vec3 dTangentW;
vec3 dBinormalW;
vec3 dViewDirW;
vec3 dReflDirW;
vec3 ccReflDirW;
vec3 dLightDirNormW;
float dAtten;
mat3 dTBN;
vec4 dReflection;
vec3 dDiffuseLight;
vec3 dSpecularLight;
float ccFresnel;
vec3 ccReflection;
vec3 ccSpecularLight;
float ccSpecularityNoFres;
vec3 sSpecularLight;
#ifdef LIT_DISPERSION
	uniform float material_dispersion;
#endif
#ifndef LIT_OPACITY_FADES_SPECULAR
	uniform float material_alphaFade;
#endif
#ifdef LIT_SSAO
	uniform sampler2D ssaoTexture;
	uniform vec2 ssaoTextureSizeInv;
#endif
#ifdef LIT_SHADOW_CATCHER
	float dShadowCatcher = 1.0;
#endif
#if LIGHT_COUNT > 0
	#include "lightDeclarationPS, LIGHT_COUNT"
#endif
#ifdef LIT_SPECULAR
	#if LIT_FRESNEL_MODEL == NONE && !defined(LIT_REFLECTIONS) && !defined(LIT_DIFFUSE_MAP) 
		#define LIT_OLD_AMBIENT
	#endif
#endif
#ifdef STD_LIGHTMAP_DIR
	uniform float bakeDir;
#endif
#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT
	uniform float ambientBakeOcclusionContrast;
	uniform float ambientBakeOcclusionBrightness;
#endif
`,litForwardMainPS:`
void main(void) {
	#include "litUserMainStartPS"
	dReflection = vec4(0);
	#ifdef LIT_CLEARCOAT
		ccSpecularLight = vec3(0);
		ccReflection = vec3(0);
	#endif
	#if LIT_NONE_SLICE_MODE == SLICED
		#include "startNineSlicedPS"
	#elif LIT_NONE_SLICE_MODE == TILED
		#include "startNineSlicedTiledPS"
	#endif
	#ifdef LIT_NEEDS_NORMAL
		dVertexNormalW = normalize(vNormalW);
		#ifdef LIT_TANGENTS
			#if defined(LIT_HEIGHTS) || defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS) || defined(LIT_GGX_SPECULAR)
				dTangentW = vTangentW;
				dBinormalW = vBinormalW;
			#endif
		#endif
		getViewDir();
		#ifdef LIT_TBN
			getTBN(dTangentW, dBinormalW, dVertexNormalW);
			#ifdef LIT_TWO_SIDED_LIGHTING
				handleTwoSidedLighting();
			#endif
		#endif
	#endif
	evaluateFrontend();
	#include "debugProcessFrontendPS"
	evaluateBackend();
	#include "litUserMainEndPS"
}
`,litForwardPostCodePS:`
#ifdef LIT_NEEDS_NORMAL
	#include "cubeMapRotatePS"
	#include "cubeMapProjectPS"
	#include "envProcPS"
#endif
#ifdef LIT_SPECULAR_OR_REFLECTION
	#ifdef LIT_METALNESS
		#include "metalnessModulatePS"
	#endif
	#if LIT_FRESNEL_MODEL == SCHLICK
		#include "fresnelSchlickPS"
	#endif
	#ifdef LIT_IRIDESCENCE
		#include "iridescenceDiffractionPS"
	#endif
#endif
#ifdef LIT_AO
	#include "aoDiffuseOccPS"
	#include "aoSpecOccPS"
#endif
#if LIT_REFLECTION_SOURCE == ENVATLASHQ
	#include "envAtlasPS"
	#include "reflectionEnvHQPS"
#elif LIT_REFLECTION_SOURCE == ENVATLAS
	#include "envAtlasPS"
	#include "reflectionEnvPS"
#elif LIT_REFLECTION_SOURCE == CUBEMAP
	#include "reflectionCubePS"
#elif LIT_REFLECTION_SOURCE == SPHEREMAP
	#include "reflectionSpherePS"
#endif
#ifdef LIT_REFLECTIONS
	#ifdef LIT_CLEARCOAT
		#include "reflectionCCPS"
	#endif
	#ifdef LIT_SHEEN
		#include "reflectionSheenPS"
	#endif
#endif
#ifdef LIT_REFRACTION
	#if defined(LIT_DYNAMIC_REFRACTION)
		#include "refractionDynamicPS"
	#elif defined(LIT_REFLECTIONS)
		#include "refractionCubePS"
	#endif
#endif
#ifdef LIT_SHEEN
	#include "lightSheenPS"
#endif
uniform vec3 material_ambient;
#ifdef LIT_SPECULAR
	#ifdef LIT_LIGHTING
		#ifdef LIT_GGX_SPECULAR
			#ifdef LIT_ANISOTROPY
				#include "lightSpecularAnisoGGXPS"
			#else
				#include "lightSpecularGGXPS"
			#endif
		#else
			#include "lightSpecularBlinnPS"
		#endif
	#endif
#endif
#include "combinePS"
#ifdef LIT_LIGHTMAP
	#include "lightmapAddPS"
#endif
#ifdef LIT_ADD_AMBIENT
	#include "ambientPS"
#endif
#ifdef LIT_MSDF
	#include "msdfPS"
#endif
#ifdef LIT_NEEDS_NORMAL
	#include "viewDirPS"
	#ifdef LIT_SPECULAR
		#ifdef LIT_ANISOTROPY
			#include "reflDirAnisoPS"
		#else
			#include "reflDirPS"
		#endif
	#endif
#endif
#include "lightingPS"
`,litForwardPreCodePS:`
#include "basePS"
#include "sphericalPS"
#include "decodePS"
#include "gammaPS"
#include "tonemappingPS"
#include "fogPS"
#if LIT_NONE_SLICE_MODE == SLICED
	#include "baseNineSlicedPS"
#elif LIT_NONE_SLICE_MODE == TILED
	#include "baseNineSlicedTiledPS"
#endif
#ifdef LIT_TBN
	#include "TBNPS"
	#ifdef LIT_TWO_SIDED_LIGHTING
		#include "twoSidedLightingPS"
	#endif
#endif
`,litMainPS:`
#include "varyingsPS"
#include "litUserDeclarationPS"
#include "frontendDeclPS"
#if defined(PICK_PASS) || defined(PREPASS_PASS)
	#include "frontendCodePS"
	#include "litUserCodePS"
	#include "litOtherMainPS"
#elif defined(SHADOW_PASS)
	#include "frontendCodePS"
	#include "litUserCodePS"
	#include "litShadowMainPS"
#else
	#include "litForwardDeclarationPS"
	#include "litForwardPreCodePS"
	#include "frontendCodePS"
	#include "litForwardPostCodePS"
	#include "litForwardBackendPS"
	#include "litUserCodePS"
	#include "litForwardMainPS"
#endif
`,litMainVS:`
#include "varyingsVS"
#include  "litUserDeclarationVS"
#ifdef VERTEX_COLOR
	attribute vec4 vertex_color;
#endif
#ifdef NINESLICED
	varying vec2 vMask;
	varying vec2 vTiledUv;
	uniform mediump vec4 innerOffset;
	uniform mediump vec2 outerScale;
	uniform mediump vec4 atlasRect;
#endif
vec3 dPositionW;
mat4 dModelMatrix;
#include "transformCoreVS"
#ifdef UV0
	attribute vec2 vertex_texCoord0;
	#include "uv0VS"
#endif
#ifdef UV1
	attribute vec2 vertex_texCoord1;
	#include "uv1VS"
#endif
#ifdef LINEAR_DEPTH
	#ifndef VIEWMATRIX
	#define VIEWMATRIX
		uniform mat4 matrix_view;
	#endif
#endif
#include "transformVS"
#ifdef NORMALS
	#include "normalCoreVS"
	#include "normalVS"
#endif
#ifdef TANGENTS
	attribute vec4 vertex_tangent;
#endif
#include "uvTransformUniformsPS, UV_TRANSFORMS_COUNT"
#ifdef MSDF
	#include "msdfVS"
#endif
#include  "litUserCodeVS"
#ifdef VERTEX_COLOR
	vec3 decodeGamma(vec3 raw) {
		return pow(raw, vec3(2.2));
	}
	vec4 gammaCorrectInput(vec4 color) {
		return vec4(decodeGamma(color.xyz), color.w);
	}
#endif
void main(void) {
	#include "litUserMainStartVS"
	gl_PointSize = 1.0;
	gl_Position = getPosition();
	vPositionW = getWorldPosition();
	#ifdef NORMALS
		vNormalW = getNormal();
	#endif
	#ifdef TANGENTS
		vTangentW = normalize(dNormalMatrix * vertex_tangent.xyz);
		vBinormalW = cross(vNormalW, vTangentW) * vertex_tangent.w;
	#elif defined(GGX_SPECULAR)
		vObjectSpaceUpW = normalize(dNormalMatrix * vec3(0, 1, 0));
	#endif
	#ifdef UV0
		vec2 uv0 = getUv0();
		#ifdef UV0_UNMODIFIED
			vUv0 = uv0;
		#endif
	#endif
	#ifdef UV1
		vec2 uv1 = getUv1();
		#ifdef UV1_UNMODIFIED
			vUv1 = uv1;
		#endif
	#endif
	#include "uvTransformVS, UV_TRANSFORMS_COUNT"
	#ifdef VERTEX_COLOR
		#ifdef STD_VERTEX_COLOR_GAMMA
			vVertexColor = gammaCorrectInput(vertex_color);
		#else
			vVertexColor = vertex_color;
		#endif
	#endif
	#ifdef LINEAR_DEPTH
		vLinearDepth = -(matrix_view * vec4(vPositionW, 1.0)).z;
	#endif
	#ifdef MSDF
		unpackMsdfParams();
	#endif
	#include "litUserMainEndVS"
}
`,litOtherMainPS:`
#ifdef PICK_PASS
	#include "pickPS"
#endif
#ifdef PREPASS_PASS
	#include "floatAsUintPS"
#endif
void main(void) {
	#include "litUserMainStartPS"
	evaluateFrontend();
	#ifdef PICK_PASS
		pcFragColor0 = getPickOutput();
		#ifdef DEPTH_PICK_PASS
			pcFragColor1 = getPickDepth();
		#endif
	#endif
	#ifdef PREPASS_PASS
		gl_FragColor = float2vec4(vLinearDepth);
	#endif
	#include "litUserMainEndPS"
}
`,litShaderArgsPS:`
vec3 litArgs_albedo;
float litArgs_opacity;
vec3 litArgs_emission;
vec3 litArgs_worldNormal;
float litArgs_ao;
vec3 litArgs_lightmap;
vec3 litArgs_lightmapDir;
float litArgs_metalness;
vec3 litArgs_specularity;
float litArgs_specularityFactor;
float litArgs_gloss;
float litArgs_sheen_gloss;
vec3 litArgs_sheen_specularity;
float litArgs_transmission;
float litArgs_thickness;
float litArgs_ior;
float litArgs_dispersion;
float litArgs_iridescence_intensity;
float litArgs_iridescence_thickness;
vec3 litArgs_clearcoat_worldNormal;
float litArgs_clearcoat_specularity;
float litArgs_clearcoat_gloss;
`,litShaderCorePS:`
	#if LIT_NONE_SLICE_MODE == TILED
		const float textureBias = -1000.0;
	#else
		uniform float textureBias;
	#endif
	#include "litShaderArgsPS"
`,litShadowMainPS:`
#if LIGHT_TYPE != DIRECTIONAL
	uniform vec3 view_position;
	uniform float light_radius;
#endif
#if SHADOW_TYPE == PCSS_32F
	#include "linearizeDepthPS"
#endif
void main(void) {
	#include "litUserMainStartPS"
	evaluateFrontend();
	#ifdef PERSPECTIVE_DEPTH
		float depth = gl_FragCoord.z;
		#if SHADOW_TYPE == PCSS_32F
			#if LIGHT_TYPE != DIRECTIONAL
				depth = linearizeDepthWithParams(depth, camera_params);
			#endif
		#endif
	#else
		float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);
		#define MODIFIED_DEPTH
	#endif
	#if SHADOW_TYPE == VSM_16F || SHADOW_TYPE == VSM_32F
		#if SHADOW_TYPE == VSM_32F
			float exponent = 15.0;
		#else
			float exponent = 5.54;
		#endif
		depth = 2.0 * depth - 1.0;
		depth =  exp(exponent * depth);
		gl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);
	#else
		#if SHADOW_TYPE == PCSS_32F
			gl_FragColor.r = depth;
		#else
			#ifdef MODIFIED_DEPTH
				gl_FragDepth = depth;
			#endif
			gl_FragColor = vec4(1.0);
		#endif
	#endif
	#include "litUserMainEndPS"
}
`,litUserDeclarationPS:"",litUserDeclarationVS:"",litUserCodePS:"",litUserCodeVS:"",litUserMainStartPS:"",litUserMainStartVS:"",litUserMainEndPS:"",litUserMainEndVS:"",ltcPS:`
mat3 transposeMat3( const in mat3 m ) {
	mat3 tmp;
	tmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );
	tmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );
	tmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );
	return tmp;
}
vec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	float dotNV = saturate( dot( N, V ) );
	vec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );
	uv = uv * LUT_SCALE + LUT_BIAS;
	return uv;
}
float LTC_ClippedSphereFormFactor( const in vec3 f ) {
	float l = length( f );
	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );
}
vec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {
	float x = dot( v1, v2 );
	float y = abs( x );
	float a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;
	float b = 3.4175940 + ( 4.1616724 + y ) * y;
	float v = a / b;
	float theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;
	return cross( v1, v2 ) * theta_sintheta;
}
struct Coords {
	vec3 coord0;
	vec3 coord1;
	vec3 coord2;
	vec3 coord3;
};
float LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {
	vec3 v1 = rectCoords.coord1 - rectCoords.coord0;
	vec3 v2 = rectCoords.coord3 - rectCoords.coord0;
	
	vec3 lightNormal = cross( v1, v2 );
	float factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));
	vec3 T1, T2;
	T1 = normalize( V - N * dot( V, N ) );
	T2 =  factor * cross( N, T1 );
	mat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );
	vec3 coords[ 4 ];
	coords[ 0 ] = mat * ( rectCoords.coord0 - P );
	coords[ 1 ] = mat * ( rectCoords.coord1 - P );
	coords[ 2 ] = mat * ( rectCoords.coord2 - P );
	coords[ 3 ] = mat * ( rectCoords.coord3 - P );
	coords[ 0 ] = normalize( coords[ 0 ] );
	coords[ 1 ] = normalize( coords[ 1 ] );
	coords[ 2 ] = normalize( coords[ 2 ] );
	coords[ 3 ] = normalize( coords[ 3 ] );
	vec3 vectorFormFactor = vec3( 0.0 );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );
	float result = LTC_ClippedSphereFormFactor( vectorFormFactor );
	return result;
}
Coords dLTCCoords;
Coords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){
	Coords coords;
	coords.coord0 = lightPos + halfWidth - halfHeight;
	coords.coord1 = lightPos - halfWidth - halfHeight;
	coords.coord2 = lightPos - halfWidth + halfHeight;
	coords.coord3 = lightPos + halfWidth + halfHeight;
	return coords;
}
float dSphereRadius;
Coords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){
	dSphereRadius = max(length(halfWidth), length(halfHeight));
	vec3 f = reflect(normalize(lightPos - view_position), vNormalW);
	vec3 w = normalize(cross(f, halfHeight));
	vec3 h = normalize(cross(f, w));
	return getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);
}
vec2 dLTCUV;
#ifdef LIT_CLEARCOAT
	vec2 ccLTCUV;
#endif
vec2 getLTCLightUV(float gloss, vec3 worldNormal, vec3 viewDir)
{
	float roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);
	return LTC_Uv( worldNormal, viewDir, roughness );
}
vec3 dLTCSpecFres;
#ifdef LIT_CLEARCOAT
	vec3 ccLTCSpecFres;
#endif
vec3 getLTCLightSpecFres(vec2 uv, vec3 specularity)
{
	vec4 t2 = texture2DLod(areaLightsLutTex2, uv, 0.0);
	return specularity * t2.x + ( vec3( 1.0 ) - specularity) * t2.y;
}
void calcLTCLightValues(float gloss, vec3 worldNormal, vec3 viewDir, vec3 specularity, float clearcoatGloss, vec3 clearcoatWorldNormal, float clearcoatSpecularity)
{
	dLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);
	dLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity); 
#ifdef LIT_CLEARCOAT
	ccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);
	ccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(clearcoatSpecularity));
#endif
}
void calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight) {
	dLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);
}
void calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight) {
	calcRectLightValues(lightPos, halfWidth, halfHeight);
}
void calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight) {
	dLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);
}
vec3 SolveCubic(vec4 Coefficient)
{
	float pi = 3.14159;
	Coefficient.xyz /= Coefficient.w;
	Coefficient.yz /= 3.0;
	float A = Coefficient.w;
	float B = Coefficient.z;
	float C = Coefficient.y;
	float D = Coefficient.x;
	vec3 Delta = vec3(
		-Coefficient.z * Coefficient.z + Coefficient.y,
		-Coefficient.y * Coefficient.z + Coefficient.x,
		dot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)
	);
	float Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);
	vec2 xlc, xsc;
	{
		float A_a = 1.0;
		float C_a = Delta.x;
		float D_a = -2.0 * B * Delta.x + Delta.y;
		float Theta = atan(sqrt(Discriminant), -D_a) / 3.0;
		float x_1a = 2.0 * sqrt(-C_a) * cos(Theta);
		float x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);
		float xl;
		if ((x_1a + x_3a) > 2.0 * B)
			xl = x_1a;
		else
			xl = x_3a;
		xlc = vec2(xl - B, A);
	}
	{
		float A_d = D;
		float C_d = Delta.z;
		float D_d = -D * Delta.y + 2.0 * C * Delta.z;
		float Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;
		float x_1d = 2.0 * sqrt(-C_d) * cos(Theta);
		float x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);
		float xs;
		if (x_1d + x_3d < 2.0 * C)
			xs = x_1d;
		else
			xs = x_3d;
		xsc = vec2(-D, xs + C);
	}
	float E =  xlc.y * xsc.y;
	float F = -xlc.x * xsc.y - xlc.y * xsc.x;
	float G =  xlc.x * xsc.x;
	vec2 xmc = vec2(C * F - B * G, -B * F + C * E);
	vec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);
	if (Root.x < Root.y && Root.x < Root.z)
		Root.xyz = Root.yxz;
	else if (Root.z < Root.x && Root.z < Root.y)
		Root.xyz = Root.xzy;
	return Root;
}
float LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)
{
	vec3 T1 = normalize(V - N * dot(V, N));
	vec3 T2 = cross(N, T1);
	mat3 R = transposeMat3( mat3( T1, T2, N ) );
	vec3 L_[ 3 ];
	L_[ 0 ] = R * ( points.coord0 - P );
	L_[ 1 ] = R * ( points.coord1 - P );
	L_[ 2 ] = R * ( points.coord2 - P );
	vec3 C  = 0.5 * (L_[0] + L_[2]);
	vec3 V1 = 0.5 * (L_[1] - L_[2]);
	vec3 V2 = 0.5 * (L_[1] - L_[0]);
	C  = Minv * C;
	V1 = Minv * V1;
	V2 = Minv * V2;
	float a, b;
	float d11 = dot(V1, V1);
	float d22 = dot(V2, V2);
	float d12 = dot(V1, V2);
	if (abs(d12) / sqrt(d11 * d22) > 0.0001)
	{
		float tr = d11 + d22;
		float det = -d12 * d12 + d11 * d22;
		det = sqrt(det);
		float u = 0.5 * sqrt(tr - 2.0 * det);
		float v = 0.5 * sqrt(tr + 2.0 * det);
		float e_max = (u + v) * (u + v);
		float e_min = (u - v) * (u - v);
		vec3 V1_, V2_;
		if (d11 > d22)
		{
			V1_ = d12 * V1 + (e_max - d11) * V2;
			V2_ = d12 * V1 + (e_min - d11) * V2;
		}
		else
		{
			V1_ = d12*V2 + (e_max - d22)*V1;
			V2_ = d12*V2 + (e_min - d22)*V1;
		}
		a = 1.0 / e_max;
		b = 1.0 / e_min;
		V1 = normalize(V1_);
		V2 = normalize(V2_);
	}
	else
	{
		a = 1.0 / dot(V1, V1);
		b = 1.0 / dot(V2, V2);
		V1 *= sqrt(a);
		V2 *= sqrt(b);
	}
	vec3 V3 = normalize(cross(V1, V2));
	if (dot(C, V3) < 0.0)
		V3 *= -1.0;
	float L  = dot(V3, C);
	float x0 = dot(V1, C) / L;
	float y0 = dot(V2, C) / L;
	float E1 = inversesqrt(a);
	float E2 = inversesqrt(b);
	a *= L * L;
	b *= L * L;
	float c0 = a * b;
	float c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;
	float c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);
	float c3 = 1.0;
	vec3 roots = SolveCubic(vec4(c0, c1, c2, c3));
	float e1 = roots.x;
	float e2 = roots.y;
	float e3 = roots.z;
	vec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);
	mat3 rotate = mat3(V1, V2, V3);
	avgDir = rotate * avgDir;
	avgDir = normalize(avgDir);
	float L1 = sqrt(-e2 / e3);
	float L2 = sqrt(-e2 / e1);
	float formFactor = max(0.0, L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2)));
	
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	vec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);
	uv = uv*LUT_SCALE + LUT_BIAS;
	float scale = texture2DLod(areaLightsLutTex2, uv, 0.0).w;
	return formFactor*scale;
}
float FixNan(float value) {
	#ifdef WEBGPU
		return value != value ? 0.0 : value;
	#else
		return isnan(value) ? 0.0 : value;
	#endif
}
float getRectLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {
	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );
}
float getDiskLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {
	return FixNan(LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords ));
}
float getSphereLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {
	float falloff = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);
	return FixNan(getLightDiffuse(worldNormal, viewDir, lightDirNorm) * falloff);
}
mat3 getLTCLightInvMat(vec2 uv)
{
	vec4 t1 = texture2DLod(areaLightsLutTex1, uv, 0.0);
	return mat3(
		vec3( t1.x, 0, t1.y ),
		vec3(	0, 1,	0 ),
		vec3( t1.z, 0, t1.w )
	);
}
float calcRectLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {
	mat3 mInv = getLTCLightInvMat(uv);
	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );
}
float getRectLightSpecular(vec3 worldNormal, vec3 viewDir) {
	return calcRectLightSpecular(worldNormal, viewDir, dLTCUV);
}
float calcDiskLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {
	mat3 mInv = getLTCLightInvMat(uv);
	return LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );
}
float getDiskLightSpecular(vec3 worldNormal, vec3 viewDir) {
	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);
}
float getSphereLightSpecular(vec3 worldNormal, vec3 viewDir) {
	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);
}
`,metalnessPS:`
#ifdef STD_METALNESS_CONSTANT
uniform float material_metalness;
#endif
void getMetalness() {
	float metalness = 1.0;
	#ifdef STD_METALNESS_CONSTANT
	metalness *= material_metalness;
	#endif
	#ifdef STD_METALNESS_TEXTURE
	metalness *= texture2DBias({STD_METALNESS_TEXTURE_NAME}, {STD_METALNESS_TEXTURE_UV}, textureBias).{STD_METALNESS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_METALNESS_VERTEX
	metalness *= saturate(vVertexColor.{STD_METALNESS_VERTEX_CHANNEL});
	#endif
	dMetalness = metalness;
}
`,metalnessModulatePS:`
vec3 getSpecularModulate(in vec3 specularity, in vec3 albedo, in float metalness, in float f0, in float specularityFactor) {
	vec3 dielectricF0 = f0 * specularity * specularityFactor;
	return mix(dielectricF0, albedo, metalness);
}
vec3 getAlbedoModulate(in vec3 albedo, in float metalness) {
	return albedo * (1.0 - metalness);
}
`,morphPS:`
	varying vec2 uv0;
	uniform sampler2DArray morphTexture;
	uniform highp float morphFactor[{MORPH_TEXTURE_MAX_COUNT}];
	uniform highp uint morphIndex[{MORPH_TEXTURE_MAX_COUNT}];
	uniform int count;
	#ifdef MORPH_INT
		uniform vec3 aabbSize;
		uniform vec3 aabbMin;
	#endif
	void main (void) {
		highp vec3 color = vec3(0, 0, 0);
		ivec2 pixelCoords = ivec2(uv0 * vec2(textureSize(morphTexture, 0).xy));
		
		for (int i = 0; i < count; i++) {
			uint textureIndex = morphIndex[i];
			vec3 delta = texelFetch(morphTexture, ivec3(pixelCoords, int(textureIndex)), 0).xyz;
			color += morphFactor[i] * delta;
		}
		#ifdef MORPH_INT
			color = (color - aabbMin) / aabbSize * 65535.0;
			gl_FragColor = uvec4(color, 1u);
		#else
			gl_FragColor = vec4(color, 1.0);
		#endif
	}
`,morphVS:`
	attribute vec2 vertex_position;
	varying vec2 uv0;
	void main(void) {
		gl_Position = vec4(vertex_position, 0.5, 1.0);
		uv0 = vertex_position.xy * 0.5 + 0.5;
	}
`,msdfPS:`
uniform sampler2D texture_msdfMap;
float median(float r, float g, float b) {
	return max(min(r, g), min(max(r, g), b));
}
float map (float min, float max, float v) {
	return (v - min) / (max - min);
}
uniform float font_sdfIntensity;
uniform float font_pxrange;
uniform float font_textureWidth;
#ifndef LIT_MSDF_TEXT_ATTRIBUTE
	uniform vec4 outline_color;
	uniform float outline_thickness;
	uniform vec4 shadow_color;
	uniform vec2 shadow_offset;
#else
	varying vec4 outline_color;
	varying float outline_thickness;
	varying vec4 shadow_color;
	varying vec2 shadow_offset;
#endif
vec4 applyMsdf(vec4 color) {
	color.rgb = gammaCorrectInput(color.rgb);
	vec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;
	vec2 uvShdw = vUv0 - shadow_offset;
	vec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;
	float sigDist = median(tsample.r, tsample.g, tsample.b);
	float sigDistShdw = median(ssample.r, ssample.g, ssample.b);
	float smoothingMax = 0.2;
	vec2 w = fwidth(vUv0);
	float smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, smoothingMax);
	float mapMin = 0.05;
	float mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);
	float sigDistInner = map(mapMin, mapMax, sigDist);
	float sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);
	sigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);
	float center = 0.5;
	float inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);
	float outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);
	float shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);
	vec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);
	tcolor = mix(tcolor, color, inside);
	vec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;
	tcolor = mix(scolor, tcolor, outline);
	tcolor.rgb = gammaCorrectOutput(tcolor.rgb);
	
	return tcolor;
}
`,msdfVS:`
attribute vec3 vertex_outlineParameters;
attribute vec3 vertex_shadowParameters;
varying vec4 outline_color;
varying float outline_thickness;
varying vec4 shadow_color;
varying vec2 shadow_offset;
void unpackMsdfParams() {
	vec3 little = mod(vertex_outlineParameters, 256.);
	vec3 big = (vertex_outlineParameters - little) / 256.;
	outline_color.rb = little.xy / 255.;
	outline_color.ga = big.xy / 255.;
	outline_thickness = little.z / 255. * 0.2;
	little = mod(vertex_shadowParameters, 256.);
	big = (vertex_shadowParameters - little) / 256.;
	shadow_color.rb = little.xy / 255.;
	shadow_color.ga = big.xy / 255.;
	shadow_offset = (vec2(little.z, big.z) / 127. - 1.) * 0.005;
}
`,normalVS:`
mat3 dNormalMatrix;
vec3 getNormal() {
	dNormalMatrix = getNormalMatrix(dModelMatrix);
	vec3 localNormal = getLocalNormal(vertex_normal);
	return normalize(dNormalMatrix * localNormal);
}
`,normalCoreVS:`
attribute vec3 vertex_normal;
uniform mat3 matrix_normal;
#ifdef MORPHING_NORMAL
	#ifdef MORPHING_INT
		uniform highp usampler2D morphNormalTex;
	#else
		uniform highp sampler2D morphNormalTex;
	#endif
#endif
vec3 getLocalNormal(vec3 vertexNormal) {
	vec3 localNormal = vertex_normal;
	#ifdef MORPHING_NORMAL
		ivec2 morphUV = getTextureMorphCoords();
		#ifdef MORPHING_INT
			vec3 morphNormal = vec3(texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz) / 65535.0 * 2.0 - 1.0;
		#else
			vec3 morphNormal = texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz;
		#endif
		localNormal += morphNormal;
	#endif
	return localNormal;
}
#if defined(SKIN) || defined(BATCH)
	mat3 getNormalMatrix(mat4 modelMatrix) {
		return mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);
	}
#elif defined(INSTANCING)
	mat3 getNormalMatrix(mat4 modelMatrix) {
		return mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);
	}
#else
	mat3 getNormalMatrix(mat4 modelMatrix) {
		return matrix_normal;
	}
#endif
`,normalMapPS:`
#ifdef STD_NORMAL_TEXTURE
	uniform float material_bumpiness;
#endif
#ifdef STD_NORMALDETAIL_TEXTURE
	uniform float material_normalDetailMapBumpiness;
	vec3 blendNormals(vec3 n1, vec3 n2) {
		n1 += vec3(0, 0, 1);
		n2 *= vec3(-1, -1, 1);
		return n1 * dot(n1, n2) / n1.z - n2;
	}
#endif
void getNormal() {
#ifdef STD_NORMAL_TEXTURE
	vec3 normalMap = {STD_NORMAL_TEXTURE_DECODE}(texture2DBias({STD_NORMAL_TEXTURE_NAME}, {STD_NORMAL_TEXTURE_UV}, textureBias));
	normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);
	#ifdef STD_NORMALDETAIL_TEXTURE
		vec3 normalDetailMap = {STD_NORMALDETAIL_TEXTURE_DECODE}(texture2DBias({STD_NORMALDETAIL_TEXTURE_NAME}, {STD_NORMALDETAIL_TEXTURE_UV}, textureBias));
		normalDetailMap = mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness);
		normalMap = blendNormals(normalMap, normalDetailMap);
	#endif
	dNormalW = normalize(dTBN * normalMap);
#else
	dNormalW = dVertexNormalW;
#endif
}
`,opacityPS:`
uniform float material_opacity;
void getOpacity() {
	dAlpha = material_opacity;
	#ifdef STD_OPACITY_TEXTURE
	dAlpha *= texture2DBias({STD_OPACITY_TEXTURE_NAME}, {STD_OPACITY_TEXTURE_UV}, textureBias).{STD_OPACITY_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_OPACITY_VERTEX
	dAlpha *= clamp(vVertexColor.{STD_OPACITY_VERTEX_CHANNEL}, 0.0, 1.0);
	#endif
}
`,opacityDitherPS:`
#if STD_OPACITY_DITHER == BAYER8
	#include "bayerPS"
#endif
uniform vec4 blueNoiseJitter;
#if STD_OPACITY_DITHER == BLUENOISE
	uniform sampler2D blueNoiseTex32;
#endif
void opacityDither(float alpha, float id) {
	#if STD_OPACITY_DITHER == BAYER8
		float noise = bayer8(floor(mod(gl_FragCoord.xy + blueNoiseJitter.xy + id, 8.0))) / 64.0;
	#else
		#if STD_OPACITY_DITHER == BLUENOISE
			vec2 uv = fract(gl_FragCoord.xy / 32.0 + blueNoiseJitter.xy + id);
			float noise = texture2DLod(blueNoiseTex32, uv, 0.0).y;
		#endif
		#if STD_OPACITY_DITHER == IGNNOISE
			vec3 magic = vec3(0.06711056, 0.00583715, 52.9829189);
			float noise = fract(magic.z * fract(dot(gl_FragCoord.xy + blueNoiseJitter.xy + id, magic.xy)));
		#endif
	#endif
	noise = pow(noise, 2.2);
	if (alpha < noise)
		discard;
}
`,outputPS:`
`,outputAlphaPS:`
#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == ADDITIVEALPHA || defined(LIT_ALPHA_TO_COVERAGE)
	gl_FragColor.a = litArgs_opacity;
#elif LIT_BLEND_TYPE == PREMULTIPLIED
	gl_FragColor.rgb *= litArgs_opacity;
	gl_FragColor.a = litArgs_opacity;
#else
	gl_FragColor.a = 1.0;
#endif
`,outputTex2DPS:`
varying vec2 vUv0;
uniform sampler2D source;
void main(void) {
	gl_FragColor = texture2D(source, vUv0);
}
`,sheenPS:`
uniform vec3 material_sheen;
void getSheen() {
	vec3 sheenColor = material_sheen;
	#ifdef STD_SHEEN_TEXTURE
	sheenColor *= {STD_SHEEN_TEXTURE_DECODE}(texture2DBias({STD_SHEEN_TEXTURE_NAME}, {STD_SHEEN_TEXTURE_UV}, textureBias)).{STD_SHEEN_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SHEEN_VERTEX
	sheenColor *= saturate(vVertexColor.{STD_SHEEN_VERTEX_CHANNEL});
	#endif
	sSpecularity = sheenColor;
}
`,sheenGlossPS:`
uniform float material_sheenGloss;
void getSheenGlossiness() {
	float sheenGlossiness = material_sheenGloss;
	#ifdef STD_SHEENGLOSS_TEXTURE
	sheenGlossiness *= texture2DBias({STD_SHEENGLOSS_TEXTURE_NAME}, {STD_SHEENGLOSS_TEXTURE_UV}, textureBias).{STD_SHEENGLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SHEENGLOSS_VERTEX
	sheenGlossiness *= saturate(vVertexColor.{STD_SHEENGLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_SHEENGLOSS_INVERT
	sheenGlossiness = 1.0 - sheenGlossiness;
	#endif
	sGlossiness = sheenGlossiness + 0.0000001;
}
`,parallaxPS:`
uniform float material_heightMapFactor;
void getParallax() {
	float parallaxScale = material_heightMapFactor;
	float height = texture2DBias({STD_HEIGHT_TEXTURE_NAME}, {STD_HEIGHT_TEXTURE_UV}, textureBias).{STD_HEIGHT_TEXTURE_CHANNEL};
	height = height * parallaxScale - parallaxScale * 0.5;
	vec3 viewDirT = dViewDirW * dTBN;
	viewDirT.z += 0.42;
	dUvOffset = height * (viewDirT.xy / viewDirT.z);
}
`,pickPS:`
vec4 encodePickOutput(uint id) {
	const vec4 inv = vec4(1.0 / 255.0);
	const uvec4 shifts = uvec4(16, 8, 0, 24);
	uvec4 col = (uvec4(id) >> shifts) & uvec4(0xff);
	return vec4(col) * inv;
}
#ifndef PICK_CUSTOM_ID
	uniform uint meshInstanceId;
	vec4 getPickOutput() {
		return encodePickOutput(meshInstanceId);
	}
#endif
#ifdef DEPTH_PICK_PASS
	#include "floatAsUintPS"
	vec4 getPickDepth() {
		return float2uint(gl_FragCoord.z);
	}
#endif
`,reflDirPS:`
void getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {
	dReflDirW = normalize(-reflect(viewDir, worldNormal));
}
`,reflDirAnisoPS:`
void getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {
	float roughness = sqrt(1.0 - min(gloss, 1.0));
	vec2 direction = dAnisotropyRotation;
	vec3 anisotropicT = normalize(tbn * vec3(direction, 0.0));
	vec3 anisotropicB = normalize(cross(tbn[2], anisotropicT));
	float anisotropy = dAnisotropy;
	vec3 anisotropicDirection = anisotropicB;
	vec3 anisotropicTangent = cross(anisotropicDirection, viewDir);
	vec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);
	float bendFactor = 1.0 - anisotropy * (1.0 - roughness);
	float bendFactor4 = bendFactor * bendFactor * bendFactor * bendFactor;
	vec3 bentNormal = normalize(mix(normalize(anisotropicNormal), normalize(worldNormal), bendFactor4));
	dReflDirW = reflect(-viewDir, bentNormal);
}
`,reflectionCCPS:`
#ifdef LIT_CLEARCOAT
void addReflectionCC(vec3 reflDir, float gloss) {
	ccReflection += calcReflection(reflDir, gloss);
}
#endif
`,reflectionCubePS:`
uniform samplerCube texture_cubeMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 lookupVec = cubeMapProject(reflDir);
	lookupVec.x *= -1.0;
	return {reflectionDecode}(textureCube(texture_cubeMap, lookupVec));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`,reflectionEnvHQPS:`
#ifndef ENV_ATLAS
	#define ENV_ATLAS
	uniform sampler2D texture_envAtlas;
#endif
uniform samplerCube texture_cubeMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);
	vec2 uv = toSphericalUv(dir);
	float level = saturate(1.0 - gloss) * 5.0;
	float ilevel = floor(level);
	float flevel = level - ilevel;
	vec3 sharp = {reflectionCubemapDecode}(textureCube(texture_cubeMap, dir));
	vec3 roughA = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel)));
	vec3 roughB = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));
	return processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`,reflectionEnvPS:`
#ifndef ENV_ATLAS
#define ENV_ATLAS
	uniform sampler2D texture_envAtlas;
#endif
uniform float material_reflectivity;
float shinyMipLevel(vec2 uv) {
	vec2 dx = dFdx(uv);
	vec2 dy = dFdy(uv);
	vec2 uv2 = vec2(fract(uv.x + 0.5), uv.y);
	vec2 dx2 = dFdx(uv2);
	vec2 dy2 = dFdy(uv2);
	float maxd = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));
	return clamp(0.5 * log2(maxd) - 1.0 + textureBias, 0.0, 5.0);
}
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);
	vec2 uv = toSphericalUv(dir);
	float level = saturate(1.0 - gloss) * 5.0;
	float ilevel = floor(level);
	float level2 = shinyMipLevel(uv * atlasSize);
	float ilevel2 = floor(level2);
	vec2 uv0, uv1;
	float weight;
	if (ilevel == 0.0) {
		uv0 = mapShinyUv(uv, ilevel2);
		uv1 = mapShinyUv(uv, ilevel2 + 1.0);
		weight = level2 - ilevel2;
	} else {
		uv0 = uv1 = mapRoughnessUv(uv, ilevel);
		weight = 0.0;
	}
	vec3 linearA = {reflectionDecode}(texture2D(texture_envAtlas, uv0));
	vec3 linearB = {reflectionDecode}(texture2D(texture_envAtlas, uv1));
	vec3 linear0 = mix(linearA, linearB, weight);
	vec3 linear1 = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));
	return processEnvironment(mix(linear0, linear1, level - ilevel));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`,reflectionSpherePS:`
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform mat4 matrix_view;
#endif
uniform sampler2D texture_sphereMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 reflDir, float gloss) {
	vec3 reflDirV = (mat3(matrix_view) * reflDir);
	float m = 2.0 * sqrt(dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z + 1.0) * (reflDirV.z + 1.0));
	vec2 sphereMapUv = reflDirV.xy / m + 0.5;
	return {reflectionDecode}(texture2D(texture_sphereMap, sphereMapUv));
}
void addReflection(vec3 reflDir, float gloss) {   
	dReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);
}
`,reflectionSheenPS:`
void addReflectionSheen(vec3 worldNormal, vec3 viewDir, float gloss) {
	float NoV = dot(worldNormal, viewDir);
	float alphaG = gloss * gloss;
	float a = gloss < 0.25 ? -339.2 * alphaG + 161.4 * gloss - 25.9 : -8.48 * alphaG + 14.3 * gloss - 9.95;
	float b = gloss < 0.25 ? 44.0 * alphaG - 23.7 * gloss + 3.26 : 1.97 * alphaG - 3.27 * gloss + 0.72;
	float DG = exp( a * NoV + b ) + ( gloss < 0.25 ? 0.0 : 0.1 * ( gloss - 0.25 ) );
	sReflection += calcReflection(worldNormal, 0.0) * saturate(DG);
}
`,refractionCubePS:`
vec3 refract2(vec3 viewVec, vec3 normal, float IOR) {
	float vn = dot(viewVec, normal);
	float k = 1.0 - IOR * IOR * (1.0 - vn * vn);
	vec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;
	return refrVec;
}
void addRefraction(
	vec3 worldNormal, 
	vec3 viewDir, 
	float thickness, 
	float gloss, 
	vec3 specularity, 
	vec3 albedo, 
	float transmission,
	float refractionIndex,
	float dispersion
#if defined(LIT_IRIDESCENCE)
	, vec3 iridescenceFresnel,
	float iridescenceIntensity
#endif 
) {
	vec4 tmpRefl = dReflection;
	vec3 reflectionDir = refract2(-viewDir, worldNormal, refractionIndex);
	dReflection = vec4(0);
	addReflection(reflectionDir, gloss);
	dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);
	dReflection = tmpRefl;
}
`,refractionDynamicPS:`
uniform float material_invAttenuationDistance;
uniform vec3 material_attenuation;
vec3 evalRefractionColor(vec3 refractionVector, float gloss, float refractionIndex) {
	vec4 pointOfRefraction = vec4(vPositionW + refractionVector, 1.0);
	vec4 projectionPoint = matrix_viewProjection * pointOfRefraction;
	vec2 uv = getGrabScreenPos(projectionPoint);
	float iorToRoughness = (1.0 - gloss) * clamp((1.0 / refractionIndex) * 2.0 - 2.0, 0.0, 1.0);
	float refractionLod = log2(uScreenSize.x) * iorToRoughness;
	vec3 refraction = texture2DLod(uSceneColorMap, uv, refractionLod).rgb;
	#ifdef SCENE_COLORMAP_GAMMA
		refraction = decodeGamma(refraction);
	#endif
	return refraction;
}
void addRefraction(
	vec3 worldNormal, 
	vec3 viewDir, 
	float thickness, 
	float gloss, 
	vec3 specularity, 
	vec3 albedo, 
	float transmission,
	float refractionIndex,
	float dispersion
#if defined(LIT_IRIDESCENCE)
	, vec3 iridescenceFresnel,
	float iridescenceIntensity
#endif
) {
	vec3 modelScale;
	modelScale.x = length(vec3(matrix_model[0].xyz));
	modelScale.y = length(vec3(matrix_model[1].xyz));
	modelScale.z = length(vec3(matrix_model[2].xyz));
	vec3 scale = thickness * modelScale;
	vec3 refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndex)) * scale;
	vec3 refraction = evalRefractionColor(refractionVector, gloss, refractionIndex);
	#ifdef LIT_DISPERSION
		float halfSpread = (1.0 / refractionIndex - 1.0) * 0.025 * dispersion;
		float refractionIndexR = refractionIndex - halfSpread;
		refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexR)) * scale;
		refraction.r = evalRefractionColor(refractionVector, gloss, refractionIndexR).r;
		float refractionIndexB = refractionIndex + halfSpread;
		refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexB)) * scale;
		refraction.b = evalRefractionColor(refractionVector, gloss, refractionIndexB).b;
	#endif
	vec3 transmittance;
	if (material_invAttenuationDistance != 0.0)
	{
		vec3 attenuation = -log(material_attenuation) * material_invAttenuationDistance;
		transmittance = exp(-attenuation * length(refractionVector));
	}
	else
	{
		transmittance = vec3(1.0);
	}
	vec3 fresnel = vec3(1.0) - 
		getFresnel(
			dot(viewDir, worldNormal), 
			gloss, 
			specularity
		#if defined(LIT_IRIDESCENCE)
			, iridescenceFresnel,
			iridescenceIntensity
		#endif
		);
	dDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);
}
`,reprojectPS:`
varying vec2 vUv0;
#ifdef CUBEMAP_SOURCE
	uniform samplerCube sourceCube;
#else
	uniform sampler2D sourceTex;
#endif
#ifdef USE_SAMPLES_TEX
	uniform sampler2D samplesTex;
	uniform vec2 samplesTexInverseSize;
#endif
uniform vec3 params;
float targetFace() { return params.x; }
float targetTotalPixels() { return params.y; }
float sourceTotalPixels() { return params.z; }
float PI = 3.141592653589793;
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
#include "decodePS"
#include "encodePS"
vec3 modifySeams(vec3 dir, float scale) {
	vec3 adir = abs(dir);
	float M = max(max(adir.x, adir.y), adir.z);
	return dir / M * vec3(
		adir.x == M ? 1.0 : scale,
		adir.y == M ? 1.0 : scale,
		adir.z == M ? 1.0 : scale
	);
}
vec2 toSpherical(vec3 dir) {
	return vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));
}
vec3 fromSpherical(vec2 uv) {
	return vec3(cos(uv.y) * sin(uv.x),
				sin(uv.y),
				cos(uv.y) * cos(uv.x));
}
vec3 getDirectionEquirect() {
	return fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));
}
float signNotZero(float k){
	return(k >= 0.0) ? 1.0 : -1.0;
}
vec2 signNotZero(vec2 v) {
	return vec2(signNotZero(v.x), signNotZero(v.y));
}
vec3 octDecode(vec2 o) {
	vec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);
	if (v.y < 0.0) {
		v.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);
	}
	return normalize(v);
}
vec3 getDirectionOctahedral() {
	return octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);
}
vec2 octEncode(in vec3 v) {
	float l1norm = abs(v.x) + abs(v.y) + abs(v.z);
	vec2 result = v.xz * (1.0 / l1norm);
	if (v.y < 0.0) {
		result = (1.0 - abs(result.yx)) * signNotZero(result.xy);
	}
	return result;
}
#ifdef CUBEMAP_SOURCE
	vec4 sampleCubemap(vec3 dir) {
		return textureCube(sourceCube, modifySeams(dir, 1.0));
	}
	vec4 sampleCubemap(vec2 sph) {
		return sampleCubemap(fromSpherical(sph));
	}
	vec4 sampleCubemap(vec3 dir, float mipLevel) {
		return textureCubeLod(sourceCube, modifySeams(dir, 1.0), mipLevel);
	}
	vec4 sampleCubemap(vec2 sph, float mipLevel) {
		return sampleCubemap(fromSpherical(sph), mipLevel);
	}
#else
	vec4 sampleEquirect(vec2 sph) {
		vec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;
		return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));
	}
	vec4 sampleEquirect(vec3 dir) {
		return sampleEquirect(toSpherical(dir));
	}
	vec4 sampleEquirect(vec2 sph, float mipLevel) {
		vec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;
		return texture2DLod(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);
	}
	vec4 sampleEquirect(vec3 dir, float mipLevel) {
		return sampleEquirect(toSpherical(dir), mipLevel);
	}
	vec4 sampleOctahedral(vec3 dir) {
		vec2 uv = octEncode(dir) * 0.5 + 0.5;
		return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));
	}
	vec4 sampleOctahedral(vec2 sph) {
		return sampleOctahedral(fromSpherical(sph));
	}
	vec4 sampleOctahedral(vec3 dir, float mipLevel) {
		vec2 uv = octEncode(dir) * 0.5 + 0.5;
		return texture2DLod(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);
	}
	vec4 sampleOctahedral(vec2 sph, float mipLevel) {
		return sampleOctahedral(fromSpherical(sph), mipLevel);
	}
#endif
vec3 getDirectionCubemap() {
	vec2 st = vUv0 * 2.0 - 1.0;
	float face = targetFace();
	vec3 vec;
	if (face == 0.0) {
		vec = vec3(1, -st.y, -st.x);
	} else if (face == 1.0) {
		vec = vec3(-1, -st.y, st.x);
	} else if (face == 2.0) {
		vec = vec3(st.x, 1, st.y);
	} else if (face == 3.0) {
		vec = vec3(st.x, -1, -st.y);
	} else if (face == 4.0) {
		vec = vec3(st.x, -st.y, 1);
	} else {
		vec = vec3(-st.x, -st.y, -1);
	}
	return normalize(modifySeams(vec, 1.0));
}
mat3 matrixFromVector(vec3 n) {
	float a = 1.0 / (1.0 + n.z);
	float b = -n.x * n.y * a;
	vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);
	vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);
	return mat3(b1, b2, n);
}
mat3 matrixFromVectorSlow(vec3 n) {
	vec3 up = (1.0 - abs(n.y) <= 0.0000001) ? vec3(0.0, 0.0, n.y > 0.0 ? 1.0 : -1.0) : vec3(0.0, 1.0, 0.0);
	vec3 x = normalize(cross(up, n));
	vec3 y = cross(n, x);
	return mat3(x, y, n);
}
vec4 reproject() {
	if ({NUM_SAMPLES} <= 1) {
		return {ENCODE_FUNC}({DECODE_FUNC}({SOURCE_FUNC}({TARGET_FUNC}())));
	} else {
		vec3 t = {TARGET_FUNC}();
		vec3 tu = dFdx(t);
		vec3 tv = dFdy(t);
		vec3 result = vec3(0.0);
		for (float u = 0.0; u < {NUM_SAMPLES_SQRT}; ++u) {
			for (float v = 0.0; v < {NUM_SAMPLES_SQRT}; ++v) {
				result += {DECODE_FUNC}({SOURCE_FUNC}(normalize(t +
															tu * (u / {NUM_SAMPLES_SQRT} - 0.5) +
															tv * (v / {NUM_SAMPLES_SQRT} - 0.5))));
			}
		}
		return {ENCODE_FUNC}(result / ({NUM_SAMPLES_SQRT} * {NUM_SAMPLES_SQRT}));
	}
}
vec4 unpackFloat = vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);
#ifdef USE_SAMPLES_TEX
	void unpackSample(int i, out vec3 L, out float mipLevel) {
		float u = (float(i * 4) + 0.5) * samplesTexInverseSize.x;
		float v = (floor(u) + 0.5) * samplesTexInverseSize.y;
		vec4 raw;
		raw.x = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
		raw.y = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
		raw.z = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
		raw.w = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat);
		L.xyz = raw.xyz * 2.0 - 1.0;
		mipLevel = raw.w * 8.0;
	}
	vec4 prefilterSamples() {
		mat3 vecSpace = matrixFromVectorSlow({TARGET_FUNC}());
		vec3 L;
		float mipLevel;
		vec3 result = vec3(0.0);
		float totalWeight = 0.0;
		for (int i = 0; i < {NUM_SAMPLES}; ++i) {
			unpackSample(i, L, mipLevel);
			result += {DECODE_FUNC}({SOURCE_FUNC}(vecSpace * L, mipLevel)) * L.z;
			totalWeight += L.z;
		}
		return {ENCODE_FUNC}(result / totalWeight);
	}
	vec4 prefilterSamplesUnweighted() {
		mat3 vecSpace = matrixFromVectorSlow({TARGET_FUNC}());
		vec3 L;
		float mipLevel;
		vec3 result = vec3(0.0);
		float totalWeight = 0.0;
		for (int i = 0; i < {NUM_SAMPLES}; ++i) {
			unpackSample(i, L, mipLevel);
			result += {DECODE_FUNC}({SOURCE_FUNC}(vecSpace * L, mipLevel));
		}
		return {ENCODE_FUNC}(result / float({NUM_SAMPLES}));
	}
#endif
void main(void) {
	gl_FragColor = {PROCESS_FUNC}();
}
`,reprojectVS:`
attribute vec2 vertex_position;
uniform vec4 uvMod;
varying vec2 vUv0;
void main(void) {
	gl_Position = vec4(vertex_position, 0.5, 1.0);
	vUv0 = getImageEffectUV((vertex_position.xy * 0.5 + 0.5) * uvMod.xy + uvMod.zw);
}
`,screenDepthPS:`
uniform highp sampler2D uSceneDepthMap;
#ifndef SCREENSIZE
	#define SCREENSIZE
	uniform vec4 uScreenSize;
#endif
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform mat4 matrix_view;
#endif
#ifndef LINEARIZE_DEPTH
	#define LINEARIZE_DEPTH
	
	#ifndef CAMERAPLANES
		#define CAMERAPLANES
		uniform vec4 camera_params;
	#endif
	float linearizeDepth(float z) {
		if (camera_params.w == 0.0)
			return (camera_params.z * camera_params.y) / (camera_params.y + z * (camera_params.z - camera_params.y));
		else
			return camera_params.z + z * (camera_params.y - camera_params.z);
	}
#endif
float delinearizeDepth(float linearDepth) {
	if (camera_params.w == 0.0) {
		return (camera_params.y * (camera_params.z - linearDepth)) / (linearDepth * (camera_params.z - camera_params.y));
	} else {
		return (linearDepth - camera_params.z) / (camera_params.y - camera_params.z);
	}
}
float getLinearScreenDepth(vec2 uv) {
	#ifdef SCENE_DEPTHMAP_LINEAR
		#ifdef SCENE_DEPTHMAP_FLOAT
			return texture2D(uSceneDepthMap, uv).r;
		#else
			ivec2 textureSize = textureSize(uSceneDepthMap, 0);
			ivec2 texel = ivec2(uv * vec2(textureSize));
			vec4 data = texelFetch(uSceneDepthMap, texel, 0);
			uint intBits = 
				(uint(data.r * 255.0) << 24u) |
				(uint(data.g * 255.0) << 16u) |
				(uint(data.b * 255.0) << 8u) |
				uint(data.a * 255.0);
			return uintBitsToFloat(intBits);
		#endif
	#else
		return linearizeDepth(texture2D(uSceneDepthMap, uv).r);
	#endif
}
#ifndef VERTEXSHADER
	float getLinearScreenDepth() {
		vec2 uv = gl_FragCoord.xy * uScreenSize.zw;
		return getLinearScreenDepth(uv);
	}
#endif
float getLinearDepth(vec3 pos) {
	return -(matrix_view * vec4(pos, 1.0)).z;
}
`,shadowCascadesPS:`
int getShadowCascadeIndex(vec4 shadowCascadeDistances, int shadowCascadeCount) {
	float depth = 1.0 / gl_FragCoord.w;
	vec4 comparisons = step(shadowCascadeDistances, vec4(depth));
	int cascadeIndex = int(dot(comparisons, vec4(1.0)));
	return min(cascadeIndex, shadowCascadeCount - 1);
}
int ditherShadowCascadeIndex(int cascadeIndex, vec4 shadowCascadeDistances, int shadowCascadeCount, float blendFactor) {
 
	if (cascadeIndex < shadowCascadeCount - 1) {
		float currentRangeEnd = shadowCascadeDistances[cascadeIndex];
		float transitionStart = blendFactor * currentRangeEnd;
		float depth = 1.0 / gl_FragCoord.w;
		if (depth > transitionStart) {
			float transitionFactor = smoothstep(transitionStart, currentRangeEnd, depth);
			float dither = fract(sin(dot(gl_FragCoord.xy, vec2(12.9898, 78.233))) * 43758.5453);
			if (dither < transitionFactor) {
				cascadeIndex += 1;
			}
		}
	}
	return cascadeIndex;
}
vec3 fadeShadow(vec3 shadowCoord, vec4 shadowCascadeDistances) {				  
	float depth = 1.0 / gl_FragCoord.w;
	if (depth > shadowCascadeDistances.w) {
		shadowCoord.z = -9999999.0;
	}
	return shadowCoord;
}
`,shadowEVSMPS:`
float linstep(float a, float b, float v) {
	return saturate((v - a) / (b - a));
}
float reduceLightBleeding(float pMax, float amount) {
	 return linstep(amount, 1.0, pMax);
}
float chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {
	float variance = moments.y - (moments.x * moments.x);
	variance = max(variance, minVariance);
	float d = mean - moments.x;
	float pMax = variance / (variance + (d * d));
	pMax = reduceLightBleeding(pMax, lightBleedingReduction);
	return (mean <= moments.x ? 1.0 : pMax);
}
float calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {
	Z = 2.0 * Z - 1.0;
	float warpedDepth = exp(exponent * Z);
	moments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);
	float VSMBias = vsmBias;
	float depthScale = VSMBias * exponent * warpedDepth;
	float minVariance1 = depthScale * depthScale;
	return chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);
}
float VSM16(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {
	vec3 moments = texture2DLod(tex, texCoords, 0.0).xyz;
	return calculateEVSM(moments, Z, vsmBias, exponent);
}
float getShadowVSM16(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent) {
	return VSM16(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);
}
float getShadowSpotVSM16(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {
	return VSM16(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);
}
float VSM32(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {
	#ifdef CAPS_TEXTURE_FLOAT_FILTERABLE
		vec3 moments = texture2DLod(tex, texCoords, 0.0).xyz;
	#else
		float pixelSize = 1.0 / resolution;
		texCoords -= vec2(pixelSize);
		vec3 s00 = texture2DLod(tex, texCoords, 0.0).xyz;
		vec3 s10 = texture2DLod(tex, texCoords + vec2(pixelSize, 0), 0.0).xyz;
		vec3 s01 = texture2DLod(tex, texCoords + vec2(0, pixelSize), 0.0).xyz;
		vec3 s11 = texture2DLod(tex, texCoords + vec2(pixelSize), 0.0).xyz;
		vec2 fr = fract(texCoords * resolution);
		vec3 h0 = mix(s00, s10, fr.x);
		vec3 h1 = mix(s01, s11, fr.x);
		vec3 moments = mix(h0, h1, fr.y);
	#endif
	return calculateEVSM(moments, Z, vsmBias, exponent);
}
float getShadowVSM32(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent) {
	return VSM32(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);
}
float getShadowSpotVSM32(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {
	float Z = length(lightDir) * shadowParams.w + shadowParams.z;
	return VSM32(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, Z, shadowParams.y, exponent);
}
`,shadowPCF1PS:`
float getShadowPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return textureShadow(shadowMap, shadowCoord);
}
float getShadowSpotPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return textureShadow(shadowMap, shadowCoord);
}
#ifndef WEBGPU
float getShadowOmniPCF1x1(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {
	float shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;
	return texture(shadowMap, vec4(lightDir, shadowZ));
}
#endif
`,shadowPCF3PS:`
float _getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {
	float z = shadowCoord.z;
	vec2 uv = shadowCoord.xy * shadowParams.x;
	float shadowMapSizeInv = 1.0 / shadowParams.x;
	vec2 base_uv = floor(uv + 0.5);
	float s = (uv.x + 0.5 - base_uv.x);
	float t = (uv.y + 0.5 - base_uv.y); 
	base_uv -= vec2(0.5);
	base_uv *= shadowMapSizeInv;
	float sum = 0.0;
	float uw0 = (3.0 - 2.0 * s);
	float uw1 = (1.0 + 2.0 * s);
	float u0 = (2.0 - s) / uw0 - 1.0;
	float u1 = s / uw1 + 1.0;
	float vw0 = (3.0 - 2.0 * t);
	float vw1 = (1.0 + 2.0 * t);
	float v0 = (2.0 - t) / vw0 - 1.0;
	float v1 = t / vw1 + 1.0;
	u0 = u0 * shadowMapSizeInv + base_uv.x;
	v0 = v0 * shadowMapSizeInv + base_uv.y;
	u1 = u1 * shadowMapSizeInv + base_uv.x;
	v1 = v1 * shadowMapSizeInv + base_uv.y;
	sum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));
	sum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));
	sum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));
	sum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));
	sum *= 1.0f / 16.0;
	return sum;
}
float getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
float getShadowSpotPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
#ifndef WEBGPU
float getShadowOmniPCF3x3(samplerCubeShadow shadowMap, vec4 shadowParams, vec3 dir) {
	
	float shadowZ = length(dir) * shadowParams.w + shadowParams.z;
	float z = 1.0 / float(textureSize(shadowMap, 0));
	vec3 tc = normalize(dir);
	mediump vec4 shadows;
	shadows.x = texture(shadowMap, vec4(tc + vec3( z, z, z), shadowZ));
	shadows.y = texture(shadowMap, vec4(tc + vec3(-z,-z, z), shadowZ));
	shadows.z = texture(shadowMap, vec4(tc + vec3(-z, z,-z), shadowZ));
	shadows.w = texture(shadowMap, vec4(tc + vec3( z,-z,-z), shadowZ));
	return dot(shadows, vec4(0.25));
}
float getShadowOmniPCF3x3(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {
	return getShadowOmniPCF3x3(shadowMap, shadowParams, lightDir);
}
#endif
`,shadowPCF5PS:`
float _getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {
	float z = shadowCoord.z;
	vec2 uv = shadowCoord.xy * shadowParams.x;
	float shadowMapSizeInv = 1.0 / shadowParams.x;
	vec2 base_uv = floor(uv + 0.5);
	float s = (uv.x + 0.5 - base_uv.x);
	float t = (uv.y + 0.5 - base_uv.y);
	base_uv -= vec2(0.5);
	base_uv *= shadowMapSizeInv;
	float uw0 = (4.0 - 3.0 * s);
	float uw1 = 7.0;
	float uw2 = (1.0 + 3.0 * s);
	float u0 = (3.0 - 2.0 * s) / uw0 - 2.0;
	float u1 = (3.0 + s) / uw1;
	float u2 = s / uw2 + 2.0;
	float vw0 = (4.0 - 3.0 * t);
	float vw1 = 7.0;
	float vw2 = (1.0 + 3.0 * t);
	float v0 = (3.0 - 2.0 * t) / vw0 - 2.0;
	float v1 = (3.0 + t) / vw1;
	float v2 = t / vw2 + 2.0;
	float sum = 0.0;
	u0 = u0 * shadowMapSizeInv + base_uv.x;
	v0 = v0 * shadowMapSizeInv + base_uv.y;
	u1 = u1 * shadowMapSizeInv + base_uv.x;
	v1 = v1 * shadowMapSizeInv + base_uv.y;
	u2 = u2 * shadowMapSizeInv + base_uv.x;
	v2 = v2 * shadowMapSizeInv + base_uv.y;
	sum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));
	sum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));
	sum += uw2 * vw0 * textureShadow(shadowMap, vec3(u2, v0, z));
	sum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));
	sum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));
	sum += uw2 * vw1 * textureShadow(shadowMap, vec3(u2, v1, z));
	sum += uw0 * vw2 * textureShadow(shadowMap, vec3(u0, v2, z));
	sum += uw1 * vw2 * textureShadow(shadowMap, vec3(u1, v2, z));
	sum += uw2 * vw2 * textureShadow(shadowMap, vec3(u2, v2, z));
	sum *= 1.0f / 144.0;
	sum = saturate(sum);
	return sum;
}
float getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
float getShadowSpotPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {
	return _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);
}
`,shadowPCSSPS:`
#define PCSS_SAMPLE_COUNT 16
uniform float pcssDiskSamples[PCSS_SAMPLE_COUNT];
uniform float pcssSphereSamples[PCSS_SAMPLE_COUNT];
vec2 vogelDisk(int sampleIndex, float count, float phi, float r) {
	const float GoldenAngle = 2.4;
	float theta = float(sampleIndex) * GoldenAngle + phi;
	float sine = sin(theta);
	float cosine = cos(theta);
	return vec2(r * cosine, r * sine);
}
vec3 vogelSphere(int sampleIndex, float count, float phi, float r) {
	const float GoldenAngle = 2.4;
	float theta = float(sampleIndex) * GoldenAngle + phi;
	float weight = float(sampleIndex) / count;
	return vec3(cos(theta) * r, weight, sin(theta) * r);
}
float noise(vec2 screenPos) {
	const float PHI = 1.61803398874989484820459;
	return fract(sin(dot(screenPos * PHI, screenPos)) * screenPos.x);
}
float viewSpaceDepth(float depth, mat4 invProjection) {
	float z = depth * 2.0 - 1.0;
	vec4 clipSpace = vec4(0.0, 0.0, z, 1.0);
	vec4 viewSpace = invProjection * clipSpace;
	return viewSpace.z;
}
float PCSSBlockerDistance(TEXTURE_ACCEPT(shadowMap), vec2 sampleCoords[PCSS_SAMPLE_COUNT], vec2 shadowCoords, vec2 searchSize, float z, vec4 cameraParams) {
	float blockers = 0.0;
	float averageBlocker = 0.0;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		vec2 offset = sampleCoords[i] * searchSize;
		vec2 sampleUV = shadowCoords + offset;
		float blocker = texture2DLod(shadowMap, sampleUV, 0.0).r;
		float isBlocking = step(blocker, z);
		blockers += isBlocking;
		averageBlocker += blocker * isBlocking;
	}
	if (blockers > 0.0)
		return averageBlocker / blockers;
	return -1.0;
}
float PCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec2 shadowSearchArea) {
	float receiverDepth = linearizeDepthWithParams(shadowCoords.z, cameraParams);
	vec2 samplePoints[PCSS_SAMPLE_COUNT];
	const float PI = 3.141592653589793;
	float noise = noise( gl_FragCoord.xy ) * 2.0 * PI;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		float pcssPresample = pcssDiskSamples[i];
		samplePoints[i] = vogelDisk(i, float(PCSS_SAMPLE_COUNT), noise, pcssPresample);
	}
	float averageBlocker = PCSSBlockerDistance(TEXTURE_PASS(shadowMap), samplePoints, shadowCoords.xy, shadowSearchArea, receiverDepth, cameraParams);
	if (averageBlocker == -1.0) {
		return 1.0;
	} else {
		float depthDifference = (receiverDepth - averageBlocker) / 3.0;
		vec2 filterRadius = depthDifference * shadowSearchArea;
		float shadow = 0.0;
		for (int i = 0; i < PCSS_SAMPLE_COUNT; i ++)
		{
			vec2 sampleUV = samplePoints[i] * filterRadius;
			sampleUV = shadowCoords.xy + sampleUV;
			float depth = texture2DLod(shadowMap, sampleUV, 0.0).r;
			shadow += step(receiverDepth, depth);
		}
		return shadow / float(PCSS_SAMPLE_COUNT);
	} 
}
#ifndef WEBGPU
float PCSSCubeBlockerDistance(samplerCube shadowMap, vec3 lightDirNorm, vec3 samplePoints[PCSS_SAMPLE_COUNT], float z, float shadowSearchArea) {
	float blockers = 0.0;
	float averageBlocker = 0.0;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		vec3 sampleDir = lightDirNorm + samplePoints[i] * shadowSearchArea;
		sampleDir = normalize(sampleDir);
		float blocker = textureCubeLod(shadowMap, sampleDir, 0.0).r;
		float isBlocking = step(blocker, z);
		blockers += isBlocking;
		averageBlocker += blocker * isBlocking;
	}
	if (blockers > 0.0)
		return averageBlocker / blockers;
	return -1.0;
}
float PCSSCube(samplerCube shadowMap, vec4 shadowParams, vec3 shadowCoords, vec4 cameraParams, float shadowSearchArea, vec3 lightDir) {
	
	vec3 samplePoints[PCSS_SAMPLE_COUNT];
	const float PI = 3.141592653589793;
	float noise = noise( gl_FragCoord.xy ) * 2.0 * PI;
	for (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {
		float r = pcssSphereSamples[i];
		samplePoints[i] = vogelSphere(i, float(PCSS_SAMPLE_COUNT), noise, r);
	}
	float receiverDepth = length(lightDir) * shadowParams.w + shadowParams.z;
	vec3 lightDirNorm = normalize(lightDir);
	
	float averageBlocker = PCSSCubeBlockerDistance(shadowMap, lightDirNorm, samplePoints, receiverDepth, shadowSearchArea);
	if (averageBlocker == -1.0) {
		return 1.0;
	} else {
		float filterRadius = ((receiverDepth - averageBlocker) / averageBlocker) * shadowSearchArea;
		float shadow = 0.0;
		for (int i = 0; i < PCSS_SAMPLE_COUNT; i++)
		{
			vec3 offset = samplePoints[i] * filterRadius;
			vec3 sampleDir = lightDirNorm + offset;
			sampleDir = normalize(sampleDir);
			float depth = textureCubeLod(shadowMap, sampleDir, 0.0).r;
			shadow += step(receiverDepth, depth);
		}
		return shadow / float(PCSS_SAMPLE_COUNT);
	}
}
float getShadowOmniPCSS(samplerCube shadowMap, vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {
	return PCSSCube(shadowMap, shadowParams, shadowCoord, cameraParams, shadowSearchArea.x, lightDir);
}
#endif
float getShadowSpotPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {
	return PCSS(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, shadowSearchArea);
}
`,shadowSoftPS:`
highp float fractSinRand(const in vec2 uv) {
	const float PI = 3.141592653589793;
	const highp float a = 12.9898, b = 78.233, c = 43758.5453;
	highp float dt = dot(uv.xy, vec2(a, b)), sn = mod(dt, PI);
	return fract(sin(sn) * c);
}
struct VogelDiskData {
	float invNumSamples;
	float initialAngle;
	float currentPointId;
};
void prepareDiskConstants(out VogelDiskData data, int sampleCount, float randomSeed) {
	const float pi2 = 6.28318530718;
	data.invNumSamples = 1.0 / float(sampleCount);
	data.initialAngle = randomSeed * pi2;
	data.currentPointId = 0.0;
}
vec2 generateDiskSample(inout VogelDiskData data) {
	const float GOLDEN_ANGLE = 2.399963;
	float r = sqrt((data.currentPointId + 0.5) * data.invNumSamples);
	float theta = data.currentPointId * GOLDEN_ANGLE + data.initialAngle;
	vec2 offset = vec2(cos(theta), sin(theta)) * pow(r, 1.33);
	data.currentPointId += 1.0;
	return offset;
}
void PCSSFindBlocker(TEXTURE_ACCEPT(shadowMap), out float avgBlockerDepth, out int numBlockers,
	vec2 shadowCoords, float z, int shadowBlockerSamples, float penumbraSize, float invShadowMapSize, float randomSeed) {
	VogelDiskData diskData;
	prepareDiskConstants(diskData, shadowBlockerSamples, randomSeed);
	float searchWidth = penumbraSize * invShadowMapSize;
	float blockerSum = 0.0;
	numBlockers = 0;
	for( int i = 0; i < shadowBlockerSamples; ++i ) {
		vec2 diskUV = generateDiskSample(diskData);
		vec2 sampleUV = shadowCoords + diskUV * searchWidth;
		float shadowMapDepth = texture2DLod(shadowMap, sampleUV, 0.0).r;
		if ( shadowMapDepth < z ) {
			blockerSum += shadowMapDepth;
			numBlockers++;
		}
	}
	avgBlockerDepth = blockerSum / float(numBlockers);
}
float PCSSFilter(TEXTURE_ACCEPT(shadowMap), vec2 uv, float receiverDepth, int shadowSamples, float filterRadius, float randomSeed) {
	VogelDiskData diskData;
	prepareDiskConstants(diskData, shadowSamples, randomSeed);
	float sum = 0.0;
	for (int i = 0; i < shadowSamples; i++) {
		vec2 offsetUV = generateDiskSample(diskData) * filterRadius;
		float depth = texture2DLod(shadowMap, uv + offsetUV, 0.0).r;
		sum += step(receiverDepth, depth);
	}
	return sum / float(shadowSamples);
}
float getPenumbra(float dblocker, float dreceiver, float penumbraSize, float penumbraFalloff) {
	float dist = dreceiver - dblocker;
	float penumbra = 1.0 - pow(1.0 - dist, penumbraFalloff);
	return penumbra * penumbraSize;
}
float PCSSDirectional(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec4 softShadowParams) {
	float receiverDepth = shadowCoords.z;
	float randomSeed = fractSinRand(gl_FragCoord.xy);
	int shadowSamples = int(softShadowParams.x);
	int shadowBlockerSamples = int(softShadowParams.y);
	float penumbraSize = softShadowParams.z;
	float penumbraFalloff = softShadowParams.w;
	int shadowMapSize = textureSize(shadowMap, 0).x;
	float invShadowMapSize = 1.0 / float(shadowMapSize);
	invShadowMapSize *= float(shadowMapSize) / 2048.0;
	float penumbra;
	if (shadowBlockerSamples > 0) {
		float avgBlockerDepth = 0.0;
		int numBlockers = 0;
		PCSSFindBlocker(TEXTURE_PASS(shadowMap), avgBlockerDepth, numBlockers, shadowCoords.xy, receiverDepth, shadowBlockerSamples, penumbraSize, invShadowMapSize, randomSeed);
		if (numBlockers < 1)
			return 1.0f;
		penumbra = getPenumbra(avgBlockerDepth, shadowCoords.z, penumbraSize, penumbraFalloff);
	} else {
		penumbra = penumbraSize;
	}
	float filterRadius = penumbra * invShadowMapSize;
	return PCSSFilter(TEXTURE_PASS(shadowMap), shadowCoords.xy, receiverDepth, shadowSamples, filterRadius, randomSeed);
}
float getShadowPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec4 softShadowParams, vec3 lightDir) {
	return PCSSDirectional(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, softShadowParams);
}
`,skinBatchVS:`
attribute float vertex_boneIndices;
uniform highp sampler2D texture_poseMap;
mat4 getBoneMatrix(const in float indexFloat) {
	int width = textureSize(texture_poseMap, 0).x;
	int index = int(indexFloat + 0.5) * 3;
	int iy = index / width;
	int ix = index % width;
	vec4 v1 = texelFetch(texture_poseMap, ivec2(ix + 0, iy), 0);
	vec4 v2 = texelFetch(texture_poseMap, ivec2(ix + 1, iy), 0);
	vec4 v3 = texelFetch(texture_poseMap, ivec2(ix + 2, iy), 0);
	return mat4(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, 1
	);
}
`,skinVS:`
attribute vec4 vertex_boneWeights;
attribute vec4 vertex_boneIndices;
uniform highp sampler2D texture_poseMap;
void getBoneMatrix(const in int width, const in int index, out vec4 v1, out vec4 v2, out vec4 v3) {
	int v = index / width;
	int u = index % width;
	v1 = texelFetch(texture_poseMap, ivec2(u + 0, v), 0);
	v2 = texelFetch(texture_poseMap, ivec2(u + 1, v), 0);
	v3 = texelFetch(texture_poseMap, ivec2(u + 2, v), 0);
}
mat4 getSkinMatrix(const in vec4 indicesFloat, const in vec4 weights) {
	int width = textureSize(texture_poseMap, 0).x;
	ivec4 indices = ivec4(indicesFloat + 0.5) * 3;
	vec4 a1, a2, a3;
	getBoneMatrix(width, indices.x, a1, a2, a3);
	vec4 b1, b2, b3;
	getBoneMatrix(width, indices.y, b1, b2, b3);
	vec4 c1, c2, c3;
	getBoneMatrix(width, indices.z, c1, c2, c3);
	vec4 d1, d2, d3;
	getBoneMatrix(width, indices.w, d1, d2, d3);
	vec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;
	vec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;
	vec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;
	float one = dot(weights, vec4(1.0));
	return mat4(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, one
	);
}
`,skyboxPS:`
	#define LIT_SKYBOX_INTENSITY
	#include "envProcPS"
	#include "gammaPS"
	#include "tonemappingPS"
	#ifdef PREPASS_PASS
		varying float vLinearDepth;
		#include "floatAsUintPS"
	#endif
	varying vec3 vViewDir;
	uniform float skyboxHighlightMultiplier;
	#ifdef SKY_CUBEMAP
		uniform samplerCube texture_cubeMap;
		#ifdef SKYMESH
			varying vec3 vWorldPos;
			uniform mat3 cubeMapRotationMatrix;
			uniform vec3 projectedSkydomeCenter;
		#endif
	#else
		#include "sphericalPS"
		#include "envAtlasPS"
		uniform sampler2D texture_envAtlas;
		uniform float mipLevel;
	#endif
	void main(void) {
		#ifdef PREPASS_PASS
			gl_FragColor = float2vec4(vLinearDepth);
		#else
			#ifdef SKY_CUBEMAP
				#ifdef SKYMESH
					vec3 envDir = normalize(vWorldPos - projectedSkydomeCenter);
					vec3 dir = envDir * cubeMapRotationMatrix;
				#else
					vec3 dir = vViewDir;
				#endif
				dir.x *= -1.0;
				vec3 linear = {SKYBOX_DECODE_FNC}(textureCube(texture_cubeMap, dir));
			#else
				vec3 dir = vViewDir * vec3(-1.0, 1.0, 1.0);
				vec2 uv = toSphericalUv(normalize(dir));
				vec3 linear = {SKYBOX_DECODE_FNC}(texture2D(texture_envAtlas, mapRoughnessUv(uv, mipLevel)));
			#endif
			if (any(greaterThanEqual(linear, vec3(64.0)))) {
				linear *= skyboxHighlightMultiplier;
			}
			gl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);
		#endif
	}
`,skyboxVS:`
attribute vec4 aPosition;
uniform mat4 matrix_view;
uniform mat4 matrix_projectionSkybox;
uniform mat3 cubeMapRotationMatrix;
varying vec3 vViewDir;
#ifdef PREPASS_PASS
	varying float vLinearDepth;
#endif
#ifdef SKYMESH
	uniform mat4 matrix_model;
	varying vec3 vWorldPos;
#endif
void main(void) {
	mat4 view = matrix_view;
	#ifdef SKYMESH
		vec4 worldPos = matrix_model * aPosition;
		vWorldPos = worldPos.xyz;
		gl_Position = matrix_projectionSkybox * (view * worldPos);
		#ifdef PREPASS_PASS
			vLinearDepth = -(matrix_view * vec4(vWorldPos, 1.0)).z;
		#endif
	#else
		view[3][0] = view[3][1] = view[3][2] = 0.0;
		gl_Position = matrix_projectionSkybox * (view * aPosition);
		vViewDir = aPosition.xyz * cubeMapRotationMatrix;
		#ifdef PREPASS_PASS
			vLinearDepth = -gl_Position.w;
		#endif
	#endif
	gl_Position.z = gl_Position.w - 1.0e-7;
}
`,specularPS:`
#ifdef STD_SPECULAR_CONSTANT
uniform vec3 material_specular;
#endif
void getSpecularity() {
	vec3 specularColor = vec3(1,1,1);
	#ifdef STD_SPECULAR_CONSTANT
	specularColor *= material_specular;
	#endif
	#ifdef STD_SPECULAR_TEXTURE
	specularColor *= {STD_SPECULAR_TEXTURE_DECODE}(texture2DBias({STD_SPECULAR_TEXTURE_NAME}, {STD_SPECULAR_TEXTURE_UV}, textureBias)).{STD_SPECULAR_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SPECULAR_VERTEX
	specularColor *= saturate(vVertexColor.{STD_SPECULAR_VERTEX_CHANNEL});
	#endif
	dSpecularity = specularColor;
}
`,sphericalPS:`
vec2 toSpherical(vec3 dir) {
	return vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));
}
vec2 toSphericalUv(vec3 dir) {
	const float PI = 3.141592653589793;
	vec2 uv = toSpherical(dir) / vec2(PI * 2.0, PI) + 0.5;
	return vec2(uv.x, 1.0 - uv.y);
}
`,specularityFactorPS:`
#ifdef STD_SPECULARITYFACTOR_CONSTANT
uniform float material_specularityFactor;
#endif
void getSpecularityFactor() {
	float specularityFactor = 1.0;
	#ifdef STD_SPECULARITYFACTOR_CONSTANT
	specularityFactor *= material_specularityFactor;
	#endif
	#ifdef STD_SPECULARITYFACTOR_TEXTURE
	specularityFactor *= texture2DBias({STD_SPECULARITYFACTOR_TEXTURE_NAME}, {STD_SPECULARITYFACTOR_TEXTURE_UV}, textureBias).{STD_SPECULARITYFACTOR_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SPECULARITYFACTOR_VERTEX
	specularityFactor *= saturate(vVertexColor.{STD_SPECULARITYFACTOR_VERTEX_CHANNEL});
	#endif
	dSpecularityFactor = specularityFactor;
}
`,spotPS:`
float getSpotEffect(vec3 lightSpotDir, float lightInnerConeAngle, float lightOuterConeAngle, vec3 lightDirNorm) {
	float cosAngle = dot(lightDirNorm, lightSpotDir);
	return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);
}
`,startNineSlicedPS:`
	nineSlicedUv = vec2(vUv0.x, 1.0 - vUv0.y);
`,startNineSlicedTiledPS:`
	vec2 tileMask = step(vMask, vec2(0.99999));
	vec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);
	vec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);
	vec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));
	clampedUv = clampedUv * atlasRect.zw + atlasRect.xy;
	nineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);
	nineSlicedUv.y = 1.0 - nineSlicedUv.y;
	
`,stdDeclarationPS:`
	float dAlpha = 1.0;
	#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE
		#ifdef STD_OPACITY_TEXTURE_ALLOCATE
			uniform sampler2D texture_opacityMap;
		#endif
	#endif
	#ifdef FORWARD_PASS
		vec3 dAlbedo;
		vec3 dNormalW;
		vec3 dSpecularity = vec3(0.0);
		float dGlossiness = 0.0;
		#ifdef LIT_REFRACTION
			float dTransmission;
			float dThickness;
		#endif
		#ifdef LIT_SCENE_COLOR
			uniform sampler2D uSceneColorMap;
		#endif
		#ifdef LIT_SCREEN_SIZE
			uniform vec4 uScreenSize;
		#endif
		#ifdef LIT_TRANSFORMS
			uniform mat4 matrix_viewProjection;
			uniform mat4 matrix_model;
		#endif
		#ifdef STD_HEIGHT_MAP
			vec2 dUvOffset;
			#ifdef STD_HEIGHT_TEXTURE_ALLOCATE
				uniform sampler2D texture_heightMap;
			#endif
		#endif
		#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE
			uniform sampler2D texture_diffuseMap;
		#endif
		#ifdef STD_DIFFUSEDETAIL_TEXTURE_ALLOCATE
			uniform sampler2D texture_diffuseDetailMap;
		#endif
		#ifdef STD_NORMAL_TEXTURE_ALLOCATE
			uniform sampler2D texture_normalMap;
		#endif
		#ifdef STD_NORMALDETAIL_TEXTURE_ALLOCATE
			uniform sampler2D texture_normalDetailMap;
		#endif
		#ifdef STD_THICKNESS_TEXTURE_ALLOCATE
			uniform sampler2D texture_thicknessMap;
		#endif
		#ifdef STD_REFRACTION_TEXTURE_ALLOCATE
			uniform sampler2D texture_refractionMap;
		#endif
		#ifdef LIT_IRIDESCENCE
			float dIridescence;
			float dIridescenceThickness;
			#ifdef STD_IRIDESCENCE_THICKNESS_TEXTURE_ALLOCATE
				uniform sampler2D texture_iridescenceThicknessMap;
			#endif
			#ifdef STD_IRIDESCENCE_TEXTURE_ALLOCATE
				uniform sampler2D texture_iridescenceMap;
			#endif
		#endif
		#ifdef LIT_CLEARCOAT
			float ccSpecularity;
			float ccGlossiness;
			vec3 ccNormalW;
		#endif
		#ifdef LIT_GGX_SPECULAR
			float dAnisotropy;
			vec2 dAnisotropyRotation;
		#endif
		#ifdef LIT_SPECULAR_OR_REFLECTION
			#ifdef LIT_SHEEN
				vec3 sSpecularity;
				float sGlossiness;
				#ifdef STD_SHEEN_TEXTURE_ALLOCATE
					uniform sampler2D texture_sheenMap;
				#endif
				#ifdef STD_SHEENGLOSS_TEXTURE_ALLOCATE
					uniform sampler2D texture_sheenGlossMap;
				#endif
			#endif
			#ifdef LIT_METALNESS
				float dMetalness;
				float dIor;
				#ifdef STD_METALNESS_TEXTURE_ALLOCATE
					uniform sampler2D texture_metalnessMap;
				#endif
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				float dSpecularityFactor;
				#ifdef STD_SPECULARITYFACTOR_TEXTURE_ALLOCATE
					uniform sampler2D texture_specularityFactorMap;
				#endif
			#endif
			#ifdef STD_SPECULAR_COLOR
				#ifdef STD_SPECULAR_TEXTURE_ALLOCATE
					uniform sampler2D texture_specularMap;
				#endif
			#endif
			#ifdef STD_GLOSS_TEXTURE_ALLOCATE
				uniform sampler2D texture_glossMap;
			#endif
		#endif
		#ifdef STD_AO
			float dAo;
			#ifdef STD_AO_TEXTURE_ALLOCATE
				uniform sampler2D texture_aoMap;
			#endif
			#ifdef STD_AODETAIL_TEXTURE_ALLOCATE
				uniform sampler2D texture_aoDetailMap;
			#endif
		#endif
		vec3 dEmission;
		#ifdef STD_EMISSIVE_TEXTURE_ALLOCATE
			uniform sampler2D texture_emissiveMap;
		#endif
		#ifdef LIT_CLEARCOAT
			#ifdef STD_CLEARCOAT_TEXTURE_ALLOCATE
				uniform sampler2D texture_clearCoatMap;
			#endif
			#ifdef STD_CLEARCOATGLOSS_TEXTURE_ALLOCATE
				uniform sampler2D texture_clearCoatGlossMap;
			#endif
			#ifdef STD_CLEARCOATNORMAL_TEXTURE_ALLOCATE
				uniform sampler2D texture_clearCoatNormalMap;
			#endif
		#endif
		
		#ifdef LIT_GGX_SPECULAR
			#ifdef STD_ANISOTROPY_TEXTURE_ALLOCATE
				uniform sampler2D texture_anisotropyMap;
			#endif
		#endif
		#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
			vec3 dLightmap;
			#ifdef STD_LIGHT_TEXTURE_ALLOCATE
				uniform sampler2D texture_lightMap;
			#endif
		#endif
	#endif
	#include "litShaderCorePS"
`,stdFrontEndPS:`
	#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE
		#include "opacityPS"
		#if defined(LIT_ALPHA_TEST)
			#include "alphaTestPS"
		#endif
		#if STD_OPACITY_DITHER != NONE
			#include "opacityDitherPS"
		#endif
	#endif
	#ifdef FORWARD_PASS
		#ifdef STD_HEIGHT_MAP
			#include "parallaxPS"
		#endif
		#include  "diffusePS"
		#ifdef LIT_NEEDS_NORMAL
			#include "normalMapPS"
		#endif
		#ifdef LIT_REFRACTION
			#include "transmissionPS"
			#include "thicknessPS"
		#endif
		#ifdef LIT_IRIDESCENCE
			#include "iridescencePS"
			#include "iridescenceThicknessPS"
		#endif
		#ifdef LIT_SPECULAR_OR_REFLECTION
			#ifdef LIT_SHEEN
				#include "sheenPS"
				#include "sheenGlossPS"
			#endif
			#ifdef LIT_METALNESS
				#include "metalnessPS"
				#include "iorPS"
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				#include "specularityFactorPS"
			#endif
			#ifdef STD_SPECULAR_COLOR
				#include "specularPS"
			#else
				void getSpecularity() { 
					dSpecularity = vec3(1);
				}
			#endif
			#include "glossPS"
		#endif
		#ifdef STD_AO
			#include "aoPS"
		#endif
		#include "emissivePS"
		#ifdef LIT_CLEARCOAT
			#include "clearCoatPS"
			#include "clearCoatGlossPS"
			#include "clearCoatNormalPS"
		#endif
		#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)
			#include "anisotropyPS"
		#endif
		#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
			#include "lightmapPS"
		#endif
	#endif
	void evaluateFrontend() {
		#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE
			getOpacity();
			#if defined(LIT_ALPHA_TEST)
				alphaTest(dAlpha);
			#endif
			#if STD_OPACITY_DITHER != NONE
				opacityDither(dAlpha, 0.0);
			#endif
			litArgs_opacity = dAlpha;
		#endif
		#ifdef FORWARD_PASS
			#ifdef STD_HEIGHT_MAP
				getParallax();
			#endif
			getAlbedo();
			litArgs_albedo = dAlbedo;
			#ifdef LIT_NEEDS_NORMAL
				getNormal();
				litArgs_worldNormal = dNormalW;
			#endif
			#ifdef LIT_REFRACTION
				getRefraction();
				litArgs_transmission = dTransmission;
				getThickness();
				litArgs_thickness = dThickness;
				#ifdef LIT_DISPERSION
					litArgs_dispersion = material_dispersion;
				#endif
			#endif
			#ifdef LIT_IRIDESCENCE
				getIridescence();
				getIridescenceThickness();
				litArgs_iridescence_intensity = dIridescence;
				litArgs_iridescence_thickness = dIridescenceThickness;
			#endif
			#ifdef LIT_SPECULAR_OR_REFLECTION
				#ifdef LIT_SHEEN
					getSheen();
					litArgs_sheen_specularity = sSpecularity;
					getSheenGlossiness();
					litArgs_sheen_gloss = sGlossiness;
				#endif
				#ifdef LIT_METALNESS
					getMetalness();
					litArgs_metalness = dMetalness;
					getIor();
					litArgs_ior = dIor;
				#endif
				#ifdef LIT_SPECULARITY_FACTOR
					getSpecularityFactor();
					litArgs_specularityFactor = dSpecularityFactor;
				#endif
				getGlossiness();
				getSpecularity();
				litArgs_specularity = dSpecularity;
				litArgs_gloss = dGlossiness;
			#endif
			#ifdef STD_AO
				getAO();
				litArgs_ao = dAo;
			#endif
			getEmission();
			litArgs_emission = dEmission;
			#ifdef LIT_CLEARCOAT
				getClearCoat();
				getClearCoatGlossiness();
				getClearCoatNormal();
				litArgs_clearcoat_specularity = ccSpecularity;
				litArgs_clearcoat_gloss = ccGlossiness;
				litArgs_clearcoat_worldNormal = ccNormalW;
			#endif
			#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)
				getAnisotropy();
			#endif
			#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
				getLightMap();
				litArgs_lightmap = dLightmap;
				#ifdef STD_LIGHTMAP_DIR
					litArgs_lightmapDir = dLightmapDir;
				#endif
			#endif
		#endif
	}
`,TBNPS:`
#ifdef LIT_TANGENTS
	#define TBN_TANGENTS
#else
	#if defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)
		#define TBN_DERIVATIVES
	#endif
#endif
#if defined(TBN_DERIVATIVES)
	uniform float tbnBasis;
#endif
void getTBN(vec3 tangent, vec3 binormal, vec3 normal) {
	#ifdef TBN_TANGENTS
		dTBN = mat3(normalize(tangent), normalize(binormal), normalize(normal));
	#elif defined(TBN_DERIVATIVES)
		vec2 uv = {lightingUv};
		vec3 dp1 = dFdx( vPositionW );
		vec3 dp2 = dFdy( vPositionW );
		vec2 duv1 = dFdx( uv );
		vec2 duv2 = dFdy( uv );
		vec3 dp2perp = cross( dp2, normal );
		vec3 dp1perp = cross( normal, dp1 );
		vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;
		vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;
		float denom = max( dot(T,T), dot(B,B) );
		float invmax = (denom == 0.0) ? 0.0 : tbnBasis / sqrt( denom );
		dTBN = mat3(T * invmax, -B * invmax, normal );
	#else
		vec3 B = cross(normal, vObjectSpaceUpW);
		vec3 T = cross(normal, B);
		if (dot(B,B)==0.0)
		{
			float major=max(max(normal.x, normal.y), normal.z);
			if (normal.x == major)
			{
				B = cross(normal, vec3(0,1,0));
				T = cross(normal, B);
			}
			else if (normal.y == major)
			{
				B = cross(normal, vec3(0,0,1));
				T = cross(normal, B);
			}
			else if (normal.z == major)
			{
				B = cross(normal, vec3(1,0,0));
				T = cross(normal, B);
			}
		}
		dTBN = mat3(normalize(T), normalize(B), normalize(normal));
	#endif
}
`,thicknessPS:`
#ifdef STD_THICKNESS_CONSTANT
uniform float material_thickness;
#endif
void getThickness() {
	dThickness = 1.0;
	#ifdef STD_THICKNESS_CONSTANT
	dThickness *= material_thickness;
	#endif
	#ifdef STD_THICKNESS_TEXTURE
	dThickness *= texture2DBias({STD_THICKNESS_TEXTURE_NAME}, {STD_THICKNESS_TEXTURE_UV}, textureBias).{STD_THICKNESS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_THICKNESS_VERTEX
	dThickness *= saturate(vVertexColor.{STD_THICKNESS_VERTEX_CHANNEL});
	#endif
}
`,tonemappingPS:`
#if (TONEMAP == NONE)
	#include "tonemappingNonePS"
#elif TONEMAP == FILMIC
	#include "tonemappingFilmicPS"
#elif TONEMAP == LINEAR
	#include "tonemappingLinearPS"
#elif TONEMAP == HEJL
	#include "tonemappingHejlPS"
#elif TONEMAP == ACES
	#include "tonemappingAcesPS"
#elif TONEMAP == ACES2
	#include "tonemappingAces2PS"
#elif TONEMAP == NEUTRAL
	#include "tonemappingNeutralPS"
#endif
`,tonemappingAcesPS:`
uniform float exposure;
vec3 toneMap(vec3 color) {
	float tA = 2.51;
	float tB = 0.03;
	float tC = 2.43;
	float tD = 0.59;
	float tE = 0.14;
	vec3 x = color * exposure;
	return (x*(tA*x+tB))/(x*(tC*x+tD)+tE);
}
`,tonemappingAces2PS:`
uniform float exposure;
const mat3 ACESInputMat = mat3(
	0.59719, 0.35458, 0.04823,
	0.07600, 0.90834, 0.01566,
	0.02840, 0.13383, 0.83777
);
const mat3 ACESOutputMat = mat3(
	 1.60475, -0.53108, -0.07367,
	-0.10208,  1.10813, -0.00605,
	-0.00327, -0.07276,  1.07602
);
vec3 RRTAndODTFit(vec3 v) {
	vec3 a = v * (v + 0.0245786) - 0.000090537;
	vec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;
	return a / b;
}
vec3 toneMap(vec3 color) {
	color *= exposure / 0.6;
	color = color * ACESInputMat;
	color = RRTAndODTFit(color);
	color = color * ACESOutputMat;
	color = clamp(color, 0.0, 1.0);
	return color;
}
`,tonemappingFilmicPS:`
const float A =  0.15;
const float B =  0.50;
const float C =  0.10;
const float D =  0.20;
const float E =  0.02;
const float F =  0.30;
const float W =  11.2;
uniform float exposure;
vec3 uncharted2Tonemap(vec3 x) {
	 return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;
}
vec3 toneMap(vec3 color) {
	color = uncharted2Tonemap(color * exposure);
	vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));
	color = color * whiteScale;
	return color;
}
`,tonemappingHejlPS:`
uniform float exposure;
vec3 toneMap(vec3 color) {
	color *= exposure;
	const float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;
	const float Scl = 1.25;
	vec3 h = max( vec3(0.0), color - vec3(0.004) );
	return (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);
}
`,tonemappingLinearPS:`
uniform float exposure;
vec3 toneMap(vec3 color) {
	return color * exposure;
}
`,tonemappingNeutralPS:`
uniform float exposure;
vec3 toneMap(vec3 color) {
	color *= exposure;
	float startCompression = 0.8 - 0.04;
	float desaturation = 0.15;
	float x = min(color.r, min(color.g, color.b));
	float offset = x < 0.08 ? x - 6.25 * x * x : 0.04;
	color -= offset;
	float peak = max(color.r, max(color.g, color.b));
	if (peak < startCompression) return color;
	float d = 1. - startCompression;
	float newPeak = 1. - d * d / (peak + d - startCompression);
	color *= newPeak / peak;
	float g = 1. - 1. / (desaturation * (peak - newPeak) + 1.);
	return mix(color, newPeak * vec3(1, 1, 1), g);
}
`,tonemappingNonePS:`
vec3 toneMap(vec3 color) {
	return color;
}
`,transformVS:`
#ifdef PIXELSNAP
uniform vec4 uScreenSize;
#endif
#ifdef SCREENSPACE
uniform float projectionFlipY;
#endif
vec4 evalWorldPosition(vec3 vertexPosition, mat4 modelMatrix) {
	vec3 localPos = getLocalPosition(vertexPosition);
	#ifdef NINESLICED
		localPos.xz *= outerScale;
		vec2 positiveUnitOffset = clamp(vertexPosition.xz, vec2(0.0), vec2(1.0));
		vec2 negativeUnitOffset = clamp(-vertexPosition.xz, vec2(0.0), vec2(1.0));
		localPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;
		vTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;
		localPos.xz *= -0.5;
		localPos = localPos.xzy;
	#endif
	vec4 posW = modelMatrix * vec4(localPos, 1.0);
	#ifdef SCREENSPACE
		posW.zw = vec2(0.0, 1.0);
	#endif
	return posW;
}
vec4 getPosition() {
	dModelMatrix = getModelMatrix();
	vec4 posW = evalWorldPosition(vertex_position.xyz, dModelMatrix);
	dPositionW = posW.xyz;
	vec4 screenPos;
	#ifdef UV1LAYOUT
		screenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);
		#ifdef WEBGPU
			screenPos.y *= -1.0;
		#endif
	#else
		#ifdef SCREENSPACE
			screenPos = posW;
			screenPos.y *= projectionFlipY;
		#else
			screenPos = matrix_viewProjection * posW;
		#endif
		#ifdef PIXELSNAP
			screenPos.xy = (screenPos.xy * 0.5) + 0.5;
			screenPos.xy *= uScreenSize.xy;
			screenPos.xy = floor(screenPos.xy);
			screenPos.xy *= uScreenSize.zw;
			screenPos.xy = (screenPos.xy * 2.0) - 1.0;
		#endif
	#endif
	return screenPos;
}
vec3 getWorldPosition() {
	return dPositionW;
}
`,transformCoreVS:`
attribute vec4 vertex_position;
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
#ifdef MORPHING
	uniform vec2 morph_tex_params;
	attribute uint morph_vertex_id;
	ivec2 getTextureMorphCoords() {
		ivec2 textureSize = ivec2(morph_tex_params);
		int morphGridV = int(morph_vertex_id) / textureSize.x;
		int morphGridU = int(morph_vertex_id) - (morphGridV * textureSize.x);
		#ifdef WEBGPU
			morphGridV = textureSize.y - morphGridV - 1;
		#endif
		return ivec2(morphGridU, morphGridV);
	}
	#ifdef MORPHING_POSITION
		#ifdef MORPHING_INT
			uniform vec3 aabbSize;
			uniform vec3 aabbMin;
			uniform usampler2D morphPositionTex;
		#else
			uniform highp sampler2D morphPositionTex;
		#endif
	#endif
#endif
#ifdef defined(BATCH)
	#include "skinBatchVS"
	mat4 getModelMatrix() {
		return getBoneMatrix(vertex_boneIndices);
	}
#elif defined(SKIN)
	#include "skinVS"
	mat4 getModelMatrix() {
		return matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);
	}
#elif defined(INSTANCING)
	#include "transformInstancingVS"
#else
	mat4 getModelMatrix() {
		return matrix_model;
	}
#endif
vec3 getLocalPosition(vec3 vertexPosition) {
	vec3 localPos = vertexPosition;
	#ifdef MORPHING_POSITION
		ivec2 morphUV = getTextureMorphCoords();
		#ifdef MORPHING_INT
			vec3 morphPos = vec3(texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz) / 65535.0 * aabbSize + aabbMin;
		#else
			vec3 morphPos = texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz;
		#endif
		localPos += morphPos;
	#endif
	return localPos;
}
`,transformInstancingVS:`
attribute vec4 instance_line1;
attribute vec4 instance_line2;
attribute vec4 instance_line3;
attribute vec4 instance_line4;
mat4 getModelMatrix() {
	return matrix_model * mat4(instance_line1, instance_line2, instance_line3, instance_line4);
}
`,transmissionPS:`
#ifdef STD_REFRACTION_CONSTANT
uniform float material_refraction;
#endif
void getRefraction() {
	float refraction = 1.0;
	#ifdef STD_REFRACTION_CONSTANT
	refraction = material_refraction;
	#endif
	#ifdef STD_REFRACTION_TEXTURE
	refraction *= texture2DBias({STD_REFRACTION_TEXTURE_NAME}, {STD_REFRACTION_TEXTURE_UV}, textureBias).{STD_REFRACTION_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_REFRACTION_VERTEX
	refraction *= saturate(vVertexColor.{STD_REFRACTION_VERTEX_CHANNEL});
	#endif
	dTransmission = refraction;
}
`,twoSidedLightingPS:`
uniform float twoSidedLightingNegScaleFactor;
void handleTwoSidedLighting() {
	dTBN[2] *= gl_FrontFacing ? twoSidedLightingNegScaleFactor : -twoSidedLightingNegScaleFactor;
}
`,uv0VS:`
#ifdef NINESLICED
	vec2 getUv0() {
		vec2 uv = vertex_position.xz;
		vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));
		vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));
		uv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;
		uv = uv * -0.5 + 0.5;
		uv = uv * atlasRect.zw + atlasRect.xy;
		vMask = vertex_texCoord0.xy;
		return uv;
	}
#else
	vec2 getUv0() {
		return vertex_texCoord0;
	}
#endif
`,uv1VS:`
vec2 getUv1() {
	return vertex_texCoord1;
}
`,uvTransformVS:`
vUV{TRANSFORM_UV_{i}}_{TRANSFORM_ID_{i}} = vec2(
	dot(vec3(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}0),
	dot(vec3(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}1)
);
`,uvTransformUniformsPS:`
	uniform vec3 {TRANSFORM_NAME_{i}}0;
	uniform vec3 {TRANSFORM_NAME_{i}}1;
`,viewDirPS:`
void getViewDir() {
	dViewDirW = normalize(view_position - vPositionW);
}
`,webgpuPS:ri,webgpuVS:rs},fG={alphaTestPS:`
uniform alpha_ref: f32;
fn alphaTest(a: f32) {
	if (a < uniform.alpha_ref) {
		discard;
	}
}
`,ambientPS:`
#if LIT_AMBIENT_SOURCE == AMBIENTSH
	uniform ambientSH: array<vec3f, 9>;
#endif
#if LIT_AMBIENT_SOURCE == ENVALATLAS
	#include "envAtlasPS"
	#ifndef ENV_ATLAS
		#define ENV_ATLAS
		var texture_envAtlas: texture_2d<f32>;
		var texture_envAtlasSampler: sampler;
	#endif
#endif
fn addAmbient(worldNormal: vec3f) {
	#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH
		let n: vec3f = cubeMapRotate(worldNormal);
		let color: vec3f =
			uniform.ambientSH[0] +
			uniform.ambientSH[1] * n.x +
			uniform.ambientSH[2] * n.y +
			uniform.ambientSH[3] * n.z +
			uniform.ambientSH[4] * n.x * n.z +
			uniform.ambientSH[5] * n.z * n.y +
			uniform.ambientSH[6] * n.y * n.x +
			uniform.ambientSH[7] * (3.0 * n.z * n.z - 1.0) +
			uniform.ambientSH[8] * (n.x * n.x - n.y * n.y);
		dDiffuseLight += processEnvironment(max(color, vec3f(0.0)));
	#endif
	#if LIT_AMBIENT_SOURCE == ENVALATLAS
		let dir: vec3f = normalize(cubeMapRotate(worldNormal) * vec3f(-1.0, 1.0, 1.0));
		let uv: vec2f = mapUv(toSphericalUv(dir), vec4f(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);
		let raw: vec4f = textureSample(texture_envAtlas, texture_envAtlasSampler, uv);
		let linear: vec3f = {ambientDecode}(raw);
		dDiffuseLight += processEnvironment(linear);
	#endif
	#if LIT_AMBIENT_SOURCE == CONSTANT
		dDiffuseLight += uniform.light_globalAmbient;
	#endif
}
`,anisotropyPS:`
#ifdef LIT_GGX_SPECULAR
	uniform material_anisotropyIntensity: f32;
	uniform material_anisotropyRotation: vec2f;
#endif
fn getAnisotropy() {
	dAnisotropy = 0.0;
	dAnisotropyRotation = vec2f(1.0, 0.0);
#ifdef LIT_GGX_SPECULAR
	dAnisotropy = uniform.material_anisotropyIntensity;
	dAnisotropyRotation = uniform.material_anisotropyRotation;
#endif
#ifdef STD_ANISOTROPY_TEXTURE
	let anisotropyTex: vec3f = textureSampleBias({STD_ANISOTROPY_TEXTURE_NAME}, {STD_ANISOTROPY_TEXTURE_NAME}Sampler, {STD_ANISOTROPY_TEXTURE_UV}, uniform.textureBias).rgb;
	dAnisotropy *= anisotropyTex.b;
	let anisotropyRotationFromTex: vec2f = anisotropyTex.rg * 2.0 - vec2f(1.0);
	let rotationMatrix: mat2x2f = mat2x2f(dAnisotropyRotation.x, dAnisotropyRotation.y, -dAnisotropyRotation.y, dAnisotropyRotation.x);
	dAnisotropyRotation = rotationMatrix * anisotropyRotationFromTex;
#endif
	dAnisotropy = clamp(dAnisotropy, 0.0, 1.0);
}
`,aoPS:`
#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)
	uniform material_aoIntensity: f32;
#endif
#ifdef STD_AODETAIL_TEXTURE
	#include "detailModesPS"
#endif
fn getAO() {
	dAo = 1.0;
	#ifdef STD_AO_TEXTURE
		var aoBase: f32 = textureSampleBias({STD_AO_TEXTURE_NAME}, {STD_AO_TEXTURE_NAME}Sampler, {STD_AO_TEXTURE_UV}, uniform.textureBias).{STD_AO_TEXTURE_CHANNEL};
		#ifdef STD_AODETAIL_TEXTURE
			var aoDetail: f32 = textureSampleBias({STD_AODETAIL_TEXTURE_NAME}, {STD_AODETAIL_TEXTURE_NAME}Sampler, {STD_AODETAIL_TEXTURE_UV}, uniform.textureBias).{STD_AODETAIL_TEXTURE_CHANNEL};
			aoBase = detailMode_{STD_AODETAIL_DETAILMODE}(vec3f(aoBase), vec3f(aoDetail)).r;
		#endif
		dAo = dAo * aoBase;
	#endif
	#ifdef STD_AO_VERTEX
		dAo = dAo * saturate(vVertexColor.{STD_AO_VERTEX_CHANNEL});
	#endif
	#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)
		dAo = mix(1.0, dAo, uniform.material_aoIntensity);
	#endif
}
`,aoDiffuseOccPS:`
fn occludeDiffuse(ao: f32) {
	dDiffuseLight = dDiffuseLight * ao;
}
`,aoSpecOccPS:`
#if LIT_OCCLUDE_SPECULAR != NONE
	#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
		uniform material_occludeSpecularIntensity: f32;
	#endif
#endif
fn occludeSpecular(gloss: f32, ao: f32, worldNormal: vec3f, viewDir: vec3f) {
	#if LIT_OCCLUDE_SPECULAR == AO
		#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
			var specOcc: f32 = mix(1.0, ao, uniform.material_occludeSpecularIntensity);
		#else
			var specOcc: f32 = ao;
		#endif
	#endif
	#if LIT_OCCLUDE_SPECULAR == GLOSSDEPENDENT
		var specPow: f32 = exp2(gloss * 11.0);
		var specOcc: f32 = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01 * specPow) - 1.0 + ao);
		#ifdef LIT_OCCLUDE_SPECULAR_FLOAT
			specOcc = mix(1.0, specOcc, uniform.material_occludeSpecularIntensity);
		#endif
	#endif
	#if LIT_OCCLUDE_SPECULAR != NONE
		dSpecularLight = dSpecularLight * specOcc;
		dReflection = dReflection * specOcc;
		#ifdef LIT_SHEEN
			sSpecularLight = sSpecularLight * specOcc;
			sReflection = sReflection * specOcc;
		#endif
	#endif
}
`,bakeDirLmEndPS:`
	let dirLm = textureSample(texture_dirLightMap, texture_dirLightMapSampler, vUv1);
	if (uniform.bakeDir > 0.5) {
		if (dAtten > 0.00001) {
			let unpacked_dir = dirLm.xyz * 2.0 - vec3f(1.0);
			dAtten = clamp(dAtten, 0.0, 1.0);
			let combined_dir = dLightDirNormW.xyz * dAtten + unpacked_dir * dirLm.w;
			let finalRgb = normalize(combined_dir) * 0.5 + vec3f(0.5);
			let finalA = max(dirLm.w + dAtten, 1.0 / 255.0);
			output.color = vec4f(finalRgb, finalA);
		} else {
			output.color = dirLm;
		}
	} else {
		let alpha_min = select(0.0, 1.0 / 255.0, dAtten > 0.00001);
		let finalA = max(dirLm.w, alpha_min);
		output.color = vec4f(dirLm.rgb, finalA);
	}
`,bakeLmEndPS:`
#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT
	dDiffuseLight = ((dDiffuseLight - 0.5) * max(uniform.ambientBakeOcclusionContrast + 1.0, 0.0)) + 0.5;
	dDiffuseLight = dDiffuseLight + vec3f(uniform.ambientBakeOcclusionBrightness);
	dDiffuseLight = saturate3(dDiffuseLight);
	dDiffuseLight = dDiffuseLight * dAmbientLight;
#endif
#ifdef LIGHTMAP_RGBM
	var temp_color_rgbm = vec4f(dDiffuseLight, 1.0);
	temp_color_rgbm = vec4f(pow(temp_color_rgbm.rgb, vec3f(0.5)), temp_color_rgbm.a);
	temp_color_rgbm = vec4f(temp_color_rgbm.rgb / 8.0, temp_color_rgbm.a);
	let max_g_b = max(temp_color_rgbm.g, max(temp_color_rgbm.b, 1.0 / 255.0));
	let max_rgb = max(temp_color_rgbm.r, max_g_b);
	temp_color_rgbm.a = clamp(max_rgb, 0.0, 1.0);
	temp_color_rgbm.a = ceil(temp_color_rgbm.a * 255.0) / 255.0;
	temp_color_rgbm = vec4f(temp_color_rgbm.rgb / temp_color_rgbm.a, temp_color_rgbm.a);
	output.color = temp_color_rgbm;
#else
	output.color = vec4f(dDiffuseLight, 1.0);
#endif
`,basePS:`
uniform view_position: vec3f;
uniform light_globalAmbient: vec3f;
fn square(x: f32) -> f32 {
	return x*x;
}
fn saturate(x: f32) -> f32 {
	return clamp(x, 0.0, 1.0);
}
fn saturate3(x: vec3f) -> vec3f {
	return clamp(x, vec3f(0.0), vec3f(1.0));
}
`,baseNineSlicedPS:`
#define NINESLICED
varying vMask: vec2f;
varying vTiledUv: vec2f;
uniform innerOffset: vec4f;
uniform outerScale: vec2f;
uniform atlasRect: vec4f;
var<private> nineSlicedUv: vec2f;
`,baseNineSlicedTiledPS:`
#define NINESLICED
#define NINESLICETILED
varying vMask: vec2f;
varying vTiledUv: vec2f;
uniform innerOffset: vec4f;
uniform outerScale: vec2f;
uniform atlasRect: vec4f;
var<private> nineSlicedUv: vec2f;
`,bayerPS:`
fn bayer2(p: vec2f) -> f32 {
	return (2.0 * p.y + p.x + 1.0) % 4.0;
}
fn bayer4(p: vec2f) -> f32 {
	let p1: vec2f = p % vec2f(2.0);
	let p2: vec2f = floor(0.5 * (p % vec2f(4.0)));
	return 4.0 * bayer2(p1) + bayer2(p2);
}
fn bayer8(p: vec2f) -> f32 {
	let p1: vec2f = p % vec2f(2.0);
	let p2: vec2f = floor(0.5 * (p % vec2f(4.0)));
	let p4: vec2f = floor(0.25 * (p % vec2f(8.0)));
	return 4.0 * (4.0 * bayer2(p1) + bayer2(p2)) + bayer2(p4);
}
`,blurVSMPS:`
varying vUv0: vec2f;
var source: texture_2d<f32>;
var sourceSampler: sampler;
#ifdef GAUSS
	uniform weight: array<f32, {SAMPLES}>;
#endif
uniform pixelOffset: vec2f;
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	var moments: vec3f = vec3f(0.0);
	let uv: vec2f = input.vUv0 - uniform.pixelOffset * (f32({SAMPLES}) * 0.5);
	for (var i: i32 = 0; i < {SAMPLES}; i = i + 1) {
		let c: vec4f = textureSample(source, sourceSampler, uv + uniform.pixelOffset * f32(i));
		#ifdef GAUSS
			moments = moments + c.xyz * uniform.weight[i].element;
		#else
			moments = moments + c.xyz;
		#endif
	}
	#ifndef GAUSS
		moments = moments * (1.0 / f32({SAMPLES}));
	#endif
	output.color = vec4f(moments, 1.0);
	return output;
}
`,clearCoatPS:`
uniform material_clearCoat: f32;
fn getClearCoat() {
	ccSpecularity = uniform.material_clearCoat;
	#ifdef STD_CLEARCOAT_TEXTURE
	ccSpecularity = ccSpecularity * textureSampleBias({STD_CLEARCOAT_TEXTURE_NAME}, {STD_CLEARCOAT_TEXTURE_NAME}Sampler, {STD_CLEARCOAT_TEXTURE_UV}, uniform.textureBias).{STD_CLEARCOAT_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_CLEARCOAT_VERTEX
	ccSpecularity = ccSpecularity * saturate(vVertexColor.{STD_CLEARCOAT_VERTEX_CHANNEL});
	#endif
}
`,clearCoatGlossPS:`
	uniform material_clearCoatGloss: f32;
fn getClearCoatGlossiness() {
	ccGlossiness = uniform.material_clearCoatGloss;
	#ifdef STD_CLEARCOATGLOSS_TEXTURE
	ccGlossiness = ccGlossiness * textureSampleBias({STD_CLEARCOATGLOSS_TEXTURE_NAME}, {STD_CLEARCOATGLOSS_TEXTURE_NAME}Sampler, {STD_CLEARCOATGLOSS_TEXTURE_UV}, uniform.textureBias).{STD_CLEARCOATGLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_CLEARCOATGLOSS_VERTEX
	ccGlossiness = ccGlossiness * saturate(vVertexColor.{STD_CLEARCOATGLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_CLEARCOATGLOSS_INVERT
	ccGlossiness = 1.0 - ccGlossiness;
	#endif
	ccGlossiness += 0.0000001;
}
`,clearCoatNormalPS:`
#ifdef STD_CLEARCOATNORMAL_TEXTURE
	uniform material_clearCoatBumpiness: f32;
#endif
fn getClearCoatNormal() {
#ifdef STD_CLEARCOATNORMAL_TEXTURE
	var normalMap: vec3f = {STD_CLEARCOATNORMAL_TEXTURE_DECODE}(textureSampleBias({STD_CLEARCOATNORMAL_TEXTURE_NAME}, {STD_CLEARCOATNORMAL_TEXTURE_NAME}Sampler, {STD_CLEARCOATNORMAL_TEXTURE_UV}, uniform.textureBias));
	normalMap = mix(vec3f(0.0, 0.0, 1.0), normalMap, uniform.material_clearCoatBumpiness);
	ccNormalW = normalize(dTBN * normalMap);
#else
	ccNormalW = dVertexNormalW;
#endif
}
`,clusteredLightCookiesPS:`
fn _getCookieClustered(tex: texture_2d<f32>, texSampler: sampler, uv: vec2f, intensity: f32, cookieChannel: vec4f) -> vec3f {
	let pixel: vec4f = mix(vec4f(1.0), textureSampleLevel(tex, texSampler, uv, 0.0), intensity);
	let isRgb: bool = dot(cookieChannel.rgb, vec3f(1.0)) == 3.0;
	return select(vec3f(dot(pixel, cookieChannel)), pixel.rgb, isRgb);
}
fn getCookie2DClustered(tex: texture_2d<f32>, texSampler: sampler, transform: mat4x4f, worldPosition: vec3f, intensity: f32, cookieChannel: vec4f) -> vec3f {
	let projPos: vec4f = transform * vec4f(worldPosition, 1.0);
	return _getCookieClustered(tex, texSampler, projPos.xy / projPos.w, intensity, cookieChannel);
}
fn getCookieCubeClustered(tex: texture_2d<f32>, texSampler: sampler, dir: vec3f, intensity: f32, cookieChannel: vec4f, shadowTextureResolution: f32, shadowEdgePixels: f32, omniAtlasViewport: vec3f) -> vec3f {
	let uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);
	return _getCookieClustered(tex, texSampler, uv, intensity, cookieChannel);
}
`,clusteredLightShadowsPS:`
fn _getShadowCoordPerspZbuffer(shadowMatrix: mat4x4f, shadowParams: vec4f, wPos: vec3f) -> vec3f {
	var projPos = shadowMatrix * vec4f(wPos, 1.0);
	return projPos.xyz / projPos.w;
}
fn getShadowCoordPerspZbufferNormalOffset(shadowMatrix: mat4x4f, shadowParams: vec4f, normal: vec3f) -> vec3f {
	let wPos: vec3f = vPositionW + normal * shadowParams.y;
	return _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);
}
fn normalOffsetPointShadow(shadowParams: vec4f, lightPos: vec3f, lightDir: vec3f, lightDirNorm: vec3f, normal: vec3f) -> vec3f {
	let distScale: f32 = length(lightDir);
	let wPos: vec3f = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
	let dir: vec3f = wPos - lightPos;
	return dir;
}
#if defined(CLUSTER_SHADOW_TYPE_PCF1)
	fn getShadowOmniClusteredPCF1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowParams: vec4f, omniAtlasViewport: vec3f, shadowEdgePixels: f32, lightDir: vec3f) -> f32 {
		let shadowTextureResolution: f32 = shadowParams.x;
		let uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		let shadowZ: f32 = length(lightDir) * shadowParams.w + shadowParams.z;
		return textureSampleCompareLevel(shadowMap, shadowMapSampler, uv, shadowZ);
	}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF3)
	fn getShadowOmniClusteredPCF3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowParams: vec4f, omniAtlasViewport: vec3f, shadowEdgePixels: f32, lightDir: vec3f) -> f32 {
		let shadowTextureResolution: f32 = shadowParams.x;
		let uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		let shadowZ: f32 = length(lightDir) * shadowParams.w + shadowParams.z;
		let shadowCoord: vec3f = vec3f(uv, shadowZ);
		return getShadowPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams);
	}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF5)
	fn getShadowOmniClusteredPCF5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowParams: vec4f, omniAtlasViewport: vec3f, shadowEdgePixels: f32, lightDir: vec3f) -> f32 {
		let shadowTextureResolution: f32 = shadowParams.x;
		let uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);
		let shadowZ: f32 = length(lightDir) * shadowParams.w + shadowParams.z;
		let shadowCoord: vec3f = vec3f(uv, shadowZ);
		return getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams);
	}
#endif
#if defined(CLUSTER_SHADOW_TYPE_PCF1)
	fn getShadowSpotClusteredPCF1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
		return textureSampleCompareLevel(shadowMap, shadowMapSampler, shadowCoord.xy, shadowCoord.z);
	}
#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF3)
	fn getShadowSpotClusteredPCF3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
		return getShadowSpotPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams);
	}
#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF5)
	fn getShadowSpotClusteredPCF5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
		return getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams);
	}
#endif
`,clusteredLightUtilsPS:`
struct FaceCoords {
	uv: vec2f,
	faceIndex: f32,
	tileOffset: vec2f,
}
fn getCubemapFaceCoordinates(dir: vec3f) -> FaceCoords {
	var faceIndex: f32;
	var tileOffset: vec2f;
	var uv: vec2f;
	let vAbs: vec3f = abs(dir);
	var ma: f32;
	if (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {
		let is_neg_z = dir.z < 0.0;
		faceIndex = select(4.0, 5.0, is_neg_z);
		ma = 0.5 / vAbs.z;
		uv = vec2f(select(dir.x, -dir.x, is_neg_z), -dir.y);
		tileOffset = vec2f(2.0, select(0.0, 1.0, is_neg_z));
	} else if (vAbs.y >= vAbs.x) {
		let is_neg_y = dir.y < 0.0;
		faceIndex = select(2.0, 3.0, is_neg_y);
		ma = 0.5 / vAbs.y;
		uv = vec2f(dir.x, select(dir.z, -dir.z, is_neg_y));
		tileOffset = vec2f(1.0, select(0.0, 1.0, is_neg_y));
	} else {
		let is_neg_x = dir.x < 0.0;
		faceIndex = select(0.0, 1.0, is_neg_x);
		ma = 0.5 / vAbs.x;
		uv = vec2f(select(-dir.z, dir.z, is_neg_x), -dir.y);
		tileOffset = vec2f(0.0, select(0.0, 1.0, is_neg_x));
	}
	uv = uv * ma + 0.5;
	return FaceCoords(uv, faceIndex, tileOffset);
}
fn getCubemapAtlasCoordinates(omniAtlasViewport: vec3f, shadowEdgePixels: f32, shadowTextureResolution: f32, dir: vec3f) -> vec2f {
	let faceData: FaceCoords = getCubemapFaceCoordinates(dir);
	var uv: vec2f = faceData.uv;
	let tileOffset: vec2f = faceData.tileOffset;
	let atlasFaceSize: f32 = omniAtlasViewport.z;
	let tileSize: f32 = shadowTextureResolution * atlasFaceSize;
	var offset: f32 = shadowEdgePixels / tileSize;
	uv = uv * (1.0 - offset * 2.0) + offset;
	uv = uv * atlasFaceSize;
	uv = uv + tileOffset * atlasFaceSize;
	uv = uv + omniAtlasViewport.xy;
	return uv;
}
`,clusteredLightPS:`
#include "lightBufferDefinesPS"
#include "clusteredLightUtilsPS"
#ifdef CLUSTER_COOKIES
	#include "clusteredLightCookiesPS"
#endif
#ifdef CLUSTER_SHADOWS
	#include "clusteredLightShadowsPS"
#endif
var clusterWorldTexture: texture_2d<u32>;
var lightsTexture: texture_2d<uff>;
#ifdef CLUSTER_SHADOWS
	var shadowAtlasTexture: texture_depth_2d;
	var shadowAtlasTextureSampler: sampler_comparison;
#endif
#ifdef CLUSTER_COOKIES
	var cookieAtlasTexture: texture_2d<f32>;
	var cookieAtlasTextureSampler: sampler;
#endif
uniform clusterMaxCells: i32;
uniform numClusteredLights: i32;
uniform clusterTextureWidth: i32;
uniform clusterCellsCountByBoundsSize: vec3f;
uniform clusterBoundsMin: vec3f;
uniform clusterBoundsDelta: vec3f;
uniform clusterCellsDot: vec3i;
uniform clusterCellsMax: vec3i;
uniform shadowAtlasParams: vec2f;
struct ClusterLightData {
	flags: u32,
	halfWidth: vec3f,
	isSpot: bool,
	halfHeight: vec3f,
	lightIndex: i32,
	position: vec3f,
	shape: u32,
	direction: vec3f,
	falloffModeLinear: bool,
	color: vec3f,
	shadowIntensity: f32,
	omniAtlasViewport: vec3f,
	range: f32,
	cookieChannelMask: vec4f,
	biasesData: f32,
	colorBFlagsData: u32,
	shadowBias: f32,
	shadowNormalBias: f32,
	anglesData: f32,
	innerConeAngleCos: f32,
	outerConeAngleCos: f32,
	cookieIntensity: f32,
	isDynamic: bool,
	isLightmapped: bool
}
var<private> lightProjectionMatrix: mat4x4f;
fn sampleLightTextureF(lightIndex: i32, index: i32) -> vec4f {
	return textureLoad(lightsTexture, vec2<i32>(index, lightIndex), 0);
}
fn decodeClusterLightCore(clusterLightData: ptr<function, ClusterLightData>, lightIndex: i32) {
	clusterLightData.lightIndex = lightIndex;
	let halfData: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_COLOR_ANGLES_BIAS});
	clusterLightData.anglesData = halfData.z;
	clusterLightData.biasesData = halfData.w;
	clusterLightData.colorBFlagsData = bitcast<u32>(halfData.y);
	let colorRG: vec2f = unpack2x16float(bitcast<u32>(halfData.x));
	let colorB_flags: vec2f = unpack2x16float(clusterLightData.colorBFlagsData);
	clusterLightData.color = vec3f(colorRG, colorB_flags.x) * {LIGHT_COLOR_DIVIDER};
	let lightPosRange: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_POSITION_RANGE});
	clusterLightData.position = lightPosRange.xyz;
	clusterLightData.range = lightPosRange.w;
	let lightDir_Flags: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_DIRECTION_FLAGS});
	clusterLightData.direction = lightDir_Flags.xyz;
	let flags_uint: u32 = bitcast<u32>(lightDir_Flags.w);
	clusterLightData.flags = flags_uint;
	clusterLightData.isSpot = (flags_uint & (1u << 30u)) != 0u;
	clusterLightData.shape = (flags_uint >> 28u) & 0x3u;
	clusterLightData.falloffModeLinear = (flags_uint & (1u << 27u)) == 0u;
	clusterLightData.shadowIntensity = f32((flags_uint >> 0u) & 0xFFu) / 255.0;
	clusterLightData.cookieIntensity = f32((flags_uint >> 8u) & 0xFFu) / 255.0;
	clusterLightData.isDynamic = (flags_uint & (1u << 22u)) != 0u;
	clusterLightData.isLightmapped = (flags_uint & (1u << 21u)) != 0u;
}
fn decodeClusterLightSpot(clusterLightData: ptr<function, ClusterLightData>) {
	let angleFlags: u32 = (clusterLightData.colorBFlagsData >> 16u) & 0xFFFFu;
	let angleValues: vec2f = unpack2x16float(bitcast<u32>(clusterLightData.anglesData));
	let innerVal: f32 = angleValues.x;
	let outerVal: f32 = angleValues.y;
	let innerIsVersine: bool = (angleFlags & 1u) != 0u;
	let outerIsVersine: bool = ((angleFlags >> 1u) & 1u) != 0u;
	clusterLightData.innerConeAngleCos = select(innerVal, 1.0 - innerVal, innerIsVersine);
	clusterLightData.outerConeAngleCos = select(outerVal, 1.0 - outerVal, outerIsVersine);
}
fn decodeClusterLightOmniAtlasViewport(clusterLightData: ptr<function, ClusterLightData>) {
	clusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_0}).xyz;
}
fn decodeClusterLightAreaData(clusterLightData: ptr<function, ClusterLightData>) {
	clusterLightData.halfWidth = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_AREA_DATA_WIDTH}).xyz;
	clusterLightData.halfHeight = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_AREA_DATA_HEIGHT}).xyz;
}
fn decodeClusterLightProjectionMatrixData(clusterLightData: ptr<function, ClusterLightData>) {
	let m0: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_0});
	let m1: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_1});
	let m2: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_2});
	let m3: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_3});
	lightProjectionMatrix = mat4x4f(m0, m1, m2, m3);
}
fn decodeClusterLightShadowData(clusterLightData: ptr<function, ClusterLightData>) {
	let biases: vec2f = unpack2x16float(bitcast<u32>(clusterLightData.biasesData));
	clusterLightData.shadowBias = biases.x;
	clusterLightData.shadowNormalBias = biases.y;
}
fn decodeClusterLightCookieData(clusterLightData: ptr<function, ClusterLightData>) {
	let cookieFlags: u32 = (clusterLightData.flags >> 23u) & 0x0Fu;
	let mask_uvec: vec4<u32> = vec4<u32>(cookieFlags) & vec4<u32>(1u, 2u, 4u, 8u);
	clusterLightData.cookieChannelMask = step(vec4f(1.0), vec4f(mask_uvec));
}
fn evaluateLight(
	light: ptr<function, ClusterLightData>,
	worldNormal: vec3f,
	viewDir: vec3f,
	reflectionDir: vec3f,
#if defined(LIT_CLEARCOAT)
	clearcoatReflectionDir: vec3f,
#endif
	gloss: f32,
	specularity: vec3f,
	geometricNormal: vec3f,
	tbn: mat3x3f,
#if defined(LIT_IRIDESCENCE)
	iridescenceFresnel: vec3f,
#endif
	clearcoat_worldNormal: vec3f,
	clearcoat_gloss: f32,
	sheen_gloss: f32,
	iridescence_intensity: f32
) {
	var cookieAttenuation: vec3f = vec3f(1.0);
	var diffuseAttenuation: f32 = 1.0;
	var falloffAttenuation: f32 = 1.0;
	let lightDirW: vec3f = evalOmniLight(light.position);
	let lightDirNormW: vec3f = normalize(lightDirW);
	#ifdef CLUSTER_AREALIGHTS
	if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
		decodeClusterLightAreaData(light);
		if (light.shape == {LIGHTSHAPE_RECT}) {
			calcRectLightValues(light.position, light.halfWidth, light.halfHeight);
		} else if (light.shape == {LIGHTSHAPE_DISK}) {
			calcDiskLightValues(light.position, light.halfWidth, light.halfHeight);
		} else {
			calcSphereLightValues(light.position, light.halfWidth, light.halfHeight);
		}
		falloffAttenuation = getFalloffWindow(light.range, lightDirW);
	} else
	#endif
	{
		if (light.falloffModeLinear) {
			falloffAttenuation = getFalloffLinear(light.range, lightDirW);
		} else {
			falloffAttenuation = getFalloffInvSquared(light.range, lightDirW);
		}
	}
	if (falloffAttenuation > 0.00001) {
		#ifdef CLUSTER_AREALIGHTS
		if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
			if (light.shape == {LIGHTSHAPE_RECT}) {
				diffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			} else if (light.shape == {LIGHTSHAPE_DISK}) {
				diffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			} else {
				diffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;
			}
		} else
		#endif
		{
			falloffAttenuation = falloffAttenuation * getLightDiffuse(worldNormal, viewDir, lightDirNormW);
		}
		if (light.isSpot) {
			decodeClusterLightSpot(light);
			falloffAttenuation = falloffAttenuation * getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, lightDirNormW);
		}
		#if defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)
		if (falloffAttenuation > 0.00001) {
			if (light.shadowIntensity > 0.0 || light.cookieIntensity > 0.0) {
				if (light.isSpot) {
					decodeClusterLightProjectionMatrixData(light);
				} else {
					decodeClusterLightOmniAtlasViewport(light);
				}
				let shadowTextureResolution: f32 = uniform.shadowAtlasParams.x;
				let shadowEdgePixels: f32 = uniform.shadowAtlasParams.y;
				#ifdef CLUSTER_COOKIES
				if (light.cookieIntensity > 0.0) {
					decodeClusterLightCookieData(light);
					if (light.isSpot) {
						cookieAttenuation = getCookie2DClustered(cookieAtlasTexture, cookieAtlasTextureSampler, lightProjectionMatrix, vPositionW, light.cookieIntensity, light.cookieChannelMask);
					} else {
						cookieAttenuation = getCookieCubeClustered(cookieAtlasTexture, cookieAtlasTextureSampler, lightDirW, light.cookieIntensity, light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);
					}
				}
				#endif
				#ifdef CLUSTER_SHADOWS
				if (light.shadowIntensity > 0.0) {
					decodeClusterLightShadowData(light);
					let shadowParams: vec4f = vec4f(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);
					if (light.isSpot) {
						let shadowCoord: vec3f = getShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);
						#if defined(CLUSTER_SHADOW_TYPE_PCF1)
							let shadow: f32 = getShadowSpotClusteredPCF1(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)
							let shadow: f32 = getShadowSpotClusteredPCF3(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)
							let shadow: f32 = getShadowSpotClusteredPCF5(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCSS)
							let shadow: f32 = getShadowSpotClusteredPCSS(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);
						#endif
						falloffAttenuation = falloffAttenuation * mix(1.0, shadow, light.shadowIntensity);
					} else {
						let dir: vec3f = normalOffsetPointShadow(shadowParams, light.position, lightDirW, lightDirNormW, geometricNormal);
						#if defined(CLUSTER_SHADOW_TYPE_PCF1)
							let shadow: f32 = getShadowOmniClusteredPCF1(shadowAtlasTexture, shadowAtlasTextureSampler, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)
							let shadow: f32 = getShadowOmniClusteredPCF3(shadowAtlasTexture, shadowAtlasTextureSampler, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)
							let shadow: f32 = getShadowOmniClusteredPCF5(shadowAtlasTexture, shadowAtlasTextureSampler, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);
						#endif
						falloffAttenuation = falloffAttenuation * mix(1.0, shadow, light.shadowIntensity);
					}
				}
				#endif
			}
		}
		#endif
		#ifdef CLUSTER_AREALIGHTS
		if (light.shape != {LIGHTSHAPE_PUNCTUAL}) {
			{
				var areaDiffuse: vec3f = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;
				#if defined(LIT_SPECULAR)
					areaDiffuse = mix(areaDiffuse, vec3f(0.0), dLTCSpecFres);
				#endif
				dDiffuseLight = dDiffuseLight + areaDiffuse;
			}
			#ifdef LIT_SPECULAR
				var areaLightSpecular: f32;
				if (light.shape == {LIGHTSHAPE_RECT}) {
					areaLightSpecular = getRectLightSpecular(worldNormal, viewDir);
				} else if (light.shape == {LIGHTSHAPE_DISK}) {
					areaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);
				} else {
					areaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);
				}
				dSpecularLight = dSpecularLight + dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;
				#ifdef LIT_CLEARCOAT
					var areaLightSpecularCC: f32;
					if (light.shape == {LIGHTSHAPE_RECT}) {
						areaLightSpecularCC = getRectLightSpecular(clearcoat_worldNormal, viewDir);
					} else if (light.shape == {LIGHTSHAPE_DISK}) {
						areaLightSpecularCC = getDiskLightSpecular(clearcoat_worldNormal, viewDir);
					} else {
						areaLightSpecularCC = getSphereLightSpecular(clearcoat_worldNormal, viewDir);
					}
					ccSpecularLight = ccSpecularLight + ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;
				#endif
			#endif
		} else
		#endif
		{
			{
				var punctualDiffuse: vec3f = falloffAttenuation * light.color * cookieAttenuation;
				#if defined(CLUSTER_AREALIGHTS)
				#if defined(LIT_SPECULAR)
					punctualDiffuse = mix(punctualDiffuse, vec3f(0.0), specularity);
				#endif
				#endif
				dDiffuseLight = dDiffuseLight + punctualDiffuse;
			}
			#ifdef LIT_SPECULAR
				let halfDir: vec3f = normalize(-lightDirNormW + viewDir);
				#ifdef LIT_SPECULAR_FRESNEL
					dSpecularLight = dSpecularLight +
						getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation *
						getFresnel(
							dot(viewDir, halfDir),
							gloss,
							specularity
						#if defined(LIT_IRIDESCENCE)
							, iridescenceFresnel,
							iridescence_intensity
						#endif
							);
				#else
					dSpecularLight = dSpecularLight + getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;
				#endif
				#ifdef LIT_CLEARCOAT
					#ifdef LIT_SPECULAR_FRESNEL
						ccSpecularLight = ccSpecularLight + getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));
					#else
						ccSpecularLight = ccSpecularLight + getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation;
					#endif
				#endif
				#ifdef LIT_SHEEN
					sSpecularLight = sSpecularLight + getLightSpecularSheen(halfDir, worldNormal, viewDir, lightDirNormW, sheen_gloss) * falloffAttenuation * light.color * cookieAttenuation;
				#endif
			#endif
		}
	}
	dAtten = falloffAttenuation;
	dLightDirNormW = lightDirNormW;
}
fn evaluateClusterLight(
	lightIndex: i32,
	worldNormal: vec3f,
	viewDir: vec3f,
	reflectionDir: vec3f,
#if defined(LIT_CLEARCOAT)
	clearcoatReflectionDir: vec3f,
#endif
	gloss: f32,
	specularity: vec3f,
	geometricNormal: vec3f,
	tbn: mat3x3f,
#if defined(LIT_IRIDESCENCE)
	iridescenceFresnel: vec3f,
#endif
	clearcoat_worldNormal: vec3f,
	clearcoat_gloss: f32,
	sheen_gloss: f32,
	iridescence_intensity: f32
) {
	var clusterLightData: ClusterLightData;
	decodeClusterLightCore(&clusterLightData, lightIndex);
	#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS
		let acceptLightMask: bool = clusterLightData.isDynamic;
	#else
		let acceptLightMask: bool = clusterLightData.isLightmapped;
	#endif
	if (acceptLightMask) {
		evaluateLight(
			&clusterLightData,
			worldNormal,
			viewDir,
			reflectionDir,
#if defined(LIT_CLEARCOAT)
			clearcoatReflectionDir,
#endif
			gloss,
			specularity,
			geometricNormal,
			tbn,
#if defined(LIT_IRIDESCENCE)
			iridescenceFresnel,
#endif
			clearcoat_worldNormal,
			clearcoat_gloss,
			sheen_gloss,
			iridescence_intensity
		);
	}
}
fn addClusteredLights(
	worldNormal: vec3f,
	viewDir: vec3f,
	reflectionDir: vec3f,
#if defined(LIT_CLEARCOAT)
	clearcoatReflectionDir: vec3f,
#endif
	gloss: f32,
	specularity: vec3f,
	geometricNormal: vec3f,
	tbn: mat3x3f,
#if defined(LIT_IRIDESCENCE)
	iridescenceFresnel: vec3f,
#endif
	clearcoat_worldNormal: vec3f,
	clearcoat_gloss: f32,
	sheen_gloss: f32,
	iridescence_intensity: f32
) {
	if (uniform.numClusteredLights <= 1) {
		return;
	}
	let cellCoords: vec3i = vec3i(floor((vPositionW - uniform.clusterBoundsMin) * uniform.clusterCellsCountByBoundsSize));
	if (!(any(cellCoords < vec3i(0)) || any(cellCoords >= uniform.clusterCellsMax))) {
		let cellIndex: i32 = cellCoords.x * uniform.clusterCellsDot.x + cellCoords.y * uniform.clusterCellsDot.y + cellCoords.z * uniform.clusterCellsDot.z;
		let clusterV: i32 = cellIndex / uniform.clusterTextureWidth;
		let clusterU: i32 = cellIndex - clusterV * uniform.clusterTextureWidth;
		for (var lightCellIndex: i32 = 0; lightCellIndex < uniform.clusterMaxCells; lightCellIndex = lightCellIndex + 1) {
			let lightIndex: u32 = textureLoad(clusterWorldTexture, vec2<i32>(clusterU + lightCellIndex, clusterV), 0).r;
			if (lightIndex == 0u) {
				break;
			}
			evaluateClusterLight(
				i32(lightIndex),
				worldNormal,
				viewDir,
				reflectionDir,
#if defined(LIT_CLEARCOAT)
				clearcoatReflectionDir,
#endif
				gloss,
				specularity,
				geometricNormal,
				tbn,
#if defined(LIT_IRIDESCENCE)
				iridescenceFresnel,
#endif
				clearcoat_worldNormal,
				clearcoat_gloss,
				sheen_gloss,
				iridescence_intensity
			);
		}
	}
}`,combinePS:`
fn combineColor(albedo: vec3f, sheenSpecularity: vec3f, clearcoatSpecularity: f32) -> vec3f {
	var ret: vec3f = vec3f(0.0);
	#ifdef LIT_OLD_AMBIENT
		ret = ret + ((dDiffuseLight - uniform.light_globalAmbient) * albedo + uniform.material_ambient * uniform.light_globalAmbient);
	#else
		ret = ret + (albedo * dDiffuseLight);
	#endif
	#ifdef LIT_SPECULAR
		ret = ret + dSpecularLight;
	#endif
	#ifdef LIT_REFLECTIONS
		ret = ret + (dReflection.rgb * dReflection.a);
	#endif
	#ifdef LIT_SHEEN
		let sheenScaling: f32 = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;
		ret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;
	#endif
	#ifdef LIT_CLEARCOAT
		let clearCoatScaling: f32 = 1.0 - ccFresnel * clearcoatSpecularity;
		ret = ret * clearCoatScaling + (ccSpecularLight + ccReflection) * clearcoatSpecularity;
	#endif
	return ret;
}
`,cookieBlit2DPS:`
	varying uv0: vec2f;
	var blitTexture: texture_2d<f32>;
	var blitTextureSampler : sampler;
	@fragment
	fn fragmentMain(input : FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		output.color = textureSample(blitTexture, blitTextureSampler, input.uv0);
		return output;
	}
`,cookieBlitCubePS:`
	varying uv0: vec2f;
	uniform invViewProj: mat4x4<f32>;
	var blitTexture: texture_cube<f32>;
	var blitTextureSampler : sampler;
	@fragment
	fn fragmentMain(input : FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		var projPos = vec4f(input.uv0 * 2.0 - 1.0, 0.5, 1.0);
		var worldPos = uniform.invViewProj * projPos;
		output.color = textureSample(blitTexture, blitTextureSampler, worldPos.xyz);
		return output;
	}
`,cookieBlitVS:`
	attribute vertex_position: vec2f;
	varying uv0: vec2f;
	@vertex
	fn vertexMain(input: VertexInput) -> VertexOutput {
		var output: VertexOutput;
		output.position = vec4f(input.vertex_position, 0.5, 1.0);
		output.uv0 = input.vertex_position * 0.5 + vec2f(0.5, 0.5);
		output.uv0.y = 1.0 - output.uv0.y;
		return output;
	}
`,cubeMapProjectPS:`
#if LIT_CUBEMAP_PROJECTION == BOX
	uniform envBoxMin: vec3f;
	uniform envBoxMax: vec3f;
#endif
fn cubeMapProject(nrdir: vec3f) -> vec3f {
	#if LIT_CUBEMAP_PROJECTION == NONE
		return cubeMapRotate(nrdir);
	#endif
	#if LIT_CUBEMAP_PROJECTION == BOX
		let nrdir_rotated: vec3f = cubeMapRotate(nrdir);
		let rbmax: vec3f = (uniform.envBoxMax - vPositionW) / nrdir_rotated;
		let rbmin: vec3f = (uniform.envBoxMin - vPositionW) / nrdir_rotated;
		let rbminmax: vec3f = select(rbmin, rbmax, nrdir_rotated > vec3f(0.0));
		let fa: f32 = min(min(rbminmax.x, rbminmax.y), rbminmax.z);
		let posonbox: vec3f = vPositionW + nrdir_rotated * fa;
		let envBoxPos: vec3f = (uniform.envBoxMin + uniform.envBoxMax) * 0.5;
		return normalize(posonbox - envBoxPos);
	#endif
}
`,cubeMapRotatePS:`
#ifdef CUBEMAP_ROTATION
uniform cubeMapRotationMatrix: mat3x3f;
#endif
fn cubeMapRotate(refDir: vec3f) -> vec3f {
#ifdef CUBEMAP_ROTATION
	return refDir * uniform.cubeMapRotationMatrix;
#else
	return refDir;
#endif
}
`,debugOutputPS:`
#ifdef DEBUG_ALBEDO_PASS
output.color = vec4(gammaCorrectOutput(dAlbedo), 1.0);
#endif
#ifdef DEBUG_UV0_PASS
output.color = vec4f(litArgs_albedo , 1.0);
#endif
#ifdef DEBUG_WORLD_NORMAL_PASS
output.color = vec4f(litArgs_worldNormal * 0.5 + 0.5, 1.0);
#endif
#ifdef DEBUG_OPACITY_PASS
output.color = vec4f(vec3f(litArgs_opacity) , 1.0);
#endif
#ifdef DEBUG_SPECULARITY_PASS
output.color = vec4f(litArgs_specularity, 1.0);
#endif
#ifdef DEBUG_GLOSS_PASS
output.color = vec4f(vec3f(litArgs_gloss) , 1.0);
#endif
#ifdef DEBUG_METALNESS_PASS
output.color = vec4f(vec3f(litArgs_metalness) , 1.0);
#endif
#ifdef DEBUG_AO_PASS
output.color = vec4f(vec3f(litArgs_ao) , 1.0);
#endif
#ifdef DEBUG_EMISSION_PASS
output.color = vec4f(gammaCorrectOutput(litArgs_emission), 1.0);
#endif
`,debugProcessFrontendPS:`
#ifdef DEBUG_LIGHTING_PASS
	litArgs_albedo = vec3f(0.5);
#endif
#ifdef DEBUG_UV0_PASS
#ifdef VARYING_VUV0
	litArgs_albedo = vec3f(vUv0, 0.0);
#else
	litArgs_albedo = vec3f(0.0);
#endif
#endif
`,detailModesPS:`
#ifndef _DETAILMODES_INCLUDED_
#define _DETAILMODES_INCLUDED_
fn detailMode_mul(c1: vec3f, c2: vec3f) -> vec3f {
	return c1 * c2;
}
fn detailMode_add(c1: vec3f, c2: vec3f) -> vec3f {
	return c1 + c2;
}
fn detailMode_screen(c1: vec3f, c2: vec3f) -> vec3f {
	return 1.0 - (1.0 - c1)*(1.0 - c2);
}
fn detailMode_overlay(c1: vec3f, c2: vec3f) -> vec3f {
	return mix(1.0 - 2.0 * (1.0 - c1)*(1.0 - c2), 2.0 * c1 * c2, step(c1, vec3f(0.5)));
}
fn detailMode_min(c1: vec3f, c2: vec3f) -> vec3f {
	return min(c1, c2);
}
fn detailMode_max(c1: vec3f, c2: vec3f) -> vec3f {
	return max(c1, c2);
}
#endif
`,diffusePS:`
uniform material_diffuse: vec3f;
#ifdef STD_DIFFUSEDETAIL_TEXTURE
	#include "detailModesPS"
#endif
fn getAlbedo() {
	dAlbedo = uniform.material_diffuse.rgb;
	#ifdef STD_DIFFUSE_TEXTURE
		var albedoTexture: vec3f = {STD_DIFFUSE_TEXTURE_DECODE}(textureSampleBias({STD_DIFFUSE_TEXTURE_NAME}, {STD_DIFFUSE_TEXTURE_NAME}Sampler, {STD_DIFFUSE_TEXTURE_UV}, uniform.textureBias)).{STD_DIFFUSE_TEXTURE_CHANNEL};
		#ifdef STD_DIFFUSEDETAIL_TEXTURE
			var albedoDetail: vec3f = {STD_DIFFUSEDETAIL_TEXTURE_DECODE}(textureSampleBias({STD_DIFFUSEDETAIL_TEXTURE_NAME}, {STD_DIFFUSEDETAIL_TEXTURE_NAME}Sampler, {STD_DIFFUSEDETAIL_TEXTURE_UV}, uniform.textureBias)).{STD_DIFFUSEDETAIL_TEXTURE_CHANNEL};
			albedoTexture = detailMode_{STD_DIFFUSEDETAIL_DETAILMODE}(albedoTexture, albedoDetail);
		#endif
		dAlbedo = dAlbedo * albedoTexture;
	#endif
	#ifdef STD_DIFFUSE_VERTEX
		dAlbedo = dAlbedo * saturate3(vVertexColor.{STD_DIFFUSE_VERTEX_CHANNEL});
	#endif
}
`,decodePS:`
#ifndef _DECODE_INCLUDED_
#define _DECODE_INCLUDED_
fn decodeLinear(raw: vec4f) -> vec3f {
	return raw.rgb;
}
fn decodeGammaFloat(raw: f32) -> f32 {
	return pow(raw, 2.2);
}
fn decodeGamma3(raw: vec3f) -> vec3f {
	return pow(raw, vec3f(2.2));
}
fn decodeGamma(raw: vec4f) -> vec3f {
	return pow(raw.xyz, vec3f(2.2));
}
fn decodeRGBM(raw: vec4f) -> vec3f {
	let color = (8.0 * raw.a) * raw.rgb;
	return color * color;
}
fn decodeRGBP(raw: vec4f) -> vec3f {
	let color = raw.rgb * (-raw.a * 7.0 + 8.0);
	return color * color;
}
fn decodeRGBE(raw: vec4f) -> vec3f {
	return select(vec3f(0.0), raw.xyz * pow(2.0, raw.w * 255.0 - 128.0), raw.a != 0.0);
}
fn passThrough(raw: vec4f) -> vec4f {
	return raw;
}
fn unpackNormalXYZ(nmap: vec4f) -> vec3f {
	return nmap.xyz * 2.0 - 1.0;
}
fn unpackNormalXY(nmap: vec4f) -> vec3f {
	var xy = nmap.wy * 2.0 - 1.0;
	return vec3f(xy, sqrt(1.0 - clamp(dot(xy, xy), 0.0, 1.0)));
}
#endif
`,emissivePS:`
uniform material_emissive: vec3f;
uniform material_emissiveIntensity: f32;
fn getEmission() {
	dEmission = uniform.material_emissive * uniform.material_emissiveIntensity;
	#ifdef STD_EMISSIVE_TEXTURE
	dEmission *= {STD_EMISSIVE_TEXTURE_DECODE}(textureSampleBias({STD_EMISSIVE_TEXTURE_NAME}, {STD_EMISSIVE_TEXTURE_NAME}Sampler, {STD_EMISSIVE_TEXTURE_UV}, uniform.textureBias)).{STD_EMISSIVE_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_EMISSIVE_VERTEX
	dEmission = dEmission * saturate3(vVertexColor.{STD_EMISSIVE_VERTEX_CHANNEL});
	#endif
}
`,encodePS:`
fn encodeLinear(source: vec3f) -> vec4f {
	return vec4f(source, 1.0);
}
fn encodeGamma(source: vec3f) -> vec4f {
	return vec4f(pow(source + vec3f(0.0000001), vec3f(1.0 / 2.2)), 1.0);
}
fn encodeRGBM(source: vec3f) -> vec4f {
	var color: vec3f = pow(source, vec3f(0.5));
	color *= 1.0 / 8.0;
	var a: f32 = saturate(max(max(color.r, color.g), max(color.b, 1.0 / 255.0)));
	a = ceil(a * 255.0) / 255.0;
	color /= a;
	return vec4f(color, a);
}
fn encodeRGBP(source: vec3f) -> vec4f {
	var gamma: vec3f = pow(source, vec3f(0.5));
	var maxVal: f32 = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));
	var v: f32 = 1.0 - ((maxVal - 1.0) / 7.0);
	v = ceil(v * 255.0) / 255.0;
	return vec4f(gamma / (-v * 7.0 + 8.0), v);
}
fn encodeRGBE(source: vec3f) -> vec4f {
	var maxVal: f32 = max(source.x, max(source.y, source.z));
	if (maxVal < 1e-32) {
		return vec4f(0.0, 0.0, 0.0, 0.0);
	} else {
		var e: f32 = ceil(log2(maxVal));
		return vec4f(source / pow(2.0, e), (e + 128.0) / 255.0);
	}
}
`,endPS:`
	var finalRgb: vec3f = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);
	finalRgb = finalRgb + litArgs_emission;
	finalRgb = addFog(finalRgb);
	finalRgb = toneMap(finalRgb);
	finalRgb = gammaCorrectOutput(finalRgb);
	output.color = vec4f(finalRgb, output.color.a);
`,envAtlasPS:`
#ifndef _ENVATLAS_INCLUDED_
#define _ENVATLAS_INCLUDED_
const atlasSize : f32 = 512.0;
const seamSize : f32 = 1.0 / atlasSize;
fn mapUv(uv : vec2f, rect : vec4f) -> vec2f {
	return vec2f(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),
				 mix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));
}
fn mapRoughnessUv(uv : vec2f, level : f32) -> vec2f {
	let t : f32 = 1.0 / exp2(level);
	return mapUv(uv, vec4f(0.0, 1.0 - t, t, t * 0.5));
}
fn mapShinyUv(uv : vec2f, level : f32) -> vec2f {
	let t : f32 = 1.0 / exp2(level);
	return mapUv(uv, vec4f(1.0 - t, 1.0 - t, t, t * 0.5));
}
#endif
`,envProcPS:`
#ifdef LIT_SKYBOX_INTENSITY
	uniform skyboxIntensity : f32;
#endif
fn processEnvironment(color : vec3f) -> vec3f {
	#ifdef LIT_SKYBOX_INTENSITY
		return color * uniform.skyboxIntensity;
	#else
		return color;
	#endif
}
`,falloffInvSquaredPS:`
fn getFalloffWindow(lightRadius: f32, lightDir: vec3f) -> f32 {
	let sqrDist: f32 = dot(lightDir, lightDir);
	let invRadius: f32 = 1.0 / lightRadius;
	return square(saturate(1.0 - square(sqrDist * square(invRadius))));
}
fn getFalloffInvSquared(lightRadius: f32, lightDir: vec3f) -> f32 {
	let sqrDist: f32 = dot(lightDir, lightDir);
	var falloff: f32 = 1.0 / (sqrDist + 1.0);
	let invRadius: f32 = 1.0 / lightRadius;
	falloff = falloff * 16.0;
	falloff = falloff * square(saturate(1.0 - square(sqrDist * square(invRadius))));
	return falloff;
}
`,falloffLinearPS:`
fn getFalloffLinear(lightRadius: f32, lightDir: vec3f) -> f32 {
	let d: f32 = length(lightDir);
	return max(((lightRadius - d) / lightRadius), 0.0);
}
`,floatAsUintPS:`
#ifndef FLOAT_AS_UINT
#define FLOAT_AS_UINT
fn float2uint(value: f32) -> vec4f {
	let intBits = bitcast<u32>(value);
	return vec4f(
		f32((intBits >> 24u) & 0xffu),
		f32((intBits >> 16u) & 0xffu),
		f32((intBits >> 8u) & 0xffu),
		f32(intBits & 0xffu)
	) / 255.0;
}
fn uint2float(value: vec4f) -> f32 {
	let rgba_u32 = vec4<u32>(value * 255.0);
	let intBits: u32 =
		(rgba_u32.r << 24u) |
		(rgba_u32.g << 16u) |
		(rgba_u32.b << 8u)  |
		 rgba_u32.a;
	return bitcast<f32>(intBits);
}
fn float2vec4(value: f32) -> vec4f {
	#if defined(CAPS_TEXTURE_FLOAT_RENDERABLE)
		return vec4f(value, 1.0, 1.0, 1.0);
	#else
		return float2uint(value);
	#endif
}
#endif
`,fogPS:`
var<private> dBlendModeFogFactor : f32 = 1.0;
#if (FOG != NONE)
	uniform fog_color : vec3f;
	
	#if (FOG == LINEAR)
		uniform fog_start : f32;
		uniform fog_end : f32;
	#else
		uniform fog_density : f32;
	#endif
#endif
fn getFogFactor() -> f32 {
	let depth = pcPosition.z / pcPosition.w;
	var fogFactor : f32 = 0.0;
	#if (FOG == LINEAR)
		fogFactor = (uniform.fog_end - depth) / (uniform.fog_end - uniform.fog_start);
	#elif (FOG == EXP)
		fogFactor = exp(-depth * uniform.fog_density);
	#elif (FOG == EXP2)
		fogFactor = exp(-depth * depth * uniform.fog_density * uniform.fog_density);
	#endif
	return clamp(fogFactor, 0.0, 1.0);
}
fn addFog(color : vec3f) -> vec3f {
	#if (FOG != NONE)
		return mix(uniform.fog_color * dBlendModeFogFactor, color, getFogFactor());
	#else
		return color;
	#endif
}
`,fresnelSchlickPS:`
fn getFresnel(
		cosTheta: f32,
		gloss: f32,
		specularity: vec3f
	#if defined(LIT_IRIDESCENCE)
		, iridescenceFresnel: vec3f,
		iridescenceIntensity: f32
	#endif
) -> vec3f {
	let fresnel: f32 = pow(1.0 - saturate(cosTheta), 5.0);
	let glossSq: f32 = gloss * gloss;
	let specIntensity: f32 = max(specularity.r, max(specularity.g, specularity.b));
	let ret: vec3f = specularity + (max(vec3f(glossSq * specIntensity), specularity) - specularity) * fresnel;
	#if defined(LIT_IRIDESCENCE)
		return mix(ret, iridescenceFresnel, iridescenceIntensity);
	#else
		return ret;
	#endif
}
fn getFresnelCC(cosTheta: f32) -> f32 {
	let fresnel: f32 = pow(1.0 - saturate(cosTheta), 5.0);
	return 0.04 + (1.0 - 0.04) * fresnel;
}`,frontendCodePS:"",frontendDeclPS:"",fullscreenQuadVS:`
attribute vertex_position: vec2f;
varying vUv0: vec2f;
@vertex
fn vertexMain(input: VertexInput) -> VertexOutput {
	var output: VertexOutput;
	output.position = vec4f(input.vertex_position, 0.5, 1.0);
	output.vUv0 = input.vertex_position.xy * 0.5 + vec2f(0.5);
	return output;
}
`,gammaPS:`
#include "decodePS"
#if (GAMMA == SRGB)
	fn gammaCorrectInput(color: f32) -> f32 {
		return decodeGammaFloat(color);
	}
	fn gammaCorrectInputVec3(color: vec3f) -> vec3f {
		return decodeGamma3(color);
	}
	fn gammaCorrectInputVec4(color: vec4f) -> vec4f {
		return vec4f(decodeGamma3(color.xyz), color.w);
	}
	fn gammaCorrectOutput(color: vec3f) -> vec3f {
		return pow(color + 0.0000001, vec3f(1.0 / 2.2));
	}
#else
	fn gammaCorrectInput(color: f32) -> f32 {
		return color;
	}
	fn gammaCorrectInputVec3(color: vec3f) -> vec3f {
		return color;
	}
	fn gammaCorrectInputVec4(color: vec4f) -> vec4f {
		return color;
	}
	fn gammaCorrectOutput(color: vec3f) -> vec3f {
		return color;
	}
#endif
`,glossPS:`
#ifdef STD_GLOSS_CONSTANT
	uniform material_gloss: f32;
#endif
fn getGlossiness() {
	dGlossiness = 1.0;
	#ifdef STD_GLOSS_CONSTANT
	dGlossiness = dGlossiness * uniform.material_gloss;
	#endif
	#ifdef STD_GLOSS_TEXTURE
	dGlossiness = dGlossiness * textureSampleBias({STD_GLOSS_TEXTURE_NAME}, {STD_GLOSS_TEXTURE_NAME}Sampler, {STD_GLOSS_TEXTURE_UV}, uniform.textureBias).{STD_GLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_GLOSS_VERTEX
	dGlossiness = dGlossiness * saturate(vVertexColor.{STD_GLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_GLOSS_INVERT
	dGlossiness = 1.0 - dGlossiness;
	#endif
	dGlossiness = dGlossiness + 0.0000001;
}
`,quadVS:`
	attribute aPosition: vec2f;
	varying uv0: vec2f;
	@vertex fn vertexMain(input: VertexInput) -> VertexOutput {
		var output: VertexOutput;
		output.position = vec4f(input.aPosition, 0.0, 1.0);
		output.uv0 = getImageEffectUV((input.aPosition + 1.0) * 0.5);
		return output;
	}
`,indirectCoreCS:`
struct DrawIndexedIndirectArgs {
	indexCount: u32,
	instanceCount: u32,
	firstIndex: u32,
	baseVertex: i32,
	firstInstance: u32
};
struct DrawIndirectArgs {
	vertexCount: u32,
	instanceCount: u32,
	firstVertex: u32,
	firstInstance: u32,
	_pad: u32
};
`,immediateLinePS:`
	#include "gammaPS"
	varying color: vec4f;
	@fragment
	fn fragmentMain(input : FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		output.color = vec4f(gammaCorrectOutput(decodeGamma3(input.color.rgb)), input.color.a);
		return output;
	}
`,immediateLineVS:`
	attribute vertex_position: vec4f;
	attribute vertex_color: vec4f;
	uniform matrix_model: mat4x4f;
	uniform matrix_viewProjection: mat4x4f;
	varying color: vec4f;
	@vertex
	fn vertexMain(input : VertexInput) -> VertexOutput {
		var output : VertexOutput;
		output.color = input.vertex_color;
		output.position = uniform.matrix_viewProjection * uniform.matrix_model * input.vertex_position;
		return output;
	}
`,iridescenceDiffractionPS:`
uniform material_iridescenceRefractionIndex: f32;
fn iridescence_iorToFresnelScalar(transmittedIor: f32, incidentIor: f32) -> f32 {
	return pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);
}
fn iridescence_iorToFresnelVec3(transmittedIor: vec3f, incidentIor: f32) -> vec3f {
	return pow((transmittedIor - vec3f(incidentIor)) / (transmittedIor + vec3f(incidentIor)), vec3f(2.0));
}
fn iridescence_fresnelToIor(f0: vec3f) -> vec3f {
	let sqrtF0: vec3f = sqrt(f0);
	return (vec3f(1.0) + sqrtF0) / (vec3f(1.0) - sqrtF0);
}
const XYZ_TO_REC709: mat3x3f = mat3x3f(
	vec3f(3.2404542, -1.5371385, -0.4985314),
	vec3f(-0.9692660,  1.8760108,  0.0415560),
	vec3f(0.0556434, -0.2040259,  1.0572252)
);
fn iridescence_sensitivity(opd: f32, shift: vec3f) -> vec3f {
	let PI: f32 = 3.141592653589793;
	let phase: f32 = 2.0 * PI * opd * 1.0e-9;
	const val: vec3f = vec3f(5.4856e-13, 4.4201e-13, 5.2481e-13);
	const pos: vec3f = vec3f(1.6810e+06, 1.7953e+06, 2.2084e+06);
	const var_: vec3f = vec3f(4.3278e+09, 9.3046e+09, 6.6121e+09);
	var xyz: vec3f = val * sqrt(2.0 * PI * var_) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var_);
	xyz.x = xyz.x + 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));
	xyz = xyz / vec3f(1.0685e-07);
	return XYZ_TO_REC709 * xyz;
}
fn iridescence_fresnelScalar(cosTheta: f32, f0: f32) -> f32 {
	let x: f32 = clamp(1.0 - cosTheta, 0.0, 1.0);
	let x2: f32 = x * x;
	let x5: f32 = x * x2 * x2;
	return f0 + (1.0 - f0) * x5;
}
fn iridescence_fresnelVec3(cosTheta: f32, f0: vec3f) -> vec3f {
	let x: f32 = clamp(1.0 - cosTheta, 0.0, 1.0);
	let x2: f32 = x * x;
	let x5: f32 = x * x2 * x2;
	return f0 + (vec3f(1.0) - f0) * x5;
}
fn calcIridescence(outsideIor: f32, cosTheta: f32, base_f0: vec3f, iridescenceThickness: f32) -> vec3f {
	let PI: f32 = 3.141592653589793;
	let iridescenceIor: f32 = mix(outsideIor, uniform.material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));
	let sinTheta2Sq: f32 = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));
	let cosTheta2Sq: f32 = 1.0 - sinTheta2Sq;
	if (cosTheta2Sq < 0.0) {
		return vec3f(1.0);
	}
	let cosTheta2: f32 = sqrt(cosTheta2Sq);
	let r0: f32 = iridescence_iorToFresnelScalar(iridescenceIor, outsideIor);
	let r12: f32 = iridescence_fresnelScalar(cosTheta, r0);
	let r21: f32 = r12;
	let t121: f32 = 1.0 - r12;
	let phi12: f32 = select(0.0, PI, iridescenceIor < outsideIor);
	let phi21: f32 = PI - phi12;
	let baseIor: vec3f = iridescence_fresnelToIor(base_f0 + vec3f(0.0001));
	let r1: vec3f = iridescence_iorToFresnelVec3(baseIor, iridescenceIor);
	let r23: vec3f = iridescence_fresnelVec3(cosTheta2, r1);
	let phi23: vec3f = select(vec3f(0.0), vec3f(PI), baseIor < vec3f(iridescenceIor));
	let opd: f32 = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;
	let phi: vec3f = vec3f(phi21) + phi23;
	let r123Sq: vec3f = clamp(vec3f(r12) * r23, vec3f(1e-5), vec3f(0.9999));
	let r123: vec3f = sqrt(r123Sq);
	let rs: vec3f = pow(vec3f(t121), vec3f(2.0)) * r23 / (vec3f(1.0) - r123Sq);
	let c0: vec3f = vec3f(r12) + rs;
	var i_irid: vec3f = c0;
	var cm: vec3f = rs - vec3f(t121);
	cm = cm * r123;
	let sm1: vec3f = 2.0 * iridescence_sensitivity(1.0 * opd, 1.0 * phi);
	i_irid = i_irid + cm * sm1;
	cm = cm * r123;
	let sm2: vec3f = 2.0 * iridescence_sensitivity(2.0 * opd, 2.0 * phi);
	i_irid = i_irid + cm * sm2;
	return max(i_irid, vec3f(0.0));
}
fn getIridescenceDiffraction(cosTheta: f32, specularity: vec3f, iridescenceThickness: f32) -> vec3f {
	return calcIridescence(1.0, cosTheta, specularity, iridescenceThickness);
}
`,iridescencePS:`
#ifdef STD_IRIDESCENCE_CONSTANT
	uniform material_iridescence: f32;
#endif
fn getIridescence() {
	var iridescence = 1.0;
	#ifdef STD_IRIDESCENCE_CONSTANT
	iridescence = iridescence * uniform.material_iridescence;
	#endif
	#ifdef STD_IRIDESCENCE_TEXTURE
	iridescence = iridescence * textureSampleBias({STD_IRIDESCENCE_TEXTURE_NAME}, {STD_IRIDESCENCE_TEXTURE_NAME}Sampler, {STD_IRIDESCENCE_TEXTURE_UV}, uniform.textureBias).{STD_IRIDESCENCE_TEXTURE_CHANNEL};
	#endif
	dIridescence = iridescence; 
}
`,iridescenceThicknessPS:`
uniform material_iridescenceThicknessMax: f32;
#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE
	uniform material_iridescenceThicknessMin: f32;
#endif
fn getIridescenceThickness() {
	#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE
		var blend: f32 = textureSampleBias({STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}, {STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}Sampler, {STD_IRIDESCENCETHICKNESS_TEXTURE_UV}, uniform.textureBias).{STD_IRIDESCENCETHICKNESS_TEXTURE_CHANNEL};
		var iridescenceThickness: f32 = mix(uniform.material_iridescenceThicknessMin, uniform.material_iridescenceThicknessMax, blend);
	#else
		var iridescenceThickness: f32 = uniform.material_iridescenceThicknessMax;
	#endif
	dIridescenceThickness = iridescenceThickness; 
}
`,iorPS:`
#ifdef STD_IOR_CONSTANT
	uniform material_refractionIndex: f32;
#endif
fn getIor() {
#ifdef STD_IOR_CONSTANT
	dIor = uniform.material_refractionIndex;
#else
	dIor = 1.0 / 1.5;
#endif
}
`,lightDeclarationPS:`
#if defined(LIGHT{i})
	uniform light{i}_color: vec3f;
	#if LIGHT{i}TYPE == DIRECTIONAL
		uniform light{i}_direction: vec3f;
	#else
		#define LIT_CODE_LIGHTS_POINT
		uniform light{i}_position: vec3f;
		uniform light{i}_radius: f32;
		#if LIGHT{i}TYPE == SPOT
			#define LIT_CODE_LIGHTS_SPOT
			uniform light{i}_direction: vec3f;
			uniform light{i}_innerConeAngle: f32;
			uniform light{i}_outerConeAngle: f32;
		#endif
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#define LIT_CODE_FALLOFF_SQUARED
		#if LIGHT{i}TYPE == DIRECTIONAL
			uniform light{i}_position: vec3f;
		#endif
		uniform light{i}_halfWidth: vec3f;
		uniform light{i}_halfHeight: vec3f;
	#else
		#if LIGHT{i}FALLOFF == LINEAR
			#define LIT_CODE_FALLOFF_LINEAR
		#endif
		#if LIGHT{i}FALLOFF == INVERSESQUARED
			#define LIT_CODE_FALLOFF_SQUARED
		#endif
	#endif
	#if defined(LIGHT{i}CASTSHADOW)
		#if LIGHT{i}TYPE != OMNI
			uniform light{i}_shadowMatrix: mat4x4f;
		#endif
		uniform light{i}_shadowIntensity: f32;
		uniform light{i}_shadowParams: vec4f;
		#if LIGHT{i}SHADOWTYPE == PCSS_32F
			uniform light{i}_shadowSearchArea: f32;
			uniform light{i}_cameraParams: vec4f;
			#if LIGHT{i}TYPE == DIRECTIONAL
				uniform light{i}_softShadowParams: vec4f;
			#endif
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			uniform light{i}_shadowMatrixPalette: array<mat4x4f, 4>;
			uniform light{i}_shadowCascadeDistances: vec4f;
			uniform light{i}_shadowCascadeCount: i32;
			uniform light{i}_shadowCascadeBlend: f32;
		#endif
		#if LIGHT{i}TYPE == OMNI
			NOT SUPPORTED
			
		#else
			#if defined(LIGHT{i}SHADOW_PCF)
				var light{i}_shadowMap: texture_depth_2d;
				var light{i}_shadowMapSampler: sampler_comparison;
			#else
				var light{i}_shadowMap: texture_2d<f32>;
				var light{i}_shadowMapSampler: sampler;
			#endif
		#endif
	#endif
	#if defined(LIGHT{i}COOKIE)
		#define LIT_CODE_COOKIE
		#if LIGHT{i}TYPE == OMNI
			NOT SUPPORTED
		#endif
		#if LIGHT{i}TYPE == SPOT
			NOT SUPPORTED
		#endif
	#endif
#endif
`,lightDiffuseLambertPS:`
fn getLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f) -> f32 {
	return max(dot(worldNormal, -lightDirNorm), 0.0);
}
`,lightDirPointPS:`
fn evalOmniLight(lightPosW: vec3f) -> vec3f {
	return vPositionW - lightPosW;
}
`,lightEvaluationPS:`
#if defined(LIGHT{i})
	evaluateLight{i}(
		#if defined(LIT_IRIDESCENCE)
			iridescenceFresnel
		#endif
	);
#endif
`,lightFunctionLightPS:`
#if defined(LIGHT{i})
fn evaluateLight{i}(
	#if defined(LIT_IRIDESCENCE)
		iridescenceFresnel: vec3f
	#endif
) {
	var lightColor: vec3f = uniform.light{i}_color;
	#if LIGHT{i}TYPE == DIRECTIONAL && !defined(LIT_SHADOW_CATCHER)
		if (all(lightColor == vec3f(0.0, 0.0, 0.0))) {
			return;
		}
	#endif
	#if LIGHT{i}TYPE == DIRECTIONAL
		dLightDirNormW = uniform.light{i}_direction;
		dAtten = 1.0;
	#else
		var lightDirW: vec3f = evalOmniLight(uniform.light{i}_position);
		dLightDirNormW = normalize(lightDirW);
		#if defined(LIGHT{i}COOKIE)
			#if LIGHT{i}TYPE == SPOT
				#ifdef LIGHT{i}COOKIE_FALLOFF
					#ifdef LIGHT{i}COOKIE_TRANSFORM
						var cookieAttenuation: vec3f = getCookie2DXform(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity, uniform.light{i}_cookieMatrix, uniform.light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};
					#else
						var cookieAttenuation: vec3f = getCookie2D(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
					#endif
				#else
					#ifdef LIGHT{i}COOKIE_TRANSFORM
						var cookieAttenuation: vec3f = getCookie2DClipXform(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity, uniform.light{i}_cookieMatrix, uniform.light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};
					#else
						var cookieAttenuation: vec3f = getCookie2DClip(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
					#endif
				#endif
			#endif
			#if LIGHT{i}TYPE == OMNI
				var cookieAttenuation: vec3f = getCookieCube(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};
			#endif
			lightColor = lightColor * cookieAttenuation;
		#endif
		#if LIGHT{i}SHAPE == PUNCTUAL
			#if LIGHT{i}FALLOFF == LINEAR
				dAtten = getFalloffLinear(uniform.light{i}_radius, lightDirW);
			#else
				dAtten = getFalloffInvSquared(uniform.light{i}_radius, lightDirW);
			#endif
		#else
			dAtten = getFalloffWindow(uniform.light{i}_radius, lightDirW);
		#endif
		#if LIGHT{i}TYPE == SPOT
			#if !defined(LIGHT{i}COOKIE) || defined(LIGHT{i}COOKIE_FALLOFF)
				dAtten = dAtten * getSpotEffect(uniform.light{i}_direction, uniform.light{i}_innerConeAngle, uniform.light{i}_outerConeAngle, dLightDirNormW);
			#endif
		#endif
	#endif
	if (dAtten < 0.00001) {
		return;
	}
	#if LIGHT{i}SHAPE != PUNCTUAL
		#if LIGHT{i}SHAPE == RECT
			calcRectLightValues(uniform.light{i}_position, uniform.light{i}_halfWidth, uniform.light{i}_halfHeight);
		#elif LIGHT{i}SHAPE == DISK
			calcDiskLightValues(uniform.light{i}_position, uniform.light{i}_halfWidth, uniform.light{i}_halfHeight);
		#elif LIGHT{i}SHAPE == SPHERE
			calcSphereLightValues(uniform.light{i}_position, uniform.light{i}_halfWidth, uniform.light{i}_halfHeight);
		#endif
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#if LIGHT{i}TYPE == DIRECTIONAL
			var attenDiffuse: f32 = getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirNormW);
		#else
			#if LIGHT{i}SHAPE == RECT
				var attenDiffuse: f32 = getRectLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#elif LIGHT{i}SHAPE == DISK
				var attenDiffuse: f32 = getDiskLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#elif LIGHT{i}SHAPE == SPHERE
				var attenDiffuse: f32 = getSphereLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;
			#endif
		#endif
	#else
		dAtten = dAtten * getLightDiffuse(litArgs_worldNormal, vec3(0.0), dLightDirNormW);
	#endif
	#ifdef LIGHT{i}CASTSHADOW
		#if LIGHT{i}TYPE == DIRECTIONAL
			var shadow: f32 = getShadow{i}(vec3(0.0));
		#else
			var shadow: f32 = getShadow{i}(lightDirW);
		#endif
		shadow = mix(1.0, shadow, uniform.light{i}_shadowIntensity);
		dAtten = dAtten * shadow;
		#if defined(LIT_SHADOW_CATCHER) && LIGHT{i}TYPE == DIRECTIONAL
			dShadowCatcher = dShadowCatcher * shadow;
		#endif			
	#endif
	#if LIGHT{i}SHAPE != PUNCTUAL
		#ifdef LIT_SPECULAR
			dDiffuseLight = dDiffuseLight + (((attenDiffuse * dAtten) * lightColor) * (1.0 - dLTCSpecFres));
		#else
			dDiffuseLight = dDiffuseLight + ((attenDiffuse * dAtten) * lightColor);
		#endif						
	#else
		#if defined(AREA_LIGHTS) && defined(LIT_SPECULAR)
			dDiffuseLight = dDiffuseLight + ((dAtten * lightColor) * (1.0 - litArgs_specularity));
		#else
			dDiffuseLight = dDiffuseLight + (dAtten * lightColor);
		#endif
	#endif
	#ifdef LIGHT{i}AFFECT_SPECULARITY
		#if LIGHT{i}SHAPE != PUNCTUAL
			#ifdef LIT_CLEARCOAT
				#if LIGHT{i}SHAPE == RECT
					ccSpecularLight = ccSpecularLight + (ccLTCSpecFres * getRectLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor);
				#elif LIGHT{i}SHAPE == DISK
					ccSpecularLight = ccSpecularLight + (ccLTCSpecFres * getDiskLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor);
				#elif LIGHT{i}SHAPE == SPHERE
					ccSpecularLight = ccSpecularLight + (ccLTCSpecFres * getSphereLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor);
				#endif
			#endif
			#ifdef LIT_SPECULAR
				#if LIGHT{i}SHAPE == RECT
					dSpecularLight = dSpecularLight + (dLTCSpecFres * getRectLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor);
				#elif LIGHT{i}SHAPE == DISK
					dSpecularLight = dSpecularLight + (dLTCSpecFres * getDiskLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor);
				#elif LIGHT{i}SHAPE == SPHERE
					dSpecularLight = dSpecularLight + (dLTCSpecFres * getSphereLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor);
				#endif
			#endif
		#else
			#if LIGHT{i}TYPE == DIRECTIONAL && LIT_FRESNEL_MODEL != NONE
				#define LIGHT{i}FRESNEL
			#endif
			#ifdef LIT_SPECULAR
				var halfDirW: vec3f = normalize(-dLightDirNormW + dViewDirW);
			#endif
			#ifdef LIT_CLEARCOAT
				var lightspecularCC: vec3f = getLightSpecular(halfDirW, ccReflDirW, litArgs_clearcoat_worldNormal, dViewDirW, dLightDirNormW, litArgs_clearcoat_gloss, dTBN) * dAtten * lightColor;
				#ifdef LIGHT{i}FRESNEL
					lightspecularCC = lightspecularCC * getFresnelCC(dot(dViewDirW, halfDirW));
				#endif
				ccSpecularLight = ccSpecularLight + lightspecularCC;
			#endif
			#ifdef LIT_SHEEN
				sSpecularLight = sSpecularLight + (getLightSpecularSheen(halfDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_sheen_gloss) * dAtten * lightColor);
			#endif
			#ifdef LIT_SPECULAR
				var lightSpecular: vec3f = getLightSpecular(halfDirW, dReflDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_gloss, dTBN) * dAtten * lightColor;
				#ifdef LIGHT{i}FRESNEL
					#if defined(LIT_IRIDESCENCE)
						lightSpecular = lightSpecular * getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity, iridescenceFresnel, litArgs_iridescence_intensity);
					#else
						lightSpecular = lightSpecular * getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity);
					#endif
				#else
					lightSpecular = lightSpecular * litArgs_specularity;
				#endif
				
				dSpecularLight = dSpecularLight + lightSpecular;
			#endif
		#endif
	#endif
}
#endif
`,lightFunctionShadowPS:`
#ifdef LIGHT{i}CASTSHADOW
	#ifdef LIGHT{i}_SHADOW_SAMPLE_POINT
		fn getShadowSampleCoordOmni{i}(shadowParams: vec4f, worldPosition: vec3f, lightPos: vec3f, lightDir: ptr<function, vec3f>, lightDirNorm: vec3f, normal: vec3f) -> vec3f {
			#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
				let distScale: f32 = length(*lightDir);
				var surfacePosition = worldPosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
				*lightDir = surfacePosition - lightPos;
			#endif
			return *lightDir;
		}
	#endif
	#ifndef LIGHT{i}_SHADOW_SAMPLE_POINT
		fn getShadowSampleCoord{i}(shadowTransform: mat4x4f, shadowParams: vec4f, worldPosition: vec3f, lightPos: vec3f, lightDir: ptr<function, vec3f>, lightDirNorm: vec3f, normal: vec3f) -> vec3f {
			var surfacePosition = worldPosition;
			#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER
				#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
					surfacePosition = surfacePosition + normal * shadowParams.y;
				#endif
			#else
				#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET
					#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO
						var distScale: f32 = 1.0;
					#else
						var distScale: f32 = abs(dot(vPositionW - lightPos, lightDirNorm));
					#endif
					surfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;
				#endif
			#endif
			var positionInShadowSpace: vec4f = shadowTransform * vec4f(surfacePosition, 1.0);
			#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO
				positionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;
			#else
				#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER
					positionInShadowSpace.xyz = positionInShadowSpace.xyz / positionInShadowSpace.w;
				#else
					positionInShadowSpace.xy = positionInShadowSpace.xy / positionInShadowSpace.w;
					positionInShadowSpace.z = length(*lightDir) * shadowParams.w;
				#endif
			#endif
			return positionInShadowSpace.xyz;
		}
	#endif
	fn getShadow{i}(lightDirW_in: vec3f) -> f32 {
		var lightDirArg = lightDirW_in;
		#if LIGHT{i}TYPE == OMNI
			var shadowCoord: vec3f = getShadowSampleCoordOmni{i}(uniform.light{i}_shadowParams, vPositionW, uniform.light{i}_position, &lightDirArg, dLightDirNormW, dVertexNormalW);
		#else
			#ifdef LIGHT{i}_SHADOW_CASCADES
				var cascadeIndex: i32 = getShadowCascadeIndex(uniform.light{i}_shadowCascadeDistances, uniform.light{i}_shadowCascadeCount);
				#ifdef LIGHT{i}_SHADOW_CASCADE_BLEND
					cascadeIndex = ditherShadowCascadeIndex(cascadeIndex, uniform.light{i}_shadowCascadeDistances, uniform.light{i}_shadowCascadeCount, uniform.light{i}_shadowCascadeBlend);
				#endif
				var shadowMatrix: mat4x4f = uniform.light{i}_shadowMatrixPalette[cascadeIndex];
			#else
				var shadowMatrix: mat4x4f = uniform.light{i}_shadowMatrix;
			#endif
			#if LIGHT{i}TYPE == DIRECTIONAL
				var shadowCoord: vec3f = getShadowSampleCoord{i}(shadowMatrix, uniform.light{i}_shadowParams, vPositionW, vec3f(0.0), &lightDirArg, dLightDirNormW, dVertexNormalW);
			#else
				var shadowCoord: vec3f = getShadowSampleCoord{i}(shadowMatrix, uniform.light{i}_shadowParams, vPositionW, uniform.light{i}_position, &lightDirArg, dLightDirNormW, dVertexNormalW);
			#endif
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			shadowCoord = fadeShadow(shadowCoord, uniform.light{i}_shadowCascadeDistances);
		#endif
		#if LIGHT{i}TYPE == DIRECTIONAL
			#if LIGHT{i}SHADOWTYPE == VSM_16F
				return getShadowVSM16(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 5.54);
			#endif
			#if LIGHT{i}SHADOWTYPE == VSM_32F
				return getShadowVSM32(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 15.0);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				#if LIGHT{i}SHAPE != PUNCTUAL
					let shadowSearchArea = vec2f(length(uniform.light{i}_halfWidth), length(uniform.light{i}_halfHeight)) * uniform.light{i}_shadowSearchArea;
					return getShadowPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, shadowSearchArea, lightDirW_in);
				#else
					return getShadowPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, uniform.light{i}_softShadowParams, lightDirW_in);
				#endif
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowPCF1x1(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowPCF3x3(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F
				return getShadowPCF5x5(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);
			#endif
		#endif
		#if LIGHT{i}TYPE == SPOT
			#if LIGHT{i}SHADOWTYPE == VSM_16F
				return getShadowSpotVSM16(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 5.54, lightDirW_in);
			#endif
			#if LIGHT{i}SHADOWTYPE == VSM_32F
				return getShadowSpotVSM32(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 15.0, lightDirW_in);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				#if LIGHT{i}SHAPE != PUNCTUAL
					var shadowSearchArea: vec2f = vec2f(length(uniform.light{i}_halfWidth), length(uniform.light{i}_halfHeight)) * uniform.light{i}_shadowSearchArea;
				#else
					var shadowSearchArea: vec2f = vec2f(uniform.light{i}_shadowSearchArea);
				#endif
				return getShadowSpotPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, shadowSearchArea, lightDirW_in);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowSpotPCF1x1(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowSpotPCF3x3(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F
				return getShadowSpotPCF5x5(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);
			#endif
		#endif
		#if LIGHT{i}TYPE == OMNI
			#if LIGHT{i}SHADOWTYPE == PCSS_32F
				 var shadowSearchArea: vec2f;
				 #if LIGHT{i}SHAPE != PUNCTUAL
					var shadowSearchArea: vec2f = vec2f(length(uniform.light{i}_halfWidth), length(uniform.light{i}_halfHeight)) * uniform.light{i}_shadowSearchArea;
				#else
					var shadowSearchArea: vec2f = vec2f(uniform.light{i}_shadowSearchArea);
				#endif
				return getShadowOmniPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, shadowSearchArea, lightDirW_in);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F
				return getShadowOmniPCF1x1(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, lightDirW_in);
			#endif
			#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F
				return getShadowOmniPCF3x3(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, lightDirW_in);
			#endif
		#endif
	}
#endif
`,lightingPS:`
#ifdef LIT_CLUSTERED_LIGHTS
	#define LIT_CODE_FALLOFF_LINEAR
	#define LIT_CODE_FALLOFF_SQUARED
	#define LIT_CODE_LIGHTS_POINT
	#define LIT_CODE_LIGHTS_SPOT
#endif
#ifdef AREA_LIGHTS
	var areaLightsLutTex1: texture_2d<f32>;
	var areaLightsLutTex1Sampler: sampler;
	var areaLightsLutTex2: texture_2d<f32>;
	var areaLightsLutTex2Sampler: sampler;
#endif
#ifdef LIT_LIGHTING
	#include "lightDiffuseLambertPS"
	#if defined(AREA_LIGHTS) || defined(LIT_CLUSTERED_AREA_LIGHTS)
		#include "ltcPS"
	#endif
#endif
#ifdef SHADOW_DIRECTIONAL
	#include "shadowCascadesPS"
#endif
#if defined(SHADOW_KIND_PCF1)
	#include "shadowPCF1PS"
#endif
#if defined(SHADOW_KIND_PCF3)
	#include "shadowPCF3PS"
#endif
#if defined(SHADOW_KIND_PCF5)
	#include "shadowPCF5PS"
#endif
#if defined(SHADOW_KIND_PCSS)
	#include "linearizeDepthPS"
	#include "shadowSoftPS"
#endif
#if defined(SHADOW_KIND_VSM)
	#include "shadowEVSMPS"
#endif
#ifdef LIT_CODE_FALLOFF_LINEAR
	#include "falloffLinearPS"
#endif
#ifdef LIT_CODE_FALLOFF_SQUARED
	#include "falloffInvSquaredPS"
#endif
#ifdef LIT_CODE_LIGHTS_POINT
	#include "lightDirPointPS"
#endif
#ifdef LIT_CODE_LIGHTS_SPOT
	#include "spotPS"
#endif
#ifdef LIT_CODE_COOKIE
	#include "cookiePS"
#endif
#ifdef LIT_CLUSTERED_LIGHTS
	#include "clusteredLightPS"
#endif
#ifdef LIGHT_COUNT > 0
	#include "lightFunctionShadowPS, LIGHT_COUNT"
	#include "lightFunctionLightPS, LIGHT_COUNT"
#endif
`,lightmapAddPS:`
fn addLightMap(
	lightmap: vec3f,
	dir: vec3f,
	worldNormal: vec3f,
	viewDir: vec3f,
	reflectionDir: vec3f,
	gloss: f32,
	specularity: vec3f,
	vertexNormal: vec3f,
	tbn: mat3x3f
#if defined(LIT_IRIDESCENCE)
	, iridescenceFresnel: vec3f,
	iridescenceIntensity: f32
#endif
) {
	#if defined(LIT_SPECULAR) && defined(LIT_DIR_LIGHTMAP)
		if (dot(dir, dir) < 0.0001) {
				dDiffuseLight = dDiffuseLight + lightmap;
		} else {
			let vlight: f32 = saturate(dot(dir, -vertexNormal));
			let flight: f32 = saturate(dot(dir, -worldNormal));
			let nlight: f32 = (flight / max(vlight, 0.01)) * 0.5;
			dDiffuseLight = dDiffuseLight + lightmap * nlight * 2.0;
			let halfDir: vec3f = normalize(-dir + viewDir);
			var specularLight: vec3f = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);
			#ifdef LIT_SPECULAR_FRESNEL
				specularLight = specularLight *
					getFresnel(dot(viewDir, halfDir),
					gloss,
					specularity
				#if defined(LIT_IRIDESCENCE)
					, iridescenceFresnel,
					iridescenceIntensity
				#endif
					);
			#endif
			dSpecularLight = dSpecularLight + specularLight;
		}
	#else
		dDiffuseLight = dDiffuseLight + lightmap;
	#endif
}
`,lightmapPS:`
#ifdef STD_LIGHTMAP_DIR
	var<private> dLightmapDir: vec3f;
	var texture_dirLightMap: texture_2d<f32>;
	var texture_dirLightMapSampler: sampler;
#endif
fn getLightMap() {
	dLightmap = vec3f(1.0);
	#ifdef STD_LIGHT_TEXTURE
		dLightmap = dLightmap * {STD_LIGHT_TEXTURE_DECODE}(textureSampleBias({STD_LIGHT_TEXTURE_NAME}, {STD_LIGHT_TEXTURE_NAME}Sampler, {STD_LIGHT_TEXTURE_UV}, uniform.textureBias)).{STD_LIGHT_TEXTURE_CHANNEL};
		#ifdef STD_LIGHTMAP_DIR
			var dir: vec3f = textureSampleBias(texture_dirLightMap, texture_dirLightMapSampler, {STD_LIGHT_TEXTURE_UV}, uniform.textureBias).xyz * 2.0 - 1.0;
			var dirDot = dot(dir, dir);
			dLightmapDir = select(vec3(0.0), dir / sqrt(dirDot), dirDot > 0.001);
		#endif
	#endif
	#ifdef STD_LIGHT_VERTEX
		dLightmap = dLightmap * saturate(vVertexColor.{STD_LIGHT_VERTEX_CHANNEL});
	#endif
}
`,lightSpecularAnisoGGXPS:`
fn calcLightSpecular(gloss: f32, worldNormal: vec3f, viewDir: vec3f, h: vec3f, lightDirNorm: vec3f, tbn: mat3x3f) -> f32 {
	let PI: f32 = 3.141592653589793;
	let roughness: f32 = max((1.0 - gloss) * (1.0 - gloss), 0.001);
	let alphaRoughness: f32 = roughness * roughness;
	let anisotropy: f32 = dAnisotropy;
	let direction: vec2f = dAnisotropyRotation;
	let at: f32 = mix(alphaRoughness, 1.0, anisotropy * anisotropy);
	let ab: f32 = clamp(alphaRoughness, 0.001, 1.0);
	let anisotropicT: vec3f = normalize(tbn * vec3f(direction, 0.0));
	let anisotropicB: vec3f = normalize(cross(tbn[2], anisotropicT));
	let NoH: f32 = dot(worldNormal, h);
	let ToH: f32 = dot(anisotropicT, h);
	let BoH: f32 = dot(anisotropicB, h);
	let a2: f32 = at * ab;
	let v: vec3f = vec3f(ab * ToH, at * BoH, a2 * NoH);
	let v2: f32 = dot(v, v);
	let w2: f32 = a2 / v2;
	let D: f32 = a2 * w2 * w2 * (1.0 / PI);
	let ToV: f32 = dot(anisotropicT, viewDir);
	let BoV: f32 = dot(anisotropicB, viewDir);
	let ToL: f32 = dot(anisotropicT, -lightDirNorm);
	let BoL: f32 = dot(anisotropicB, -lightDirNorm);
	let NoV: f32 = dot(worldNormal, viewDir);
	let NoL: f32 = dot(worldNormal, -lightDirNorm);
	let lambdaV: f32 = NoL * length(vec3f(at * ToV, ab * BoV, NoV));
	let lambdaL: f32 = NoV * length(vec3f(at * ToL, ab * BoL, NoL));
	let G: f32 = 0.5 / (lambdaV + lambdaL);
	return D * G;
}
fn getLightSpecular(h: vec3f, reflDir: vec3f, worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f, gloss: f32, tbn: mat3x3f) -> f32 {
	return calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);
}
`,lightSpecularGGXPS:`
fn calcLightSpecular(gloss: f32, worldNormal: vec3f, viewDir: vec3f, h: vec3f, lightDirNorm: vec3f) -> f32 {
	const PI: f32 = 3.141592653589793;
	let roughness: f32 = max((1.0 - gloss) * (1.0 - gloss), 0.001);
	let alpha: f32 = roughness * roughness;
	let NoH: f32 = max(dot(worldNormal, h), 0.0);
	let NoV: f32 = max(dot(worldNormal, viewDir), 0.0);
	let NoL: f32 = max(dot(worldNormal, -lightDirNorm), 0.0);
	let NoH2: f32 = NoH * NoH;
	let denom: f32 = NoH2 * (alpha - 1.0) + 1.0;
	let D: f32 = alpha / (PI * denom * denom);
	let alpha2: f32 = alpha * alpha;
	let lambdaV: f32 = NoL * sqrt(NoV * NoV * (1.0 - alpha2) + alpha2);
	let lambdaL: f32 = NoV * sqrt(NoL * NoL * (1.0 - alpha2) + alpha2);
	let G: f32 = 0.5 / max(lambdaV + lambdaL, 0.00001);
	return D * G;
}
fn getLightSpecular(h: vec3f, reflDir: vec3f, worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f, gloss: f32, tbn: mat3x3f) -> f32 {
	return calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm);
}
`,lightSpecularBlinnPS:`
fn calcLightSpecular(gloss: f32, worldNormal: vec3f, h: vec3f) -> f32 {
	let nh: f32 = max( dot( h, worldNormal ), 0.0 );
	var specPow: f32 = exp2(gloss * 11.0);
	specPow = max(specPow, 0.0001);
	return pow(nh, specPow) * (specPow + 2.0) / 8.0;
}
fn getLightSpecular(h: vec3f, reflDir: vec3f, worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f, gloss: f32, tbn: mat3x3f) -> f32 {
	return calcLightSpecular(gloss, worldNormal, h);
}
`,lightSheenPS:`
fn sheenD(normal: vec3f, h: vec3f, roughness: f32) -> f32 {
	let PI: f32 = 3.141592653589793;
	let invR: f32 = 1.0 / (roughness * roughness);
	var cos2h: f32 = max(dot(normal, h), 0.0);
	cos2h = cos2h * cos2h;
	let sin2h: f32 = max(1.0 - cos2h, 0.0078125);
	return (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);
}
fn sheenV(normal: vec3f, viewDir: vec3f, light: vec3f) -> f32 {
	let NoV: f32 = max(dot(normal, viewDir), 0.000001);
	let NoL: f32 = max(dot(normal, light), 0.000001);
	return 1.0 / (4.0 * (NoL + NoV - NoL * NoV));
}
fn getLightSpecularSheen(h: vec3f, worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f, sheenGloss: f32) -> f32 {
	let D: f32 = sheenD(worldNormal, h, sheenGloss);
	let V: f32 = sheenV(worldNormal, viewDir, -lightDirNorm);
	return D * V;
}`,linearizeDepthPS:`
#ifndef LINEARIZE_DEPTH
#define LINEARIZE_DEPTH
fn linearizeDepthWithParams(z: f32, cameraParams: vec4f) -> f32 {
	if (cameraParams.w == 0.0) {
		return (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));
	} else {
		return cameraParams.z + z * (cameraParams.y - cameraParams.z);
	}
}
#ifndef CAMERAPLANES
	#define CAMERAPLANES
	uniform camera_params: vec4f;
#endif
fn linearizeDepth(z: f32) -> f32 {
	return linearizeDepthWithParams(z, uniform.camera_params);
}
#endif
`,litForwardBackendPS:`
fn evaluateBackend() -> FragmentOutput {
	var output: FragmentOutput;
	#ifdef LIT_SSAO
		litArgs_ao = litArgs_ao * textureSampleLevel(ssaoTexture, ssaoTextureSampler, pcPosition.xy * uniform.ssaoTextureSizeInv, 0.0).r;
	#endif
	#ifdef LIT_NEEDS_NORMAL
		#ifdef LIT_SPECULAR
			getReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);
		#endif
		#ifdef LIT_CLEARCOAT
			ccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));
		#endif
	#endif
	#ifdef LIT_SPECULAR_OR_REFLECTION
		#ifdef LIT_METALNESS
			var f0: f32 = 1.0 / litArgs_ior;
			f0 = (f0 - 1.0) / (f0 + 1.0);
			f0 = f0 * f0;
			#ifdef LIT_SPECULARITY_FACTOR
				litArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0, litArgs_specularityFactor);
			#else
				litArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0, 1.0);
			#endif
			litArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);
		#endif
		#ifdef LIT_IRIDESCENCE
			var iridescenceFresnel: vec3f = getIridescenceDiffraction(saturate(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);
		#endif
	#endif
	#ifdef LIT_ADD_AMBIENT
		addAmbient(litArgs_worldNormal);
		#ifdef LIT_SPECULAR
			dDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);
		#endif
		#ifdef LIT_SEPARATE_AMBIENT
			var dAmbientLight: vec3f = dDiffuseLight;
			dDiffuseLight = vec3(0.0);
		#endif
	#endif
	#ifndef LIT_OLD_AMBIENT
		dDiffuseLight = dDiffuseLight * uniform.material_ambient;
	#endif
	#ifdef LIT_AO
		#ifndef LIT_OCCLUDE_DIRECT
			occludeDiffuse(litArgs_ao);
		#endif
	#endif
	#ifdef LIT_LIGHTMAP
		addLightMap(
			litArgs_lightmap, 
			litArgs_lightmapDir, 
			litArgs_worldNormal, 
			dViewDirW, 
			dReflDirW, 
			litArgs_gloss, 
			litArgs_specularity, 
			dVertexNormalW,
			dTBN
		#if defined(LIT_IRIDESCENCE)
			, iridescenceFresnel,
			litArgs_iridescence_intensity
		#endif
		);
	#endif
	#ifdef LIT_LIGHTING || LIT_REFLECTIONS
		#ifdef LIT_REFLECTIONS
			#ifdef LIT_CLEARCOAT
				addReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);
			
				#ifdef LIT_SPECULAR_FRESNEL
					ccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));
					ccReflection = ccReflection * ccFresnel;
				#else
					ccFresnel = 0.0;
				#endif
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				ccReflection = ccReflection * litArgs_specularityFactor;
			#endif
			#ifdef LIT_SHEEN
				addReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);
			#endif
			addReflection(dReflDirW, litArgs_gloss);
			#ifdef LIT_FRESNEL_MODEL
				dReflection = vec4f(
					dReflection.rgb * getFresnel(
						dot(dViewDirW, litArgs_worldNormal),
						litArgs_gloss,
						litArgs_specularity
					#if defined(LIT_IRIDESCENCE)
						, iridescenceFresnel,
						litArgs_iridescence_intensity
					#endif
						),
					dReflection.a
				);
			#else
				dReflection = vec4f(dReflection.rgb * litArgs_specularity, dReflection.a);
			#endif
		#endif
		#ifdef AREA_LIGHTS
			dSpecularLight = dSpecularLight * litArgs_specularity;
			#ifdef LIT_SPECULAR
				calcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);
			#endif
		#endif
		
		#ifdef LIGHT_COUNT > 0
			#include "lightEvaluationPS, LIGHT_COUNT"
		#endif
		#ifdef LIT_CLUSTERED_LIGHTS
			addClusteredLights(litArgs_worldNormal, dViewDirW, dReflDirW,
				#if defined(LIT_CLEARCOAT)
						ccReflDirW,
				#endif
						litArgs_gloss, litArgs_specularity, dVertexNormalW, dTBN, 
				#if defined(LIT_IRIDESCENCE)
						iridescenceFresnel,
				#endif
						litArgs_clearcoat_worldNormal, litArgs_clearcoat_gloss, litArgs_sheen_gloss, litArgs_iridescence_intensity
			);
		#endif
		#ifdef AREA_LIGHTS
			#ifdef LIT_CLEARCOAT
				litArgs_clearcoat_specularity = 1.0;
			#endif
			#ifdef LIT_SPECULAR
				litArgs_specularity = vec3(1.0);
			#endif
		#endif
		#ifdef LIT_REFRACTION
			addRefraction(
				litArgs_worldNormal, 
				dViewDirW, 
				litArgs_thickness, 
				litArgs_gloss, 
				litArgs_specularity, 
				litArgs_albedo, 
				litArgs_transmission,
				litArgs_ior,
				litArgs_dispersion
				#if defined(LIT_IRIDESCENCE)
					, iridescenceFresnel, 
					litArgs_iridescence_intensity
				#endif
			);
		#endif
	#endif
	#ifdef LIT_AO
		#ifdef LIT_OCCLUDE_DIRECT
			occludeDiffuse(litArgs_ao);
		#endif
		#if LIT_OCCLUDE_SPECULAR != NONE
			occludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);
		#endif
	#endif
	#if !defined(LIT_OPACITY_FADES_SPECULAR)
		#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == PREMULTIPLIED
			var specLum: f32 = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3f( 0.2126, 0.7152, 0.0722 ));
			#ifdef LIT_CLEARCOAT
				specLum = specLum + dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection * litArgs_clearcoat_specularity, vec3f( 0.2126, 0.7152, 0.0722 ));
			#endif
			litArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);
		#endif
		litArgs_opacity = litArgs_opacity * uniform.material_alphaFade;
	#endif
	#ifdef LIT_LIGHTMAP_BAKING
		#ifdef LIT_LIGHTMAP_BAKING_COLOR
			#include "bakeLmEndPS"
		#endif
		#ifdef LIT_LIGHTMAP_BAKING_DIR
			#include "bakeDirLmEndPS"
		#endif
	#else
		#include "endPS"
		#include "outputAlphaPS"
	#endif
	#ifdef LIT_MSDF
		output.color = applyMsdf(output.color);
	#endif
	#include "outputPS"
	#include "debugOutputPS"
	#ifdef LIT_SHADOW_CATCHER
		output.color = vec4f(vec3f(dShadowCatcher), output.color.a);
	#endif
	return output;
}
`,litForwardDeclarationPS:`
var<private> sReflection: vec3f;
var<private> dVertexNormalW: vec3f;
var<private> dTangentW: vec3f;
var<private> dBinormalW: vec3f;
var<private> dViewDirW: vec3f;
var<private> dReflDirW: vec3f;
var<private> ccReflDirW: vec3f;
var<private> dLightDirNormW: vec3f;
var<private> dAtten: f32;
var<private> dTBN: mat3x3f;
var<private> dReflection: vec4f;
var<private> dDiffuseLight: vec3f;
var<private> dSpecularLight: vec3f;
var<private> ccFresnel: f32;
var<private> ccReflection: vec3f;
var<private> ccSpecularLight: vec3f;
var<private> ccSpecularityNoFres: f32;
var<private> sSpecularLight: vec3f;
#ifdef LIT_DISPERSION
	uniform material_dispersion: f32;
#endif
#ifndef LIT_OPACITY_FADES_SPECULAR
	uniform material_alphaFade: f32;
#endif
#ifdef LIT_SSAO
	var ssaoTexture : texture_2d<f32>;
	var ssaoTextureSampler : sampler;
	uniform ssaoTextureSizeInv: vec2f;
#endif
#ifdef LIT_SHADOW_CATCHER
	var<private> dShadowCatcher: f32 = 1.0;
#endif
#if LIGHT_COUNT > 0
	#include "lightDeclarationPS, LIGHT_COUNT"
#endif
#ifdef LIT_SPECULAR
	#if LIT_FRESNEL_MODEL == NONE && !defined(LIT_REFLECTIONS) && !defined(LIT_DIFFUSE_MAP) 
		#define LIT_OLD_AMBIENT
	#endif
#endif
#ifdef STD_LIGHTMAP_DIR
	uniform bakeDir: f32;
#endif
#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT
	uniform ambientBakeOcclusionContrast: f32;
	uniform ambientBakeOcclusionBrightness: f32;
#endif
`,litForwardMainPS:`
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	#include "litUserMainStartPS"
	dReflection = vec4f(0.0);
	#ifdef LIT_CLEARCOAT
		ccSpecularLight = vec3f(0.0);
		ccReflection = vec3f(0.0);
	#endif
	#if LIT_NONE_SLICE_MODE == SLICED
		#include "startNineSlicedPS"
	#elif LIT_NONE_SLICE_MODE == TILED
		#include "startNineSlicedTiledPS"
	#endif
	#ifdef LIT_NEEDS_NORMAL
		dVertexNormalW = normalize(vNormalW);
		#ifdef LIT_TANGENTS
			#if defined(LIT_HEIGHTS) || defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS) || defined(LIT_GGX_SPECULAR)
				dTangentW = vTangentW;
				dBinormalW = vBinormalW;
			#endif
		#endif
		getViewDir();
		#ifdef LIT_TBN
			getTBN(dTangentW, dBinormalW, dVertexNormalW);
			#ifdef LIT_TWO_SIDED_LIGHTING
				handleTwoSidedLighting();
			#endif
		#endif
	#endif
	evaluateFrontend();
	#include "debugProcessFrontendPS"
	var output: FragmentOutput = evaluateBackend();
	#include "litUserMainEndPS"
	return output;
}
`,litForwardPostCodePS:`
#ifdef LIT_NEEDS_NORMAL
	#include "cubeMapRotatePS"
	#include "cubeMapProjectPS"
	#include "envProcPS"
#endif
#ifdef LIT_SPECULAR_OR_REFLECTION
	#ifdef LIT_METALNESS
		#include "metalnessModulatePS"
	#endif
	#if LIT_FRESNEL_MODEL == SCHLICK
		#include "fresnelSchlickPS"
	#endif
	#ifdef LIT_IRIDESCENCE
		#include "iridescenceDiffractionPS"
	#endif
#endif
#ifdef LIT_AO
	#include "aoDiffuseOccPS"
	#include "aoSpecOccPS"
#endif
#if LIT_REFLECTION_SOURCE == ENVATLASHQ
	#include "envAtlasPS"
	#include "reflectionEnvHQPS"
#elif LIT_REFLECTION_SOURCE == ENVATLAS
	#include "envAtlasPS"
	#include "reflectionEnvPS"
#elif LIT_REFLECTION_SOURCE == CUBEMAP
	#include "reflectionCubePS"
#elif LIT_REFLECTION_SOURCE == SPHEREMAP
	#include "reflectionSpherePS"
#endif
#ifdef LIT_REFLECTIONS
	#ifdef LIT_CLEARCOAT
		#include "reflectionCCPS"
	#endif
	#ifdef LIT_SHEEN
		#include "reflectionSheenPS"
	#endif
#endif
#ifdef LIT_REFRACTION
	#if defined(LIT_DYNAMIC_REFRACTION)
		#include "refractionDynamicPS"
	#elif defined(LIT_REFLECTIONS)
		#include "refractionCubePS"
	#endif
#endif
#ifdef LIT_SHEEN
	#include "lightSheenPS"
#endif
uniform material_ambient: vec3f;
#ifdef LIT_SPECULAR
	#ifdef LIT_LIGHTING
		#ifdef LIT_GGX_SPECULAR
			#ifdef LIT_ANISOTROPY
				#include "lightSpecularAnisoGGXPS"
			#else
				#include "lightSpecularGGXPS"
			#endif
		#else
			#include "lightSpecularBlinnPS"
		#endif
	#endif
#endif
#include "combinePS"
#ifdef LIT_LIGHTMAP
	#include "lightmapAddPS"
#endif
#ifdef LIT_ADD_AMBIENT
	#include "ambientPS"
#endif
#ifdef LIT_MSDF
	#include "msdfPS"
#endif
#ifdef LIT_NEEDS_NORMAL
	#include "viewDirPS"
	#ifdef LIT_SPECULAR
		#ifdef LIT_ANISOTROPY
			#include "reflDirAnisoPS"
		#else
			#include "reflDirPS"
		#endif
	#endif
#endif
#include "lightingPS"
`,litForwardPreCodePS:`
#include "basePS"
#include "sphericalPS"
#include "decodePS"
#include "gammaPS"
#include "tonemappingPS"
#include "fogPS"
#if LIT_NONE_SLICE_MODE == SLICED
	#include "baseNineSlicedPS"
#elif LIT_NONE_SLICE_MODE == TILED
	#include "baseNineSlicedTiledPS"
#endif
#ifdef LIT_TBN
	#include "TBNPS"
	#ifdef LIT_TWO_SIDED_LIGHTING
		#include "twoSidedLightingPS"
	#endif
#endif
`,litMainPS:`
#include "varyingsPS"
#include "litUserDeclarationPS"
#include "frontendDeclPS"
#if defined(PICK_PASS) || defined(PREPASS_PASS)
	#include "frontendCodePS"
	#include "litUserCodePS"
	#include "litOtherMainPS"
#elif defined(SHADOW_PASS)
	#include "frontendCodePS"
	#include "litUserCodePS"
	#include "litShadowMainPS"
#else
	#include "litForwardDeclarationPS"
	#include "litForwardPreCodePS"
	#include "frontendCodePS"
	#include "litForwardPostCodePS"
	#include "litForwardBackendPS"
	#include "litUserCodePS"
	#include "litForwardMainPS"
#endif
`,litMainVS:`
#include "varyingsVS"
#include  "litUserDeclarationVS"
#ifdef VERTEX_COLOR
	attribute vertex_color: vec4f;
#endif
#ifdef NINESLICED
	varying vMask: vec2f;
	varying vTiledUv: vec2f;
	var<private> dMaskGlobal: vec2f;
	var<private> dTiledUvGlobal: vec2f;
	uniform innerOffset: vec4f;
	uniform outerScale: vec2f;
	uniform atlasRect: vec4f;
#endif
var<private> dPositionW: vec3f;
var<private> dModelMatrix: mat4x4f;
#include "transformCoreVS"
#ifdef UV0
	attribute vertex_texCoord0: vec2f;
	#include "uv0VS"
#endif
#ifdef UV1
	attribute vertex_texCoord1: vec2f;
	#include "uv1VS"
#endif
#ifdef LINEAR_DEPTH
	#ifndef VIEWMATRIX
	#define VIEWMATRIX
		uniform matrix_view: mat4x4f;
	#endif
#endif
#include "transformVS"
#ifdef NORMALS
	#include "normalCoreVS"
	#include "normalVS"
#endif
#ifdef TANGENTS
	attribute vertex_tangent: vec4f;
#endif
#include "uvTransformUniformsPS, UV_TRANSFORMS_COUNT"
#ifdef MSDF
	#include "msdfVS"
#endif
#include  "litUserCodeVS"
#ifdef VERTEX_COLOR
	fn decodeGamma3(raw: vec3f) -> vec3f {
		return pow(raw, vec3f(2.2));
	}
	fn gammaCorrectInputVec4(color: vec4f) -> vec4f {
		return vec4f(decodeGamma3(color.xyz), color.w);
	}
#endif
@vertex
fn vertexMain(input : VertexInput) -> VertexOutput {
	#include "litUserMainStartVS"
	var output : VertexOutput;
	output.position = getPosition();
	output.vPositionW = getWorldPosition();
	#ifdef NORMALS
		output.vNormalW = getNormal();
	#endif
	#ifdef TANGENTS
		output.vTangentW = normalize(dNormalMatrix * vertex_tangent.xyz);
		output.vBinormalW = cross(output.vNormalW, output.vTangentW) * vertex_tangent.w;
	#elif defined(GGX_SPECULAR)
		output.vObjectSpaceUpW = normalize(dNormalMatrix * vec3f(0.0, 1.0, 0.0));
	#endif
	#ifdef UV0
		var uv0: vec2f = getUv0();
		#ifdef UV0_UNMODIFIED
			output.vUv0 = uv0;
		#endif
	#endif
	#ifdef UV1
		var uv1: vec2f = getUv1();
		#ifdef UV1_UNMODIFIED
			output.vUv1 = uv1;
		#endif
	#endif
	#include "uvTransformVS, UV_TRANSFORMS_COUNT"
	#ifdef VERTEX_COLOR
		#ifdef STD_VERTEX_COLOR_GAMMA
			output.vVertexColor = gammaCorrectInputVec4(vertex_color);
		#else
			output.vVertexColor = vertex_color;
		#endif
	#endif
	#ifdef LINEAR_DEPTH
		output.vLinearDepth = -(uniform.matrix_view * vec4f(output.vPositionW, 1.0)).z;
	#endif
	#ifdef MSDF
		unpackMsdfParams();
		output.outline_color = dOutlineColor;
		output.outline_thickness = dOutlineThickness;
		output.shadow_color = dShadowColor;
		output.shadow_offset = dShadowOffset;
	#endif
	#ifdef NINESLICED
		output.vMask = dMaskGlobal;
		output.vTiledUv = dTiledUvGlobal;
	#endif
	#include "litUserMainEndVS"
	return output;
}
`,litOtherMainPS:`
#ifdef PICK_PASS
	#include "pickPS"
#endif
#ifdef PREPASS_PASS
	#include "floatAsUintPS"
#endif
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	#include "litUserMainStartPS"
	var output: FragmentOutput;
	
	evaluateFrontend();
	#ifdef PICK_PASS
		output.color = getPickOutput();
		#ifdef DEPTH_PICK_PASS
			output.color1 = getPickDepth();
		#endif
	#endif
	#ifdef PREPASS_PASS
		output.color = float2vec4(vLinearDepth);
	#endif
	#include "litUserMainEndPS"
	return output;
}
`,litShaderArgsPS:`
var<private> litArgs_albedo: vec3f;
var<private> litArgs_opacity: f32;
var<private> litArgs_emission: vec3f;
var<private> litArgs_worldNormal: vec3f;
var<private> litArgs_ao: f32;
var<private> litArgs_lightmap: vec3f;
var<private> litArgs_lightmapDir: vec3f;
var<private> litArgs_metalness: f32;
var<private> litArgs_specularity: vec3f;
var<private> litArgs_specularityFactor: f32;
var<private> litArgs_gloss: f32;
var<private> litArgs_sheen_gloss: f32;
var<private> litArgs_sheen_specularity: vec3f;
var<private> litArgs_transmission: f32;
var<private> litArgs_thickness: f32;
var<private> litArgs_ior: f32;
var<private> litArgs_dispersion: f32;
var<private> litArgs_iridescence_intensity: f32;
var<private> litArgs_iridescence_thickness: f32;
var<private> litArgs_clearcoat_worldNormal: vec3f;
var<private> litArgs_clearcoat_specularity: f32;
var<private> litArgs_clearcoat_gloss: f32;
`,litShaderCorePS:`
	#if LIT_NONE_SLICE_MODE == TILED
		var<private> textureBias: f32 = -1000.0;
	#else
		uniform textureBias: f32;
	#endif
	#include "litShaderArgsPS"
`,litShadowMainPS:`
#if LIGHT_TYPE != DIRECTIONAL
	uniform view_position: vec3f;
	uniform light_radius: f32;
#endif
#if SHADOW_TYPE == PCSS_32F
	#include "linearizeDepthPS"
#endif
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	#include "litUserMainStartPS"
	var output: FragmentOutput;
	evaluateFrontend();
	#ifdef PERSPECTIVE_DEPTH
		var depth: f32 = input.position.z;
		#if SHADOW_TYPE == PCSS_32F
			#if LIGHT_TYPE != DIRECTIONAL
				depth = linearizeDepthWithParams(depth, camera_params);
			#endif
		#endif
	#else
		var depth: f32 = min(distance(uniform.view_position, input.vPositionW) / uniform.light_radius, 0.99999);
		#define MODIFIED_DEPTH
	#endif
	#if SHADOW_TYPE == VSM_16F || SHADOW_TYPE == VSM_32F
		#if SHADOW_TYPE == VSM_32F
			var exponent: f32 = 15.0;
		#else
			var exponent: f32 = 5.54;
		#endif
		var depth_vsm = 2.0 * depth - 1.0;
		depth_vsm = exp(exponent * depth_vsm);
		output.color = vec4f(depth_vsm, depth_vsm * depth_vsm, 1.0, 1.0);
	#else
		#if SHADOW_TYPE == PCSS_32F
			output.color = vec4f(depth, 0.0, 0.0, 1.0);
		#else
			#ifdef MODIFIED_DEPTH
				output.fragDepth = depth;
			#endif
			output.color = vec4f(1.0);
		#endif
	#endif
	#include "litUserMainEndPS"
	
	return output;
}
`,litUserDeclarationPS:"",litUserDeclarationVS:"",litUserCodePS:"",litUserCodeVS:"",litUserMainStartPS:"",litUserMainStartVS:"",litUserMainEndPS:"",litUserMainEndVS:"",ltcPS:`
fn LTC_Uv(N: vec3f, V: vec3f, roughness: f32) -> vec2f {
	const LUT_SIZE: f32 = 64.0;
	const LUT_SCALE: f32 = (LUT_SIZE - 1.0) / LUT_SIZE;
	const LUT_BIAS: f32 = 0.5 / LUT_SIZE;
	let dotNV: f32 = saturate(dot( N, V ));
	let uv: vec2f = vec2f( roughness, sqrt( 1.0 - dotNV ) );
	return uv * LUT_SCALE + LUT_BIAS;
}
fn LTC_ClippedSphereFormFactor( f: vec3f ) -> f32 {
	let l: f32 = length( f );
	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );
}
fn LTC_EdgeVectorFormFactor( v1: vec3f, v2: vec3f ) -> vec3f {
	let x: f32 = dot( v1, v2 );
	let y: f32 = abs( x );
	let a: f32 = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;
	let b: f32 = 3.4175940 + ( 4.1616724 + y ) * y;
	let v: f32 = a / b;
	let inv_sqrt_term = inverseSqrt( max( 1.0 - x * x, 1e-7f ) );
	let theta_sintheta: f32 = select( (0.5 * inv_sqrt_term - v), v, x > 0.0 );
	return cross( v1, v2 ) * theta_sintheta;
}
struct Coords {
	coord0: vec3f,
	coord1: vec3f,
	coord2: vec3f,
	coord3: vec3f,
}
fn LTC_EvaluateRect( N: vec3f, V: vec3f, P: vec3f, mInv: mat3x3f, rectCoords: Coords) -> f32 {
	let v1: vec3f = rectCoords.coord1 - rectCoords.coord0;
	let v2: vec3f = rectCoords.coord3 - rectCoords.coord0;
	let lightNormal: vec3f = cross( v1, v2 );
	let factor: f32 = sign(-dot( lightNormal, P - rectCoords.coord0 ));
	let T1: vec3f = normalize( V - N * dot( V, N ) );
	let T2: vec3f = factor * cross( N, T1 );
	let mat: mat3x3f = mInv * transpose( mat3x3f( T1, T2, N ) );
	var coords: array<vec3f, 4>;
	coords[0] = mat * ( rectCoords.coord0 - P );
	coords[1] = mat * ( rectCoords.coord1 - P );
	coords[2] = mat * ( rectCoords.coord2 - P );
	coords[3] = mat * ( rectCoords.coord3 - P );
	coords[0] = normalize( coords[0] );
	coords[1] = normalize( coords[1] );
	coords[2] = normalize( coords[2] );
	coords[3] = normalize( coords[3] );
	var vectorFormFactor: vec3f = vec3f( 0.0 );
	vectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[0], coords[1] );
	vectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[1], coords[2] );
	vectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[2], coords[3] );
	vectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[3], coords[0] );
	let result: f32 = LTC_ClippedSphereFormFactor( vectorFormFactor );
	return result;
}
var<private> dLTCCoords: Coords;
fn getLTCLightCoords(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) -> Coords {
	var coords: Coords;
	coords.coord0 = lightPos + halfWidth - halfHeight;
	coords.coord1 = lightPos - halfWidth - halfHeight;
	coords.coord2 = lightPos - halfWidth + halfHeight;
	coords.coord3 = lightPos + halfWidth + halfHeight;
	return coords;
}
var<private> dSphereRadius: f32;
fn getSphereLightCoords(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) -> Coords {
	dSphereRadius = max(length(halfWidth), length(halfHeight));
	let f: vec3f = reflect(normalize(lightPos - uniform.view_position), vNormalW);
	let w: vec3f = normalize(cross(f, halfHeight));
	let h: vec3f = normalize(cross(f, w));
	return getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);
}
var<private> dLTCUV: vec2f;
#ifdef LIT_CLEARCOAT
	var<private> ccLTCUV: vec2f;
#endif
fn getLTCLightUV(gloss: f32, worldNormal: vec3f, viewDir: vec3f) -> vec2f {
	let roughness: f32 = max((1.0 - gloss) * (1.0 - gloss), 0.001);
	return LTC_Uv( worldNormal, viewDir, roughness );
}
var<private> dLTCSpecFres: vec3f;
#ifdef LIT_CLEARCOAT
	var<private> ccLTCSpecFres: vec3f;
#endif
fn getLTCLightSpecFres(uv: vec2f, specularity: vec3f) -> vec3f {
	let t2: vec4f = textureSampleLevel(areaLightsLutTex2, areaLightsLutTex2Sampler, uv, 0.0);
	return specularity * t2.x + ( vec3f( 1.0 ) - specularity) * t2.y;
}
fn calcLTCLightValues(gloss: f32, worldNormal: vec3f, viewDir: vec3f, specularity: vec3f, clearcoatGloss: f32, clearcoatWorldNormal: vec3f, clearcoatSpecularity: f32) {
	dLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);
	dLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity);
	#ifdef LIT_CLEARCOAT
		ccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);
		ccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3f(clearcoatSpecularity));
	#endif
}
fn calcRectLightValues(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) {
	dLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);
}
fn calcDiskLightValues(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) {
	calcRectLightValues(lightPos, halfWidth, halfHeight);
}
fn calcSphereLightValues(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) {
	dLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);
}
fn SolveCubic(Coefficient_in: vec4f) -> vec3f {
	let pi: f32 = 3.14159;
	var Coefficient = Coefficient_in;
	Coefficient = vec4f(Coefficient.xyz / Coefficient.w, Coefficient.w);
	let new_yz: vec2f = Coefficient.yz / 3.0;
	Coefficient = vec4f(Coefficient.x, new_yz.x, new_yz.y, Coefficient.w);
	
	let A: f32 = Coefficient.w;
	let B: f32 = Coefficient.z;
	let C: f32 = Coefficient.y;
	let D: f32 = Coefficient.x;
	let Delta: vec3f = vec3f(
		-Coefficient.z * Coefficient.z + Coefficient.y,
		-Coefficient.y * Coefficient.z + Coefficient.x,
		dot(vec2f(Coefficient.z, -Coefficient.y), Coefficient.xy)
	);
	let Discriminant: f32 = dot(vec2f(4.0 * Delta.x, -Delta.y), Delta.zy);
	var xlc: vec2f;
	var xsc: vec2f;
	{
		let A_a: f32 = 1.0;
		let C_a: f32 = Delta.x;
		let D_a: f32 = -2.0 * B * Delta.x + Delta.y;
		let Theta: f32 = atan2(sqrt(Discriminant), -D_a) / 3.0;
		let sqrt_neg_Ca = sqrt(-C_a);
		let x_1a: f32 = 2.0 * sqrt_neg_Ca * cos(Theta);
		let x_3a: f32 = 2.0 * sqrt_neg_Ca * cos(Theta + (2.0 / 3.0) * pi);
		let xl: f32 = select(x_3a, x_1a, (x_1a + x_3a) > 2.0 * B);
		xlc = vec2f(xl - B, A);
	}
	{
		let A_d: f32 = D;
		let C_d: f32 = Delta.z;
		let D_d: f32 = -D * Delta.y + 2.0 * C * Delta.z;
		let Theta: f32 = atan2(D * sqrt(Discriminant), -D_d) / 3.0;
		let sqrt_neg_Cd = sqrt(-C_d);
		let x_1d: f32 = 2.0 * sqrt_neg_Cd * cos(Theta);
		let x_3d: f32 = 2.0 * sqrt_neg_Cd * cos(Theta + (2.0 / 3.0) * pi);
		let xs: f32 = select(x_3d, x_1d, x_1d + x_3d < 2.0 * C);
		xsc = vec2f(-D, xs + C);
	}
	let E: f32 =  xlc.y * xsc.y;
	let F: f32 = -xlc.x * xsc.y - xlc.y * xsc.x;
	let G: f32 =  xlc.x * xsc.x;
	let xmc: vec2f = vec2f(C * F - B * G, -B * F + C * E);
	var Root: vec3f = vec3f(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);
	if (Root.x < Root.y && Root.x < Root.z) {
		Root = Root.yxz;
	} else if (Root.z < Root.x && Root.z < Root.y) {
		Root = Root.xzy;
	}
	return Root;
}
fn LTC_EvaluateDisk(N: vec3f, V: vec3f, P: vec3f, Minv: mat3x3f, points: Coords) -> f32 {
	let T1: vec3f = normalize(V - N * dot(V, N));
	let T2: vec3f = cross(N, T1);
	let R: mat3x3f = transpose( mat3x3f( T1, T2, N ) );
	var L_: array<vec3f, 3>;
	L_[0] = R * ( points.coord0 - P );
	L_[1] = R * ( points.coord1 - P );
	L_[2] = R * ( points.coord2 - P );
	let C: vec3f  = 0.5 * (L_[0] + L_[2]);
	var V1: vec3f = 0.5 * (L_[1] - L_[2]);
	var V2: vec3f = 0.5 * (L_[1] - L_[0]);
	let C_Minv: vec3f  = Minv * C;
	let V1_Minv: vec3f = Minv * V1;
	let V2_Minv: vec3f = Minv * V2;
	var a: f32;
	var b: f32;
	let d11: f32 = dot(V1_Minv, V1_Minv);
	let d22: f32 = dot(V2_Minv, V2_Minv);
	let d12: f32 = dot(V1_Minv, V2_Minv);
	if (abs(d12) / sqrt(d11 * d22) > 0.0001) {
		let tr: f32 = d11 + d22;
		let det_inner: f32 = -d12 * d12 + d11 * d22;
		let det: f32 = sqrt(det_inner);
		let u: f32 = 0.5 * sqrt(tr - 2.0 * det);
		let v: f32 = 0.5 * sqrt(tr + 2.0 * det);
		let e_max: f32 = (u + v) * (u + v);
		let e_min: f32 = (u - v) * (u - v);
		var V1_: vec3f;
		var V2_: vec3f;
		if (d11 > d22) {
			V1_ = d12 * V1_Minv + (e_max - d11) * V2_Minv;
			V2_ = d12 * V1_Minv + (e_min - d11) * V2_Minv;
		} else {
			V1_ = d12*V2_Minv + (e_max - d22)*V1_Minv;
			V2_ = d12*V2_Minv + (e_min - d22)*V1_Minv;
		}
		a = 1.0 / e_max;
		b = 1.0 / e_min;
		V1 = normalize(V1_);
		V2 = normalize(V2_);
	} else {
		a = 1.0 / dot(V1_Minv, V1_Minv);
		b = 1.0 / dot(V2_Minv, V2_Minv);
		V1 = V1_Minv * sqrt(a);
		V2 = V2_Minv * sqrt(b);
	}
	var V3: vec3f = normalize(cross(V1, V2));
	if (dot(C_Minv, V3) < 0.0) {
		V3 = V3 * -1.0;
	}
	let L: f32  = dot(V3, C_Minv);
	let x0: f32 = dot(V1, C_Minv) / L;
	let y0: f32 = dot(V2, C_Minv) / L;
	let E1: f32 = inverseSqrt(a);
	let E2: f32 = inverseSqrt(b);
	let a_scaled = a * L * L;
	let b_scaled = b * L * L;
	let c0: f32 = a_scaled * b_scaled;
	let c1: f32 = a_scaled * b_scaled * (1.0 + x0 * x0 + y0 * y0) - a_scaled - b_scaled;
	let c2: f32 = 1.0 - a_scaled * (1.0 + x0 * x0) - b_scaled * (1.0 + y0 * y0);
	let c3: f32 = 1.0;
	let roots: vec3f = SolveCubic(vec4f(c0, c1, c2, c3));
	let e1: f32 = roots.x;
	let e2: f32 = roots.y;
	let e3: f32 = roots.z;
	var avgDir: vec3f = vec3f(a_scaled * x0 / (a_scaled - e2), b_scaled * y0 / (b_scaled - e2), 1.0);
	let rotate: mat3x3f = mat3x3f(V1, V2, V3);
	avgDir = rotate * avgDir;
	avgDir = normalize(avgDir);
	let L1: f32 = sqrt(-e2 / e3);
	let L2: f32 = sqrt(-e2 / e1);
	let formFactor: f32 = max(0.0, L1 * L2 * inverseSqrt((1.0 + L1 * L1) * (1.0 + L2 * L2)));
	const LUT_SIZE_disk: f32 = 64.0;
	const LUT_SCALE_disk: f32 = ( LUT_SIZE_disk - 1.0 ) / LUT_SIZE_disk;
	const LUT_BIAS_disk: f32 = 0.5 / LUT_SIZE_disk;
	var uv: vec2f = vec2f(avgDir.z * 0.5 + 0.5, formFactor);
	uv = uv * LUT_SCALE_disk + LUT_BIAS_disk;
	let scale: f32 = textureSampleLevel(areaLightsLutTex2, areaLightsLutTex2Sampler, uv, 0.0).w;
	return formFactor * scale;
}
fn FixNan(value: f32) -> f32 {
	return select(value, 0.0, value != value);
}
fn getRectLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDir: vec3f, lightDirNorm: vec3f) -> f32 {
	let identityMat = mat3x3f(vec3f(1.0, 0.0, 0.0), vec3f(0.0, 1.0, 0.0), vec3f(0.0, 0.0, 1.0));
	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, identityMat, dLTCCoords );
}
fn getDiskLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDir: vec3f, lightDirNorm: vec3f) -> f32 {
	let identityMat = mat3x3f(vec3f(1.0, 0.0, 0.0), vec3f(0.0, 1.0, 0.0), vec3f(0.0, 0.0, 1.0));
	return FixNan(LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, identityMat, dLTCCoords ));
}
fn getSphereLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDir: vec3f, lightDirNorm: vec3f) -> f32 {
	let falloff: f32 = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);
	return FixNan(getLightDiffuse(worldNormal, viewDir, lightDirNorm) * falloff);
}
fn getLTCLightInvMat(uv: vec2f) -> mat3x3f {
	let t1: vec4f = textureSampleLevel(areaLightsLutTex1, areaLightsLutTex1Sampler, uv, 0.0);
	return mat3x3f(
		vec3f( t1.x, 0.0, t1.y ),
		vec3f( 0.0, 1.0, 0.0 ),
		vec3f( t1.z, 0.0, t1.w )
	);
}
fn calcRectLightSpecular(worldNormal: vec3f, viewDir: vec3f, uv: vec2f) -> f32 {
	let mInv: mat3x3f = getLTCLightInvMat(uv);
	return LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );
}
fn getRectLightSpecular(worldNormal: vec3f, viewDir: vec3f) -> f32 {
	return calcRectLightSpecular(worldNormal, viewDir, dLTCUV);
}
fn calcDiskLightSpecular(worldNormal: vec3f, viewDir: vec3f, uv: vec2f) -> f32 {
	let mInv: mat3x3f = getLTCLightInvMat(uv);
	return LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );
}
fn getDiskLightSpecular(worldNormal: vec3f, viewDir: vec3f) -> f32 {
	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);
}
fn getSphereLightSpecular(worldNormal: vec3f, viewDir: vec3f) -> f32 {
	return calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);
}
`,metalnessPS:`
#ifdef STD_METALNESS_CONSTANT
uniform material_metalness: f32;
#endif
fn getMetalness() {
	var metalness: f32 = 1.0;
	#ifdef STD_METALNESS_CONSTANT
		metalness = metalness * uniform.material_metalness;
	#endif
	#ifdef STD_METALNESS_TEXTURE
		metalness = metalness * textureSampleBias({STD_METALNESS_TEXTURE_NAME}, {STD_METALNESS_TEXTURE_NAME}Sampler, {STD_METALNESS_TEXTURE_UV}, uniform.textureBias).{STD_METALNESS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_METALNESS_VERTEX
	metalness = metalness * saturate(vVertexColor.{STD_METALNESS_VERTEX_CHANNEL});
	#endif
	dMetalness = metalness;
}
`,metalnessModulatePS:`
fn getSpecularModulate(specularity: vec3f, albedo: vec3f, metalness: f32, f0: f32, specularityFactor: f32) -> vec3f {
	let dielectricF0: vec3f = f0 * specularity * specularityFactor;
	return mix(dielectricF0, albedo, metalness);
}
fn getAlbedoModulate(albedo: vec3f, metalness: f32) -> vec3f {
	return albedo * (1.0 - metalness);
}
`,morphPS:`
	varying uv0: vec2f;
	var morphTexture: texture_2d_array<f32>;
	uniform morphFactor: array<f32, {MORPH_TEXTURE_MAX_COUNT}>;
	uniform morphIndex: array<u32, {MORPH_TEXTURE_MAX_COUNT}>;
	uniform count: u32;
	@fragment
	fn fragmentMain(input : FragmentInput) -> FragmentOutput {
		var color = vec3f(0, 0, 0);
		let textureDims = textureDimensions(morphTexture);
		let pixelCoords = vec2i(input.uv0 * vec2f(textureDims));
		
		for (var i: u32 = 0; i < uniform.count; i = i + 1) {
			var textureIndex: u32 = uniform.morphIndex[i].element;
			var delta = textureLoad(morphTexture, pixelCoords, textureIndex, 0).xyz;
			color += uniform.morphFactor[i].element * delta;
		}
		var output: FragmentOutput;
		output.color = vec4f(color, 1.0);
		return output;
	}
`,morphVS:`
	attribute vertex_position: vec2f;
	varying uv0: vec2f;
	@vertex
	fn vertexMain(input: VertexInput) -> VertexOutput {
		var output: VertexOutput;
		output.position = vec4f(input.vertex_position, 0.5, 1.0);
		output.uv0 = input.vertex_position * 0.5 + vec2f(0.5, 0.5);
		return output;
	}
`,msdfPS:`
var texture_msdfMap: texture_2d<f32>;
var texture_msdfMapSampler: sampler;
fn median(r: f32, g: f32, b: f32) -> f32 {
	return max(min(r, g), min(max(r, g), b));
}
fn map(min: f32, max: f32, v: f32) -> f32 {
	return (v - min) / (max - min);
}
uniform font_sdfIntensity: f32;
uniform font_pxrange: f32;
uniform font_textureWidth: f32;
#ifndef LIT_MSDF_TEXT_ATTRIBUTE
	uniform outline_color: vec4f;
	uniform outline_thickness: f32;
	uniform shadow_color: vec4f;
	uniform shadow_offset: vec2f;
#else
	varying outline_color: vec4f;
	varying outline_thickness: f32;
	varying shadow_color: vec4f;
	varying shadow_offset: vec2f;
#endif
fn applyMsdf(color_in: vec4f) -> vec4f {
	#ifndef LIT_MSDF_TEXT_ATTRIBUTE
		var outline_colorValue = uniform.outline_color;
		var outline_thicknessValue = uniform.outline_thickness;
		var shadow_colorValue = uniform.shadow_color;
		var shadow_offsetValue = uniform.shadow_offset;
	#else
		var outline_colorValue = outline_color;
		var outline_thicknessValue = outline_thickness;
		var shadow_colorValue = shadow_color;
		var shadow_offsetValue = shadow_offset;
	#endif
	var color = vec4f(gammaCorrectInputVec3(color_in.rgb), color_in.a);
	let tsample: vec3f = textureSample(texture_msdfMap, texture_msdfMapSampler, vUv0).rgb;
	let uvShdw: vec2f = vUv0 - shadow_offsetValue;
	let ssample: vec3f = textureSample(texture_msdfMap, texture_msdfMapSampler, uvShdw).rgb;
	let sigDist: f32 = median(tsample.r, tsample.g, tsample.b);
	var sigDistShdw: f32 = median(ssample.r, ssample.g, ssample.b);
	let smoothingMax: f32 = 0.2;
	let w: vec2f = abs(dpdx(vUv0)) + abs(dpdy(vUv0));
	let smoothing: f32 = clamp(w.x * uniform.font_textureWidth / uniform.font_pxrange, 0.0, smoothingMax);
	let mapMin: f32 = 0.05;
	let mapMax: f32 = clamp(1.0 - uniform.font_sdfIntensity, mapMin, 1.0);
	let sigDistInner: f32 = map(mapMin, mapMax, sigDist);
	let sigDistOutline: f32 = map(mapMin, mapMax, sigDist + outline_thicknessValue);
	sigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thicknessValue);
	let center: f32 = 0.5;
	let inside: f32 = smoothstep(center - smoothing, center + smoothing, sigDistInner);
	let outline: f32 = smoothstep(center - smoothing, center + smoothing, sigDistOutline);
	let shadow: f32 = smoothstep(center - smoothing, center + smoothing, sigDistShdw);
	let tcolor_outline: vec4f = outline * vec4f(outline_colorValue.a * outline_colorValue.rgb, outline_colorValue.a);
	var tcolor: vec4f = select(vec4f(0.0), tcolor_outline, outline > inside);
	tcolor = mix(tcolor, color, inside);
	let scolor_shadow: vec4f = shadow * vec4f(shadow_colorValue.a * shadow_colorValue.rgb, shadow_colorValue.a);
	let scolor: vec4f = select(tcolor, scolor_shadow, shadow > outline);
	tcolor = mix(scolor, tcolor, outline);
	tcolor = vec4f(gammaCorrectOutput(tcolor.rgb), tcolor.a);
	return tcolor;
}
`,msdfVS:`
attribute vertex_outlineParameters: vec3f;
attribute vertex_shadowParameters: vec3f;
varying outline_color: vec4f;
varying outline_thickness: f32;
varying shadow_color: vec4f;
varying shadow_offset: vec2f;
var<private> dOutlineColor: vec4f;
var<private> dOutlineThickness: f32;
var<private> dShadowColor: vec4f;
var<private> dShadowOffset: vec2f;
fn unpackMsdfParams() {
	let little: vec3f = vertex_outlineParameters % vec3f(256.0);
	let big: vec3f = (vertex_outlineParameters - little) / 256.0;
	dOutlineColor = vec4f(little.x, big.x, little.y, big.y) / 255.0;
	dOutlineThickness = little.z / 255.0 * 0.2;
	let little_shadow = vertex_shadowParameters % vec3f(256.0);
	let big_shadow = (vertex_shadowParameters - little_shadow) / 256.0;
	dShadowColor = vec4f(little_shadow.x, big_shadow.x, little_shadow.y, big_shadow.y) / 255.0;
	dShadowOffset = (vec2f(little_shadow.z, big_shadow.z) / 127.0 - 1.0) * 0.005;
}
`,normalVS:`
var<private> dNormalMatrix: mat3x3f;
fn getNormal() -> vec3f {
	dNormalMatrix = getNormalMatrix(dModelMatrix);
	let localNormal: vec3f = getLocalNormal(vertex_normal);
	return normalize(dNormalMatrix * localNormal);
}`,normalCoreVS:`
attribute vertex_normal: vec3f;
uniform matrix_normal: mat3x3f;
#ifdef MORPHING_NORMAL
	#ifdef MORPHING_INT
		var morphNormalTex: texture_2d<u32>;
		var morphNormalTexSampler: sampler;
	#else
		var morphNormalTex: texture_2d<f32>;
		var morphNormalTexSampler: sampler;
	#endif
#endif
fn getLocalNormal(vertexNormal: vec3f) -> vec3f {
	var localNormal: vec3f = vertexNormal;
	#ifdef MORPHING_NORMAL
		let morphUV: vec2i = getTextureMorphCoords();
		#ifdef MORPHING_INT
			let morphNormalInt: vec4u = textureLoad(morphNormalTex, morphUV, 0);
			let morphNormalF: vec3f = vec3f(morphNormalInt.xyz) / 65535.0 * 2.0 - 1.0;
			localNormal = localNormal + morphNormalF;
		#else
			let morphNormal: vec3f = textureLoad(morphNormalTex, morphUV, 0).xyz;
			localNormal = localNormal + morphNormal;
		#endif
	#endif
	return localNormal;
}
#if defined(SKIN) || defined(BATCH)
	fn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {
		return mat3x3f(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);
	}
#elif defined(INSTANCING)
	fn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {
		return mat3x3f(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);
	}
#else
	fn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {
		return uniform.matrix_normal;
	}
#endif
`,normalMapPS:`
#ifdef STD_NORMAL_TEXTURE
	uniform material_bumpiness: f32;
#endif
#ifdef STD_NORMALDETAIL_TEXTURE
	uniform material_normalDetailMapBumpiness: f32;
	fn blendNormals(inN1: vec3f, inN2: vec3f) -> vec3f {
		let n1: vec3f = inN1 + vec3f(0.0, 0.0, 1.0);
		let n2: vec3f = inN2 * vec3f(-1.0, -1.0, 1.0);
		return n1 * dot(n1, n2) / n1.z - n2;
	}
#endif
fn getNormal() {
#ifdef STD_NORMAL_TEXTURE
	var normalMap: vec3f = {STD_NORMAL_TEXTURE_DECODE}(textureSampleBias({STD_NORMAL_TEXTURE_NAME}, {STD_NORMAL_TEXTURE_NAME}Sampler, {STD_NORMAL_TEXTURE_UV}, uniform.textureBias));
	normalMap = mix(vec3f(0.0, 0.0, 1.0), normalMap, uniform.material_bumpiness);
	#ifdef STD_NORMALDETAIL_TEXTURE
		var normalDetailMap: vec3f = {STD_NORMALDETAIL_TEXTURE_DECODE}(textureSampleBias({STD_NORMALDETAIL_TEXTURE_NAME}, {STD_NORMALDETAIL_TEXTURE_NAME}Sampler, {STD_NORMALDETAIL_TEXTURE_UV}, uniform.textureBias));
		normalDetailMap = mix(vec3f(0.0, 0.0, 1.0), normalDetailMap, uniform.material_normalDetailMapBumpiness);
		normalMap = blendNormals(normalMap, normalDetailMap);
	#endif
	dNormalW = normalize(dTBN * normalMap);
#else
	dNormalW = dVertexNormalW;
#endif
}
`,opacityPS:`
uniform material_opacity: f32;
fn getOpacity() {
	dAlpha = uniform.material_opacity;
	#ifdef STD_OPACITY_TEXTURE
	dAlpha = dAlpha * textureSampleBias({STD_OPACITY_TEXTURE_NAME}, {STD_OPACITY_TEXTURE_NAME}Sampler, {STD_OPACITY_TEXTURE_UV}, uniform.textureBias).{STD_OPACITY_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_OPACITY_VERTEX
	dAlpha = dAlpha * clamp(vVertexColor.{STD_OPACITY_VERTEX_CHANNEL}, 0.0, 1.0);
	#endif
}
`,opacityDitherPS:`
#if STD_OPACITY_DITHER == BAYER8
	#include "bayerPS"
#endif
uniform blueNoiseJitter: vec4f;
#if STD_OPACITY_DITHER == BLUENOISE
	var blueNoiseTex32 : texture_2d<f32>;
	var blueNoiseTex32Sampler : sampler;
#endif
fn opacityDither(alpha: f32, id: f32) {
	#if STD_OPACITY_DITHER == BAYER8
		var noise: f32 = bayer8(floor((pcPosition.xy + uniform.blueNoiseJitter.xy + id) % vec2f(8.0))) / 64.0;
	#else
		#if STD_OPACITY_DITHER == BLUENOISE
			var uv = fract(pcPosition.xy / 32.0 + uniform.blueNoiseJitter.xy + id);
			var noise: f32 = textureSampleLevel(blueNoiseTex32, blueNoiseTex32Sampler, uv, 0.0).y;
		#endif
		#if STD_OPACITY_DITHER == IGNNOISE
			var magic = vec3f(0.06711056, 0.00583715, 52.9829189);
			var noise: f32 = fract(magic.z * fract(dot(pcPosition.xy + uniform.blueNoiseJitter.xy + id, magic.xy)));
		#endif
	#endif
	noise = pow(noise, 2.2);
	if (alpha < noise) {
		discard;
	}
}
`,outputPS:`
`,outputAlphaPS:`
#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == ADDITIVEALPHA || defined(LIT_ALPHA_TO_COVERAGE)
	output.color = vec4f(output.color.rgb, litArgs_opacity);
#elif LIT_BLEND_TYPE == PREMULTIPLIED
	output.color = vec4f(output.color.rgb * litArgs_opacity, litArgs_opacity);
#else
	output.color = vec4f(output.color.rgb, 1.0);
#endif
`,outputTex2DPS:`
varying vUv0: vec2f;
var source: texture_2d<f32>;
var sourceSampler: sampler;
@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	output.color = textureSample(source, sourceSampler, input.vUv0);
	return output;
}
`,sheenPS:`
uniform material_sheen: vec3f;
fn getSheen() {
	var sheenColor = uniform.material_sheen;
	#ifdef STD_SHEEN_TEXTURE
	sheenColor = sheenColor * {STD_SHEEN_TEXTURE_DECODE}(textureSampleBias({STD_SHEEN_TEXTURE_NAME}, {STD_SHEEN_TEXTURE_NAME}Sampler, {STD_SHEEN_TEXTURE_UV}, uniform.textureBias)).{STD_SHEEN_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SHEEN_VERTEX
	sheenColor = sheenColor * saturate3(vVertexColor.{STD_SHEEN_VERTEX_CHANNEL});
	#endif
	sSpecularity = sheenColor;
}
`,sheenGlossPS:`
uniform material_sheenGloss: f32;
fn getSheenGlossiness() {
	var sheenGlossiness = uniform.material_sheenGloss;
	#ifdef STD_SHEENGLOSS_TEXTURE
	sheenGlossiness = sheenGlossiness * textureSampleBias({STD_SHEENGLOSS_TEXTURE_NAME}, {STD_SHEENGLOSS_TEXTURE_NAME}Sampler, {STD_SHEENGLOSS_TEXTURE_UV}, uniform.textureBias).{STD_SHEENGLOSS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SHEENGLOSS_VERTEX
	sheenGlossiness = sheenGlossiness * saturate(vVertexColor.{STD_SHEENGLOSS_VERTEX_CHANNEL});
	#endif
	#ifdef STD_SHEENGLOSS_INVERT
	sheenGlossiness = 1.0 - sheenGlossiness;
	#endif
	sGlossiness = sheenGlossiness + 0.0000001;
}
`,parallaxPS:`
uniform material_heightMapFactor: f32;
fn getParallax() {
	var parallaxScale = uniform.material_heightMapFactor;
	var height: f32 = textureSampleBias({STD_HEIGHT_TEXTURE_NAME}, {STD_HEIGHT_TEXTURE_NAME}Sampler, {STD_HEIGHT_TEXTURE_UV}, uniform.textureBias).{STD_HEIGHT_TEXTURE_CHANNEL};
	height = height * parallaxScale - parallaxScale * 0.5;
	var viewDirT: vec3f = dViewDirW * dTBN;
	viewDirT.z = viewDirT.z + 0.42;
	dUvOffset = height * (viewDirT.xy / viewDirT.z);
}
`,pickPS:`
fn encodePickOutput(id: u32) -> vec4f {
	let inv: vec4f = vec4f(1.0 / 255.0);
	let shifts: vec4u = vec4u(16u, 8u, 0u, 24u);
	let col: vec4u = (vec4u(id) >> shifts) & vec4u(0xffu);
	return vec4f(col) * inv;
}
#ifndef PICK_CUSTOM_ID
	uniform meshInstanceId: u32;
	fn getPickOutput() -> vec4f {
		return encodePickOutput(uniform.meshInstanceId);
	}
#endif
#ifdef DEPTH_PICK_PASS
	#include "floatAsUintPS"
	fn getPickDepth() -> vec4f {
		return float2uint(pcPosition.z);
	}
#endif
`,reflDirPS:`
fn getReflDir(worldNormal: vec3f, viewDir: vec3f, gloss: f32, tbn: mat3x3f) {
	dReflDirW = normalize(-reflect(viewDir, worldNormal));
}
`,reflDirAnisoPS:`
fn getReflDir(worldNormal: vec3f, viewDir: vec3f, gloss: f32, tbn: mat3x3f) {
	let roughness: f32 = sqrt(1.0 - min(gloss, 1.0));
	let direction: vec2f = dAnisotropyRotation;
	let anisotropicT: vec3f = normalize(tbn * vec3f(direction, 0.0));
	let anisotropicB: vec3f = normalize(cross(tbn[2], anisotropicT));
	let anisotropy: f32 = dAnisotropy;
	let anisotropicDirection: vec3f = anisotropicB;
	let anisotropicTangent: vec3f = cross(anisotropicDirection, viewDir);
	let anisotropicNormal: vec3f = cross(anisotropicTangent, anisotropicDirection);
	let bendFactor: f32 = 1.0 - anisotropy * (1.0 - roughness);
	let bendFactor4: f32 = bendFactor * bendFactor * bendFactor * bendFactor;
	let bentNormal: vec3f = normalize(mix(normalize(anisotropicNormal), normalize(worldNormal), bendFactor4));
	dReflDirW = reflect(-viewDir, bentNormal);
}`,reflectionCCPS:`
#ifdef LIT_CLEARCOAT
fn addReflectionCC(reflDir: vec3f, gloss: f32) {
	ccReflection = ccReflection + calcReflection(reflDir, gloss);
}
#endif
`,reflectionCubePS:`
var texture_cubeMap: texture_cube<f32>;
var texture_cubeMapSampler: sampler;
uniform material_reflectivity: f32;
fn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {
	var lookupVec: vec3f = cubeMapProject(reflDir);
	lookupVec.x = lookupVec.x * -1.0;
	return {reflectionDecode}(textureSample(texture_cubeMap, texture_cubeMapSampler, lookupVec));
}
fn addReflection(reflDir: vec3f, gloss: f32) {
	dReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);
}
`,reflectionEnvHQPS:`
#ifndef ENV_ATLAS
	#define ENV_ATLAS
	var texture_envAtlas: texture_2d<f32>;
	var texture_envAtlasSampler: sampler;
#endif
var texture_cubeMap: texture_cube<f32>;
var texture_cubeMapSampler: sampler;
uniform material_reflectivity: f32;
fn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {
	let dir: vec3f = cubeMapProject(reflDir) * vec3f(-1.0, 1.0, 1.0);
	let uv: vec2f = toSphericalUv(dir);
	let level: f32 = saturate(1.0 - gloss) * 5.0;
	let ilevel: f32 = floor(level);
	let flevel: f32 = level - ilevel;
	let sharp: vec3f = {reflectionCubemapDecode}(textureSample(texture_cubeMap, texture_cubeMapSampler, dir));
	let roughA: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, mapRoughnessUv(uv, ilevel)));
	let roughB: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, mapRoughnessUv(uv, ilevel + 1.0)));
	return processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));
}
fn addReflection(reflDir: vec3f, gloss: f32) {
	dReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);
}
`,reflectionEnvPS:`
#ifndef ENV_ATLAS
#define ENV_ATLAS
	var texture_envAtlas: texture_2d<f32>;
	var texture_envAtlasSampler: sampler;
#endif
uniform material_reflectivity: f32;
fn shinyMipLevel(uv: vec2f) -> f32 {
	let dx: vec2f = dpdx(uv);
	let dy: vec2f = dpdy(uv);
	let uv2: vec2f = vec2f(fract(uv.x + 0.5), uv.y);
	let dx2: vec2f = dpdx(uv2);
	let dy2: vec2f = dpdy(uv2);
	let maxd: f32 = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));
	return clamp(0.5 * log2(maxd) - 1.0 + uniform.textureBias, 0.0, 5.0);
}
fn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {
	let dir: vec3f = cubeMapProject(reflDir) * vec3f(-1.0, 1.0, 1.0);
	let uv: vec2f = toSphericalUv(dir);
	let level: f32 = saturate(1.0 - gloss) * 5.0;
	let ilevel: f32 = floor(level);
	let level2: f32 = shinyMipLevel(uv * atlasSize);
	let ilevel2: f32 = floor(level2);
	var uv0: vec2f;
	var uv1: vec2f;
	var weight: f32;
	if (ilevel == 0.0) {
		uv0 = mapShinyUv(uv, ilevel2);
		uv1 = mapShinyUv(uv, ilevel2 + 1.0);
		weight = level2 - ilevel2;
	} else {
		uv0 = mapRoughnessUv(uv, ilevel);
		uv1 = uv0;
		weight = 0.0;
	}
	let linearA: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, uv0));
	let linearB: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, uv1));
	let linear0: vec3f = mix(linearA, linearB, weight);
	let linear1: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, mapRoughnessUv(uv, ilevel + 1.0)));
	return processEnvironment(mix(linear0, linear1, level - ilevel));
}
fn addReflection(reflDir: vec3f, gloss: f32) {
	dReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);
}
`,reflectionSpherePS:`
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform matrix_view: mat4x4f;
#endif
var texture_sphereMap: texture_2d<f32>;
var texture_sphereMapSampler: sampler;
uniform material_reflectivity: f32;
fn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {
	let viewRotationMatrix = mat3x3f(uniform.matrix_view[0].xyz, uniform.matrix_view[1].xyz, uniform.matrix_view[2].xyz);
	let reflDirV: vec3f = viewRotationMatrix * reflDir;
	let m: f32 = 2.0 * sqrt(dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z + 1.0) * (reflDirV.z + 1.0));
	let sphereMapUv: vec2f = reflDirV.xy / m + 0.5;
	return {reflectionDecode}(textureSample(texture_sphereMap, texture_sphereMapSampler, sphereMapUv));
}
fn addReflection(reflDir: vec3f, gloss: f32) {
	dReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);
}
`,reflectionSheenPS:`
fn addReflectionSheen(worldNormal: vec3f, viewDir: vec3f, gloss: f32) {
	let NoV: f32 = dot(worldNormal, viewDir);
	let alphaG: f32 = gloss * gloss;
	let a: f32 = select(
		-8.48 * alphaG + 14.3 * gloss - 9.95,
		-339.2 * alphaG + 161.4 * gloss - 25.9,
		gloss < 0.25
	);
	let b: f32 = select(
		1.97 * alphaG - 3.27 * gloss + 0.72,
		44.0 * alphaG - 23.7 * gloss + 3.26,
		gloss < 0.25
	);
	let dg_add: f32 = select(
		0.1 * ( gloss - 0.25 ),
		0.0,
		gloss < 0.25
	);
	let dg: f32 = exp( a * NoV + b ) + dg_add;
	sReflection = sReflection + (calcReflection(worldNormal, 0.0) * saturate(dg));
}`,refractionCubePS:`
fn refract2(viewVec: vec3f, normal: vec3f, IOR: f32) -> vec3f {
	let vn: f32 = dot(viewVec, normal);
	let k: f32 = 1.0 - IOR * IOR * (1.0 - vn * vn);
	let refrVec: vec3f = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;
	return refrVec;
}
fn addRefraction(
	worldNormal: vec3f,
	viewDir: vec3f,
	thickness: f32,
	gloss: f32,
	specularity: vec3f,
	albedo: vec3f,
	transmission: f32,
	refractionIndex: f32,
	dispersion: f32
#if defined(LIT_IRIDESCENCE)
	, iridescenceFresnel: vec3f,
	iridescenceIntensity: f32
#endif
) {
	let tmpRefl: vec4f = dReflection;
	let reflectionDir: vec3f = refract2(-viewDir, worldNormal, refractionIndex);
	dReflection = vec4f(0.0);
	addReflection(reflectionDir, gloss);
	dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);
	dReflection = tmpRefl;
}
`,refractionDynamicPS:`
uniform material_invAttenuationDistance: f32;
uniform material_attenuation: vec3f;
fn evalRefractionColor(refractionVector: vec3f, gloss: f32, refractionIndex: f32) -> vec3f {
	let pointOfRefraction: vec4f = vec4f(vPositionW + refractionVector, 1.0);
	let projectionPoint: vec4f = uniform.matrix_viewProjection * pointOfRefraction;
	let uv: vec2f = getGrabScreenPos(projectionPoint);
	let iorToRoughness: f32 = (1.0 - gloss) * clamp((1.0 / refractionIndex) * 2.0 - 2.0, 0.0, 1.0);
	let refractionLod: f32 = log2(uniform.uScreenSize.x) * iorToRoughness;
	var refraction: vec3f = textureSampleLevel(uSceneColorMap, uSceneColorMapSampler, uv, refractionLod).rgb;
	#ifdef SCENE_COLORMAP_GAMMA
		refraction = decodeGamma3(refraction);
	#endif
	return refraction;
}
fn addRefraction(
	worldNormal: vec3f,
	viewDir: vec3f,
	thickness: f32,
	gloss: f32,
	specularity: vec3f,
	albedo: vec3f,
	transmission: f32,
	refractionIndex: f32,
	dispersion: f32,
#if defined(LIT_IRIDESCENCE)
	iridescenceFresnel: vec3f,
	iridescenceIntensity: f32
#endif
) {
	var modelScale: vec3f;
	modelScale.x = length(uniform.matrix_model[0].xyz);
	modelScale.y = length(uniform.matrix_model[1].xyz);
	modelScale.z = length(uniform.matrix_model[2].xyz);
	let scale: vec3f = thickness * modelScale;
	var refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndex)) * scale;
	var refraction = evalRefractionColor(refractionVector, gloss, refractionIndex);
	#ifdef LIT_DISPERSION
		let halfSpread: f32 = (1.0 / refractionIndex - 1.0) * 0.025 * dispersion;
		let refractionIndexR: f32 = refractionIndex - halfSpread;
		refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexR)) * scale;
		refraction.r = evalRefractionColor(refractionVector, gloss, refractionIndexR).r;
		let refractionIndexB: f32 = refractionIndex + halfSpread;
		refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexB)) * scale;
		refraction.b = evalRefractionColor(refractionVector, gloss, refractionIndexB).b;
	#endif
	var transmittance: vec3f;
	if (uniform.material_invAttenuationDistance != 0.0)
	{
		let attenuation: vec3f = -log(uniform.material_attenuation) * uniform.material_invAttenuationDistance;
		transmittance = exp(-attenuation * length(refractionVector));
	}
	else
	{
		transmittance = vec3f(1.0);
	}
	let fresnel: vec3f = vec3f(1.0) -
		getFresnel(
			dot(viewDir, worldNormal),
			gloss,
			specularity
		#if defined(LIT_IRIDESCENCE)
			, iridescenceFresnel,
			iridescenceIntensity
		#endif
		);
	dDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);
}
`,reprojectPS:`
varying vUv0: vec2f;
#ifdef CUBEMAP_SOURCE
	var sourceCube: texture_cube<f32>;
	var sourceCubeSampler : sampler;
#else
	var sourceTex: texture_2d<f32>;
	var sourceTexSampler : sampler;
#endif
#ifdef USE_SAMPLES_TEX
	var samplesTex: texture_2d<f32>;
	var samplesTexSampler : sampler;
	uniform samplesTexInverseSize: vec2f;
#endif
uniform params: vec3f;
fn targetFace() -> f32 { return uniform.params.x; }
fn targetTotalPixels() -> f32 { return uniform.params.y; }
fn sourceTotalPixels() -> f32 { return uniform.params.z; }
const PI: f32 = 3.141592653589793;
fn saturate(x: f32) -> f32 {
	return clamp(x, 0.0, 1.0);
}
#include "decodePS"
#include "encodePS"
fn modifySeams(dir: vec3f, scale: f32) -> vec3f {
	let adir = abs(dir);
	let M = max(max(adir.x, adir.y), adir.z);
	return dir / M * vec3f(
		select(scale, 1.0, adir.x == M),
		select(scale, 1.0, adir.y == M),
		select(scale, 1.0, adir.z == M)
	);
}
fn toSpherical(dir: vec3f) -> vec2f {
	let nonZeroXZ = any(dir.xz != vec2f(0.0, 0.0));
	return vec2f(select(0.0, atan2(dir.x, dir.z), nonZeroXZ), asin(dir.y));
}
fn fromSpherical(uv: vec2f) -> vec3f {
	return vec3f(cos(uv.y) * sin(uv.x),
				sin(uv.y),
				cos(uv.y) * cos(uv.x));
}
fn getDirectionEquirect(uv: vec2f) -> vec3f {
	return fromSpherical((vec2f(uv.x, 1.0 - uv.y) * 2.0 - 1.0) * vec2f(PI, PI * 0.5));
}
fn signNotZero(k: f32) -> f32 {
	return select(-1.0, 1.0, k >= 0.0);
}
fn signNotZeroVec2(v: vec2f) -> vec2f {
	return vec2f(signNotZero(v.x), signNotZero(v.y));
}
fn octDecode(o: vec2f) -> vec3f {
	var v = vec3f(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);
	if (v.y < 0.0) {
		var temp: vec2f = (1.0 - abs(v.zx)) * signNotZeroVec2(v.xz);
		v = vec3f(temp.x, v.y, temp.y);
	}
	return normalize(v);
}
fn getDirectionOctahedral(uv: vec2f) -> vec3f {
	return octDecode(vec2f(uv.x, 1.0 - uv.y) * 2.0 - 1.0);
}
fn octEncode(v: vec3f) -> vec2f {
	let l1norm = abs(v.x) + abs(v.y) + abs(v.z);
	var result = v.xz * (1.0 / l1norm);
	if (v.y < 0.0) {
		result = (1.0 - abs(result.yx)) * signNotZeroVec2(result.xy);
	}
	return result;
}
#ifdef CUBEMAP_SOURCE
	fn sampleCubemapDir(dir: vec3f) -> vec4f {
		return textureSample(sourceCube, sourceCubeSampler, modifySeams(dir, 1.0));
	}
	fn sampleCubemapSph(sph: vec2f) -> vec4f {
		return sampleCubemapDir(fromSpherical(sph));
	}
	fn sampleCubemapDirLod(dir: vec3f, mipLevel: f32) -> vec4f {
		return textureSampleLevel(sourceCube, sourceCubeSampler, modifySeams(dir, 1.0), mipLevel);
	}
	fn sampleCubemapSphLod(sph: vec2f, mipLevel: f32) -> vec4f {
		return sampleCubemapDirLod(fromSpherical(sph), mipLevel);
	}
#else
	fn sampleEquirectSph(sph: vec2f) -> vec4f {
		let uv = sph / vec2f(PI * 2.0, PI) + 0.5;
		return textureSample(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y));
	}
	fn sampleEquirectDir(dir: vec3f) -> vec4f {
		return sampleEquirectSph(toSpherical(dir));
	}
	fn sampleEquirectSphLod(sph: vec2f, mipLevel: f32) -> vec4f {
		let uv = sph / vec2f(PI * 2.0, PI) + 0.5;
		return textureSampleLevel(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y), mipLevel);
	}
	fn sampleEquirectDirLod(dir: vec3f, mipLevel: f32) -> vec4f {
		return sampleEquirectSphLod(toSpherical(dir), mipLevel);
	}
	fn sampleOctahedralDir(dir: vec3f) -> vec4f {
		let uv = octEncode(dir) * 0.5 + 0.5;
		return textureSample(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y));
	}
	fn sampleOctahedralSph(sph: vec2f) -> vec4f {
		return sampleOctahedralDir(fromSpherical(sph));
	}
	fn sampleOctahedralDirLod(dir: vec3f, mipLevel: f32) -> vec4f {
		let uv = octEncode(dir) * 0.5 + 0.5;
		return textureSampleLevel(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y), mipLevel);
	}
	fn sampleOctahedralSphLod(sph: vec2f, mipLevel: f32) -> vec4f {
		return sampleOctahedralDirLod(fromSpherical(sph), mipLevel);
	}
#endif
fn getDirectionCubemap(uv: vec2f) -> vec3f {
	let st = uv * 2.0 - 1.0;
	let face = targetFace();
	var vec: vec3f;
	if (face == 0.0) {
		vec = vec3f(1, -st.y, -st.x);
	} else if (face == 1.0) {
		vec = vec3f(-1, -st.y, st.x);
	} else if (face == 2.0) {
		vec = vec3f(st.x, 1, st.y);
	} else if (face == 3.0) {
		vec = vec3f(st.x, -1, -st.y);
	} else if (face == 4.0) {
		vec = vec3f(st.x, -st.y, 1);
	} else {
		vec = vec3f(-st.x, -st.y, -1);
	}
	return normalize(modifySeams(vec, 1.0));
}
fn matrixFromVector(n: vec3f) -> mat3x3f {
	let a = 1.0 / (1.0 + n.z);
	let b = -n.x * n.y * a;
	let b1 = vec3f(1.0 - n.x * n.x * a, b, -n.x);
	let b2 = vec3f(b, 1.0 - n.y * n.y * a, -n.y);
	return mat3x3f(b1, b2, n);
}
fn matrixFromVectorSlow(n: vec3f) -> mat3x3f {
	let up = select(vec3f(0.0, 0.0, select(-1.0, 1.0, n.y > 0.0)), vec3f(0.0, 1.0, 0.0), abs(n.y) > 0.0000001);
	let x = normalize(cross(up, n));
	let y = cross(n, x);
	return mat3x3f(x, y, n);
}
fn reproject(uv: vec2f) -> vec4f {
	if ({NUM_SAMPLES} <= 1) {
		return {ENCODE_FUNC}({DECODE_FUNC}({SOURCE_FUNC}Dir({TARGET_FUNC}(uv))));
	} else {
		let t = {TARGET_FUNC}(uv);
		let tu = dpdx(t);
		let tv = dpdy(t);
		var result = vec3f(0.0);
		for (var u = 0.0; u < {NUM_SAMPLES_SQRT}; u += 1.0) {
			for (var v = 0.0; v < {NUM_SAMPLES_SQRT}; v += 1.0) {
				result += {DECODE_FUNC}({SOURCE_FUNC}Dir(normalize(t +
															tu * (u / {NUM_SAMPLES_SQRT} - 0.5) +
															tv * (v / {NUM_SAMPLES_SQRT} - 0.5))));
			}
		}
		return {ENCODE_FUNC}(result / ({NUM_SAMPLES_SQRT} * {NUM_SAMPLES_SQRT}));
	}
}
const unpackFloat: vec4f = vec4f(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);
#ifdef USE_SAMPLES_TEX
	fn unpackSample(i: i32, L: ptr<function, vec3f>, mipLevel: ptr<function, f32>) {
		var u = (f32(i * 4) + 0.5) * uniform.samplesTexInverseSize.x;
		var v = (floor(u) + 0.5) * uniform.samplesTexInverseSize.y;
		var raw: vec4f;
		raw.x = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;
		raw.y = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;
		raw.z = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;
		raw.w = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat);
		*L = raw.xyz * 2.0 - 1.0;
		*mipLevel = raw.w * 8.0;
	}
	fn prefilterSamples(uv: vec2f) -> vec4f {
		let vecSpace = matrixFromVectorSlow({TARGET_FUNC}(uv));
		var L: vec3f;
		var mipLevel: f32;
		var result = vec3f(0.0);
		var totalWeight = 0.0;
		for (var i = 0; i < {NUM_SAMPLES}; i += 1) {
			unpackSample(i, &L, &mipLevel);
			result += {DECODE_FUNC}({SOURCE_FUNC}DirLod(vecSpace * L, mipLevel)) * L.z;
			totalWeight += L.z;
		}
		return {ENCODE_FUNC}(result / totalWeight);
	}
	fn prefilterSamplesUnweighted(uv: vec2f) -> vec4f {
		let vecSpace = matrixFromVectorSlow({TARGET_FUNC}(uv));
		var L: vec3f;
		var mipLevel: f32;
		var result = vec3f(0.0);
		for (var i = 0; i < {NUM_SAMPLES}; i += 1) {
			unpackSample(i, &L, &mipLevel);
			result += {DECODE_FUNC}({SOURCE_FUNC}DirLod(vecSpace * L, mipLevel));
		}
		return {ENCODE_FUNC}(result / f32({NUM_SAMPLES}));
	}
#endif
@fragment
fn fragmentMain(input : FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	output.color = {PROCESS_FUNC}(input.vUv0);
	return output;
}
`,reprojectVS:`
attribute vertex_position: vec2f;
uniform uvMod: vec4f;
varying vUv0: vec2f;
@vertex
fn vertexMain(input: VertexInput) -> VertexOutput {
	var output: VertexOutput;
	output.position = vec4f(input.vertex_position, 0.5, 1.0);
	output.vUv0 = getImageEffectUV((input.vertex_position * 0.5 + vec2f(0.5, 0.5)) * uniform.uvMod.xy + uniform.uvMod.zw);
	return output;
}
`,screenDepthPS:`
var uSceneDepthMap: texture_2d<uff>;
#ifndef SCREENSIZE
	#define SCREENSIZE
	uniform uScreenSize: vec4f;
#endif
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform matrix_view: mat4x4f;
#endif
#ifndef LINEARIZE_DEPTH
	#define LINEARIZE_DEPTH
	#ifndef CAMERAPLANES
		#define CAMERAPLANES
		uniform camera_params: vec4f;
	#endif
	fn linearizeDepth(z: f32) -> f32 {
		if (uniform.camera_params.w == 0.0) {
			return (uniform.camera_params.z * uniform.camera_params.y) / (uniform.camera_params.y + z * (uniform.camera_params.z - uniform.camera_params.y));
		} else {
			return uniform.camera_params.z + z * (uniform.camera_params.y - uniform.camera_params.z);
		}
	}
#endif
fn delinearizeDepth(linearDepth: f32) -> f32 {
	if (uniform.camera_params.w == 0.0) {
		return (uniform.camera_params.y * (uniform.camera_params.z - linearDepth)) / (linearDepth * (uniform.camera_params.z - uniform.camera_params.y));
	} else {
		return (linearDepth - uniform.camera_params.z) / (uniform.camera_params.y - uniform.camera_params.z);
	}
}
fn getLinearScreenDepth(uv: vec2f) -> f32 {
	let textureSize = textureDimensions(uSceneDepthMap, 0);
	let texel: vec2i = vec2i(uv * vec2f(textureSize));
	#ifdef SCENE_DEPTHMAP_LINEAR
		return textureLoad(uSceneDepthMap, texel, 0).r;
	#else
		return linearizeDepth(textureLoad(uSceneDepthMap, texel, 0).r);
	#endif
}
#ifndef VERTEXSHADER
	fn getLinearScreenDepthFrag() -> f32 {
		let uv: vec2f = pcPosition.xy * uniform.uScreenSize.zw;
		return getLinearScreenDepth(uv);
	}
#endif
fn getLinearDepth(pos: vec3f) -> f32 {
	return -(uniform.matrix_view * vec4f(pos, 1.0)).z;
}
`,shadowCascadesPS:`
fn getShadowCascadeIndex(shadowCascadeDistances: vec4f, shadowCascadeCount: i32) -> i32 {
	let depth: f32 = 1.0 / pcPosition.w;
	let comparisons: vec4f = step(shadowCascadeDistances, vec4f(depth));
	let cascadeIndex: i32 = i32(dot(comparisons, vec4f(1.0)));
	return min(cascadeIndex, shadowCascadeCount - 1);
}
fn ditherShadowCascadeIndex(cascadeIndex_in: i32, shadowCascadeDistances: vec4f, shadowCascadeCount: i32, blendFactor: f32) -> i32 {
	var cascadeIndex: i32 = cascadeIndex_in;
	if (cascadeIndex < shadowCascadeCount - 1) {
		let currentRangeEnd: f32 = shadowCascadeDistances[cascadeIndex];
		let transitionStart: f32 = blendFactor * currentRangeEnd;
		let depth: f32 = 1.0 / pcPosition.w;
		if (depth > transitionStart) {
			let transitionFactor: f32 = smoothstep(transitionStart, currentRangeEnd, depth);
			let dither: f32 = fract(sin(dot(pcPosition.xy, vec2f(12.9898, 78.233))) * 43758.5453);
			if (dither < transitionFactor) {
				cascadeIndex = cascadeIndex + 1;
			}
		}
	}
	return cascadeIndex;
}
fn fadeShadow(shadowCoord_in: vec3f, shadowCascadeDistances: vec4f) -> vec3f {
	var shadowCoord: vec3f = shadowCoord_in;
	let depth: f32 = 1.0 / pcPosition.w;
	if (depth > shadowCascadeDistances.w) {
		shadowCoord.z = -9999999.0;
	}
	return shadowCoord;
}
`,shadowEVSMPS:`
fn linstep(a: f32, b: f32, v: f32) -> f32 {
	return clamp((v - a) / (b - a), 0.0, 1.0);
}
fn reduceLightBleeding(pMax: f32, amount: f32) -> f32 {
	 return linstep(amount, 1.0, pMax);
}
fn chebyshevUpperBound(moments: vec2f, mean: f32, minVariance: f32, lightBleedingReduction: f32) -> f32 {
	var variance: f32 = moments.y - (moments.x * moments.x);
	variance = max(variance, minVariance);
	let d: f32 = mean - moments.x;
	var pMax: f32 = variance / (variance + (d * d));
	pMax = reduceLightBleeding(pMax, lightBleedingReduction);
	return select(pMax, 1.0, mean <= moments.x);
}
fn calculateEVSM(moments_in: vec3f, Z_in: f32, vsmBias: f32, exponent: f32) -> f32 {
	let Z: f32 = 2.0 * Z_in - 1.0;
	let warpedDepth: f32 = exp(exponent * Z);
	let moments: vec2f = moments_in.xy + vec2f(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments_in.z);
	let VSMBias: f32 = vsmBias;
	let depthScale: f32 = VSMBias * exponent * warpedDepth;
	let minVariance1: f32 = depthScale * depthScale;
	return chebyshevUpperBound(moments, warpedDepth, minVariance1, 0.1);
}
fn VSM16(tex: texture_2d<f32>, texSampler: sampler, texCoords: vec2f, resolution: f32, Z: f32, vsmBias: f32, exponent: f32) -> f32 {
	let moments: vec3f = textureSampleLevel(tex, texSampler, texCoords, 0.0).xyz;
	return calculateEVSM(moments, Z, vsmBias, exponent);
}
fn getShadowVSM16(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32) -> f32 {
	return VSM16(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);
}
fn getShadowSpotVSM16(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32, lightDir: vec3f) -> f32 {
	let Z: f32 = length(lightDir) * shadowParams.w + shadowParams.z;
	return VSM16(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, Z, shadowParams.y, exponent);
}
fn VSM32(tex: texture_2d<f32>, texSampler: sampler, texCoords_in: vec2f, resolution: f32, Z: f32, vsmBias: f32, exponent: f32) -> f32 {
	#ifdef CAPS_TEXTURE_FLOAT_FILTERABLE
		var moments: vec3f = textureSampleLevel(tex, texSampler, texCoords_in, 0.0).xyz;
	#else
		var pixelSize : f32 = 1.0 / resolution;
		let texCoords: vec2f = texCoords_in - vec2f(pixelSize);
		let s00: vec3f = textureSampleLevel(tex, texSampler, texCoords, 0.0).xyz;
		let s10: vec3f = textureSampleLevel(tex, texSampler, texCoords + vec2f(pixelSize, 0.0), 0.0).xyz;
		let s01: vec3f = textureSampleLevel(tex, texSampler, texCoords + vec2f(0.0, pixelSize), 0.0).xyz;
		let s11: vec3f = textureSampleLevel(tex, texSampler, texCoords + vec2f(pixelSize), 0.0).xyz;
		let fr: vec2f = fract(texCoords * resolution);
		let h0: vec3f = mix(s00, s10, fr.x);
		let h1: vec3f = mix(s01, s11, fr.x);
		var moments: vec3f = mix(h0, h1, fr.y);
	#endif
	return calculateEVSM(moments, Z, vsmBias, exponent);
}
fn getShadowVSM32(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32) -> f32 {
	return VSM32(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);
}
fn getShadowSpotVSM32(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32, lightDir: vec3f) -> f32 {
	let Z: f32 = length(lightDir) * shadowParams.w + shadowParams.z;
	return VSM32(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, Z, shadowParams.y, exponent);
}
`,shadowPCF1PS:`
fn getShadowPCF1x1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
	return textureSampleCompareLevel(shadowMap, shadowMapSampler, shadowCoord.xy, shadowCoord.z);
}
fn getShadowSpotPCF1x1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
	return textureSampleCompareLevel(shadowMap, shadowMapSampler, shadowCoord.xy, shadowCoord.z);
}
`,shadowPCF3PS:`
fn _getShadowPCF3x3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec3f) -> f32 {
	let z: f32 = shadowCoord.z;
	let uv: vec2f = shadowCoord.xy * shadowParams.x;
	let shadowMapSizeInv: f32 = 1.0 / shadowParams.x;
	let base_uv_temp: vec2f = floor(uv + 0.5);
	let s: f32 = (uv.x + 0.5 - base_uv_temp.x);
	let t: f32 = (uv.y + 0.5 - base_uv_temp.y);
	let base_uv: vec2f = (base_uv_temp - vec2f(0.5)) * shadowMapSizeInv;
	var sum: f32 = 0.0;
	let uw0: f32 = (3.0 - 2.0 * s);
	let uw1: f32 = (1.0 + 2.0 * s);
	let u0_offset: f32 = (2.0 - s) / uw0 - 1.0;
	let u1_offset: f32 = s / uw1 + 1.0;
	let vw0: f32 = (3.0 - 2.0 * t);
	let vw1: f32 = (1.0 + 2.0 * t);
	let v0_offset: f32 = (2.0 - t) / vw0 - 1.0;
	let v1_offset: f32 = t / vw1 + 1.0;
	let u0: f32 = u0_offset * shadowMapSizeInv + base_uv.x;
	let v0: f32 = v0_offset * shadowMapSizeInv + base_uv.y;
	let u1: f32 = u1_offset * shadowMapSizeInv + base_uv.x;
	let v1: f32 = v1_offset * shadowMapSizeInv + base_uv.y;
	sum = sum + uw0 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v0), z);
	sum = sum + uw1 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v0), z);
	sum = sum + uw0 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v1), z);
	sum = sum + uw1 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v1), z);
	sum = sum * (1.0 / 16.0);
	return sum;
}
fn getShadowPCF3x3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
	return _getShadowPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);
}
fn getShadowSpotPCF3x3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
	return _getShadowPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);
}
`,shadowPCF5PS:`
fn _getShadowPCF5x5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec3f) -> f32 {
	let z: f32 = shadowCoord.z;
	let uv: vec2f = shadowCoord.xy * shadowParams.x;
	let shadowMapSizeInv: f32 = 1.0 / shadowParams.x;
	let base_uv_temp: vec2f = floor(uv + 0.5);
	let s: f32 = (uv.x + 0.5 - base_uv_temp.x);
	let t: f32 = (uv.y + 0.5 - base_uv_temp.y);
	let base_uv: vec2f = (base_uv_temp - vec2f(0.5)) * shadowMapSizeInv;
	let uw0: f32 = (4.0 - 3.0 * s);
	let uw1: f32 = 7.0;
	let uw2: f32 = (1.0 + 3.0 * s);
	let u0_offset: f32 = (3.0 - 2.0 * s) / uw0 - 2.0;
	let u1_offset: f32 = (3.0 + s) / uw1;
	let u2_offset: f32 = s / uw2 + 2.0;
	let vw0: f32 = (4.0 - 3.0 * t);
	let vw1: f32 = 7.0;
	let vw2: f32 = (1.0 + 3.0 * t);
	let v0_offset: f32 = (3.0 - 2.0 * t) / vw0 - 2.0;
	let v1_offset: f32 = (3.0 + t) / vw1;
	let v2_offset: f32 = t / vw2 + 2.0;
	var sum: f32 = 0.0;
	let u0: f32 = u0_offset * shadowMapSizeInv + base_uv.x;
	let v0: f32 = v0_offset * shadowMapSizeInv + base_uv.y;
	let u1: f32 = u1_offset * shadowMapSizeInv + base_uv.x;
	let v1: f32 = v1_offset * shadowMapSizeInv + base_uv.y;
	let u2: f32 = u2_offset * shadowMapSizeInv + base_uv.x;
	let v2: f32 = v2_offset * shadowMapSizeInv + base_uv.y;
	sum = sum + uw0 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v0), z);
	sum = sum + uw1 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v0), z);
	sum = sum + uw2 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u2, v0), z);
	sum = sum + uw0 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v1), z);
	sum = sum + uw1 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v1), z);
	sum = sum + uw2 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u2, v1), z);
	sum = sum + uw0 * vw2 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v2), z);
	sum = sum + uw1 * vw2 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v2), z);
	sum = sum + uw2 * vw2 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u2, v2), z);
	sum = sum * (1.0 / 144.0);
	sum = saturate(sum);
	return sum;
}
fn getShadowPCF5x5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
	return _getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);
}
fn getShadowSpotPCF5x5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {
	return _getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);
}
`,shadowSoftPS:`
fn fractSinRand(uv: vec2f) -> f32 {
	let PI: f32 = 3.141592653589793;
	let a: f32 = 12.9898; let b: f32 = 78.233; let c: f32 = 43758.5453;
	let dt: f32 = dot(uv.xy, vec2f(a, b));
	let sn: f32 = dt % PI;
	return fract(sin(sn) * c);
}
struct VogelDiskData {
	invNumSamples: f32,
	initialAngle: f32,
	currentPointId: f32,
}
fn prepareDiskConstants(data: ptr<function, VogelDiskData>, sampleCount: i32, randomSeed: f32) {
	let pi2: f32 = 6.28318530718;
	data.invNumSamples = 1.0 / f32(sampleCount);
	data.initialAngle = randomSeed * pi2;
	data.currentPointId = 0.0;
}
fn generateDiskSample(data: ptr<function, VogelDiskData>) -> vec2f {
	let GOLDEN_ANGLE: f32 = 2.399963;
	let r: f32 = sqrt((data.currentPointId + 0.5) * data.invNumSamples);
	let theta: f32 = data.currentPointId * GOLDEN_ANGLE + data.initialAngle;
	let offset: vec2f = vec2f(cos(theta), sin(theta)) * pow(r, 1.33);
	data.currentPointId = data.currentPointId + 1.0;
	return offset;
}
fn PCSSFindBlocker(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, avgBlockerDepth: ptr<function, f32>, numBlockers: ptr<function, i32>,
	shadowCoords: vec2f, z: f32, shadowBlockerSamples: i32, penumbraSize: f32, invShadowMapSize: f32, randomSeed: f32) {
	var diskData: VogelDiskData;
	prepareDiskConstants(&diskData, shadowBlockerSamples, randomSeed);
	let searchWidth: f32 = penumbraSize * invShadowMapSize;
	var blockerSum: f32 = 0.0;
	var numBlockers_local: i32 = 0;
	for( var i: i32 = 0; i < shadowBlockerSamples; i = i + 1 ) {
		let diskUV: vec2f = generateDiskSample(&diskData);
		let sampleUV: vec2f = shadowCoords + diskUV * searchWidth;
		let shadowMapDepth: f32 = textureSampleLevel(shadowMap, shadowMapSampler, sampleUV, 0.0).r;
		if ( shadowMapDepth < z ) {
			blockerSum = blockerSum + shadowMapDepth;
			numBlockers_local = numBlockers_local + 1;
		}
	}
	*avgBlockerDepth = blockerSum / f32(numBlockers_local);
	*numBlockers = numBlockers_local;
}
fn PCSSFilter(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, uv: vec2f, receiverDepth: f32, shadowSamples: i32, filterRadius: f32, randomSeed: f32) -> f32 {
	var diskData: VogelDiskData;
	prepareDiskConstants(&diskData, shadowSamples, randomSeed);
	var sum: f32 = 0.0;
	for (var i: i32 = 0; i < shadowSamples; i = i + 1) {
		let offsetUV: vec2f = generateDiskSample(&diskData) * filterRadius;
		let depth: f32 = textureSampleLevel(shadowMap, shadowMapSampler, uv + offsetUV, 0.0).r;
		sum = sum + step(receiverDepth, depth);
	}
	return sum / f32(shadowSamples);
}
fn getPenumbra(dblocker: f32, dreceiver: f32, penumbraSize: f32, penumbraFalloff: f32) -> f32 {
	let dist: f32 = dreceiver - dblocker;
	let penumbra: f32 = 1.0 - pow(1.0 - dist, penumbraFalloff);
	return penumbra * penumbraSize;
}
fn PCSSDirectional(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoords: vec3f, cameraParams: vec4f, softShadowParams: vec4f) -> f32 {
	let receiverDepth: f32 = shadowCoords.z;
	let randomSeed: f32 = fractSinRand(pcPosition.xy);
	let shadowSamples: i32 = i32(softShadowParams.x);
	let shadowBlockerSamples: i32 = i32(softShadowParams.y);
	let penumbraSize: f32 = softShadowParams.z;
	let penumbraFalloff: f32 = softShadowParams.w;
	let shadowMapSize: i32 = i32(textureDimensions(shadowMap, 0).x);
	var invShadowMapSize: f32 = 1.0 / f32(shadowMapSize);
	invShadowMapSize = invShadowMapSize * (f32(shadowMapSize) / 2048.0);
	var penumbra: f32;
	if (shadowBlockerSamples > 0) {
		var avgBlockerDepth: f32 = 0.0;
		var numBlockers: i32 = 0;
		PCSSFindBlocker(shadowMap, shadowMapSampler, &avgBlockerDepth, &numBlockers, shadowCoords.xy, receiverDepth, shadowBlockerSamples, penumbraSize, invShadowMapSize, randomSeed);
		if (numBlockers < 1) {
			return 1.0;
		}
		penumbra = getPenumbra(avgBlockerDepth, shadowCoords.z, penumbraSize, penumbraFalloff);
	} else {
		penumbra = penumbraSize;
	}
	let filterRadius: f32 = penumbra * invShadowMapSize;
	return PCSSFilter(shadowMap, shadowMapSampler, shadowCoords.xy, receiverDepth, shadowSamples, filterRadius, randomSeed);
}
fn getShadowPCSS(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, cameraParams: vec4f, softShadowParams: vec4f, lightDir: vec3f) -> f32 {
	return PCSSDirectional(shadowMap, shadowMapSampler, shadowCoord, cameraParams, softShadowParams);
}
`,skinBatchVS:`
attribute vertex_boneIndices: f32;
var texture_poseMap: texture_2d<uff>;
fn getBoneMatrix(indexFloat: f32) -> mat4x4f {
	let width = i32(textureDimensions(texture_poseMap).x);
	let index: i32 = i32(indexFloat + 0.5) * 3;
	let iy: i32 = index / width;
	let ix: i32 = index % width;
	let v1: vec4f = textureLoad(texture_poseMap, vec2i(ix + 0, iy), 0);
	let v2: vec4f = textureLoad(texture_poseMap, vec2i(ix + 1, iy), 0);
	let v3: vec4f = textureLoad(texture_poseMap, vec2i(ix + 2, iy), 0);
	return mat4x4f(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, 1.0
	);
}
`,skinVS:`
attribute vertex_boneWeights: vec4f;
attribute vertex_boneIndices: vec4f;
var texture_poseMap: texture_2d<uff>;
struct BoneMatrix {
	v1: vec4f,
	v2: vec4f,
	v3: vec4f,
}
fn getBoneMatrix(width: i32, index: i32) -> BoneMatrix {
	let v = index / width;
	let u = index % width;
	var result: BoneMatrix;
	result.v1 = textureLoad(texture_poseMap, vec2i(u + 0, v), 0);
	result.v2 = textureLoad(texture_poseMap, vec2i(u + 1, v), 0);
	result.v3 = textureLoad(texture_poseMap, vec2i(u + 2, v), 0);
	return result;
}
fn getSkinMatrix(indicesFloat: vec4f, weights: vec4f) -> mat4x4f {
	let width = i32(textureDimensions(texture_poseMap).x);
	var indices = vec4i(indicesFloat + 0.5) * 3;
	let boneA = getBoneMatrix(width, indices.x);
	let boneB = getBoneMatrix(width, indices.y);
	let boneC = getBoneMatrix(width, indices.z);
	let boneD = getBoneMatrix(width, indices.w);
	let v1 = boneA.v1 * weights.x + boneB.v1 * weights.y + boneC.v1 * weights.z + boneD.v1 * weights.w;
	let v2 = boneA.v2 * weights.x + boneB.v2 * weights.y + boneC.v2 * weights.z + boneD.v2 * weights.w;
	let v3 = boneA.v3 * weights.x + boneB.v3 * weights.y + boneC.v3 * weights.z + boneD.v3 * weights.w;
	let one = dot(weights, vec4f(1.0, 1.0, 1.0, 1.0));
	return mat4x4f(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, one
	);
}
`,skyboxPS:`
	#define LIT_SKYBOX_INTENSITY
	#include "envProcPS"
	#include "gammaPS"
	#include "tonemappingPS"
	#ifdef PREPASS_PASS
		varying vLinearDepth: f32;
		#include "floatAsUintPS"
	#endif
	varying vViewDir : vec3f;
	uniform skyboxHighlightMultiplier : f32;
	#ifdef SKY_CUBEMAP
		var texture_cubeMap : texture_cube<f32>;
		var texture_cubeMap_sampler : sampler;
		#ifdef SKYMESH
			varying vWorldPos : vec3f;
			uniform cubeMapRotationMatrix : mat3x3f;
			uniform projectedSkydomeCenter : vec3f;
		#endif
	#else
		#include "sphericalPS"
		#include "envAtlasPS"
		var texture_envAtlas : texture_2d<f32>;
		var texture_envAtlas_sampler : sampler;
		uniform mipLevel : f32;
	#endif
	@fragment
	fn fragmentMain(input : FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		#ifdef PREPASS_PASS
			output.color = float2vec4(vLinearDepth);
		#else
			var linear : vec3f;
			var dir : vec3f;
			#ifdef SKY_CUBEMAP
				#ifdef SKYMESH
					var envDir : vec3f = normalize(input.vWorldPos - uniform.projectedSkydomeCenter);
					dir = envDir * uniform.cubeMapRotationMatrix;
				#else
					dir = input.vViewDir;
				#endif
				dir.x *= -1.0;
				linear = {SKYBOX_DECODE_FNC}(textureSample(texture_cubeMap, texture_cubeMap_sampler, dir));
			#else
				dir = input.vViewDir * vec3f(-1.0, 1.0, 1.0);
				let uv : vec2f = toSphericalUv(normalize(dir));
				linear = {SKYBOX_DECODE_FNC}(textureSample(texture_envAtlas, texture_envAtlas_sampler, mapRoughnessUv(uv, uniform.mipLevel)));
			#endif
			if (any(linear >= vec3f(64.0))) {
				linear *= uniform.skyboxHighlightMultiplier;
			}
			
			output.color = vec4f(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);
		#endif
		return output;
	}
`,skyboxVS:`
	attribute aPosition : vec4f;
	uniform matrix_view : mat4x4f;
	uniform matrix_projectionSkybox : mat4x4f;
	uniform cubeMapRotationMatrix : mat3x3f;
	varying vViewDir : vec3f;
	#ifdef PREPASS_PASS
		varying vLinearDepth: f32;
	#endif
	#ifdef SKYMESH
		uniform matrix_model : mat4x4f;
		varying vWorldPos : vec3f;
	#endif
	@vertex
	fn vertexMain(input : VertexInput) -> VertexOutput {
		var output : VertexOutput;
		var view : mat4x4f = uniform.matrix_view;
		#ifdef SKYMESH
			var worldPos : vec4f = uniform.matrix_model * input.aPosition;
			output.vWorldPos = worldPos.xyz;
			output.position = uniform.matrix_projectionSkybox * (view * worldPos);
			#ifdef PREPASS_PASS
				output.vLinearDepth = -(uniform.matrix_view * vec4f(worldPos.xyz, 1.0)).z;
			#endif
		#else
			view[3][0] = 0.0;
			view[3][1] = 0.0;
			view[3][2] = 0.0;
			output.position = uniform.matrix_projectionSkybox * (view * input.aPosition);
			output.vViewDir = input.aPosition.xyz * uniform.cubeMapRotationMatrix;
			#ifdef PREPASS_PASS
				output.vLinearDepth = -pcPosition.w;
			#endif
		#endif
		output.position.z = output.position.w - 1.0e-7;
		return output;
	}
`,specularPS:`
#ifdef STD_SPECULAR_CONSTANT
	uniform material_specular: vec3f;
#endif
fn getSpecularity() {
	var specularColor = vec3f(1.0, 1.0, 1.0);
	#ifdef STD_SPECULAR_CONSTANT
	specularColor = specularColor * uniform.material_specular;
	#endif
	#ifdef STD_SPECULAR_TEXTURE
	specularColor = specularColor * {STD_SPECULAR_TEXTURE_DECODE}(textureSampleBias({STD_SPECULAR_TEXTURE_NAME}, {STD_SPECULAR_TEXTURE_NAME}Sampler, {STD_SPECULAR_TEXTURE_UV}, uniform.textureBias)).{STD_SPECULAR_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SPECULAR_VERTEX
	specularColor = specularColor * saturate3(vVertexColor.{STD_SPECULAR_VERTEX_CHANNEL});
	#endif
	dSpecularity = specularColor;
}
`,sphericalPS:`
fn toSpherical(dir: vec3f) -> vec2f {
	let angle_xz = select(0.0, atan2(dir.x, dir.z), any(dir.xz != vec2f(0.0)));
	return vec2f(angle_xz, asin(dir.y));
}
fn toSphericalUv(dir : vec3f) -> vec2f {
	const PI : f32 = 3.141592653589793;
	let uv : vec2f = toSpherical(dir) / vec2f(PI * 2.0, PI) + vec2f(0.5, 0.5);
	return vec2f(uv.x, 1.0 - uv.y);
}
`,specularityFactorPS:`
#ifdef STD_SPECULARITYFACTOR_CONSTANT
	uniform material_specularityFactor: f32;
#endif
fn getSpecularityFactor() {
	var specularityFactor = 1.0;
	#ifdef STD_SPECULARITYFACTOR_CONSTANT
	specularityFactor = specularityFactor * uniform.material_specularityFactor;
	#endif
	#ifdef STD_SPECULARITYFACTOR_TEXTURE
	specularityFactor = specularityFactor * textureSampleBias({STD_SPECULARITYFACTOR_TEXTURE_NAME}, {STD_SPECULARITYFACTOR_TEXTURE_NAME}Sampler, {STD_SPECULARITYFACTOR_TEXTURE_UV}, uniform.textureBias).{STD_SPECULARITYFACTOR_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_SPECULARITYFACTOR_VERTEX
	specularityFactor = specularityFactor * saturate(vVertexColor.{STD_SPECULARITYFACTOR_VERTEX_CHANNEL});
	#endif
	dSpecularityFactor = specularityFactor;
}
`,spotPS:`
fn getSpotEffect(lightSpotDir: vec3f, lightInnerConeAngle: f32, lightOuterConeAngle: f32, lightDirNorm: vec3f) -> f32 {
	let cosAngle: f32 = dot(lightDirNorm, lightSpotDir);
	return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);
}`,startNineSlicedPS:`
	nineSlicedUv = vec2f(vUv0.x, 1.0 - vUv0.y);
`,startNineSlicedTiledPS:`
	let tileMask: vec2f = step(vMask, vec2f(0.99999));
	let tileSize: vec2f = 0.5 * (innerOffset.xy + innerOffset.zw);
	let tileScale: vec2f = vec2f(1.0) / (vec2f(1.0) - tileSize);
	var clampedUv: vec2f = mix(innerOffset.xy * 0.5, vec2f(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));
	clampedUv = clampedUv * atlasRect.zw + atlasRect.xy;
	var nineSlicedUv: vec2f = vUv0 * tileMask + clampedUv * (vec2f(1.0) - tileMask);
	nineSlicedUv.y = 1.0 - nineSlicedUv.y;
`,stdDeclarationPS:`
	var<private> dAlpha: f32 = 1.0;
	#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE
		#ifdef STD_OPACITY_TEXTURE_ALLOCATE
			var texture_opacityMap : texture_2d<f32>;
			var texture_opacityMapSampler : sampler;
		#endif
	#endif
	#ifdef FORWARD_PASS
		var<private> dAlbedo: vec3f;
		var<private> dNormalW: vec3f;
		var<private> dSpecularity: vec3f = vec3f(0.0, 0.0, 0.0);
		var<private> dGlossiness: f32 = 0.0;
		#ifdef LIT_REFRACTION
			var<private> dTransmission: f32;
			var<private> dThickness: f32;
		#endif
		#ifdef LIT_SCENE_COLOR
			var uSceneColorMap : texture_2d<f32>;
			var uSceneColorMapSampler : sampler;
		#endif
		#ifdef LIT_SCREEN_SIZE
			uniform uScreenSize: vec4f;
		#endif
		#ifdef LIT_TRANSFORMS
			var<private> matrix_viewProjection: mat4x4f;
			var<private> matrix_model: mat4x4f;
		#endif
		#ifdef STD_HEIGHT_MAP
			var<private> dUvOffset: vec2f;
			#ifdef STD_HEIGHT_TEXTURE_ALLOCATE
				var texture_heightMap : texture_2d<f32>;
				var texture_heightMapSampler : sampler;
			#endif
		#endif
		#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE
			var texture_diffuseMap : texture_2d<f32>;
			var texture_diffuseMapSampler : sampler;
		#endif
		#ifdef STD_DIFFUSEDETAIL_TEXTURE_ALLOCATE
			var texture_diffuseDetailMap : texture_2d<f32>;
			var texture_diffuseDetailMapSampler : sampler;
		#endif
		#ifdef STD_NORMAL_TEXTURE_ALLOCATE
			var texture_normalMap : texture_2d<f32>;
			var texture_normalMapSampler : sampler;
		#endif
		#ifdef STD_NORMALDETAIL_TEXTURE_ALLOCATE
			var texture_normalDetailMap : texture_2d<f32>;
			var texture_normalDetailMapSampler : sampler;
		#endif
		#ifdef STD_THICKNESS_TEXTURE_ALLOCATE
			var texture_thicknessMap : texture_2d<f32>;
			var texture_thicknessMapSampler : sampler;
		#endif
		#ifdef STD_REFRACTION_TEXTURE_ALLOCATE
			var texture_refractionMap : texture_2d<f32>;
			var texture_refractionMapSampler : sampler;
		#endif
		#ifdef LIT_IRIDESCENCE
			var<private> dIridescence: f32;
			var<private> dIridescenceThickness: f32;
			#ifdef STD_IRIDESCENCE_THICKNESS_TEXTURE_ALLOCATE
				var texture_iridescenceThicknessMap : texture_2d<f32>;
				var texture_iridescenceThicknessMapSampler : sampler;
			#endif
			#ifdef STD_IRIDESCENCE_TEXTURE_ALLOCATE
				var texture_iridescenceMap : texture_2d<f32>;
				var texture_iridescenceMapSampler : sampler;
			#endif
		#endif
		#ifdef LIT_CLEARCOAT
			var<private> ccSpecularity: f32;
			var<private> ccGlossiness: f32;
			var<private> ccNormalW: vec3f;
		#endif
		#ifdef LIT_GGX_SPECULAR
			var<private> dAnisotropy: f32;
			var<private> dAnisotropyRotation: vec2f;
		#endif
		#ifdef LIT_SPECULAR_OR_REFLECTION
			#ifdef LIT_SHEEN
				var<private> sSpecularity: vec3f;
				var<private> sGlossiness: f32;
				#ifdef STD_SHEEN_TEXTURE_ALLOCATE
					var texture_sheenMap : texture_2d<f32>;
					var texture_sheenMapSampler : sampler;
				#endif
				#ifdef STD_SHEENGLOSS_TEXTURE_ALLOCATE
					var texture_sheenGlossMap : texture_2d<f32>;
					var texture_sheenGlossMapSampler : sampler;
				#endif
			#endif
			#ifdef LIT_METALNESS
				var<private> dMetalness: f32;
				var<private> dIor: f32;
				#ifdef STD_METALNESS_TEXTURE_ALLOCATE
					var texture_metalnessMap : texture_2d<f32>;
					var texture_metalnessMapSampler : sampler;
				#endif
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				var<private> dSpecularityFactor: f32;
				#ifdef STD_SPECULARITYFACTOR_TEXTURE_ALLOCATE
					var texture_specularityFactorMap : texture_2d<f32>;
					var texture_specularityFactorMapSampler : sampler;
				#endif
			#endif
			#ifdef STD_SPECULAR_COLOR
				#ifdef STD_SPECULAR_TEXTURE_ALLOCATE
					var texture_specularMap : texture_2d<f32>;
					var texture_specularMapSampler : sampler;
				#endif
			#endif
			#ifdef STD_GLOSS_TEXTURE_ALLOCATE
				var texture_glossMap : texture_2d<f32>;
				var texture_glossMapSampler : sampler;
			#endif
		#endif
		#ifdef STD_AO
			var <private> dAo: f32;
			#ifdef STD_AO_TEXTURE_ALLOCATE
				var texture_aoMap : texture_2d<f32>;
				var texture_aoMapSampler : sampler;
			#endif
			#ifdef STD_AODETAIL_TEXTURE_ALLOCATE
				var texture_aoDetailMap : texture_2d<f32>;
				var texture_aoDetailMapSampler : sampler;
			#endif
		#endif
		var <private> dEmission: vec3f;
		#ifdef STD_EMISSIVE_TEXTURE_ALLOCATE
			var texture_emissiveMap : texture_2d<f32>;
			var texture_emissiveMapSampler : sampler;
		#endif
		#ifdef LIT_CLEARCOAT
			#ifdef STD_CLEARCOAT_TEXTURE_ALLOCATE
				var texture_clearCoatMap : texture_2d<f32>;
				var texture_clearCoatMapSampler : sampler;
			#endif
			#ifdef STD_CLEARCOATGLOSS_TEXTURE_ALLOCATE
				var texture_clearCoatGlossMap : texture_2d<f32>;
				var texture_clearCoatGlossMapSampler : sampler;
			#endif
			#ifdef STD_CLEARCOATNORMAL_TEXTURE_ALLOCATE
				var texture_clearCoatNormalMap : texture_2d<f32>;
				var texture_clearCoatNormalMapSampler : sampler;
			#endif
		#endif
		#ifdef LIT_GGX_SPECULAR
			#ifdef STD_ANISOTROPY_TEXTURE_ALLOCATE
				var texture_anisotropyMap : texture_2d<f32>;
				var texture_anisotropyMapSampler : sampler;
			#endif
		#endif
		#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
			var<private> dLightmap: vec3f;
			#ifdef STD_LIGHT_TEXTURE_ALLOCATE
				var texture_lightMap : texture_2d<f32>;
				var texture_lightMapSampler : sampler;
			#endif
		#endif
	#endif
	#include "litShaderCorePS"
`,stdFrontEndPS:`
	#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE
		#include "opacityPS"
		#if defined(LIT_ALPHA_TEST)
			#include "alphaTestPS"
		#endif
		#if STD_OPACITY_DITHER != NONE
			#include "opacityDitherPS"
		#endif
	#endif
	#ifdef FORWARD_PASS
		#ifdef STD_HEIGHT_MAP
			#include "parallaxPS"
		#endif
		#include  "diffusePS"
		#ifdef LIT_NEEDS_NORMAL
			#include "normalMapPS"
		#endif
		#ifdef LIT_REFRACTION
			#include "transmissionPS"
			#include "thicknessPS"
		#endif
		#ifdef LIT_IRIDESCENCE
			#include "iridescencePS"
			#include "iridescenceThicknessPS"
		#endif
		#ifdef LIT_SPECULAR_OR_REFLECTION
			#ifdef LIT_SHEEN
				#include "sheenPS"
				#include "sheenGlossPS"
			#endif
			#ifdef LIT_METALNESS
				#include "metalnessPS"
				#include "iorPS"
			#endif
			#ifdef LIT_SPECULARITY_FACTOR
				#include "specularityFactorPS"
			#endif
			#ifdef STD_SPECULAR_COLOR
				#include "specularPS"
			#else
				fn getSpecularity() { 
					dSpecularity = vec3f(1.0, 1.0, 1.0);
				}
			#endif
			#include "glossPS"
		#endif
		#ifdef STD_AO
			#include "aoPS"
		#endif
		#include "emissivePS"
		#ifdef LIT_CLEARCOAT
			#include "clearCoatPS"
			#include "clearCoatGlossPS"
			#include "clearCoatNormalPS"
		#endif
		#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)
			#include "anisotropyPS"
		#endif
		#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
			#include "lightmapPS"
		#endif
	#endif
	fn evaluateFrontend() {
		#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE
			getOpacity();
			#if defined(LIT_ALPHA_TEST)
				alphaTest(dAlpha);
			#endif
			#if STD_OPACITY_DITHER != NONE
				opacityDither(dAlpha, 0.0);
			#endif
			litArgs_opacity = dAlpha;
		#endif
		#ifdef FORWARD_PASS
			#ifdef STD_HEIGHT_MAP
				getParallax();
			#endif
			getAlbedo();
			litArgs_albedo = dAlbedo;
			#ifdef LIT_NEEDS_NORMAL
				getNormal();
				litArgs_worldNormal = dNormalW;
			#endif
			#ifdef LIT_REFRACTION
				getRefraction();
				litArgs_transmission = dTransmission;
				getThickness();
				litArgs_thickness = dThickness;
				#ifdef LIT_DISPERSION
					litArgs_dispersion = uniform.material_dispersion;
				#endif
			#endif
			#ifdef LIT_IRIDESCENCE
				getIridescence();
				getIridescenceThickness();
				litArgs_iridescence_intensity = dIridescence;
				litArgs_iridescence_thickness = dIridescenceThickness;
			#endif
			#ifdef LIT_SPECULAR_OR_REFLECTION
				#ifdef LIT_SHEEN
					getSheen();
					litArgs_sheen_specularity = sSpecularity;
					getSheenGlossiness();
					litArgs_sheen_gloss = sGlossiness;
				#endif
				#ifdef LIT_METALNESS
					getMetalness();
					litArgs_metalness = dMetalness;
					getIor();
					litArgs_ior = dIor;
				#endif
				#ifdef LIT_SPECULARITY_FACTOR
					getSpecularityFactor();
					litArgs_specularityFactor = dSpecularityFactor;
				#endif
				getGlossiness();
				getSpecularity();
				litArgs_specularity = dSpecularity;
				litArgs_gloss = dGlossiness;
			#endif
			#ifdef STD_AO
				getAO();
				litArgs_ao = dAo;
			#endif
			getEmission();
			litArgs_emission = dEmission;
			#ifdef LIT_CLEARCOAT
				getClearCoat();
				getClearCoatGlossiness();
				getClearCoatNormal();
				litArgs_clearcoat_specularity = ccSpecularity;
				litArgs_clearcoat_gloss = ccGlossiness;
				litArgs_clearcoat_worldNormal = ccNormalW;
			#endif
			#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)
				getAnisotropy();
			#endif
			#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)
				getLightMap();
				litArgs_lightmap = dLightmap;
				#ifdef STD_LIGHTMAP_DIR
					litArgs_lightmapDir = dLightmapDir;
				#endif
			#endif
		#endif
	}
`,TBNPS:`
#ifdef LIT_TANGENTS
	#define TBN_TANGENTS
#else
	#if defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)
		#define TBN_DERIVATIVES
	#endif
#endif
#if defined(TBN_DERIVATIVES)
	uniform tbnBasis: f32;
#endif
fn getTBN(tangent: vec3f, binormal: vec3f, normal: vec3f) {
	#ifdef TBN_TANGENTS
		dTBN = mat3x3f(normalize(tangent), normalize(binormal), normalize(normal));
	#elif defined(TBN_DERIVATIVES)
		let uv: vec2f = {lightingUv};
		let dp1: vec3f = dpdx( vPositionW );
		let dp2: vec3f = dpdy( vPositionW );
		let duv1: vec2f = dpdx( uv );
		let duv2: vec2f = dpdy( uv );
		let dp2perp: vec3f = cross( dp2, normal );
		let dp1perp: vec3f = cross( normal, dp1 );
		let T: vec3f = dp2perp * duv1.x + dp1perp * duv2.x;
		let B: vec3f = dp2perp * duv1.y + dp1perp * duv2.y;
		let denom: f32 = max( dot(T, T), dot(B, B) );
		let invmax: f32 = select(uniform.tbnBasis / sqrt( denom ), 0.0, denom == 0.0);
		dTBN = mat3x3f(T * invmax, -B * invmax, normal );
	#else
		var B: vec3f = cross(normal, vObjectSpaceUpW);
		var T: vec3f = cross(normal, B);
		if (dot(B,B) == 0.0)
		{
			let major: f32 = max(max(normal.x, normal.y), normal.z);
			if (normal.x == major)
			{
				B = cross(normal, vec3f(0.0, 1.0, 0.0));
				T = cross(normal, B);
			}
			else if (normal.y == major)
			{
				B = cross(normal, vec3f(0.0, 0.0, 1.0));
				T = cross(normal, B);
			}
			else
			{
				B = cross(normal, vec3f(1.0, 0.0, 0.0));
				T = cross(normal, B);
			}
		}
		dTBN = mat3x3f(normalize(T), normalize(B), normalize(normal));
	#endif
}`,thicknessPS:`
#ifdef STD_THICKNESS_CONSTANT
uniform material_thickness: f32;
#endif
fn getThickness() {
	dThickness = 1.0;
	#ifdef STD_THICKNESS_CONSTANT
	dThickness = dThickness * uniform.material_thickness;
	#endif
	#ifdef STD_THICKNESS_TEXTURE
	dThickness = dThickness * textureSampleBias({STD_THICKNESS_TEXTURE_NAME}, {STD_THICKNESS_TEXTURE_NAME}Sampler, {STD_THICKNESS_TEXTURE_UV}, uniform.textureBias).{STD_THICKNESS_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_THICKNESS_VERTEX
	dThickness = dThickness * saturate(vVertexColor.{STD_THICKNESS_VERTEX_CHANNEL});
	#endif
}
`,tonemappingPS:`
#if (TONEMAP == NONE)
	#include "tonemappingNonePS"
#elif TONEMAP == FILMIC
	#include "tonemappingFilmicPS"
#elif TONEMAP == LINEAR
	#include "tonemappingLinearPS"
#elif TONEMAP == HEJL
	#include "tonemappingHejlPS"
#elif TONEMAP == ACES
	#include "tonemappingAcesPS"
#elif TONEMAP == ACES2
	#include "tonemappingAces2PS"
#elif TONEMAP == NEUTRAL
	#include "tonemappingNeutralPS"
#endif
`,tonemappingAcesPS:`
uniform exposure: f32;
fn toneMap(color: vec3f) -> vec3f {
	let tA: f32 = 2.51;
	let tB: f32 = 0.03;
	let tC: f32 = 2.43;
	let tD: f32 = 0.59;
	let tE: f32 = 0.14;
	let x: vec3f = color * uniform.exposure;
	return (x * (tA * x + tB)) / (x * (tC * x + tD) + tE);
}
`,tonemappingAces2PS:`
uniform exposure: f32;
const ACESInputMat: mat3x3f = mat3x3f(
	vec3f(0.59719, 0.35458, 0.04823),
	vec3f(0.07600, 0.90834, 0.01566),
	vec3f(0.02840, 0.13383, 0.83777)
);
const ACESOutputMat: mat3x3f = mat3x3f(
	vec3f( 1.60475, -0.53108, -0.07367),
	vec3f(-0.10208,  1.10813, -0.00605),
	vec3f(-0.00327, -0.07276,  1.07602)
);
fn RRTAndODTFit(v: vec3f) -> vec3f {
	let a: vec3f = v * (v + vec3f(0.0245786)) - vec3f(0.000090537);
	let b: vec3f = v * (vec3f(0.983729) * v + vec3f(0.4329510)) + vec3f(0.238081);
	return a / b;
}
fn toneMap(color: vec3f) -> vec3f {
	var c: vec3f = color * (uniform.exposure / 0.6);
	c = c * ACESInputMat;
	c = RRTAndODTFit(c);
	c = c * ACESOutputMat;
	return clamp(c, vec3f(0.0), vec3f(1.0));
}
`,tonemappingFilmicPS:`
const A: f32 = 0.15;
const B: f32 = 0.50;
const C: f32 = 0.10;
const D: f32 = 0.20;
const E: f32 = 0.02;
const F: f32 = 0.30;
const W: f32 = 11.2;
uniform exposure: f32;
fn uncharted2Tonemap(x: vec3f) -> vec3f {
	return ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - vec3f(E / F);
}
fn toneMap(color: vec3f) -> vec3f {
	var c: vec3f = uncharted2Tonemap(color * uniform.exposure);
	let whiteScale: vec3f = vec3f(1.0) / uncharted2Tonemap(vec3f(W, W, W));
	c *= whiteScale;
	return c;
}
`,tonemappingHejlPS:`
uniform exposure: f32;
fn toneMap(color: vec3f) -> vec3f {
	let A: f32 = 0.22;
	let B: f32 = 0.3;
	let C: f32 = 0.1;
	let D: f32 = 0.2;
	let E: f32 = 0.01;
	let F: f32 = 0.3;
	let Scl: f32 = 1.25;
	let adjusted_color = color * uniform.exposure;
	let h = max(vec3f(0.0), adjusted_color - vec3f(0.004));
	return (h * ((Scl * A) * h + Scl * vec3f(C * B)) + Scl * vec3f(D * E)) /
		   (h * (A * h + vec3f(B)) + vec3f(D * F)) -
		   Scl * vec3f(E / F);
}
`,tonemappingLinearPS:`
uniform exposure: f32;
fn toneMap(color: vec3f) -> vec3f {
	return color * uniform.exposure;
}
`,tonemappingNeutralPS:`
uniform exposure: f32;
fn toneMap(col: vec3f) -> vec3f {
	var color = col * uniform.exposure;
	let startCompression = 0.8 - 0.04;
	let desaturation = 0.15;
	let x = min(color.r, min(color.g, color.b));
	let offset = select(0.04, x - 6.25 * x * x, x < 0.08);
	color -= vec3f(offset);
	let peak = max(color.r, max(color.g, color.b));
	if (peak < startCompression) {
		return color;
	}
	let d = 1.0 - startCompression;
	let newPeak = 1.0 - d * d / (peak + d - startCompression);
	color *= newPeak / peak;
	let g = 1.0 - 1.0 / (desaturation * (peak - newPeak) + 1.0);
	return mix(color, vec3f(newPeak), vec3f(g));
}
`,tonemappingNonePS:`
fn toneMap(color: vec3f) -> vec3f {
	return color;
}
`,transformVS:`
#ifdef PIXELSNAP
	uniform uScreenSize: vec4f;
#endif
#ifdef SCREENSPACE
	uniform projectionFlipY: f32;
#endif
fn evalWorldPosition(vertexPosition: vec3f, modelMatrix: mat4x4f) -> vec4f {
	var localPos: vec3f = getLocalPosition(vertexPosition);
	#ifdef NINESLICED
		var localPosXZ: vec2f = localPos.xz;
		localPosXZ = localPosXZ * uniform.outerScale;
		let positiveUnitOffset: vec2f = clamp(vertexPosition.xz, vec2f(0.0), vec2f(1.0));
		let negativeUnitOffset: vec2f = clamp(-vertexPosition.xz, vec2f(0.0), vec2f(1.0));
		localPosXZ = localPosXZ + (-positiveUnitOffset * uniform.innerOffset.xy + negativeUnitOffset * uniform.innerOffset.zw) * vertex_texCoord0.xy;
		dTiledUvGlobal = (localPosXZ - uniform.outerScale + uniform.innerOffset.xy) * -0.5 + 1.0;
		localPosXZ = localPosXZ * -0.5;
		localPos = vec3f(localPosXZ.x, localPosXZ.y, localPos.y);
	#endif
	var posW: vec4f = modelMatrix * vec4f(localPos, 1.0);
	#ifdef SCREENSPACE
		posW = vec4f(posW.xy, 0.0, 1.0);
	#endif
	return posW;
}
fn getPosition() -> vec4f {
	dModelMatrix = getModelMatrix();
	let posW: vec4f = evalWorldPosition(vertex_position.xyz, dModelMatrix);
	dPositionW = posW.xyz;
	var screenPos: vec4f;
	#ifdef UV1LAYOUT
		screenPos = vec4f(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1.0);
		screenPos.y *= -1.0;
	#else
		#ifdef SCREENSPACE
			screenPos = posW;
			screenPos.y *= uniform.projectionFlipY;
		#else
			screenPos = uniform.matrix_viewProjection * posW;
		#endif
		#ifdef PIXELSNAP
			screenPos.xy = (screenPos.xy * 0.5) + 0.5;
			screenPos.xy *= uniforms.uScreenSize.xy;
			screenPos.xy = floor(screenPos.xy);
			screenPos.xy *= uniforms.uScreenSize.zw;
			screenPos.xy = (screenPos.xy * 2.0) - 1.0;
		#endif
	#endif
	return screenPos;
}
fn getWorldPosition() -> vec3f {
	return dPositionW;
}
`,transformCoreVS:`
	attribute vertex_position: vec4f;
	uniform matrix_viewProjection: mat4x4f;
	uniform matrix_model: mat4x4f;
	
	#ifdef MORPHING
		uniform morph_tex_params: vec2f;
		attribute morph_vertex_id: u32;
		fn getTextureMorphCoords() -> vec2i {
			var textureSize: vec2i = vec2i(uniform.morph_tex_params);
			var morphGridV: i32 = i32(morph_vertex_id) / textureSize.x;
			var morphGridU: i32 = i32(morph_vertex_id) - (morphGridV * textureSize.x);
			morphGridV = textureSize.y - morphGridV - 1;
			return vec2i(morphGridU, morphGridV);
		}
		#ifdef MORPHING_POSITION
			#ifdef MORPHING_INT
				uniform aabbSize: vec3f;
				uniform aabbMin: vec3f;
				var morphPositionTex: texture_2d<u32>;
			#else
				var morphPositionTex: texture_2d<f32>;
			#endif
		#endif
	#endif
	#ifdef defined(BATCH)
		#include "skinBatchVS"
		fn getModelMatrix() -> mat4x4f {
			return getBoneMatrix(vertex_boneIndices);
		}
	#elif defined(SKIN)
		#include "skinVS"
		fn getModelMatrix() -> mat4x4f {
			return uniform.matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);
		}
	#elif defined(INSTANCING)
		#include "transformInstancingVS"
	#else
		fn getModelMatrix() -> mat4x4f {
			return uniform.matrix_model;
		}
	#endif
	fn getLocalPosition(vertexPosition: vec3f) -> vec3f {
		var localPos: vec3f = vertexPosition;
		#ifdef MORPHING_POSITION
			var morphUV: vec2i = getTextureMorphCoords();
			#ifdef MORPHING_INT
				var morphPos: vec3f = vec3f(textureLoad(morphPositionTex, morphUV, 0).xyz) / 65535.0 * uniform.aabbSize + uniform.aabbMin;
			#else
				var morphPos: vec3f = textureLoad(morphPositionTex, morphUV, 0).xyz;
			#endif
			localPos += morphPos;
		#endif
		return localPos;
	}
`,transformInstancingVS:`
attribute instance_line1: vec4f;
attribute instance_line2: vec4f;
attribute instance_line3: vec4f;
attribute instance_line4: vec4f;
fn getModelMatrix() -> mat4x4f {
	return uniform.matrix_model * mat4x4f(instance_line1, instance_line2, instance_line3, instance_line4);
}
`,transmissionPS:`
#ifdef STD_REFRACTION_CONSTANT
	uniform material_refraction: f32;
#endif
fn getRefraction() {
	var refraction: f32 = 1.0;
	#ifdef STD_REFRACTION_CONSTANT
	refraction = uniform.material_refraction;
	#endif
	#ifdef STD_REFRACTION_TEXTURE
	refraction = refraction * textureSampleBias({STD_REFRACTION_TEXTURE_NAME}, {STD_REFRACTION_TEXTURE_NAME}Sampler, {STD_REFRACTION_TEXTURE_UV}, uniform.textureBias).{STD_REFRACTION_TEXTURE_CHANNEL};
	#endif
	#ifdef STD_REFRACTION_VERTEX
	refraction = refraction * saturate(vVertexColor.{STD_REFRACTION_VERTEX_CHANNEL});
	#endif
	dTransmission = refraction;
}
`,twoSidedLightingPS:`
uniform twoSidedLightingNegScaleFactor: f32;
fn handleTwoSidedLighting() {
	dTBN[2] = dTBN[2] * select(-uniform.twoSidedLightingNegScaleFactor, uniform.twoSidedLightingNegScaleFactor, pcFrontFacing);
}
`,uv0VS:`
#ifdef NINESLICED
	fn getUv0() -> vec2f {
		var uv = vertex_position.xz;
		let positiveUnitOffset = clamp(vertex_position.xz, vec2f(0.0, 0.0), vec2f(1.0, 1.0));
		let negativeUnitOffset = clamp(-vertex_position.xz, vec2f(0.0, 0.0), vec2f(1.0, 1.0));
		uv = uv + ((-positiveUnitOffset * uniform.innerOffset.xy) + (negativeUnitOffset * uniform.innerOffset.zw)) * vertex_texCoord0.xy;
		uv = uv * -0.5 + vec2f(0.5, 0.5);
		uv = uv * uniform.atlasRect.zw + uniform.atlasRect.xy;
		dMaskGlobal = vertex_texCoord0.xy;
		return uv;
	}
#else
	fn getUv0() -> vec2f {
		return vertex_texCoord0;
	}
#endif
`,uv1VS:`
fn getUv1() -> vec2f {
	return vertex_texCoord1;
}
`,uvTransformVS:`
output.vUV{TRANSFORM_UV_{i}}_{TRANSFORM_ID_{i}} = vec2f(
	dot(vec3f(uv{TRANSFORM_UV_{i}}, 1), uniform.{TRANSFORM_NAME_{i}}0),
	dot(vec3f(uv{TRANSFORM_UV_{i}}, 1), uniform.{TRANSFORM_NAME_{i}}1)
);
`,uvTransformUniformsPS:`
	uniform {TRANSFORM_NAME_{i}}0: vec3f;
	uniform {TRANSFORM_NAME_{i}}1: vec3f;
`,viewDirPS:`
fn getViewDir() {
	dViewDirW = normalize(uniform.view_position - vPositionW);
}
`,webgpuPS:rr,webgpuVS:ra};e.app=null;class fH extends X{init(e){let{assetPrefix:t,batchManager:i,componentSystems:s,elementInput:r,gamepads:a,graphicsDevice:n,keyboard:o,lightmapper:l,mouse:h,resourceHandlers:c,scriptsOrder:d,scriptPrefix:u,soundManager:f,touch:p,xr:m}=e;this.graphicsDevice=n,nH.get(n,tz).add(fV),nH.get(n,tV).add(fG),this._initDefaultMaterial(),this._initProgramLibrary(),this.stats=new fz(n),this._soundManager=f,this.scene=new ds(n),this._registerSceneImmediate(this.scene),this.assets=new fT(this.loader),t&&(this.assets.prefix=t),this.bundles=new fE(this.assets),this.scriptsOrder=d||[],this.defaultLayerWorld=new hd({name:"World",id:0}),this.defaultLayerDepth=new hd({name:"Depth",id:1,enabled:false,opaqueSortMode:0}),this.defaultLayerSkybox=new hd({name:"Skybox",id:2,opaqueSortMode:0}),this.defaultLayerUi=new hd({name:"UI",id:4,transparentSortMode:1}),this.defaultLayerImmediate=new hd({name:"Immediate",id:3,opaqueSortMode:0});let _=new hf("default");_.pushOpaque(this.defaultLayerWorld),_.pushOpaque(this.defaultLayerDepth),_.pushOpaque(this.defaultLayerSkybox),_.pushTransparent(this.defaultLayerWorld),_.pushOpaque(this.defaultLayerImmediate),_.pushTransparent(this.defaultLayerImmediate),_.pushTransparent(this.defaultLayerUi),this.scene.layers=_,fo.createPlaceholder(n),this.renderer=new ha(n,this.scene),l&&(this.lightmapper=new l(n,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this)),i&&(this._batcher=new i(n,this.root,this.scene),this.once("prerender",this._firstBatch,this)),this.keyboard=o||null,this.mouse=h||null,this.touch=p||null,this.gamepads=a||null,r&&(this.elementInput=r,this.elementInput.app=this),this.xr=m?new m(this):null,this.elementInput&&this.elementInput.attachSelectEvents(),this._scriptPrefix=u||"",this.enableBundles&&this.loader.addHandler("bundle",new fP(this)),c.forEach(e=>{let t=new e(this);this.loader.addHandler(t.handlerType,t);}),s.forEach(e=>{this.systems.add(new e(this));}),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),"undefined"!=typeof document&&(void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,false)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,false)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,false)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,false))),this.tick=fW(this);}static getApplication(e){return e?fH._applications[e]:r}_initDefaultMaterial(){var e;let t=new d0;t.name="Default Material",e=this.graphicsDevice,oe.get(e,()=>t);}_initProgramLibrary(){var e;let t=new ua(this.graphicsDevice,new d0);e=this.graphicsDevice,nF.get(e,()=>t);}get soundManager(){return this._soundManager}get batcher(){return this._batcher}get fillMode(){return this._fillMode}get resolutionMode(){return this._resolutionMode}configure(e,t){a$.get(e,(e,i)=>{if(e)return void t(e);let s=i.application_properties,r=i.scenes,a=i.assets;this._parseApplicationProperties(s,e=>{this._parseScenes(r),this._parseAssets(a),e?t(e):t(null);});});}preload(e){this.fire("preload:start");let t=this.assets.list({preload:true});if(0===t.length){this.fire("preload:end"),e();return}let i=0,s=()=>{i++,this.fire("preload:progress",i/t.length),i===t.length&&(this.fire("preload:end"),e());};t.forEach(e=>{e.loaded?s():(e.once("load",s),e.once("error",s),this.assets.load(e));});}_preloadScripts(e,t){t();}_parseApplicationProperties(e,t){if("number"==typeof e.maxAssetRetries&&e.maxAssetRetries>0&&this.loader.enableRetry(e.maxAssetRetries),e.useDevicePixelRatio||(e.useDevicePixelRatio=e.use_device_pixel_ratio),e.resolutionMode||(e.resolutionMode=e.resolution_mode),e.fillMode||(e.fillMode=e.fill_mode),this._width=e.width,this._height=e.height,e.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(e.resolutionMode,this._width,this._height),this.setCanvasFillMode(e.fillMode,this._width,this._height),e.layers&&e.layerOrder){let t=new hf("application"),i={};for(let t in e.layers){let s=e.layers[t];s.id=parseInt(t,10),s.enabled=1!==s.id,i[t]=new hd(s);}for(let s=0,r=e.layerOrder.length;s<r;s++){let r=e.layerOrder[s],a=i[r.layer];a&&(r.transparent?t.pushTransparent(a):t.pushOpaque(a),t.subLayerEnabled[s]=r.enabled);}this.scene.layers=t;}if(e.batchGroups){let t=this.batcher;if(t)for(let i=0,s=e.batchGroups.length;i<s;i++){let s=e.batchGroups[i];t.addGroup(s.name,s.dynamic,s.maxAabbSize,s.id,s.layers);}}e.i18nAssets&&(this.i18n.assets=e.i18nAssets),this._loadLibraries(e.libraries,t);}_loadLibraries(e,t){let i=e.length,s=i,r=/^https?:\/\//;if(i){let a=(e,i)=>{s--,e?t(e):0===s&&(this.onLibrariesLoaded(),t(null));};for(let t=0;t<i;++t){let i=e[t];!r.test(i.toLowerCase())&&this._scriptPrefix&&(i=P.join(this._scriptPrefix,i)),this.loader.load(i,"script",a);}}else this.onLibrariesLoaded(),t(null);}_parseScenes(e){if(e)for(let t=0;t<e.length;t++)this.scenes.add(e[t].name,e[t].url);}_parseAssets(e){let t=[],i={},s={};for(let s=0;s<this.scriptsOrder.length;s++){let r=this.scriptsOrder[s];e[r]&&(i[r]=true,t.push(e[r]));}if(this.enableBundles)for(let i in e)"bundle"===e[i].type&&(s[i]=true,t.push(e[i]));for(let r in e)i[r]||s[r]||t.push(e[r]);for(let e=0;e<t.length;e++){let i=t[e],s=new fy(i.name,i.type,i.file,i.data);if(s.id=parseInt(i.id,10),s.preload=!!i.preload&&i.preload,s.loaded="script"===i.type&&i.data&&i.data.loadingType>0,s.tags.add(i.tags),i.i18n)for(let e in i.i18n)s.addLocalizedAssetId(e,i.i18n[e]);this.assets.add(s);}}start(){this.frame=0,this.fire("start",{timestamp:Q(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.requestAnimationFrame();}requestAnimationFrame(){this.xr?.session?this.frameRequestId=this.xr.session.requestAnimationFrame(this.tick):this.frameRequestId=k.browser||k.worker?requestAnimationFrame(this.tick):null;}inputUpdate(e){this.controller&&this.controller.update(e),this.mouse&&this.mouse.update(),this.keyboard&&this.keyboard.update(),this.gamepads&&this.gamepads.update();}update(e){this.frame++,this.graphicsDevice.update(),this.stats.frame.scriptUpdateStart=Q(),this.systems.fire(this._inTools?"toolsUpdate":"update",e),this.stats.frame.scriptUpdate=Q()-this.stats.frame.scriptUpdateStart,this.stats.frame.animUpdateStart=Q(),this.systems.fire("animationUpdate",e),this.stats.frame.animUpdate=Q()-this.stats.frame.animUpdateStart,this.stats.frame.scriptPostUpdateStart=Q(),this.systems.fire("postUpdate",e),this.stats.frame.scriptPostUpdate=Q()-this.stats.frame.scriptPostUpdateStart,this.fire("update",e),this.inputUpdate(e);}render(){this.updateCanvasSize(),this.graphicsDevice.frameStart(),this.fire("prerender"),this.root.syncHierarchy(),this._batcher&&this._batcher.updateAll(),this.renderComposition(this.scene.layers),this.fire("postrender"),this.stats.frame.renderTime=Q()-this.stats.frame.renderStart,this.graphicsDevice.frameEnd();}renderComposition(e){this.renderer.update(e),this.renderer.buildFrameGraph(this.frameGraph,e),this.frameGraph.render(this.graphicsDevice);}_fillFrameStatsBasic(e,t,i){let s=this.stats.frame;s.dt=t,s.ms=i,e>s._timeToCountFrames?(s.fps=s._fpsAccum,s._fpsAccum=0,s._timeToCountFrames=e+1e3):s._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0,s.gsplats=this.renderer._gsplatCount;}_fillFrameStats(){let e=this.stats.frame;e.cameras=this.renderer._camerasRendered,e.materials=this.renderer._materialSwitches,e.shaders=this.graphicsDevice._shaderSwitchesPerFrame,e.shadowMapUpdates=this.renderer._shadowMapUpdates,e.shadowMapTime=this.renderer._shadowMapTime,e.depthMapTime=this.renderer._depthMapTime,e.forwardTime=this.renderer._forwardTime;let t=this.graphicsDevice._primsPerFrame;e.triangles=t[4]/3+Math.max(t[5]-2,0)+Math.max(t[6]-2,0),e.cullTime=this.renderer._cullTime,e.sortTime=this.renderer._sortTime,e.skinTime=this.renderer._skinTime,e.morphTime=this.renderer._morphTime,e.lightClusters=this.renderer._lightClusters,e.lightClustersTime=this.renderer._lightClustersTime,e.otherPrimitives=0;for(let i=0;i<t.length;i++)i<4&&(e.otherPrimitives+=t[i]),t[i]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,(e=this.stats.drawCalls).forward=this.renderer._forwardDrawCalls,e.culled=this.renderer._numDrawCallsCulled,e.depth=0,e.shadow=this.renderer._shadowDrawCalls,e.skinned=this.renderer._skinDrawCalls,e.immediate=0,e.instanced=0,e.removedByInstancing=0,e.misc=e.total-(e.forward+e.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,(e=this.stats.particles).updatesPerFrame=e._updatesPerFrame,e.frameTime=e._frameTime,e._updatesPerFrame=0,e._frameTime=0;}setCanvasFillMode(e,t,i){this._fillMode=e,this.resizeCanvas(t,i);}setCanvasResolution(e,t,i){this._resolutionMode=e,e===fe&&void 0===t&&(t=this.graphicsDevice.canvas.clientWidth,i=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(t,i);}isHidden(){return document[this._hiddenAttr]}onVisibilityChange(){this.isHidden()?this._soundManager&&this._soundManager.suspend():this._soundManager&&this._soundManager.resume();}resizeCanvas(e,t){if(!this._allowResize||this.xr&&this.xr.session)return;let i=window.innerWidth,s=window.innerHeight;if(this._fillMode===u7){let r=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;r>i/s?t=(e=i)/r:e=(t=s)*r;}else this._fillMode===u9&&(e=i,t=s);return this.graphicsDevice.canvas.style.width=`${e}px`,this.graphicsDevice.canvas.style.height=`${t}px`,this.updateCanvasSize(),{width:e,height:t}}updateCanvasSize(){if(!(!this._allowResize||this.xr?.active)&&this._resolutionMode===fe){let e=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(e.clientWidth,e.clientHeight);}}onLibrariesLoaded(){this._librariesLoaded=true,this.systems.rigidbody&&this.systems.rigidbody.onLibraryLoaded();}applySceneSettings(e){let t;if(this.systems.rigidbody&&"undefined"!=typeof Ammo){let[t,i,s]=e.physics.gravity;this.systems.rigidbody.gravity.set(t,i,s);}this.scene.applySettings(e),e.render.hasOwnProperty("skybox")&&(e.render.skybox?(t=this.assets.get(e.render.skybox))?this.setSkybox(t):this.assets.once(`add:${e.render.skybox}`,this.setSkybox,this):this.setSkybox(null));}setAreaLightLuts(e,t){e&&t&&fo.set(this.graphicsDevice,e,t);}setSkybox(e){if(e!==this._skyboxAsset){let t=()=>{this.setSkybox(null);},i=()=>{this.scene.setSkybox(this._skyboxAsset?this._skyboxAsset.resources:null);};this._skyboxAsset&&(this.assets.off(`load:${this._skyboxAsset.id}`,i,this),this.assets.off(`remove:${this._skyboxAsset.id}`,t,this),this._skyboxAsset.off("change",i,this)),this._skyboxAsset=e,this._skyboxAsset&&(this.assets.on(`load:${this._skyboxAsset.id}`,i,this),this.assets.once(`remove:${this._skyboxAsset.id}`,t,this),this._skyboxAsset.on("change",i,this),0!==this.scene.skyboxMip||this._skyboxAsset.loadFaces||(this._skyboxAsset.loadFaces=true),this.assets.load(this._skyboxAsset)),i();}}_firstBake(){this.lightmapper?.bake(null,this.scene.lightmapMode);}_firstBatch(){this.batcher?.generate();}_processTimestamp(e){return e}drawLine(e,t,i,s,r){this.scene.drawLine(e,t,i,s,r);}drawLines(e,t,i=true,s=this.scene.defaultDrawLayer){this.scene.drawLines(e,t,i,s);}drawLineArrays(e,t,i=true,s=this.scene.defaultDrawLayer){this.scene.drawLineArrays(e,t,i,s);}drawWireSphere(e,t,i=es.WHITE,s=20,r=true,a=this.scene.defaultDrawLayer){this.scene.immediate.drawWireSphere(e,t,i,s,r,a);}drawWireAlignedBox(e,t,i=es.WHITE,s=true,r=this.scene.defaultDrawLayer,a){this.scene.immediate.drawWireAlignedBox(e,t,i,s,r,a);}drawMeshInstance(e,t=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(null,null,null,e,t);}drawMesh(e,t,i,s=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(t,i,e,null,s);}drawQuad(e,t,i=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(t,e,this.scene.immediate.getQuadMesh(),null,i);}drawTexture(e,t,i,s,r,a,n=this.scene.defaultDrawLayer,o=true){if(false===o&&!this.graphicsDevice.isWebGPU)return;let l=new ey;l.setTRS(new ed(e,t,0),ex.IDENTITY,new ed(i,-s,0)),a||((a=new cf).cull=0,a.setParameter("colorMap",r),a.shaderDesc=o?this.scene.immediate.getTextureShaderDesc(r.encoding):this.scene.immediate.getUnfilterableTextureShaderDesc(),a.update()),this.drawQuad(l,a,n);}drawDepthTexture(e,t,i,s,r=this.scene.defaultDrawLayer){let a=new cf;a.cull=0,a.shaderDesc=this.scene.immediate.getDepthTextureShaderDesc(),a.update(),this.drawTexture(e,t,i,s,null,a,r);}destroy(){if(this._inFrameUpdate){this._destroyRequested=true;return}let e=this.graphicsDevice.canvas.id;this.fire("destroy",this),this.off("librariesloaded"),this._gsplatSortedEvt?.off(),this._gsplatSortedEvt=null,"undefined"!=typeof document&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler,false),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,false),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,false),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,false)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.gamepads&&(this.gamepads.destroy(),this.gamepads=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null;let t=this.loader.getHandler("script");t?.clearCache(),this.loader.destroy(),this.loader=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,this.lightmapper?.destroy(),this.lightmapper=null,this._batcher&&(this._batcher.destroy(),this._batcher=null),this._entityIndex={},this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,this.xr?.end(),this.xr?.destroy(),this.renderer.destroy(),this.renderer=null;let i=this.assets.list();for(let e=0;e<i.length;e++)i[e].unload(),i[e].off();this.assets.off(),this.scene.destroy(),this.scene=null,this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),this._soundManager?.destroy(),this._soundManager=null,fs.app=null,fH._applications[e]=null,r===this&&(r=null),fH.cancelTick(this);}static cancelTick(e){e.frameRequestId&&(cancelAnimationFrame(e.frameRequestId),e.frameRequestId=void 0);}getEntityFromIndex(e){return this._entityIndex[e]}_registerSceneImmediate(e){this.on("postrender",e.immediate.onPostRender,e.immediate),this._gsplatSortedEvt=e.on("gsplat:sorted",e=>{this.stats.frame.gsplatSort+=e;});}constructor(t){super(),this._batcher=null,this._destroyRequested=false,this._inFrameUpdate=false,this._librariesLoaded=false,this._fillMode=u7,this._resolutionMode=ft,this._allowResize=true,this._skyboxAsset=null,this._entityIndex={},this._inTools=false,this._scriptPrefix="",this._time=0,this.enableBundles="undefined"!=typeof TextDecoder,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.frameGraph=new fr,this.scriptsOrder=[],this.autoRender=true,this.renderNextFrame=false,this.lightmapper=null,this.loader=new fI(this),this.scenes=new fU(this),this.scripts=new fL(this),this.systems=new fw,this.i18n=new fR(this),this.keyboard=null,this.mouse=null,this.touch=null,this.gamepads=null,this.elementInput=null,this.xr=null,fH._applications[t.id]=this,r=this,e.app=this,this.root=new fB,this.root._enabledInHierarchy=true;}}fH._applications={};let fW=function(t){return function(i,s){if(!t.graphicsDevice)return;t.frameRequestId&&(t.xr?.session?.cancelAnimationFrame(t.frameRequestId),cancelAnimationFrame(t.frameRequestId),t.frameRequestId=null),t._inFrameUpdate=true,r=t,e.app=t;let a=t._processTimestamp(i)||Q(),n=a-(t._time||a),o=n/1e3;if(o=ei.clamp(o,0,t.maxDeltaTime)*t.timeScale,t._time=a,t.requestAnimationFrame(),t.graphicsDevice.contextLost)return;t._fillFrameStatsBasic(a,o,n),t.fire("frameupdate",n);let l=false;s?(l=!t.xr?.update(s),t.graphicsDevice.defaultFramebuffer=s.session.renderState.baseLayer.framebuffer):t.graphicsDevice.defaultFramebuffer=null,l||(t.update(o),t.fire("framerender"),(t.autoRender||t.renderNextFrame)&&(t.render(),t.renderNextFrame=false),t.fire("frameend"),t.stats.frameEnd()),t._inFrameUpdate=false,t._destroyRequested&&t.destroy();}};class fX{constructor(){this.componentSystems=[],this.resourceHandlers=[];}}let fY=new eD;class fq{store(){this.mask=this.light.mask,this.shadowUpdateMode=this.light.shadowUpdateMode,this.enabled=this.light.enabled,this.intensity=this.light.intensity,this.rotation=this.light._node.getLocalRotation().clone(),this.numCascades=this.light.numCascades,this.castShadows=this.light._castShadows;}restore(){let e=this.light;e.mask=this.mask,e.shadowUpdateMode=this.shadowUpdateMode,e.enabled=this.enabled,e.intensity=this.intensity,e._node.setLocalRotation(this.rotation),e.numCascades=this.numCascades,e._castShadows=this.castShadows;}startBake(){this.light.enabled=true,this.light._destroyShadowMap(),this.light.beginFrame();}endBake(e){let t=this.light;t.enabled=false,t.shadowMap&&(t.shadowMap.cached&&e.add(t,t.shadowMap),t.shadowMap=null);}constructor(e,t,i){this.scene=e,this.light=t,this.store(),t.numCascades=1,this.scene.clusteredLightingEnabled&&!i.shadowsEnabled&&(t.castShadows=false),0!==t.type&&(t._node.getWorldTransform(),t.getBoundingSphere(fY),this.lightBounds=new eC,this.lightBounds.center.copy(fY.center),this.lightBounds.halfExtents.set(fY.radius,fY.radius,fY.radius));}}let f$=new ef;class fj extends fq{get numVirtualLights(){return 0===this.light.type?this.light.bakeNumSamples:1}prepareVirtualLight(e,t){let i=this.light;if(i._node.setLocalRotation(this.rotation),e>0){let s=i.bakeArea;cZ.circlePointDeterministic(f$,e,t),f$.mulScalar(.5*s),i._node.rotateLocal(f$.x,0,f$.y);}i._node.getWorldTransform(),i.intensity=Math.pow(Math.pow(this.intensity,2.2)/t,.45454545454545453);}constructor(e,t){super(e.scene,t,e.lightingParams);}}let fK=new ed;class fZ extends fq{get numVirtualLights(){return this.light.bakeNumSamples}prepareVirtualLight(e,t){cZ.spherePointDeterministic(fK,e,t,0,this.scene.ambientBakeSpherePart),this.light._node.lookAt(fK.mulScalar(-1)),this.light._node.rotateLocal(90,0,0);let i=Math.pow(2*Math.PI*this.scene.ambientBakeSpherePart,2.2);this.light.intensity=Math.pow(i/t,.45454545454545453);}constructor(e){let t=e.scene,i=new fB("AmbientLight");i.addComponent("light",{type:"directional",affectDynamic:true,affectLightmapped:false,bake:true,bakeNumSamples:t.ambientBakeNumSamples,castShadows:true,normalOffsetBias:.05,shadowBias:.2,shadowDistance:1,shadowResolution:2048,shadowType:0,color:es.WHITE,intensity:1,bakeDir:false}),super(t,i.light.light,e.lightingParams);}}class fQ{store(){this.castShadows=this.component.castShadows;}restore(){this.component.castShadows=this.castShadows;}constructor(e,t=null){this.node=e,this.component=e.render||e.model,t=t||this.component.meshInstances,this.store(),this.meshInstances=t,this.bounds=null,this.renderTargets=[];}}let fJ={glslBilateralDeNoisePS:`
float normpdf3(in vec3 v, in float sigma) {
	return 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;
}
vec3 decodeRGBM(vec4 rgbm) {
	vec3 color = (8.0 * rgbm.a) * rgbm.rgb;
	return color * color;
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec4 encodeRGBM(vec3 color) {
	vec4 encoded;
	encoded.rgb = pow(color.rgb, vec3(0.5));
	encoded.rgb *= 1.0 / 8.0;
	encoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );
	encoded.a = ceil(encoded.a * 255.0) / 255.0;
	encoded.rgb /= encoded.a;
	return encoded;
}
vec3 decode(vec4 pixel) {
	#if HDR
		return pixel.rgb;
	#else
		return decodeRGBM(pixel);
	#endif
}
bool isUsed(vec4 pixel) {
	#if HDR
		return any(greaterThan(pixel.rgb, vec3(0.0)));
	#else
		return pixel.a > 0.0;
	#endif
}
varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
uniform vec2 sigmas;
uniform float bZnorm;
uniform float kernel[{MSIZE}];
void main(void) {
	
	vec4 pixel = texture2DLod(source, vUv0, 0.0);
	if (!isUsed(pixel)) {
		gl_FragColor = pixel;
		return ;
	}
	float sigma = sigmas.x;
	float bSigma = sigmas.y;
	vec3 pixelHdr = decode(pixel);
	vec3 accumulatedHdr = vec3(0.0);
	float accumulatedFactor = 0.000001;
	const int kSize = ({MSIZE} - 1) / 2;
	for (int i = -kSize; i <= kSize; ++i) {
		for (int j = -kSize; j <= kSize; ++j) {
			
			vec2 coord = vUv0 + vec2(float(i), float(j)) * pixelOffset;
			vec4 pix = texture2DLod(source, coord, 0.0);
			if (isUsed(pix)) {
				vec3 hdr = decode(pix);
				float factor = kernel[kSize + j] * kernel[kSize + i];
				factor *= normpdf3(hdr - pixelHdr, bSigma) * bZnorm;
				accumulatedHdr += factor * hdr;
				accumulatedFactor += factor;
			}
		}
	}
	vec3 finalHDR = accumulatedHdr / accumulatedFactor;
	#if HDR
		gl_FragColor = vec4(finalHDR, 1.0);
	#else
		gl_FragColor = encodeRGBM(finalHDR);
	#endif
}
`,glslDilatePS:`
varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
bool isUsed(vec4 pixel) {
	#if HDR
		return any(greaterThan(pixel.rgb, vec3(0.0)));
	#else
		return pixel.a > 0.0;
	#endif
}
void main(void) {
	vec4 c = texture2DLod(source, vUv0, 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 - pixelOffset, 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(0, -pixelOffset.y), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(-pixelOffset.x, 0), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(pixelOffset.x, 0), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(0, pixelOffset.y), 0.0);
	c = isUsed(c) ? c : texture2DLod(source, vUv0 + pixelOffset, 0.0);
	gl_FragColor = c;
}
`},f0={wgslBilateralDeNoisePS:`
fn normpdf3(v: vec3f, sigma: f32) -> f32 {
	return 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;
}
fn decodeRGBM(rgbm: vec4f) -> vec3f {
	let color = (8.0 * rgbm.a) * rgbm.rgb;
	return color * color;
}
fn saturate(x: f32) -> f32 {
	return clamp(x, 0.0, 1.0);
}
fn encodeRGBM(color: vec3f) -> vec4f {
	var encoded: vec4f;
	let rgb_processed = pow(color.rgb, vec3f(0.5)) * (1.0 / 8.0);
	encoded = vec4f(rgb_processed, 0.0);
	let max_g_b = max( encoded.g, max( encoded.b, 1.0 / 255.0 ) );
	let max_rgb = max( encoded.r, max_g_b );
	encoded.a = clamp(max_rgb, 0.0, 1.0);
	encoded.a = ceil(encoded.a * 255.0) / 255.0;
	encoded = vec4f(encoded.rgb / encoded.a, encoded.a);
	return encoded;
}
fn decode(pixel: vec4f) -> vec3f {
	#if HDR
		return pixel.rgb;
	#else
		return decodeRGBM(pixel);
	#endif
}
fn isUsed(pixel: vec4f) -> bool {
	#if HDR
		return any(pixel.rgb > vec3f(0.0));
	#else
		return pixel.a > 0.0;
	#endif
}
varying vUv0: vec2f;
var source: texture_2d<f32>;
var sourceSampler: sampler;
uniform kernel: array<f32, {MSIZE}>;
uniform pixelOffset: vec2f;
uniform sigmas: vec2f;
uniform bZnorm: f32;
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let pixel = textureSampleLevel(source, sourceSampler, input.vUv0, 0.0);
	if (!isUsed(pixel)) {
		output.color = pixel;
		return output;
	}
	let sigma = uniform.sigmas.x;
	let bSigma = uniform.sigmas.y;
	let pixelHdr = decode(pixel);
	var accumulatedHdr = vec3f(0.0);
	var accumulatedFactor = 0.000001;
	const kSize = ({MSIZE} - 1) / 2;
	for (var i: i32 = -kSize; i <= kSize; i = i + 1) {
		for (var j: i32 = -kSize; j <= kSize; j = j + 1) {
			let coord = input.vUv0 + vec2f(f32(i), f32(j)) * uniform.pixelOffset;
			let pix = textureSampleLevel(source, sourceSampler, coord, 0.0);
			if (isUsed(pix)) {
				let hdr = decode(pix);
				var factor = uniform.kernel[u32(kSize + j)].element * uniform.kernel[u32(kSize + i)].element;
				factor = factor * normpdf3(hdr - pixelHdr, bSigma) * uniform.bZnorm;
				accumulatedHdr = accumulatedHdr + factor * hdr;
				accumulatedFactor = accumulatedFactor + factor;
			}
		}
	}
	let finalHDR = accumulatedHdr / accumulatedFactor;
	#if HDR
		output.color = vec4f(finalHDR, 1.0);
	#else
		output.color = encodeRGBM(finalHDR);
	#endif
	return output;
}
`,wgslDilatePS:`
varying vUv0: vec2f;
var source: texture_2d<f32>;
var sourceSampler: sampler;
uniform pixelOffset: vec2f;
fn isUsed(pixel: vec4f) -> bool {
	#ifdef HDR
		return any(pixel.rgb > vec3f(0.0));
	#else
		return pixel.a > 0.0;
	#endif
}
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var c: vec4f = textureSampleLevel(source, sourceSampler, input.vUv0, 0.0);
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 - uniform.pixelOffset, 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(0.0, -uniform.pixelOffset.y), 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(uniform.pixelOffset.x, -uniform.pixelOffset.y), 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(-uniform.pixelOffset.x, 0.0), 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(uniform.pixelOffset.x, 0.0), 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(-uniform.pixelOffset.x, uniform.pixelOffset.y), 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(0.0, uniform.pixelOffset.y), 0.0), c, isUsed(c));
	c = select(textureSampleLevel(source, sourceSampler, input.vUv0 + uniform.pixelOffset, 0.0), c, isUsed(c));
	var output: FragmentOutput;
	output.color = c;
	return output;
}
`};class f1{setSourceTexture(e){this.constantTexSource.setValue(e);}prepare(e,t){this.pixelOffset[0]=1/e,this.pixelOffset[1]=1/t,this.constantPixelOffset.setValue(this.pixelOffset);}prepareDenoise(e,t,i){let s=+!i;if(!this.shaderDenoise[s]){let e=new Map;e.set("{MSIZE}",15),i&&e.set("HDR",""),this.shaderDenoise[s]=nY.createShader(this.device,{uniqueName:`lmBilateralDeNoise-${i?"hdr":"rgbm"}`,attributes:{vertex_position:e6},vertexGLSL:nH.get(this.device,tz).get("fullscreenQuadVS"),vertexWGSL:nH.get(this.device,tV).get("fullscreenQuadVS"),fragmentGLSL:nH.get(this.device,tz).get("glslBilateralDeNoisePS"),fragmentWGSL:nH.get(this.device,tV).get("wgslBilateralDeNoisePS"),fragmentDefines:e}),this.sigmas=new Float32Array(2),this.constantSigmas=this.device.scope.resolve("sigmas"),this.constantKernel=this.device.scope.resolve("kernel[0]"),this.bZnorm=this.device.scope.resolve("bZnorm");}this.sigmas[0]=e,this.sigmas[1]=t,this.constantSigmas.setValue(this.sigmas),this.evaluateDenoiseUniforms(e,t);}getDenoise(e){return this.shaderDenoise[+!e]}getDilate(e,t){let i=+!t;if(!this.shaderDilate[i]){let s=t?"#define HDR\n":"";this.shaderDilate[i]=nY.createShader(e,{uniqueName:`lmDilate-${t?"hdr":"rgbm"}`,attributes:{vertex_position:e6},vertexGLSL:nH.get(this.device,tz).get("fullscreenQuadVS"),vertexWGSL:nH.get(this.device,tV).get("fullscreenQuadVS"),fragmentGLSL:s+nH.get(this.device,tz).get("glslDilatePS"),fragmentWGSL:s+nH.get(this.device,tV).get("wgslDilatePS")});}return this.shaderDilate[i]}evaluateDenoiseUniforms(e,t){function i(e,t){return .39894*Math.exp(-0.5*e*e/(t*t))/t}this.kernel=this.kernel||new Float32Array(15);let s=this.kernel,r=Math.floor(7);for(let t=0;t<=r;++t){let a=i(t,e);s[r+t]=a,s[r-t]=a;}this.constantKernel.setValue(this.kernel);let a=1/i(0,t);this.bZnorm.setValue(a);}constructor(e){this.shaderDilate=[],this.shaderDenoise=[],this.device=e,nH.get(this.device,tz).add(fJ),nH.get(this.device,tV).add(f0),this.constantTexSource=e.scope.resolve("source"),this.constantPixelOffset=e.scope.resolve("pixelOffset"),this.pixelOffset=new Float32Array(2),this.sigmas=null,this.constantSigmas=null,this.kernel=null;}}class f2 extends as{destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy();}),this.viewBindGroups.length=0;}execute(){let e=this.device,{renderer:t,camera:i,receivers:s,renderTarget:r,worldClusters:a,lightArray:n}=this;e.supportsUniformBuffers&&!t.viewUniformFormat&&t.initViewBindGroupFormat(t.scene.clusteredLightingEnabled),t.renderForwardLayer(i,r,null,void 0,0,this.viewBindGroups,{meshInstances:s,splitLights:n,lightClusters:a});}constructor(e,t,i,s,r,a){super(e),this.viewBindGroups=[],this.renderer=t,this.camera=i,this.worldClusters=s,this.receivers=r,this.lightArray=a;}}let f3=new ed;class f4{destroy(){oi.decRef(this.blackTex),this.blackTex=null,oi.destroy(),this.device=null,this.root=null,this.scene=null,this.renderer=null,this.assets=null,this.camera?.destroy(),this.camera=null;}initBake(e){if(this.bakeHDR=7!==this.scene.lightmapPixelFormat,!this._initCalled){this._initCalled=true,this.lightmapFilters=new f1(e),this.constantBakeDir=e.scope.resolve("bakeDir"),this.materials=[],this.blackTex=new ih(this.device,{width:4,height:4,format:7,type:tI,name:"lightmapBlack"}),oi.incRef(this.blackTex);let t=new oP;t.clearColor.set(0,0,0,0),t.clearColorBuffer=true,t.clearDepthBuffer=false,t.clearStencilBuffer=false,t.frustumCulling=false,t.projection=1,t.aspectRatio=1,t.node=new oX,this.camera=t,this.camera.shaderParams.gammaCorrection=0,this.camera.shaderParams.toneMapping=0;}if(this.scene.clusteredLightingEnabled){let t=new hw(e.supportsAreaLights,e.maxTextureSize,()=>{});this.lightingParams=t;let i=this.scene.lighting;t.shadowsEnabled=i.shadowsEnabled,t.shadowAtlasResolution=i.shadowAtlasResolution,t.cookiesEnabled=i.cookiesEnabled,t.cookieAtlasResolution=i.cookieAtlasResolution,t.areaLightsEnabled=i.areaLightsEnabled,t.cells=new ed(3,3,3),t.maxLightsPerCell=4,this.worldClusters=new o7(e),this.worldClusters.name="ClusterLightmapper",this.shadowLocalClusteredPass=new lk(e,this.renderer.shadowRenderer,this.renderer._shadowRendererLocal);}}finishBake(e){function t(e){oi.decRef(e.colorBuffer),e.destroy();}this.materials=[],this.renderTargets.forEach(e=>{t(e);}),this.renderTargets.clear(),e.forEach(e=>{e.renderTargets.forEach(e=>{t(e);}),e.renderTargets.length=0;}),this.ambientAOMaterial=null,this.worldClusters&&(this.worldClusters.destroy(),this.worldClusters=null);}createMaterialForPass(e,t,i){let s=new d0;return s.name=`lmMaterial-pass:${t}-ambient:${i}`,s.setDefine("UV1LAYOUT",""),s.setDefine("LIT_LIGHTMAP_BAKING",""),0===t?(s.setDefine("LIT_LIGHTMAP_BAKING_COLOR",""),i?s.setDefine("LIT_LIGHTMAP_BAKING_ADD_AMBIENT",""):s.ambient=new es(0,0,0),this.bakeHDR||s.setDefine("LIGHTMAP_RGBM",""),s.lightMap=this.blackTex):(s.setDefine("LIT_LIGHTMAP_BAKING_DIR",""),s.setDefine("STD_LIGHTMAP_DIR","")),s.cull=0,s.forceUv1=true,s.update(),s}createMaterials(e,t,i){for(let e=0;e<i;e++)this.passMaterials[e]||(this.passMaterials[e]=this.createMaterialForPass(t,e,false));this.ambientAOMaterial||(this.ambientAOMaterial=this.createMaterialForPass(t,0,true),this.ambientAOMaterial.onUpdateShader=function(e){return e.litOptions.lightMapWithoutAmbient=true,e.litOptions.separateAmbient=true,e});}createTexture(e,t){return new ih(this.device,{width:e,height:e,format:this.scene.lightmapPixelFormat,mipmaps:false,type:this.bakeHDR?tP:tI,minFilter:0,magFilter:0,addressU:1,addressV:1,name:t})}collectModels(e,t,i){let s;if(e.enabled){if(e.model?.model&&e.model?.enabled&&(i&&i.push(new fQ(e)),e.model.lightmapped&&t&&(s=e.model.model.meshInstances)),e.render?.enabled&&(i&&i.push(new fQ(e)),e.render.lightmapped&&t&&(s=e.render.meshInstances)),s){let i=true;for(let e=0;e<s.length;e++)if(!s[e].mesh.vertexBuffer.format.hasUv1){i=false;break}if(i){let i=[];for(let r=0;r<s.length;r++){let a=s[r].mesh;this._tempSet.has(a)?t.push(new fQ(e,[s[r]])):i.push(s[r]),this._tempSet.add(a);}this._tempSet.clear(),i.length>0&&t.push(new fQ(e,i));}}for(let s=0;s<e._children.length;s++)this.collectModels(e._children[s],t,i);}}prepareShadowCasters(e){let t=[];for(let i=0;i<e.length;i++){let s=e[i].component;if(s.castShadows=s.castShadowsLightmap,s.castShadowsLightmap){let s=e[i].meshInstances;for(let e=0;e<s.length;e++)s[e].visibleThisFrame=true,t.push(s[e]);}}return t}updateTransforms(e){for(let t=0;t<e.length;t++){let i=e[t].meshInstances;for(let e=0;e<i.length;e++)i[e].node.getWorldTransform();}}calculateLightmapSize(e){let t,i,s,r=this.scene.lightmapSizeMultiplier||16;e.model?(s=e.model.lightmapSizeMultiplier,e.model.asset?(t=this.assets.get(e.model.asset).data).area&&(i=t.area):e.model._area&&(t=e.model)._area&&(i=t._area)):e.render&&(s=e.render.lightmapSizeMultiplier,"asset"!==e.render.type&&e.render._area&&(t=e.render)._area&&(i=t._area));let a={x:1,y:1,z:1,uv:1};i&&(a.x=i.x,a.y=i.y,a.z=i.z,a.uv=i.uv);let n=s||1;a.x*=n,a.y*=n,a.z*=n;let o=e.render||e.model,l=this.computeNodeBounds(o.meshInstances);f3.copy(l.halfExtents);let h=a.x*f3.y*f3.z+a.y*f3.x*f3.z+a.z*f3.x*f3.y;return h/=a.uv,h=Math.sqrt(h),Math.min(ei.nextPowerOfTwo(h*r),this.scene.lightmapMaxResolution||2048)}setLightmapping(e,t,i,s){for(let r=0;r<e.length;r++){let a=e[r],n=a.meshInstances;for(let e=0;e<n.length;e++){let r=n[e];if(r.setLightmapped(t),t){s&&(r._shaderDefs|=s),r.mask=2;for(let e=0;e<i;e++){let t=a.renderTargets[e].colorBuffer;t.minFilter=1,t.magFilter=1,r.setRealtimeLightmap(od.lightmapParamNames[e],t);}}}}}bake(e,t=1){let i=this.device,s=Q();this.scene._updateSkyMesh(),this.stats.renderPasses=0,this.stats.shadowMapTime=0,this.stats.forwardTime=0;let r=i._shaderStats.linked,a=i._renderTargetCreationTime,n=i._shaderStats.compileTime,o=[],l=[];if(e){for(let t=0;t<e.length;t++)this.collectModels(e[t],o,null);this.collectModels(this.root,null,l);}else this.collectModels(this.root,o,l);if(o.length>0){this.renderer.shadowRenderer.frameUpdate();let e=1===t?2:1;this.setLightmapping(o,false,e),this.initBake(i),this.bakeInternal(e,o,l);let s=64;1===t&&(s|=128),this.scene.ambientBake&&(s|=4096),this.setLightmapping(o,true,e,s),this.finishBake(o);}let h=Q();this.stats.totalRenderTime=h-s,this.stats.shadersLinked=i._shaderStats.linked-r,this.stats.compileTime=i._shaderStats.compileTime-n,this.stats.fboTime=i._renderTargetCreationTime-a,this.stats.lightmapCount=o.length;}allocateTextures(e,t){for(let i=0;i<e.length;i++){let s=e[i],r=this.calculateLightmapSize(s.node);for(let e=0;e<t;e++){let t=this.createTexture(r,`lightmapper_lightmap_${i}`);oi.incRef(t),s.renderTargets[e]=new iU({colorBuffer:t,depth:false});}if(!this.renderTargets.has(r)){let e=this.createTexture(r,`lightmapper_temp_lightmap_${r}`);oi.incRef(e),this.renderTargets.set(r,new iU({colorBuffer:e,depth:false}));}}}prepareLightsToBake(e,t){if(this.scene.ambientBake){let e=new fZ(this);t.push(e);}let i=this.renderer.lights;for(let s=0;s<i.length;s++){let r=i[s],a=new fj(this,r);e.push(a),r.enabled&&(4&r.mask)!=0&&(r.mask=7,r.shadowUpdateMode=0===r.type?2:1,t.push(a));}t.sort();}restoreLights(e){for(let t=0;t<e.length;t++)e[t].restore();}setupScene(){this.ambientLight.copy(this.scene.ambientLight),this.scene.ambientBake||this.scene.ambientLight.set(0,0,0),this.renderer.setSceneConstants(),this.device.scope.resolve("ambientBakeOcclusionContrast").setValue(this.scene.ambientBakeOcclusionContrast),this.device.scope.resolve("ambientBakeOcclusionBrightness").setValue(this.scene.ambientBakeOcclusionBrightness);}restoreScene(){this.scene.ambientLight.copy(this.ambientLight);}computeNodeBounds(e){let t=new eC;if(e.length>0){t.copy(e[0].aabb);for(let i=1;i<e.length;i++)t.add(e[i].aabb);}return t}computeNodesBounds(e){for(let t=0;t<e.length;t++){let i=e[t].meshInstances;e[t].bounds=this.computeNodeBounds(i);}}computeBounds(e){let t=new eC;for(let i=0;i<e.length;i++){t.copy(e[0].aabb);for(let i=1;i<e.length;i++)t.add(e[i].aabb);}return t}backupMaterials(e){for(let t=0;t<e.length;t++)this.materials[t]=e[t].material;}restoreMaterials(e){for(let t=0;t<e.length;t++)e[t].material=this.materials[t];}lightCameraPrepare(e,t){let i,s=t.light;return 2===s.type&&((i=s.getRenderData(null,0).shadowCamera)._node.setPosition(s._node.getPosition()),i._node.setRotation(s._node.getRotation()),i._node.rotateLocal(-90,0,0),i.projection=0,i.nearClip=s.attenuationEnd/1e3,i.farClip=s.attenuationEnd,i.aspectRatio=1,i.fov=2*s._outerConeAngle,this.renderer.updateCameraFrustum(i)),i}lightCameraPrepareAndCull(e,t,i,s){let r=e.light,a=true;if(0===r.type){f3.copy(s.center),f3.y+=s.halfExtents.y,this.camera.node.setPosition(f3),this.camera.node.setEulerAngles(-90,0,0),this.camera.nearClip=0,this.camera.farClip=2*s.halfExtents.y;let e=Math.max(s.halfExtents.x,s.halfExtents.z);this.camera.orthoHeight=e;}else e.lightBounds.intersects(t.bounds)||(a=false);if(2===r.type){let e=false,s=t.meshInstances;for(let t=0;t<s.length;t++)if(s[t]._isVisible(i)){e=true;break}e||(a=false);}return a}setupLightArray(e,t){e[0].length=0,e[1].length=0,e[2].length=0,e[t.type][0]=t,t.visibleThisFrame=true;}renderShadowMap(e,t,i,s){let r=s.light,a=this.scene.clusteredLightingEnabled,n=r.castShadows&&(!a||this.scene.lighting.shadowsEnabled);if(!t&&n)if(r.shadowMap||a||(r.shadowMap=this.shadowMapCache.get(this.device,r)),0===r.type){this.renderer._shadowRendererDirectional.cull(r,e,this.camera,i);let t=this.renderer._shadowRendererDirectional.getLightRenderPass(r,this.camera);t?.render();}else if(this.renderer._shadowRendererLocal.cull(r,e,i),a)this.shadowLocalClusteredPass.update([r]),this.shadowLocalClusteredPass.enabled&&this.shadowLocalClusteredPass.render();else {let e=r.numShadowFaces,t=2===r._type;for(let i=0;i<e;i++)new lg(this.device,this.renderer.shadowRenderer,r,i,t).render();}return  true}postprocessTextures(e,t,i){let s,r=this.lightmapFilters.getDilate(e,this.bakeHDR),a=this.scene.lightmapFilterEnabled;a&&(this.lightmapFilters.prepareDenoise(this.scene.lightmapFilterRange,this.scene.lightmapFilterSmoothness,this.bakeHDR),s=this.lightmapFilters.getDenoise(this.bakeHDR)),e.setBlendState(iS.NOBLEND),e.setDepthState(ix.NODEPTH),e.setStencilState(null,null);for(let n=0;n<t.length;n++){let o=t[n];for(let t=0;t<i;t++){let i=o.renderTargets[t],n=i.colorBuffer,l=this.renderTargets.get(n.width),h=l.colorBuffer;this.lightmapFilters.prepare(n.width,n.height);for(let o=0;o<1;o++)this.lightmapFilters.setSourceTexture(n),n0(e,l,a&&0===t&&0===o?s:r),this.lightmapFilters.setSourceTexture(h),n0(e,i,r);}}}bakeInternal(e,t,i){let s,r,a,n,o,l,h=this.scene,c=h.layers,d=this.device,u=h.clusteredLightingEnabled;this.createMaterials(d,h,e),this.setupScene(),c._update(),this.computeNodesBounds(t),this.allocateTextures(t,e),this.renderer.collectLights(c);let f=[],p=[];this.prepareLightsToBake(f,p),this.updateTransforms(i);let m=this.prepareShadowCasters(i);this.renderer.updateCpuSkinMatrices(m),this.renderer.gpuUpdate(m);let _=this.computeBounds(m);for(s=0;s<t.length;s++)for(r=0,a=t[s].meshInstances;r<a.length;r++)(n=a[r]).setLightmapped(false),n.mask=4,n.setRealtimeLightmap(od.lightmapParamNames[0],this.blackTex),n.setRealtimeLightmap(od.lightmapParamNames[1],this.blackTex);for(r=0;r<p.length;r++)p[r].light.enabled=false;let g=[[],[],[]],v=false;for(s=0;s<p.length;s++){let i=p[s],f=i instanceof fZ,S=0===i.light.type,y=i.numVirtualLights;e>1&&y>1&&i.light.bakeDir&&(y=1);for(let s=0;s<y;s++){y>1&&i.prepareVirtualLight(s,y),i.startBake();let p=false,x=this.lightCameraPrepare(d,i);for(l=0;l<t.length;l++){let T=t[l];if(a=T.meshInstances,!this.lightCameraPrepareAndCull(i,T,x,_))continue;this.setupLightArray(g,i.light);let E=S?[]:[i.light];for(u&&this.renderer.lightTextureAtlas.update(E,this.lightingParams),p=this.renderShadowMap(c,p,m,i),u&&this.worldClusters.update(E,this.lightingParams),this.backupMaterials(a),o=0;o<e&&(!(o>0)||!(s>0))&&(!f||!(o>0));o++){let e=T.renderTargets[o],t=T.renderTargets[o].colorBuffer.width,l=this.renderTargets.get(t),c=l.colorBuffer;0===o?v=h.updateShaders:v&&(h.updateShaders=true);let p=this.passMaterials[o];for(f&&s+1===y&&0===o&&(p=this.ambientAOMaterial),r=0;r<a.length;r++)a[r].material=p;this.renderer.updateShaders(a),1===o&&this.constantBakeDir.setValue(+!!i.light.bakeDir);let m=new f2(d,this.renderer,this.camera,u?this.worldClusters:null,a,g);for(m.init(l),m.colorOps.clear=true,m.colorOps.clearValue.copy(this.camera.clearColor),m.render(),m.destroy(),T.renderTargets[o]=l,this.renderTargets.set(t,e),r=0;r<a.length;r++)(n=a[r]).setRealtimeLightmap(od.lightmapParamNames[o],c),n._shaderDefs|=64;}this.restoreMaterials(a);}i.endBake(this.shadowMapCache);}}for(this.postprocessTextures(d,t,e),l=0;l<i.length;l++)i[l].restore();this.restoreLights(f),this.restoreScene(),u||this.shadowMapCache.clear();}constructor(e,t,i,s,r){this.device=e,this.root=t,this.scene=i,this.renderer=s,this.assets=r,this.shadowMapCache=s.shadowMapCache,this._tempSet=new Set,this._initCalled=false,this.passMaterials=[],this.ambientAOMaterial=null,this.fog="",this.ambientLight=new es,this.renderTargets=new Map,this.stats={renderPasses:0,lightmapCount:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0};}}class f5 extends X{static _buildAccessors(e,t){t.forEach(t=>{let i="object"==typeof t?t.name:t;Object.defineProperty(e,i,{get:function(){return this.data[i]},set:function(e){let t=this.data,s=t[i];t[i]=e,this.fire("set",i,s,e);},configurable:true});}),e._accessorsBuilt=true;}buildAccessors(e){f5._buildAccessors(this,e);}onSetEnabled(e,t,i){t!==i&&this.entity.enabled&&(i?this.onEnable():this.onDisable());}onEnable(){}onDisable(){}onPostStateChange(){}get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){}get enabled(){return  true}constructor(e,t){super(),this.system=e,this.entity=t,this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",function(e,t,i){this.fire(`set_${e}`,e,t,i);}),this.on("set_enabled",this.onSetEnabled,this);}}f5.order=0;class f8 extends X{addComponent(e,t={}){let i=new this.ComponentType(this,e),s=new this.DataType;return this.store[e.getGuid()]={entity:e,data:s},e[this.id]=i,e.c[this.id]=i,this.initializeComponentData(i,t,[]),this.fire("add",e,i),i}removeComponent(e){let t=this.id,i=this.store[e.getGuid()],s=e.c[t];s.fire("beforeremove"),this.fire("beforeremove",e,s),delete this.store[e.getGuid()],e[t]=void 0,delete e.c[t],this.fire("remove",e,i.data);}cloneComponent(e,t){let i=this.store[e.getGuid()];return this.addComponent(t,i.data)}initializeComponentData(e,t={},i){for(let s=0,r=i.length;s<r;s++){let r,a,n=i[s];"object"==typeof n?(r=n.name,a=n.type):(r=n,a=void 0);let o=t[r];void 0!==o?(void 0!==a&&(o=function(e,t){if(!e)return e;switch(t){case "rgb":if(e instanceof es)return e.clone();return new es(e[0],e[1],e[2]);case "rgba":if(e instanceof es)return e.clone();return new es(e[0],e[1],e[2],e[3]);case "vec2":if(e instanceof ef)return e.clone();return new ef(e[0],e[1]);case "vec3":if(e instanceof ed)return e.clone();return new ed(e[0],e[1],e[2]);case "vec4":if(e instanceof ep)return e.clone();return new ep(e[0],e[1],e[2],e[3]);case "boolean":case "number":case "string":case "entity":return e;default:throw Error(`Could not convert unhandled type: ${t}`)}}(o,a)),e[r]=o):e[r]=e.data[r];}e.enabled&&e.entity.enabled&&e.onEnable();}getPropertiesOfType(e){let t=[];return (this.schema||[]).forEach(i=>{i&&"object"==typeof i&&i.type===e&&t.push(i);}),t}destroy(){this.off();}constructor(e){super(),this.app=e,this.store={},this.schema=[];}}class f6{update(e,t){if(e<this._left||e>=this._right){let i=t.length;if(i)if(e<t[0])this._left=-1/0,this._right=t[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(e>=t[i-1])this._left=t[i-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=i-1;else {let i=this._findKey(e,t);this._left=t[i],this._right=t[i+1],this._len=this._right-this._left;let s=1/this._len;this._recip=isFinite(s)?s:0,this._p0=i,this._p1=i+1;}else this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0;}this._t=0===this._recip?0:(e-this._left)*this._recip,this._hermite.valid=false;}_findKey(e,t){let i=0;for(;e>=t[i+1];)i++;return i}eval(e,t,i){let s=i._data,r=i._components,a=this._p0*r;if(0===t)for(let t=0;t<r;++t)e[t]=s[a+t];else {let i=this._t,n=this._p1*r;switch(t){case 1:for(let t=0;t<r;++t)e[t]=ei.lerp(s[a+t],s[n+t],i);break;case 2:{let t=this._hermite;if(!t.valid){let e=i*i,s=i+i,r=1-i,a=r*r;t.valid=true,t.p0=(1+s)*a,t.m0=i*a,t.p1=e*(3-s),t.m1=e*(i-1);}let a=(3*this._p0+1)*r,n=(3*this._p0+2)*r,o=(3*this._p1+1)*r,l=(3*this._p1+0)*r;for(let i=0;i<r;++i)e[i]=t.p0*s[a+i]+t.m0*s[n+i]*this._len+t.p1*s[o+i]+t.m1*s[l+i]*this._len;}}}}constructor(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:false,p0:0,m0:0,p1:0,m1:0};}}class f9{constructor(e){this._name=`${e.name}Snapshot`,this._time=-1,this._cache=[],this._results=[];for(let t=0;t<e._inputs.length;++t)this._cache[t]=new f6;let t=e._curves,i=e._outputs;for(let e=0;e<t.length;++e){let s=i[t[e]._output],r=[];for(let e=0;e<s._components;++e)r[e]=0;this._results[e]=r;}}}class f7{set name(e){this._name=e;}get name(){return this._name}set track(e){this._track=e,this._snapshot=new f9(e);}get track(){return this._track}get snapshot(){return this._snapshot}set time(e){this._time=e,this.alignCursorToCurrentTime();}get time(){return this._time}set speed(e){let t=Math.sign(e)!==Math.sign(this._speed);this._speed=e,t&&this.alignCursorToCurrentTime();}get speed(){return this._speed}set loop(e){this._loop=e;}get loop(){return this._loop}set blendWeight(e){this._blendWeight=e;}get blendWeight(){return this._blendWeight}set blendOrder(e){this._blendOrder=e;}get blendOrder(){return this._blendOrder}set eventCursor(e){this._eventCursor=e;}get eventCursor(){return this._eventCursor}get eventCursorEnd(){return this.isReverse?0:this._track.events.length-1}get nextEvent(){return this._track.events[this._eventCursor]}get isReverse(){return this._speed<0}nextEventAheadOfTime(e){return !!this.nextEvent&&(this.isReverse?this.nextEvent.time<=e:this.nextEvent.time>=e)}nextEventBehindTime(e){return !!this.nextEvent&&(e===this.track.duration?this.isReverse?this.nextEvent.time>=e:this.nextEvent.time<=e:this.isReverse?this.nextEvent.time>e:this.nextEvent.time<e)}resetEventCursor(){this._eventCursor=this.isReverse?this._track.events.length-1:0;}moveEventCursor(){this._eventCursor+=this.isReverse?-1:1,this._eventCursor>=this.track.events.length?this._eventCursor=0:this._eventCursor<0&&(this._eventCursor=this.track.events.length-1);}clipFrameTime(e){let t=f7.eventFrame;t.start=0,t.end=e,t.residual=0,this.isReverse?e<0&&(t.start=this.track.duration,t.end=0,t.residual=e+this.track.duration):e>this.track.duration&&(t.start=0,t.end=this.track.duration,t.residual=e-this.track.duration);}alignCursorToCurrentTime(){for(this.resetEventCursor();this.nextEventBehindTime(this._time)&&this._eventCursor!==this.eventCursorEnd;)this.moveEventCursor();}fireNextEvent(){this._eventHandler.fire(this.nextEvent.name,{track:this.track,...this.nextEvent}),this.moveEventCursor();}fireNextEventInFrame(e,t){return !!(this.nextEventAheadOfTime(e)&&this.nextEventBehindTime(t))&&(this.fireNextEvent(),true)}activeEventsForFrame(e,t){let i=f7.eventFrame;this.clipFrameTime(t);let s=this.eventCursor;for(;this.fireNextEventInFrame(e,i.end)&&s!==this.eventCursor;);this.loop&&Math.abs(i.residual)>0&&this.activeEventsForFrame(i.start,i.residual);}progressForTime(e){return e*this._speed/this._track.duration}_update(e){if(this._playing){let t=this._time,i=this._track.duration,s=this._speed,r=this._loop;this._track.events.length>0&&i>0&&this.activeEventsForFrame(t,t+s*e),t+=s*e,s>=0?t>i&&(r?t=t%i||0:(t=this._track.duration,this.pause())):t<0&&(r?t=i+(t%i||0):(t=0,this.pause())),this._time=t;}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot);}play(){this._playing=true,this._time=0;}stop(){this._playing=false,this._time=0;}pause(){this._playing=false;}resume(){this._playing=true;}reset(){this._time=0;}constructor(e,t,i,s,r,a){this._name=e.name,this._track=e,this._snapshot=new f9(e),this._playing=s,this._time=t,this._speed=i,this._loop=r,this._blendWeight=1,this._blendOrder=0,this._eventHandler=a,this.alignCursorToCurrentTime();}}f7.eventFrame={start:0,end:0,residual:0};let pe="NONE",pt="PREV_STATE",pi="NEXT_STATE",ps="PREV_STATE_NEXT_STATE",pr="NEXT_STATE_PREV_STATE",pa="GREATER_THAN",pn="LESS_THAN",po="GREATER_THAN_EQUAL_TO",pl="LESS_THAN_EQUAL_TO",ph="EQUAL_TO",pc="NOT_EQUAL_TO",pd="INTEGER",pu="FLOAT",pf="BOOLEAN",pp="TRIGGER",pm="2D_DIRECTIONAL",p_="2D_CARTESIAN",pg="DIRECT",pv="START",pS=[pv,"END","ANY"],py="OVERWRITE",px="ADDITIVE";class pT{static dot(e,t){let i=e.length,s=0;for(let r=0;r<i;++r)s+=e[r]*t[r];return s}static normalize(e){let t=pT.dot(e,e);if(t>0){t=1/Math.sqrt(t);let i=e.length;for(let s=0;s<i;++s)e[s]*=t;}}static set(e,t,i){let s=e.length;if("quaternion"===i){let i=pT.dot(t,t);i>0&&(i=1/Math.sqrt(i));for(let r=0;r<s;++r)e[r]=t[r]*i;}else for(let i=0;i<s;++i)e[i]=t[i];}static blendVec(e,t,i,s){let r=s?1:1-i,a=e.length;for(let s=0;s<a;++s)e[s]=e[s]*r+t[s]*i;}static blendQuat(e,t,i,s){let r=e.length,a=s?1:1-i;0>pT.dot(e,t)&&(i=-i);for(let s=0;s<r;++s)e[s]=e[s]*a+t[s]*i;s||pT.normalize(e);}static blend(e,t,i,s,r){"quaternion"===s?pT.blendQuat(e,t,i,r):pT.blendVec(e,t,i,r);}static stableSort(e,t){let i=e.length;for(let s=0;s<i-1;++s)for(let r=s+1;r<i;++r)if(t(e[r],e[s])){let t=e[s];e[s]=e[r],e[r]=t;}}}class pE{get _normalizeWeights(){return this._component.normalizeWeights}getWeight(e){return (this.dirty&&this.updateWeights(),this._normalizeWeights&&0===this.totalWeight||!this.mask[e])?0:this._normalizeWeights?this.weights[e]/this.totalWeight:ei.clamp(this.weights[e],0,1)}_layerBlendType(e){return this._component.layers[e].blendType}setMask(e,t){this.mask[e]=t,this._normalizeWeights&&(this._component.layers[e].blendType===py&&(this.mask=this.mask.fill(0,0,e)),this.dirty=true);}updateWeights(){this.totalWeight=0;for(let e=0;e<this.weights.length;e++)this.weights[e]=this._component.layers[e].weight,this.totalWeight+=this.mask[e]*this.weights[e];this.dirty=false;}updateValue(e,t){if(0===this.counter&&(pT.set(this.value,pE.IDENTITY_QUAT_ARR,this.valueType),this._normalizeWeights||pT.blend(this.value,this.baseValue,1,this.valueType)),this.mask[e]&&0!==this.getWeight(e)){if(this._layerBlendType(e)!==px||this._normalizeWeights)pT.blend(this.value,t,this.getWeight(e),this.valueType);else if(this.valueType===pE.TYPE_QUAT){let i=pE.q1.set(this.value[0],this.value[1],this.value[2],this.value[3]),s=pE.q2.set(this.baseValue[0],this.baseValue[1],this.baseValue[2],this.baseValue[3]),r=pE.q3.set(t[0],t[1],t[2],t[3]),a=s.invert().mul(r);a.slerp(ex.IDENTITY,a,this.getWeight(e)),i.mul(a),pE.quatArr[0]=i.x,pE.quatArr[1]=i.y,pE.quatArr[2]=i.z,pE.quatArr[3]=i.w,pT.set(this.value,pE.quatArr,this.valueType);}else pE.vecArr[0]=t[0]-this.baseValue[0],pE.vecArr[1]=t[1]-this.baseValue[1],pE.vecArr[2]=t[2]-this.baseValue[2],pT.blend(this.value,pE.vecArr,this.getWeight(e),this.valueType,true);this.setter&&this.setter(this.value);}}unbind(){this.setter&&this.setter(this.baseValue);}constructor(e,t){this._component=e,this.mask=new Int8Array(e.layers.length),this.weights=new Float32Array(e.layers.length),this.totalWeight=0,this.counter=0,this.layerCounter=0,this.valueType=t,this.dirty=true,this.value=t===pE.TYPE_QUAT?[0,0,0,1]:[0,0,0],this.baseValue=null,this.setter=null;}}pE.TYPE_QUAT="quaternion",pE.TYPE_VEC3="vector3",pE.q1=new ex,pE.q2=new ex,pE.q3=new ex,pE.quatArr=[0,0,0,1],pE.vecArr=[0,0,0],pE.IDENTITY_QUAT_ARR=[0,0,0,1];class pw{get clips(){return this._clips}addClip(e){let t=this._targets,i=this._binder,s=e.track.curves,r=e.snapshot,a=[],n=[];for(let e=0;e<s.length;++e){let o=s[e].paths;for(let s=0;s<o.length;++s){let l=o[s],h=i.resolve(l),c=t[h&&h.targetPath||null];if(!c&&h){c={target:h,value:[],curves:0,blendCounter:0};for(let e=0;e<c.target.components;++e)c.value.push(0);if(t[h.targetPath]=c,i.animComponent){if(!i.animComponent.targets[h.targetPath]){let e;e="localRotation"===h.targetPath.substring(h.targetPath.length-13)?pE.TYPE_QUAT:pE.TYPE_VEC3,i.animComponent.targets[h.targetPath]=new pE(i.animComponent,e);}i.animComponent.targets[h.targetPath].layerCounter++,i.animComponent.targets[h.targetPath].setMask(i.layerIndex,1);}}c&&(c.curves++,a.push(r._results[e]),n.push(c));}}this._clips.push(e),this._inputs.push(a),this._outputs.push(n);}removeClip(e){let t=this._targets,i=this._binder,s=this._clips,r=s[e].track.curves;for(let e=0;e<r.length;++e){let s=r[e].paths;for(let e=0;e<s.length;++e){let r=s[e],a=this._binder.resolve(r);a&&(a.curves--,0===a.curves&&(i.unresolve(r),delete t[a.targetPath],i.animComponent&&i.animComponent.targets[a.targetPath].layerCounter--));}}s.splice(e,1),this._inputs.splice(e,1),this._outputs.splice(e,1);}removeClips(){for(;this._clips.length>0;)this.removeClip(0);}updateClipTrack(e,t){this._clips.forEach(i=>{i.name.includes(e)&&(i.track=t);}),this.rebind();}findClip(e){let t=this._clips;for(let i=0;i<t.length;++i){let s=t[i];if(s.name===e)return s}return null}rebind(){this._binder.rebind(),this._targets={};let e=[...this.clips];this.removeClips(),e.forEach(e=>{this.addClip(e);});}assignMask(e){return this._binder.assignMask(e)}update(e,t=true){let i=this._clips,s=i.map((e,t)=>t);pT.stableSort(s,(e,t)=>i[e].blendOrder<i[t].blendOrder);for(let r=0;r<s.length;++r){let a,n,o,l=s[r],h=i[l],c=this._inputs[l],d=this._outputs[l],u=h.blendWeight;if(u>0&&h._update(e),!t)break;if(u>=1)for(let e=0;e<c.length;++e)a=c[e],o=(n=d[e]).value,pT.set(o,a,n.target.type),n.blendCounter++;else if(u>0)for(let e=0;e<c.length;++e)a=c[e],o=(n=d[e]).value,0===n.blendCounter?pT.set(o,a,n.target.type):pT.blend(o,a,u,n.target.type),n.blendCounter++;}let r=this._targets,a=this._binder;for(let e in r)if(r.hasOwnProperty(e)){let t=r[e];if(a.animComponent&&t.target.usesLayerBlending){let i=a.animComponent.targets[e];i.counter===i.layerCounter&&(i.counter=0),i.path||(i.path=e,i.baseValue=t.target.get(),i.setter=t.target.set),i.updateValue(a.layerIndex,t.value),i.counter++;}else t.target.set(t.value);t.blendCounter=0;}this._binder.update(e);}constructor(e){this._binder=e,this._clips=[],this._inputs=[],this._outputs=[],this._targets={};}}class pb{get events(){return this._events}constructor(e){this._events=[...e],this._events.sort((e,t)=>e.time-t.time);}}class pA{get name(){return this._name}get duration(){return this._duration}get inputs(){return this._inputs}get outputs(){return this._outputs}get curves(){return this._curves}set events(e){this._animEvents=e;}get events(){return this._animEvents.events}eval(e,t){t._time=e;let i=this._inputs,s=this._outputs,r=this._curves,a=t._cache,n=t._results;for(let t=0;t<i.length;++t)a[t].update(e,i[t]._data);for(let e=0;e<r.length;++e){let t=r[e],i=s[t._output],o=n[e];a[t._input].eval(o,t._interpolation,i);}}constructor(e,t,i,s,r,a=new pb([])){this._name=e,this._duration=t,this._inputs=i,this._outputs=s,this._curves=r,this._animEvents=a;}}pA.EMPTY=Object.freeze(new pA("empty",Number.MAX_VALUE,[],[],[]));class pC{static joinPath(e,t){return t=t||".",e.map(function(e){return e.replace(/\\/g,"\\\\").replace(RegExp(`\\${t}`,"g"),`\\${t}`)}).join(t)}static splitPath(e,t){t=t||".";let i=[],s="",r=0;for(;r<e.length;){let a=e[r++];"\\"===a&&r<e.length?"\\"===(a=e[r++])||a===t?s+=a:s+=`\\${a}`:a===t?(i.push(s),s=""):s+=a;}return s.length>0&&i.push(s),i}static encode(e,t,i){return `${Array.isArray(e)?e.join("/"):e}/${t}/${Array.isArray(i)?i.join("/"):i}`}resolve(e){return null}unresolve(e){}update(e){}}class pP{get set(){return this._set}get get(){return this._get}get type(){return this._type}get components(){return this._components}get targetPath(){return this._targetPath}get isTransform(){return this._isTransform}get isWeight(){return this._isWeight}get usesLayerBlending(){return this._isTransform||this._isWeight}constructor(e,t,i,s){e.set?(this._set=e.set,this._get=e.get):this._set=e,this._type=t,this._components=i,this._targetPath=s,this._isTransform="localRotation"===this._targetPath.substring(this._targetPath.length-13)||"localPosition"===this._targetPath.substring(this._targetPath.length-13)||"localScale"===this._targetPath.substring(this._targetPath.length-10),this._isWeight=-1!==this._targetPath.indexOf("weight.");}}class pI{_isPathActive(e){if(!this._mask)return  true;let t=[e.entityPath[0],this.graph.name];for(let i=0;i<t.length;++i){let s=t[i];if(this._isPathInMask(s,1===e.entityPath.length))return  true;for(let t=1;t<e.entityPath.length;t++)if(s+=`/${e.entityPath[t]}`,this._isPathInMask(s,t===e.entityPath.length-1))return  true}return  false}findNode(e){let t;return this._isPathActive(e)?(this.graph&&((t=this.graph.findByPath(e.entityPath))||(t=this.graph.findByPath(e.entityPath.slice(1)))),t||(t=this.nodes[e.entityPath[e.entityPath.length-1]||""]),t):null}static createAnimTarget(e,t,i,s,r,a){return new pP(e,t,i,pC.encode(s.path,a||"entity",r))}resolve(e){let t=pC.encode(e.entityPath,e.component,e.propertyPath),i=this.targetCache[t];if(i)return i;let s=this.findNode(e);if(!s)return null;let r=this.handlers[e.propertyPath];return r&&(i=r(s))?(this.targetCache[t]=i,this.nodeCounts[s.path]?this.nodeCounts[s.path]++:(this.activeNodes.push(s),this.nodeCounts[s.path]=1),i):null}unresolve(e){if("graph"!==e.component)return;let t=this.nodes[e.entityPath[e.entityPath.length-1]||""];if(this.nodeCounts[t.path]--,0===this.nodeCounts[t.path]){let e=this.activeNodes,i=e.indexOf(t.node),s=e.length;i<s-1&&(e[i]=e[s-1]),e.pop();}}update(e){let t=this.activeNodes;for(let e=0;e<t.length;++e)t[e]._dirtifyLocal();}assignMask(e){return e!==this._mask&&(this._mask=e,true)}constructor(e){if(this._isPathInMask=(e,t)=>{let i=this._mask[e];if(i&&(i.children||t&&false!==i.value))return  true;return  false},this.graph=e,!e)return;this._mask=null;let t={},i=function(e){t[e.name]=e;for(let t=0;t<e.children.length;++t)i(e.children[t]);};i(e),this.nodes=t,this.targetCache={};let s=function(e){let t,i=e;for(;i&&!(i instanceof fB);)i=i.parent;return i&&(i.render?t=i.render.meshInstances:i.model&&(t=i.model.meshInstances)),t};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(e){let t=e.localPosition;return pI.createAnimTarget(function(e){t.set(...e);},"vector",3,e,"localPosition")},localRotation:function(e){let t=e.localRotation;return pI.createAnimTarget(function(e){t.set(...e);},"quaternion",4,e,"localRotation")},localScale:function(e){let t=e.localScale;return pI.createAnimTarget(function(e){t.set(...e);},"vector",3,e,"localScale")},weight:function(e,t){t=0===t.indexOf("name.")?t.replace("name.",""):Number(t);let i=s(e),r=[];if(i)for(let t=0;t<i.length;++t)i[t].node.name===e.name&&i[t].morphInstance&&r.push(i[t].morphInstance);return r.length>0?pI.createAnimTarget({set:e=>{for(let i=0;i<r.length;++i)r[i].setWeight(t,e[0]);},get:()=>[r[0].getWeight(t)]},"number",1,e,`weight.${t}`):null},materialTexture:(e,t)=>{let i=s(e);if(i){let s;for(let t=0;t<i.length;++t)if(i[t].node.name===e.name){s=i[t];break}if(s){let i=e=>{let i=this.animComponent.system.app.assets.get(e[0]);i&&i.resource&&"texture"===i.type&&(s.material[t]=i.resource,s.material.update());};return pI.createAnimTarget(i,"vector",1,e,"materialTexture","material")}}return null}};}}class pD extends f5{set animations(e){this._animations=e,this.onSetAnimations();}get animations(){return this._animations}set assets(e){let t=this._assets;if(t&&t.length){for(let e=0;e<t.length;e++)if(t[e]){let i=this.system.app.assets.get(t[e]);if(i){i.off("change",this.onAssetChanged,this),i.off("remove",this.onAssetRemoved,this);let e=this.animationsIndex[i.id];this.currAnim===e&&this._stopCurrentAnimation(),delete this.animations[e],delete this.animationsIndex[i.id];}}}this._assets=e;let i=e.map(e=>e instanceof fy?e.id:e);this.loadAnimationAssets(i);}get assets(){return this._assets}set currentTime(e){if(this.skeleton&&(this.skeleton.currentTime=e,this.skeleton.addTime(0),this.skeleton.updateGraph()),this.animEvaluator){let t=this.animEvaluator.clips;for(let i=0;i<t.length;++i)t[i].time=e;}}get currentTime(){if(this.skeleton)return this.skeleton._time;if(this.animEvaluator){let e=this.animEvaluator.clips;if(e.length>0)return e[e.length-1].time}return 0}get duration(){return this.currAnim?this.animations[this.currAnim].duration:0}set loop(e){if(this._loop=e,this.skeleton&&(this.skeleton.looping=e),this.animEvaluator)for(let t=0;t<this.animEvaluator.clips.length;++t)this.animEvaluator.clips[t].loop=e;}get loop(){return this._loop}play(e,t=0){if(this.enabled&&this.entity.enabled&&this.animations[e]){if(this.prevAnim=this.currAnim,this.currAnim=e,this.model){this.skeleton||this.animEvaluator||this._createAnimationController();let e=this.animations[this.prevAnim],i=this.animations[this.currAnim];if(this.blending=t>0&&!!this.prevAnim,this.blending&&(this.blend=0,this.blendSpeed=1/t),this.skeleton&&(this.blending?(this.fromSkel.animation=e,this.fromSkel.addTime(this.skeleton._time),this.toSkel.animation=i):this.skeleton.animation=i),this.animEvaluator){let e=this.animEvaluator;if(this.blending)for(;e.clips.length>1;)e.removeClip(0);else this.animEvaluator.removeClips();let t=new f7(this.animations[this.currAnim],0,1,true,this.loop);t.name=this.currAnim,t.blendWeight=+!this.blending,t.reset(),this.animEvaluator.addClip(t);}}this.playing=true;}}getAnimation(e){return this.animations[e]}setModel(e){e!==this.model&&(this._resetAnimationController(),this.model=e,this.animations&&this.currAnim&&this.animations[this.currAnim]&&this.play(this.currAnim));}onSetAnimations(){let e=this.entity.model;if(e){let t=e.model;t&&t!==this.model&&this.setModel(t);}if(!this.currAnim&&this.activate&&this.enabled&&this.entity.enabled){let e=Object.keys(this._animations);e.length>0&&this.play(e[0]);}}_resetAnimationController(){this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null;}_createAnimationController(){let e=this.model,t=this.animations,i=false,s=false;for(let e in t)t.hasOwnProperty(e)&&(t[e].constructor===pA?s=true:i=true);let r=e.getGraph();i?(this.fromSkel=new dp(r),this.toSkel=new dp(r),this.skeleton=new dp(r),this.skeleton.looping=this.loop,this.skeleton.setGraph(r)):s&&(this.animEvaluator=new pw(new pI(this.entity)));}loadAnimationAssets(e){if(!e||!e.length)return;let t=this.system.app.assets,i=e=>{if(e.resources.length>1)for(let t=0;t<e.resources.length;t++)this.animations[e.resources[t].name]=e.resources[t],this.animationsIndex[e.id]=e.resources[t].name;else this.animations[e.name]=e.resource,this.animationsIndex[e.id]=e.name;this.animations=this.animations;},s=e=>{e.off("change",this.onAssetChanged,this),e.on("change",this.onAssetChanged,this),e.off("remove",this.onAssetRemoved,this),e.on("remove",this.onAssetRemoved,this),e.resource?i(e):(e.once("load",i,this),this.enabled&&this.entity.enabled&&t.load(e));};for(let i=0,r=e.length;i<r;i++){let r=t.get(e[i]);r?s(r):t.on(`add:${e[i]}`,s);}}onAssetChanged(e,t,i,s){if("resource"===t||"resources"===t)if("resources"===t&&i&&0===i.length&&(i=null),i){let t=false;if(i.length>1){if(s&&s.length>1)for(let e=0;e<s.length;e++)delete this.animations[s[e].name];else delete this.animations[e.name];t=false;for(let e=0;e<i.length;e++)this.animations[i[e].name]=i[e],!t&&this.currAnim===i[e].name&&this.playing&&this.enabled&&this.entity.enabled&&(t=true,this.play(i[e].name));t||(this._stopCurrentAnimation(),this.onSetAnimations());}else {if(s&&s.length>1)for(let e=0;e<s.length;e++)delete this.animations[s[e].name];this.animations[e.name]=i[0]||i,t=false,this.currAnim===e.name&&this.playing&&this.enabled&&this.entity.enabled&&(t=true,this.play(e.name)),t||(this._stopCurrentAnimation(),this.onSetAnimations());}this.animationsIndex[e.id]=e.name;}else {if(s.length>1)for(let e=0;e<s.length;e++)delete this.animations[s[e].name],this.currAnim===s[e].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id];}}onAssetRemoved(e){if(e.off("remove",this.onAssetRemoved,this),this.animations){if(e.resources.length>1)for(let t=0;t<e.resources.length;t++)delete this.animations[e.resources[t].name],this.currAnim===e.resources[t].name&&this._stopCurrentAnimation();else delete this.animations[e.name],this.currAnim===e.name&&this._stopCurrentAnimation();delete this.animationsIndex[e.id];}}_stopCurrentAnimation(){if(this.currAnim=null,this.playing=false,this.skeleton&&(this.skeleton.currentTime=0,this.skeleton.animation=null),this.animEvaluator){for(let e=0;e<this.animEvaluator.clips.length;++e)this.animEvaluator.clips[e].stop();this.animEvaluator.update(0),this.animEvaluator.removeClips();}}onEnable(){super.onEnable();let e=this.assets,t=this.system.app.assets;if(e)for(let i=0,s=e.length;i<s;i++){let s=e[i];s instanceof fy||(s=t.get(s)),s&&!s.resource&&t.load(s);}if(this.activate&&!this.currAnim){let e=Object.keys(this.animations);e.length>0&&this.play(e[0]);}}onBeforeRemove(){for(let e=0;e<this.assets.length;e++){let t=this.assets[e];"number"==typeof t&&(t=this.system.app.assets.get(t)),t&&(t.off("change",this.onAssetChanged,this),t.off("remove",this.onAssetRemoved,this));}this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null;}update(e){if(this.blending&&(this.blend+=e*this.blendSpeed,this.blend>=1&&(this.blend=1)),this.playing){let t=this.skeleton;if(null!==t&&null!==this.model){if(this.blending)t.blend(this.fromSkel,this.toSkel,this.blend);else {let i=e*this.speed;t.addTime(i),this.speed>0&&t._time===t.animation.duration&&!this.loop?this.playing=false:this.speed<0&&0===t._time&&!this.loop&&(this.playing=false);}this.blending&&1===this.blend&&(t.animation=this.toSkel.animation),t.updateGraph();}}let t=this.animEvaluator;if(t){for(let e=0;e<t.clips.length;++e){let i=t.clips[e];i.speed=this.speed,this.playing?i.resume():i.pause();}this.blending&&t.clips.length>1&&(t.clips[1].blendWeight=this.blend),t.update(e);}this.blending&&1===this.blend&&(this.blending=false);}constructor(...e){super(...e),this._animations={},this._assets=[],this._loop=true,this.animEvaluator=null,this.model=null,this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animationsIndex={},this.prevAnim=null,this.currAnim=null,this.blend=0,this.blending=false,this.blendSpeed=0,this.activate=true,this.speed=1;}}class pR{constructor(){this.enabled=true;}}let pL=["enabled"];class pM extends f8{initializeComponentData(e,t,i){for(let i of ["activate","enabled","loop","speed","assets"])t.hasOwnProperty(i)&&(e[i]=t[i]);super.initializeComponentData(e,t,pL);}cloneComponent(e,t){this.addComponent(t,{}),t.animation.assets=e.animation.assets.slice(),t.animation.speed=e.animation.speed,t.animation.loop=e.animation.loop,t.animation.activate=e.animation.activate,t.animation.enabled=e.animation.enabled;let i={},s=e.animation.animations;for(let e in s)s.hasOwnProperty(e)&&(i[e]=s[e]);t.animation.animations=i;let r={},a=e.animation.animationsIndex;for(let e in a)a.hasOwnProperty(e)&&(r[e]=a[e]);return t.animation.animationsIndex=r,t.animation}onBeforeRemove(e,t){t.onBeforeRemove();}onUpdate(e){let t=this.store;for(let i in t)if(t.hasOwnProperty(i)){let s=t[i];s.data.enabled&&s.entity.enabled&&s.entity.animation.update(e);}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this);}constructor(e){super(e),this.id="animation",this.ComponentType=pD,this.DataType=pR,this.schema=pL,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this);}}f5._buildAccessors(pD.prototype,pL);class pO{get parent(){return this._parent}get name(){return this._name}get path(){return this._parent?`${this._parent.path}.${this._name}`:this._name}get point(){return this._point}get pointLength(){return this._pointLength}set weight(e){this._weight=e;}get weight(){return this._parent?this._parent.weight*this._weight:this._weight}get normalizedWeight(){let e=this._state.totalWeight;return 0===e?0:this.weight/e}get speed(){return this._weightedSpeed*this._speed}get absoluteSpeed(){return Math.abs(this._speed)}set weightedSpeed(e){this._weightedSpeed=e;}get weightedSpeed(){return this._weightedSpeed}set animTrack(e){this._animTrack=e;}get animTrack(){return this._animTrack}constructor(e,t,i,s,r=1){this._state=e,this._parent=t,this._name=i,Array.isArray(s)?(this._point=new ef(s[0],s[1]),this._pointLength=this._point.length()):(this._point=s,this._pointLength=s),this._speed=r,this._weightedSpeed=1,this._weight=1,this._animTrack=null;}}class pF extends pO{get weight(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}get syncAnimations(){return this._syncAnimations}getChild(e){for(let t=0;t<this._children.length;t++)if(this._children[t].name===e)return this._children[t];return null}updateParameterValues(){let e=true;for(let t=0;t<this._parameterValues.length;t++){let i=this._findParameter(this._parameters[t]).value;this._parameterValues[t]!==i&&(this._parameterValues[t]=i,e=false);}return e}getNodeWeightedDuration(e){return this._children[e].animTrack.duration/this._children[e].speedMultiplier*this._children[e].weight}getNodeCount(){let e=0;for(let t=0;t<this._children.length;t++)this._children[t].constructor===pF?e+=this._children[t].getNodeCount():e++;return e}constructor(e,t,i,s,r,a,n,o,l){super(e,t,i,s),this._parameters=r,this._parameterValues=Array(r.length),this._children=[],this._findParameter=l,this._syncAnimations=false!==n,this._pointCache={};for(let t=0;t<a.length;t++){let i=a[t];i.children?this._children.push(o(i.type,e,this,i.name,1,i.parameter?[i.parameter]:i.parameters,i.children,i.syncAnimations,o,l)):this._children.push(new pO(e,this,i.name,i.point,i.speed));}}}class pN extends pF{calculateWeights(){if(this.updateParameterValues())return;let e=0;this._children[0].weight=0;for(let t=0;t<this._children.length;t++){let i=this._children[t];if(t!==this._children.length-1){let e=this._children[t+1];if(i.point===e.point)i.weight=.5,e.weight=.5;else if(ei.between(this._parameterValues[0],i.point,e.point,true)){let t=Math.abs(i.point-e.point),s=(t-Math.abs(i.point-this._parameterValues[0]))/t;i.weight=s,e.weight=1-s;}else e.weight=0;}this._syncAnimations&&(e+=i.animTrack.duration/i.absoluteSpeed*i.weight);}if(this._syncAnimations)for(let t=0;t<this._children.length;t++){let i=this._children[t];i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/e;}}constructor(e,t,i,s,r,a,n,o,l){a.sort((e,t)=>e.point-t.point),super(e,t,i,s,r,a,n,o,l);}}class pB extends pF{pointDistanceCache(e,t){let i=`${e}${t}`;return this._pointCache[i]||(this._pointCache[i]=this._children[t].point.clone().sub(this._children[e].point)),this._pointCache[i]}calculateWeights(){let e,t;if(!this.updateParameterValues()){pB._p.set(...this._parameterValues),e=0,t=0;for(let i=0;i<this._children.length;i++){let s=this._children[i],r=s.point;pB._pip.set(pB._p.x,pB._p.y).sub(r);let a=Number.MAX_VALUE;for(let e=0;e<this._children.length;e++){if(i===e)continue;let t=this.pointDistanceCache(i,e),s=ei.clamp(1-pB._pip.dot(t)/t.lengthSq(),0,1);s<a&&(a=s);}s.weight=a,e+=a,this._syncAnimations&&(t+=s.animTrack.duration/s.absoluteSpeed*s.weight);}for(let i=0;i<this._children.length;i++){let s=this._children[i];s.weight=s._weight/e,this._syncAnimations&&(s.weightedSpeed=s.animTrack.duration/s.absoluteSpeed/t);}}}}pB._p=new ef,pB._pip=new ef;class pk extends pF{pointCache(e,t){let i=`${e}${t}`;return this._pointCache[i]||(this._pointCache[i]=new ef((this._children[t].pointLength-this._children[e].pointLength)/((this._children[t].pointLength+this._children[e].pointLength)/2),2*ef.angleRad(this._children[e].point,this._children[t].point))),this._pointCache[i]}calculateWeights(){let e,t;if(this.updateParameterValues())return;pk._p.set(...this._parameterValues);let i=pk._p.length();e=0,t=0;for(let s=0;s<this._children.length;s++){let r=this._children[s],a=r.point,n=r.pointLength,o=Number.MAX_VALUE;for(let e=0;e<this._children.length;e++){if(s===e)continue;let t=this.pointCache(s,e),r=this._children[e].pointLength;pk._pip.set((i-n)/((r+n)/2),2*ef.angleRad(a,pk._p));let l=ei.clamp(1-Math.abs(pk._pip.dot(t)/t.lengthSq()),0,1);l<o&&(o=l);}r.weight=o,e+=o,this._syncAnimations&&(t+=r.animTrack.duration/r.absoluteSpeed*r.weight);}for(let i=0;i<this._children.length;i++){let s=this._children[i];if(s.weight=s._weight/e,this._syncAnimations){let i=s.animTrack.duration/t*e;s.weightedSpeed=s.absoluteSpeed*i;}}}}pk._p=new ef,pk._pip=new ef;class pU extends pF{calculateWeights(){if(this.updateParameterValues())return;let e=0,t=0;for(let i=0;i<this._children.length;i++)if(e+=Math.max(this._parameterValues[i],0),this._syncAnimations){let e=this._children[i];t+=e.animTrack.duration/e.absoluteSpeed*e.weight;}for(let i=0;i<this._children.length;i++){let s=this._children[i],r=Math.max(this._parameterValues[i],0);e?(s.weight=r/e,this._syncAnimations&&(s.weightedSpeed=s.animTrack.duration/s.absoluteSpeed/t)):(s.weight=0,this._syncAnimations&&(s.weightedSpeed=0));}}}class pz{_createTree(e,t,i,s,r,a,n,o,l,h){switch(e){case "1D":return new pN(t,i,s,r,a,n,o,l,h);case p_:return new pB(t,i,s,r,a,n,o,l,h);case pm:return new pk(t,i,s,r,a,n,o,l,h);case pg:return new pU(t,i,s,r,a,n,o,l,h)}}_getNodeFromPath(e){let t=this._blendTree;for(let i=1;i<e.length;i++)t=t.getChild(e[i]);return t}addAnimation(e,t){let i=e.join("."),s=this._animationList.findIndex(e=>e.path===i);if(s>=0)this._animationList[s].animTrack=t;else {let i=this._getNodeFromPath(e);i.animTrack=t,this._animationList.push(i);}this._updateHasAnimations();}_updateHasAnimations(){this._hasAnimations=this._animationList.length>0&&this._animationList.every(e=>e.animTrack&&e.animTrack!==pA.EMPTY);}get name(){return this._name}set animations(e){this._animationList=e,this._updateHasAnimations();}get animations(){return this._animationList}get hasAnimations(){return this._hasAnimations}set speed(e){this._speed=e;}get speed(){return this._speed}set loop(e){this._loop=e;}get loop(){return this._loop}get nodeCount(){return this._blendTree&&this._blendTree.constructor!==pO?this._blendTree.getNodeCount():1}get playable(){return -1!==pS.indexOf(this.name)||this.animations.length===this.nodeCount}get looping(){if(this.animations.length>0){let e=`${this.name}.${this.animations[0].animTrack.name}`,t=this._controller.animEvaluator.findClip(e);if(t)return t.loop}return  false}get totalWeight(){let e=0;for(let t=0;t<this.animations.length;t++)e+=this.animations[t].weight;return e}get timelineDuration(){let e=0;for(let t=0;t<this.animations.length;t++){let i=this.animations[t];i.animTrack.duration>e&&(e=i.animTrack.duration);}return e}constructor(e,t,i=1,s=true,r){this._animations={},this._animationList=[],this._controller=e,this._name=t,this._speed=i,this._loop=s,this._hasAnimations=false,r?this._blendTree=this._createTree(r.type,this,null,t,1,r.parameter?[r.parameter]:r.parameters,r.children,r.syncAnimations,this._createTree,this._controller.findParameter):this._blendTree=new pO(this,null,t,1,i);}}class pV{get from(){return this._from}set to(e){this._to=e;}get to(){return this._to}get time(){return this._time}get priority(){return this._priority}get conditions(){return this._conditions}get exitTime(){return this._exitTime}get transitionOffset(){return this._transitionOffset}get interruptionSource(){return this._interruptionSource}get hasExitTime(){return !!this.exitTime}constructor({from:e,to:t,time:i=0,priority:s=0,conditions:r=[],exitTime:a=null,transitionOffset:n=null,interruptionSource:o=pe}){this._from=e,this._to=t,this._time=i,this._priority=s,this._conditions=r,this._exitTime=a,this._transitionOffset=n,this._interruptionSource=o;}}class pG{get animEvaluator(){return this._animEvaluator}set activeState(e){this._activeStateName=e;}get activeState(){return this._findState(this._activeStateName)}get activeStateName(){return this._activeStateName}get activeStateAnimations(){return this.activeState.animations}set previousState(e){this._previousStateName=e;}get previousState(){return this._findState(this._previousStateName)}get previousStateName(){return this._previousStateName}get playable(){let e=true;for(let t=0;t<this._stateNames.length;t++)this._states[this._stateNames[t]].playable||(e=false);return e}set playing(e){this._playing=e;}get playing(){return this._playing}get activeStateProgress(){return this._getActiveStateProgressForTime(this._timeInState)}get activeStateDuration(){if(this._activeStateDurationDirty){let e=0;for(let t=0;t<this.activeStateAnimations.length;t++){let i=this._animEvaluator.findClip(this.activeStateAnimations[t].name);i&&(e=Math.max(e,i.track.duration));}this._activeStateDuration=e,this._activeStateDurationDirty=false;}return this._activeStateDuration}set activeStateCurrentTime(e){this._timeInStateBefore=e,this._timeInState=e;for(let t=0;t<this.activeStateAnimations.length;t++){let i=this.animEvaluator.findClip(this.activeStateAnimations[t].name);i&&(i.time=e);}}get activeStateCurrentTime(){return this._timeInState}get transitioning(){return this._isTransitioning}get transitionProgress(){return this._currTransitionTime/this._totalTransitionTime}get states(){return this._stateNames}assignMask(e){return this._animEvaluator.assignMask(e)}_findState(e){return this._states[e]}_getActiveStateProgressForTime(e){if(this.activeStateName===pv||"END"===this.activeStateName||"ANY"===this.activeStateName)return 1;let t=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return t?t.progressForTime(e):null}_findTransitionsFromState(e){let t=this._findTransitionsFromStateCache[e];return t||((t=this._transitions.filter(t=>t.from===e)).sort(hu),this._findTransitionsFromStateCache[e]=t),t}_findTransitionsBetweenStates(e,t){let i=this._findTransitionsBetweenStatesCache[`${e}->${t}`];return i||((i=this._transitions.filter(i=>i.from===e&&i.to===t)).sort(hu),this._findTransitionsBetweenStatesCache[`${e}->${t}`]=i),i}_transitionHasConditionsMet(e){let t=e.conditions;for(let e=0;e<t.length;e++){let i=t[e],s=this._findParameter(i.parameterName);switch(i.predicate){case pa:if(!(s.value>i.value))return  false;break;case pn:if(!(s.value<i.value))return  false;break;case po:if(!(s.value>=i.value))return  false;break;case pl:if(!(s.value<=i.value))return  false;break;case ph:if(s.value!==i.value)return  false;break;case pc:if(s.value===i.value)return  false}}return  true}_findTransition(e,t){let i=[];if(e&&t)i=i.concat(this._findTransitionsBetweenStates(e,t));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case pt:i=(i=i.concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState("ANY"));break;case pi:i=(i=i.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState("ANY"));break;case ps:i=(i=(i=i.concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState("ANY"));break;case pr:i=(i=(i=i.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState("ANY"));}else i=(i=i.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState("ANY"));if((i=i.filter(e=>{if(e.to===this.activeStateName)return  false;if(e.hasExitTime){let t=this._getActiveStateProgressForTime(this._timeInStateBefore),i=this._getActiveStateProgressForTime(this._timeInState);if(e.exitTime<1&&this.activeState.loop&&(t-=Math.floor(t),i-=Math.floor(i)),i===t){if(i!==e.exitTime)return null}else if(!(e.exitTime>t&&e.exitTime<=i))return null}return this._transitionHasConditionsMet(e)})).length>0){let e=i[0];return "END"===e.to&&(e.to=this._findTransitionsFromState(pv)[0].to),e}return null}updateStateFromTransition(e){let t,i,s;this.previousState=e.from?this.activeStateName:null,this.activeState=e.to,this._activeStateDurationDirty=true;for(let t=0;t<e.conditions.length;t++){let i=e.conditions[t];this._findParameter(i.parameterName).type===pp&&this._consumeTrigger(i.parameterName);}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});let e=Math.min(0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1,1);for(let r=0;r<this._transitionPreviousStates.length;r++){this._isTransitioning?r!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[r].weight*=1-e:this._transitionPreviousStates[r].weight=e:this._transitionPreviousStates[r].weight=1,t=this._findState(this._transitionPreviousStates[r].name);for(let e=0;e<t.animations.length;e++)i=t.animations[e],(s=this._animEvaluator.findClip(`${i.name}.previous.${r}`))||((s=this._animEvaluator.findClip(i.name)).name=`${i.name}.previous.${r}`),r!==this._transitionPreviousStates.length-1&&s.pause();}}this._isTransitioning=true,this._totalTransitionTime=e.time,this._currTransitionTime=0,this._transitionInterruptionSource=e.interruptionSource;let r=this.activeState,a=e.transitionOffset&&e.transitionOffset>0&&e.transitionOffset<1,n=0,o=0;if(a){let t=r.timelineDuration*e.transitionOffset;n=t,o=t;}this._timeInState=n,this._timeInStateBefore=o;for(let t=0;t<r.animations.length;t++){if(s=this._animEvaluator.findClip(r.animations[t].name))s.reset();else {let e=Number.isFinite(r.animations[t].speed)?r.animations[t].speed:r.speed;(s=new f7(r.animations[t].animTrack,this._timeInState,e,true,r.loop,this._eventHandler)).name=r.animations[t].name,this._animEvaluator.addClip(s);}if(e.time>0?s.blendWeight=0:s.blendWeight=r.animations[t].normalizedWeight,s.play(),a)s.time=r.timelineDuration*e.transitionOffset;else {let e=r.speed>=0?0:this.activeStateDuration;s.time=e;}}}_transitionToState(e){if(!this._findState(e))return;let t=this._findTransition(this._activeStateName,e);t||(this._animEvaluator.removeClips(),t=new pV({from:null,to:e})),this.updateStateFromTransition(t);}assignAnimation(e,t,i,s){let r=e.split("."),a=this._findState(r[0]);a||(a=new pz(this,r[0],i),this._states[r[0]]=a,this._stateNames.push(r[0])),a.addAnimation(r,t),this._animEvaluator.updateClipTrack(a.name,t),void 0!==i&&(a.speed=i),void 0!==s&&(a.loop=s),!this._playing&&this._activate&&this.playable&&this.play(),this._activeStateDurationDirty=true;}removeNodeAnimations(e){if(-1!==pS.indexOf(e))return  false;let t=this._findState(e);return !!t&&(t.animations=[],true)}play(e){e&&this._transitionToState(e),this._playing=true;}pause(){this._playing=false;}reset(){this._previousStateName=null,this._activeStateName=pv,this._playing=false,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=false,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips();}rebind(){this._animEvaluator.rebind();}update(e){let t,i,s;if(!this._playing)return;(this.activeState.loop||this._timeInState<this.activeStateDuration)&&(this._timeInStateBefore=this._timeInState,this._timeInState+=e*this.activeState.speed,!this.activeState.loop&&this._timeInState>this.activeStateDuration&&(this._timeInState=this.activeStateDuration,e=this.activeStateDuration-this._timeInStateBefore));let r=this._findTransition(this._activeStateName);if(r&&this.updateStateFromTransition(r),this._isTransitioning)if(this._currTransitionTime+=e,this._currTransitionTime<=this._totalTransitionTime){let e=0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1;for(let r=0;r<this._transitionPreviousStates.length;r++){t=this._findState(this._transitionPreviousStates[r].name);let a=this._transitionPreviousStates[r].weight;for(let n=0;n<t.animations.length;n++)i=t.animations[n],(s=this._animEvaluator.findClip(`${i.name}.previous.${r}`))&&(s.blendWeight=(1-e)*i.normalizedWeight*a);}t=this.activeState;for(let s=0;s<t.animations.length;s++)i=t.animations[s],this._animEvaluator.findClip(i.name).blendWeight=e*i.normalizedWeight;}else {this._isTransitioning=false;let e=this.activeStateAnimations.length,r=this._animEvaluator.clips.length;for(let t=0;t<r-e;t++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],t=this.activeState;for(let e=0;e<t.animations.length;e++)i=t.animations[e],(s=this._animEvaluator.findClip(i.name))&&(s.blendWeight=i.normalizedWeight);}else if(this.activeState._blendTree.constructor!==pO){t=this.activeState;for(let e=0;e<t.animations.length;e++)i=t.animations[e],(s=this._animEvaluator.findClip(i.name))&&(s.blendWeight=i.normalizedWeight,i.parent.syncAnimations&&(s.speed=i.speed));}this._animEvaluator.update(e,this.activeState.hasAnimations);}constructor(e,t,i,s,r,a,n){this._states={},this._stateNames=[],this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._previousStateName=null,this._activeStateName=pv,this._activeStateDuration=0,this._activeStateDurationDirty=true,this._playing=false,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=false,this._transitionInterruptionSource=pe,this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0,this.findParameter=e=>this._findParameter(e),this._animEvaluator=e,this._eventHandler=r,this._findParameter=a,this._consumeTrigger=n;for(let e=0;e<t.length;e++)this._states[t[e].name]=new pz(this,t[e].name,t[e].speed,t[e].loop,t[e].blendTree),this._stateNames.push(t[e].name);this._transitions=i.map(e=>new pV({...e})),this._activate=s;}}let pH=new ef,pW=new ed,pX=new ep,pY=new es,pq=new ex;class p$ extends pI{static _packFloat(e){return e[0]}static _packBoolean(e){return !!e[0]}static _packVec2(e){return pH.x=e[0],pH.y=e[1],pH}static _packVec3(e){return pW.x=e[0],pW.y=e[1],pW.z=e[2],pW}static _packVec4(e){return pX.x=e[0],pX.y=e[1],pX.z=e[2],pX.w=e[3],pX}static _packColor(e){return pY.r=e[0],pY.g=e[1],pY.b=e[2],pY.a=e[3],pY}static _packQuat(e){return pq.x=e[0],pq.y=e[1],pq.z=e[2],pq.w=e[3],pq}resolve(e){let t,i,s,r=pC.encode(e.entityPath,e.component,e.propertyPath),a=this.targetCache[r];if(a)return a;switch(e.component){case "entity":t=this._getEntityFromHierarchy(e.entityPath),s=pC.encode(t.path,"entity",e.propertyPath),i=t;break;case "graph":if(!(i=this.findNode(e)))return null;s=pC.encode(i.path,"graph",e.propertyPath);break;default:if(!(i=(t=this._getEntityFromHierarchy(e.entityPath)).findComponent(e.component)))return null;s=pC.encode(t.path,e.component,e.propertyPath);}return a=this._createAnimTargetForProperty(i,e.propertyPath,s),this.targetCache[r]=a,a}update(e){let t=this.activeNodes;if(t)for(let e=0;e<t.length;e++)t[e]._dirtifyLocal();}_getEntityFromHierarchy(e){if(!this.animComponent.entity.name===e[0])return null;let t=this.animComponent.entity;return 1===e.length?t:t._parent.findByPath(e)}_resolvePath(e,t,i){let s=t.length-!i;for(let i=0;i<s;i++)e=e[t[i]];return e}_setter(e,t,i){let s=this._resolvePath(e,t),r=t[t.length-1],a=`set${r.substring(0,1).toUpperCase()}${r.substring(1)}`;if(s[a]){let e=s[`get${r.substring(0,1).toUpperCase()}${r.substring(1)}`].bind(s)();e=[e.x,e.y,e.z,e.w];let t=s[a].bind(s);return {set:e=>{t(i(e));},get:()=>e}}let n=s[r];if("object"==typeof n&&n.hasOwnProperty("copy"))return function(e){n.copy(i(e));};if(-1!==[ef,ed,ep,es,ex].indexOf(s.constructor)&&t.length>1){let a=t.length>2?this._resolvePath(e,t.slice(0,-1)):e,n=t[t.length-2];return function(e){s[r]=i(e),a[n]=s;}}return function(e){s[r]=i(e);}}_createAnimTargetForProperty(e,t,i){let s,r,a;if(this.handlers&&t[0].startsWith("weight."))return this.handlers.weight(e,t[0].replace("weight.",""));if(this.handlers&&"material"===t[0]&&2===t.length){let i=t[1];if(i.endsWith("Map"))return this.handlers.materialTexture(e,i)}let n=this._resolvePath(e,t,true);if(void 0===n)return null;if("number"==typeof n)s=this._setter(e,t,p$._packFloat),r="vector",a=1;else if("boolean"==typeof n)s=this._setter(e,t,p$._packBoolean),r="vector",a=1;else if("object"==typeof n)switch(n.constructor){case ef:s=this._setter(e,t,p$._packVec2),r="vector",a=2;break;case ed:s=this._setter(e,t,p$._packVec3),r="vector",a=3;break;case ep:s=this._setter(e,t,p$._packVec4),r="vector",a=4;break;case es:s=this._setter(e,t,p$._packColor),r="vector",a=4;break;case ex:s=this._setter(e,t,p$._packQuat),r="quaternion",a=4;break;default:return null}return -1!==t.indexOf("material")?new pP(t=>{s(t),e.material.update();},r,a,i):new pP(s,r,a,i)}rebind(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;let e={},t=function(i){e[i.name]=i;for(let e=0;e<i.children.length;++e)t(i.children[e]);};t(this.graph),this.nodes=e;}constructor(e,t,i,s,r){super(t),this.animComponent=e,this._mask=s,this.layerName=i,this.layerIndex=r;}}class pj{get name(){return this._name}set playing(e){this._controller.playing=e;}get playing(){return this._controller.playing}get playable(){return this._controller.playable}get activeState(){return this._controller.activeStateName}get previousState(){return this._controller.previousStateName}get activeStateProgress(){return this._controller.activeStateProgress}get activeStateDuration(){return this._controller.activeStateDuration}set activeStateCurrentTime(e){let t=this._controller,i=t.playing;t.playing=true,t.activeStateCurrentTime=e,i||t.update(0),t.playing=i;}get activeStateCurrentTime(){return this._controller.activeStateCurrentTime}get transitioning(){return this._controller.transitioning}get transitionProgress(){return this.transitioning?this._controller.transitionProgress:null}get states(){return this._controller.states}set weight(e){this._weight=e,this._component.dirtifyTargets();}get weight(){return this._weight}set blendType(e){e!==this._blendType&&(this._blendType=e,this._controller.normalizeWeights&&this._component.rebind());}get blendType(){return this._blendType}set mask(e){this._controller.assignMask(e)&&this._component.rebind(),this._mask=e;}get mask(){return this._mask}play(e){this._controller.play(e);}pause(){this._controller.pause();}reset(){this._controller.reset();}rebind(){this._controller.rebind();}update(e){this._blendTime&&(this._blendTimeElapsed<this._blendTime?(this.weight=ei.lerp(this._startingWeight,this._targetWeight,this._blendTimeElapsed/this._blendTime),this._blendTimeElapsed+=e):(this.weight=this._targetWeight,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0)),this._controller.update(e);}blendToWeight(e,t){this._startingWeight=this.weight,this._targetWeight=e,this._blendTime=Math.max(0,t),this._blendTimeElapsed=0;}assignAnimation(e,t,i,s){t instanceof pA&&(this._controller.assignAnimation(e,t,i,s),0===this._controller._transitions.length&&this._controller._transitions.push(new pV({from:"START",to:e})),this._component.activate&&this._component.playable&&(this._component.playing=true));}removeNodeAnimations(e){this._controller.removeNodeAnimations(e)&&(this._component.playing=false);}getAnimationAsset(e){return this._component.animationAssets[`${this.name}:${e}`]}transition(e,t=0,i=null){this._controller.updateStateFromTransition(new pV({from:this._controller.activeStateName,to:e,time:t,transitionOffset:i}));}constructor(e,t,i,s=1,r=py){this._mask=null,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0,this._name=e,this._controller=t,this._component=i,this._weight=s,this._blendType=r;}}class pK{get parameters(){return Object.assign({},this._parameters)}get layers(){return this._layers}constructor(e){if(this._layers=[],this._parameters={},Array.isArray(e.layers))this._layers=e.layers;else for(let t in e.layers){let i=e.layers[t],s={name:i.name,blendType:i.blendType,weight:i.weight,states:[],transitions:[]};for(let t=0;t<i.states.length;t++)s.states.push(e.states[i.states[t]]);for(let t=0;t<i.transitions.length;t++){let r=e.transitions[i.transitions[t]];if(r.conditions&&!Array.isArray(r.conditions)){let e=Object.keys(r.conditions),t=[];for(let i=0;i<e.length;i++){let s=r.conditions[e[i]];s.parameterName&&t.push(s);}r.conditions=t;}Number.isInteger(r.from)&&(r.from=e.states[r.from].name),Number.isInteger(r.to)&&(r.to=e.states[r.to].name),s.transitions.push(r);}this._layers.push(s);}for(let t in e.parameters){let i=e.parameters[t];this._parameters[i.name]={type:i.type,value:i.value};}}}class pZ extends f5{set stateGraphAsset(e){let t,i;null===e?this.removeStateGraph():(this._stateGraphAsset&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this),e instanceof fy?(t=e.id,(i=this.system.app.assets.get(t))||(this.system.app.assets.add(e),i=this.system.app.assets.get(t))):(t=e,i=this.system.app.assets.get(t)),i&&this._stateGraphAsset!==t&&(i.resource?(this._stateGraph=i.resource,this.loadStateGraph(this._stateGraph),i.on("change",this._onStateGraphAssetChangeEvent,this)):(i.once("load",e=>{this._stateGraph=e.resource,this.loadStateGraph(this._stateGraph);}),i.on("change",this._onStateGraphAssetChangeEvent,this),this.system.app.assets.load(i)),this._stateGraphAsset=t));}get stateGraphAsset(){return this._stateGraphAsset}set normalizeWeights(e){this._normalizeWeights=e,this.unbind();}get normalizeWeights(){return this._normalizeWeights}set animationAssets(e){this._animationAssets=e,this.loadAnimationAssets();}get animationAssets(){return this._animationAssets}set speed(e){this._speed=e;}get speed(){return this._speed}set activate(e){this._activate=e;}get activate(){return this._activate}set playing(e){this._playing=e;}get playing(){return this._playing}set rootBone(e){if("string"==typeof e){let t=this.entity.root.findByGuid(e);this._rootBone=t;}else e instanceof fB?this._rootBone=e:this._rootBone=null;this.rebind();}get rootBone(){return this._rootBone}set stateGraph(e){this._stateGraph=e;}get stateGraph(){return this._stateGraph}get layers(){return this._layers}set layerIndices(e){this._layerIndices=e;}get layerIndices(){return this._layerIndices}set parameters(e){this._parameters=e;}get parameters(){return this._parameters}set targets(e){this._targets=e;}get targets(){return this._targets}get playable(){for(let e=0;e<this._layers.length;e++)if(!this._layers[e].playable)return  false;return  true}get baseLayer(){return this._layers.length>0?this._layers[0]:null}_onStateGraphAssetChangeEvent(e){let t=this.animationAssets,i=this.layers.map(e=>e.mask);this.removeStateGraph(),this._stateGraph=new pK(e._data),this.loadStateGraph(this._stateGraph),this.animationAssets=t,this.loadAnimationAssets(),this.layers.forEach((e,t)=>{e.mask=i[t];}),this.rebind();}dirtifyTargets(){let e=Object.values(this._targets);for(let t=0;t<e.length;t++)e[t].dirty=true;}_addLayer({name:e,states:t,transitions:i,weight:s,mask:r,blendType:a}){let n;n=this.rootBone?this.rootBone:this.entity;let o=this._layers.length,l=new pG(new pw(new p$(this,n,e,r,o)),t,i,this._activate,this,this.findParameter,this.consumeTrigger);return this._layers.push(new pj(e,l,this,s,a)),this._layerIndices[e]=o,this._layers[o]}addLayer(e,t,i,s){let r=this.findAnimationLayer(e);return r||this._addLayer({name:e,states:[{name:"START",speed:1}],transitions:[],weight:t,mask:i,blendType:s})}_assignParameters(e){this._parameters={};let t=Object.keys(e.parameters);for(let i=0;i<t.length;i++){let s=t[i];this._parameters[s]={type:e.parameters[s].type,value:e.parameters[s].value};}}loadStateGraph(e){this._stateGraph=e,this._assignParameters(e),this._layers=[];let t=false;for(let i=0;i<e.layers.length;i++){let s=e.layers[i];this._addLayer({...s}),s.states.some(e=>e.blendTree)&&(t=true);}t||this.setupAnimationAssets();}setupAnimationAssets(){for(let e=0;e<this._layers.length;e++){let t=this._layers[e],i=t.name;for(let e=0;e<t.states.length;e++){let s=t.states[e];if(-1===pS.indexOf(s)){let e=`${i}:${s}`;this._animationAssets[e]||(this._animationAssets[e]={asset:null});}}}this.loadAnimationAssets();}loadAnimationAssets(){for(let e=0;e<this._layers.length;e++){let t=this._layers[e];for(let e=0;e<t.states.length;e++){let i=t.states[e];if(-1!==pS.indexOf(i))continue;let s=this._animationAssets[`${t.name}:${i}`];if(!s||!s.asset){this.findAnimationLayer(t.name).assignAnimation(i,pA.EMPTY);continue}let r=s.asset,a=this.system.app.assets.get(r);a&&(a.resource?this.onAnimationAssetLoaded(t.name,i,a):(a.once("load",(function(e,t){return (function(i){this.onAnimationAssetLoaded(e,t,i);}).bind(this)}).bind(this)(t.name,i)),this.system.app.assets.load(a)));}}}onAnimationAssetLoaded(e,t,i){this.findAnimationLayer(e).assignAnimation(t,i.resource);}removeStateGraph(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=false,this.unbind(),this._targets={};}reset(){this._assignParameters(this._stateGraph);for(let e=0;e<this._layers.length;e++){let t=this._layers[e].playing;this._layers[e].reset(),this._layers[e].playing=t;}}unbind(){this._normalizeWeights||Object.keys(this._targets).forEach(e=>{this._targets[e].unbind();});}rebind(){this._targets={};for(let e=0;e<this._layers.length;e++)this._layers[e].rebind();}findAnimationLayer(e){let t=this._layerIndices[e];return this._layers[t]||null}addAnimationState(e,t,i=1,s=true,r="Base"){this._stateGraph||this.loadStateGraph(new pK({layers:[{name:r,states:[{name:"START",speed:1},{name:e,speed:i,loop:s,defaultState:true}],transitions:[{from:"START",to:e}]}],parameters:{}}));let a=this.findAnimationLayer(r);a?a.assignAnimation(e,t,i,s):this.addLayer(r)?.assignAnimation(e,t,i,s);}assignAnimation(e,t,i,s=1,r=true){if(!this._stateGraph&&-1===e.indexOf(".")){this.loadStateGraph(new pK({layers:[{name:"Base",states:[{name:"START",speed:1},{name:e,speed:s,loop:r,defaultState:true}],transitions:[{from:"START",to:e}]}],parameters:{}})),this.baseLayer.assignAnimation(e,t);return}let a=i?this.findAnimationLayer(i):this.baseLayer;a&&a.assignAnimation(e,t,s,r);}removeNodeAnimations(e,t){let i=t?this.findAnimationLayer(t):this.baseLayer;i&&i.removeNodeAnimations(e);}getParameterValue(e,t){let i=this._parameters[e];if(i&&i.type===t)return i.value}setParameterValue(e,t,i){let s=this._parameters[e];if(s&&s.type===t){s.value=i;return}}getFloat(e){return this.getParameterValue(e,pu)}setFloat(e,t){this.setParameterValue(e,pu,t);}getInteger(e){return this.getParameterValue(e,pd)}setInteger(e,t){"number"==typeof t&&t%1==0&&this.setParameterValue(e,pd,t);}getBoolean(e){return this.getParameterValue(e,pf)}setBoolean(e,t){this.setParameterValue(e,pf,!!t);}getTrigger(e){return this.getParameterValue(e,pp)}setTrigger(e,t=false){this.setParameterValue(e,pp,true),t&&this._consumedTriggers.add(e);}resetTrigger(e){this.setParameterValue(e,pp,false);}onBeforeRemove(){Number.isFinite(this._stateGraphAsset)&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this);}update(e){for(let t=0;t<this.layers.length;t++)this.layers[t].update(e*this.speed);this._consumedTriggers.forEach(e=>{this.parameters[e].value=false;}),this._consumedTriggers.clear();}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&t[e.rootBone.getGuid()]?this.rootBone=t[e.rootBone.getGuid()]:this.rebind();}constructor(...e){super(...e),this._stateGraphAsset=null,this._animationAssets={},this._speed=1,this._activate=true,this._playing=false,this._rootBone=null,this._stateGraph=null,this._layers=[],this._layerIndices={},this._parameters={},this._targets={},this._consumedTriggers=new Set,this._normalizeWeights=false,this.findParameter=e=>this._parameters[e],this.consumeTrigger=e=>{this._consumedTriggers.add(e);};}}class pQ{constructor(){this.enabled=true;}}let pJ=["enabled"];class p0 extends f8{initializeComponentData(e,t,i){super.initializeComponentData(e,t,pJ);let s=["animationAssets","stateGraph","layers","masks"];Object.keys(t).forEach(i=>{s.includes(i)||(e[i]=t[i]);}),t.stateGraph&&(e.stateGraph=t.stateGraph,e.loadStateGraph(e.stateGraph)),t.layers&&t.layers.forEach((t,i)=>{t._controller.states.forEach(s=>{t._controller._states[s]._animationList.forEach(s=>{if(s.animTrack&&s.animTrack!==pA.EMPTY)e.layers[i].assignAnimation(s.name,s.animTrack);else {let r=this.app.assets.get(t._component._animationAssets[`${t.name}:${s.name}`].asset);r&&!r.loaded&&r.once("load",()=>{e.layers[i].assignAnimation(s.name,r.resource);});}});});}),t.animationAssets&&(e.animationAssets=Object.assign(e.animationAssets,t.animationAssets)),t.masks&&Object.keys(t.masks).forEach(i=>{if(e.layers[i]){let s=t.masks[i].mask,r={};Object.keys(s).forEach(e=>{r[decodeURI(e)]=s[e];}),e.layers[i].mask=r;}});}onAnimationUpdate(e){let t=this.store;for(let i in t)if(t.hasOwnProperty(i)){let s=t[i].entity.anim;s.data.enabled&&s.entity.enabled&&s.playing&&s.update(e);}}cloneComponent(e,t){let i;e.anim.rootBone&&e.anim.rootBone!==e||(i={},e.anim.layers.forEach((e,s)=>{if(e.mask){let r={};Object.keys(e.mask).forEach(i=>{let s=i.split("/");s.shift(),r[[t.name,...s].join("/")]=e.mask[i];}),i[s]={mask:r};}}));let s={enabled:e.anim.enabled,stateGraphAsset:e.anim.stateGraphAsset,animationAssets:e.anim.animationAssets,speed:e.anim.speed,activate:e.anim.activate,playing:e.anim.playing,rootBone:e.anim.rootBone,stateGraph:e.anim.stateGraph,layers:e.anim.layers,layerIndices:e.anim.layerIndices,parameters:e.anim.parameters,normalizeWeights:e.anim.normalizeWeights,masks:i};return this.addComponent(t,s)}onBeforeRemove(e,t){t.onBeforeRemove();}destroy(){super.destroy(),this.app.systems.off("animationUpdate",this.onAnimationUpdate,this);}constructor(e){super(e),this.id="anim",this.ComponentType=pZ,this.DataType=pQ,this.schema=pJ,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("animationUpdate",this.onAnimationUpdate,this);}}f5._buildAccessors(pZ.prototype,pJ);class p1 extends f5{setCurrentListener(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;let e=this.system.current.getPosition();this.system.manager.listener.setPosition(e);}}onEnable(){this.setCurrentListener();}onDisable(){this.system.current===this.entity&&(this.system.current=null);}}class p2{constructor(){this.enabled=true;}}let p3=["enabled"];class p4 extends f8{initializeComponentData(e,t,i){i=["enabled"],super.initializeComponentData(e,t,i);}onUpdate(e){if(this.current){let e=this.current.getPosition();this.manager.listener.setPosition(e);let t=this.current.getWorldTransform();this.manager.listener.setOrientation(t);}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this);}constructor(e){super(e),this.id="audiolistener",this.ComponentType=p1,this.DataType=p2,this.schema=p3,this.manager=e.soundManager,this.current=null,this.app.systems.on("update",this.onUpdate,this);}}f5._buildAccessors(p1.prototype,p3);let p5="group",p8="image",p6="text",p9="stretch",p7="contain",me="cover",mt="DEFAULT",mi="HOVER",ms="PRESSED",mr="INACTIVE",ma={};ma[mt]="_defaultTint",ma[mi]="hoverTint",ma[ms]="pressedTint",ma[mr]="inactiveTint";let mn={};mn[mt]="_defaultSpriteAsset",mn[mi]="hoverSpriteAsset",mn[ms]="pressedSpriteAsset",mn[mr]="inactiveSpriteAsset";let mo={};mo[mt]="_defaultSpriteFrame",mo[mi]="hoverSpriteFrame",mo[ms]="pressedSpriteFrame",mo[mr]="inactiveSpriteFrame";class ml extends f5{get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e);}get enabled(){return this.data.enabled}set active(e){this._setValue("active",e);}get active(){return this.data.active}set imageEntity(e){if(this._imageEntity!==e){let t="string"==typeof e;(!this._imageEntity||!t||this._imageEntity.getGuid()!==e)&&(this._imageEntity&&this._imageEntityUnsubscribe(),e instanceof oX?this._imageEntity=e:t?this._imageEntity=this.system.app.getEntityFromIndex(e)||null:this._imageEntity=null,this._imageEntity&&this._imageEntitySubscribe(),this._imageEntity?this.data.imageEntity=this._imageEntity.getGuid():t&&e&&(this.data.imageEntity=e));}}get imageEntity(){return this._imageEntity}set hitPadding(e){this._setValue("hitPadding",e);}get hitPadding(){return this.data.hitPadding}set transitionMode(e){this._setValue("transitionMode",e);}get transitionMode(){return this.data.transitionMode}set hoverTint(e){this._setValue("hoverTint",e);}get hoverTint(){return this.data.hoverTint}set pressedTint(e){this._setValue("pressedTint",e);}get pressedTint(){return this.data.pressedTint}set inactiveTint(e){this._setValue("inactiveTint",e);}get inactiveTint(){return this.data.inactiveTint}set fadeDuration(e){this._setValue("fadeDuration",e);}get fadeDuration(){return this.data.fadeDuration}set hoverSpriteAsset(e){this._setValue("hoverSpriteAsset",e);}get hoverSpriteAsset(){return this.data.hoverSpriteAsset}set hoverSpriteFrame(e){this._setValue("hoverSpriteFrame",e);}get hoverSpriteFrame(){return this.data.hoverSpriteFrame}set pressedSpriteAsset(e){this._setValue("pressedSpriteAsset",e);}get pressedSpriteAsset(){return this.data.pressedSpriteAsset}set pressedSpriteFrame(e){this._setValue("pressedSpriteFrame",e);}get pressedSpriteFrame(){return this.data.pressedSpriteFrame}set inactiveSpriteAsset(e){this._setValue("inactiveSpriteAsset",e);}get inactiveSpriteAsset(){return this.data.inactiveSpriteAsset}set inactiveSpriteFrame(e){this._setValue("inactiveSpriteFrame",e);}get inactiveSpriteFrame(){return this.data.inactiveSpriteFrame}_setValue(e,t){let i=this.data,s=i[e];i[e]=t,this.fire("set",e,s,t);}_toggleLifecycleListeners(e,t){this[e]("set_active",this._onSetActive,this),this[e]("set_transitionMode",this._onSetTransitionMode,this),this[e]("set_hoverTint",this._onSetTransitionValue,this),this[e]("set_pressedTint",this._onSetTransitionValue,this),this[e]("set_inactiveTint",this._onSetTransitionValue,this),this[e]("set_hoverSpriteAsset",this._onSetTransitionValue,this),this[e]("set_hoverSpriteFrame",this._onSetTransitionValue,this),this[e]("set_pressedSpriteAsset",this._onSetTransitionValue,this),this[e]("set_pressedSpriteFrame",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteAsset",this._onSetTransitionValue,this),this[e]("set_inactiveSpriteFrame",this._onSetTransitionValue,this),"on"===e?this._evtElementAdd=this.entity.on("element:add",this._onElementComponentAdd,this):(this._evtElementAdd?.off(),this._evtElementAdd=null);}_onSetActive(e,t,i){t!==i&&this._updateVisualState();}_onSetTransitionMode(e,t,i){t!==i&&(this._cancelTween(),this._resetToDefaultVisualState(t),this._forceReapplyVisualState());}_onSetTransitionValue(e,t,i){t!==i&&this._forceReapplyVisualState();}_imageEntitySubscribe(){this._evtImageEntityElementAdd=this._imageEntity.on("element:add",this._onImageElementGain,this),this._imageEntity.element&&this._onImageElementGain();}_imageEntityUnsubscribe(){this._evtImageEntityElementAdd?.off(),this._evtImageEntityElementAdd=null,this._imageEntity?.element&&this._onImageElementLose();}_imageEntityElementSubscribe(){let e=this._imageEntity.element;this._evtImageEntityElementRemove=e.once("beforeremove",this._onImageElementLose,this),this._evtImageEntityElementColor=e.on("set:color",this._onSetColor,this),this._evtImageEntityElementOpacity=e.on("set:opacity",this._onSetOpacity,this),this._evtImageEntityElementSpriteAsset=e.on("set:spriteAsset",this._onSetSpriteAsset,this),this._evtImageEntityElementSpriteFrame=e.on("set:spriteFrame",this._onSetSpriteFrame,this);}_imageEntityElementUnsubscribe(){this._evtImageEntityElementRemove?.off(),this._evtImageEntityElementRemove=null,this._evtImageEntityElementColor?.off(),this._evtImageEntityElementColor=null,this._evtImageEntityElementOpacity?.off(),this._evtImageEntityElementOpacity=null,this._evtImageEntityElementSpriteAsset?.off(),this._evtImageEntityElementSpriteAsset=null,this._evtImageEntityElementSpriteFrame?.off(),this._evtImageEntityElementSpriteFrame=null;}_onElementComponentRemove(){this._toggleHitElementListeners("off");}_onElementComponentAdd(){this._toggleHitElementListeners("on");}_onImageElementLose(){this._imageEntityElementUnsubscribe(),this._cancelTween(),this._resetToDefaultVisualState(this.transitionMode);}_onImageElementGain(){this._imageEntityElementSubscribe(),this._storeDefaultVisualState(),this._forceReapplyVisualState();}_toggleHitElementListeners(e){if(this.entity.element){let t="on"===e;t&&this._hasHitElementListeners||(this.entity.element[e]("beforeremove",this._onElementComponentRemove,this),this.entity.element[e]("mouseenter",this._onMouseEnter,this),this.entity.element[e]("mouseleave",this._onMouseLeave,this),this.entity.element[e]("mousedown",this._onMouseDown,this),this.entity.element[e]("mouseup",this._onMouseUp,this),this.entity.element[e]("touchstart",this._onTouchStart,this),this.entity.element[e]("touchend",this._onTouchEnd,this),this.entity.element[e]("touchleave",this._onTouchLeave,this),this.entity.element[e]("touchcancel",this._onTouchCancel,this),this.entity.element[e]("selectstart",this._onSelectStart,this),this.entity.element[e]("selectend",this._onSelectEnd,this),this.entity.element[e]("selectenter",this._onSelectEnter,this),this.entity.element[e]("selectleave",this._onSelectLeave,this),this.entity.element[e]("click",this._onClick,this),this._hasHitElementListeners=t);}}_storeDefaultVisualState(){let e=this._imageEntity?.element;e&&e.type!==p5&&(this._storeDefaultColor(e.color),this._storeDefaultOpacity(e.opacity),this._storeDefaultSpriteAsset(e.spriteAsset),this._storeDefaultSpriteFrame(e.spriteFrame));}_storeDefaultColor(e){this._defaultTint.r=e.r,this._defaultTint.g=e.g,this._defaultTint.b=e.b;}_storeDefaultOpacity(e){this._defaultTint.a=e;}_storeDefaultSpriteAsset(e){this._defaultSpriteAsset=e;}_storeDefaultSpriteFrame(e){this._defaultSpriteFrame=e;}_onSetColor(e){this._isApplyingTint||(this._storeDefaultColor(e),this._forceReapplyVisualState());}_onSetOpacity(e){this._isApplyingTint||(this._storeDefaultOpacity(e),this._forceReapplyVisualState());}_onSetSpriteAsset(e){this._isApplyingSprite||(this._storeDefaultSpriteAsset(e),this._forceReapplyVisualState());}_onSetSpriteFrame(e){this._isApplyingSprite||(this._storeDefaultSpriteFrame(e),this._forceReapplyVisualState());}_onMouseEnter(e){this._isHovering=true,this._updateVisualState(),this._fireIfActive("mouseenter",e);}_onMouseLeave(e){this._isHovering=false,this._isPressed=false,this._updateVisualState(),this._fireIfActive("mouseleave",e);}_onMouseDown(e){this._isPressed=true,this._updateVisualState(),this._fireIfActive("mousedown",e);}_onMouseUp(e){this._isPressed=false,this._updateVisualState(),this._fireIfActive("mouseup",e);}_onTouchStart(e){this._isPressed=true,this._updateVisualState(),this._fireIfActive("touchstart",e);}_onTouchEnd(e){e.event.preventDefault(),this._isPressed=false,this._updateVisualState(),this._fireIfActive("touchend",e);}_onTouchLeave(e){this._isPressed=false,this._updateVisualState(),this._fireIfActive("touchleave",e);}_onTouchCancel(e){this._isPressed=false,this._updateVisualState(),this._fireIfActive("touchcancel",e);}_onSelectStart(e){this._isPressed=true,this._updateVisualState(),this._fireIfActive("selectstart",e);}_onSelectEnd(e){this._isPressed=false,this._updateVisualState(),this._fireIfActive("selectend",e);}_onSelectEnter(e){this._hoveringCounter++,1===this._hoveringCounter&&(this._isHovering=true,this._updateVisualState()),this._fireIfActive("selectenter",e);}_onSelectLeave(e){this._hoveringCounter--,0===this._hoveringCounter&&(this._isHovering=false,this._isPressed=false,this._updateVisualState()),this._fireIfActive("selectleave",e);}_onClick(e){this._fireIfActive("click",e);}_fireIfActive(e,t){this.data.active&&this.fire(e,t);}_updateVisualState(e){let t=this._visualState,i=this._determineVisualState();if((t!==i||e)&&this.enabled)switch(this._visualState=i,t===mi&&this._fireIfActive("hoverend"),t===ms&&this._fireIfActive("pressedend"),i===mi&&this._fireIfActive("hoverstart"),i===ms&&this._fireIfActive("pressedstart"),this.transitionMode){case 0:{let e=this[ma[this._visualState]];this._applyTint(e);break}case 1:{let e=mn[this._visualState],t=mo[this._visualState],i=this[e],s=this[t];this._applySprite(i,s);}}}_forceReapplyVisualState(){this._updateVisualState(true);}_resetToDefaultVisualState(e){if(this._imageEntity?.element)switch(e){case 0:this._cancelTween(),this._applyTintImmediately(this._defaultTint);break;case 1:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame);}}_determineVisualState(){return this.active?this._isPressed?ms:this._isHovering?mi:mt:mr}_applySprite(e,t){let i=this._imageEntity?.element;i&&(t=t||0,this._isApplyingSprite=true,i.spriteAsset!==e&&(i.spriteAsset=e),i.spriteFrame!==t&&(i.spriteFrame=t),this._isApplyingSprite=false);}_applyTint(e){this._cancelTween(),0===this.fadeDuration?this._applyTintImmediately(e):this._applyTintWithTween(e);}_applyTintImmediately(e){let t=this._imageEntity?.element;if(!e||!t||t.type===p5)return;let i=mh(e);this._isApplyingTint=true,i.equals(t.color)||(t.color=i),t.opacity!==e.a&&(t.opacity=e.a),this._isApplyingTint=false;}_applyTintWithTween(e){let t=this._imageEntity?.element;if(!e||!t||t.type===p5)return;let i=mh(e),s=t.color,r=t.opacity;i.equals(s)&&e.a===r||(this._tweenInfo={startTime:Q(),from:new es(s.r,s.g,s.b,r),to:e.clone(),lerpColor:new es});}_updateTintTween(){let e=Q()-this._tweenInfo.startTime,t=0===this.fadeDuration?1:e/this.fadeDuration;if(Math.abs((t=ei.clamp(t,0,1))-1)>1e-5){let e=this._tweenInfo.lerpColor;e.lerp(this._tweenInfo.from,this._tweenInfo.to,t),this._applyTintImmediately(new es(e.r,e.g,e.b,e.a));}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween();}_cancelTween(){delete this._tweenInfo;}onUpdate(){this._tweenInfo&&this._updateTintTween();}onEnable(){this._isHovering=false,this._hoveringCounter=0,this._isPressed=false,this._toggleHitElementListeners("on"),this._forceReapplyVisualState();}onDisable(){this._toggleHitElementListeners("off"),this._resetToDefaultVisualState(this.transitionMode);}onRemove(){this._imageEntityUnsubscribe(),this._toggleLifecycleListeners("off",this.system),this.onDisable();}resolveDuplicatedEntityReferenceProperties(e,t){e.imageEntity&&(this.imageEntity=t[e.imageEntity.getGuid()]);}constructor(e,t){super(e,t),this._visualState=mt,this._isHovering=false,this._hoveringCounter=0,this._isPressed=false,this._defaultTint=new es(1,1,1,1),this._defaultSpriteAsset=null,this._defaultSpriteFrame=0,this._imageEntity=null,this._evtElementAdd=null,this._evtImageEntityElementAdd=null,this._evtImageEntityElementRemove=null,this._evtImageEntityElementColor=null,this._evtImageEntityElementOpacity=null,this._evtImageEntityElementSpriteAsset=null,this._evtImageEntityElementSpriteFrame=null,this._visualState=mt,this._isHovering=false,this._hoveringCounter=0,this._isPressed=false,this._defaultTint=new es(1,1,1,1),this._defaultSpriteAsset=null,this._defaultSpriteFrame=0,this._toggleLifecycleListeners("on",e);}}function mh(e){return new es(e.r,e.g,e.b)}ml.EVENT_MOUSEDOWN="mousedown",ml.EVENT_MOUSEUP="mouseup",ml.EVENT_MOUSEENTER="mouseenter",ml.EVENT_MOUSELEAVE="mouseleave",ml.EVENT_CLICK="click",ml.EVENT_TOUCHSTART="touchstart",ml.EVENT_TOUCHEND="touchend",ml.EVENT_TOUCHCANCEL="touchcancel",ml.EVENT_TOUCHLEAVE="touchleave",ml.EVENT_SELECTSTART="selectstart",ml.EVENT_SELECTEND="selectend",ml.EVENT_SELECTENTER="selectenter",ml.EVENT_SELECTLEAVE="selectleave",ml.EVENT_HOVERSTART="hoverstart",ml.EVENT_HOVEREND="hoverend",ml.EVENT_PRESSEDSTART="pressedstart",ml.EVENT_PRESSEDEND="pressedend";class mc{constructor(){this.enabled=true,this.active=true,this.imageEntity=null,this.hitPadding=new ep,this.transitionMode=0,this.hoverTint=new es(.75,.75,.75),this.pressedTint=new es(.5,.5,.5),this.inactiveTint=new es(.25,.25,.25),this.fadeDuration=0,this.hoverSpriteAsset=null,this.hoverSpriteFrame=0,this.pressedSpriteAsset=null,this.pressedSpriteFrame=0,this.inactiveSpriteAsset=null,this.inactiveSpriteFrame=0;}}let md=["enabled","active",{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"];class mu extends f8{initializeComponentData(e,t,i){e.imageEntity=t.imageEntity,super.initializeComponentData(e,t,md);}onUpdate(e){let t=this.store;for(let e in t){let i=t[e].entity,s=i.button;s.enabled&&i.enabled&&s.onUpdate();}}_onRemoveComponent(e,t){t.onRemove();}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this);}constructor(e){super(e),this.id="button",this.ComponentType=ml,this.DataType=mc,this.schema=md,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this);}}let mf=new ed,mp=new ex;class mm extends f5{get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e);}get enabled(){return this.data.enabled}set type(e){this._setValue("type",e);}get type(){return this.data.type}set halfExtents(e){this._setValue("halfExtents",e);}get halfExtents(){return this.data.halfExtents}set linearOffset(e){this._setValue("linearOffset",e);}get linearOffset(){return this.data.linearOffset}set angularOffset(e){this._setValue("angularOffset",e);}get angularOffset(){return this.data.angularOffset}set radius(e){this._setValue("radius",e);}get radius(){return this.data.radius}set axis(e){this._setValue("axis",e);}get axis(){return this.data.axis}set height(e){this._setValue("height",e);}get height(){return this.data.height}set asset(e){this._setValue("asset",e);}get asset(){return this.data.asset}set renderAsset(e){this._setValue("renderAsset",e);}get renderAsset(){return this.data.renderAsset}set convexHull(e){this._setValue("convexHull",e);}get convexHull(){return this.data.convexHull}set shape(e){this._setValue("shape",e);}get shape(){return this.data.shape}set model(e){this._setValue("model",e);}get model(){return this.data.model}set render(e){this._setValue("render",e);}get render(){return this.data.render}set checkVertexDuplicates(e){this._setValue("checkVertexDuplicates",e);}get checkVertexDuplicates(){return this.data.checkVertexDuplicates}_setValue(e,t){let i=this.data,s=i[e];i[e]=t,this.fire("set",e,s,t);}onSetType(e,t,i){t!==i&&this.system.changeType(this,t,i);}onSetHalfExtents(e,t,i){let s=this.data.type;this.data.initialized&&"box"===s&&this.system.recreatePhysicalShapes(this);}onSetOffset(e,t,i){this._hasOffset=!this.data.linearOffset.equals(ed.ZERO)||!this.data.angularOffset.equals(ex.IDENTITY),this.data.initialized&&this.system.recreatePhysicalShapes(this);}onSetRadius(e,t,i){let s=this.data.type;this.data.initialized&&("sphere"===s||"capsule"===s||"cylinder"===s||"cone"===s)&&this.system.recreatePhysicalShapes(this);}onSetHeight(e,t,i){let s=this.data.type;this.data.initialized&&("capsule"===s||"cylinder"===s||"cone"===s)&&this.system.recreatePhysicalShapes(this);}onSetAxis(e,t,i){let s=this.data.type;this.data.initialized&&("capsule"===s||"cylinder"===s||"cone"===s)&&this.system.recreatePhysicalShapes(this);}onSetAsset(e,t,i){let s=this.system.app.assets;if(t){let e=s.get(t);e&&e.off("remove",this.onAssetRemoved,this);}if(i){i instanceof fy&&(this.data.asset=i.id);let e=s.get(this.data.asset);e&&(e.off("remove",this.onAssetRemoved,this),e.on("remove",this.onAssetRemoved,this));}this.data.initialized&&"mesh"===this.data.type&&(i||(this.data.model=null),this.system.recreatePhysicalShapes(this));}onSetRenderAsset(e,t,i){let s=this.system.app.assets;if(t){let e=s.get(t);e&&e.off("remove",this.onRenderAssetRemoved,this);}if(i){i instanceof fy&&(this.data.renderAsset=i.id);let e=s.get(this.data.renderAsset);e&&(e.off("remove",this.onRenderAssetRemoved,this),e.on("remove",this.onRenderAssetRemoved,this));}this.data.initialized&&"mesh"===this.data.type&&(i||(this.data.render=null),this.system.recreatePhysicalShapes(this));}onSetModel(e,t,i){this.data.initialized&&"mesh"===this.data.type&&this.system.implementations.mesh.doRecreatePhysicalShape(this);}onSetRender(e,t,i){this.onSetModel(e,t,i);}onAssetRemoved(e){e.off("remove",this.onAssetRemoved,this),this.data.asset===e.id&&(this.asset=null);}onRenderAssetRemoved(e){e.off("remove",this.onRenderAssetRemoved,this),this.data.renderAsset===e.id&&(this.renderAsset=null);}getCompoundChildShapeIndex(e){let t=this.data.shape,i=t.getNumChildShapes();for(let s=0;s<i;s++){let i=t.getChildShape(s);if(Ammo.getPointer(i)===Ammo.getPointer(e))return s}return null}_onInsert(e){if("undefined"!=typeof Ammo){if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody){let e=this.entity.parent;for(;e;){if(e.collision&&"compound"===e.collision.type){0===e.collision.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(e.collision):this.system.recreatePhysicalShapes(this);break}e=e.parent;}}}}_updateCompound(){let e=this.entity;if(e._dirtyWorld){let t=e._dirtyLocal,i=e;for(;i&&!t&&(!i.collision||i.collision!==this._compoundParent);)i._dirtyLocal&&(t=true),i=i.parent;if(t){e.forEach(this.system.implementations.compound._updateEachDescendantTransform,e);let t=this._compoundParent.entity.rigidbody;t&&t.activate();}}}getShapePosition(){let e=this.entity.getPosition();if(this._hasOffset){let t=this.entity.getRotation(),i=this.data.linearOffset;return mp.copy(t).transformVector(i,mf),mf.add(e)}return e}getShapeRotation(){let e=this.entity.getRotation();return this._hasOffset?mp.copy(e).mul(this.data.angularOffset):e}onEnable(){if("mesh"===this.data.type&&(this.data.asset||this.data.renderAsset)&&this.data.initialized){let e=this.system.app.assets.get(this.data.asset||this.data.renderAsset);if(e&&(!e.resource||!this.data.shape))return void this.system.recreatePhysicalShapes(this)}if(this.entity.rigidbody)this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation();else if(this._compoundParent&&this!==this._compoundParent)if(0===this._compoundParent.shape.getNumChildShapes())this.system.recreatePhysicalShapes(this._compoundParent);else {let e=this.system._getNodeTransform(this.entity,this._compoundParent.entity);this._compoundParent.shape.addChildShape(e,this.data.shape),Ammo.destroy(e),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate();}else this.entity.trigger&&this.entity.trigger.enable();}onDisable(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?!this._compoundParent.entity._destroying&&(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable();}onBeforeRemove(){this.asset&&(this.asset=null),this.renderAsset&&(this.renderAsset=null),this.entity.off("insert",this._onInsert,this),this.off();}constructor(e,t){super(e,t),this._compoundParent=null,this._hasOffset=false,this.entity.on("insert",this._onInsert,this),this.on("set_type",this.onSetType,this),this.on("set_convexHull",this.onSetModel,this),this.on("set_halfExtents",this.onSetHalfExtents,this),this.on("set_linearOffset",this.onSetOffset,this),this.on("set_angularOffset",this.onSetOffset,this),this.on("set_radius",this.onSetRadius,this),this.on("set_height",this.onSetHeight,this),this.on("set_axis",this.onSetAxis,this),this.on("set_asset",this.onSetAsset,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_model",this.onSetModel,this),this.on("set_render",this.onSetRender,this);}}mm.EVENT_CONTACT="contact",mm.EVENT_COLLISIONSTART="collisionstart",mm.EVENT_COLLISIONEND="collisionend",mm.EVENT_TRIGGERENTER="triggerenter",mm.EVENT_TRIGGERLEAVE="triggerleave";class m_{constructor(){this.enabled=true,this.type="box",this.halfExtents=new ed(.5,.5,.5),this.linearOffset=new ed,this.angularOffset=new ex,this.radius=.5,this.axis=1,this.height=2,this.convexHull=false,this.asset=null,this.renderAsset=null,this.checkVertexDuplicates=true,this.shape=null,this.model=null,this.render=null,this.initialized=false;}}let mg="static",mv="dynamic",mS="kinematic";class my{initialize(e){let t=this.entity,i=e.shape;if(i&&"undefined"!=typeof Ammo){t.trigger&&t.trigger.destroy();let e=this.component;if(e){let t=e.getShapePosition(),i=e.getShapeRotation();a.setValue(t.x,t.y,t.z),n.setValue(i.x,i.y,i.z,i.w);}else {let e=t.getPosition(),i=t.getRotation();a.setValue(e.x,e.y,e.z),n.setValue(i.x,i.y,i.z,i.w);}o.setOrigin(a),o.setRotation(n);let s=this.app.systems.rigidbody.createBody(1,i,o);s.setRestitution(0),s.setFriction(0),s.setDamping(0,0),a.setValue(0,0,0),s.setLinearFactor(a),s.setAngularFactor(a),s.setCollisionFlags(4|s.getCollisionFlags()),s.entity=t,this.body=s,this.component.enabled&&t.enabled&&this.enable();}}destroy(){this.body&&(this.disable(),this.app.systems.rigidbody.destroyBody(this.body),this.body=null);}_getEntityTransform(e){let t=this.component;if(t){let e=t.getShapePosition(),i=t.getShapeRotation();a.setValue(e.x,e.y,e.z),n.setValue(i.x,i.y,i.z,i.w);}else {let e=this.entity.getPosition(),t=this.entity.getRotation();a.setValue(e.x,e.y,e.z),n.setValue(t.x,t.y,t.z,t.w);}e.setOrigin(a),e.setRotation(n);}updateTransform(){this._getEntityTransform(o);let e=this.body;e.setWorldTransform(o),e.activate();}enable(){let e=this.body;if(!e)return;let t=this.app.systems.rigidbody;0>t._triggers.indexOf(this)&&(t.addBody(e,16,65517),t._triggers.push(this)),e.forceActivationState(1),this.updateTransform();}disable(){let e=this.body;if(!e)return;let t=this.app.systems.rigidbody,i=t._triggers.indexOf(this);i>-1&&(t.removeBody(e),t._triggers.splice(i,1)),e.forceActivationState(5);}constructor(e,t,i){this.entity=t.entity,this.component=t,this.app=e,"undefined"==typeof Ammo||a||(a=new Ammo.btVector3,n=new Ammo.btQuaternion,o=new Ammo.btTransform),this.initialize(i);}}let mx=new ey,mT=new ed,mE=new ed,mw=new ex,mb=new oX,mA=["enabled","type","halfExtents","linearOffset","angularOffset","radius","axis","height","convexHull","asset","renderAsset","shape","model","render","checkVertexDuplicates"];class mC{beforeInitialize(e,t){t.shape=null,t.model=new hA,t.model.graph=new oX;}afterInitialize(e,t){this.recreatePhysicalShapes(e),e.data.initialized=true;}reset(e,t){this.beforeInitialize(e,t),this.afterInitialize(e,t);}recreatePhysicalShapes(e){let t=e.entity,i=e.data;if("undefined"!=typeof Ammo){t.trigger&&(t.trigger.destroy(),delete t.trigger),i.shape&&(e._compoundParent&&(e!==e._compoundParent&&this.system._removeCompoundChild(e._compoundParent,i.shape),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate()),this.destroyShape(i)),i.shape=this.createPhysicalShape(e.entity,i);let s=!e._compoundParent;if("compound"!==i.type||e._compoundParent&&e!==e._compoundParent){if("compound"!==i.type&&!e.rigidbody){e._compoundParent=null;let i=t.parent;for(;i;){if(i.collision&&"compound"===i.collision.type){e._compoundParent=i.collision;break}i=i.parent;}}}else e._compoundParent=e,t.forEach(this._addEachDescendant,e);e._compoundParent&&e!==e._compoundParent&&(s&&0===e._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(e._compoundParent):(this.system.updateCompoundChildTransform(t,true),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate())),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):e._compoundParent||(t.trigger?t.trigger.initialize(i):t.trigger=new my(this.system.app,e,i));}}createPhysicalShape(e,t){}updateTransform(e,t,i,s){e.entity.trigger&&e.entity.trigger.updateTransform();}destroyShape(e){e.shape&&(Ammo.destroy(e.shape),e.shape=null);}beforeRemove(e,t){t.data.shape&&(t._compoundParent&&!t._compoundParent.entity._destroying&&(this.system._removeCompoundChild(t._compoundParent,t.data.shape),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate()),t._compoundParent=null,this.destroyShape(t.data));}remove(e,t){e.rigidbody&&e.rigidbody.body&&e.rigidbody.disableSimulation(),e.trigger&&(e.trigger.destroy(),delete e.trigger);}clone(e,t){let i=this.system.store[e.getGuid()],s={enabled:i.data.enabled,type:i.data.type,halfExtents:[i.data.halfExtents.x,i.data.halfExtents.y,i.data.halfExtents.z],linearOffset:[i.data.linearOffset.x,i.data.linearOffset.y,i.data.linearOffset.z],angularOffset:[i.data.angularOffset.x,i.data.angularOffset.y,i.data.angularOffset.z,i.data.angularOffset.w],radius:i.data.radius,axis:i.data.axis,height:i.data.height,convexHull:i.data.convexHull,asset:i.data.asset,renderAsset:i.data.renderAsset,model:i.data.model,render:i.data.render,checkVertexDuplicates:i.data.checkVertexDuplicates};return this.system.addComponent(t,s)}constructor(e){this.system=e;}}class mP extends mC{createPhysicalShape(e,t){if("undefined"!=typeof Ammo){let e=t.halfExtents,i=new Ammo.btVector3(e?e.x:.5,e?e.y:.5,e?e.z:.5),s=new Ammo.btBoxShape(i);return Ammo.destroy(i),s}}}class mI extends mC{createPhysicalShape(e,t){if("undefined"!=typeof Ammo)return new Ammo.btSphereShape(t.radius)}}class mD extends mC{createPhysicalShape(e,t){let i=t.axis??1,s=t.radius??.5,r=Math.max((t.height??2)-2*s,0),a=null;if("undefined"!=typeof Ammo)switch(i){case 0:a=new Ammo.btCapsuleShapeX(s,r);break;case 1:a=new Ammo.btCapsuleShape(s,r);break;case 2:a=new Ammo.btCapsuleShapeZ(s,r);}return a}}class mR extends mC{createPhysicalShape(e,t){let i=t.axis??1,s=t.radius??.5,r=t.height??1,a=null,n=null;if("undefined"!=typeof Ammo)switch(i){case 0:a=new Ammo.btVector3(.5*r,s,s),n=new Ammo.btCylinderShapeX(a);break;case 1:a=new Ammo.btVector3(s,.5*r,s),n=new Ammo.btCylinderShape(a);break;case 2:a=new Ammo.btVector3(s,s,.5*r),n=new Ammo.btCylinderShapeZ(a);}return a&&Ammo.destroy(a),n}}class mL extends mC{createPhysicalShape(e,t){let i=t.axis??1,s=t.radius??.5,r=t.height??1,a=null;if("undefined"!=typeof Ammo)switch(i){case 0:a=new Ammo.btConeShapeX(s,r);break;case 1:a=new Ammo.btConeShape(s,r);break;case 2:a=new Ammo.btConeShapeZ(s,r);}return a}}class mM extends mC{beforeInitialize(e,t){}createAmmoHull(e,t,i,s){let r=new Ammo.btConvexHullShape,a=new Ammo.btVector3,n=[];e.getPositions(n);for(let e=0;e<n.length;e+=3)a.setValue(n[e]*s.x,n[e+1]*s.y,n[e+2]*s.z),r.addPoint(a,false);Ammo.destroy(a),r.recalcLocalAabb(),r.setMargin(.01);let o=this.system._getNodeTransform(t);i.addChildShape(o,r),Ammo.destroy(o);}createAmmoMesh(e,t,i,s,r=true){let a,n=this.system;if(n._triMeshCache[e.id])a=n._triMeshCache[e.id];else {let t,i,o,l,h,c=e.vertexBuffer,d=c.getFormat();for(let e=0;e<d.elements.length;e++){let s=d.elements[e];if(s.name===e6){i=new Float32Array(c.lock(),s.offset),t=s.stride/4;break}}let u=[];e.getIndices(u);let f=e.primitive[0].count/3,p=new Ammo.btVector3,m=e.primitive[0].base;a=new Ammo.btTriangleMesh,n._triMeshCache[e.id]=a;let _=new Map;a.getIndexedMeshArray().at(0).m_numTriangles=f;let g=s?s.x:1,v=s?s.y:1,S=s?s.z:1,y=e=>{let s,n=i[e*t]*g,o=i[e*t+1]*v,l=i[e*t+2]*S;if(r){let e=`${n}:${o}:${l}`;if(void 0!==(s=_.get(e)))return s;p.setValue(n,o,l),s=a.findOrAddVertex(p,false),_.set(e,s);}else p.setValue(n,o,l),s=a.findOrAddVertex(p,false);return s};for(let e=0;e<f;e++)o=y(u[m+3*e]),l=y(u[m+3*e+1]),h=y(u[m+3*e+2]),a.addIndex(o),a.addIndex(l),a.addIndex(h);Ammo.destroy(p);}let o=new Ammo.btBvhTriangleMeshShape(a,true);if(!s){let e=n._getNodeScaling(t);o.setLocalScaling(e),Ammo.destroy(e);}let l=n._getNodeTransform(t);i.addChildShape(l,o),Ammo.destroy(l);}createPhysicalShape(e,t){if("undefined"!=typeof Ammo&&(t.model||t.render)){let i=new Ammo.btCompoundShape,s=e.getWorldTransform().getScale();if(t.render){let e=t.render.meshes;for(let r=0;r<e.length;r++)t.convexHull?this.createAmmoHull(e[r],mb,i,s):this.createAmmoMesh(e[r],mb,i,s,t.checkVertexDuplicates);}else if(t.model){let e=t.model.meshInstances;for(let s=0;s<e.length;s++)this.createAmmoMesh(e[s].mesh,e[s].node,i,null,t.checkVertexDuplicates);let r=new Ammo.btVector3(s.x,s.y,s.z);i.setLocalScaling(r),Ammo.destroy(r);}return i}}recreatePhysicalShapes(e){let t=e.data;(t.renderAsset||t.asset)&&e.enabled&&e.entity.enabled?this.loadAsset(e,t.renderAsset||t.asset,t.renderAsset?"render":"model"):this.doRecreatePhysicalShape(e);}loadAsset(e,t,i){let s=e.data,r=this.system.app.assets,a=s[i],n=t=>{s[i]===a&&(s[i]=t.resource,this.doRecreatePhysicalShape(e));},o=e=>{e.ready(e=>{if(e.data.containerAsset){let t=r.get(e.data.containerAsset);t.loaded?n(e):(t.ready(()=>{n(e);}),r.load(t));}else n(e);}),r.load(e);},l=r.get(t);l?o(l):r.once(`add:${t}`,o);}doRecreatePhysicalShape(e){let t=e.entity,i=e.data;i.model||i.render?(this.destroyShape(i),i.shape=this.createPhysicalShape(t,i),t.rigidbody?(t.rigidbody.disableSimulation(),t.rigidbody.createBody(),t.enabled&&t.rigidbody.enabled&&t.rigidbody.enableSimulation()):t.trigger?t.trigger.initialize(i):t.trigger=new my(this.system.app,e,i)):(this.beforeRemove(t,e),this.remove(t,i));}updateTransform(e,t,i,s){if(e.shape){let t=e.entity.getWorldTransform().getScale(),i=e.shape.getLocalScaling();(t.x!==i.x()||t.y!==i.y()||t.z!==i.z())&&this.doRecreatePhysicalShape(e);}super.updateTransform(e,t,i,s);}destroyShape(e){if(!e.shape)return;let t=e.shape.getNumChildShapes();for(let i=0;i<t;i++){let t=e.shape.getChildShape(i);Ammo.destroy(t);}Ammo.destroy(e.shape),e.shape=null;}}class mO extends mC{createPhysicalShape(e,t){if("undefined"!=typeof Ammo)return new Ammo.btCompoundShape}_addEachDescendant(e){e.collision&&!e.rigidbody&&(e.collision._compoundParent=this,e!==this.entity&&e.collision.system.recreatePhysicalShapes(e.collision));}_updateEachDescendant(e){!e.collision||e.collision._compoundParent===this&&(e.collision._compoundParent=null,e===this.entity||e.rigidbody||e.collision.system.recreatePhysicalShapes(e.collision));}_updateEachDescendantTransform(e){e.collision&&e.collision._compoundParent===this.collision._compoundParent&&this.collision.system.updateCompoundChildTransform(e,false);}}class mF extends f8{initializeComponentData(e,t,i){let s;i=["type","halfExtents","radius","axis","height","convexHull","shape","model","asset","render","renderAsset","enabled","linearOffset","angularOffset","checkVertexDuplicates"];let r={};for(let e=0,s=i.length;e<s;e++){let s=i[e];r[s]=t[s];}if(t.hasOwnProperty("asset")?(-1!==(s=i.indexOf("model"))&&i.splice(s,1),-1!==(s=i.indexOf("render"))&&i.splice(s,1)):t.hasOwnProperty("model")&&-1!==(s=i.indexOf("asset"))&&i.splice(s,1),r.type||(r.type=e.data.type),e.data.type=r.type,Array.isArray(r.halfExtents)&&(r.halfExtents=new ed(r.halfExtents)),Array.isArray(r.linearOffset)&&(r.linearOffset=new ed(r.linearOffset)),Array.isArray(r.angularOffset)){let e=r.angularOffset;3===e.length?r.angularOffset=new ex().setFromEulerAngles(e[0],e[1],e[2]):r.angularOffset=new ex(r.angularOffset);}let a=this._createImplementation(r.type);a.beforeInitialize(e,r),super.initializeComponentData(e,r,i),a.afterInitialize(e,r);}_createImplementation(e){if(void 0===this.implementations[e]){let t;switch(e){case "box":t=new mP(this);break;case "sphere":t=new mI(this);break;case "capsule":t=new mD(this);break;case "cylinder":t=new mR(this);break;case "cone":t=new mL(this);break;case "mesh":t=new mM(this);break;case "compound":t=new mO(this);}this.implementations[e]=t;}return this.implementations[e]}_getImplementation(e){return this.implementations[e.collision.data.type]}cloneComponent(e,t){return this._getImplementation(e).clone(e,t)}onBeforeRemove(e,t){this.implementations[t.data.type].beforeRemove(e,t),t.onBeforeRemove();}onRemove(e,t){this.implementations[t.type].remove(e,t);}updateCompoundChildTransform(e,t){let i=e.collision._compoundParent;if(i!==e.collision&&e.enabled&&e.collision.enabled&&(e._dirtyLocal||t)){let t=this._getNodeTransform(e,i.entity),s=i.getCompoundChildShapeIndex(e.collision.shape);null===s?i.shape.addChildShape(t,e.collision.data.shape):i.shape.updateChildTransform(s,t,true),Ammo.destroy(t);}}_removeCompoundChild(e,t){if(0!==e.shape.getNumChildShapes())if(e.shape.removeChildShape)e.shape.removeChildShape(t);else {let i=e.getCompoundChildShapeIndex(t);null!==i&&e.shape.removeChildShapeByIndex(i);}}onTransformChanged(e,t,i,s){this.implementations[e.data.type].updateTransform(e,t,i,s);}changeType(e,t,i){this.implementations[t].beforeRemove(e.entity,e),this.implementations[t].remove(e.entity,e.data),this._createImplementation(i).reset(e,e.data);}recreatePhysicalShapes(e){this.implementations[e.data.type].recreatePhysicalShapes(e);}_calculateNodeRelativeTransform(e,t){if(e===t){let t=e.getWorldTransform().getScale();mx.setScale(t.x,t.y,t.z);}else this._calculateNodeRelativeTransform(e.parent,t),mx.mul(e.getLocalTransform());}_getNodeScaling(e){let t=e.getWorldTransform().getScale();return new Ammo.btVector3(t.x,t.y,t.z)}_getNodeTransform(e,t){let i,s;t?(this._calculateNodeRelativeTransform(e,t),i=mT,s=mw,mx.getTranslation(i),s.setFromMat4(mx)):(i=e.getPosition(),s=e.getRotation());let r=new Ammo.btQuaternion,a=new Ammo.btTransform;a.setIdentity();let n=a.getOrigin(),o=e.collision;if(o&&o._hasOffset){let e=o.data.linearOffset,t=o.data.angularOffset;mw.copy(s).transformVector(e,mE),mE.add(i),mw.copy(s).mul(t),n.setValue(mE.x,mE.y,mE.z),r.setValue(mw.x,mw.y,mw.z,mw.w);}else n.setValue(i.x,i.y,i.z),r.setValue(s.x,s.y,s.z,s.w);return a.setRotation(r),Ammo.destroy(r),a}destroy(){for(let e in this._triMeshCache)Ammo.destroy(this._triMeshCache[e]);this._triMeshCache=null,super.destroy();}constructor(e){super(e),this.id="collision",this.ComponentType=mm,this.DataType=m_,this.schema=mA,this.implementations={},this._triMeshCache={},this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this);}}let mN=new es,mB=new ii;class mk{destroy(){this.setMaterial(null),this._element.removeModelFromLayers(this.model),this.model.destroy(),this.model=null,this.node=null,this.mesh=null,this.meshInstance?.destroy(),this.meshInstance=null,this.unmaskMeshInstance?.destroy(),this.unmaskMeshInstance=null,this._entity=null,this._element=null;}setMesh(e){this.meshInstance&&(this.mesh=e,this.meshInstance.mesh=e,this.meshInstance.visible=!!e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=e),this.forceUpdateAabb());}setMask(e){if(this.meshInstance){if(this._entity.enabled&&this._element.enabled&&this._element.removeModelFromLayers(this.model),e)for(let e in this.unmaskMeshInstance=new od(this.mesh,this.meshInstance.material,this.node),this.unmaskMeshInstance.name=`Unmask: ${this._entity.name}`,this.unmaskMeshInstance.castShadow=false,this.unmaskMeshInstance.receiveShadow=false,this.unmaskMeshInstance.pick=false,this.model.meshInstances.push(this.unmaskMeshInstance),this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(e,this.meshInstance.parameters[e].data);else {let e=this.model.meshInstances.indexOf(this.unmaskMeshInstance);e>=0&&this.model.meshInstances.splice(e,1);}this._entity.enabled&&this._element.enabled&&this._element.addModelToLayers(this.model),e||(this.unmaskMeshInstance?.destroy(),this.unmaskMeshInstance=null);}}setMaterial(e){this.meshInstance&&(this.meshInstance.material=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=e));}setParameter(e,t){this.meshInstance&&(this.meshInstance.setParameter(e,t),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(e,t));}deleteParameter(e){this.meshInstance&&(this.meshInstance.deleteParameter(e),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(e));}setUnmaskDrawOrder(){if(!this.meshInstance)return;let e=function(t){let i,s=t.children,r=s.length;if(r){for(let e=0;e<r;e++)s[e].element&&(i=s[e]);if(!i)return null;let t=e(i);return t||i}return null};if(this.unmaskMeshInstance){let t=e(this._entity);t&&t.element?this.unmaskMeshInstance.drawOrder=t.element.drawOrder+t.element.getMaskOffset():this.unmaskMeshInstance.drawOrder=this.meshInstance.drawOrder+this._element.getMaskOffset();}}setDrawOrder(e){this.meshInstance&&(this.meshInstance.drawOrder=e);}setCull(e){if(!this.meshInstance)return;let t=this._element,i=null;e&&t._isScreenSpace()&&(i=function(e){return t.isVisibleForCamera(e)}),this.meshInstance.cull=e,this.meshInstance.isVisibleFunc=i,this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=e,this.unmaskMeshInstance.isVisibleFunc=i);}setScreenSpace(e){this.meshInstance&&(this.meshInstance.screenSpace=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=e));}setLayer(e){this.meshInstance&&(this.meshInstance.layer=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=e));}forceUpdateAabb(e){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1));}setAabbFunc(e){this.meshInstance&&(this.meshInstance._updateAabbFunc=e,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=e));}constructor(e,t,i){this._entity=e,this._element=e.element,this.model=new hA,this.node=new oX,this.model.graph=this.node,this.mesh=t,this.meshInstance=new od(this.mesh,i,this.node),this.meshInstance.name=`ImageElement: ${e.name}`,this.meshInstance.castShadow=false,this.meshInstance.receiveShadow=false,this._meshDirty=false,this.model.meshInstances.push(this.meshInstance),this._entity.addChild(this.model.graph),this.model._entity=this._entity,this.unmaskMeshInstance=null;}}class mU{destroy(){this.textureAsset=null,this.spriteAsset=null,this.materialAsset=null,this._renderable.setMesh(this._defaultMesh),this._renderable.destroy(),this._defaultMesh=null,this._element.off("resize",this._onParentResizeOrPivotChange,this),this._element.off("set:pivot",this._onParentResizeOrPivotChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("screen:set:resolution",this._onResolutionChange,this);}_onResolutionChange(e){}_onParentResizeOrPivotChange(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh);}_onScreenSpaceChange(e){this._updateMaterial(e);}_onScreenChange(e,t){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(false);}_onDrawOrderChange(e){this._renderable.setDrawOrder(e),this.mask&&this._element.screen&&this._element.screen.screen.once("syncdraworder",function(){this._renderable.setUnmaskDrawOrder();},this);}_hasUserMaterial(){return !!this._materialAsset||!!this._material&&-1===this._system.defaultImageMaterials.indexOf(this._material)}_use9Slicing(){return this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)}_updateMaterial(e){let t=!!this._mask,i=!!(this.sprite&&1===this.sprite.renderMode),s=!!(this.sprite&&2===this.sprite.renderMode);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(e,t,i,s)),this._renderable&&(this._renderable.setCull(!this._element._isScreenSpace()||this._element._isScreenCulled()),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(e),this._renderable.setLayer(15*!e));}_createMesh(){let e=this._element,t=e.calculatedWidth,i=e.calculatedHeight,s=this._rect,r=this._system.app.graphicsDevice,a=new Float32Array([t,0,0,0,0,1,s.x+s.z,1-s.y,t,i,0,0,0,1,s.x+s.z,1-(s.y+s.w),0,0,0,0,0,1,s.x,1-s.y,0,i,0,0,0,1,s.x,1-(s.y+s.w)]),n=mB.get(r,()=>new iO(r,[{semantic:e6,components:3,type:6},{semantic:e9,components:3,type:6},{semantic:tr,components:2,type:6}])),o=new iP(r,n,4,{data:a.buffer}),l=new n7(r);return l.vertexBuffer=o,l.primitive[0].type=5,l.primitive[0].base=0,l.primitive[0].count=4,l.primitive[0].indexed=false,l.aabb.setMinMax(ed.ZERO,new ed(t,i,0)),this._updateMesh(l),l}_updateMesh(e){let t=this._element,i=t.calculatedWidth,s=t.calculatedHeight;if(t.fitMode!==p9&&this._targetAspectRatio>0){let e=t.calculatedWidth/t.calculatedHeight;t.fitMode===p7&&e>this._targetAspectRatio||t.fitMode===me&&e<this._targetAspectRatio?i=t.calculatedHeight*this._targetAspectRatio:s=t.calculatedWidth/this._targetAspectRatio;}let r=t._isScreenSpace();if(this._updateMaterial(r),this._renderable&&this._renderable.forceUpdateAabb(),this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)){let e=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],r=2/e.rect.z,a=2/e.rect.w;this._innerOffset.set(e.border.x*r,e.border.y*a,e.border.z*r,e.border.w*a);let n=this.sprite.atlas.texture;this._atlasRect.set(e.rect.x/n.width,e.rect.y/n.height,e.rect.z/n.width,e.rect.w/n.height);let o=null!==this._pixelsPerUnit?this._pixelsPerUnit:this.sprite.pixelsPerUnit,l=e.rect.z/o,h=e.rect.w/o;this._outerScale.set(Math.max(i,this._innerOffset.x*l),Math.max(s,this._innerOffset.y*h));let c=l,d=h;this._outerScale.x/=l,this._outerScale.y/=h,c*=ei.clamp(i/(this._innerOffset.x*l),1e-4,1),d*=ei.clamp(s/(this._innerOffset.y*h),1e-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(c,d,1),this._renderable.node.setLocalPosition((.5-t.pivot.x)*i,(.5-t.pivot.y)*s,0));}else {let r=e.vertexBuffer,a=new Float32Array(r.lock()),n=t.pivot.x,o=t.pivot.y;a[0]=i-n*i,a[1]=0-o*s,a[8]=i-n*i,a[9]=s-o*s,a[16]=0-n*i,a[17]=0-o*s,a[24]=0-n*i,a[25]=s-o*s;let l=1,h=1,c=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){let e=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];e&&(c=e.rect,l=this._sprite.atlas.texture.width,h=this._sprite.atlas.texture.height);}a[6]=(c.x+c.z)/l,a[7]=1-c.y/h,a[14]=(c.x+c.z)/l,a[15]=1-(c.y+c.w)/h,a[22]=c.x/l,a[23]=1-c.y/h,a[30]=c.x/l,a[31]=1-(c.y+c.w)/h,r.unlock();let d=new ed(0-n*i,0-o*s,0),u=new ed(i-n*i,s-o*s,0);e.aabb.setMinMax(d,u),this._renderable&&(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null));}this._meshDirty=false;}_updateSprite(){let e=false,t=null;if(this._targetAspectRatio=-1,this._sprite&&this._sprite.atlas){t=this._sprite.meshes[this.spriteFrame],e=1===this._sprite.renderMode||2===this._sprite.renderMode;let i=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];i?.rect.w>0&&(this._targetAspectRatio=i.rect.z/i.rect.w);}this.mesh=e?t:this._defaultMesh,this.refreshMesh();}refreshMesh(){this.mesh&&(this._element._beingInitialized?this._meshDirty=true:this._updateMesh(this.mesh));}_updateAabb(e){return e.center.set(0,0,0),e.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),e.setFromTransformedAabb(e,this._renderable.node.getWorldTransform()),e}_toggleMask(){this._element._dirtifyMask();let e=this._element._isScreenSpace();this._updateMaterial(e),this._renderable.setMask(!!this._mask);}_onMaterialLoad(e){this.material=e.resource;}_onMaterialAdded(e){this._system.app.assets.off(`add:${e.id}`,this._onMaterialAdded,this),this._materialAsset===e.id&&this._bindMaterialAsset(e);}_bindMaterialAsset(e){this._entity.enabled&&(e.on("load",this._onMaterialLoad,this),e.on("change",this._onMaterialChange,this),e.on("remove",this._onMaterialRemove,this),e.resource?this._onMaterialLoad(e):this._system.app.assets.load(e));}_unbindMaterialAsset(e){e.off("load",this._onMaterialLoad,this),e.off("change",this._onMaterialChange,this),e.off("remove",this._onMaterialRemove,this);}_onMaterialChange(){}_onMaterialRemove(){}_onTextureAdded(e){this._system.app.assets.off(`add:${e.id}`,this._onTextureAdded,this),this._textureAsset===e.id&&this._bindTextureAsset(e);}_bindTextureAsset(e){this._entity.enabled&&(e.on("load",this._onTextureLoad,this),e.on("change",this._onTextureChange,this),e.on("remove",this._onTextureRemove,this),e.resource?this._onTextureLoad(e):this._system.app.assets.load(e));}_unbindTextureAsset(e){e.off("load",this._onTextureLoad,this),e.off("change",this._onTextureChange,this),e.off("remove",this._onTextureRemove,this);}_onTextureLoad(e){this.texture=e.resource;}_onTextureChange(e){}_onTextureRemove(e){}_onSpriteAssetAdded(e){this._system.app.assets.off(`add:${e.id}`,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e);}_bindSpriteAsset(e){this._entity.enabled&&(e.on("load",this._onSpriteAssetLoad,this),e.on("change",this._onSpriteAssetChange,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._system.app.assets.load(e));}_unbindSpriteAsset(e){e.off("load",this._onSpriteAssetLoad,this),e.off("change",this._onSpriteAssetChange,this),e.off("remove",this._onSpriteAssetRemove,this),e.data.textureAtlasAsset&&this._system.app.assets.off(`load:${e.data.textureAtlasAsset}`,this._onTextureAtlasLoad,this);}_onSpriteAssetLoad(e){if(e&&e.resource)if(e.resource.atlas)this.sprite=e.resource;else {let t=e.data.textureAtlasAsset;if(t){let e=this._system.app.assets;e.off(`load:${t}`,this._onTextureAtlasLoad,this),e.once(`load:${t}`,this._onTextureAtlasLoad,this);}}else this.sprite=null;}_onSpriteAssetChange(e){this._onSpriteAssetLoad(e);}_onSpriteAssetRemove(e){}_bindSprite(e){this._evtSetMeshes=e.on("set:meshes",this._onSpriteMeshesChange,this),e.on("set:pixelsPerUnit",this._onSpritePpuChange,this),e.on("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.on("set:texture",this._onAtlasTextureChange,this);}_unbindSprite(e){this._evtSetMeshes?.off(),this._evtSetMeshes=null,e.off("set:pixelsPerUnit",this._onSpritePpuChange,this),e.off("set:atlas",this._onAtlasTextureChange,this),e.atlas&&e.atlas.off("set:texture",this._onAtlasTextureChange,this);}_onSpriteMeshesChange(){this._sprite&&(this._spriteFrame=ei.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite();}_onSpritePpuChange(){0!==this.sprite.renderMode&&null===this._pixelsPerUnit&&this._updateSprite();}_onAtlasTextureChange(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"));}_onTextureAtlasLoad(e){let t=this._spriteAsset;t instanceof fy?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._system.app.assets.get(t));}onEnable(){if(this._materialAsset){let e=this._system.app.assets.get(this._materialAsset);e&&e.resource!==this._material&&this._bindMaterialAsset(e);}if(this._textureAsset){let e=this._system.app.assets.get(this._textureAsset);e&&e.resource!==this._texture&&this._bindTextureAsset(e);}if(this._spriteAsset){let e=this._system.app.assets.get(this._spriteAsset);e&&e.resource!==this._sprite&&this._bindSpriteAsset(e);}this._element.addModelToLayers(this._renderable.model);}onDisable(){this._element.removeModelFromLayers(this._renderable.model);}_setStencil(e){this._renderable.meshInstance.stencilFront=e,this._renderable.meshInstance.stencilBack=e;let t=0;if(this._element.maskedBy&&(t=this._element.maskedBy.element._image._maskRef),this._renderable.unmaskMeshInstance){let e=new iN({ref:t+1,func:2,zpass:5});this._renderable.unmaskMeshInstance.stencilFront=e,this._renderable.unmaskMeshInstance.stencilBack=e;}}_updateRenderableEmissive(){mN.linear(this._color),this._colorUniform[0]=mN.r,this._colorUniform[1]=mN.g,this._colorUniform[2]=mN.b,this._renderable.setParameter("material_emissive",this._colorUniform);}set color(e){let{r:t,g:i,b:s}=e;(this._color.r!==t||this._color.g!==i||this._color.b!==s)&&(this._color.r=t,this._color.g=i,this._color.b=s,this._updateRenderableEmissive()),this._element&&this._element.fire("set:color",this._color);}get color(){return this._color}set opacity(e){e!==this._color.a&&(this._color.a=e,this._renderable.setParameter("material_opacity",e)),this._element&&this._element.fire("set:opacity",e);}get opacity(){return this._color.a}set rect(e){let t,i,s,r;e instanceof ep?(t=e.x,i=e.y,s=e.z,r=e.w):(t=e[0],i=e[1],s=e[2],r=e[3]),(t!==this._rect.x||i!==this._rect.y||s!==this._rect.z||r!==this._rect.w)&&(this._rect.set(t,i,s,r),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=true:this._updateMesh(this._renderable.mesh)));}get rect(){return this._rect}_removeMaterialAssetEvents(){if(this._materialAsset){let e=this._system.app.assets;e.off(`add:${this._materialAsset}`,this._onMaterialAdded,this);let t=e.get(this._materialAsset);t&&(t.off("load",this._onMaterialLoad,this),t.off("change",this._onMaterialChange,this),t.off("remove",this._onMaterialRemove,this));}}set material(e){if(this._material!==e){if(!e){let t=this._element._isScreenSpace();e=this.mask?t?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:t?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial;}if(this._material=e,this._materialAsset){let t=this._system.app.assets.get(this._materialAsset);t&&t.resource===e||(this._removeMaterialAssetEvents(),this._materialAsset=null);}e&&(this._renderable.setMaterial(e),this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._updateRenderableEmissive(),this._renderable.setParameter("material_opacity",this._color.a)));}}get material(){return this._material}set materialAsset(e){let t=this._system.app.assets,i=e;if(e instanceof fy&&(i=e.id),this._materialAsset!==i)if(this._removeMaterialAssetEvents(),this._materialAsset=i,this._materialAsset){let e=t.get(this._materialAsset);e?this._bindMaterialAsset(e):(this._materialAsset=null,this.material=null,this._materialAsset=i,t.on(`add:${this._materialAsset}`,this._onMaterialAdded,this));}else this._materialAsset=null,this.material=null,this._materialAsset=i;}get materialAsset(){return this._materialAsset}set texture(e){if(this._texture!==e){if(this._textureAsset){let t=this._system.app.assets.get(this._textureAsset);t&&t.resource!==e&&(this.textureAsset=null);}if(this._texture=e,e){this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._updateRenderableEmissive(),this._renderable.setParameter("material_opacity",this._color.a);let e=this._texture.width/this._texture.height;e!==this._targetAspectRatio&&(this._targetAspectRatio=e,this._element.fitMode!==p9&&this.refreshMesh());}else this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"),this._targetAspectRatio=-1,this._element.fitMode!==p9&&this.refreshMesh();}}get texture(){return this._texture}set textureAsset(e){let t=this._system.app.assets,i=e;if(e instanceof fy&&(i=e.id),this._textureAsset!==i){if(this._textureAsset){t.off(`add:${this._textureAsset}`,this._onTextureAdded,this);let e=t.get(this._textureAsset);e&&(e.off("load",this._onTextureLoad,this),e.off("change",this._onTextureChange,this),e.off("remove",this._onTextureRemove,this));}if(this._textureAsset=i,this._textureAsset){let e=t.get(this._textureAsset);e?this._bindTextureAsset(e):(this.texture=null,t.on(`add:${this._textureAsset}`,this._onTextureAdded,this));}else this.texture=null;}}get textureAsset(){return this._textureAsset}set spriteAsset(e){let t=this._system.app.assets,i=e;if(e instanceof fy&&(i=e.id),this._spriteAsset!==i){if(this._spriteAsset){t.off(`add:${this._spriteAsset}`,this._onSpriteAssetAdded,this);let e=t.get(this._spriteAsset);e&&this._unbindSpriteAsset(e);}if(this._spriteAsset=i,this._spriteAsset){let e=t.get(this._spriteAsset);e?this._bindSpriteAsset(e):(this.sprite=null,t.on(`add:${this._spriteAsset}`,this._onSpriteAssetAdded,this));}else this.sprite=null;}this._element&&this._element.fire("set:spriteAsset",i);}get spriteAsset(){return this._spriteAsset}set sprite(e){if(this._sprite!==e){if(this._sprite&&this._unbindSprite(this._sprite),this._spriteAsset){let t=this._system.app.assets.get(this._spriteAsset);t&&t.resource!==e&&(this.spriteAsset=null);}this._sprite=e,this._sprite&&(this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null)),this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap")),this._sprite&&(this._spriteFrame=ei.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite();}}get sprite(){return this._sprite}set spriteFrame(e){let t=this._spriteFrame;this._sprite?this._spriteFrame=ei.clamp(e,0,this._sprite.frameKeys.length-1):this._spriteFrame=e,this._spriteFrame!==t&&this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",e);}get spriteFrame(){return this._spriteFrame}set mesh(e){this._renderable.setMesh(e),this._defaultMesh===e?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc);}get mesh(){return this._renderable.mesh}set mask(e){this._mask!==e&&(this._mask=e,this._toggleMask());}get mask(){return this._mask}set pixelsPerUnit(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this._sprite&&(1===this._sprite.renderMode||2===this._sprite.renderMode)&&this._updateSprite());}get pixelsPerUnit(){return this._pixelsPerUnit}get aabb(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}constructor(e){this._evtSetMeshes=null,this._element=e,this._entity=e.entity,this._system=e.system,this._textureAsset=null,this._texture=null,this._materialAsset=null,this._material=null,this._spriteAsset=null,this._sprite=null,this._spriteFrame=0,this._pixelsPerUnit=null,this._targetAspectRatio=-1,this._rect=new ep(0,0,1,1),this._mask=false,this._maskRef=0,this._outerScale=new ef,this._outerScaleUniform=new Float32Array(2),this._innerOffset=new ep,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new ep,this._atlasRectUniform=new Float32Array(4),this._defaultMesh=this._createMesh(),this._renderable=new mk(this._entity,this._defaultMesh,this._material),this._color=new es(1,1,1,1),this._colorUniform=new Float32Array([1,1,1]),this._updateRenderableEmissive(),this._renderable.setParameter("material_opacity",1),this._updateAabbFunc=this._updateAabb.bind(this),this._onScreenChange(this._element.screen),this._element.on("resize",this._onParentResizeOrPivotChange,this),this._element.on("set:pivot",this._onParentResizeOrPivotChange,this),this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.on("set:screen",this._onScreenChange,this),this._element.on("set:draworder",this._onDrawOrderChange,this),this._element.on("screen:set:resolution",this._onResolutionChange,this),!e._beingInitialized&&e.enabled&&e.entity.enabled&&this.onEnable();}}class mz extends X{set defaultAsset(e){let t=e instanceof fy?e.id:e;this._defaultAsset!==t&&(this._defaultAsset&&this._unbindDefaultAsset(),this._defaultAsset=t,this._defaultAsset&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale));}get defaultAsset(){return this._defaultAsset}set localizedAsset(e){let t=e instanceof fy?e.id:e;this._localizedAsset!==t&&(this._localizedAsset&&(this._app.assets.off(`add:${this._localizedAsset}`,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset()),this._localizedAsset=t,this._localizedAsset&&(this._app.assets.get(this._localizedAsset)?this._bindLocalizedAsset():this._app.assets.once(`add:${this._localizedAsset}`,this._onLocalizedAssetAdd,this)));}get localizedAsset(){return this._localizedAsset}set autoLoad(e){this._autoLoad!==e&&(this._autoLoad=e,this._autoLoad&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset()));}get autoLoad(){return this._autoLoad}set disableLocalization(e){this._disableLocalization!==e&&(this._disableLocalization=e,this._onSetLocale(this._app.i18n.locale));}get disableLocalization(){return this._disableLocalization}_bindDefaultAsset(){let e=this._app.assets.get(this._defaultAsset);e?this._onDefaultAssetAdd(e):this._app.assets.once(`add:${this._defaultAsset}`,this._onDefaultAssetAdd,this);}_unbindDefaultAsset(){if(!this._defaultAsset)return;this._app.assets.off(`add:${this._defaultAsset}`,this._onDefaultAssetAdd,this);let e=this._app.assets.get(this._defaultAsset);e&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleRemove,this),e.off("remove",this._onDefaultAssetRemove,this));}_onDefaultAssetAdd(e){this._defaultAsset===e.id&&(e.on("add:localized",this._onLocaleAdd,this),e.on("remove:localized",this._onLocaleRemove,this),e.once("remove",this._onDefaultAssetRemove,this));}_onDefaultAssetRemove(e){this._defaultAsset===e.id&&(e.off("add:localized",this._onLocaleAdd,this),e.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once(`add:${this._defaultAsset}`,this._onDefaultAssetAdd,this));}_bindLocalizedAsset(){if(!this._autoLoad)return;let e=this._app.assets.get(this._localizedAsset);e&&(e.on("load",this._onLocalizedAssetLoad,this),e.on("change",this._onLocalizedAssetChange,this),e.on("remove",this._onLocalizedAssetRemove,this),e.resource?this._onLocalizedAssetLoad(e):this._app.assets.load(e));}_unbindLocalizedAsset(){let e=this._app.assets.get(this._localizedAsset);e&&(e.off("load",this._onLocalizedAssetLoad,this),e.off("change",this._onLocalizedAssetChange,this),e.off("remove",this._onLocalizedAssetRemove,this));}_onLocalizedAssetAdd(e){this._localizedAsset===e.id&&this._bindLocalizedAsset();}_onLocalizedAssetLoad(e){this.fire("load",e);}_onLocalizedAssetChange(e,t,i,s){this.fire("change",e,t,i,s);}_onLocalizedAssetRemove(e){this._localizedAsset===e.id&&(this.localizedAsset=this._defaultAsset),this.fire("remove",e);}_onLocaleAdd(e,t){this._app.i18n.locale===e&&this._onSetLocale(e);}_onLocaleRemove(e,t){this._app.i18n.locale===e&&this._onSetLocale(e);}_onSetLocale(e){if(!this._defaultAsset){this.localizedAsset=null;return}let t=this._app.assets.get(this._defaultAsset);if(!t||this._disableLocalization){this.localizedAsset=this._defaultAsset;return}let i=t.getLocalizedAssetId(e);if(!i){this.localizedAsset=this._defaultAsset;return}this.localizedAsset=i;}destroy(){this.defaultAsset=null,this._app.i18n.off(fR.EVENT_CHANGE,this._onSetLocale,this),this.off();}constructor(e){super(),this._app=e,e.i18n.on(fR.EVENT_CHANGE,this._onSetLocale,this),this._autoLoad=false,this._disableLocalization=false,this._defaultAsset=null,this._localizedAsset=null;}}let mV="msdf",mG="bitmap",mH=/[\w|/]/;class mW{read(){let e=this._read();for(;8===e;)e=this._read();return 0!==e&&1!==e&&(this._last=this._index),e}buf(){return this._buf}last(){return this._last}error(){return this._error}debugPrint(){let e=["EOF","ERROR","TEXT","OPEN_BRACKET","CLOSE_BRACKET","EQUALS","STRING","IDENTIFIER","WHITESPACE"],t=this.read(),i="";for(;i+=`${(i.length>0?"\n":"")+e[t]} '${this.buf().join("")}'`,0!==t&&1!==t;)t=this.read();return i}_read(){return (this._buf=[],this._eof())?0:"text"===this._mode?this._text():this._tag()}_text(){for(;;)switch(this._cur){case null:return 2*(this._buf.length>0);case "[":return this._mode="tag",this._buf.length>0?2:this._tag();case "\\":this._next(),"["===this._cur?this._store():this._output("\\");break;default:this._store();}}_tag(){switch(this._cur){case null:return this._error="unexpected end of input reading tag",1;case "[":return this._store(),3;case "]":return this._store(),this._mode="text",4;case "=":return this._store(),5;case " ":case "	":case "\n":case "\r":case "\v":case "\f":return this._whitespace();case '"':return this._string();default:if(!this._isIdentifierSymbol(this._cur))return this._error="unrecognized character",1;return this._identifier()}}_whitespace(){for(this._store();-1!==" 	\n\r\v\f".indexOf(this._cur);)this._store();return 8}_string(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",1;case '"':return this._next(),6;default:this._store();}}_identifier(){for(this._store();null!==this._cur&&this._isIdentifierSymbol(this._cur);)this._store();return 7}_isIdentifierSymbol(e){return 1===e.length&&null!==e.match(mH)}_eof(){return null===this._cur}_next(){return this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null),this._cur}_store(){return this._buf.push(this._cur),this._next()}_output(e){this._buf.push(e);}constructor(e){this._symbols=e,this._index=0,this._last=0,this._cur=this._symbols.length>0?this._symbols[0]:null,this._buf=[],this._mode="text",this._error=null;}}class mX{parse(e,t){for(;;)switch(this._scanner.read()){case 0:return  true;case 1:default:return  false;case 2:Array.prototype.push.apply(e,this._scanner.buf());break;case 3:if(!this._parseTag(e,t))return  false}}error(){return `Error evaluating markup at #${this._scanner.last().toString()} (${this._scanner.error()||this._error})`}_parseTag(e,t){let i=this._scanner.read();if(7!==i)return this._error="expected identifier",false;let s=this._scanner.buf().join("");if("/"===s[0]){for(let r=t.length-1;r>=0;--r)if(s===`/${t[r].name}`&&null===t[r].end){if(t[r].end=e.length,4!==(i=this._scanner.read()))return this._error="expected close bracket",false;return  true}return this._error="failed to find matching tag",false}let r={name:s,value:null,attributes:{},start:e.length,end:null};if(5===(i=this._scanner.read())){if(6!==(i=this._scanner.read()))return this._error="expected string",false;r.value=this._scanner.buf().join(""),i=this._scanner.read();}for(;;){switch(i){case 4:return t.push(r),true;case 7:{let e=this._scanner.buf().join("");if(5!==(i=this._scanner.read()))return this._error="expected equals",false;if(6!==(i=this._scanner.read()))return this._error="expected string",false;let t=this._scanner.buf().join("");r.attributes[e]=t;break}default:return this._error="expected close bracket or identifier",false}i=this._scanner.read();}}constructor(e){this._scanner=new mW(e),this._error=null;}}class mY{static evaluate(e){let t=new mX(e),i=[],s=[];if(!t.parse(i,s)||s.find(e=>null===e.end))return {symbols:e,tags:null};let r=function(e,t){if(0===e.length)return null;let i={};for(let t=0;t<e.length;++t){let s=e[t];i.hasOwnProperty(s.start)?null===i[s.start].open?i[s.start].open=[s]:i[s.start].open.push(s):i[s.start]={open:[s],close:null},i.hasOwnProperty(s.end)?null===i[s.end].close?i[s.end].close=[s]:i[s.end].close.push(s):i[s.end]={open:null,close:[s]};}let s=[],r=Object.keys(i).sort((e,t)=>e-t),a=[];for(let e=0;e<r.length;++e){let t=i[r[e]];null!==t.close&&function(e){s=s.filter(t=>void 0===e.find(e=>e===t));}(t.close),null!==t.open&&function(e){for(let t=0;t<e.length;++t)s.push(e[t]);}(t.open),a.push({start:r[e],tags:function(e){if(0===e.length)return null;let t={};for(let i=0;i<e.length;++i){let s=e[i],r={};r[s.name]={value:s.value,attributes:s.attributes},function e(t,i){for(let s in i){if(!i.hasOwnProperty(s))continue;let r=i[s];r instanceof Object?(t.hasOwnProperty(s)||(t[s]={}),e(t[s],i[s])):t[s]=r;}}(t,r);}return t}(s)});}let n=[],o=null;for(let e=0;e<a.length;++e){let t=a[e];for(;n.length<t.start;)n.push(o?o.tags:null);o=t;}for(;n.length<t;)n.push(null);return n}(s,i.length);return {symbols:i,tags:r}}}class mq{constructor(){this.count=0,this.quad=0,this.lines={},this.positions=[],this.normals=[],this.uvs=[],this.colors=[],this.indices=[],this.outlines=[],this.shadows=[],this.meshInstance=null;}}let m$=/^[\r\n]$/,mj=/^[ \t]$/,mK=/^[ \t\-]|\u200b$/,mZ=/^[a-z0-9]$/i,mQ=/^[\u1100-\u11ff]|[\u3000-\u9fff\ua960-\ua97f]|[\uac00-\ud7ff]$/,mJ=/^[]$/,m0=["","","","","","","","","","","","",""],m1={width:0,height:0,xadvance:0,xoffset:0,yoffset:0},m2=new es,m3=new ef,m4=new es;class m5{destroy(){this._setMaterial(null),this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null),this._fontAsset.destroy(),this.font=null,this._element.off("resize",this._onParentResize,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("set:pivot",this._onPivotChange,this),this._system.app.i18n.off(fR.EVENT_CHANGE,this._onLocaleSet,this),this._system.app.i18n.off("data:add",this._onLocalizationData,this),this._system.app.i18n.off("data:remove",this._onLocalizationData,this);}_onParentResize(e,t){!this._noResize&&this._font&&this._updateText();}_onScreenChange(e){e?this._updateMaterial(e.screen.screenSpace):this._updateMaterial(false);}_onScreenSpaceChange(e){this._updateMaterial(e);}_onDrawOrderChange(e){if(this._drawOrder=e,this._model)for(let t=0,i=this._model.meshInstances.length;t<i;t++)this._model.meshInstances[t].drawOrder=e;}_onPivotChange(e){this._font&&this._updateText();}_onLocaleSet(e){if(this._i18nKey){if(this.fontAsset){let e=this._system.app.assets.get(this.fontAsset);e&&e.resource&&e.resource===this._font||(this.font=null);}this._resetLocalizedText();}}_onLocalizationData(e,t){this._i18nKey&&t[this._i18nKey]&&this._resetLocalizedText();}_resetLocalizedText(){this._setText(this._system.app.i18n.getText(this._i18nKey));}_setText(e){if(this.unicodeConverter){let t=this._system.getUnicodeConverter();t&&(e=t(e));}this._text!==e&&(this._font&&this._updateText(e),this._text=e);}_updateText(e){let t;if(void 0===e&&(e=this._text),this._symbols=H.getSymbols(e.normalize?e.normalize("NFC"):e),0===this._symbols.length&&(this._symbols=[" "]),this._enableMarkup){let e=mY.evaluate(this._symbols);this._symbols=e.symbols,t=e.tags||[];}if(this._rtlReorder){let e=this._system.app.systems.element.getRtlReorder();if(e){let i=e(this._symbols);this._rtl=i.rtl,this._symbols=i.mapping.map(function(e){return this._symbols[e]},this),t&&(t=i.mapping.map(e=>t[e]));}}else this._rtl=false;let i=(e,t)=>`${e.toString(true).toLowerCase()}:${t.toFixed(2)}`,s=(e,t)=>`${e.toString(true).toLowerCase()}:${t.x.toFixed(2)}:${t.y.toFixed(2)}`;if(t){let e={},r={},a={};this._colorPalette=[Math.round(255*this._color.r),Math.round(255*this._color.g),Math.round(255*this._color.b)],this._outlinePalette=[Math.round(255*this._outlineColor.r),Math.round(255*this._outlineColor.g),Math.round(255*this._outlineColor.b),Math.round(255*this._outlineColor.a),Math.round(255*this._outlineThickness)],this._shadowPalette=[Math.round(255*this._shadowColor.r),Math.round(255*this._shadowColor.g),Math.round(255*this._shadowColor.b),Math.round(255*this._shadowColor.a),Math.round(127*this._shadowOffset.x),Math.round(127*this._shadowOffset.y)],this._symbolColors=[],this._symbolOutlineParams=[],this._symbolShadowParams=[],e[this._color.toString(false).toLowerCase()]=0,r[i(this._outlineColor,this._outlineThickness)]=0,a[s(this._shadowColor,this._shadowOffset)]=0;for(let n=0,o=this._symbols.length;n<o;++n){let o=t[n],l=0;if(o&&o.color&&o.color.value){let t=o.color.value;if(7===t.length&&"#"===t[0]){let i=t.substring(1).toLowerCase();e.hasOwnProperty(i)?l=e[i]:/^[0-9a-f]{6}$/.test(i)&&(l=this._colorPalette.length/3,e[i]=l,this._colorPalette.push(parseInt(i.substring(0,2),16)),this._colorPalette.push(parseInt(i.substring(2,4),16)),this._colorPalette.push(parseInt(i.substring(4,6),16)));}}this._symbolColors.push(l);let h=0;if(o&&o.outline&&(o.outline.attributes.color||o.outline.attributes.thickness)){let e=o.outline.attributes.color?m2.fromString(o.outline.attributes.color):this._outlineColor,t=Number(o.outline.attributes.thickness);(Number.isNaN(e.r)||Number.isNaN(e.g)||Number.isNaN(e.b)||Number.isNaN(e.a))&&(e=this._outlineColor),Number.isNaN(t)&&(t=this._outlineThickness);let s=i(e,t);r.hasOwnProperty(s)?h=r[s]:(h=this._outlinePalette.length/5,r[s]=h,this._outlinePalette.push(Math.round(255*e.r),Math.round(255*e.g),Math.round(255*e.b),Math.round(255*e.a),Math.round(255*t)));}this._symbolOutlineParams.push(h);let c=0;if(o&&o.shadow&&(o.shadow.attributes.color||o.shadow.attributes.offset||o.shadow.attributes.offsetX||o.shadow.attributes.offsetY)){let e=o.shadow.attributes.color?m2.fromString(o.shadow.attributes.color):this._shadowColor,t=Number(o.shadow.attributes.offset),i=Number(o.shadow.attributes.offsetX),r=Number(o.shadow.attributes.offsetY);(Number.isNaN(e.r)||Number.isNaN(e.g)||Number.isNaN(e.b)||Number.isNaN(e.a))&&(e=this._shadowColor);let n=m3.set(Number.isNaN(i)?Number.isNaN(t)?this._shadowOffset.x:t:i,Number.isNaN(r)?Number.isNaN(t)?this._shadowOffset.y:t:r),l=s(e,n);a.hasOwnProperty(l)?c=a[l]:(c=this._shadowPalette.length/6,a[l]=c,this._shadowPalette.push(Math.round(255*e.r),Math.round(255*e.g),Math.round(255*e.b),Math.round(255*e.a),Math.round(127*n.x),Math.round(127*n.y)));}this._symbolShadowParams.push(c);}}else this._colorPalette=[],this._symbolColors=null,this._symbolOutlineParams=null,this._symbolShadowParams=null;this._updateMaterialEmissive(),this._updateMaterialOutline(),this._updateMaterialShadow();let r=this._calculateCharsPerTexture(),a=false,n=this._element,o=n._isScreenSpace(),l=n._isScreenCulled(),h=function(e){return n.isVisibleForCamera(e)};for(let e=0,t=this._meshInfo.length;e<t;e++){let t=r[e]||0,i=this._meshInfo[e];if(i.count!==t){if(a||(n.removeModelFromLayers(this._model),a=true),i.count=t,i.positions.length=i.normals.length=3*t*4,i.indices.length=3*t*2,i.uvs.length=2*t*4,i.colors.length=4*t*4,i.outlines.length=4*t*3,i.shadows.length=4*t*3,i.meshInstance&&this._removeMeshInstance(i.meshInstance),0===t){i.meshInstance=null;continue}for(let e=0;e<t;e++)i.indices[3*e*2+0]=4*e,i.indices[3*e*2+1]=4*e+1,i.indices[3*e*2+2]=4*e+3,i.indices[3*e*2+3]=4*e+2,i.indices[3*e*2+4]=4*e+3,i.indices[3*e*2+5]=4*e+1,i.normals[4*e*3+0]=0,i.normals[4*e*3+1]=0,i.normals[4*e*3+2]=-1,i.normals[4*e*3+3]=0,i.normals[4*e*3+4]=0,i.normals[4*e*3+5]=-1,i.normals[4*e*3+6]=0,i.normals[4*e*3+7]=0,i.normals[4*e*3+8]=-1,i.normals[4*e*3+9]=0,i.normals[4*e*3+10]=0,i.normals[4*e*3+11]=-1;let s=new od(function(e,t){let i=new n7(e);return i.setPositions(t.positions),i.setNormals(t.normals),i.setColors32(t.colors),i.setUvs(0,t.uvs),i.setIndices(t.indices),i.setVertexStream(ty,t.outlines,3,void 0,6,false),i.setVertexStream(tx,t.shadows,3,void 0,6,false),i.update(),i}(this._system.app.graphicsDevice,i),this._material,this._node);if(s.name=`Text Element: ${this._entity.name}`,s.castShadow=false,s.receiveShadow=false,s.cull=!o,s.screenSpace=o,s.drawOrder=this._drawOrder,l&&(s.cull=true,s.isVisibleFunc=h),this._setTextureParams(s,this._font.textures[e]),s.setParameter("material_emissive",this._colorUniform),s.setParameter("material_opacity",this._color.a),s.setParameter("font_sdfIntensity",this._font.intensity),s.setParameter("font_pxrange",this._getPxRange(this._font)),s.setParameter("font_textureWidth",this._font.data.info.maps[e].width),s.setParameter("outline_color",this._outlineColorUniform),s.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness),s.setParameter("shadow_color",this._shadowColorUniform),this._symbolShadowParams)this._shadowOffsetUniform[0]=0,this._shadowOffsetUniform[1]=0;else {let t=-this._font.data.info.maps[e].width/this._font.data.info.maps[e].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=t*this._shadowOffsetScale*this._shadowOffset.y;}s.setParameter("shadow_offset",this._shadowOffsetUniform),i.meshInstance=s,this._model.meshInstances.push(s);}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy),a&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model),this._updateMeshes(),this._rangeStart=0,this._rangeEnd=this._symbols.length,this._updateRenderRange();}_removeMeshInstance(e){e.destroy();let t=this._model.meshInstances.indexOf(e);-1!==t&&this._model.meshInstances.splice(t,1);}_setMaterial(e){if(this._material=e,this._model)for(let t=0,i=this._model.meshInstances.length;t<i;t++)this._model.meshInstances[t].material=e;}_updateMaterial(e){let t=this._element,i=t._isScreenCulled(),s=function(e){return t.isVisibleForCamera(e)},r=this._font&&this._font.type===mV;if(this._material=this._system.getTextElementMaterial(e,r,this._enableMarkup),this._model)for(let t=0,r=this._model.meshInstances.length;t<r;t++){let r=this._model.meshInstances[t];r.cull=!e,r.material=this._material,r.screenSpace=e,i?(r.cull=true,r.isVisibleFunc=s):r.isVisibleFunc=null;}}_updateMaterialEmissive(){this._symbolColors?(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(m4.linear(this._color),this._colorUniform[0]=m4.r,this._colorUniform[1]=m4.g,this._colorUniform[2]=m4.b);}_updateMaterialOutline(){this._symbolOutlineParams?(this._outlineColorUniform[0]=0,this._outlineColorUniform[1]=0,this._outlineColorUniform[2]=0,this._outlineColorUniform[3]=1):(m4.linear(this._outlineColor),this._outlineColorUniform[0]=m4.r,this._outlineColorUniform[1]=m4.g,this._outlineColorUniform[2]=m4.b,this._outlineColorUniform[3]=m4.a);}_updateMaterialShadow(){this._symbolOutlineParams?(this._shadowColorUniform[0]=0,this._shadowColorUniform[1]=0,this._shadowColorUniform[2]=0,this._shadowColorUniform[3]=0):(m4.linear(this._shadowColor),this._shadowColorUniform[0]=m4.r,this._shadowColorUniform[1]=m4.g,this._shadowColorUniform[2]=m4.b,this._shadowColorUniform[3]=m4.a);}_isWordBoundary(e){return mK.test(e)}_isValidNextChar(e){return null!==e&&!mJ.test(e)}_isNextCJKBoundary(e,t){return mQ.test(e)&&(mK.test(t)||mZ.test(t))}_isNextCJKWholeWord(e){return mQ.test(e)}_updateMeshes(){let e,t,i,s,r=this._font.data,a=this,n=Math.min(this._minFontSize,this._maxFontSize),o=this._maxFontSize,l=this._shouldAutoFit();l&&(this._fontSize=this._maxFontSize);let h=this._symbols.length,c=0,d=0,u=0,f=0,p=1,m=0,_=0,g=0,v=0,S=0,y=0,x=Math.abs(this._element.anchor.x-this._element.anchor.z)>=1e-4,T=this._element.calculatedWidth;(!this.autoWidth||x)&&this._wrapLines||(T=1/0);let E=0,w=0;function b(e,t,i){a._lineWidths.push(Math.abs(i));let s=g>t?t+1:g,r=g>t?g+1:t,n=e.slice(s,r);if(y){let e=n.length;for(;e--&&y>0;)m$.test(n[e])&&(n.splice(e,1),y--);}a._lineContents.push(n.join("")),c=0,d-=a._scaledLineHeight,p++,v=0,S=0,y=0,m=0,g=t;}let A=true;for(;A;){A=false,l?this._scaledLineHeight=this._lineHeight*this._fontSize/(this._maxFontSize||1e-4):this._scaledLineHeight=this._lineHeight,this.width=0,this.height=0,this._lineWidths=[],this._lineContents=[],c=0,d=0,u=0,f=0,p=1,m=0,_=0,g=0,v=0,S=0,y=0;let a=this._fontSize/32;E=this._fontMinY*a,w=this._fontMaxY*a;for(let e=0;e<this._meshInfo.length;e++)this._meshInfo[e].quad=0,this._meshInfo[e].lines={};let x=255,C=255,P=255,I=65535,D=65535,R=0,L=65535,M=65535,O=32639;for(let l=0;l<h;l++){let F,N;if(e=this._symbols[l],s=l+1>=h?null:this._symbols[l+1],m$.test(e)){y++,(!this._wrapLines||this._maxLines<0||p<this._maxLines)&&(b(this._symbols,l,f),_=l+1,g=l+1);continue}let B=0,k=0,U=0,z=1;if(!(t=r.chars[e]))if(-1!==m0.indexOf(e))t=m1;else if(r.chars[" "])t=r.chars[" "];else for(let e in r.chars){t=r.chars[e];break}if(t){let e=0;if(S>0){let t=this._font.data.kerning;if(t){let i=t[H.getCodePoint(this._symbols[l-1])||0];i&&(e=i[H.getCodePoint(this._symbols[l])||0]||0);}}F=t.scale||1,z=a*((t.width+t.height)/2)/F,U=(t.xadvance+e)*a,B=(t.xoffset-e)*a,k=t.yoffset*a;}let V=mj.test(e),G=t&&t.map||0,W=-this._font.data.info.maps[G].width/this._font.data.info.maps[G].height,X=this._meshInfo[G],Y=c+this._spacing*U;if(Y>T&&S>0&&!V&&(this._maxLines<0||p<this._maxLines))if(0===v)_=l,b(this._symbols,l,f);else {let e=Math.max(l-_,0);if(this._meshInfo.length<=1)X.lines[p-1]-=e,X.quad-=e;else {let e=_,t=l;for(let i=e;i<t;i++){let e=this._symbols[i],t=r.chars[e],s=this._meshInfo[t&&t.map||0];s.lines[p-1]-=1,s.quad-=1;}}l-=e+1,b(this._symbols,_,m);continue}i=X.quad,X.lines[p-1]=i;let q=c-B,$=q+z,j=d-k,K=j+z;if(this._rtl){let e=z-B-this._spacing*U-B;q-=e,$-=e;}if(X.positions[4*i*3+0]=q,X.positions[4*i*3+1]=j,X.positions[4*i*3+2]=u,X.positions[4*i*3+3]=$,X.positions[4*i*3+4]=j,X.positions[4*i*3+5]=u,X.positions[4*i*3+6]=$,X.positions[4*i*3+7]=K,X.positions[4*i*3+8]=u,X.positions[4*i*3+9]=q,X.positions[4*i*3+10]=K,X.positions[4*i*3+11]=u,this.width=Math.max(this.width,Y),this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(N=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1e-4)),(N=ei.clamp(N,n,o))!==this._element.fontSize)||(this.height=Math.max(this.height,w-(d+E)),this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(N=ei.clamp(this._fontSize-1,n,o))!==this._element.fontSize)){this._fontSize=N,A=true;break}c+=this._spacing*U,V||(f=c),(this._isWordBoundary(e)||this._isValidNextChar(s)&&(this._isNextCJKBoundary(e,s)||this._isNextCJKWholeWord(s)))&&(v++,m=f,_=l+1),S++;let Z=this._getUv(e);if(X.uvs[4*i*2+0]=Z[0],X.uvs[4*i*2+1]=1-Z[1],X.uvs[4*i*2+2]=Z[2],X.uvs[4*i*2+3]=1-Z[1],X.uvs[4*i*2+4]=Z[2],X.uvs[4*i*2+5]=1-Z[3],X.uvs[4*i*2+6]=Z[0],X.uvs[4*i*2+7]=1-Z[3],this._symbolColors){let e=3*this._symbolColors[l];x=this._colorPalette[e],C=this._colorPalette[e+1],P=this._colorPalette[e+2];}if(X.colors[4*i*4+0]=x,X.colors[4*i*4+1]=C,X.colors[4*i*4+2]=P,X.colors[4*i*4+3]=255,X.colors[4*i*4+4]=x,X.colors[4*i*4+5]=C,X.colors[4*i*4+6]=P,X.colors[4*i*4+7]=255,X.colors[4*i*4+8]=x,X.colors[4*i*4+9]=C,X.colors[4*i*4+10]=P,X.colors[4*i*4+11]=255,X.colors[4*i*4+12]=x,X.colors[4*i*4+13]=C,X.colors[4*i*4+14]=P,X.colors[4*i*4+15]=255,this._symbolOutlineParams){let e=5*this._symbolOutlineParams[l];I=this._outlinePalette[e]+256*this._outlinePalette[e+1],D=this._outlinePalette[e+2]+256*this._outlinePalette[e+3],R=this._outlinePalette[e+4];}if(X.outlines[4*i*3+0]=I,X.outlines[4*i*3+1]=D,X.outlines[4*i*3+2]=R,X.outlines[4*i*3+3]=I,X.outlines[4*i*3+4]=D,X.outlines[4*i*3+5]=R,X.outlines[4*i*3+6]=I,X.outlines[4*i*3+7]=D,X.outlines[4*i*3+8]=R,X.outlines[4*i*3+9]=I,X.outlines[4*i*3+10]=D,X.outlines[4*i*3+11]=R,this._symbolShadowParams){let e=6*this._symbolShadowParams[l];L=this._shadowPalette[e]+256*this._shadowPalette[e+1],M=this._shadowPalette[e+2]+256*this._shadowPalette[e+3],O=this._shadowPalette[e+4]+127+256*Math.round(W*this._shadowPalette[e+5]+127);}X.shadows[4*i*3+0]=L,X.shadows[4*i*3+1]=M,X.shadows[4*i*3+2]=O,X.shadows[4*i*3+3]=L,X.shadows[4*i*3+4]=M,X.shadows[4*i*3+5]=O,X.shadows[4*i*3+6]=L,X.shadows[4*i*3+7]=M,X.shadows[4*i*3+8]=O,X.shadows[4*i*3+9]=L,X.shadows[4*i*3+10]=M,X.shadows[4*i*3+11]=O,X.quad++;}!A&&g<h&&b(this._symbols,h,c);}this._noResize=true,this.autoWidth=this._autoWidth,this.autoHeight=this._autoHeight,this._noResize=false;let C=this._element.pivot.x,P=this._element.pivot.y,I=this._alignment.x,D=this._alignment.y;for(let e=0;e<this._meshInfo.length;e++){if(0===this._meshInfo[e].count)continue;let t=0;for(let i in this._meshInfo[e].lines){let s=this._meshInfo[e].lines[i],r=this._lineWidths[parseInt(i,10)],a=-C*this._element.calculatedWidth+I*(this._element.calculatedWidth-r)*(this._rtl?-1:1),n=(1-P)*this._element.calculatedHeight-w-(1-D)*(this._element.calculatedHeight-this.height);for(let i=t;i<=s;i++)this._meshInfo[e].positions[4*i*3]+=a,this._meshInfo[e].positions[4*i*3+3]+=a,this._meshInfo[e].positions[4*i*3+6]+=a,this._meshInfo[e].positions[4*i*3+9]+=a,this._meshInfo[e].positions[4*i*3+1]+=n,this._meshInfo[e].positions[4*i*3+4]+=n,this._meshInfo[e].positions[4*i*3+7]+=n,this._meshInfo[e].positions[4*i*3+10]+=n;if(this._rtl)for(let i=t;i<=s;i++){let t=4*i*3;for(let i=0;i<4;++i)this._meshInfo[e].positions[t+3*i]=this._element.calculatedWidth-this._meshInfo[e].positions[t+3*i]+2*a;let s=this._meshInfo[e].positions[t+3],r=this._meshInfo[e].positions[t+6];this._meshInfo[e].positions[t+3]=this._meshInfo[e].positions[t+0],this._meshInfo[e].positions[t+6]=this._meshInfo[e].positions[t+9],this._meshInfo[e].positions[t+0]=s,this._meshInfo[e].positions[t+9]=r;}t=s+1;}let i=4*this._meshInfo[e].count,s=4*this._meshInfo[e].quad,r=new ag(this._meshInfo[e].meshInstance.mesh.vertexBuffer);for(let t=0;t<i;t++)t>=s?(r.element[e6].set(0,0,0),r.element[tr].set(0,0),r.element[ti].set(0,0,0,0),r.element[ty].set(0,0,0,0),r.element[tx].set(0,0,0,0)):(r.element[e6].set(this._meshInfo[e].positions[3*t+0],this._meshInfo[e].positions[3*t+1],this._meshInfo[e].positions[3*t+2]),r.element[tr].set(this._meshInfo[e].uvs[2*t+0],this._meshInfo[e].uvs[2*t+1]),r.element[ti].set(this._meshInfo[e].colors[4*t+0],this._meshInfo[e].colors[4*t+1],this._meshInfo[e].colors[4*t+2],this._meshInfo[e].colors[4*t+3]),r.element[ty].set(this._meshInfo[e].outlines[3*t+0],this._meshInfo[e].outlines[3*t+1],this._meshInfo[e].outlines[3*t+2]),r.element[tx].set(this._meshInfo[e].shadows[3*t+0],this._meshInfo[e].shadows[3*t+1],this._meshInfo[e].shadows[3*t+2])),r.next();r.end(),this._meshInfo[e].meshInstance.mesh.aabb.compute(this._meshInfo[e].positions),this._meshInfo[e].meshInstance._aabbVer=-1;}this._aabbDirty=true;}_onFontRender(){this.font=this._font;}_onFontLoad(e){this.font!==e.resource&&(this.font=e.resource);}_onFontChange(e,t,i,s){if("data"===t){this._font.data=i;let e=this._font.data.info.maps.length;for(let t=0;t<e;t++){if(!this._meshInfo[t])continue;let e=this._meshInfo[t].meshInstance;e&&(e.setParameter("font_sdfIntensity",this._font.intensity),e.setParameter("font_pxrange",this._getPxRange(this._font)),e.setParameter("font_textureWidth",this._font.data.info.maps[t].width));}}}_onFontRemove(e){}_setTextureParams(e,t){this._font&&(this._font.type===mV?(e.deleteParameter("texture_emissiveMap"),e.deleteParameter("texture_opacityMap"),e.setParameter("texture_msdfMap",t)):this._font.type===mG&&(e.deleteParameter("texture_msdfMap"),e.setParameter("texture_emissiveMap",t),e.setParameter("texture_opacityMap",t)));}_getPxRange(e){let t=Object.keys(this._font.data.chars);for(let e=0;e<t.length;e++){let i=this._font.data.chars[t[e]];if(i.range)return (i.scale||1)*i.range}return 2}_getUv(e){let t=this._font.data;if(!t.chars[e])return t.chars[" "]?this._getUv(" "):[0,0,0,0];let i=t.chars[e].map,s=t.info.maps[i].width,r=t.info.maps[i].height,a=t.chars[e].x,n=t.chars[e].y,o=a+t.chars[e].width,l=n-t.chars[e].height,h=1-t.chars[e].height/r;return [a/s,h-n/r,o/s,h-l/r]}onEnable(){this._fontAsset.autoLoad=true,this._model&&this._element.addModelToLayers(this._model);}onDisable(){this._fontAsset.autoLoad=false,this._model&&this._element.removeModelFromLayers(this._model);}_setStencil(e){if(this._model){let t=this._model.meshInstances;for(let i=0;i<t.length;i++)t[i].stencilFront=e,t[i].stencilBack=e;}}_shouldAutoFitWidth(){return this._autoFitWidth&&!this._autoWidth}_shouldAutoFitHeight(){return this._autoFitHeight&&!this._autoHeight}_shouldAutoFit(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight}_calculateCharsPerTexture(e){let t={};void 0===e&&(e=this._symbols.length);for(let i=0,s=e;i<s;i++){let e=this._symbols[i],s=this._font.data.chars[e];!s&&((s=this._font.data.chars[" "])||(s=this._font.data.chars[Object.keys(this._font.data.chars)[0]]));let r=s.map;t[r]?t[r]++:t[r]=1;}return t}_updateRenderRange(){let e=0===this._rangeStart?0:this._calculateCharsPerTexture(this._rangeStart),t=0===this._rangeEnd?0:this._calculateCharsPerTexture(this._rangeEnd);for(let i=0,s=this._meshInfo.length;i<s;i++){let s=e[i]||0,r=t[i]||0,a=this._meshInfo[i].meshInstance;if(a){let e=a.mesh;e&&(e.primitive[0].base=3*s*2,e.primitive[0].count=(r-s)*6);}}}set text(e){this._i18nKey=null;let t=null!=e&&e.toString()||"";this._setText(t);}get text(){return this._text}set key(e){let t=null!==e?e.toString():null;this._i18nKey!==t&&(this._i18nKey=t,t?(this._fontAsset.disableLocalization=false,this._resetLocalizedText()):this._fontAsset.disableLocalization=true);}get key(){return this._i18nKey}set color(e){let t=e.r,i=e.g,s=e.b;if((this._color.r!==t||this._color.g!==i||this._color.b!==s)&&(this._color.r=t,this._color.g=i,this._color.b=s,this._model)){if(this._symbolColors)this._font&&this._updateText();else {m4.linear(this._color),this._colorUniform[0]=m4.r,this._colorUniform[1]=m4.g,this._colorUniform[2]=m4.b;for(let e=0,t=this._model.meshInstances.length;e<t;e++)this._model.meshInstances[e].setParameter("material_emissive",this._colorUniform);}this._element&&this._element.fire("set:color",this._color);}}get color(){return this._color}set opacity(e){if(this._color.a!==e&&(this._color.a=e,this._model))for(let t=0,i=this._model.meshInstances.length;t<i;t++)this._model.meshInstances[t].setParameter("material_opacity",e);this._element&&this._element.fire("set:opacity",e);}get opacity(){return this._color.a}set lineHeight(e){let t=this._lineHeight;this._lineHeight=e,this._scaledLineHeight=e,t!==e&&this._font&&this._updateText();}get lineHeight(){return this._lineHeight}set wrapLines(e){let t=this._wrapLines;this._wrapLines=e,t!==e&&this._font&&this._updateText();}get wrapLines(){return this._wrapLines}get lines(){return this._lineContents}set spacing(e){let t=this._spacing;this._spacing=e,t!==e&&this._font&&this._updateText();}get spacing(){return this._spacing}set fontSize(e){let t=this._fontSize;this._fontSize=e,this._originalFontSize=e,t!==e&&this._font&&this._updateText();}get fontSize(){return this._fontSize}set fontAsset(e){this._fontAsset.defaultAsset=e;}get fontAsset(){return this._fontAsset.localizedAsset}set font(e){let t;if(this._font&&(t=this._font.type,this._font.off&&this._font.off("render",this._onFontRender,this)),this._font=e,this._fontMinY=0,this._fontMaxY=0,!e)return;let i=this._font.data;for(let e in i.chars){let t=i.chars[e];t.bounds&&(this._fontMinY=Math.min(this._fontMinY,t.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,t.bounds[3]));}if(this._font.on&&this._font.on("render",this._onFontRender,this),this._fontAsset.localizedAsset&&this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null),e.type!==t){let e=this._element._isScreenSpace();this._updateMaterial(e);}for(let e=0,t=this._font.textures.length;e<t;e++)if(this._meshInfo[e]){let t=this._meshInfo[e].meshInstance;t&&(t.setParameter("font_sdfIntensity",this._font.intensity),t.setParameter("font_pxrange",this._getPxRange(this._font)),t.setParameter("font_textureWidth",this._font.data.info.maps[e].width),this._setTextureParams(t,this._font.textures[e]));}else this._meshInfo[e]=new mq;let s=false;for(let e=this._font.textures.length;e<this._meshInfo.length;e++)this._meshInfo[e].meshInstance&&(s||(this._element.removeModelFromLayers(this._model),s=true),this._removeMeshInstance(this._meshInfo[e].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length),this._updateText();}get font(){return this._font}set alignment(e){e instanceof ef?this._alignment.set(e.x,e.y):this._alignment.set(e[0],e[1]),this._font&&this._updateText();}get alignment(){return this._alignment}set autoWidth(e){let t=this._autoWidth;if(this._autoWidth=e,e&&1e-4>Math.abs(this._element.anchor.x-this._element.anchor.z)&&(this._element.width=this.width),t!==e){let e=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;e!==this._fontSize&&(this._fontSize=e,this._font&&this._updateText());}}get autoWidth(){return this._autoWidth}set autoHeight(e){let t=this._autoHeight;if(this._autoHeight=e,e&&1e-4>Math.abs(this._element.anchor.y-this._element.anchor.w)&&(this._element.height=this.height),t!==e){let e=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;e!==this._fontSize&&(this._fontSize=e,this._font&&this._updateText());}}get autoHeight(){return this._autoHeight}set rtlReorder(e){this._rtlReorder!==e&&(this._rtlReorder=e,this._font&&this._updateText());}get rtlReorder(){return this._rtlReorder}set unicodeConverter(e){this._unicodeConverter!==e&&(this._unicodeConverter=e,this._setText(this._text));}get unicodeConverter(){return this._unicodeConverter}get aabb(){if(this._aabbDirty){let e=false;for(let t=0;t<this._meshInfo.length;t++)this._meshInfo[t].meshInstance&&(e?this._aabb.add(this._meshInfo[t].meshInstance.aabb):(this._aabb.copy(this._meshInfo[t].meshInstance.aabb),e=true));this._aabbDirty=false;}return this._aabb}set outlineColor(e){let t=e instanceof es?e.r:e[0],i=e instanceof es?e.g:e[1],s=e instanceof es?e.b:e[2],r=e instanceof es?e.a:e[3];if((this._outlineColor.r!==t||this._outlineColor.g!==i||this._outlineColor.b!==s||this._outlineColor.a!==r)&&(this._outlineColor.r=t,this._outlineColor.g=i,this._outlineColor.b=s,this._outlineColor.a=r,this._model)){if(this._symbolOutlineParams)this._font&&this._updateText();else {m4.linear(this._outlineColor),this._outlineColorUniform[0]=m4.r,this._outlineColorUniform[1]=m4.g,this._outlineColorUniform[2]=m4.b,this._outlineColorUniform[3]=m4.a;for(let e=0,t=this._model.meshInstances.length;e<t;e++)this._model.meshInstances[e].setParameter("outline_color",this._outlineColorUniform);}this._element&&this._element.fire("set:outline",this._color);}}get outlineColor(){return this._outlineColor}set outlineThickness(e){let t=this._outlineThickness;if(this._outlineThickness=e,t!==e&&this._font){if(!this._model)return;if(this._symbolOutlineParams)this._font&&this._updateText();else for(let e=0,t=this._model.meshInstances.length;e<t;e++)this._model.meshInstances[e].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness);}}get outlineThickness(){return this._outlineThickness}set shadowColor(e){let t=e instanceof es?e.r:e[0],i=e instanceof es?e.g:e[1],s=e instanceof es?e.b:e[2],r=e instanceof es?e.a:e[3];if((this._shadowColor.r!==t||this._shadowColor.g!==i||this._shadowColor.b!==s||this._shadowColor.a!==r)&&(this._shadowColor.r=t,this._shadowColor.g=i,this._shadowColor.b=s,this._shadowColor.a=r,this._model))if(this._symbolShadowParams)this._font&&this._updateText();else {m4.linear(this._shadowColor),this._shadowColorUniform[0]=m4.r,this._shadowColorUniform[1]=m4.g,this._shadowColorUniform[2]=m4.b,this._shadowColorUniform[3]=m4.a;for(let e=0,t=this._model.meshInstances.length;e<t;e++)this._model.meshInstances[e].setParameter("shadow_color",this._shadowColorUniform);}}get shadowColor(){return this._shadowColor}set shadowOffset(e){let t=e instanceof ef?e.x:e[0],i=e instanceof ef?e.y:e[1];if((this._shadowOffset.x!==t||this._shadowOffset.y!==i)&&(this._shadowOffset.set(t,i),this._font&&this._model))if(this._symbolShadowParams)this._updateText();else for(let e=0,t=this._model.meshInstances.length;e<t;e++){let t=-this._font.data.info.maps[e].width/this._font.data.info.maps[e].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=t*this._shadowOffsetScale*this._shadowOffset.y,this._model.meshInstances[e].setParameter("shadow_offset",this._shadowOffsetUniform);}}get shadowOffset(){return this._shadowOffset}set minFontSize(e){this._minFontSize!==e&&(this._minFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText());}get minFontSize(){return this._minFontSize}set maxFontSize(e){this._maxFontSize!==e&&(this._maxFontSize=e,this.font&&this._shouldAutoFit()&&this._updateText());}get maxFontSize(){return this._maxFontSize}set autoFitWidth(e){this._autoFitWidth!==e&&(this._autoFitWidth=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText());}get autoFitWidth(){return this._autoFitWidth}set autoFitHeight(e){this._autoFitHeight!==e&&(this._autoFitHeight=e,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText());}get autoFitHeight(){return this._autoFitHeight}set maxLines(e){this._maxLines===e||(null!==e||-1!==this._maxLines)&&(this._maxLines=null===e?-1:e,this.font&&this._wrapLines&&this._updateText());}get maxLines(){return this._maxLines}set enableMarkup(e){if(e=!!e,this._enableMarkup===e)return;this._enableMarkup=e,this.font&&this._updateText();let t=this._element._isScreenSpace();this._updateMaterial(t);}get enableMarkup(){return this._enableMarkup}get symbols(){return this._symbols}get symbolColors(){return null===this._symbolColors?null:this._symbolColors.map(function(e){return this._colorPalette.slice(3*e,3*e+3)},this)}get symbolOutlineParams(){return null===this._symbolOutlineParams?null:this._symbolOutlineParams.map(function(e){return this._outlinePalette.slice(5*e,5*e+5)},this)}get symbolShadowParams(){return null===this._symbolShadowParams?null:this._symbolShadowParams.map(function(e){return this._shadowPalette.slice(6*e,6*e+6)},this)}get rtl(){return this._rtl}set rangeStart(e){(e=Math.max(0,Math.min(e,this._symbols.length)))!==this._rangeStart&&(this._rangeStart=e,this._updateRenderRange());}get rangeStart(){return this._rangeStart}set rangeEnd(e){(e=Math.max(this._rangeStart,Math.min(e,this._symbols.length)))!==this._rangeEnd&&(this._rangeEnd=e,this._updateRenderRange());}get rangeEnd(){return this._rangeEnd}constructor(e){this._element=e,this._system=e.system,this._entity=e.entity,this._text="",this._symbols=[],this._colorPalette=[],this._outlinePalette=[],this._shadowPalette=[],this._symbolColors=null,this._symbolOutlineParams=null,this._symbolShadowParams=null,this._i18nKey=null,this._fontAsset=new mz(this._system.app),this._fontAsset.disableLocalization=true,this._fontAsset.on("load",this._onFontLoad,this),this._fontAsset.on("change",this._onFontChange,this),this._fontAsset.on("remove",this._onFontRemove,this),this._font=null,this._color=new es(1,1,1,1),this._colorUniform=new Float32Array(3),this._spacing=1,this._fontSize=32,this._fontMinY=0,this._fontMaxY=0,this._originalFontSize=32,this._maxFontSize=32,this._minFontSize=8,this._autoFitWidth=false,this._autoFitHeight=false,this._maxLines=-1,this._lineHeight=32,this._scaledLineHeight=32,this._wrapLines=false,this._drawOrder=0,this._alignment=new ef(.5,.5),this._autoWidth=true,this._autoHeight=true,this.width=0,this.height=0,this._node=new oX,this._model=new hA,this._model.graph=this._node,this._entity.addChild(this._node),this._meshInfo=[],this._material=null,this._aabbDirty=true,this._aabb=new eC,this._noResize=false,this._currentMaterialType=null,this._maskedMaterialSrc=null,this._rtlReorder=false,this._unicodeConverter=false,this._rtl=false,this._outlineColor=new es(0,0,0,1),this._outlineColorUniform=new Float32Array(4),this._outlineThicknessScale=.2,this._outlineThickness=0,this._shadowColor=new es(0,0,0,1),this._shadowColorUniform=new Float32Array(4),this._shadowOffsetScale=.005,this._shadowOffset=new ef(0,0),this._shadowOffsetUniform=new Float32Array(2),this._enableMarkup=false,this._onScreenChange(this._element.screen),e.on("resize",this._onParentResize,this),e.on("set:screen",this._onScreenChange,this),e.on("screen:set:screenspace",this._onScreenSpaceChange,this),e.on("set:draworder",this._onDrawOrderChange,this),e.on("set:pivot",this._onPivotChange,this),this._system.app.i18n.on(fR.EVENT_CHANGE,this._onLocaleSet,this),this._system.app.i18n.on("data:add",this._onLocalizationData,this),this._system.app.i18n.on("data:remove",this._onLocalizationData,this),this._rangeStart=0,this._rangeEnd=0,!e._beingInitialized&&e.enabled&&e.entity.enabled&&this.onEnable();}}let m8=new ed,m6=new ey,m9=new ed,m7=new ed,_e=new ey,_t=new ey,_i=new ey,_s=new ey;class _r extends f5{get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){let t=this.data,i=t.enabled;t.enabled=e,this.fire("set","enabled",i,e);}get enabled(){return this.data.enabled}get _absLeft(){return this._localAnchor.x+this._margin.x}get _absRight(){return this._localAnchor.z-this._margin.z}get _absTop(){return this._localAnchor.w-this._margin.w}get _absBottom(){return this._localAnchor.y+this._margin.y}get _hasSplitAnchorsX(){return Math.abs(this._anchor.x-this._anchor.z)>.001}get _hasSplitAnchorsY(){return Math.abs(this._anchor.y-this._anchor.w)>.001}get aabb(){return this._image?this._image.aabb:this._text?this._text.aabb:null}set anchor(e){e instanceof ep?this._anchor.copy(e):this._anchor.set(...e),this.entity._parent||this.screen?this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY):this._calculateLocalAnchors(),this._anchorDirty=true,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:anchor",this._anchor);}get anchor(){return this._anchor}set batchGroupId(e){this._batchGroupId!==e&&(this.entity.enabled&&this._batchGroupId>=0&&this.system.app.batcher?.remove(n2.ELEMENT,this.batchGroupId,this.entity),this.entity.enabled&&e>=0&&this.system.app.batcher?.insert(n2.ELEMENT,e,this.entity),e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=e);}get batchGroupId(){return this._batchGroupId}set bottom(e){this._margin.y=e;let t=this.entity.getLocalPosition(),i=this._absTop,s=this._localAnchor.y+e;this._setHeight(i-s),t.y=e+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(t);}get bottom(){return this._margin.y}set calculatedWidth(e){this._setCalculatedWidth(e,true);}get calculatedWidth(){return this._calculatedWidth}set calculatedHeight(e){this._setCalculatedHeight(e,true);}get calculatedHeight(){return this._calculatedHeight}get canvasCorners(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;let e=this.system.app.graphicsDevice,t=this.screenCorners,i=e.canvas.clientWidth/e.width,s=e.canvas.clientHeight/e.height;for(let r=0;r<4;r++)this._canvasCorners[r].set(t[r].x*i,(e.height-t[r].y)*s);return this._canvasCornersDirty=false,this._canvasCorners}set drawOrder(e){let t=0;this.screen&&(t=this.screen.screen.priority),e>0xffffff&&(e=0xffffff),this._drawOrder=(t<<24)+e,this.fire("set:draworder",this._drawOrder);}get drawOrder(){return this._drawOrder}set height(e){this._height=e,this._hasSplitAnchorsY||this._setCalculatedHeight(e,true),this.fire("set:height",this._height);}get height(){return this._height}set layers(e){if(this._addedModels.length)for(let e=0;e<this._layers.length;e++){let t=this.system.app.scene.layers.getLayerById(this._layers[e]);if(t)for(let e=0;e<this._addedModels.length;e++)t.removeMeshInstances(this._addedModels[e].meshInstances);}if(this._layers=e,this.enabled&&this.entity.enabled&&this._addedModels.length)for(let e=0;e<this._layers.length;e++){let t=this.system.app.scene.layers.getLayerById(this._layers[e]);if(t)for(let e=0;e<this._addedModels.length;e++)t.addMeshInstances(this._addedModels[e].meshInstances);}}get layers(){return this._layers}set left(e){this._margin.x=e;let t=this.entity.getLocalPosition(),i=this._absRight,s=this._localAnchor.x+e;this._setWidth(i-s),t.x=e+this._calculatedWidth*this._pivot.x,this.entity.setLocalPosition(t);}get left(){return this._margin.x}set margin(e){this._margin.copy(e),this._calculateSize(true,true),this.fire("set:margin",this._margin);}get margin(){return this._margin}get maskedBy(){return this._maskedBy}set pivot(e){let{pivot:t,margin:i}=this,s=t.x,r=t.y;e instanceof ef?t.copy(e):t.set(...e);let a=i.x+i.z,n=t.x-s;i.x+=a*n,i.z-=a*n;let o=i.y+i.w,l=t.y-r;i.y+=o*l,i.w-=o*l,this._anchorDirty=true,this._cornersDirty=true,this._worldCornersDirty=true,this._calculateSize(false,false),this._flagChildrenAsDirty(),this.fire("set:pivot",t);}get pivot(){return this._pivot}set right(e){this._margin.z=e;let t=this.entity.getLocalPosition(),i=this._absLeft,s=this._localAnchor.z-e;this._setWidth(s-i),t.x=this._localAnchor.z-this._localAnchor.x-e-this._calculatedWidth*(1-this._pivot.x),this.entity.setLocalPosition(t);}get right(){return this._margin.z}get screenCorners(){if(!this._cornersDirty||!this.screen)return this._screenCorners;let e=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0),this._screenCorners[1].set(this._absRight,this._absBottom,0),this._screenCorners[2].set(this._absRight,this._absTop,0),this._screenCorners[3].set(this._absLeft,this._absTop,0);let t=this.screen.screen.screenSpace;for(let i=0;i<4;i++)this._screenTransform.transformPoint(this._screenCorners[i],this._screenCorners[i]),t&&this._screenCorners[i].mulScalar(this.screen.screen.scale),e&&this._screenCorners[i].add(e);return this._cornersDirty=false,this._canvasCornersDirty=true,this._worldCornersDirty=true,this._screenCorners}get textWidth(){return this._text?this._text.width:0}get textHeight(){return this._text?this._text.height:0}set top(e){this._margin.w=e;let t=this.entity.getLocalPosition(),i=this._absBottom,s=this._localAnchor.w-e;this._setHeight(s-i),t.y=this._localAnchor.w-this._localAnchor.y-e-this._calculatedHeight*(1-this._pivot.y),this.entity.setLocalPosition(t);}get top(){return this._margin.w}set type(e){e!==this._type&&(this._type=e,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),e===p8?this._image=new mU(this):e===p6&&(this._text=new m5(this)));}get type(){return this._type}set useInput(e){this._useInput!==e&&(this._useInput=e,this.system.app.elementInput?e?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this):this._useInput,this.fire("set:useInput",e));}get useInput(){return this._useInput}set fitMode(e){this._fitMode=e,this._calculateSize(true,true),this._image&&this._image.refreshMesh();}get fitMode(){return this._fitMode}set width(e){this._width=e,this._hasSplitAnchorsX||this._setCalculatedWidth(e,true),this.fire("set:width",this._width);}get width(){return this._width}get worldCorners(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){let e=this.screenCorners;if(!this.screen.screen.screenSpace){_e.copy(this.screen.screen._screenMatrix),_e.data[13]=-_e.data[13],_e.mul2(this.screen.getWorldTransform(),_e);for(let t=0;t<4;t++)_e.transformPoint(e[t],this._worldCorners[t]);}}else {let e=this.entity.getLocalPosition();_e.setTranslate(-e.x,-e.y,-e.z),_t.setTRS(ed.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),_i.setTranslate(e.x,e.y,e.z);let t=this.entity.parent?this.entity.parent:this.entity;_s.copy(t.getWorldTransform()),_s.mul(_i).mul(_t).mul(_e),m9.set(e.x-this.pivot.x*this.calculatedWidth,e.y-this.pivot.y*this.calculatedHeight,e.z),_s.transformPoint(m9,this._worldCorners[0]),m9.set(e.x+(1-this.pivot.x)*this.calculatedWidth,e.y-this.pivot.y*this.calculatedHeight,e.z),_s.transformPoint(m9,this._worldCorners[1]),m9.set(e.x+(1-this.pivot.x)*this.calculatedWidth,e.y+(1-this.pivot.y)*this.calculatedHeight,e.z),_s.transformPoint(m9,this._worldCorners[2]),m9.set(e.x-this.pivot.x*this.calculatedWidth,e.y+(1-this.pivot.y)*this.calculatedHeight,e.z),_s.transformPoint(m9,this._worldCorners[3]);}return this._worldCornersDirty=false,this._worldCorners}set fontSize(e){this._setValue("fontSize",e);}get fontSize(){return this._text?this._text.fontSize:null}set minFontSize(e){this._setValue("minFontSize",e);}get minFontSize(){return this._text?this._text.minFontSize:null}set maxFontSize(e){this._setValue("maxFontSize",e);}get maxFontSize(){return this._text?this._text.maxFontSize:null}set maxLines(e){this._setValue("maxLines",e);}get maxLines(){return this._text?this._text.maxLines:null}set autoFitWidth(e){this._setValue("autoFitWidth",e);}get autoFitWidth(){return this._text?this._text.autoFitWidth:null}set autoFitHeight(e){this._setValue("autoFitHeight",e);}get autoFitHeight(){return this._text?this._text.autoFitHeight:null}set color(e){this._setValue("color",e);}get color(){return this._text?this._text.color:this._image?this._image.color:null}set font(e){this._setValue("font",e);}get font(){return this._text?this._text.font:null}set fontAsset(e){this._setValue("fontAsset",e);}get fontAsset(){return this._text&&"number"==typeof this._text.fontAsset?this._text.fontAsset:null}set spacing(e){this._setValue("spacing",e);}get spacing(){return this._text?this._text.spacing:null}set lineHeight(e){this._setValue("lineHeight",e);}get lineHeight(){return this._text?this._text.lineHeight:null}set wrapLines(e){this._setValue("wrapLines",e);}get wrapLines(){return this._text?this._text.wrapLines:null}set lines(e){this._setValue("lines",e);}get lines(){return this._text?this._text.lines:null}set alignment(e){this._setValue("alignment",e);}get alignment(){return this._text?this._text.alignment:null}set autoWidth(e){this._setValue("autoWidth",e);}get autoWidth(){return this._text?this._text.autoWidth:null}set autoHeight(e){this._setValue("autoHeight",e);}get autoHeight(){return this._text?this._text.autoHeight:null}set rtlReorder(e){this._setValue("rtlReorder",e);}get rtlReorder(){return this._text?this._text.rtlReorder:null}set unicodeConverter(e){this._setValue("unicodeConverter",e);}get unicodeConverter(){return this._text?this._text.unicodeConverter:null}set text(e){this._setValue("text",e);}get text(){return this._text?this._text.text:null}set key(e){this._setValue("key",e);}get key(){return this._text?this._text.key:null}set texture(e){this._setValue("texture",e);}get texture(){return this._image?this._image.texture:null}set textureAsset(e){this._setValue("textureAsset",e);}get textureAsset(){return this._image?this._image.textureAsset:null}set material(e){this._setValue("material",e);}get material(){return this._image?this._image.material:null}set materialAsset(e){this._setValue("materialAsset",e);}get materialAsset(){return this._image?this._image.materialAsset:null}set sprite(e){this._setValue("sprite",e);}get sprite(){return this._image?this._image.sprite:null}set spriteAsset(e){this._setValue("spriteAsset",e);}get spriteAsset(){return this._image?this._image.spriteAsset:null}set spriteFrame(e){this._setValue("spriteFrame",e);}get spriteFrame(){return this._image?this._image.spriteFrame:null}set pixelsPerUnit(e){this._setValue("pixelsPerUnit",e);}get pixelsPerUnit(){return this._image?this._image.pixelsPerUnit:null}set opacity(e){this._setValue("opacity",e);}get opacity(){return this._text?this._text.opacity:this._image?this._image.opacity:null}set rect(e){this._setValue("rect",e);}get rect(){return this._image?this._image.rect:null}set mask(e){this._setValue("mask",e);}get mask(){return this._image?this._image.mask:null}set outlineColor(e){this._setValue("outlineColor",e);}get outlineColor(){return this._text?this._text.outlineColor:null}set outlineThickness(e){this._setValue("outlineThickness",e);}get outlineThickness(){return this._text?this._text.outlineThickness:null}set shadowColor(e){this._setValue("shadowColor",e);}get shadowColor(){return this._text?this._text.shadowColor:null}set shadowOffset(e){this._setValue("shadowOffset",e);}get shadowOffset(){return this._text?this._text.shadowOffset:null}set enableMarkup(e){this._setValue("enableMarkup",e);}get enableMarkup(){return this._text?this._text.enableMarkup:null}set rangeStart(e){this._setValue("rangeStart",e);}get rangeStart(){return this._text?this._text.rangeStart:null}set rangeEnd(e){this._setValue("rangeEnd",e);}get rangeEnd(){return this._text?this._text.rangeEnd:null}_setValue(e,t){this._text?(this._text[e]!==t&&this._dirtyBatch(),this._text[e]=t):this._image&&(this._image[e]!==t&&this._dirtyBatch(),this._image[e]=t);}_patch(){this.entity._sync=this._sync,this.entity.setPosition=this._setPosition,this.entity.setLocalPosition=this._setLocalPosition;}_unpatch(){this.entity._sync=fB.prototype._sync,this.entity.setPosition=fB.prototype.setPosition,this.entity.setLocalPosition=fB.prototype.setLocalPosition;}_setPosition(e,t,i){this.element.screen?(e instanceof ed?m8.copy(e):m8.set(e,t,i),this.getWorldTransform(),m6.copy(this.element._screenToWorld).invert(),m6.transformPoint(m8,this.localPosition),this._dirtyLocal||this._dirtifyLocal()):fB.prototype.setPosition.call(this,e,t,i);}_setLocalPosition(e,t,i){e instanceof ed?this.localPosition.copy(e):this.localPosition.set(e,t,i);let s=this.element,r=this.localPosition,a=s._pivot;s._margin.x=r.x-s._calculatedWidth*a.x,s._margin.z=s._localAnchor.z-s._localAnchor.x-s._calculatedWidth-s._margin.x,s._margin.y=r.y-s._calculatedHeight*a.y,s._margin.w=s._localAnchor.w-s._localAnchor.y-s._calculatedHeight-s._margin.y,this._dirtyLocal||this._dirtifyLocal();}_sync(){let e=this.element,t=e.screen;if(t){if(e._anchorDirty){let i=0,s=0,r=0,a=1;if(this._parent&&this._parent.element)i=this._parent.element.calculatedWidth,s=this._parent.element.calculatedHeight,r=this._parent.element.pivot.x,a=this._parent.element.pivot.y;else {let e=t.screen.resolution;i=e.x/t.screen.scale,s=e.y/t.screen.scale;}e._anchorTransform.setTranslate(i*(e.anchor.x-r),-(s*(a-e.anchor.y)),0),e._anchorDirty=false,e._calculateLocalAnchors();}e._sizeDirty&&e._calculateSize(false,false);}if(this._dirtyLocal){this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale);let t=this.localPosition,i=e._pivot;e._margin.x=t.x-e._calculatedWidth*i.x,e._margin.z=e._localAnchor.z-e._localAnchor.x-e._calculatedWidth-e._margin.x,e._margin.y=t.y-e._calculatedHeight*i.y,e._margin.w=e._localAnchor.w-e._localAnchor.y-e._calculatedHeight-e._margin.y,this._dirtyLocal=false;}if(!t){this._dirtyWorld&&(e._cornersDirty=true,e._canvasCornersDirty=true,e._worldCornersDirty=true),fB.prototype._sync.call(this);return}if(this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this._parent.element?e._screenToWorld.mul2(this._parent.element._modelTransform,e._anchorTransform):e._screenToWorld.copy(e._anchorTransform),e._modelTransform.mul2(e._screenToWorld,this.localTransform),t){e._screenToWorld.mul2(t.screen._screenMatrix,e._screenToWorld),t.screen.screenSpace||e._screenToWorld.mul2(t.worldTransform,e._screenToWorld),this.worldTransform.mul2(e._screenToWorld,this.localTransform);let i=e._parentWorldTransform;i.setIdentity();let s=this._parent;s&&s.element&&s!==t&&(_e.setTRS(ed.ZERO,s.getLocalRotation(),s.getLocalScale()),i.mul2(s.element._parentWorldTransform,_e)),m9.set(0,0,this.localPosition.z),m7.set(e._absLeft+e._pivot.x*e.calculatedWidth,e._absBottom+e._pivot.y*e.calculatedHeight,0),_e.setTranslate(-m7.x,-m7.y,-m7.z),_t.setTRS(m9,this.getLocalRotation(),this.getLocalScale()),_i.setTranslate(m7.x,m7.y,m7.z),e._screenTransform.mul2(e._parentWorldTransform,_i).mul(_t).mul(_e),e._cornersDirty=true,e._canvasCornersDirty=true,e._worldCornersDirty=true;}else this.worldTransform.copy(e._modelTransform);this._dirtyWorld=false;}}_onInsert(e){let t=this._parseUpToScreen();this.entity._dirtifyWorld(),this._updateScreen(t.screen),this._dirtifyMask();}_dirtifyMask(){let e=this.entity;for(;e;){let t=e.parent;if((null===t||t.screen)&&e.element){this.system._prerender&&this.system._prerender.length||(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));let t=this.system._prerender.indexOf(this.entity);t>=0&&this.system._prerender.splice(t,1),0>this.system._prerender.indexOf(e)&&this.system._prerender.push(e);}e=t;}}_onPrerender(){for(let e=0;e<this.system._prerender.length;e++){let t=this.system._prerender[e];t.element&&t.element.syncMask(1);}this.system._prerender.length=0;}_bindScreen(e){e._bindElement(this);}_unbindScreen(e){e._unbindElement(this);}_updateScreen(e){this.screen&&this.screen!==e&&this._unbindScreen(this.screen.screen);let t=this.screen;this.screen=e,this.screen&&this._bindScreen(this.screen.screen),this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("set:screen",this.screen,t),this._anchorDirty=true;let i=this.entity.children;for(let t=0,s=i.length;t<s;t++)i[t].element&&i[t].element._updateScreen(e);this.screen&&this.screen.screen.syncDrawOrder();}syncMask(e){let t=this._parseUpToScreen();this._updateMask(t.mask,e);}_setMaskedBy(e){let t=this._image||this._text;if(e){let i=e.element._image._maskRef;t?._setStencil(new iN({ref:i,func:2})),this._maskedBy=e;}else t?._setStencil(null),this._maskedBy=null;}_updateMask(e,t){if(e){if(this._setMaskedBy(e),this.mask){let i=new iN({ref:e.element._image._maskRef,func:2,zpass:3});this._image._setStencil(i),this._image._maskRef=t,t++,e=this.entity;}let i=this.entity.children;for(let s=0,r=i.length;s<r;s++)i[s].element?._updateMask(e,t);this.mask&&t--;}else {if(this._setMaskedBy(null),this.mask){let i=new iN({ref:t,func:7,zpass:2});this._image._setStencil(i),this._image._maskRef=t,t++,e=this.entity;}let i=this.entity.children;for(let s=0,r=i.length;s<r;s++)i[s].element?._updateMask(e,t);this.mask&&t--;}}_parseUpToScreen(){let e={screen:null,mask:null},t=this.entity._parent;for(;t&&!t.screen;)t.element&&t.element.mask&&!e.mask&&(e.mask=t),t=t.parent;return t&&t.screen&&(e.screen=t),e}_onScreenResize(e){this._anchorDirty=true,this._cornersDirty=true,this._worldCornersDirty=true,this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("screen:set:resolution",e);}_onScreenSpaceChange(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace);}_onScreenRemove(){this.screen&&(this.screen._destroying?this.screen=null:this._updateScreen(null));}_calculateLocalAnchors(){let e=1e3,t=1e3,i=this.entity._parent;if(i&&i.element)e=i.element.calculatedWidth,t=i.element.calculatedHeight;else if(this.screen){let i=this.screen.screen.resolution,s=this.screen.screen.scale;e=i.x/s,t=i.y/s;}this._localAnchor.set(this._anchor.x*e,this._anchor.y*t,this._anchor.z*e,this._anchor.w*t);}getOffsetPosition(e,t){let i=this.entity.getLocalPosition().clone();return i.x+=e,i.y+=t,this._screenToWorld.transformPoint(i,i),i}onLayersChanged(e,t){this.addModelToLayers(this._image?this._image._renderable.model:this._text._model),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);}onLayerAdded(e){!(0>this.layers.indexOf(e.id))&&(this._image?e.addMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.addMeshInstances(this._text._model.meshInstances));}onLayerRemoved(e){!(0>this.layers.indexOf(e.id))&&(this._image?e.removeMeshInstances(this._image._renderable.model.meshInstances):this._text&&e.removeMeshInstances(this._text._model.meshInstances));}onEnable(){let e=this.system.app.scene,t=e.layers;this._image&&this._image.onEnable(),this._text&&this._text.onEnable(),this._group&&this._group.onEnable(),this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this),this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this._batchGroupId>=0&&this.system.app.batcher?.insert(n2.ELEMENT,this.batchGroupId,this.entity),this.fire("enableelement");}onDisable(){let e=this.system.app.scene.layers;this._evtLayersChanged?.off(),this._evtLayersChanged=null,e&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this._image&&this._image.onDisable(),this._text&&this._text.onDisable(),this._group&&this._group.onDisable(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this._batchGroupId>=0&&this.system.app.batcher?.remove(n2.ELEMENT,this.batchGroupId,this.entity),this.fire("disableelement");}onRemove(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder()),this.off();}_calculateSize(e,t){if(!this.entity._parent&&!this.screen)return;this._calculateLocalAnchors();let i=this._absRight-this._absLeft,s=this._absTop-this._absBottom;e?this._setWidth(i):this._setCalculatedWidth(i,false),t?this._setHeight(s):this._setCalculatedHeight(s,false);let r=this.entity.getLocalPosition();r.x=this._margin.x+this._calculatedWidth*this._pivot.x,r.y=this._margin.y+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(r),this._sizeDirty=false;}_setWidth(e){this._width=e,this._setCalculatedWidth(e,false),this.fire("set:width",this._width);}_setHeight(e){this._height=e,this._setCalculatedHeight(e,false),this.fire("set:height",this._height);}_setCalculatedWidth(e,t){if(!(1e-4>=Math.abs(e-this._calculatedWidth))){if(this._calculatedWidth=e,this.entity._dirtifyLocal(),t){let e=this.entity.getLocalPosition(),t=this._pivot;this._margin.x=e.x-this._calculatedWidth*t.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x;}this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight);}}_setCalculatedHeight(e,t){if(!(1e-4>=Math.abs(e-this._calculatedHeight))){if(this._calculatedHeight=e,this.entity._dirtifyLocal(),t){let e=this.entity.getLocalPosition(),t=this._pivot;this._margin.y=e.y-this._calculatedHeight*t.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y;}this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight);}}_flagChildrenAsDirty(){let e=this.entity._children;for(let t=0,i=e.length;t<i;t++)e[t].element&&(e[t].element._anchorDirty=true,e[t].element._sizeDirty=true);}addModelToLayers(e){this._addedModels.push(e);for(let t=0;t<this.layers.length;t++){let i=this.system.app.scene.layers.getLayerById(this.layers[t]);i&&i.addMeshInstances(e.meshInstances);}}removeModelFromLayers(e){let t=this._addedModels.indexOf(e);t>=0&&this._addedModels.splice(t,1);for(let t=0;t<this.layers.length;t++){let i=this.system.app.scene.layers.getLayerById(this.layers[t]);i&&i.removeMeshInstances(e.meshInstances);}}getMaskOffset(){let e=this.system.app.frame;this._offsetReadAt!==e&&(this._maskOffset=.5,this._offsetReadAt=e);let t=this._maskOffset;return this._maskOffset-=.001,t}isVisibleForCamera(e){let t,i,s,r;if(this.maskedBy){let e=this.maskedBy.element.screenCorners;t=Math.min(Math.min(e[0].x,e[1].x),Math.min(e[2].x,e[3].x)),i=Math.max(Math.max(e[0].x,e[1].x),Math.max(e[2].x,e[3].x)),r=Math.min(Math.min(e[0].y,e[1].y),Math.min(e[2].y,e[3].y)),s=Math.max(Math.max(e[0].y,e[1].y),Math.max(e[2].y,e[3].y));}else {let a=this.system.app.graphicsDevice.width,n=this.system.app.graphicsDevice.height,o=e._rect.z*a,l=e._rect.w*n;i=(t=e._rect.x*a)+o,r=(s=(1-e._rect.y)*n)-l;}let a=this.screenCorners,n=Math.min(Math.min(a[0].x,a[1].x),Math.min(a[2].x,a[3].x)),o=Math.max(Math.max(a[0].x,a[1].x),Math.max(a[2].x,a[3].x)),l=Math.min(Math.min(a[0].y,a[1].y),Math.min(a[2].y,a[3].y)),h=Math.max(Math.max(a[0].y,a[1].y),Math.max(a[2].y,a[3].y));return !(o<t)&&!(n>i)&&!(l>s)&&!(h<r)}_isScreenSpace(){return !!this.screen&&!!this.screen.screen&&this.screen.screen.screenSpace}_isScreenCulled(){return !!this.screen&&!!this.screen.screen&&this.screen.screen.cull}_dirtyBatch(){ -1!==this.batchGroupId&&this.system.app.batcher?.markGroupDirty(this.batchGroupId);}constructor(e,t){super(e,t),this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._beingInitialized=false,this._anchor=new ep,this._localAnchor=new ep,this._pivot=new ef,this._width=this._calculatedWidth=32,this._height=this._calculatedHeight=32,this._margin=new ep(0,0,-32,-32),this._modelTransform=new ey,this._screenToWorld=new ey,this._anchorTransform=new ey,this._anchorDirty=true,this._parentWorldTransform=new ey,this._screenTransform=new ey,this._screenCorners=[new ed,new ed,new ed,new ed],this._canvasCorners=[new ef,new ef,new ef,new ef],this._worldCorners=[new ed,new ed,new ed,new ed],this._cornersDirty=true,this._canvasCornersDirty=true,this._worldCornersDirty=true,this.entity.on("insert",this._onInsert,this),this._patch(),this.screen=null,this._type=p5,this._image=null,this._text=null,this._group=null,this._drawOrder=0,this._fitMode=p9,this._useInput=false,this._layers=[4],this._addedModels=[],this._batchGroupId=-1,this._offsetReadAt=0,this._maskOffset=.5,this._maskedBy=null;}}_r.EVENT_MOUSEDOWN="mousedown",_r.EVENT_MOUSEUP="mouseup",_r.EVENT_MOUSEENTER="mouseenter",_r.EVENT_MOUSELEAVE="mouseleave",_r.EVENT_MOUSEMOVE="mousemove",_r.EVENT_MOUSEWHEEL="mousewheel",_r.EVENT_CLICK="click",_r.EVENT_TOUCHSTART="touchstart",_r.EVENT_TOUCHEND="touchend",_r.EVENT_TOUCHMOVE="touchmove",_r.EVENT_TOUCHCANCEL="touchcancel";class _a{constructor(){this.enabled=true;}}let _n=["enabled"];class _o extends f8{destroy(){super.destroy(),this._defaultTexture.destroy();}initializeComponentData(e,t,i){let s;e._beingInitialized=true,void 0!==t.anchor&&(t.anchor instanceof ep?e.anchor.copy(t.anchor):e.anchor.set(t.anchor[0],t.anchor[1],t.anchor[2],t.anchor[3])),void 0!==t.pivot&&(t.pivot instanceof ef?e.pivot.copy(t.pivot):e.pivot.set(t.pivot[0],t.pivot[1]));let r=Math.abs(e.anchor.x-e.anchor.z)>.001,a=Math.abs(e.anchor.y-e.anchor.w)>.001,n=false;void 0!==t.margin&&(t.margin instanceof ep?e.margin.copy(t.margin):e._margin.set(t.margin[0],t.margin[1],t.margin[2],t.margin[3]),n=true),void 0!==t.left&&(e._margin.x=t.left,n=true),void 0!==t.bottom&&(e._margin.y=t.bottom,n=true),void 0!==t.right&&(e._margin.z=t.right,n=true),void 0!==t.top&&(e._margin.w=t.top,n=true),n&&(e.margin=e._margin);let o=false;void 0===t.width||r?r&&(o=true):e.width=t.width,void 0===t.height||a?a&&(o=true):e.height=t.height,o&&(e.anchor=e.anchor),void 0!==t.enabled&&(e.enabled=t.enabled),void 0!==t.useInput&&(e.useInput=t.useInput),void 0!==t.fitMode&&(e.fitMode=t.fitMode),e.batchGroupId=void 0===t.batchGroupId||null===t.batchGroupId?-1:t.batchGroupId,t.layers&&Array.isArray(t.layers)&&(e.layers=t.layers.slice(0)),void 0!==t.type&&(e.type=t.type),e.type===p8?(void 0!==t.rect&&(e.rect=t.rect),void 0!==t.color&&((s=t.color)instanceof es||(s=new es(t.color[0],t.color[1],t.color[2])),e.color=s),void 0!==t.opacity&&(e.opacity=t.opacity),void 0!==t.textureAsset&&(e.textureAsset=t.textureAsset),t.texture&&(e.texture=t.texture),void 0!==t.spriteAsset&&(e.spriteAsset=t.spriteAsset),t.sprite&&(e.sprite=t.sprite),void 0!==t.spriteFrame&&(e.spriteFrame=t.spriteFrame),void 0!==t.pixelsPerUnit&&null!==t.pixelsPerUnit&&(e.pixelsPerUnit=t.pixelsPerUnit),void 0!==t.materialAsset&&(e.materialAsset=t.materialAsset),t.material&&(e.material=t.material),void 0!==t.mask&&(e.mask=t.mask)):e.type===p6&&(void 0!==t.autoWidth&&(e.autoWidth=t.autoWidth),void 0!==t.autoHeight&&(e.autoHeight=t.autoHeight),void 0!==t.rtlReorder&&(e.rtlReorder=t.rtlReorder),void 0!==t.unicodeConverter&&(e.unicodeConverter=t.unicodeConverter),null!==t.text&&void 0!==t.text?e.text=t.text:null!==t.key&&void 0!==t.key&&(e.key=t.key),void 0!==t.color&&((s=t.color)instanceof es||(s=new es(s[0],s[1],s[2])),e.color=s),void 0!==t.opacity&&(e.opacity=t.opacity),void 0!==t.spacing&&(e.spacing=t.spacing),void 0!==t.fontSize&&(e.fontSize=t.fontSize,t.lineHeight||(e.lineHeight=t.fontSize)),void 0!==t.lineHeight&&(e.lineHeight=t.lineHeight),void 0!==t.maxLines&&(e.maxLines=t.maxLines),void 0!==t.wrapLines&&(e.wrapLines=t.wrapLines),void 0!==t.minFontSize&&(e.minFontSize=t.minFontSize),void 0!==t.maxFontSize&&(e.maxFontSize=t.maxFontSize),t.autoFitWidth&&(e.autoFitWidth=t.autoFitWidth),t.autoFitHeight&&(e.autoFitHeight=t.autoFitHeight),void 0!==t.fontAsset&&(e.fontAsset=t.fontAsset),void 0!==t.font&&(e.font=t.font),void 0!==t.alignment&&(e.alignment=t.alignment),void 0!==t.outlineColor&&(e.outlineColor=t.outlineColor),void 0!==t.outlineThickness&&(e.outlineThickness=t.outlineThickness),void 0!==t.shadowColor&&(e.shadowColor=t.shadowColor),void 0!==t.shadowOffset&&(e.shadowOffset=t.shadowOffset),void 0!==t.enableMarkup&&(e.enableMarkup=t.enableMarkup));let l=e._parseUpToScreen();l.screen&&e._updateScreen(l.screen),super.initializeComponentData(e,t,i),e._beingInitialized=false,e.type===p8&&e._image._meshDirty&&e._image._updateMesh(e._image.mesh);}onAddComponent(e,t){e.fire("element:add");}onRemoveComponent(e,t){t.onRemove();}cloneComponent(e,t){let i=e.element,s={enabled:i.enabled,width:i.width,height:i.height,anchor:i.anchor.clone(),pivot:i.pivot.clone(),margin:i.margin.clone(),alignment:i.alignment&&i.alignment.clone()||i.alignment,autoWidth:i.autoWidth,autoHeight:i.autoHeight,type:i.type,rect:i.rect&&i.rect.clone()||i.rect,rtlReorder:i.rtlReorder,unicodeConverter:i.unicodeConverter,materialAsset:i.materialAsset,material:i.material,color:i.color&&i.color.clone()||i.color,opacity:i.opacity,textureAsset:i.textureAsset,texture:i.texture,spriteAsset:i.spriteAsset,sprite:i.sprite,spriteFrame:i.spriteFrame,pixelsPerUnit:i.pixelsPerUnit,spacing:i.spacing,lineHeight:i.lineHeight,wrapLines:i.wrapLines,layers:i.layers,fontSize:i.fontSize,minFontSize:i.minFontSize,maxFontSize:i.maxFontSize,autoFitWidth:i.autoFitWidth,autoFitHeight:i.autoFitHeight,maxLines:i.maxLines,fontAsset:i.fontAsset,font:i.font,useInput:i.useInput,fitMode:i.fitMode,batchGroupId:i.batchGroupId,mask:i.mask,outlineColor:i.outlineColor&&i.outlineColor.clone()||i.outlineColor,outlineThickness:i.outlineThickness,shadowColor:i.shadowColor&&i.shadowColor.clone()||i.shadowColor,shadowOffset:i.shadowOffset&&i.shadowOffset.clone()||i.shadowOffset,enableMarkup:i.enableMarkup};return void 0!==i.key&&null!==i.key?s.key=i.key:s.text=i.text,this.addComponent(t,s)}getTextElementMaterial(e,t,i){let s=(e&&1)|(t&&2)|(i&&4),r=this._defaultTextMaterials[s];if(r)return r;let a="TextMaterial";return r=new d0,t?(r.msdfMap=this._defaultTexture,r.msdfTextAttribute=i,r.emissive.set(1,1,1)):(a=`Bitmap${a}`,r.emissive.set(1,1,1),r.emissiveMap=this._defaultTexture,r.opacityMap=this._defaultTexture,r.opacityMapChannel="a"),e&&(a=`ScreenSpace${a}`,r.depthTest=false),r.name=`default${a}`,r.useLighting=false,r.useTonemap=false,r.useFog=false,r.useSkybox=false,r.diffuse.set(0,0,0),r.opacity=.5,r.blendType=4,r.depthWrite=false,r.emissiveVertexColor=true,r.update(),this._defaultTextMaterials[s]=r,r}_createBaseImageMaterial(){let e=new d0;return e.diffuse.set(0,0,0),e.emissive.set(1,1,1),e.emissiveMap=this._defaultTexture,e.opacityMap=this._defaultTexture,e.opacityMapChannel="a",e.useLighting=false,e.useTonemap=false,e.useFog=false,e.useSkybox=false,e.blendType=4,e.depthWrite=false,e}getImageElementMaterial(e,t,i,s){if(e)if(t)if(i)return this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=false,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=false,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=false,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=false,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=false,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial;else if(s)return this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=false,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=false,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=false,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=false,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=false,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial;else return this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=false,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=false,this.defaultScreenSpaceImageMaskMaterial.greenWrite=false,this.defaultScreenSpaceImageMaskMaterial.blueWrite=false,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=false,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial)),this.defaultScreenSpaceImageMaskMaterial;else if(i)return this.defaultScreenSpaceImage9SlicedMaterial||(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=false,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial;else if(s)return this.defaultScreenSpaceImage9TiledMaterial||(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImage9TiledMaterial.depthTest=false,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial;else return this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",this.defaultScreenSpaceImageMaterial.depthTest=false,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial)),this.defaultScreenSpaceImageMaterial;if(t)if(i)return this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaskMaterial.alphaTest=1,this.defaultImage9SlicedMaskMaterial.redWrite=false,this.defaultImage9SlicedMaskMaterial.greenWrite=false,this.defaultImage9SlicedMaskMaterial.blueWrite=false,this.defaultImage9SlicedMaskMaterial.alphaWrite=false,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial;else if(s)return this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=2,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=false,this.defaultImage9TiledMaskMaterial.greenWrite=false,this.defaultImage9TiledMaskMaterial.blueWrite=false,this.defaultImage9TiledMaskMaterial.alphaWrite=false,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial;else return this.defaultImageMaskMaterial||(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=false,this.defaultImageMaskMaterial.greenWrite=false,this.defaultImageMaskMaterial.blueWrite=false,this.defaultImageMaskMaterial.alphaWrite=false,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial)),this.defaultImageMaskMaterial;return i?(this.defaultImage9SlicedMaterial||(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial):s?(this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",this.defaultImage9TiledMaterial.nineSlicedMode=2,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial):(this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial)),this.defaultImageMaterial)}registerUnicodeConverter(e){this._unicodeConverter=e;}registerRtlReorder(e){this._rtlReorder=e;}getUnicodeConverter(){return this._unicodeConverter}getRtlReorder(){return this._rtlReorder}constructor(e){super(e),this.id="element",this.ComponentType=_r,this.DataType=_a,this.schema=_n,this._unicodeConverter=null,this._rtlReorder=null,this._defaultTexture=new ih(e.graphicsDevice,{width:1,height:1,format:20,name:"element-system"});let t=this._defaultTexture.lock(),i=new Uint8Array(4);i[0]=255,i[1]=255,i[2]=255,i[3]=255,t.set(i),this._defaultTexture.unlock(),this.defaultImageMaterial=null,this.defaultImage9SlicedMaterial=null,this.defaultImage9TiledMaterial=null,this.defaultImageMaskMaterial=null,this.defaultImage9SlicedMaskMaterial=null,this.defaultImage9TiledMaskMaterial=null,this.defaultScreenSpaceImageMaterial=null,this.defaultScreenSpaceImage9SlicedMaterial=null,this.defaultScreenSpaceImage9TiledMaterial=null,this.defaultScreenSpaceImageMask9SlicedMaterial=null,this.defaultScreenSpaceImageMask9TiledMaterial=null,this.defaultScreenSpaceImageMaskMaterial=null,this._defaultTextMaterials={},this.defaultImageMaterials=[],this.on("add",this.onAddComponent,this),this.on("beforeremove",this.onRemoveComponent,this);}}let _l="free",_h="limited",_c="locked",_d=["angularDampingX","angularDampingY","angularDampingZ","angularEquilibriumX","angularEquilibriumY","angularEquilibriumZ","angularLimitsX","angularLimitsY","angularLimitsZ","angularMotionX","angularMotionY","angularMotionZ","angularSpringX","angularSpringY","angularSpringZ","angularStiffnessX","angularStiffnessY","angularStiffnessZ","breakForce","enableCollision","enabled","entityA","entityB","linearDampingX","linearDampingY","linearDampingZ","linearEquilibriumX","linearEquilibriumY","linearEquilibriumZ","linearLimitsX","linearLimitsY","linearLimitsZ","linearMotionX","linearMotionY","linearMotionZ","linearSpringX","linearSpringY","linearSpringZ","linearStiffnessX","linearStiffnessY","linearStiffnessZ"];class _u extends f5{set entityA(e){this._destroyConstraint(),this._entityA=e,this._createConstraint();}get entityA(){return this._entityA}set entityB(e){this._destroyConstraint(),this._entityB=e,this._createConstraint();}get entityB(){return this._entityB}set breakForce(e){this._constraint&&this._breakForce!==e&&(this._constraint.setBreakingImpulseThreshold(e),this._breakForce=e);}get breakForce(){return this._breakForce}set enableCollision(e){this._destroyConstraint(),this._enableCollision=e,this._createConstraint();}get enableCollision(){return this._enableCollision}set angularLimitsX(e){this._angularLimitsX.equals(e)||(this._angularLimitsX.copy(e),this._updateAngularLimits());}get angularLimitsX(){return this._angularLimitsX}set angularMotionX(e){this._angularMotionX!==e&&(this._angularMotionX=e,this._updateAngularLimits());}get angularMotionX(){return this._angularMotionX}set angularLimitsY(e){this._angularLimitsY.equals(e)||(this._angularLimitsY.copy(e),this._updateAngularLimits());}get angularLimitsY(){return this._angularLimitsY}set angularMotionY(e){this._angularMotionY!==e&&(this._angularMotionY=e,this._updateAngularLimits());}get angularMotionY(){return this._angularMotionY}set angularLimitsZ(e){this._angularLimitsZ.equals(e)||(this._angularLimitsZ.copy(e),this._updateAngularLimits());}get angularLimitsZ(){return this._angularLimitsZ}set angularMotionZ(e){this._angularMotionZ!==e&&(this._angularMotionZ=e,this._updateAngularLimits());}get angularMotionZ(){return this._angularMotionZ}set linearLimitsX(e){this._linearLimitsX.equals(e)||(this._linearLimitsX.copy(e),this._updateLinearLimits());}get linearLimitsX(){return this._linearLimitsX}set linearMotionX(e){this._linearMotionX!==e&&(this._linearMotionX=e,this._updateLinearLimits());}get linearMotionX(){return this._linearMotionX}set linearLimitsY(e){this._linearLimitsY.equals(e)||(this._linearLimitsY.copy(e),this._updateLinearLimits());}get linearLimitsY(){return this._linearLimitsY}set linearMotionY(e){this._linearMotionY!==e&&(this._linearMotionY=e,this._updateLinearLimits());}get linearMotionY(){return this._linearMotionY}set linearLimitsZ(e){this._linearLimitsZ.equals(e)||(this._linearLimitsZ.copy(e),this._updateLinearLimits());}get linearLimitsZ(){return this._linearLimitsZ}set linearMotionZ(e){this._linearMotionZ!==e&&(this._linearMotionZ=e,this._updateLinearLimits());}get linearMotionZ(){return this._linearMotionZ}_convertTransform(e,t){let i=e.getTranslation(),s=new ex;s.setFromMat4(e);let r=new Ammo.btVector3(i.x,i.y,i.z),a=new Ammo.btQuaternion(s.x,s.y,s.z,s.w);t.setOrigin(r),t.setRotation(a),Ammo.destroy(r),Ammo.destroy(a);}_updateAngularLimits(){let e=this._constraint;if(e){let t,i,s,r,a,n;this._angularMotionX===_h?(t=this._angularLimitsX.x*ei.DEG_TO_RAD,r=this._angularLimitsX.y*ei.DEG_TO_RAD):this._angularMotionX===_l?(t=1,r=0):t=r=0,this._angularMotionY===_h?(i=this._angularLimitsY.x*ei.DEG_TO_RAD,a=this._angularLimitsY.y*ei.DEG_TO_RAD):this._angularMotionY===_l?(i=1,a=0):i=a=0,this._angularMotionZ===_h?(s=this._angularLimitsZ.x*ei.DEG_TO_RAD,n=this._angularLimitsZ.y*ei.DEG_TO_RAD):this._angularMotionZ===_l?(s=1,n=0):s=n=0;let o=new Ammo.btVector3(t,i,s);e.setAngularLowerLimit(o),o.setValue(r,a,n),e.setAngularUpperLimit(o),Ammo.destroy(o);}}_updateLinearLimits(){let e=this._constraint;if(e){let t,i,s,r,a,n;this._linearMotionX===_h?(t=this._linearLimitsX.x,r=this._linearLimitsX.y):this._linearMotionX===_l?(t=1,r=0):t=r=0,this._linearMotionY===_h?(i=this._linearLimitsY.x,a=this._linearLimitsY.y):this._linearMotionY===_l?(i=1,a=0):i=a=0,this._linearMotionZ===_h?(s=this._linearLimitsZ.x,n=this._linearLimitsZ.y):this._linearMotionZ===_l?(s=1,n=0):s=n=0;let o=new Ammo.btVector3(t,i,s);e.setLinearLowerLimit(o),o.setValue(r,a,n),e.setLinearUpperLimit(o),Ammo.destroy(o);}}_createConstraint(){if(this._entityA&&this._entityA.rigidbody){this._destroyConstraint();let e=new ey,t=this._entityA.rigidbody.body;t.activate();let i=this.entity.getWorldTransform(),s=this._entityA.getWorldTransform().clone().invert();e.mul2(s,i);let r=new Ammo.btTransform;if(this._convertTransform(e,r),this._entityB&&this._entityB.rigidbody){let s=this._entityB.rigidbody.body;s.activate();let a=this._entityB.getWorldTransform().clone().invert();e.mul2(a,i);let n=new Ammo.btTransform;this._convertTransform(e,n),this._constraint=new Ammo.btGeneric6DofSpringConstraint(t,s,r,n,!this._enableCollision),Ammo.destroy(n);}else this._constraint=new Ammo.btGeneric6DofSpringConstraint(t,r,!this._enableCollision);Ammo.destroy(r);let a=["X","Y","Z","X","Y","Z"];for(let e=0;e<6;e++){let t=e<3?"_linear":"_angular";this._constraint.enableSpring(e,this[`${t}Spring${a[e]}`]),this._constraint.setDamping(e,this[`${t}Damping${a[e]}`]),this._constraint.setEquilibriumPoint(e,this[`${t}Equilibrium${a[e]}`]),this._constraint.setStiffness(e,this[`${t}Stiffness${a[e]}`]);}this._constraint.setBreakingImpulseThreshold(this._breakForce),this._updateLinearLimits(),this._updateAngularLimits(),this.system.app.systems.rigidbody.dynamicsWorld.addConstraint(this._constraint,!this._enableCollision);}}_destroyConstraint(){this._constraint&&(this.system.app.systems.rigidbody.dynamicsWorld.removeConstraint(this._constraint),Ammo.destroy(this._constraint),this._constraint=null);}initFromData(e){for(let t of _d)e.hasOwnProperty(t)&&(e[t]instanceof ef?this[`_${t}`].copy(e[t]):this[`_${t}`]=e[t]);this._createConstraint();}onEnable(){this._createConstraint();}onDisable(){this._destroyConstraint();}_onSetEnabled(e,t,i){}_onBeforeRemove(){this.fire("remove");}constructor(e,t){super(e,t),this._constraint=null,this._entityA=null,this._entityB=null,this._breakForce=34e37,this._enableCollision=true,this._linearMotionX=_c,this._linearLimitsX=new ef(0,0),this._linearSpringX=false,this._linearStiffnessX=0,this._linearDampingX=1,this._linearEquilibriumX=0,this._linearMotionY=_c,this._linearLimitsY=new ef(0,0),this._linearSpringY=false,this._linearStiffnessY=0,this._linearDampingY=1,this._linearEquilibriumY=0,this._linearMotionZ=_c,this._linearLimitsZ=new ef(0,0),this._linearSpringZ=false,this._linearStiffnessZ=0,this._linearDampingZ=1,this._linearEquilibriumZ=0,this._angularMotionX=_c,this._angularLimitsX=new ef(0,0),this._angularSpringX=false,this._angularStiffnessX=0,this._angularDampingX=1,this._angularEquilibriumX=0,this._angularMotionY=_c,this._angularLimitsY=new ef(0,0),this._angularSpringY=false,this._angularStiffnessY=0,this._angularDampingY=1,this._angularEquilibriumY=0,this._angularMotionZ=_c,this._angularLimitsZ=new ef(0,0),this._angularSpringZ=false,this._angularEquilibriumZ=0,this._angularDampingZ=1,this._angularStiffnessZ=0,this.on("set_enabled",this._onSetEnabled,this);}}let _f={Damping:"setDamping",Equilibrium:"setEquilibriumPoint",Spring:"enableSpring",Stiffness:"setStiffness"};["linear","angular"].forEach(e=>{["Damping","Equilibrium","Spring","Stiffness"].forEach(t=>{["X","Y","Z"].forEach(i=>{let s=e+t+i,r=`_${s}`,a=3*("linear"!==e);"Y"===i&&(a+=1),"Z"===i&&(a+=2),Object.defineProperty(_u.prototype,s,{get:function(){return this[r]},set:function(e){this[r]!==e&&(this[r]=e,this._constraint[_f[t]](a,e));}});});});});class _p{constructor(){this.enabled=true;}}let _m=["enabled"];class __ extends f8{initializeComponentData(e,t,i){e.initFromData(t),super.initializeComponentData(e,t,_m);}constructor(e){super(e),this.id="joint",this.app=e,this.ComponentType=_u,this.DataType=_p,this.schema=_m;}}f5._buildAccessors(_u.prototype,_m);class _g extends f5{set minWidth(e){e!==this._minWidth&&(this._minWidth=e,this.fire("resize"));}get minWidth(){return this._minWidth}set minHeight(e){e!==this._minHeight&&(this._minHeight=e,this.fire("resize"));}get minHeight(){return this._minHeight}set maxWidth(e){e!==this._maxWidth&&(this._maxWidth=e,this.fire("resize"));}get maxWidth(){return this._maxWidth}set maxHeight(e){e!==this._maxHeight&&(this._maxHeight=e,this.fire("resize"));}get maxHeight(){return this._maxHeight}set fitWidthProportion(e){e!==this._fitWidthProportion&&(this._fitWidthProportion=e,this.fire("resize"));}get fitWidthProportion(){return this._fitWidthProportion}set fitHeightProportion(e){e!==this._fitHeightProportion&&(this._fitHeightProportion=e,this.fire("resize"));}get fitHeightProportion(){return this._fitHeightProportion}set excludeFromLayout(e){e!==this._excludeFromLayout&&(this._excludeFromLayout=e,this.fire("resize"));}get excludeFromLayout(){return this._excludeFromLayout}constructor(...e){super(...e),this._minWidth=0,this._minHeight=0,this._maxWidth=null,this._maxHeight=null,this._fitWidthProportion=0,this._fitHeightProportion=0,this._excludeFromLayout=false;}}class _v{constructor(){this.enabled=true;}}let _S=["enabled"];class _y extends f8{initializeComponentData(e,t,i){ void 0!==t.enabled&&(e.enabled=t.enabled),void 0!==t.minWidth&&(e.minWidth=t.minWidth),void 0!==t.minHeight&&(e.minHeight=t.minHeight),void 0!==t.maxWidth&&(e.maxWidth=t.maxWidth),void 0!==t.maxHeight&&(e.maxHeight=t.maxHeight),void 0!==t.fitWidthProportion&&(e.fitWidthProportion=t.fitWidthProportion),void 0!==t.fitHeightProportion&&(e.fitHeightProportion=t.fitHeightProportion),void 0!==t.excludeFromLayout&&(e.excludeFromLayout=t.excludeFromLayout),super.initializeComponentData(e,t,i);}cloneComponent(e,t){let i=e.layoutchild;return this.addComponent(t,{enabled:i.enabled,minWidth:i.minWidth,minHeight:i.minHeight,maxWidth:i.maxWidth,maxHeight:i.maxHeight,fitWidthProportion:i.fitWidthProportion,fitHeightProportion:i.fitHeightProportion,excludeFromLayout:i.excludeFromLayout})}constructor(e){super(e),this.id="layoutchild",this.ComponentType=_g,this.DataType=_v,this.schema=_S;}}f5._buildAccessors(_g.prototype,_S);let _x={};_x[0]={axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"},_x[1]={axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"};let _T={};_T[0]=1,_T[1]=0;let _E={minWidth:0,minHeight:0,maxWidth:1/0,maxHeight:1/0,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},_w="NONE",_b="APPLY_STRETCHING",_A="APPLY_SHRINKING",_C=new ef;function _P(e){let t,i=_x[e],s=_x[_T[e]];function r(e,t){return -t[s.size]*e.pivot[s.axis]}function a(e){let t=e.entity.layoutchild;return !t||!t.enabled||!t.excludeFromLayout}function n(e,t,i){switch(e){case 0:return _w;case 1:if(t<i)return _b;return _w;case 2:if(t>=i)return _A;return _w;case 3:if(t<i)return _b;return _A;default:throw Error(`Unrecognized fitting mode: ${e}`)}}function o(e,i){return p(e,i.size)+(e.length-1)*t.spacing[i.axis]}function l(e,t,i){let s=_(e,i.maxSize),r=m(e,i.fittingProportion),a=S(r,s),n=_C[i.axis]-t;for(let t=0;t<e.length;++t){let o=s[t],l=c(o,n,r,a),h=e[o][i.size]+l,d=Math.min(h,e[o][i.maxSize]);e[o][i.size]=d,n-=l-Math.max(h-d,0);}}function h(e,t,i){let s=_(e,i.minSize,true),r=function(e){if(1===e.length)return [1];let t=[],i=e.length;for(let s=0;s<i;++s)t.push((1-e[s])/(i-1));return t}(m(e,i.fittingProportion)),a=S(r,s),n=t-_C[i.axis];for(let t=0;t<e.length;++t){let o=s[t],l=c(o,n,r,a),h=e[o][i.size]-l,d=Math.max(h,e[o][i.minSize]);e[o][i.size]=d,n-=l-Math.max(d-h,0);}}function c(e,t,i,s){let r=i[e],a=s[e];return 1e-5>Math.abs(r)&&1e-5>Math.abs(a)?t:t*r/a}function d(e){let t=[];for(let i=0;i<e.length;++i){let s=e[i],r=Math.max(u(s,"minWidth"),0),a=Math.max(u(s,"minHeight"),0),n=Math.max(u(s,"maxWidth"),r),o=Math.max(u(s,"maxHeight"),a),l=f(u(s,"width"),r,n),h=f(u(s,"height"),a,o),c=u(s,"fitWidthProportion"),d=u(s,"fitHeightProportion");t.push({minWidth:r,minHeight:a,maxWidth:n,maxHeight:o,width:l,height:h,fitWidthProportion:c,fitHeightProportion:d});}return t}function u(e,t){let i=e.entity.layoutchild;return i&&i.enabled&&void 0!==i[t]&&null!==i[t]?i[t]:void 0!==e[t]?e[t]:_E[t]}function f(e,t,i){return Math.min(Math.max(e,t),i)}function p(e,t){return e.reduce((e,i)=>e+i[t],0)}function m(e,t){let i=p(e,t),s=[],r=e.length;if(0===i)for(let e=0;e<r;++e)s.push(1/r);else for(let a=0;a<r;++a)s.push(e[a][t]/i);return s}function _(e,t,i){return e.forEach(g),e.slice().sort((e,s)=>i?s[t]-e[t]:e[t]-s[t]).map(v)}function g(e,t){e.index=t;}function v(e){return e.index}function S(e,t){let i=[];i[t[e.length-1]]=e[t[e.length-1]];for(let s=e.length-2;s>=0;--s)i[t[s]]=i[t[s+1]]+e[t[s]];return i}return function(e,c){var u;let f,p;e=e.filter(a),_C.x=(t=c).containerSize.x-t.padding.x-t.padding.z,_C.y=t.containerSize.y-t.padding.y-t.padding.w,function(e){for(let t=0;t<e.length;++t){let i=e[t],s=i.anchor;(0!==s.x||0!==s.y||0!==s.z||0!==s.w)&&(i.anchor=ep.ZERO);}}(e);let m=function(e){let i=0===t.orientation&&t.reverseX||1===t.orientation&&t.reverseY,s=0===t.orientation&&t.reverseY||1===t.orientation&&t.reverseX;if(i)for(let t=0;t<e.length;++t)i&&e[t].reverse();return s&&e.reverse(),e}(function(e){if(!t.wrap)return [e];let s=[[]],r=d(e),a=0,n=2===t[i.fitting];for(let o=0;o<e.length;++o){s[s.length-1].length>0&&(a+=t.spacing[i.axis]);let l=r[o][i.size];a+=l,!n&&a>_C[i.axis]&&0!==s[s.length-1].length&&(a=l,s.push([])),s[s.length-1].push(e[o]),n&&a>_C[i.axis]&&o!==e.length-1&&(a=0,s.push([]));}return s}(e)),_=function(e,i){let r=[],a=[];for(let t=0;t<e.length;++t){let n=e[t];n.largestElement=null,n.largestSize={width:-1/0,height:-1/0};for(let e=0;e<n.length;++e){let r=i[t][e];r[s.size]>n.largestSize[s.size]&&(n.largestElement=n[e],n.largestSize=r);}r.push(n.largestElement),a.push(n.largestSize);}let c=o(a,s),d=n(t[s.fitting],c,_C[s.axis]);d===_b?l(a,c,s):d===_A&&h(a,c,s);for(let r=0;r<e.length;++r){let a=e[r];for(let o=0;o<a.length;++o){let l=i[r][o],h=l[s.size],c=1===e.length?_C[s.axis]:a.largestSize[s.size],d=n(t[s.fitting],h,c);d===_b?l[s.size]=Math.min(c,l[s.maxSize]):d===_A&&(l[s.size]=Math.max(c,l[s.minSize]));}}return i}(m,function(e){let s=[];for(let r=0;r<e.length;++r){let a=d(e[r]),c=o(a,i),u=n(t[i.fitting],c,_C[i.axis]);u===_b?l(a,c,i):u===_A&&h(a,c,i),s.push(a);}return s}(m)),g=function(e,a){let n={};n[i.axis]=0,n[s.axis]=0,e[i.size]=-1/0;let o=[];for(let l=0;l<e.length;++l){let h=e[l];if(0===h.length){o.push([]);continue}let c=[],d=a[l];for(let e=0;e<h.length;++e){let a=h[e],o=d[e];n[s.axis]-=r(a,o),n[i.axis]-=-o[i.size]*a.pivot[i.axis],c[e]={},c[e][i.axis]=n[i.axis],c[e][s.axis]=n[s.axis],n[s.axis]+=r(a,o),n[i.axis]+=o[i.size]*(1-a.pivot[i.axis])+t.spacing[i.axis];}h[i.size]=n[i.axis]-t.spacing[i.axis],h[s.size]=h.largestSize[s.size],e[i.size]=Math.max(e[i.size],h[i.size]),n[i.axis]=0,n[s.axis]+=h[s.size]+t.spacing[s.axis],o.push(c);}return e[s.size]=n[s.axis]-t.spacing[s.axis],o}(m,_);return function(e,r,a){let n=t.alignment[i.axis],o=t.alignment[s.axis],l=t.padding[i.axis],h=t.padding[s.axis];for(let c=0;c<e.length;++c){let d=e[c],u=r[c],f=a[c],p=(_C[i.axis]-d[i.size])*n+l,m=(_C[s.axis]-e[s.size])*o+h;for(let e=0;e<d.length;++e){let r=(d[s.size]-u[e][s.size])*t.alignment[s.axis];f[e][i.axis]+=p,f[e][s.axis]+=m+r;}}}(m,_,g),function(e,r,a){for(let n=0;n<e.length;++n){let o=e[n],l=r[n],h=a[n];for(let e=0;e<o.length;++e){let r=o[e];r[i.calculatedSize]=l[e][i.size],r[s.calculatedSize]=l[e][s.size],0===t.orientation?r.entity.setLocalPosition(h[e][i.axis],h[e][s.axis],r.entity.getLocalPosition().z):r.entity.setLocalPosition(h[e][s.axis],h[e][i.axis],r.entity.getLocalPosition().z);}}}(m,_,g),f=(u=m).width,p=u.height,{bounds:new ep((_C.x-f)*t.alignment.x+t.padding.x,(_C.y-p)*t.alignment.y+t.padding.y,f,p)}}}let _I={};_I[0]=_P(0),_I[1]=_P(1);class _D{calculateLayout(e,t){let i=_I[t.orientation];if(i)return i(e,t);throw Error(`Unrecognized orientation value: ${t.orientation}`)}}function _R(e){return e.element}function _L(e){return e.enabled&&e.element&&e.element.enabled}class _M extends f5{set orientation(e){e!==this._orientation&&(this._orientation=e,this._scheduleReflow());}get orientation(){return this._orientation}set reverseX(e){e!==this._reverseX&&(this._reverseX=e,this._scheduleReflow());}get reverseX(){return this._reverseX}set reverseY(e){e!==this._reverseY&&(this._reverseY=e,this._scheduleReflow());}get reverseY(){return this._reverseY}set alignment(e){e.equals(this._alignment)||(this._alignment.copy(e),this._scheduleReflow());}get alignment(){return this._alignment}set padding(e){e.equals(this._padding)||(this._padding.copy(e),this._scheduleReflow());}get padding(){return this._padding}set spacing(e){e.equals(this._spacing)||(this._spacing.copy(e),this._scheduleReflow());}get spacing(){return this._spacing}set widthFitting(e){e!==this._widthFitting&&(this._widthFitting=e,this._scheduleReflow());}get widthFitting(){return this._widthFitting}set heightFitting(e){e!==this._heightFitting&&(this._heightFitting=e,this._scheduleReflow());}get heightFitting(){return this._heightFitting}set wrap(e){e!==this._wrap&&(this._wrap=e,this._scheduleReflow());}get wrap(){return this._wrap}_isSelfOrChild(e){return e===this.entity||-1!==this.entity.children.indexOf(e)}_listenForReflowEvents(e,t){e.element&&(e.element[t]("enableelement",this._scheduleReflow,this),e.element[t]("disableelement",this._scheduleReflow,this),e.element[t]("resize",this._scheduleReflow,this),e.element[t]("set:pivot",this._scheduleReflow,this)),e.layoutchild&&(e.layoutchild[t]("set_enabled",this._scheduleReflow,this),e.layoutchild[t]("resize",this._scheduleReflow,this));}_onElementOrLayoutComponentAdd(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"on"),this._scheduleReflow());}_onElementOrLayoutComponentRemove(e){this._isSelfOrChild(e)&&(this._listenForReflowEvents(e,"off"),this._scheduleReflow());}_onChildInsert(e){this._listenForReflowEvents(e,"on"),this._scheduleReflow();}_onChildRemove(e){this._listenForReflowEvents(e,"off"),this._scheduleReflow();}_scheduleReflow(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this);}reflow(){let e=_R(this.entity),t=this.entity.children.filter(_L).map(_R);if(!e||0===t.length)return;let i=Math.max(e.calculatedWidth,0),s=Math.max(e.calculatedHeight,0),r={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new ef(i,s)};this._isPerformingReflow=true;let a=this._layoutCalculator.calculateLayout(t,r);this._isPerformingReflow=false,this.fire("reflow",a);}onEnable(){this._scheduleReflow();}onRemove(){this.entity.off("childinsert",this._onChildInsert,this),this.entity.off("childremove",this._onChildRemove,this),this._listenForReflowEvents(this.entity,"off"),this.entity.children.forEach(e=>{this._listenForReflowEvents(e,"off");}),this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this),this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this);}constructor(e,t){super(e,t),this._orientation=0,this._reverseX=false,this._reverseY=true,this._alignment=new ef(0,1),this._padding=new ep,this._spacing=new ef,this._widthFitting=0,this._heightFitting=0,this._wrap=false,this._layoutCalculator=new _D,this._listenForReflowEvents(this.entity,"on"),this.entity.children.forEach(e=>{this._listenForReflowEvents(e,"on");}),this.entity.on("childinsert",this._onChildInsert,this),this.entity.on("childremove",this._onChildRemove,this),e.app.systems.element.on("add",this._onElementOrLayoutComponentAdd,this),e.app.systems.element.on("beforeremove",this._onElementOrLayoutComponentRemove,this),e.app.systems.layoutchild.on("add",this._onElementOrLayoutComponentAdd,this),e.app.systems.layoutchild.on("beforeremove",this._onElementOrLayoutComponentRemove,this);}}class _O{constructor(){this.enabled=true;}}let _F=["enabled"];class _N extends f8{initializeComponentData(e,t,i){ void 0!==t.enabled&&(e.enabled=t.enabled),void 0!==t.orientation&&(e.orientation=t.orientation),void 0!==t.reverseX&&(e.reverseX=t.reverseX),void 0!==t.reverseY&&(e.reverseY=t.reverseY),void 0!==t.alignment&&(e.alignment=Array.isArray(t.alignment)?new ef(t.alignment):t.alignment),void 0!==t.padding&&(e.padding=Array.isArray(t.padding)?new ep(t.padding):t.padding),void 0!==t.spacing&&(e.spacing=Array.isArray(t.spacing)?new ef(t.spacing):t.spacing),void 0!==t.widthFitting&&(e.widthFitting=t.widthFitting),void 0!==t.heightFitting&&(e.heightFitting=t.heightFitting),void 0!==t.wrap&&(e.wrap=t.wrap),super.initializeComponentData(e,t,i);}cloneComponent(e,t){let i=e.layoutgroup;return this.addComponent(t,{enabled:i.enabled,orientation:i.orientation,reverseX:i.reverseX,reverseY:i.reverseY,alignment:i.alignment,padding:i.padding,spacing:i.spacing,widthFitting:i.widthFitting,heightFitting:i.heightFitting,wrap:i.wrap})}scheduleReflow(e){ -1===this._reflowQueue.indexOf(e)&&this._reflowQueue.push(e);}_onPostUpdate(){this._processReflowQueue();}_processReflowQueue(){if(0===this._reflowQueue.length)return;let e=0;for(;this._reflowQueue.length>0;){let t=this._reflowQueue.slice();this._reflowQueue.length=0,t.sort((e,t)=>e.entity.graphDepth-t.entity.graphDepth);for(let e=0;e<t.length;++e)t[e].reflow();if(++e>=100)break}}_onRemoveComponent(e,t){t.onRemove();}destroy(){super.destroy(),this.app.systems.off("postUpdate",this._onPostUpdate,this);}constructor(e){super(e),this.id="layoutgroup",this.ComponentType=_M,this.DataType=_O,this.schema=_F,this._reflowQueue=[],this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("postUpdate",this._onPostUpdate,this);}}f5._buildAccessors(_M.prototype,_F);class _B{destroy(e){this.map.forEach(e=>e.mesh.destroy());}constructor(){this.map=new Map;}}let _k=new ii,_U=(e,t)=>{let i=_k.get(e,()=>new _B),s=i.map.get(t);if(!s){let r,a;switch(t){case "box":r=n7.fromGeometry(e,new cU),a={x:2,y:2,z:2,uv:2/3};break;case "capsule":r=n7.fromGeometry(e,new ue({radius:.5,height:2})),a={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case "cone":r=n7.fromGeometry(e,new ut({baseRadius:.5,peakRadius:0,height:1})),a={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case "cylinder":r=n7.fromGeometry(e,new ui({radius:.5,height:1})),a={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case "plane":r=n7.fromGeometry(e,new us({halfExtents:new ef(.5,.5),widthSegments:1,lengthSegments:1})),a={x:0,y:1,z:0,uv:1};break;case "sphere":r=n7.fromGeometry(e,new cz({radius:.5})),a={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;case "torus":r=n7.fromGeometry(e,new ur({tubeRadius:.2,ringRadius:.3})),a={x:.5*Math.PI*.5-.1*Math.PI*.1,y:.4,z:.4,uv:1};break;default:throw Error(`Invalid primitive type: ${t}`)}r.incRefCount(),s={mesh:r,area:a},i.map.set(t,s);}return s};class _z extends f5{set meshInstances(e){this._model&&(this._model.meshInstances=e);}get meshInstances(){return this._model?this._model.meshInstances:null}set customAabb(e){if(this._customAabb=e,this._model){let e=this._model.meshInstances;if(e)for(let t=0;t<e.length;t++)e[t].setCustomAabb(this._customAabb);}}get customAabb(){return this._customAabb}set type(e){if(this._type!==e)if(this._area=null,this._type=e,"asset"===e)null!==this._asset?this._bindModelAsset(this._asset):this.model=null;else {let t=_U(this.system.app.graphicsDevice,e);this._area=t.area;let i=t.mesh,s=new oX,r=new hA;r.graph=s,r.meshInstances=[new od(i,this._material,s)],this.model=r,this._asset=null;}}get type(){return this._type}set asset(e){let t=this.system.app.assets,i=e;if(e instanceof fy&&(i=e.id),this._asset!==i){if(this._asset){t.off(`add:${this._asset}`,this._onModelAssetAdded,this);let e=t.get(this._asset);e&&this._unbindModelAsset(e);}if(this._asset=i,this._asset){let e=t.get(this._asset);e?this._bindModelAsset(e):(this.model=null,t.on(`add:${this._asset}`,this._onModelAssetAdded,this));}else this.model=null;}}get asset(){return this._asset}set model(e){if(this._model!==e&&(!e||!e._immutable)&&(this._model&&(this._model._immutable=false,this.removeModelFromLayers(),this._model.getGraph().destroy(),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=false)),this._model=e,this._model)){this._model._immutable=true;let e=this._model.meshInstances;for(let t=0;t<e.length;t++)e[t].castShadow=this._castShadows,e[t].receiveShadow=this._receiveShadows,e[t].setCustomAabb(this._customAabb);this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),this.entity.anim&&this.entity.anim.rebind(),"asset"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents();}}get model(){return this._model}set lightmapped(e){if(e!==this._lightmapped&&(this._lightmapped=e,this._model)){let t=this._model.meshInstances;for(let i=0;i<t.length;i++)t[i].setLightmapped(e);}}get lightmapped(){return this._lightmapped}set castShadows(e){if(this._castShadows===e)return;let t=this._model;if(t){let i=this.layers,s=this.system.app.scene;if(this._castShadows&&!e)for(let e=0;e<i.length;e++){let i=this.system.app.scene.layers.getLayerById(this.layers[e]);i&&i.removeShadowCasters(t.meshInstances);}let r=t.meshInstances;for(let t=0;t<r.length;t++)r[t].castShadow=e;if(!this._castShadows&&e)for(let e=0;e<i.length;e++){let r=s.layers.getLayerById(i[e]);r&&r.addShadowCasters(t.meshInstances);}}this._castShadows=e;}get castShadows(){return this._castShadows}set receiveShadows(e){if(this._receiveShadows!==e&&(this._receiveShadows=e,this._model)){let t=this._model.meshInstances;for(let i=0,s=t.length;i<s;i++)t[i].receiveShadow=e;}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(e){this._castShadowsLightmap=e;}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(e){this._lightmapSizeMultiplier=e;}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(e){let t=this.system.app.scene.layers;if(this.meshInstances)for(let e=0;e<this._layers.length;e++){let i=t.getLayerById(this._layers[e]);i&&i.removeMeshInstances(this.meshInstances);}this._layers.length=0;for(let t=0;t<e.length;t++)this._layers[t]=e[t];if(this.enabled&&this.entity.enabled&&this.meshInstances)for(let e=0;e<this._layers.length;e++){let i=t.getLayerById(this._layers[e]);i&&i.addMeshInstances(this.meshInstances);}}get layers(){return this._layers}set batchGroupId(e){this._batchGroupId!==e&&(this.entity.enabled&&this._batchGroupId>=0&&this.system.app.batcher?.remove(n2.MODEL,this.batchGroupId,this.entity),this.entity.enabled&&e>=0&&this.system.app.batcher?.insert(n2.MODEL,e,this.entity),e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=e);}get batchGroupId(){return this._batchGroupId}set materialAsset(e){let t=e;e instanceof fy&&(t=e.id);let i=this.system.app.assets;if(t!==this._materialAsset){if(this._materialAsset){i.off(`add:${this._materialAsset}`,this._onMaterialAssetAdd,this);let e=i.get(this._materialAsset);e&&this._unbindMaterialAsset(e);}if(this._materialAsset=t,this._materialAsset){let e=i.get(this._materialAsset);e?this._bindMaterialAsset(e):(this._setMaterial(this.system.defaultMaterial),i.on(`add:${this._materialAsset}`,this._onMaterialAssetAdd,this));}else this._setMaterial(this.system.defaultMaterial);}}get materialAsset(){return this._materialAsset}set material(e){this._material!==e&&(this.materialAsset=null,this._setMaterial(e));}get material(){return this._material}set mapping(e){if("asset"!==this._type||(this._unsetMaterialEvents(),e||(e={}),this._mapping=e,!this._model))return;let t=this._model.meshInstances,i=this.asset?this.system.app.assets.get(this.asset):null,s=i?i.data.mapping:null,r=null;for(let i=0,a=t.length;i<a;i++)if(void 0!==e[i])e[i]?(r=this.system.app.assets.get(e[i]),this._loadAndSetMeshInstanceMaterial(r,t[i],i)):t[i].material=this.system.defaultMaterial;else if(s)if(s[i]&&(s[i].material||s[i].path)){if(void 0!==s[i].material)r=this.system.app.assets.get(s[i].material);else if(void 0!==s[i].path){let e=this._getMaterialAssetUrl(s[i].path);e&&(r=this.system.app.assets.getByUrl(e));}this._loadAndSetMeshInstanceMaterial(r,t[i],i);}else t[i].material=this.system.defaultMaterial;}get mapping(){return this._mapping}addModelToLayers(){let e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){let i=e.getLayerById(this._layers[t]);i&&i.addMeshInstances(this.meshInstances);}}removeModelFromLayers(){let e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){let i=e.getLayerById(this._layers[t]);i&&i.removeMeshInstances(this.meshInstances);}}onRemoveChild(){this._model&&this.removeModelFromLayers();}onInsertChild(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers();}onRemove(){this.asset=null,this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this);}onLayersChanged(e,t){this.addModelToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);}onLayerAdded(e){0>this.layers.indexOf(e.id)||e.addMeshInstances(this.meshInstances);}onLayerRemoved(e){0>this.layers.indexOf(e.id)||e.removeMeshInstances(this.meshInstances);}_setMaterialEvent(e,t,i,s){let r=`${t}:${i}`;this.system.app.assets.on(r,s,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[e]||(this._materialEvents[e]={}),this._materialEvents[e][r]={id:i,handler:s};}_unsetMaterialEvents(){let e=this.system.app.assets,t=this._materialEvents;if(t){for(let i=0,s=t.length;i<s;i++){if(!t[i])continue;let s=t[i];for(let t in s)e.off(t,s[t].handler,this);}this._materialEvents=null;}}_getAssetByIdOrPath(e){let t=null;if(isNaN(parseInt(e,10))){if(this.asset){let i=this._getMaterialAssetUrl(e);i&&(t=this.system.app.assets.getByUrl(i));}}else t=this.system.app.assets.get(e);return t}_getMaterialAssetUrl(e){if(!this.asset)return null;let t=this.system.app.assets.get(this.asset);return t?t.getAbsoluteUrl(e):null}_loadAndSetMeshInstanceMaterial(e,t,i){let s=this.system.app.assets;e&&(e.resource?(t.material=e.resource,this._setMaterialEvent(i,"remove",e.id,function(){t.material=this.system.defaultMaterial;})):(this._setMaterialEvent(i,"load",e.id,function(s){t.material=s.resource,this._setMaterialEvent(i,"remove",e.id,function(){t.material=this.system.defaultMaterial;});}),this.enabled&&this.entity.enabled&&s.load(e)));}onEnable(){let e,t=this.system.app,i=t.scene,s=i?.layers;this._evtLayersChanged=i.on("set:layers",this.onLayersChanged,this),s&&(this._evtLayerAdded=s.on("add",this.onLayerAdded,this),this._evtLayerRemoved=s.on("remove",this.onLayerRemoved,this));let r="asset"===this._type;if(this._model?this.addModelToLayers():r&&this._asset&&(e=t.assets.get(this._asset))&&e.resource!==this._model&&this._bindModelAsset(e),this._materialAsset&&(e=t.assets.get(this._materialAsset))&&e.resource!==this._material&&this._bindMaterialAsset(e),r&&this._mapping)for(let i in this._mapping)this._mapping[i]&&(e=this._getAssetByIdOrPath(this._mapping[i]))&&!e.resource&&t.assets.load(e);this._batchGroupId>=0&&t.batcher?.insert(n2.MODEL,this.batchGroupId,this.entity);}onDisable(){let e=this.system.app,t=e.scene.layers;this._evtLayersChanged?.off(),this._evtLayersChanged=null,t&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this._batchGroupId>=0&&e.batcher?.remove(n2.MODEL,this.batchGroupId,this.entity),this._model&&this.removeModelFromLayers();}hide(){if(this._model){let e=this._model.meshInstances;for(let t=0,i=e.length;t<i;t++)e[t].visible=false;}}show(){if(this._model){let e=this._model.meshInstances;for(let t=0,i=e.length;t<i;t++)e[t].visible=true;}}_bindMaterialAsset(e){if(e.on("load",this._onMaterialAssetLoad,this),e.on("unload",this._onMaterialAssetUnload,this),e.on("remove",this._onMaterialAssetRemove,this),e.on("change",this._onMaterialAssetChange,this),e.resource)this._onMaterialAssetLoad(e);else {if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e);}}_unbindMaterialAsset(e){e.off("load",this._onMaterialAssetLoad,this),e.off("unload",this._onMaterialAssetUnload,this),e.off("remove",this._onMaterialAssetRemove,this),e.off("change",this._onMaterialAssetChange,this);}_onMaterialAssetAdd(e){this.system.app.assets.off(`add:${e.id}`,this._onMaterialAssetAdd,this),this._materialAsset===e.id&&this._bindMaterialAsset(e);}_onMaterialAssetLoad(e){this._setMaterial(e.resource);}_onMaterialAssetUnload(e){this._setMaterial(this.system.defaultMaterial);}_onMaterialAssetRemove(e){this._onMaterialAssetUnload(e);}_onMaterialAssetChange(e){}_bindModelAsset(e){if(this._unbindModelAsset(e),e.on("load",this._onModelAssetLoad,this),e.on("unload",this._onModelAssetUnload,this),e.on("change",this._onModelAssetChange,this),e.on("remove",this._onModelAssetRemove,this),e.resource)this._onModelAssetLoad(e);else {if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e);}}_unbindModelAsset(e){e.off("load",this._onModelAssetLoad,this),e.off("unload",this._onModelAssetUnload,this),e.off("change",this._onModelAssetChange,this),e.off("remove",this._onModelAssetRemove,this);}_onModelAssetAdded(e){this.system.app.assets.off(`add:${e.id}`,this._onModelAssetAdded,this),e.id===this._asset&&this._bindModelAsset(e);}_onModelAssetLoad(e){this.model=e.resource.clone(),this._clonedModel=true;}_onModelAssetUnload(e){this.model=null;}_onModelAssetChange(e,t,i,s){"data"===t&&(this.mapping=this._mapping);}_onModelAssetRemove(e){this.model=null;}_setMaterial(e){if(this._material===e)return;this._material=e;let t=this._model;if(t&&"asset"!==this._type){let i=t.meshInstances;for(let t=0,s=i.length;t<s;t++)i[t].material=e;}}constructor(e,t){super(e,t),this._type="asset",this._asset=null,this._model=null,this._mapping={},this._castShadows=true,this._receiveShadows=true,this._materialAsset=null,this._castShadowsLightmap=true,this._lightmapped=false,this._lightmapSizeMultiplier=1,this.isStatic=false,this._layers=[0],this._batchGroupId=-1,this._customAabb=null,this._area=null,this._materialEvents=null,this._clonedModel=false,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._material=e.defaultMaterial,t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this);}}class _V{constructor(){this.enabled=true;}}let _G=["enabled"];class _H extends f8{initializeComponentData(e,t,i){i=["material","materialAsset","asset","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","type","mapping","layers","isStatic","batchGroupId"],(null===t.batchGroupId||void 0===t.batchGroupId)&&(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let s=0;s<i.length;s++)t.hasOwnProperty(i[s])&&(e[i[s]]=t[i[s]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new eC(new ed(t.aabbCenter),new ed(t.aabbHalfExtents))),super.initializeComponentData(e,t,["enabled"]);}cloneComponent(e,t){let i={type:e.model.type,asset:e.model.asset,castShadows:e.model.castShadows,receiveShadows:e.model.receiveShadows,castShadowsLightmap:e.model.castShadowsLightmap,lightmapped:e.model.lightmapped,lightmapSizeMultiplier:e.model.lightmapSizeMultiplier,isStatic:e.model.isStatic,enabled:e.model.enabled,layers:e.model.layers,batchGroupId:e.model.batchGroupId,mapping:A({},e.model.mapping)},s=e.model.materialAsset;s instanceof fy||null==s||(s=this.app.assets.get(s));let r=e.model.material;r&&r!==this.defaultMaterial&&s&&r!==s.resource||(i.materialAsset=s);let a=this.addComponent(t,i);if(e.model.model&&"asset"===e.model.type&&!e.model.asset&&(a.model=e.model.model.clone(),a._clonedModel=true),i.materialAsset||(a.material=r),e.model.model){let t=e.model.model.meshInstances,i=a.model.meshInstances;for(let e=0;e<t.length;e++)i[e].mask=t[e].mask,i[e].material=t[e].material,i[e].layer=t[e].layer,i[e].receiveShadow=t[e].receiveShadow;}return e.model.customAabb&&(a.customAabb=e.model.customAabb.clone()),a}onRemove(e,t){t.onRemove();}constructor(e){super(e),this.id="model",this.ComponentType=_z,this.DataType=_V,this.schema=_G,this.defaultMaterial=ot(e.graphicsDevice),this.on("beforeremove",this.onRemove,this);}}f5._buildAccessors(_z.prototype,_G);let _W=["emitterExtents","emitterRadius","emitterExtentsInner","emitterRadiusInner","loop","initialVelocity","animSpeed","normalMap","particleNormal"],_X=["numParticles","lifetime","rate","rate2","startAngle","startAngle2","lighting","halfLambert","intensity","wrap","wrapBounds","depthWrite","noFog","sort","stretch","alignToMotion","preWarm","emitterShape","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animLoop","colorMap","localSpace","screenSpace","orientation"],_Y=["scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","velocityGraph","velocityGraph2","localVelocityGraph","localVelocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2"],_q=["colorMapAsset","normalMapAsset","meshAsset","renderAsset"];class _$ extends f5{get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e);}get enabled(){return this.data.enabled}set autoPlay(e){this._setValue("autoPlay",e);}get autoPlay(){return this.data.autoPlay}set numParticles(e){this._setValue("numParticles",e);}get numParticles(){return this.data.numParticles}set lifetime(e){this._setValue("lifetime",e);}get lifetime(){return this.data.lifetime}set rate(e){this._setValue("rate",e);}get rate(){return this.data.rate}set rate2(e){this._setValue("rate2",e);}get rate2(){return this.data.rate2}set startAngle(e){this._setValue("startAngle",e);}get startAngle(){return this.data.startAngle}set startAngle2(e){this._setValue("startAngle2",e);}get startAngle2(){return this.data.startAngle2}set loop(e){this._setValue("loop",e);}get loop(){return this.data.loop}set preWarm(e){this._setValue("preWarm",e);}get preWarm(){return this.data.preWarm}set lighting(e){this._setValue("lighting",e);}get lighting(){return this.data.lighting}set halfLambert(e){this._setValue("halfLambert",e);}get halfLambert(){return this.data.halfLambert}set intensity(e){this._setValue("intensity",e);}get intensity(){return this.data.intensity}set depthWrite(e){this._setValue("depthWrite",e);}get depthWrite(){return this.data.depthWrite}set noFog(e){this._setValue("noFog",e);}get noFog(){return this.data.noFog}set depthSoftening(e){this._setValue("depthSoftening",e);}get depthSoftening(){return this.data.depthSoftening}set sort(e){this._setValue("sort",e);}get sort(){return this.data.sort}set blendType(e){this._setValue("blendType",e);}get blendType(){return this.data.blendType}set stretch(e){this._setValue("stretch",e);}get stretch(){return this.data.stretch}set alignToMotion(e){this._setValue("alignToMotion",e);}get alignToMotion(){return this.data.alignToMotion}set emitterShape(e){this._setValue("emitterShape",e);}get emitterShape(){return this.data.emitterShape}set emitterExtents(e){this._setValue("emitterExtents",e);}get emitterExtents(){return this.data.emitterExtents}set emitterExtentsInner(e){this._setValue("emitterExtentsInner",e);}get emitterExtentsInner(){return this.data.emitterExtentsInner}set emitterRadius(e){this._setValue("emitterRadius",e);}get emitterRadius(){return this.data.emitterRadius}set emitterRadiusInner(e){this._setValue("emitterRadiusInner",e);}get emitterRadiusInner(){return this.data.emitterRadiusInner}set initialVelocity(e){this._setValue("initialVelocity",e);}get initialVelocity(){return this.data.initialVelocity}set wrap(e){this._setValue("wrap",e);}get wrap(){return this.data.wrap}set wrapBounds(e){this._setValue("wrapBounds",e);}get wrapBounds(){return this.data.wrapBounds}set localSpace(e){this._setValue("localSpace",e);}get localSpace(){return this.data.localSpace}set screenSpace(e){this._setValue("screenSpace",e);}get screenSpace(){return this.data.screenSpace}set colorMapAsset(e){this._setValue("colorMapAsset",e);}get colorMapAsset(){return this.data.colorMapAsset}set normalMapAsset(e){this._setValue("normalMapAsset",e);}get normalMapAsset(){return this.data.normalMapAsset}set mesh(e){this._setValue("mesh",e);}get mesh(){return this.data.mesh}set meshAsset(e){this._setValue("meshAsset",e);}get meshAsset(){return this.data.meshAsset}set renderAsset(e){this._setValue("renderAsset",e);}get renderAsset(){return this.data.renderAsset}set orientation(e){this._setValue("orientation",e);}get orientation(){return this.data.orientation}set particleNormal(e){this._setValue("particleNormal",e);}get particleNormal(){return this.data.particleNormal}set localVelocityGraph(e){this._setValue("localVelocityGraph",e);}get localVelocityGraph(){return this.data.localVelocityGraph}set localVelocityGraph2(e){this._setValue("localVelocityGraph2",e);}get localVelocityGraph2(){return this.data.localVelocityGraph2}set velocityGraph(e){this._setValue("velocityGraph",e);}get velocityGraph(){return this.data.velocityGraph}set velocityGraph2(e){this._setValue("velocityGraph2",e);}get velocityGraph2(){return this.data.velocityGraph2}set rotationSpeedGraph(e){this._setValue("rotationSpeedGraph",e);}get rotationSpeedGraph(){return this.data.rotationSpeedGraph}set rotationSpeedGraph2(e){this._setValue("rotationSpeedGraph2",e);}get rotationSpeedGraph2(){return this.data.rotationSpeedGraph2}set radialSpeedGraph(e){this._setValue("radialSpeedGraph",e);}get radialSpeedGraph(){return this.data.radialSpeedGraph}set radialSpeedGraph2(e){this._setValue("radialSpeedGraph2",e);}get radialSpeedGraph2(){return this.data.radialSpeedGraph2}set scaleGraph(e){this._setValue("scaleGraph",e);}get scaleGraph(){return this.data.scaleGraph}set scaleGraph2(e){this._setValue("scaleGraph2",e);}get scaleGraph2(){return this.data.scaleGraph2}set colorGraph(e){this._setValue("colorGraph",e);}get colorGraph(){return this.data.colorGraph}set colorGraph2(e){this._setValue("colorGraph2",e);}get colorGraph2(){return this.data.colorGraph2}set alphaGraph(e){this._setValue("alphaGraph",e);}get alphaGraph(){return this.data.alphaGraph}set alphaGraph2(e){this._setValue("alphaGraph2",e);}get alphaGraph2(){return this.data.alphaGraph2}set colorMap(e){this._setValue("colorMap",e);}get colorMap(){return this.data.colorMap}set normalMap(e){this._setValue("normalMap",e);}get normalMap(){return this.data.normalMap}set animTilesX(e){this._setValue("animTilesX",e);}get animTilesX(){return this.data.animTilesX}set animTilesY(e){this._setValue("animTilesY",e);}get animTilesY(){return this.data.animTilesY}set animStartFrame(e){this._setValue("animStartFrame",e);}get animStartFrame(){return this.data.animStartFrame}set animNumFrames(e){this._setValue("animNumFrames",e);}get animNumFrames(){return this.data.animNumFrames}set animNumAnimations(e){this._setValue("animNumAnimations",e);}get animNumAnimations(){return this.data.animNumAnimations}set animIndex(e){this._setValue("animIndex",e);}get animIndex(){return this.data.animIndex}set randomizeAnimIndex(e){this._setValue("randomizeAnimIndex",e);}get randomizeAnimIndex(){return this.data.randomizeAnimIndex}set animSpeed(e){this._setValue("animSpeed",e);}get animSpeed(){return this.data.animSpeed}set animLoop(e){this._setValue("animLoop",e);}get animLoop(){return this.data.animLoop}set layers(e){this._setValue("layers",e);}get layers(){return this.data.layers}set drawOrder(e){this._drawOrder=e,this.emitter&&(this.emitter.drawOrder=e);}get drawOrder(){return this._drawOrder}_setValue(e,t){let i=this.data,s=i[e];i[e]=t,this.fire("set",e,s,t);}addMeshInstanceToLayers(){if(this.emitter)for(let e=0;e<this.layers.length;e++){let t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.addMeshInstances([this.emitter.meshInstance]),this.emitter._layer=t);}}removeMeshInstanceFromLayers(){if(this.emitter)for(let e=0;e<this.layers.length;e++){let t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&t.removeMeshInstances([this.emitter.meshInstance]);}}onSetLayers(e,t,i){if(this.emitter){for(let e=0;e<t.length;e++){let i=this.system.app.scene.layers.getLayerById(t[e]);i&&i.removeMeshInstances([this.emitter.meshInstance]);}if(this.enabled&&this.entity.enabled)for(let e=0;e<i.length;e++){let t=this.system.app.scene.layers.getLayerById(i[e]);t&&t.addMeshInstances([this.emitter.meshInstance]);}}}onLayersChanged(e,t){this.addMeshInstanceToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);}onLayerAdded(e){!this.emitter||0>this.layers.indexOf(e.id)||e.addMeshInstances([this.emitter.meshInstance]);}onLayerRemoved(e){!this.emitter||0>this.layers.indexOf(e.id)||e.removeMeshInstances([this.emitter.meshInstance]);}_bindColorMapAsset(e){if(e.on("load",this._onColorMapAssetLoad,this),e.on("unload",this._onColorMapAssetUnload,this),e.on("remove",this._onColorMapAssetRemove,this),e.on("change",this._onColorMapAssetChange,this),e.resource)this._onColorMapAssetLoad(e);else {if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e);}}_unbindColorMapAsset(e){e.off("load",this._onColorMapAssetLoad,this),e.off("unload",this._onColorMapAssetUnload,this),e.off("remove",this._onColorMapAssetRemove,this),e.off("change",this._onColorMapAssetChange,this);}_onColorMapAssetLoad(e){this.colorMap=e.resource;}_onColorMapAssetUnload(e){this.colorMap=null;}_onColorMapAssetRemove(e){this._onColorMapAssetUnload(e);}_onColorMapAssetChange(e){}onSetColorMapAsset(e,t,i){let s=this.system.app.assets;if(t){let e=s.get(t);e&&this._unbindColorMapAsset(e);}if(i){i instanceof fy&&(this.data.colorMapAsset=i.id,i=i.id);let e=s.get(i);e?this._bindColorMapAsset(e):s.once(`add:${i}`,e=>{this._bindColorMapAsset(e);});}else this.colorMap=null;}_bindNormalMapAsset(e){if(e.on("load",this._onNormalMapAssetLoad,this),e.on("unload",this._onNormalMapAssetUnload,this),e.on("remove",this._onNormalMapAssetRemove,this),e.on("change",this._onNormalMapAssetChange,this),e.resource)this._onNormalMapAssetLoad(e);else {if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e);}}_unbindNormalMapAsset(e){e.off("load",this._onNormalMapAssetLoad,this),e.off("unload",this._onNormalMapAssetUnload,this),e.off("remove",this._onNormalMapAssetRemove,this),e.off("change",this._onNormalMapAssetChange,this);}_onNormalMapAssetLoad(e){this.normalMap=e.resource;}_onNormalMapAssetUnload(e){this.normalMap=null;}_onNormalMapAssetRemove(e){this._onNormalMapAssetUnload(e);}_onNormalMapAssetChange(e){}onSetNormalMapAsset(e,t,i){let s=this.system.app.assets;if(t){let e=s.get(t);e&&this._unbindNormalMapAsset(e);}if(i){i instanceof fy&&(this.data.normalMapAsset=i.id,i=i.id);let e=s.get(i);e?this._bindNormalMapAsset(e):s.once(`add:${i}`,e=>{this._bindNormalMapAsset(e);});}else this.normalMap=null;}_bindMeshAsset(e){if(e.on("load",this._onMeshAssetLoad,this),e.on("unload",this._onMeshAssetUnload,this),e.on("remove",this._onMeshAssetRemove,this),e.on("change",this._onMeshAssetChange,this),e.resource)this._onMeshAssetLoad(e);else {if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e);}}_unbindMeshAsset(e){e.off("load",this._onMeshAssetLoad,this),e.off("unload",this._onMeshAssetUnload,this),e.off("remove",this._onMeshAssetRemove,this),e.off("change",this._onMeshAssetChange,this);}_onMeshAssetLoad(e){this._onMeshChanged(e.resource);}_onMeshAssetUnload(e){this.mesh=null;}_onMeshAssetRemove(e){this._onMeshAssetUnload(e);}_onMeshAssetChange(e){}onSetMeshAsset(e,t,i){let s=this.system.app.assets;if(t){let e=s.get(t);e&&this._unbindMeshAsset(e);}if(i){i instanceof fy&&(this.data.meshAsset=i.id,i=i.id);let e=s.get(i);e&&this._bindMeshAsset(e);}else this._onMeshChanged(null);}onSetMesh(e,t,i){!i||i instanceof fy||"number"==typeof i?this.meshAsset=i:this._onMeshChanged(i);}_onMeshChanged(e){!e||e instanceof n7||(e=e.meshInstances[0]?e.meshInstances[0].mesh:null),this.data.mesh=e,this.emitter&&(this.emitter.mesh=e,this.emitter.resetMaterial(),this.rebuild());}onSetRenderAsset(e,t,i){let s=this.system.app.assets;if(t){let e=s.get(t);e&&this._unbindRenderAsset(e);}if(i){i instanceof fy&&(this.data.renderAsset=i.id,i=i.id);let e=s.get(i);e&&this._bindRenderAsset(e);}else this._onRenderChanged(null);}_bindRenderAsset(e){if(e.on("load",this._onRenderAssetLoad,this),e.on("unload",this._onRenderAssetUnload,this),e.on("remove",this._onRenderAssetRemove,this),e.resource)this._onRenderAssetLoad(e);else {if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(e);}}_unbindRenderAsset(e){e.off("load",this._onRenderAssetLoad,this),e.off("unload",this._onRenderAssetUnload,this),e.off("remove",this._onRenderAssetRemove,this),this._evtSetMeshes?.off(),this._evtSetMeshes=null;}_onRenderAssetLoad(e){this._onRenderChanged(e.resource);}_onRenderAssetUnload(e){this._onRenderChanged(null);}_onRenderAssetRemove(e){this._onRenderAssetUnload(e);}_onRenderChanged(e){e?(this._evtSetMeshes?.off(),this._evtSetMeshes=e.on("set:meshes",this._onRenderSetMeshes,this),e.meshes&&this._onRenderSetMeshes(e.meshes)):this._onMeshChanged(null);}_onRenderSetMeshes(e){this._onMeshChanged(e&&e[0]);}onSetLoop(e,t,i){this.emitter&&(this.emitter[e]=i,this.emitter.resetTime());}onSetBlendType(e,t,i){this.emitter&&(this.emitter[e]=i,this.emitter.material.blendType=i,this.emitter.resetMaterial(),this.rebuild());}_requestDepth(){!this._requestedDepth&&(l||(l=this.system.app.scene.layers.getLayerById(1)),l&&(l.incrementCounter(),this._requestedDepth=true));}_releaseDepth(){this._requestedDepth&&l&&(l.decrementCounter(),this._requestedDepth=false);}onSetDepthSoftening(e,t,i){t!==i&&(i?this.enabled&&this.entity.enabled&&this._requestDepth():this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[e]=i),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()));}onSetSimpleProperty(e,t,i){this.emitter&&(this.emitter[e]=i,this.emitter.resetMaterial());}onSetComplexProperty(e,t,i){this.emitter&&(this.emitter[e]=i,this.emitter.resetMaterial(),this.rebuild(),this.reset());}onSetGraphProperty(e,t,i){this.emitter&&(this.emitter[e]=i,this.emitter.rebuildGraphs(),this.emitter.resetMaterial());}onEnable(){let e=this.system.app.scene,t=e.layers,i=this.data;for(let e=0,t=_q.length;e<t;e++){let t=i[_q[e]];if(t){if(!(t instanceof fy)){if(!(parseInt(t,10)>=0))continue;t=this.system.app.assets.get(t);}t&&!t.resource&&this.system.app.assets.load(t);}}if(!this.system.app.graphicsDevice.disableParticleSystem){if(!this.emitter){let e=i.mesh;e instanceof n7||(e=null),this.emitter=new cd(this.system.app.graphicsDevice,{numParticles:i.numParticles,emitterExtents:i.emitterExtents,emitterExtentsInner:i.emitterExtentsInner,emitterRadius:i.emitterRadius,emitterRadiusInner:i.emitterRadiusInner,emitterShape:i.emitterShape,initialVelocity:i.initialVelocity,wrap:i.wrap,localSpace:i.localSpace,screenSpace:i.screenSpace,wrapBounds:i.wrapBounds,lifetime:i.lifetime,rate:i.rate,rate2:i.rate2,orientation:i.orientation,particleNormal:i.particleNormal,animTilesX:i.animTilesX,animTilesY:i.animTilesY,animStartFrame:i.animStartFrame,animNumFrames:i.animNumFrames,animNumAnimations:i.animNumAnimations,animIndex:i.animIndex,randomizeAnimIndex:i.randomizeAnimIndex,animSpeed:i.animSpeed,animLoop:i.animLoop,startAngle:i.startAngle,startAngle2:i.startAngle2,scaleGraph:i.scaleGraph,scaleGraph2:i.scaleGraph2,colorGraph:i.colorGraph,colorGraph2:i.colorGraph2,alphaGraph:i.alphaGraph,alphaGraph2:i.alphaGraph2,localVelocityGraph:i.localVelocityGraph,localVelocityGraph2:i.localVelocityGraph2,velocityGraph:i.velocityGraph,velocityGraph2:i.velocityGraph2,rotationSpeedGraph:i.rotationSpeedGraph,rotationSpeedGraph2:i.rotationSpeedGraph2,radialSpeedGraph:i.radialSpeedGraph,radialSpeedGraph2:i.radialSpeedGraph2,colorMap:i.colorMap,normalMap:i.normalMap,loop:i.loop,preWarm:i.preWarm,sort:i.sort,stretch:i.stretch,alignToMotion:i.alignToMotion,lighting:i.lighting,halfLambert:i.halfLambert,intensity:i.intensity,depthSoftening:i.depthSoftening,scene:this.system.app.scene,mesh:e,depthWrite:i.depthWrite,noFog:i.noFog,node:this.entity,blendType:i.blendType}),this.emitter.meshInstance.node=this.entity,this.emitter.drawOrder=this.drawOrder,i.autoPlay||(this.pause(),this.emitter.meshInstance.visible=false);}this.emitter.colorMap&&this.addMeshInstanceToLayers(),this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&i.depthSoftening&&this._requestDepth();}}onDisable(){let e=this.system.app.scene.layers;this._evtLayersChanged?.off(),this._evtLayersChanged=null,e&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this.emitter&&(this.removeMeshInstanceFromLayers(),this.data.depthSoftening&&this._releaseDepth(),this.emitter.camera=null);}onBeforeRemove(){this.enabled&&(this.enabled=false),this.emitter&&(this.emitter.destroy(),this.emitter=null);for(let e=0;e<_q.length;e++){let t=_q[e];this.data[t]&&(this[t]=null);}this.off();}reset(){this.emitter&&this.emitter.reset();}stop(){this.emitter&&(this.emitter.loop=false,this.emitter.resetTime(),this.emitter.addTime(0,true));}pause(){this.data.paused=true;}unpause(){this.data.paused=false;}play(){this.data.paused=false,this.emitter&&(this.emitter.meshInstance.visible=true,this.emitter.loop=this.data.loop,this.emitter.resetTime());}isPlaying(){return !this.data.paused&&(!!this.emitter&&!!this.emitter.loop||Date.now()<=this.emitter.endTime)}setInTools(){let{emitter:e}=this;e&&!e.inTools&&(e.inTools=true,this.rebuild());}rebuild(){let e=this.enabled;this.enabled=false,this.emitter&&this.emitter.rebuild(),this.enabled=e;}constructor(e,t){super(e,t),this._requestedDepth=false,this._drawOrder=0,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._evtSetMeshes=null,this.on("set_colorMapAsset",this.onSetColorMapAsset,this),this.on("set_normalMapAsset",this.onSetNormalMapAsset,this),this.on("set_meshAsset",this.onSetMeshAsset,this),this.on("set_mesh",this.onSetMesh,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_loop",this.onSetLoop,this),this.on("set_blendType",this.onSetBlendType,this),this.on("set_depthSoftening",this.onSetDepthSoftening,this),this.on("set_layers",this.onSetLayers,this),_W.forEach(e=>{this.on(`set_${e}`,this.onSetSimpleProperty,this);}),_X.forEach(e=>{this.on(`set_${e}`,this.onSetComplexProperty,this);}),_Y.forEach(e=>{this.on(`set_${e}`,this.onSetGraphProperty,this);});}}class _j{constructor(){this.numParticles=1,this.rate=1,this.rate2=null,this.startAngle=0,this.startAngle2=null,this.lifetime=50,this.emitterExtents=new ed,this.emitterExtentsInner=new ed,this.emitterRadius=0,this.emitterRadiusInner=0,this.emitterShape=0,this.initialVelocity=0,this.wrap=false,this.wrapBounds=new ed,this.localSpace=false,this.screenSpace=false,this.colorMap=null,this.colorMapAsset=null,this.normalMap=null,this.normalMapAsset=null,this.loop=true,this.preWarm=false,this.sort=0,this.mode=0,this.scene=null,this.lighting=false,this.halfLambert=false,this.intensity=1,this.stretch=0,this.alignToMotion=false,this.depthSoftening=0,this.renderAsset=null,this.meshAsset=null,this.mesh=null,this.depthWrite=false,this.noFog=false,this.orientation=0,this.particleNormal=new ed(0,1,0),this.animTilesX=1,this.animTilesY=1,this.animStartFrame=0,this.animNumFrames=1,this.animNumAnimations=1,this.animIndex=0,this.randomizeAnimIndex=false,this.animSpeed=1,this.animLoop=true,this.scaleGraph=null,this.scaleGraph2=null,this.colorGraph=null,this.colorGraph2=null,this.alphaGraph=null,this.alphaGraph2=null,this.localVelocityGraph=null,this.localVelocityGraph2=null,this.velocityGraph=null,this.velocityGraph2=null,this.rotationSpeedGraph=null,this.rotationSpeedGraph2=null,this.radialSpeedGraph=null,this.radialSpeedGraph2=null,this.blendType=2,this.enabled=true,this.paused=false,this.autoPlay=true,this.layers=[0];}}let _K={particlePS:`
varying vec4 texCoordsAlphaLife;
uniform sampler2D colorMap;
uniform sampler2D colorParam;
uniform float graphSampleSize;
uniform float graphNumSamples;
#ifndef CAMERAPLANES
	#define CAMERAPLANES
	uniform vec4 camera_params;
#endif
#ifdef SOFT
	uniform float softening;
#endif
uniform float colorMult;
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
void main(void) {
	vec4 tex  = texture2D(colorMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y));
	vec4 ramp = texture2D(colorParam, vec2(texCoordsAlphaLife.w, 0.0));
	ramp.rgb *= colorMult;
	ramp.a += texCoordsAlphaLife.z;
	vec3 rgb = tex.rgb * ramp.rgb;
	float a  = tex.a * ramp.a;
`,particleVS:`
vec3 unpack3NFloats(float src) {
	float r = fract(src);
	float g = fract(src * 256.0);
	float b = fract(src * 65536.0);
	return vec3(r, g, b);
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec4 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc) {
	return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );
}
vec4 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc, out vec3 w) {
	vec4 a = texture2D(tex,tc);
	vec4 b = texture2D(tex,tc + graphSampleSize);
	float c = fract(tc.x*graphNumSamples);
	vec3 unpackedA = unpack3NFloats(a.w);
	vec3 unpackedB = unpack3NFloats(b.w);
	w = mix(unpackedA, unpackedB, c);
	return mix(a, b, c);
}
vec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {
	float c = cos(pRotation);
	float s = sin(pRotation);
	mat2 m = mat2(c, -s, s, c);
	rotMatrix = m;
	return m * quadXY;
}
vec3 billboard(vec3 InstanceCoords, vec2 quadXY) {
	#ifdef SCREEN_SPACE
		vec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;
	#else
		vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;
	#endif
	return pos;
}
vec3 customFace(vec3 InstanceCoords, vec2 quadXY) {
	vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;
	return pos;
}
vec2 safeNormalize(vec2 v) {
	float l = length(v);
	return (l > 1e-06) ? v / l : v;
}
void main(void) {
	vec3 meshLocalPos = particle_vertexData.xyz;
	float id = floor(particle_vertexData.w);
	float rndFactor = fract(sin(id + 1.0 + seed));
	vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));
	float uv = id / numParticlesPot;
	readInput(uv);
#ifdef LOCAL_SPACE
	inVel = mat3(matrix_model) * inVel;
#endif
	vec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);
	float particleLifetime = lifetime;
	if (inLife <= 0.0 || inLife > particleLifetime || !inShow)
		meshLocalPos = vec3(0.0);
	vec2 quadXY = meshLocalPos.xy;
	float nlife = clamp(inLife / particleLifetime, 0.0, 1.0);
	vec3 paramDiv;
	vec4 params = tex1Dlod_lerp(TEXTURE_PASS(internalTex2), vec2(nlife, 0), paramDiv);
	float scale = params.y;
	float scaleDiv = paramDiv.x;
	float alphaDiv = paramDiv.z;
	scale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);
#ifndef USE_MESH
	texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);
#else
	texCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);
#endif
	vec3 particlePos = inPos;
	vec3 particlePosMoved = vec3(0.0);
	mat2 rotMatrix;
`,particleAnimFrameClampVS:`
	float animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);
`,particleAnimFrameLoopVS:`
	float animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));
`,particleAnimTexVS:`
	float animationIndex;
	if (animTexIndexParams.y == 1.0) {
		animationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);
	} else {
		animationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);
	}
	float atlasX = (animationIndex + animFrame) * animTexTilesParams.x;
	float atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;
	atlasX = fract(atlasX);
	texCoordsAlphaLife.xy *= animTexTilesParams.xy;
	texCoordsAlphaLife.xy += vec2(atlasX, atlasY);
`,particleInputFloatPS:`
void readInput(float uv) {
	vec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));
	vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));
	inPos = tex.xyz;
	inVel = tex2.xyz;
	inAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;
	inShow = tex.w >= 0.0;
	inLife = tex2.w;
}
`,particleInputRgba8PS:`
#define PI2 6.283185307179586
uniform vec3 inBoundsSize;
uniform vec3 inBoundsCenter;
uniform float maxVel;
float decodeFloatRG(vec2 rg) {
	return rg.y * (1.0 / 255.0) + rg.x;
}
float decodeFloatRGBA( vec4 rgba ) {
	return dot(rgba, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));
}
void readInput(float uv) {
	vec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));
	vec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));
	vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));
	vec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));
	inPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));
	inPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;
	inVel = tex2.xyz;
	inVel = (inVel - vec3(0.5)) * maxVel;
	inAngle = decodeFloatRG(tex1.ba) * PI2;
	inShow = tex2.a > 0.5;
	inLife = decodeFloatRGBA(tex3);
	float maxNegLife = max(lifetime, numParticles * (rate+rateDiv));
	float maxPosLife = lifetime+1.0;
	inLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;
}
`,particleOutputFloatPS:`
void writeOutput() {
	if (gl_FragCoord.y<1.0) {
		gl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);
	} else {
		gl_FragColor = vec4(outVel, outLife);
	}
}
`,particleOutputRgba8PS:`
uniform vec3 outBoundsMul;
uniform vec3 outBoundsAdd;
vec2 encodeFloatRG( float v ) {
	vec2 enc = vec2(1.0, 255.0) * v;
	enc = fract(enc);
	enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);
	return enc;
}
vec4 encodeFloatRGBA( float v ) {
	vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;
	enc = fract(enc);
	enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);
	return enc;
}
void writeOutput() {
	outPos = outPos * outBoundsMul + outBoundsAdd;
	outAngle = fract(outAngle / PI2);
	outVel = (outVel / maxVel) + vec3(0.5);
	float maxNegLife = max(lifetime, numParticles * (rate+rateDiv));
	float maxPosLife = lifetime+1.0;
	outLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);
	if (gl_FragCoord.y < 1.0) {
		gl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));
	} else if (gl_FragCoord.y < 2.0) {
		gl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));
	} else if (gl_FragCoord.y < 3.0) {
		gl_FragColor = vec4(outVel, visMode*0.5+0.5);
	} else {
		gl_FragColor = encodeFloatRGBA(outLife);
	}
}
`,particleUpdaterAABBPS:`
uniform mat3 spawnBounds;
uniform vec3 spawnPosInnerRatio;
vec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {
	vec3 pos = inBounds - vec3(0.5);
	vec3 posAbs = abs(pos);
	vec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));
	vec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;
	pos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);
	pos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);
	pos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);
#ifndef LOCAL_SPACE
	return emitterPos + spawnBounds * pos;
#else
	return spawnBounds * pos;
#endif
}
void addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {
	localVelocity -= vec3(0, 0, initialVelocity);
}
`,particleUpdaterEndPS:`
	writeOutput();
}
`,particleUpdaterInitPS:`
varying vec2 vUv0;
uniform highp sampler2D particleTexIN;
uniform highp sampler2D internalTex0;
uniform highp sampler2D internalTex1;
uniform highp sampler2D internalTex2;
uniform highp sampler2D internalTex3;
uniform mat3 emitterMatrix;
uniform mat3 emitterMatrixInv;
uniform vec3 emitterScale;
uniform vec3 emitterPos;
uniform vec3 frameRandom;
uniform vec3 localVelocityDivMult;
uniform vec3 velocityDivMult;
uniform float delta;
uniform float rate;
uniform float rateDiv;
uniform float lifetime;
uniform float numParticles;
uniform float rotSpeedDivMult;
uniform float radialSpeedDivMult;
uniform float seed;
uniform float startAngle;
uniform float startAngle2;
uniform float initialVelocity;
uniform float graphSampleSize;
uniform float graphNumSamples;
vec3 inPos;
vec3 inVel;
float inAngle;
bool inShow;
float inLife;
float visMode;
vec3 outPos;
vec3 outVel;
float outAngle;
bool outShow;
float outLife;
`,particleUpdaterNoRespawnPS:`
	if (outLife >= lifetime) {
		outLife -= max(lifetime, numParticles * particleRate);
		visMode = -1.0;
	}
`,particleUpdaterOnStopPS:`
	visMode = outLife < 0.0? -1.0: visMode;
`,particleUpdaterRespawnPS:`
	if (outLife >= lifetime) {
		outLife -= max(lifetime, numParticles * particleRate);
		visMode = 1.0;
	}
	visMode = outLife < 0.0? 1.0: visMode;
`,particleUpdaterSpherePS:`
uniform float spawnBoundsSphere;
uniform float spawnBoundsSphereInnerRatio;
vec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {
	float rnd4 = fract(rndFactor * 1000.0);
	vec3 norm = normalize(inBounds.xyz - vec3(0.5));
	float r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;
#ifndef LOCAL_SPACE
	return emitterPos + norm * r * spawnBoundsSphere;
#else
	return norm * r * spawnBoundsSphere;
#endif
}
void addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {
	localVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;
}
`,particleUpdaterStartPS:`
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec3 unpack3NFloats(float src) {
	float r = fract(src);
	float g = fract(src * 256.0);
	float b = fract(src * 65536.0);
	return vec3(r, g, b);
}
vec3 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc, out vec3 w) {
	vec4 a = texture2D(tex, tc);
	vec4 b = texture2D(tex, tc + graphSampleSize);
	float c = fract(tc.x * graphNumSamples);
	vec3 unpackedA = unpack3NFloats(a.w);
	vec3 unpackedB = unpack3NFloats(b.w);
	w = mix(unpackedA, unpackedB, c);
	return mix(a.xyz, b.xyz, c);
}
#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)
vec4 hash41(float p) {
	vec4 p4 = fract(vec4(p) * HASHSCALE4);
	p4 += dot(p4, p4.wzxy+19.19);
	return fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));
}
void main(void) {
	if (gl_FragCoord.x > numParticles) discard;
	readInput(vUv0.x);
	visMode = inShow? 1.0 : -1.0;
	vec4 rndFactor = hash41(gl_FragCoord.x + seed);
	float particleRate = rate + rateDiv * rndFactor.x;
	outLife = inLife + delta;
	float nlife = clamp(outLife / lifetime, 0.0, 1.0);
	vec3 localVelocityDiv;
	vec3 velocityDiv;
	vec3 paramDiv;
	vec3 localVelocity = tex1Dlod_lerp(TEXTURE_PASS(internalTex0), vec2(nlife, 0), localVelocityDiv);
	vec3 velocity =	  tex1Dlod_lerp(TEXTURE_PASS(internalTex1), vec2(nlife, 0), velocityDiv);
	vec3 params =		tex1Dlod_lerp(TEXTURE_PASS(internalTex2), vec2(nlife, 0), paramDiv);
	float rotSpeed = params.x;
	float rotSpeedDiv = paramDiv.y;
	vec3 radialParams = tex1Dlod_lerp(TEXTURE_PASS(internalTex3), vec2(nlife, 0), paramDiv);
	float radialSpeed = radialParams.x;
	float radialSpeedDiv = radialParams.y;
	bool respawn = inLife <= 0.0 || outLife >= lifetime;
	inPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;
	inAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;
#ifndef LOCAL_SPACE
	vec3 radialVel = inPos - emitterPos;
#else
	vec3 radialVel = inPos;
#endif
	radialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);
	radialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;
	localVelocity +=	(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;
	velocity +=		 (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;
	rotSpeed +=		 (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;
	addInitialVelocity(localVelocity, rndFactor.xyz);
#ifndef LOCAL_SPACE
	outVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;
#else
	outVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;
#endif
	outPos = inPos + outVel * delta;
	outAngle = inAngle + rotSpeed * delta;
`,particle_billboardVS:`
	quadXY = rotate(quadXY, inAngle, rotMatrix);
	vec3 localPos = billboard(particlePos, quadXY);
`,particle_blendAddPS:`
	dBlendModeFogFactor = 0.0;
	rgb *= saturate(gammaCorrectInput(max(a, 0.0)));
	if ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;
`,particle_blendMultiplyPS:`
	rgb = mix(vec3(1.0), rgb, vec3(a));
	if (rgb.r + rgb.g + rgb.b > 2.99) discard;
`,particle_blendNormalPS:`
	if (a < 0.01) discard;
`,particle_cpuVS:`
attribute vec4 particle_vertexData;
attribute vec4 particle_vertexData2;
attribute vec4 particle_vertexData3;
attribute float particle_vertexData4;
#ifndef USE_MESH
	attribute vec2 particle_vertexData5;
#else
	attribute vec4 particle_vertexData5;
#endif
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform mat4 matrix_view;
#endif
uniform mat3 matrix_normal;
uniform mat4 matrix_viewInverse;
uniform float numParticles;
uniform float lifetime;
uniform float stretch;
uniform float seed;
uniform vec3 emitterScale;
uniform vec3 faceTangent;
uniform vec3 faceBinorm;
#ifdef PARTICLE_GPU
	#ifdef WRAP
		uniform vec3 wrapBounds;
	#endif
#endif
#ifdef PARTICLE_GPU
	uniform highp sampler2D internalTex0;
	uniform highp sampler2D internalTex1;
	uniform highp sampler2D internalTex2;
#endif
uniform vec3 emitterPos;
varying vec4 texCoordsAlphaLife;
vec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)
{
	float c = cos(pRotation);
	float s = sin(pRotation);
	mat2 m = mat2(c, -s, s, c);
	rotMatrix = m;
	return m * quadXY;
}
vec3 billboard(vec3 InstanceCoords, vec2 quadXY)
{
	#ifdef SCREEN_SPACE
		vec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;
	#else
		vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;
	#endif
	return pos;
}
vec3 customFace(vec3 InstanceCoords, vec2 quadXY)
{
	vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;
	return pos;
}
void main(void)
{
	vec3 particlePos = particle_vertexData.xyz;
	vec3 inPos = particlePos;
	vec3 vertPos = particle_vertexData3.xyz;
	vec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);
	float id = floor(particle_vertexData4);
	float rndFactor = fract(sin(id + 1.0 + seed));
	vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));
#ifdef LOCAL_SPACE
	inVel = mat3(matrix_model) * inVel;
#endif
	vec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);
	vec2 quadXY = vertPos.xy;
#ifdef USE_MESH
	texCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);
#else
	texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);
#endif
	mat2 rotMatrix;
	float inAngle = particle_vertexData2.x;
	vec3 particlePosMoved = vec3(0.0);
	vec3 meshLocalPos = particle_vertexData3.xyz;
`,particle_cpu_endVS:`
	localPos *= particle_vertexData2.y * emitterScale;
	localPos += particlePos;
	#ifdef SCREEN_SPACE
	gl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);
	#else
	gl_Position = matrix_viewProjection * vec4(localPos, 1.0);
	#endif
`,particle_customFaceVS:`
	quadXY = rotate(quadXY, inAngle, rotMatrix);
	vec3 localPos = customFace(particlePos, quadXY);
`,particle_endPS:`
	rgb = addFog(rgb);
	rgb = toneMap(rgb);
	rgb = gammaCorrectOutput(rgb);
	gl_FragColor = vec4(rgb, a);
}
`,particle_endVS:`
	localPos *= scale * emitterScale;
	localPos += particlePos;
	#ifdef SCREEN_SPACE
	gl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);
	#else
	gl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);
	#endif
`,particle_halflambertPS:`
	vec3 negNormal = normal * 0.5 + 0.5;
	vec3 posNormal = -normal * 0.5 + 0.5;
	negNormal *= negNormal;
	posNormal *= posNormal;
`,particle_initVS:`
attribute vec4 particle_vertexData;
#if defined(USE_MESH)
	#if defined(USE_MESH_UV)
		attribute vec2 particle_uv;
	#else
		vec2 particle_uv = vec2(0.0, 0.0);
	#endif
#endif
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
uniform mat3 matrix_normal;
uniform mat4 matrix_viewInverse;
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform mat4 matrix_view;
#endif
uniform float numParticles;
uniform float numParticlesPot;
uniform float graphSampleSize;
uniform float graphNumSamples;
uniform float stretch;
uniform vec3 emitterScale;
uniform vec3 emitterPos;
uniform vec3 faceTangent;
uniform vec3 faceBinorm;
uniform float rate;
uniform float rateDiv;
uniform float lifetime;
uniform float scaleDivMult;
uniform float alphaDivMult;
uniform float seed;
uniform float delta;
uniform sampler2D particleTexOUT;
uniform sampler2D particleTexIN;
#ifdef PARTICLE_GPU
	#ifdef WRAP
		uniform vec3 wrapBounds;
	#endif
#endif
#ifdef PARTICLE_GPU
	uniform highp sampler2D internalTex0;
	uniform highp sampler2D internalTex1;
	uniform highp sampler2D internalTex2;
#endif
#ifndef CAMERAPLANES
	#define CAMERAPLANES
	uniform vec4 camera_params;
#endif
varying vec4 texCoordsAlphaLife;
vec3 inPos;
vec3 inVel;
float inAngle;
bool inShow;
float inLife;
`,particle_lambertPS:`
	vec3 negNormal = max(normal, vec3(0.0));
	vec3 posNormal = max(-normal, vec3(0.0));
`,particle_lightingPS:`
	vec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +
						negNormal.y*lightCube[2] + posNormal.y*lightCube[3] +
						negNormal.z*lightCube[4] + posNormal.z*lightCube[5];
	rgb *= light;
`,particle_localShiftVS:`
	particlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;
`,particle_meshVS:`
	vec3 localPos = meshLocalPos;
	localPos.xy = rotate(localPos.xy, inAngle, rotMatrix);
	localPos.yz = rotate(localPos.yz, inAngle, rotMatrix);
	billboard(particlePos, quadXY);
`,particle_normalVS:`
	Normal = normalize(localPos + matrix_viewInverse[2].xyz);
`,particle_normalMapPS:`
	vec3 normalMap = normalize(texture2D(normalMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)).xyz * 2.0 - 1.0);
	vec3 normal = ParticleMat * normalMap;
`,particle_pointAlongVS:`
	inAngle = atan(velocityV.x, velocityV.y);
`,particle_simulationPS:`
	#include "particleUpdaterInitPS"
	#ifdef PACK8
		#include "particleInputRgba8PS"
		#include "particleOutputRgba8PS"
	#else
		#include "particleInputFloatPS"
		#include "particleOutputFloatPS"
	#endif
	#ifdef EMITTERSHAPE_BOX
		#include "particleUpdaterAABBPS"
	#else
		#include "particleUpdaterSpherePS"
	#endif
	#include "particleUpdaterStartPS"
	#ifdef RESPAWN
		#include "particleUpdaterRespawnPS"
	#endif
	#ifdef NO_RESPAWN
		#include "particleUpdaterNoRespawnPS"
	#endif
	#ifdef ON_STOP
		#include "particleUpdaterOnStopPS"
	#endif
	#include "particleUpdaterEndPS"
`,particle_shaderPS:`
	#if NORMAL != NONE
		#if NORMAL == VERTEX
			varying vec3 Normal;
		#endif
		#if NORMAL == MAP
			varying mat3 ParticleMat;
		#endif
		uniform vec3 lightCube[6];
	#endif
	#ifdef SOFT
		varying float vDepth;
		#include "screenDepthPS"
	#endif
	#include "gammaPS"
	#include "tonemappingPS"
	#include "fogPS"
	#if NORMAL == MAP
		uniform sampler2D normalMap;
	#endif
	#include "particlePS"
	#ifdef SOFT
		#include "particle_softPS"
	#endif
	#if NORMAL == VERTEX
		vec3 normal = Normal;
	#endif
	#if NORMAL == MAP
		#include "particle_normalMapPS"
	#endif
	#if NORMAL != NONE
		#ifdef HALF_LAMBERT
			#include "particle_halflambertPS"
		#else
			#include "particle_lambertPS"
		#endif
		#include "particle_lightingPS"
	#endif
	#if BLEND == NORMAL
		#include "particle_blendNormalPS"
	#elif BLEND == ADDITIVE
		#include "particle_blendAddPS"
	#elif BLEND == MULTIPLICATIVE
		#include "particle_blendMultiplyPS"
	#endif
	#include "particle_endPS"
`,particle_shaderVS:`
	#ifdef ANIMTEX
		uniform vec2 animTexTilesParams;
		uniform vec4 animTexParams;
		uniform vec2 animTexIndexParams;
	#endif
	#if NORMAL == MAP
		varying mat3 ParticleMat;
	#endif
	#if NORMAL == VERTEX
		varying vec3 Normal;
	#endif
	#ifdef SOFT
		varying float vDepth;
	#endif
	#ifdef PARTICLE_GPU
		#include "particle_initVS"
		#ifdef PACK8
			#include "particleInputRgba8PS"
		#else
			#include  "particleInputFloatPS"
		#endif
		#ifdef SOFT
			#include "screenDepthPS"
		#endif
		#include "particleVS"
	#else
		#ifdef SOFT
			#include "screenDepthPS"
		#endif
		#include "particle_cpuVS"
	#endif
	#ifdef LOCAL_SPACE
		#include "particle_localShiftVS"
	#endif
	#ifdef ANIMTEX
		#ifdef ANIMTEX_LOOP
			#include "particleAnimFrameLoopVS"
		#else
			#include "particleAnimFrameClampVS"
		#endif
		#include "particleAnimTexVS"
	#endif
	#ifdef PARTICLE_GPU
		#ifdef WRAP
			#include "particle_wrapVS"
		#endif
	#endif
	#ifdef ALIGN_TO_MOTION
		#include "particle_pointAlongVS"
	#endif
	#ifdef USE_MESH
		#include "particle_meshVS"
	#else
		#ifdef CUSTOM_FACE
			#include "particle_customFaceVS"
		#else
			#include "particle_billboardVS"
		#endif
	#endif
	#if NORMAL == VERTEX
		#include "particle_normalVS"
	#endif
	#if NORMAL == MAP
		#include "particle_TBNVS"
	#endif
	#ifdef STRETCH
		#include "particle_stretchVS"
	#endif
	#ifdef PARTICLE_GPU
		#include "particle_endVS"
	#else
		#include "particle_cpu_endVS"
	#endif
	#ifdef SOFT
		#include "particle_softVS"
	#endif
	}
`,particle_softPS:`
	float depth = getLinearScreenDepth();
	float particleDepth = vDepth;
	float depthDiff = saturate(abs(particleDepth - depth) * softening);
	a *= depthDiff;
`,particle_softVS:`
	vDepth = getLinearDepth(localPos);
`,particle_stretchVS:`
	vec3 moveDir = inVel * stretch;
	vec3 posPrev = particlePos - moveDir;
	posPrev += particlePosMoved;
	vec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);
	float interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;
	particlePos = mix(particlePos, posPrev, interpolation);
`,particle_TBNVS:`
	mat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);
	ParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;
`,particle_wrapVS:`
	vec3 origParticlePos = particlePos;
	particlePos -= matrix_model[3].xyz;
	particlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;
	particlePos += matrix_model[3].xyz;
	particlePosMoved = particlePos - origParticlePos;
`},_Z={particlePS:`
varying texCoordsAlphaLife: vec4f;
var colorMap: texture_2d<f32>;
var colorMapSampler: sampler;
var colorParam: texture_2d<f32>;
var colorParamSampler: sampler;
uniform graphSampleSize: f32;
uniform graphNumSamples: f32;
#ifndef CAMERAPLANES
	#define CAMERAPLANES
	uniform camera_params: vec4f;
#endif
#ifdef SOFT
	uniform softening: f32;
#endif
uniform colorMult: f32;
fn saturate(x: f32) -> f32 {
	return clamp(x, 0.0, 1.0);
}
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let tex: vec4f  = textureSample(colorMap, colorMapSampler, vec2f(input.texCoordsAlphaLife.x, 1.0 - input.texCoordsAlphaLife.y));
	var ramp: vec4f = textureSample(colorParam, colorParamSampler, vec2f(input.texCoordsAlphaLife.w, 0.0));
	ramp = vec4f(ramp.rgb * uniform.colorMult, ramp.a);
	ramp.a = ramp.a + input.texCoordsAlphaLife.z;
	var rgb: vec3f = tex.rgb * ramp.rgb;
	var a: f32 = tex.a * ramp.a;
`,particleVS:`
fn unpack3NFloats(src: f32) -> vec3f {
	let r = fract(src);
	let g = fract(src * 256.0);
	let b = fract(src * 65536.0);
	return vec3f(r, g, b);
}
fn saturate(x: f32) -> f32 {
	return clamp(x, 0.0, 1.0);
}
struct TexLerpUnpackResult {
	result: vec4f,
	unpacked: vec3f
}
fn tex1Dlod_lerp_simple(tex: texture_2d<f32>, textureSize: vec2u, tc: vec2f) -> vec4f {
	let tc_next = tc + vec2f(uniform.graphSampleSize);
	let texelA: vec2i = vec2i(tc * vec2f(textureSize));
	let texelB: vec2i = vec2i(tc_next * vec2f(textureSize));
	return mix( textureLoad(tex, texelA, 0), textureLoad(tex, texelB, 0), fract(tc.x * uniform.graphNumSamples) );
}
fn tex1Dlod_lerp_unpack(tex: texture_2d<f32>, textureSize: vec2u, tc: vec2f) -> TexLerpUnpackResult {
	let tc_next = tc + vec2f(uniform.graphSampleSize);
	let texelA: vec2i = vec2i(tc * vec2f(textureSize));
	let texelB: vec2i = vec2i(tc_next * vec2f(textureSize));
	let a = textureLoad(tex, texelA, 0);
	let b = textureLoad(tex, texelB, 0);
	let c = fract(tc.x * uniform.graphNumSamples);
	let unpackedA = unpack3NFloats(a.w);
	let unpackedB = unpack3NFloats(b.w);
	let w_out = mix(unpackedA, unpackedB, c);
	return TexLerpUnpackResult(mix(a, b, c), w_out);
}
struct RotateResult {
	rotatedVec: vec2f,
	matrix: mat2x2f
}
fn rotateWithMatrix(quadXY: vec2f, pRotation: f32) -> RotateResult {
	let c = cos(pRotation);
	let s = sin(pRotation);
	let m = mat2x2f(vec2f(c, -s), vec2f(s, c));
	return RotateResult(m * quadXY, m);
}
fn billboard(InstanceCoords: vec3f, quadXY: vec2f) -> vec3f {
	var pos: vec3f;
	#ifdef SCREEN_SPACE
		pos = vec3f(-1.0, 0.0, 0.0) * quadXY.x + vec3f(0.0, -1.0, 0.0) * quadXY.y;
	#else
		pos = -uniform.matrix_viewInverse[0].xyz * quadXY.x + -uniform.matrix_viewInverse[1].xyz * quadXY.y;
	#endif
	return pos;
}
fn customFace(InstanceCoords: vec3f, quadXY: vec2f) -> vec3f {
	let pos = uniform.faceTangent * quadXY.x + uniform.faceBinorm * quadXY.y;
	return pos;
}
fn safeNormalize(v: vec2f) -> vec2f {
	let l = length(v);
	return select(v, v / l, l > 1e-06);
}
@vertex
fn vertexMain(input: VertexInput) -> VertexOutput {
	var output: VertexOutput;
	let meshLocalPos_in = input.particle_vertexData.xyz;
	let id = floor(input.particle_vertexData.w);
	let rndFactor = fract(sin(id + 1.0 + uniform.seed));
	let rndFactor3 = vec3f(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));
	let uv = id / uniform.numParticlesPot;
	readInput(uv);
	#ifdef LOCAL_SPACE
		let modelRotation = mat3x3f(uniform.matrix_model[0].xyz, uniform.matrix_model[1].xyz, uniform.matrix_model[2].xyz);
		inVel = modelRotation * inVel;
	#endif
	let viewRotation = mat3x3f(uniform.matrix_view[0].xyz, uniform.matrix_view[1].xyz, uniform.matrix_view[2].xyz);
	let velocityV = safeNormalize((viewRotation * inVel).xy);
	let particleLifetime = uniform.lifetime;
	var meshLocalPos = meshLocalPos_in;
	if (inLife <= 0.0 || inLife > particleLifetime || !inShow) {
		 meshLocalPos = vec3f(0.0);
	}
	let quadXY = meshLocalPos.xy;
	let nlife = clamp(inLife / particleLifetime, 0.0, 1.0);
	let internalTexSize = textureDimensions(internalTex2, 0);
	let lerp_result = tex1Dlod_lerp_unpack(internalTex2, internalTexSize, vec2f(nlife, 0.0));
	let params = lerp_result.result;
	let paramDiv = lerp_result.unpacked;
	var scale = params.y;
	let scaleDiv = paramDiv.x;
	let alphaDiv = paramDiv.z;
	scale = scale + (scaleDiv * 2.0 - 1.0) * uniform.scaleDivMult * fract(rndFactor*10000.0);
	#ifndef USE_MESH
		output.texCoordsAlphaLife = vec4f(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * uniform.alphaDivMult * fract(rndFactor*1000.0), nlife);
	#else
		output.texCoordsAlphaLife = vec4f(particle_uv, (alphaDiv * 2.0 - 1.0) * uniform.alphaDivMult * fract(rndFactor*1000.0), nlife);
	#endif
	var particlePos = inPos;
	var particlePosMoved = vec3f(0.0);
	var rotMatrix: mat2x2f;
`,particleAnimFrameClampVS:`
	let animFrame: f32 = min(floor(input.texCoordsAlphaLife.w * uniform.animTexParams.y) + uniform.animTexParams.x, uniform.animTexParams.z);
`,particleAnimFrameLoopVS:`
	let animFrame: f32 = floor((output.texCoordsAlphaLife.w * uniform.animTexParams.y + uniform.animTexParams.x) % (uniform.animTexParams.z + 1.0));	
`,particleAnimTexVS:`
	var animationIndex: f32;
	if (uniform.animTexIndexParams.y == 1.0) {
		animationIndex = floor((uniform.animTexParams.w + 1.0) * rndFactor3.z) * (uniform.animTexParams.z + 1.0);
	} else {
		animationIndex = uniform.animTexIndexParams.x * (uniform.animTexParams.z + 1.0);
	}
	var atlasX: f32 = (animationIndex + animFrame) * uniform.animTexTilesParams.x;
	let atlasY: f32 = 1.0 - floor(atlasX + 1.0) * uniform.animTexTilesParams.y;
	atlasX = fract(atlasX);
	let current_tcal_xy = output.texCoordsAlphaLife.xy;
	let scaled_tcal_xy = current_tcal_xy * uniform.animTexTilesParams.xy;
	let final_tcal_xy = scaled_tcal_xy + vec2f(atlasX, atlasY);
	output.texCoordsAlphaLife = vec4f(final_tcal_xy, output.texCoordsAlphaLife.z, output.texCoordsAlphaLife.w);
`,particleInputFloatPS:`
fn readInput(uv: f32) {
	let textureSize = textureDimensions(particleTexIN, 0);
	let texel0: vec2i = vec2i(vec2f(uv, 0.25) * vec2f(textureSize));
	let texel1: vec2i = vec2i(vec2f(uv, 0.75) * vec2f(textureSize));
	let tex: vec4f = textureLoad(particleTexIN, texel0, 0);
	let tex2: vec4f = textureLoad(particleTexIN, texel1, 0);
	inPos = tex.xyz;
	inVel = tex2.xyz;
	inAngle = abs(tex.w) - 1000.0;
	inShow = tex.w >= 0.0;
	inLife = tex2.w;
}
`,particleInputRgba8PS:`
const PI2: f32 = 6.283185307179586;
uniform inBoundsSize: vec3f;
uniform inBoundsCenter: vec3f;
uniform maxVel: f32;
fn decodeFloatRG(rg: vec2f) -> f32 {
	return rg.y * (1.0 / 255.0) + rg.x;
}
fn decodeFloatRGBA( rgba: vec4f ) -> f32 {
	return dot(rgba, vec4f(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));
}
fn readInput(uv: f32) {
	let textureSize = textureDimensions(particleTexIN, 0);
	let texel0: vec2i = vec2i(vec2f(uv, 0.125) * vec2f(textureSize));
	let texel1: vec2i = vec2i(vec2f(uv, 0.375) * vec2f(textureSize));
	let texel2: vec2i = vec2i(vec2f(uv, 0.625) * vec2f(textureSize));
	let texel3: vec2i = vec2i(vec2f(uv, 0.875) * vec2f(textureSize));
	let tex0 = textureLoad(particleTexIN, texel0, 0);
	let tex1 = textureLoad(particleTexIN, texel1, 0);
	let tex2 = textureLoad(particleTexIN, texel2, 0);
	let tex3 = textureLoad(particleTexIN, texel3, 0);
	inPos = vec3f(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));
	inPos = (inPos - vec3f(0.5)) * uniform.inBoundsSize + uniform.inBoundsCenter;
	inVel = tex2.xyz;
	inVel = (inVel - vec3f(0.5)) * uniform.maxVel;
	inAngle = decodeFloatRG(tex1.ba) * PI2;
	inShow = tex2.a > 0.5;
	let life_decoded = decodeFloatRGBA(tex3);
	let maxNegLife = max(uniform.lifetime, uniform.numParticles * (uniform.rate + uniform.rateDiv));
	let maxPosLife = uniform.lifetime + 1.0;
	inLife = life_decoded * (maxNegLife + maxPosLife) - maxNegLife;
}`,particleOutputFloatPS:`
fn getOutput() -> vec4f {
	if (pcPosition.y < 1.0) {
		return vec4f(outPos, (outAngle + 1000.0) * visMode);
	} else {
		return vec4f(outVel, outLife);
	}
}
`,particleOutputRgba8PS:`
uniform outBoundsMul: vec3f;
uniform outBoundsAdd: vec3f;
fn encodeFloatRG( v: f32 ) -> vec2f {
	var enc: vec2f = vec2f(1.0, 255.0) * v;
	enc = fract(enc);
	enc = enc - enc.yy * (1.0 / 255.0);
	return enc;
}
fn encodeFloatRGBA( v: f32 ) -> vec4f {
	let factors = vec4f(1.0, 255.0, 65025.0, 160581375.0);
	var enc: vec4f = factors * v;
	enc = fract(enc);
	enc = enc - enc.yzww * vec4f(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);
	return enc;
}
fn getOutput() -> vec4f {
	outPos = outPos * uniform.outBoundsMul + uniform.outBoundsAdd;
	outAngle = fract(outAngle / PI2);
	outVel = (outVel / uniform.maxVel) + vec3f(0.5);
	let maxNegLife = max(uniform.lifetime, uniform.numParticles * (uniform.rate + uniform.rateDiv));
	let maxPosLife = uniform.lifetime + 1.0;
	outLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);
	if (pcPosition.y < 1.0) {
		return vec4f(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));
	} else if (pcPosition.y < 2.0) {
		return vec4f(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));
	} else if (pcPosition.y < 3.0) {
		return vec4f(outVel, visMode * 0.5 + 0.5);
	} else {
		return encodeFloatRGBA(outLife);
	}
}
`,particleUpdaterAABBPS:`
uniform spawnBounds: mat3x3f;
uniform spawnPosInnerRatio: vec3f;
fn calcSpawnPosition(inBounds: vec3f, rndFactor: f32) -> vec3f {
	var pos = inBounds - vec3f(0.5);
	let posAbs = abs(pos);
	let maxComp = max(posAbs.x, max(posAbs.y, posAbs.z));
	let maxPos = vec3f(maxComp);
	let edge = maxPos + (vec3f(0.5) - maxPos) * uniform.spawnPosInnerRatio;
	pos.x = edge.x * select(2.0 * pos.x, sign(pos.x), maxPos.x == posAbs.x);
	pos.y = edge.y * select(2.0 * pos.y, sign(pos.y), maxPos.y == posAbs.y);
	pos.z = edge.z * select(2.0 * pos.z, sign(pos.z), maxPos.z == posAbs.z);
	#ifndef LOCAL_SPACE
		return uniform.emitterPos + uniform.spawnBounds * pos;
	#else
		return uniform.spawnBounds * pos;
	#endif
}
fn addInitialVelocity(localVelocity: ptr<function, vec3f>, inBounds: vec3f) {
	*localVelocity = *localVelocity - vec3f(0.0, 0.0, uniform.initialVelocity);
}
`,particleUpdaterEndPS:`
	output.color = getOutput();
	return output;
}
`,particleUpdaterInitPS:`
varying vUv0: vec2f;
var particleTexIN: texture_2d<uff>;
var internalTex0: texture_2d<uff>;
var internalTex1: texture_2d<uff>;
var internalTex2: texture_2d<uff>;
var internalTex3: texture_2d<uff>;
uniform emitterMatrix: mat3x3f;
uniform emitterMatrixInv: mat3x3f;
uniform emitterScale: vec3f;
uniform emitterPos: vec3f;
uniform frameRandom: vec3f;
uniform localVelocityDivMult: vec3f;
uniform velocityDivMult: vec3f;
uniform delta: f32;
uniform rate: f32;
uniform rateDiv: f32;
uniform lifetime: f32;
uniform numParticles: f32;
uniform rotSpeedDivMult: f32;
uniform radialSpeedDivMult: f32;
uniform seed: f32;
uniform startAngle: f32;
uniform startAngle2: f32;
uniform initialVelocity: f32;
uniform graphSampleSize: f32;
uniform graphNumSamples: f32;
var<private> inPos: vec3f;
var<private> inVel: vec3f;
var<private> inAngle: f32;
var<private> inShow: bool;
var<private> inLife: f32;
var<private> visMode: f32;
var<private> outPos: vec3f;
var<private> outVel: vec3f;
var<private> outAngle: f32;
var<private> outShow: bool;
var<private> outLife: f32;
`,particleUpdaterNoRespawnPS:`
	if (outLife >= uniform.lifetime) {
		outLife = outLife - max(uniform.lifetime, uniform.numParticles * particleRate);
		visMode = -1.0;
	}
`,particleUpdaterOnStopPS:`
	visMode = select(visMode, -1.0, outLife < 0.0);
`,particleUpdaterRespawnPS:`
	if (outLife >= uniform.lifetime) {
		let subtractAmount = max(uniform.lifetime, uniform.numParticles * particleRate);
		outLife = outLife - subtractAmount;
		visMode = 1.0;
	}
	visMode = select(visMode, 1.0, outLife < 0.0);
`,particleUpdaterSpherePS:`
uniform spawnBoundsSphere: f32;
uniform spawnBoundsSphereInnerRatio: f32;
fn calcSpawnPosition(inBounds: vec3f, rndFactor: f32) -> vec3f {
	let rnd4: f32 = fract(rndFactor * 1000.0);
	let norm: vec3f = normalize(inBounds.xyz - vec3f(0.5));
	let r: f32 = rnd4 * (1.0 - uniform.spawnBoundsSphereInnerRatio) + uniform.spawnBoundsSphereInnerRatio;
	#ifndef LOCAL_SPACE
		return uniform.emitterPos + norm * r * uniform.spawnBoundsSphere;
	#else
		return norm * r * uniform.spawnBoundsSphere;
	#endif
}
fn addInitialVelocity(localVelocity: ptr<function, vec3f>, inBounds: vec3f) {
	let initialVelOffset: vec3f = normalize(inBounds - vec3f(0.5)) * uniform.initialVelocity;
	*localVelocity = *localVelocity + initialVelOffset;
}
`,particleUpdaterStartPS:`
fn saturate(x: f32) -> f32 {
	return clamp(x, 0.0, 1.0);
}
fn unpack3NFloats(src: f32) -> vec3f {
	let r = fract(src);
	let g = fract(src * 256.0);
	let b = fract(src * 65536.0);
	return vec3f(r, g, b);
}
struct TexLerpUnpackResult {
	result: vec3f,
	unpacked: vec3f
}
fn tex1Dlod_lerp(tex: texture_2d<f32>, textureSize: vec2u, tc: vec2f) -> TexLerpUnpackResult {
	let tc_next = tc + vec2f(uniform.graphSampleSize);
	let texelA: vec2i = vec2i(tc * vec2f(textureSize));
	let texelB: vec2i = vec2i(tc_next * vec2f(textureSize));
	let a = textureLoad(tex, texelA, 0);
	let b = textureLoad(tex, texelB, 0);
	let c = fract(tc.x * uniform.graphNumSamples);
	let unpackedA = unpack3NFloats(a.w);
	let unpackedB = unpack3NFloats(b.w);
	let w_out = mix(unpackedA, unpackedB, c);
	return TexLerpUnpackResult(mix(a.xyz, b.xyz, c), w_out);
}
const HASHSCALE4: vec4f = vec4f(1031.0, 0.1030, 0.0973, 0.1099);
fn hash41(p: f32) -> vec4f {
	var p4 = fract(vec4f(p) * HASHSCALE4);
	p4 = p4 + dot(p4, p4.wzxy + 19.19);
	return fract(vec4f((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));
}
@fragment
fn fragmentMain(input : FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	if (pcPosition.x > uniform.numParticles) {
		discard;
		return output;
	}
	readInput(input.vUv0.x);
	visMode = select(-1.0, 1.0, inShow);
	let rndFactor = hash41(pcPosition.x + uniform.seed);
	let particleRate = uniform.rate + uniform.rateDiv * rndFactor.x;
	outLife = inLife + uniform.delta;
	let nlife = clamp(outLife / uniform.lifetime, 0.0, 1.0);
	let internalTexSize = textureDimensions(internalTex0, 0);
	let lerpResult0 = tex1Dlod_lerp(internalTex0, internalTexSize, vec2f(nlife, 0.0));
	var localVelocity = lerpResult0.result;
	let localVelocityDiv = lerpResult0.unpacked;
	let lerpResult1 = tex1Dlod_lerp(internalTex1, internalTexSize, vec2f(nlife, 0.0));
	var velocity = lerpResult1.result;
	let velocityDiv = lerpResult1.unpacked;
	let lerpResult2 = tex1Dlod_lerp(internalTex2, internalTexSize, vec2f(nlife, 0.0));
	let params = lerpResult2.result;
	let paramDiv = lerpResult2.unpacked;
	var rotSpeed = params.x;
	let rotSpeedDiv = paramDiv.y;
	let lerpResult3 = tex1Dlod_lerp(internalTex3, internalTexSize, vec2f(nlife, 0.0));
	let radialParams = lerpResult3.result;
	let radialParamDiv = lerpResult3.unpacked;
	let radialSpeed = radialParams.x;
	let radialSpeedDiv = radialParamDiv.y;
	let respawn = inLife <= 0.0 || outLife >= uniform.lifetime;
	inPos = select(inPos, calcSpawnPosition(rndFactor.xyz, rndFactor.x), respawn);
	inAngle = select(inAngle, mix(uniform.startAngle, uniform.startAngle2, rndFactor.x), respawn);
	#ifndef LOCAL_SPACE
		var radialVel: vec3f = inPos - uniform.emitterPos;
	#else
		var radialVel: vec3f = inPos;
	#endif
	radialVel = select(vec3f(0.0), radialSpeed * normalize(radialVel), dot(radialVel, radialVel) > 1.0E-8);
	radialVel = radialVel + (radialSpeedDiv * vec3f(2.0) - vec3f(1.0)) * uniform.radialSpeedDivMult * rndFactor.xyz;
	localVelocity = localVelocity + (localVelocityDiv * vec3f(2.0) - vec3f(1.0)) * uniform.localVelocityDivMult * rndFactor.xyz;
	velocity = velocity + (velocityDiv * vec3f(2.0) - vec3f(1.0)) * uniform.velocityDivMult * rndFactor.xyz;
	rotSpeed = rotSpeed + (rotSpeedDiv * 2.0 - 1.0) * uniform.rotSpeedDivMult * rndFactor.y;
	addInitialVelocity(&localVelocity, rndFactor.xyz);
	#ifndef LOCAL_SPACE
		outVel = uniform.emitterMatrix * localVelocity + (radialVel + velocity) * uniform.emitterScale;
	#else
		outVel = (localVelocity + radialVel) / uniform.emitterScale + uniform.emitterMatrixInv * velocity;
	#endif
	outPos = inPos + outVel * uniform.delta;
	outAngle = inAngle + rotSpeed * uniform.delta;
`,particle_billboardVS:`
	let rotationResult = rotateWithMatrix(quadXY, inAngle);
	let rotatedQuadXY = rotationResult.rotatedVec;
	rotMatrix = rotationResult.matrix;
	var localPos = billboard(particlePos, rotatedQuadXY);
`,particle_blendAddPS:`
	dBlendModeFogFactor = 0.0;
	rgb = rgb * saturate(gammaCorrectInput(max(a, 0.0)));
	if ((rgb.r + rgb.g + rgb.b) < 0.000001) {
		discard;
	}	
`,particle_blendMultiplyPS:`
	rgb = mix(vec3f(1.0), rgb, a);
	if ((rgb.r + rgb.g + rgb.b) > 2.99) {
		discard;
	}
`,particle_blendNormalPS:`
	if (a < 0.01) {
		discard;
	}
`,particle_cpuVS:`
attribute particle_vertexData: vec4f;
attribute particle_vertexData2: vec4f;
attribute particle_vertexData3: vec4f;
attribute particle_vertexData4: f32;
#ifndef USE_MESH
	attribute particle_vertexData5: vec2f;
#else
	attribute particle_vertexData5: vec4f;
#endif
uniform matrix_viewProjection: mat4x4f;
uniform matrix_model: mat4x4f;
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform matrix_view: mat4x4f;
#endif
uniform matrix_normal: mat3x3f;
uniform matrix_viewInverse: mat4x4f;
uniform numParticles: f32;
uniform lifetime: f32;
uniform stretch: f32;
uniform seed: f32;
uniform emitterScale: vec3f;
uniform faceTangent: vec3f;
uniform faceBinorm: vec3f;
#ifdef PARTICLE_GPU
	#ifdef WRAP
		uniform wrapBounds: vec3f;
	#endif
#endif
#ifdef PARTICLE_GPU
	var internalTex0: texture_2d<uff>;
	var internalTex1: texture_2d<uff>;
	var internalTex2: texture_2d<uff>;
#endif
uniform emitterPos: vec3f;
varying texCoordsAlphaLife: vec4f;
struct RotateResult {
	rotatedVec: vec2f,
	matrix: mat2x2f
}
fn rotateWithMatrix(quadXY: vec2f, pRotation: f32) -> RotateResult {
	let c = cos(pRotation);
	let s = sin(pRotation);
	let m = mat2x2f(vec2f(c, -s), vec2f(s, c));
	return RotateResult(m * quadXY, m);
}
fn billboard(InstanceCoords: vec3f, quadXY: vec2f) -> vec3f {
	var pos: vec3f;
	#ifdef SCREEN_SPACE
		pos = vec3f(-1.0, 0.0, 0.0) * quadXY.x + vec3f(0.0, -1.0, 0.0) * quadXY.y;
	#else
		pos = -uniform.matrix_viewInverse[0].xyz * quadXY.x + -uniform.matrix_viewInverse[1].xyz * quadXY.y;
	#endif
	return pos;
}
fn customFace(InstanceCoords: vec3f, quadXY: vec2f) -> vec3f {
	let pos = uniform.faceTangent * quadXY.x + uniform.faceBinorm * quadXY.y;
	return pos;
}
fn safeNormalize(v: vec2f) -> vec2f {
	let l = length(v);
	return select(v, v / l, l > 1e-06);
}
@vertex
fn vertexMain(input: VertexInput) -> VertexOutput {
	var output: VertexOutput;
	var particlePos = input.particle_vertexData.xyz;
	let inPos = particlePos;
	let vertPos = input.particle_vertexData3.xyz;
	var inVel = vec3f(input.particle_vertexData2.w, input.particle_vertexData3.w, input.particle_vertexData5.x);
	let id = floor(input.particle_vertexData4);
	let rndFactor = fract(sin(id + 1.0 + uniform.seed));
	let rndFactor3 = vec3f(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));
	#ifdef LOCAL_SPACE
		let modelRotation = mat3x3f(uniform.matrix_model[0].xyz, uniform.matrix_model[1].xyz, uniform.matrix_model[2].xyz);
		inVel = modelRotation * inVel;
	#endif
	let velocityV = safeNormalize((mat3x3f(uniform.matrix_view[0].xyz, uniform.matrix_view[1].xyz, uniform.matrix_view[2].xyz) * inVel).xy);
	let quadXY = vertPos.xy;
	#ifdef USE_MESH
		output.texCoordsAlphaLife = vec4f(input.particle_vertexData5.zw, input.particle_vertexData2.z, input.particle_vertexData.w);
	#else
		output.texCoordsAlphaLife = vec4f(quadXY * -0.5 + 0.5, input.particle_vertexData2.z, input.particle_vertexData.w);
	#endif
	var rotMatrix: mat2x2f;
	var inAngle = input.particle_vertexData2.x;
	var particlePosMoved = vec3f(0.0);
	let meshLocalPos = input.particle_vertexData3.xyz;
`,particle_cpu_endVS:`
	localPos = localPos * input.particle_vertexData2.y * uniform.emitterScale;
	localPos = localPos + particlePos;
	#ifdef SCREEN_SPACE
		output.position = vec4f(localPos.x, localPos.y, 0.0, 1.0);
	#else
		output.position = uniform.matrix_viewProjection * vec4f(localPos, 1.0);
	#endif
`,particle_customFaceVS:`
	let rotationResult = rotateWithMatrix(quadXY, inAngle);
	let rotatedQuadXY = rotationResult.rotatedVec;
	rotMatrix = rotationResult.matrix;
	var localPos = customFace(particlePos, rotatedQuadXY);
`,particle_endPS:`
	rgb = addFog(rgb);
	rgb = toneMap(rgb);
	rgb = gammaCorrectOutput(rgb);
	output.color = vec4f(rgb, a);
	return output;
}
`,particle_endVS:`
	localPos = localPos * scale * uniform.emitterScale;
	localPos = localPos + particlePos;
	#ifdef SCREEN_SPACE
		output.position = vec4f(localPos.x, localPos.y, 0.0, 1.0);
	#else
		output.position = uniform.matrix_viewProjection * vec4f(localPos.xyz, 1.0);
	#endif
`,particle_halflambertPS:`
	var negNormal: vec3f = normal * 0.5 + 0.5;
	var posNormal: vec3f = -normal * 0.5 + 0.5;
	negNormal = negNormal * negNormal;
	posNormal = posNormal * posNormal;
`,particle_initVS:`
attribute particle_vertexData: vec4f;
#if defined(USE_MESH)
	#if defined(USE_MESH_UV)
		attribute particle_uv: vec2f;
	#else
		var<private> particle_uv: vec2f = vec2f(0.0, 0.0);
	#endif
#endif
uniform matrix_viewProjection: mat4x4f;
uniform matrix_model: mat4x4f;
uniform matrix_normal: mat3x3f;
uniform matrix_viewInverse: mat4x4f;
#ifndef VIEWMATRIX
	#define VIEWMATRIX
	uniform matrix_view: mat4x4f;
#endif
uniform numParticles: f32;
uniform numParticlesPot: f32;
uniform graphSampleSize: f32;
uniform graphNumSamples: f32;
uniform stretch: f32;
uniform emitterScale: vec3f;
uniform emitterPos: vec3f;
uniform faceTangent: vec3f;
uniform faceBinorm: vec3f;
uniform rate: f32;
uniform rateDiv: f32;
uniform lifetime: f32;
uniform scaleDivMult: f32;
uniform alphaDivMult: f32;
uniform seed: f32;
uniform delta: f32;
#ifdef PARTICLE_GPU
	#ifdef WRAP
		uniform wrapBounds: vec3f;
	#endif
#endif
var particleTexOUT: texture_2d<uff>;
var particleTexIN: texture_2d<uff>;
#ifdef PARTICLE_GPU
	var internalTex0: texture_2d<uff>;
	var internalTex1: texture_2d<uff>;
	var internalTex2: texture_2d<uff>;
#endif
#ifndef CAMERAPLANES
	#define CAMERAPLANES
	uniform camera_params: vec4f;
#endif
varying texCoordsAlphaLife: vec4f;
var<private> inPos: vec3f;
var<private> inVel: vec3f;
var<private> inAngle: f32;
var<private> inShow: bool;
var<private> inLife: f32;
`,particle_lambertPS:`
	var negNormal: vec3f = max(normal, vec3(0.0));
	var posNormal: vec3f = max(-normal, vec3(0.0));
`,particle_lightingPS:`
	let light: vec3f = negNormal.x * uniform.lightCube[0] + posNormal.x * uniform.lightCube[1] +
					   negNormal.y * uniform.lightCube[2] + posNormal.y * uniform.lightCube[3] +
					   negNormal.z * uniform.lightCube[4] + posNormal.z * uniform.lightCube[5];
	rgb = rgb * light;
`,particle_localShiftVS:`
particlePos = (uniform.matrix_model * vec4f(particlePos, 1.0)).xyz;
`,particle_meshVS:`
var localPos = meshLocalPos;
let rotResultXY = rotateWithMatrix(localPos.xy, inAngle);
localPos = vec3f(rotResultXY.rotatedVec, localPos.z);
rotMatrix = rotResultXY.matrix;
let rotResultYZ = rotateWithMatrix(localPos.yz, inAngle);
localPos = vec3f(localPos.x, rotResultYZ.rotatedVec);
rotMatrix = rotResultYZ.matrix;
billboard(particlePos, quadXY);
`,particle_normalVS:`
output.Normal = normalize(localPos + uniform.matrix_viewInverse[2].xyz);
`,particle_normalMapPS:`
	let sampledNormal: vec4f = textureSample(normalMap, normalMapSampler, vec2f(input.texCoordsAlphaLife.x, 1.0 - input.texCoordsAlphaLife.y));
	let normalMap: vec3f = normalize(sampledNormal.xyz * 2.0 - 1.0);
	let ParticleMat = mat3x3<f32>(ParticleMat0, ParticleMat1, ParticleMat2);
	let normal: vec3f = ParticleMat * normalMap;
`,particle_pointAlongVS:`
	inAngle = atan2(velocityV.x, velocityV.y);
`,particle_simulationPS:`
	#include "particleUpdaterInitPS"
	#ifdef PACK8
		#include "particleInputRgba8PS"
		#include "particleOutputRgba8PS"
	#else
		#include "particleInputFloatPS"
		#include "particleOutputFloatPS"
	#endif
	#ifdef EMITTERSHAPE_BOX
		#include "particleUpdaterAABBPS"
	#else
		#include "particleUpdaterSpherePS"
	#endif
	#include "particleUpdaterStartPS"
	#ifdef RESPAWN
		#include "particleUpdaterRespawnPS"
	#endif
	#ifdef NO_RESPAWN
		#include "particleUpdaterNoRespawnPS"
	#endif
	#ifdef ON_STOP
		#include "particleUpdaterOnStopPS"
	#endif
	#include "particleUpdaterEndPS"
`,particle_shaderPS:`
	#if NORMAL != NONE
		#if NORMAL == VERTEX
			varying Normal: vec3f;
		#endif
		#if NORMAL == MAP
			varying ParticleMat0: vec3f;
			varying ParticleMat1: vec3f;
			varying ParticleMat2: vec3f;
		#endif
		uniform lightCube: array<vec3f, 6>;
	#endif
	#ifdef SOFT
		varying vDepth: f32;
		#include "screenDepthPS"
	#endif
	#include "gammaPS"
	#include "tonemappingPS"
	#include "fogPS"
	#if NORMAL == MAP
		var normalMap: texture_2d<f32>;
		var normalMapSampler: sampler;
	#endif
	#include "particlePS"
	#ifdef SOFT
		#include "particle_softPS"
	#endif
	#if NORMAL == VERTEX
		var normal: vec3f = Normal;
	#endif
	#if NORMAL == MAP
		#include "particle_normalMapPS"
	#endif
	#if NORMAL != NONE
		#ifdef HALF_LAMBERT
			#include "particle_halflambertPS"
		#else
			#include "particle_lambertPS"
		#endif
		#include "particle_lightingPS"
	#endif
	#if BLEND == NORMAL
		#include "particle_blendNormalPS"
	#elif BLEND == ADDITIVE
		#include "particle_blendAddPS"
	#elif BLEND == MULTIPLICATIVE
		#include "particle_blendMultiplyPS"
	#endif
	#include "particle_endPS"
`,particle_shaderVS:`
	#ifdef ANIMTEX
		uniform animTexTilesParams: vec2f;
		uniform animTexParams: vec4f;
		uniform animTexIndexParams: vec2f;
	#endif
	#if NORMAL == MAP
		varying ParticleMat0: vec3f;
		varying ParticleMat1: vec3f;
		varying ParticleMat2: vec3f;
	#endif
	#if NORMAL == VERTEX
		varying Normal: vec3f;
	#endif
	#ifdef SOFT
		varying vDepth: f32;
	#endif
	#ifdef PARTICLE_GPU
		#include "particle_initVS"
		#ifdef PACK8
			#include "particleInputRgba8PS"
		#else
			#include  "particleInputFloatPS"
		#endif
		#ifdef SOFT
			#include "screenDepthPS"
		#endif
		#include "particleVS"
	#else
		#ifdef SOFT
			#include "screenDepthPS"
		#endif
		#include "particle_cpuVS"
	#endif
	#ifdef LOCAL_SPACE
		#include "particle_localShiftVS"
	#endif
	#ifdef ANIMTEX
		#ifdef ANIMTEX_LOOP
			#include "particleAnimFrameLoopVS"
		#else
			#include "particleAnimFrameClampVS"
		#endif
		#include "particleAnimTexVS"
	#endif
	#ifdef PARTICLE_GPU
		#ifdef WRAP
			#include "particle_wrapVS"
		#endif
	#endif
	#ifdef ALIGN_TO_MOTION
		#include "particle_pointAlongVS"
	#endif
	#ifdef USE_MESH
		#include "particle_meshVS"
	#else
		#ifdef CUSTOM_FACE
			#include "particle_customFaceVS"
		#else
			#include "particle_billboardVS"
		#endif
	#endif
	#if NORMAL == VERTEX
		#include "particle_normalVS"
	#endif
	#if NORMAL == MAP
		#include "particle_TBNVS"
	#endif
	#ifdef STRETCH
		#include "particle_stretchVS"
	#endif
	#ifdef PARTICLE_GPU
		#include "particle_endVS"
	#else
		#include "particle_cpu_endVS"
	#endif
	#ifdef SOFT
		#include "particle_softVS"
	#endif
	return output;
}
`,particle_softPS:`
	var depth: f32 = getLinearScreenDepthFrag();
	var particleDepth: f32 = vDepth;
	var depthDiff: f32 = saturate(abs(particleDepth - depth) * uniform.softening);
	a = a * depthDiff;
`,particle_softVS:`
	output.vDepth = getLinearDepth(localPos);
`,particle_stretchVS:`
	let moveDir: vec3f = inVel * uniform.stretch;
	var posPrev: vec3f = particlePos - moveDir;
	posPrev = posPrev + particlePosMoved;
	let viewRotationTemp: mat3x3f = mat3x3f(uniform.matrix_view[0].xyz, uniform.matrix_view[1].xyz, uniform.matrix_view[2].xyz);
	let centerToVertexV: vec2f = normalize((viewRotationTemp * localPos).xy);
	let interpolation: f32 = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;
	particlePos = mix(particlePos, posPrev, interpolation);
`,particle_TBNVS:`
	let rot3 = mat3x3f(
		vec3f(rotMatrix[0][0], rotMatrix[1][0], 0.0),
		vec3f(rotMatrix[0][1], rotMatrix[1][1], 0.0),
		vec3f(0.0, 0.0, 1.0)
	);
	let viewBasis = mat3x3f(
		-uniform.matrix_viewInverse[0].xyz,
		-uniform.matrix_viewInverse[1].xyz,
		uniform.matrix_viewInverse[2].xyz
	);
	let tempMat = viewBasis * rot3;
	output.ParticleMat0 = tempMat[0];
	output.ParticleMat1 = tempMat[1];
	output.ParticleMat2 = tempMat[2];
`,particle_wrapVS:`
	let origParticlePos: vec3f = particlePos;
	particlePos = particlePos - uniform.matrix_model[3].xyz;
	particlePos = (particlePos % uniform.wrapBounds) - uniform.wrapBounds * 0.5;
	particlePos = particlePos + uniform.matrix_model[3].xyz;
	particlePosMoved = particlePos - origParticlePos;
`},_Q=["enabled","autoPlay","numParticles","lifetime","rate","rate2","startAngle","startAngle2","loop","preWarm","lighting","halfLambert","intensity","depthWrite","noFog","depthSoftening","sort","blendType","stretch","alignToMotion","emitterShape","emitterExtents","emitterExtentsInner","emitterRadius","emitterRadiusInner","initialVelocity","wrap","wrapBounds","localSpace","screenSpace","colorMapAsset","normalMapAsset","mesh","meshAsset","renderAsset","orientation","particleNormal","localVelocityGraph","localVelocityGraph2","velocityGraph","velocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2","scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","colorMap","normalMap","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animSpeed","animLoop","layers"];class _J extends f8{initializeComponentData(e,t,i){let s={};i=[];let r=this.propertyTypes;for(let e in (t.mesh instanceof fy||"number"==typeof t.mesh)&&(t.meshAsset=t.mesh,delete t.mesh),t){if(t.hasOwnProperty(e)&&(i.push(e),s[e]=t[e]),"vec3"===r[e])Array.isArray(s[e])&&(s[e]=new ed(s[e][0],s[e][1],s[e][2]));else if("curve"===r[e]){if(!(s[e]instanceof ea)){let t=s[e].type;s[e]=new ea(s[e].keys),s[e].type=t;}}else if("curveset"===r[e]&&!(s[e]instanceof en)){let t=s[e].type;s[e]=new en(s[e].keys),s[e].type=t;}s.layers&&Array.isArray(s.layers)&&(s.layers=s.layers.slice(0));}super.initializeComponentData(e,s,i);}cloneComponent(e,t){let i=e.particlesystem.data,s=this.schema,r={};for(let e=0,t=s.length;e<t;e++){let t=s[e],a=i[t];a instanceof ed||a instanceof ea||a instanceof en?(a=a.clone(),r[t]=a):"layers"===t?r.layers=i.layers.slice(0):null!=a&&(r[t]=a);}return this.addComponent(t,r)}onUpdate(e){let t=this.store,i=this.app.stats.particles,s=this.app.scene.layers;for(let e=0;e<s.layerList.length;e++)s.layerList[e].requiresLightCube=false;for(let r in t)if(t.hasOwnProperty(r)){let a=t[r],n=a.entity,o=a.data;if(o.enabled&&n.enabled){let t=n.particlesystem.emitter;if(!t?.meshInstance.visible)continue;if(t.lighting){let e=o.layers;for(let t=0;t<e.length;t++){let i=s.getLayerById(e[t]);i&&(i.requiresLightCube=true);}}if(!o.paused){let s=0;if(t.simTime+=e,t.simTime>=t.fixedTimeStep&&(s=Math.floor(t.simTime/t.fixedTimeStep),t.simTime-=s*t.fixedTimeStep),s){s=Math.min(s,t.maxSubSteps);for(let e=0;e<s;e++)t.addTime(t.fixedTimeStep,false);i._updatesPerFrame+=s,i._frameTime+=t._addTimeTime,t._addTimeTime=0;}t.finishFrame();}}}}onBeforeRemove(e,t){t.onBeforeRemove();}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this);}constructor(e){super(e),this.id="particlesystem",this.ComponentType=_$,this.DataType=_j,this.schema=_Q,this.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"},this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this),nH.get(e.graphicsDevice,tz).add(_K),nH.get(e.graphicsDevice,tV).add(_Z);}}class _0 extends st{constructor(e,t){super(),this.skin=e,this.skinInstance=t;}}class _1{static createCachedSkinInstance(e,t,i){let s=_1.getCachedSkinInstance(e,t);return s||((s=new n4(e)).resolve(t,i),_1.addCachedSkinInstance(e,t,s)),s}static getCachedSkinInstance(e,t){let i=null,s=_1._skinInstanceCache.get(t);if(s){let t=s.find(t=>t.skin===e);t&&(t.incRefCount(),i=t.skinInstance);}return i}static addCachedSkinInstance(e,t,i){let s=_1._skinInstanceCache.get(t);s||(s=[],_1._skinInstanceCache.set(t,s));let r=s.find(t=>t.skin===e);r||(r=new _0(e,i),s.push(r)),r.incRefCount();}static removeCachedSkinInstance(e){if(e){let t=e.rootBone;if(t){let i=_1._skinInstanceCache.get(t);if(i){let s=i.findIndex(t=>t.skinInstance===e);if(s>=0){let r=i[s];r.decRefCount(),0===r.refCount&&(i.splice(s,1),i.length||_1._skinInstanceCache.delete(t),e&&(e.destroy(),r.skinInstance=null));}}}}}}_1._skinInstanceCache=new Map;class _2{set id(e){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=e,this.asset=this._registry.get(this._id),this._bind();}get id(){return this._id}set url(e){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=e,this.asset=this._registry.getByUrl(this._url),this._bind();}get url(){return this._url}_bind(){this.id&&(this._onAssetLoad&&(this._evtLoadById=this._registry.on(`load:${this.id}`,this._onLoad,this)),this._onAssetAdd&&(this._evtAddById=this._registry.once(`add:${this.id}`,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveById=this._registry.on(`remove:${this.id}`,this._onRemove,this)),this._onAssetUnload&&(this._evtUnloadById=this._registry.on(`unload:${this.id}`,this._onUnload,this))),this.url&&(this._onAssetLoad&&(this._evtLoadByUrl=this._registry.on(`load:url:${this.url}`,this._onLoad,this)),this._onAssetAdd&&(this._evtAddByUrl=this._registry.once(`add:url:${this.url}`,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveByUrl=this._registry.on(`remove:url:${this.url}`,this._onRemove,this)));}_unbind(){this.id&&(this._evtLoadById?.off(),this._evtLoadById=null,this._evtAddById?.off(),this._evtAddById=null,this._evtRemoveById?.off(),this._evtRemoveById=null,this._evtUnloadById?.off(),this._evtUnloadById=null),this.url&&(this._evtLoadByUrl?.off(),this._evtLoadByUrl=null,this._evtAddByUrl?.off(),this._evtAddByUrl=null,this._evtRemoveByUrl?.off(),this._evtRemoveByUrl=null);}_onLoad(e){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,e);}_onAdd(e){this.asset=e,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,e);}_onRemove(e){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,e),this.asset=null;}_onUnload(e){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,e);}constructor(e,t,i,s,r){this._evtLoadById=null,this._evtUnloadById=null,this._evtAddById=null,this._evtRemoveById=null,this._evtLoadByUrl=null,this._evtAddByUrl=null,this._evtRemoveByUrl=null,this.propertyName=e,this.parent=t,this._scope=r,this._registry=i,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=s.load,this._onAssetAdd=s.add,this._onAssetRemove=s.remove,this._onAssetUnload=s.unload;}}class _3 extends f5{set renderStyle(e){this._renderStyle!==e&&(this._renderStyle=e,od._prepareRenderStyleForArray(this._meshInstances,e));}get renderStyle(){return this._renderStyle}set customAabb(e){this._customAabb=e;let t=this._meshInstances;if(t)for(let e=0;e<t.length;e++)t[e].setCustomAabb(this._customAabb);}get customAabb(){return this._customAabb}set type(e){if(this._type!==e&&(this._area=null,this._type=e,this.destroyMeshInstances(),"asset"!==e)){let t=this._material;t&&t!==this.system.defaultMaterial||(t=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);let i=_U(this.system.app.graphicsDevice,e);this._area=i.area,this.meshInstances=[new od(i.mesh,t||this.system.defaultMaterial,this.entity)];}}get type(){return this._type}set meshInstances(e){if(this.destroyMeshInstances(),this._meshInstances=e,this._meshInstances){let e=this._meshInstances;for(let t=0;t<e.length;t++)e[t].node||(e[t].node=this.entity),e[t].castShadow=this._castShadows,e[t].receiveShadow=this._receiveShadows,e[t].renderStyle=this._renderStyle,e[t].setLightmapped(this._lightmapped),e[t].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers();}}get meshInstances(){return this._meshInstances}set lightmapped(e){if(e!==this._lightmapped){this._lightmapped=e;let t=this._meshInstances;if(t)for(let i=0;i<t.length;i++)t[i].setLightmapped(e);}}get lightmapped(){return this._lightmapped}set castShadows(e){if(this._castShadows!==e){let t=this._meshInstances;if(t){let i=this.layers,s=this.system.app.scene;if(this._castShadows&&!e)for(let e=0;e<i.length;e++){let i=s.layers.getLayerById(this.layers[e]);i&&i.removeShadowCasters(t);}for(let i=0;i<t.length;i++)t[i].castShadow=e;if(!this._castShadows&&e)for(let e=0;e<i.length;e++){let r=s.layers.getLayerById(i[e]);r&&r.addShadowCasters(t);}}this._castShadows=e;}}get castShadows(){return this._castShadows}set receiveShadows(e){if(this._receiveShadows!==e){this._receiveShadows=e;let t=this._meshInstances;if(t)for(let i=0;i<t.length;i++)t[i].receiveShadow=e;}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(e){this._castShadowsLightmap=e;}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(e){this._lightmapSizeMultiplier=e;}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(e){let t,i=this.system.app.scene.layers;if(this._meshInstances)for(let e=0;e<this._layers.length;e++)(t=i.getLayerById(this._layers[e]))&&t.removeMeshInstances(this._meshInstances);this._layers.length=0;for(let t=0;t<e.length;t++)this._layers[t]=e[t];if(this.enabled&&this.entity.enabled&&this._meshInstances)for(let e=0;e<this._layers.length;e++)(t=i.getLayerById(this._layers[e]))&&t.addMeshInstances(this._meshInstances);}get layers(){return this._layers}set batchGroupId(e){this._batchGroupId!==e&&(this.entity.enabled&&this._batchGroupId>=0&&this.system.app.batcher?.remove(n2.RENDER,this.batchGroupId,this.entity),this.entity.enabled&&e>=0&&this.system.app.batcher?.insert(n2.RENDER,e,this.entity),e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=e);}get batchGroupId(){return this._batchGroupId}set material(e){if(this._material!==e&&(this._material=e,this._meshInstances&&"asset"!==this._type))for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].material=e;}get material(){return this._material}set materialAssets(e=[]){if(this._materialReferences.length>e.length){for(let t=e.length;t<this._materialReferences.length;t++)this._materialReferences[t].id=null;this._materialReferences.length=e.length;}for(let t=0;t<e.length;t++)if(this._materialReferences[t]||this._materialReferences.push(new _2(t,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),e[t]){let i=e[t]instanceof fy?e[t].id:e[t];this._materialReferences[t].id!==i&&(this._materialReferences[t].id=i),this._materialReferences[t].asset&&this._onMaterialAdded(t,this,this._materialReferences[t].asset);}else this._materialReferences[t].id=null,this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial);}get materialAssets(){return this._materialReferences.map(e=>e.id)}set asset(e){let t=e instanceof fy?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onRenderAssetAdded());}get asset(){return this._assetReference.id}assignAsset(e){let t=e instanceof fy?e.id:e;this._assetReference.id=t;}set rootBone(e){if(this._rootBone!==e){let t="string"==typeof e;this._rootBone&&t&&this._rootBone.getGuid()===e||(this._rootBone&&this._clearSkinInstances(),e instanceof oX?this._rootBone=e:t?(this._rootBone=this.system.app.getEntityFromIndex(e)||null,this._rootBone):this._rootBone=null,this._rootBone&&this._cloneSkinInstances());}}get rootBone(){return this._rootBone}destroyMeshInstances(){let e=this._meshInstances;if(e){this.removeFromLayers(),this._clearSkinInstances();for(let t=0;t<e.length;t++)e[t].destroy();this._meshInstances.length=0;}}addToLayers(){let e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){let i=e.getLayerById(this._layers[t]);i&&i.addMeshInstances(this._meshInstances);}}removeFromLayers(){if(this._meshInstances&&this._meshInstances.length){let e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){let i=e.getLayerById(this._layers[t]);i&&i.removeMeshInstances(this._meshInstances);}}}onRemoveChild(){this.removeFromLayers();}onInsertChild(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers();}onRemove(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this._assetReference.id=null;for(let e=0;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this);}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);}onLayerAdded(e){0>this.layers.indexOf(e.id)||e.addMeshInstances(this._meshInstances);}onLayerRemoved(e){0>this.layers.indexOf(e.id)||e.removeMeshInstances(this._meshInstances);}onEnable(){let e=this.system.app,t=e.scene,i=t.layers;this._rootBone&&this._cloneSkinInstances(),this._evtLayersChanged=t.on("set:layers",this.onLayersChanged,this),i&&(this._evtLayerAdded=i.on("add",this.onLayerAdded,this),this._evtLayerRemoved=i.on("remove",this.onLayerRemoved,this));let s="asset"===this._type;this._meshInstances&&this._meshInstances.length?this.addToLayers():s&&this.asset&&this._onRenderAssetAdded();for(let e=0;e<this._materialReferences.length;e++)this._materialReferences[e].asset&&this.system.app.assets.load(this._materialReferences[e].asset);this._batchGroupId>=0&&e.batcher?.insert(n2.RENDER,this.batchGroupId,this.entity);}onDisable(){let e=this.system.app,t=e.scene.layers;this._evtLayersChanged?.off(),this._evtLayersChanged=null,this._rootBone&&this._clearSkinInstances(),t&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this._batchGroupId>=0&&e.batcher?.remove(n2.RENDER,this.batchGroupId,this.entity),this.removeFromLayers();}hide(){if(this._meshInstances)for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=false;}show(){if(this._meshInstances)for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=true;}_onRenderAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset));}_onRenderAssetLoad(){if(this.destroyMeshInstances(),this._assetReference.asset){let e=this._assetReference.asset.resource;this._evtSetMeshes?.off(),this._evtSetMeshes=e.on("set:meshes",this._onSetMeshes,this),e.meshes&&this._onSetMeshes(e.meshes);}}_onSetMeshes(e){this._cloneMeshes(e);}_clearSkinInstances(){for(let e=0;e<this._meshInstances.length;e++){let t=this._meshInstances[e];_1.removeCachedSkinInstance(t.skinInstance),t.skinInstance=null;}}_cloneSkinInstances(){if(this._meshInstances.length&&this._rootBone instanceof oX)for(let e=0;e<this._meshInstances.length;e++){let t=this._meshInstances[e],i=t.mesh;i.skin&&!t.skinInstance&&(t.skinInstance=_1.createCachedSkinInstance(i.skin,this._rootBone,this.entity));}}_cloneMeshes(e){if(e&&e.length){let t=[];for(let i=0;i<e.length;i++){let s=e[i],r=new od(s,this._materialReferences[i]&&this._materialReferences[i].asset&&this._materialReferences[i].asset.resource||this.system.defaultMaterial,this.entity);t.push(r),s.morph&&(r.morphInstance=new hb(s.morph));}this.meshInstances=t,this._cloneSkinInstances();}}_onRenderAssetUnload(){"asset"===this._type&&this.destroyMeshInstances();}_onRenderAssetRemove(){this._evtSetMeshes?.off(),this._evtSetMeshes=null,this._onRenderAssetUnload();}_onMaterialAdded(e,t,i){i.resource?this._onMaterialLoad(e,t,i):this.enabled&&this.entity.enabled&&this.system.app.assets.load(i);}_updateMainMaterial(e,t){0===e&&(this.material=t);}_onMaterialLoad(e,t,i){this._meshInstances[e]&&(this._meshInstances[e].material=i.resource),this._updateMainMaterial(e,i.resource);}_onMaterialRemove(e,t,i){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial);}_onMaterialUnload(e,t,i){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial);}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&(this.rootBone=t[e.rootBone.getGuid()]);}constructor(e,t){super(e,t),this._type="asset",this._castShadows=true,this._receiveShadows=true,this._castShadowsLightmap=true,this._lightmapped=false,this._lightmapSizeMultiplier=1,this.isStatic=false,this._batchGroupId=-1,this._layers=[0],this._renderStyle=0,this._meshInstances=[],this._customAabb=null,this._area=null,this._materialReferences=[],this._rootBone=null,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._evtSetMeshes=null,this._assetReference=new _2("asset",this,e.app.assets,{add:this._onRenderAssetAdded,load:this._onRenderAssetLoad,remove:this._onRenderAssetRemove,unload:this._onRenderAssetUnload},this),this._material=e.defaultMaterial,t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this);}}class _4{constructor(){this.enabled=true;}}let _5=["enabled"],_8=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId","rootBone"];class _6 extends f8{initializeComponentData(e,t,i){(null===t.batchGroupId||void 0===t.batchGroupId)&&(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let i=0;i<_8.length;i++)t.hasOwnProperty(_8[i])&&(e[_8[i]]=t[_8[i]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new eC(new ed(t.aabbCenter),new ed(t.aabbHalfExtents))),super.initializeComponentData(e,t,_5);}cloneComponent(e,t){let i={};for(let t=0;t<_8.length;t++)i[_8[t]]=e.render[_8[t]];i.enabled=e.render.enabled,delete i.meshInstances;let s=this.addComponent(t,i),r=e.render.meshInstances,a=r.map(e=>e.mesh);s._onSetMeshes(a);for(let e=0;e<r.length;e++)s.meshInstances[e].material=r[e].material;return e.render.customAabb&&(s.customAabb=e.render.customAabb.clone()),s}onRemove(e,t){t.onRemove();}constructor(e){super(e),this.id="render",this.ComponentType=_3,this.DataType=_4,this.schema=_5,this.defaultMaterial=ot(e.graphicsDevice),this.on("beforeremove",this.onRemove,this);}}f5._buildAccessors(_3.prototype,_5);class _9{_resize(e){if(e>this._pool.length)for(let t=this._pool.length;t<e;t++)this._pool[t]=new this._constructor;}allocate(){return this._count>=this._pool.length&&this._resize(2*this._pool.length),this._pool[this._count++]}freeAll(){this._count=0;}constructor(e,t){this._pool=[],this._count=0,this._constructor=e,this._resize(t);}}let _7=new ex,ge=new ex,gt=new ed;class gi extends f5{static onLibraryLoaded(){"undefined"!=typeof Ammo&&(h=new Ammo.btTransform,c=new Ammo.btVector3,d=new Ammo.btVector3,u=new Ammo.btQuaternion);}static onAppDestroy(){Ammo.destroy(h),Ammo.destroy(c),Ammo.destroy(d),Ammo.destroy(u),h=null,c=null,d=null,u=null;}set angularDamping(e){this._angularDamping!==e&&(this._angularDamping=e,this._body&&this._body.setDamping(this._linearDamping,e));}get angularDamping(){return this._angularDamping}set angularFactor(e){!this._angularFactor.equals(e)&&(this._angularFactor.copy(e),this._body&&this._type===mv&&(c.setValue(e.x,e.y,e.z),this._body.setAngularFactor(c)));}get angularFactor(){return this._angularFactor}set angularVelocity(e){this._body&&this._type===mv&&(this._body.activate(),c.setValue(e.x,e.y,e.z),this._body.setAngularVelocity(c),this._angularVelocity.copy(e));}get angularVelocity(){if(this._body&&this._type===mv){let e=this._body.getAngularVelocity();this._angularVelocity.set(e.x(),e.y(),e.z());}return this._angularVelocity}set body(e){this._body!==e&&(this._body=e,e&&this._simulationEnabled&&e.activate());}get body(){return this._body}set friction(e){this._friction!==e&&(this._friction=e,this._body&&this._body.setFriction(e));}get friction(){return this._friction}set group(e){this._group!==e&&(this._group=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()));}get group(){return this._group}set linearDamping(e){this._linearDamping!==e&&(this._linearDamping=e,this._body&&this._body.setDamping(e,this._angularDamping));}get linearDamping(){return this._linearDamping}set linearFactor(e){!this._linearFactor.equals(e)&&(this._linearFactor.copy(e),this._body&&this._type===mv&&(c.setValue(e.x,e.y,e.z),this._body.setLinearFactor(c)));}get linearFactor(){return this._linearFactor}set linearVelocity(e){this._body&&this._type===mv&&(this._body.activate(),c.setValue(e.x,e.y,e.z),this._body.setLinearVelocity(c),this._linearVelocity.copy(e));}get linearVelocity(){if(this._body&&this._type===mv){let e=this._body.getLinearVelocity();this._linearVelocity.set(e.x(),e.y(),e.z());}return this._linearVelocity}set mask(e){this._mask!==e&&(this._mask=e,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()));}get mask(){return this._mask}set mass(e){if(this._mass!==e&&(this._mass=e,this._body&&this._type===mv)){let t=this.enabled&&this.entity.enabled;t&&this.disableSimulation(),this._body.getCollisionShape().calculateLocalInertia(e,c),this._body.setMassProps(e,c),this._body.updateInertiaTensor(),t&&this.enableSimulation();}}get mass(){return this._mass}set restitution(e){this._restitution!==e&&(this._restitution=e,this._body&&this._body.setRestitution(e));}get restitution(){return this._restitution}set rollingFriction(e){this._rollingFriction!==e&&(this._rollingFriction=e,this._body&&this._body.setRollingFriction(e));}get rollingFriction(){return this._rollingFriction}set type(e){if(this._type!==e){switch(this._type=e,this.disableSimulation(),e){case mv:this._group=1,this._mask=65535;break;case mS:this._group=4,this._mask=65535;break;default:this._group=2,this._mask=65533;}this.createBody();}}get type(){return this._type}createBody(){let e,t=this.entity;if(t.collision&&(e=t.collision.shape,t.trigger&&(t.trigger.destroy(),delete t.trigger)),e){this._body&&(this.system.removeBody(this._body),this.system.destroyBody(this._body),this._body=null);let i=this._type===mv?this._mass:0;this._getEntityTransform(h);let s=this.system.createBody(i,e,h);if(s.setRestitution(this._restitution),s.setFriction(this._friction),s.setRollingFriction(this._rollingFriction),s.setDamping(this._linearDamping,this._angularDamping),this._type===mv){let e=this._linearFactor;c.setValue(e.x,e.y,e.z),s.setLinearFactor(c);let t=this._angularFactor;c.setValue(t.x,t.y,t.z),s.setAngularFactor(c);}else this._type===mS&&(s.setCollisionFlags(2|s.getCollisionFlags()),s.setActivationState(4));s.entity=t,this.body=s,this.enabled&&t.enabled&&this.enableSimulation();}}isActive(){return !!this._body&&this._body.isActive()}activate(){this._body&&this._body.activate();}enableSimulation(){let e=this.entity;if(e.collision&&e.collision.enabled&&!this._simulationEnabled){let t=this._body;if(t){switch(this.system.addBody(t,this._group,this._mask),this._type){case mv:this.system._dynamic.push(this),t.forceActivationState(1),this.syncEntityToBody();break;case mS:this.system._kinematic.push(this),t.forceActivationState(4);break;case mg:t.forceActivationState(1),this.syncEntityToBody();}"compound"===e.collision.type&&this.system._compounds.push(e.collision),t.activate(),this._simulationEnabled=true;}}}disableSimulation(){let e=this._body;if(e&&this._simulationEnabled){let t=this.system,i=t._compounds.indexOf(this.entity.collision);i>-1&&t._compounds.splice(i,1),(i=t._dynamic.indexOf(this))>-1&&t._dynamic.splice(i,1),(i=t._kinematic.indexOf(this))>-1&&t._kinematic.splice(i,1),t.removeBody(e),e.forceActivationState(5),this._simulationEnabled=false;}}applyForce(e,t,i,s,r,a){let n=this._body;n&&(n.activate(),e instanceof ed?c.setValue(e.x,e.y,e.z):c.setValue(e,t,i),t instanceof ed?d.setValue(t.x,t.y,t.z):void 0!==s?d.setValue(s,r,a):d.setValue(0,0,0),n.applyForce(c,d));}applyTorque(e,t,i){let s=this._body;s&&(s.activate(),e instanceof ed?c.setValue(e.x,e.y,e.z):c.setValue(e,t,i),s.applyTorque(c));}applyImpulse(e,t,i,s,r,a){let n=this._body;n&&(n.activate(),e instanceof ed?c.setValue(e.x,e.y,e.z):c.setValue(e,t,i),t instanceof ed?d.setValue(t.x,t.y,t.z):void 0!==s?d.setValue(s,r,a):d.setValue(0,0,0),n.applyImpulse(c,d));}applyTorqueImpulse(e,t,i){let s=this._body;s&&(s.activate(),e instanceof ed?c.setValue(e.x,e.y,e.z):c.setValue(e,t,i),s.applyTorqueImpulse(c));}isStatic(){return this._type===mg}isStaticOrKinematic(){return this._type===mg||this._type===mS}isKinematic(){return this._type===mS}_getEntityTransform(e){let t=this.entity,i=t.collision;if(i){let e=i.getShapePosition(),t=i.getShapeRotation();c.setValue(e.x,e.y,e.z),u.setValue(t.x,t.y,t.z,t.w);}else {let e=t.getPosition(),i=t.getRotation();c.setValue(e.x,e.y,e.z),u.setValue(i.x,i.y,i.z,i.w);}e.setOrigin(c),e.setRotation(u);}syncEntityToBody(){let e=this._body;if(e){if(this._getEntityTransform(h),e.setWorldTransform(h),this._type===mS){let t=e.getMotionState();t&&t.setWorldTransform(h);}e.activate();}}_updateDynamic(){let e=this._body;if(e.isActive()){let t=e.getMotionState();if(t){let e=this.entity;t.getWorldTransform(h);let i=h.getOrigin(),s=h.getRotation(),r=e.collision;if(r&&r._hasOffset){let t=r.data.linearOffset,a=r.data.angularOffset,n=ge.copy(a).invert(),o=_7.set(s.x(),s.y(),s.z(),s.w()).mul(n);o.transformVector(t,gt),e.setPosition(i.x()-gt.x,i.y()-gt.y,i.z()-gt.z),e.setRotation(o);}else e.setPosition(i.x(),i.y(),i.z()),e.setRotation(s.x(),s.y(),s.z(),s.w());}}}_updateKinematic(){let e=this._body.getMotionState();e&&(this._getEntityTransform(h),e.setWorldTransform(h));}teleport(e,t,i,s,r,a){e instanceof ed?this.entity.setPosition(e):this.entity.setPosition(e,t,i),t instanceof ex?this.entity.setRotation(t):t instanceof ed?this.entity.setEulerAngles(t):void 0!==s&&this.entity.setEulerAngles(s,r,a),this.syncEntityToBody();}onEnable(){this._body||this.createBody(),this.enableSimulation();}onDisable(){this.disableSimulation();}constructor(...e){super(...e),this._angularDamping=0,this._angularFactor=new ed(1,1,1),this._angularVelocity=new ed,this._body=null,this._friction=.5,this._group=2,this._linearDamping=0,this._linearFactor=new ed(1,1,1),this._linearVelocity=new ed,this._mask=65533,this._mass=1,this._restitution=0,this._rollingFriction=0,this._simulationEnabled=false,this._type=mg;}}gi.EVENT_CONTACT="contact",gi.EVENT_COLLISIONSTART="collisionstart",gi.EVENT_COLLISIONEND="collisionend",gi.EVENT_TRIGGERENTER="triggerenter",gi.EVENT_TRIGGERLEAVE="triggerleave",gi.order=-1;class gs{constructor(){this.enabled=true;}}class gr{constructor(e,t,i,s){this.entity=e,this.point=t,this.normal=i,this.hitFraction=s;}}class ga{constructor(e,t,i){0!=arguments.length?(this.a=e,this.b=t,this.impulse=i.impulse,this.localPointA=i.localPoint,this.localPointB=i.localPointOther,this.pointA=i.point,this.pointB=i.pointOther,this.normal=i.normal):(this.a=null,this.b=null,this.impulse=0,this.localPointA=new ed,this.localPointB=new ed,this.pointA=new ed,this.pointB=new ed,this.normal=new ed);}}class gn{constructor(e=new ed,t=new ed,i=new ed,s=new ed,r=new ed,a=0){this.localPoint=e,this.localPointOther=t,this.point=i,this.pointOther=s,this.normal=r,this.impulse=a;}}class go{constructor(e,t){this.other=e,this.contacts=t;}}let gl=["enabled"];class gh extends f8{onLibraryLoaded(){if("undefined"!=typeof Ammo){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){let e=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(e);}f=new Ammo.btVector3,p=new Ammo.btVector3,gi.onLibraryLoaded(),this.contactPointPool=new _9(gn,1),this.contactResultPool=new _9(go,1),this.singleContactResultPool=new _9(ga,1),this.app.systems.on("update",this.onUpdate,this);}else this.app.systems.off("update",this.onUpdate,this);}initializeComponentData(e,t,i){for(let i of ["mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","rollingFriction","restitution","type","group","mask"])if(t.hasOwnProperty(i)){let s=t[i];Array.isArray(s)?e[i]=new ed(s[0],s[1],s[2]):e[i]=s;}super.initializeComponentData(e,t,["enabled"]);}cloneComponent(e,t){let i=e.rigidbody,s={enabled:i.enabled,mass:i.mass,linearDamping:i.linearDamping,angularDamping:i.angularDamping,linearFactor:[i.linearFactor.x,i.linearFactor.y,i.linearFactor.z],angularFactor:[i.angularFactor.x,i.angularFactor.y,i.angularFactor.z],friction:i.friction,rollingFriction:i.rollingFriction,restitution:i.restitution,type:i.type,group:i.group,mask:i.mask};return this.addComponent(t,s)}onBeforeRemove(e,t){t.enabled&&(t.enabled=false),t.body&&(this.destroyBody(t.body),t.body=null);}addBody(e,t,i){ void 0!==t&&void 0!==i?this.dynamicsWorld.addRigidBody(e,t,i):this.dynamicsWorld.addRigidBody(e);}removeBody(e){this.dynamicsWorld.removeRigidBody(e);}createBody(e,t,i){let s=new Ammo.btVector3(0,0,0);0!==e&&t.calculateLocalInertia(e,s);let r=new Ammo.btDefaultMotionState(i),a=new Ammo.btRigidBodyConstructionInfo(e,r,t,s),n=new Ammo.btRigidBody(a);return Ammo.destroy(a),Ammo.destroy(s),n}destroyBody(e){let t=e.getMotionState();t&&Ammo.destroy(t),Ammo.destroy(e);}raycastFirst(e,t,i={}){if(i.filterTags||i.filterCallback)return i.sort=true,this.raycastAll(e,t,i)[0]||null;let s=null;f.setValue(e.x,e.y,e.z),p.setValue(t.x,t.y,t.z);let r=new Ammo.ClosestRayResultCallback(f,p);if("number"==typeof i.filterCollisionGroup&&r.set_m_collisionFilterGroup(i.filterCollisionGroup),"number"==typeof i.filterCollisionMask&&r.set_m_collisionFilterMask(i.filterCollisionMask),this.dynamicsWorld.rayTest(f,p,r),r.hasHit()){let e=r.get_m_collisionObject(),t=Ammo.castObject(e,Ammo.btRigidBody);if(t){let e=r.get_m_hitPointWorld(),i=r.get_m_hitNormalWorld();s=new gr(t.entity,new ed(e.x(),e.y(),e.z()),new ed(i.x(),i.y(),i.z()),r.get_m_closestHitFraction());}}return Ammo.destroy(r),s}raycastAll(e,t,i={}){let s=[];f.setValue(e.x,e.y,e.z),p.setValue(t.x,t.y,t.z);let r=new Ammo.AllHitsRayResultCallback(f,p);if("number"==typeof i.filterCollisionGroup&&r.set_m_collisionFilterGroup(i.filterCollisionGroup),"number"==typeof i.filterCollisionMask&&r.set_m_collisionFilterMask(i.filterCollisionMask),this.dynamicsWorld.rayTest(f,p,r),r.hasHit()){let e=r.get_m_collisionObjects(),t=r.get_m_hitPointWorld(),a=r.get_m_hitNormalWorld(),n=r.get_m_hitFractions(),o=e.size();for(let r=0;r<o;r++){let o=Ammo.castObject(e.at(r),Ammo.btRigidBody);if(o&&o.entity){if(i.filterTags&&!o.entity.tags.has(...i.filterTags)||i.filterCallback&&!i.filterCallback(o.entity))continue;let e=t.at(r),l=a.at(r),h=new gr(o.entity,new ed(e.x(),e.y(),e.z()),new ed(l.x(),l.y(),l.z()),n.at(r));s.push(h);}}i.sort&&s.sort((e,t)=>e.hitFraction-t.hitFraction);}return Ammo.destroy(r),s}_storeCollision(e,t){let i=false,s=e.getGuid();return this.collisions[s]=this.collisions[s]||{others:[],entity:e},0>this.collisions[s].others.indexOf(t)&&(this.collisions[s].others.push(t),i=true),this.frameCollisions[s]=this.frameCollisions[s]||{others:[],entity:e},this.frameCollisions[s].others.push(t),i}_createContactPointFromAmmo(e){let t=e.get_m_localPointA(),i=e.get_m_localPointB(),s=e.getPositionWorldOnA(),r=e.getPositionWorldOnB(),a=e.get_m_normalWorldOnB(),n=this.contactPointPool.allocate();return n.localPoint.set(t.x(),t.y(),t.z()),n.localPointOther.set(i.x(),i.y(),i.z()),n.point.set(s.x(),s.y(),s.z()),n.pointOther.set(r.x(),r.y(),r.z()),n.normal.set(a.x(),a.y(),a.z()),n.impulse=e.getAppliedImpulse(),n}_createReverseContactPointFromAmmo(e){let t=e.get_m_localPointA(),i=e.get_m_localPointB(),s=e.getPositionWorldOnA(),r=e.getPositionWorldOnB(),a=e.get_m_normalWorldOnB(),n=this.contactPointPool.allocate();return n.localPointOther.set(t.x(),t.y(),t.z()),n.localPoint.set(i.x(),i.y(),i.z()),n.pointOther.set(s.x(),s.y(),s.z()),n.point.set(r.x(),r.y(),r.z()),n.normal.set(a.x(),a.y(),a.z()),n.impulse=e.getAppliedImpulse(),n}_createSingleContactResult(e,t,i){let s=this.singleContactResultPool.allocate();return s.a=e,s.b=t,s.localPointA=i.localPoint,s.localPointB=i.localPointOther,s.pointA=i.point,s.pointB=i.pointOther,s.normal=i.normal,s.impulse=i.impulse,s}_createContactResult(e,t){let i=this.contactResultPool.allocate();return i.other=e,i.contacts=t,i}_cleanOldCollisions(){for(let e in this.collisions)if(this.collisions.hasOwnProperty(e)){let t=this.frameCollisions[e],i=this.collisions[e],s=i.entity,r=s.collision,a=s.rigidbody,n=i.others,o=n.length;for(;o--;){let e=n[o];(!t||0>t.others.indexOf(e))&&(n.splice(o,1),s.trigger?(r&&r.fire("triggerleave",e),e.rigidbody&&e.rigidbody.fire("triggerleave",s)):!e.trigger&&(a&&a.fire("collisionend",e),r&&r.fire("collisionend",e)));}0===n.length&&delete this.collisions[e];}}_hasContactEvent(e){let t=e.collision;if(t&&(t.hasEvent("collisionstart")||t.hasEvent("collisionend")||t.hasEvent("contact")))return  true;let i=e.rigidbody;return i&&(i.hasEvent("collisionstart")||i.hasEvent("collisionend")||i.hasEvent("contact"))}_checkForCollisions(e,t){let i=Ammo.wrapPointer(e,Ammo.btDynamicsWorld).getDispatcher(),s=i.getNumManifolds();this.frameCollisions={};for(let e=0;e<s;e++){let t,s=i.getManifoldByIndexInternal(e),r=s.getBody0(),a=s.getBody1(),n=Ammo.castObject(r,Ammo.btRigidBody),o=Ammo.castObject(a,Ammo.btRigidBody),l=n.entity,h=o.entity;if(!l||!h)continue;let c=n.getCollisionFlags(),d=o.getCollisionFlags(),u=s.getNumContacts(),f=[],p=[];if(u>0)if(4&c||4&d){let e=l.collision&&(l.collision.hasEvent("triggerenter")||l.collision.hasEvent("triggerleave")),i=h.collision&&(h.collision.hasEvent("triggerenter")||h.collision.hasEvent("triggerleave")),s=l.rigidbody&&(l.rigidbody.hasEvent("triggerenter")||l.rigidbody.hasEvent("triggerleave")),r=h.rigidbody&&(h.rigidbody.hasEvent("triggerenter")||h.rigidbody.hasEvent("triggerleave"));e&&(t=this._storeCollision(l,h))&&!(4&d)&&l.collision.fire("triggerenter",h),i&&(t=this._storeCollision(h,l))&&!(4&c)&&h.collision.fire("triggerenter",l),s&&(t||(t=this._storeCollision(h,l)),t&&l.rigidbody.fire("triggerenter",h)),r&&(t||(t=this._storeCollision(l,h)),t&&h.rigidbody.fire("triggerenter",l));}else {let e=this._hasContactEvent(l),i=this._hasContactEvent(h),r=this.hasEvent("contact");if(r||e||i){for(let t=0;t<u;t++){let a=s.getContactPoint(t),n=this._createContactPointFromAmmo(a);if(e||i){f.push(n);let e=this._createReverseContactPointFromAmmo(a);p.push(e);}if(r){let e=this._createSingleContactResult(l,h,n);this.fire("contact",e);}}if(e){let e=this._createContactResult(h,f);t=this._storeCollision(l,h),l.collision&&(l.collision.fire("contact",e),t&&l.collision.fire("collisionstart",e)),l.rigidbody&&(l.rigidbody.fire("contact",e),t&&l.rigidbody.fire("collisionstart",e));}if(i){let e=this._createContactResult(l,p);t=this._storeCollision(h,l),h.collision&&(h.collision.fire("contact",e),t&&h.collision.fire("collisionstart",e)),h.rigidbody&&(h.rigidbody.fire("contact",e),t&&h.rigidbody.fire("collisionstart",e));}}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll();}onUpdate(e){let t,i;this._stats.physicsStart=Q(),this._gravityFloat32[0]=this.gravity.x,this._gravityFloat32[1]=this.gravity.y,this._gravityFloat32[2]=this.gravity.z;let s=this.dynamicsWorld.getGravity();(s.x()!==this._gravityFloat32[0]||s.y()!==this._gravityFloat32[1]||s.z()!==this._gravityFloat32[2])&&(s.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(s));let r=this._triggers;for(t=0,i=r.length;t<i;t++)r[t].updateTransform();let a=this._compounds;for(t=0,i=a.length;t<i;t++)a[t]._updateCompound();let n=this._kinematic;for(t=0,i=n.length;t<i;t++)n[t]._updateKinematic();this.dynamicsWorld.stepSimulation(e,this.maxSubSteps,this.fixedTimeStep);let o=this._dynamic;for(t=0,i=o.length;t<i;t++)o[t]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),e),this._stats.physicsTime=Q()-this._stats.physicsStart;}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),"undefined"!=typeof Ammo&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),Ammo.destroy(f),Ammo.destroy(p),this.dynamicsWorld=null,this.solver=null,this.overlappingPairCache=null,this.dispatcher=null,this.collisionConfiguration=null,f=null,p=null,gi.onAppDestroy());}constructor(e){super(e),this.maxSubSteps=10,this.fixedTimeStep=1/60,this.gravity=new ed(0,-9.81,0),this._gravityFloat32=new Float32Array(3),this._dynamic=[],this._kinematic=[],this._triggers=[],this._compounds=[],this.id="rigidbody",this._stats=e.stats.frame,this.ComponentType=gi,this.DataType=gs,this.contactPointPool=null,this.contactResultPool=null,this.singleContactResultPool=null,this.schema=gl,this.collisions={},this.frameCollisions={},this.on("beforeremove",this.onBeforeRemove,this);}}gh.EVENT_CONTACT="contact",f5._buildAccessors(gi.prototype,gl);let gc="none",gd="blend",gu=new ey;class gf extends f5{syncDrawOrder(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this);}_recurseDrawOrderSync(e,t){if(!(e instanceof fB))return t;if(e.element){let i=e.element.drawOrder;e.element.drawOrder=t++,e.element._batchGroupId>=0&&i!==e.element.drawOrder&&this.system.app.batcher?.markGroupDirty(e.element._batchGroupId);}e.particlesystem&&(e.particlesystem.drawOrder=t++);let i=e.children;for(let e=0;e<i.length;e++)t=this._recurseDrawOrderSync(i[e],t);return t}_processDrawOrderSync(){this._recurseDrawOrderSync(this.entity,1),this.fire("syncdraworder");}_calcProjectionMatrix(){let e=this._resolution.x/this.scale,t=this._resolution.y/this.scale;this._screenMatrix.setOrtho(0,e,-t,0,1,-1),this._screenSpace||(gu.setScale(.5*e,.5*t,1),this._screenMatrix.mul2(gu,this._screenMatrix));}_updateScale(){this.scale=this._calcScale(this._resolution,this.referenceResolution);}_calcScale(e,t){let i=Math.log2((e.x||1)/t.x),s=Math.log2((e.y||1)/t.y);return Math.pow(2,i*(1-this._scaleBlend)+s*this._scaleBlend)}_onResize(e,t){this._screenSpace&&(this._resolution.set(e,t),this.resolution=this._resolution);}_bindElement(e){this._elements.add(e);}_unbindElement(e){this._elements.delete(e);}onRemove(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.fire("remove"),this._elements.forEach(e=>e._onScreenRemove()),this._elements.clear(),this.off();}set resolution(e){this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:resolution",this._resolution),this._elements.forEach(e=>e._onScreenResize(this._resolution));}get resolution(){return this._resolution}set referenceResolution(e){this._referenceResolution.set(e.x,e.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:referenceresolution",this._resolution),this._elements.forEach(e=>e._onScreenResize(this._resolution));}get referenceResolution(){return this._scaleMode===gc?this._resolution:this._referenceResolution}set screenSpace(e){this._screenSpace=e,this._screenSpace&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this.resolution=this._resolution,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:screenspace",this._screenSpace),this._elements.forEach(e=>e._onScreenSpaceChange());}get screenSpace(){return this._screenSpace}set scaleMode(e){e!==gc&&e!==gd&&(e=gc),this._screenSpace||e===gc||(e=gc),this._scaleMode=e,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode);}get scaleMode(){return this._scaleMode}set scaleBlend(e){this._scaleBlend=e,this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:scaleblend",this._scaleBlend),this._elements.forEach(e=>e._onScreenResize(this._resolution));}get scaleBlend(){return this._scaleBlend}set priority(e){e=ei.clamp(e,0,127),this._priority!==e&&(this._priority=e,this.syncDrawOrder());}get priority(){return this._priority}constructor(e,t){super(e,t),this._resolution=new ef(640,320),this._referenceResolution=new ef(640,320),this._scaleMode=gc,this.scale=1,this._scaleBlend=.5,this._priority=0,this._screenSpace=false,this.cull=this._screenSpace,this._screenMatrix=new ey,this._elements=new Set,e.app.graphicsDevice.on("resizecanvas",this._onResize,this);}}class gp{constructor(){this.enabled=true;}}let gm=["enabled"];class g_ extends f8{initializeComponentData(e,t,i){ void 0!==t.priority&&(e.priority=t.priority),void 0!==t.screenSpace&&(e.screenSpace=t.screenSpace),e.cull=e.screenSpace,void 0!==t.scaleMode&&(e.scaleMode=t.scaleMode),void 0!==t.scaleBlend&&(e.scaleBlend=t.scaleBlend),void 0!==t.resolution&&(t.resolution instanceof ef?e._resolution.copy(t.resolution):e._resolution.set(t.resolution[0],t.resolution[1]),e.resolution=e._resolution),void 0!==t.referenceResolution&&(t.referenceResolution instanceof ef?e._referenceResolution.copy(t.referenceResolution):e._referenceResolution.set(t.referenceResolution[0],t.referenceResolution[1]),e.referenceResolution=e._referenceResolution),this._updateDescendantElements(e.entity,e.entity),e.syncDrawOrder(),super.initializeComponentData(e,t,gm);}_updateDescendantElements(e,t){let i=e.children;for(let e=0;e<i.length;e++){let s=i[e];s.element&&!s.element.screen&&s.element._updateScreen(t),s.screen||this._updateDescendantElements(s,t);}}destroy(){super.destroy(),this.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.app.systems.off("update",this._onUpdate,this);}_onUpdate(e){let t=this.store;for(let i in t)t[i].entity.screen.update&&t[i].entity.screen.update(e);}_onResize(e,t){this.windowResolution.x=e,this.windowResolution.y=t;}cloneComponent(e,t){let i=e.screen;return this.addComponent(t,{enabled:i.enabled,screenSpace:i.screenSpace,scaleMode:i.scaleMode,scaleBlend:i.scaleBlend,priority:i.priority,resolution:i.resolution.clone(),referenceResolution:i.referenceResolution.clone()})}onRemoveComponent(e,t){t.onRemove();}processDrawOrderSyncQueue(){let e=this._drawOrderSyncQueue.list();for(let t=0;t<e.length;t++){let i=e[t];i.callback.call(i.scope);}this._drawOrderSyncQueue.clear();}queueDrawOrderSync(e,t,i){this._drawOrderSyncQueue.list().length||this.app.once("prerender",this.processDrawOrderSyncQueue,this),this._drawOrderSyncQueue.has(e)||this._drawOrderSyncQueue.push(e,{callback:t,scope:i});}constructor(e){super(e),this.id="screen",this.ComponentType=gf,this.DataType=gp,this.schema=gm,this.windowResolution=new ef,this._drawOrderSyncQueue=new Y,this.app.graphicsDevice.on("resizecanvas",this._onResize,this),this.app.systems.on("update",this._onUpdate,this),this.on("beforeremove",this.onRemoveComponent,this);}}f5._buildAccessors(gf.prototype,gm);let gg=new ef,gv=new ed,gS=new eM,gy=new eR,gx=new ed,gT=new ed,gE=new ex,gw={x:"y",y:"x"};class gb extends X{_toggleLifecycleListeners(e){this._element[e]("mousedown",this._onMouseDownOrTouchStart,this),this._element[e]("touchstart",this._onMouseDownOrTouchStart,this),this._element[e]("selectstart",this._onMouseDownOrTouchStart,this);}_toggleDragListeners(e){let t="on"===e;this._hasDragListeners&&t||(this._app.mouse&&(this._element[e]("mousemove",this._onMove,this),this._element[e]("mouseup",this._onMouseUpOrTouchEnd,this)),k.touch&&(this._element[e]("touchmove",this._onMove,this),this._element[e]("touchend",this._onMouseUpOrTouchEnd,this),this._element[e]("touchcancel",this._onMouseUpOrTouchEnd,this)),this._element[e]("selectmove",this._onMove,this),this._element[e]("selectend",this._onMouseUpOrTouchEnd,this),this._hasDragListeners=t);}_onMouseDownOrTouchStart(e){if(this._element&&!this._isDragging&&this.enabled){this._dragCamera=e.camera,this._calculateDragScale();let t=this._screenToLocal(e);t&&(this._toggleDragListeners("on"),this._isDragging=true,this._dragStartMousePosition.copy(t),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"));}}_onMouseUpOrTouchEnd(){this._isDragging&&(this._isDragging=false,this._toggleDragListeners("off"),this.fire("drag:end"));}_screenToLocal(e){return (e.inputSource?gS.set(e.inputSource.getOrigin(),e.inputSource.getDirection()):(this._determineInputPosition(e),this._chooseRayOriginAndDirection()),gx.copy(this._element.entity.forward).mulScalar(-1),gy.setFromPointNormal(this._element.entity.getPosition(),gx),gy.intersectsRay(gS,gT))?(gE.copy(this._element.entity.getRotation()).invert().transformVector(gT,gT),gT.mul(this._dragScale),gT):null}_determineInputPosition(e){let t=this._app.graphicsDevice.maxPixelRatio;void 0!==e.x&&void 0!==e.y?(gg.x=e.x*t,gg.y=e.y*t):e.changedTouches&&(gg.x=e.changedTouches[0].x*t,gg.y=e.changedTouches[0].y*t);}_chooseRayOriginAndDirection(){this._element.screen&&this._element.screen.screen.screenSpace?(gS.origin.set(gg.x,-gg.y,0),gS.direction.copy(ed.FORWARD)):(gv.copy(this._dragCamera.screenToWorld(gg.x,gg.y,1)),gS.origin.copy(this._dragCamera.entity.getPosition()),gS.direction.copy(gv).sub(gS.origin).normalize());}_calculateDragScale(){let e=this._element.entity.parent,t=this._element.screen&&this._element.screen.screen,i=t&&t.screenSpace,s=i?t.scale:1,r=this._dragScale;for(r.set(s,s,s);e&&(r.mul(e.getLocalScale()),e=e.parent,!i||!e.screen););r.x=1/r.x,r.y=1/r.y,r.z=0;}_onMove(e){let{_element:t,_deltaMousePosition:i,_deltaHandlePosition:s,_axis:r}=this;if(t&&this._isDragging&&this.enabled&&t.enabled&&t.entity.enabled){let a=this._screenToLocal(e);if(a){if(i.sub2(a,this._dragStartMousePosition),s.add2(this._dragStartHandlePosition,i),r){let e=t.entity.getLocalPosition(),i=gw[r];s[i]=e[i];}t.entity.setLocalPosition(s),this.fire("drag:move",s);}}}destroy(){this._toggleLifecycleListeners("off"),this._toggleDragListeners("off");}set enabled(e){this._enabled=e;}get enabled(){return this._enabled}get isDragging(){return this._isDragging}constructor(e,t){if(super(),!e||!(e instanceof _r))throw Error("Element was null or not an ElementComponent");if(t&&"x"!==t&&"y"!==t)throw Error(`Unrecognized axis: ${t}`);this._element=e,this._app=e.system.app,this._axis=t||null,this._enabled=true,this._dragScale=new ed,this._dragStartMousePosition=new ed,this._dragStartHandlePosition=new ed,this._deltaMousePosition=new ed,this._deltaHandlePosition=new ed,this._isDragging=false,this._toggleLifecycleListeners("on");}}gb.EVENT_DRAGSTART="drag:start",gb.EVENT_DRAGEND="drag:end",gb.EVENT_DRAGMOVE="drag:move";let gA=new ef;class gC extends f5{get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e);}get enabled(){return this.data.enabled}set horizontal(e){this._setValue("horizontal",e);}get horizontal(){return this.data.horizontal}set vertical(e){this._setValue("vertical",e);}get vertical(){return this.data.vertical}set scrollMode(e){this._setValue("scrollMode",e);}get scrollMode(){return this.data.scrollMode}set bounceAmount(e){this._setValue("bounceAmount",e);}get bounceAmount(){return this.data.bounceAmount}set friction(e){this._setValue("friction",e);}get friction(){return this.data.friction}set dragThreshold(e){this._setValue("dragThreshold",e);}get dragThreshold(){return this.data.dragThreshold}set useMouseWheel(e){this._setValue("useMouseWheel",e);}get useMouseWheel(){return this.data.useMouseWheel}set mouseWheelSensitivity(e){this._setValue("mouseWheelSensitivity",e);}get mouseWheelSensitivity(){return this.data.mouseWheelSensitivity}set horizontalScrollbarVisibility(e){this._setValue("horizontalScrollbarVisibility",e);}get horizontalScrollbarVisibility(){return this.data.horizontalScrollbarVisibility}set verticalScrollbarVisibility(e){this._setValue("verticalScrollbarVisibility",e);}get verticalScrollbarVisibility(){return this.data.verticalScrollbarVisibility}set viewportEntity(e){if(this._viewportEntity===e)return;let t="string"==typeof e;(!this._viewportEntity||!t||this._viewportEntity.getGuid()!==e)&&(this._viewportEntity&&this._viewportEntityUnsubscribe(),e instanceof oX?this._viewportEntity=e:t?this._viewportEntity=this.system.app.getEntityFromIndex(e)||null:this._viewportEntity=null,this._viewportEntity&&this._viewportEntitySubscribe(),this._viewportEntity?this.data.viewportEntity=this._viewportEntity.getGuid():t&&e&&(this.data.viewportEntity=e));}get viewportEntity(){return this._viewportEntity}set contentEntity(e){if(this._contentEntity===e)return;let t="string"==typeof e;(!this._contentEntity||!t||this._contentEntity.getGuid()!==e)&&(this._contentEntity&&this._contentEntityUnsubscribe(),e instanceof oX?this._contentEntity=e:t?this._contentEntity=this.system.app.getEntityFromIndex(e)||null:this._contentEntity=null,this._contentEntity&&this._contentEntitySubscribe(),this._contentEntity?this.data.contentEntity=this._contentEntity.getGuid():t&&e&&(this.data.contentEntity=e));}get contentEntity(){return this._contentEntity}set horizontalScrollbarEntity(e){if(this._horizontalScrollbarEntity===e)return;let t="string"==typeof e;(!this._horizontalScrollbarEntity||!t||this._horizontalScrollbarEntity.getGuid()!==e)&&(this._horizontalScrollbarEntity&&this._horizontalScrollbarEntityUnsubscribe(),e instanceof oX?this._horizontalScrollbarEntity=e:t?this._horizontalScrollbarEntity=this.system.app.getEntityFromIndex(e)||null:this._horizontalScrollbarEntity=null,this._scrollbarEntities[0]=this._horizontalScrollbarEntity,this._horizontalScrollbarEntity&&this._horizontalScrollbarEntitySubscribe(),this._horizontalScrollbarEntity?this.data.horizontalScrollbarEntity=this._horizontalScrollbarEntity.getGuid():t&&e&&(this.data.horizontalScrollbarEntity=e));}get horizontalScrollbarEntity(){return this._horizontalScrollbarEntity}set verticalScrollbarEntity(e){if(this._verticalScrollbarEntity===e)return;let t="string"==typeof e;(!this._verticalScrollbarEntity||!t||this._verticalScrollbarEntity.getGuid()!==e)&&(this._verticalScrollbarEntity&&this._verticalScrollbarEntityUnsubscribe(),e instanceof oX?this._verticalScrollbarEntity=e:t?this._verticalScrollbarEntity=this.system.app.getEntityFromIndex(e)||null:this._verticalScrollbarEntity=null,this._scrollbarEntities[1]=this._verticalScrollbarEntity,this._verticalScrollbarEntity&&this._verticalScrollbarEntitySubscribe(),this._verticalScrollbarEntity?this.data.verticalScrollbarEntity=this._verticalScrollbarEntity.getGuid():t&&e&&(this.data.verticalScrollbarEntity=e));}get verticalScrollbarEntity(){return this._verticalScrollbarEntity}set scroll(e){this._onSetScroll(e.x,e.y);}get scroll(){return this._scroll}_setValue(e,t){let i=this.data,s=i[e];i[e]=t,this.fire("set",e,s,t);}_toggleLifecycleListeners(e){this[e]("set_horizontal",this._onSetHorizontalScrollingEnabled,this),this[e]("set_vertical",this._onSetVerticalScrollingEnabled,this),this.entity[e]("element:add",this._onElementComponentAdd,this);}_toggleElementListeners(e){this.entity.element&&("on"===e&&this._hasElementListeners||(this.entity.element[e]("resize",this._syncAll,this),this.entity.element[e]("mousewheel",this._onMouseWheel,this),this._hasElementListeners="on"===e));}_onElementComponentAdd(e){this._evtElementRemove=this.entity.element.once("beforeremove",this._onElementComponentRemove,this),this._toggleElementListeners("on");}_onElementComponentRemove(e){this._evtElementRemove?.off(),this._evtElementRemove=null,this._toggleElementListeners("off");}_viewportEntitySubscribe(){this._evtViewportEntityElementAdd=this._viewportEntity.on("element:add",this._onViewportElementGain,this),this._viewportEntity.element&&this._onViewportElementGain();}_viewportEntityUnsubscribe(){this._evtViewportEntityElementAdd?.off(),this._evtViewportEntityElementAdd=null,this._viewportEntity?.element&&this._onViewportElementLose();}_viewportEntityElementSubscribe(){let e=this._viewportEntity.element;this._evtViewportElementRemove=e.once("beforeremove",this._onViewportElementLose,this),this._evtViewportResize=e.on("resize",this._syncAll,this);}_viewportEntityElementUnsubscribe(){this._evtViewportElementRemove?.off(),this._evtViewportElementRemove=null,this._evtViewportResize?.off(),this._evtViewportResize=null;}_onViewportElementGain(){this._viewportEntityElementSubscribe(),this._syncAll();}_onViewportElementLose(){this._viewportEntityElementUnsubscribe();}_contentEntitySubscribe(){this._evtContentEntityElementAdd=this._contentEntity.on("element:add",this._onContentElementGain,this),this._contentEntity.element&&this._onContentElementGain();}_contentEntityUnsubscribe(){this._evtContentEntityElementAdd?.off(),this._evtContentEntityElementAdd=null,this._contentEntity?.element&&this._onContentElementLose();}_contentEntityElementSubscribe(){let e=this._contentEntity.element;this._evtContentElementRemove=e.once("beforeremove",this._onContentElementLose,this),this._evtContentResize=e.on("resize",this._syncAll,this);}_contentEntityElementUnsubscribe(){this._evtContentElementRemove?.off(),this._evtContentElementRemove=null,this._evtContentResize?.off(),this._evtContentResize=null;}_onContentElementGain(){this._contentEntityElementSubscribe(),this._destroyDragHelper(),this._contentDragHelper=new gb(this._contentEntity.element),this._contentDragHelper.on("drag:start",this._onContentDragStart,this),this._contentDragHelper.on("drag:end",this._onContentDragEnd,this),this._contentDragHelper.on("drag:move",this._onContentDragMove,this),this._prevContentSizes[0]=null,this._prevContentSizes[1]=null,this._syncAll();}_onContentElementLose(){this._contentEntityElementUnsubscribe(),this._destroyDragHelper();}_onContentDragStart(){this._contentEntity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentEntity.getLocalPosition());}_onContentDragEnd(){this._prevContentDragPosition=null,this._enableContentInput();}_onContentDragMove(e){if(this._contentEntity&&this.enabled&&this.entity.enabled&&(this._wasDragged=true,this._setScrollFromContentPosition(e),this._setVelocityFromContentPositionDelta(e),!this._disabledContentInput)){let t=e.x-this._dragStartPosition.x,i=e.y-this._dragStartPosition.y;(Math.abs(t)>this.dragThreshold||Math.abs(i)>this.dragThreshold)&&this._disableContentInput();}}_horizontalScrollbarEntitySubscribe(){this._evtHorizontalScrollbarAdd=this._horizontalScrollbarEntity.on("scrollbar:add",this._onHorizontalScrollbarGain,this),this._horizontalScrollbarEntity.scrollbar&&this._onHorizontalScrollbarGain();}_verticalScrollbarEntitySubscribe(){this._evtVerticalScrollbarAdd=this._verticalScrollbarEntity.on("scrollbar:add",this._onVerticalScrollbarGain,this),this._verticalScrollbarEntity.scrollbar&&this._onVerticalScrollbarGain();}_horizontalScrollbarEntityUnsubscribe(){this._evtHorizontalScrollbarAdd?.off(),this._evtHorizontalScrollbarAdd=null,this._horizontalScrollbarEntity.scrollbar&&this._onHorizontalScrollbarLose();}_verticalScrollbarEntityUnsubscribe(){this._evtVerticalScrollbarAdd?.off(),this._evtVerticalScrollbarAdd=null,this._verticalScrollbarEntity.scrollbar&&this._onVerticalScrollbarLose();}_onSetHorizontalScrollbarValue(e){!this._scrollbarUpdateFlags[0]&&this.enabled&&this.entity.enabled&&this._onSetScroll(e,null);}_onSetVerticalScrollbarValue(e){!this._scrollbarUpdateFlags[1]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,e);}_onHorizontalScrollbarGain(){let e=this._horizontalScrollbarEntity?.scrollbar;this._evtHorizontalScrollbarRemove=e.on("beforeremove",this._onHorizontalScrollbarLose,this),this._evtHorizontalScrollbarValue=e.on("set:value",this._onSetHorizontalScrollbarValue,this),this._syncScrollbarEnabledState(0),this._syncScrollbarPosition(0);}_onVerticalScrollbarGain(){let e=this._verticalScrollbarEntity?.scrollbar;this._evtVerticalScrollbarRemove=e.on("beforeremove",this._onVerticalScrollbarLose,this),this._evtVerticalScrollbarValue=e.on("set:value",this._onSetVerticalScrollbarValue,this),this._syncScrollbarEnabledState(1),this._syncScrollbarPosition(1);}_onHorizontalScrollbarLose(){this._evtHorizontalScrollbarRemove?.off(),this._evtHorizontalScrollbarRemove=null,this._evtHorizontalScrollbarValue?.off(),this._evtHorizontalScrollbarValue=null;}_onVerticalScrollbarLose(){this._evtVerticalScrollbarRemove?.off(),this._evtVerticalScrollbarRemove=null,this._evtVerticalScrollbarValue?.off(),this._evtVerticalScrollbarValue=null;}_onSetHorizontalScrollingEnabled(){this._syncScrollbarEnabledState(0);}_onSetVerticalScrollingEnabled(){this._syncScrollbarEnabledState(1);}_onSetScroll(e,t,i){ false!==i&&this._velocity.set(0,0,0);let s=this._updateAxis(e,"x",0),r=this._updateAxis(t,"y",1);(s||r)&&this.fire("set:scroll",this._scroll);}_updateAxis(e,t,i){let s=null!==e&&Math.abs(e-this._scroll[t])>1e-5;return (s||this._isDragging()||0===e)&&(this._scroll[t]=this._determineNewScrollValue(e,t,i),this._syncContentPosition(i),this._syncScrollbarPosition(i)),s}_determineNewScrollValue(e,t,i){if(!this._getScrollingEnabled(i))return this._scroll[t];switch(this.scrollMode){case 0:return ei.clamp(e,0,this._getMaxScrollValue(i));case 1:return this._setVelocityFromOvershoot(e,t,i),e;default:return e}}_syncAll(){this._syncContentPosition(0),this._syncContentPosition(1),this._syncScrollbarPosition(0),this._syncScrollbarPosition(1),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1);}_syncContentPosition(e){if(!this._contentEntity)return;let t=this._getAxis(e),i=this._getSign(e),s=this._prevContentSizes[e],r=this._getContentSize(e);if(null!==s&&Math.abs(s-r)>1e-4){let i=this._getMaxOffset(e,s),a=this._getMaxOffset(e,r);0===a?this._scroll[t]=1:this._scroll[t]=ei.clamp(this._scroll[t]*i/a,0,1);}let a=this._scroll[t]*this._getMaxOffset(e),n=this._contentEntity.getLocalPosition();n[t]=a*i,this._contentEntity.setLocalPosition(n),this._prevContentSizes[e]=r;}_syncScrollbarPosition(e){let t=this._scrollbarEntities[e];if(!t?.scrollbar)return;let i=this._getAxis(e);this._scrollbarUpdateFlags[e]=true,t.scrollbar.value=this._scroll[i],t.scrollbar.handleSize=this._getScrollbarHandleSize(i,e),this._scrollbarUpdateFlags[e]=false;}_syncScrollbarEnabledState(e){let t=this._scrollbarEntities[e];if(!t)return;let i=this._getScrollingEnabled(e);switch(this._getScrollbarVisibility(e)){case 0:t.enabled=i;return;case 1:t.enabled=i&&this._contentIsLargerThanViewport(e);return;default:t.enabled=i;}}_contentIsLargerThanViewport(e){return this._getContentSize(e)>this._getViewportSize(e)}_contentPositionToScrollValue(e){let t=this._getMaxOffset(0),i=this._getMaxOffset(1);return 0===t?gA.x=0:gA.x=e.x/t,0===i?gA.y=0:gA.y=-(e.y/i),gA}_getMaxOffset(e,t){t=void 0===t?this._getContentSize(e):t;let i=this._getViewportSize(e);return t<i?-this._getViewportSize(e):i-t}_getMaxScrollValue(e){return +!!this._contentIsLargerThanViewport(e)}_getScrollbarHandleSize(e,t){let i=this._getViewportSize(t),s=this._getContentSize(t);if(.001>Math.abs(s))return 1;let r=Math.min(i/s,1),a=this._toOvershoot(this._scroll[e],t);return 0===a?r:r/(1+Math.abs(a))}_getViewportSize(e){return this._getSize(e,this._viewportEntity)}_getContentSize(e){return this._getSize(e,this._contentEntity)}_getSize(e,t){return t?.element?t.element[this._getCalculatedDimension(e)]:0}_getScrollingEnabled(e){return 0===e?this.horizontal:1===e?this.vertical:void 0}_getScrollbarVisibility(e){return 0===e?this.horizontalScrollbarVisibility:1===e?this.verticalScrollbarVisibility:void 0}_getSign(e){return 0===e?1:-1}_getAxis(e){return 0===e?"x":"y"}_getCalculatedDimension(e){return 0===e?"calculatedWidth":"calculatedHeight"}_destroyDragHelper(){this._contentDragHelper&&this._contentDragHelper.destroy();}onUpdate(){this._contentEntity&&(this._updateVelocity(),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1));}_updateVelocity(){if(!this._isDragging()){if(1===this.scrollMode&&(this._hasOvershoot("x",0)&&this._setVelocityFromOvershoot(this.scroll.x,"x",0),this._hasOvershoot("y",1)&&this._setVelocityFromOvershoot(this.scroll.y,"y",1)),Math.abs(this._velocity.x)>1e-4||Math.abs(this._velocity.y)>1e-4){let e=this._contentEntity.getLocalPosition();e.x+=this._velocity.x,e.y+=this._velocity.y,this._contentEntity.setLocalPosition(e),this._setScrollFromContentPosition(e);}this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction;}}_hasOvershoot(e,t){return Math.abs(this._toOvershoot(this.scroll[e],t))>.001}_toOvershoot(e,t){let i=this._getMaxScrollValue(t);return e<0?e:e>i?e-i:0}_setVelocityFromOvershoot(e,t,i){let s=this._toOvershoot(e,i)*this._getMaxOffset(i)*this._getSign(i);Math.abs(s)>0&&(this._velocity[t]=-s/(50*this.bounceAmount+1));}_setVelocityFromContentPositionDelta(e){this._prevContentDragPosition?(this._velocity.sub2(e,this._prevContentDragPosition),this._prevContentDragPosition.copy(e)):(this._velocity.set(0,0,0),this._prevContentDragPosition=e.clone());}_setScrollFromContentPosition(e){let t=this._contentPositionToScrollValue(e);this._isDragging()&&(t=this._applyScrollValueTension(t)),this._onSetScroll(t.x,t.y,false);}_applyScrollValueTension(e){let t=this._getMaxScrollValue(0),i=this._toOvershoot(e.x,0);return i>0?e.x=t+ +Math.log10(1+i):i<0&&(e.x=-1*Math.log10(1-i)),t=this._getMaxScrollValue(1),(i=this._toOvershoot(e.y,1))>0?e.y=t+ +Math.log10(1+i):i<0&&(e.y=-1*Math.log10(1-i)),e}_isDragging(){return this._contentDragHelper&&this._contentDragHelper.isDragging}_setScrollbarComponentsEnabled(e){this._horizontalScrollbarEntity?.scrollbar&&(this._horizontalScrollbarEntity.scrollbar.enabled=e),this._verticalScrollbarEntity?.scrollbar&&(this._verticalScrollbarEntity.scrollbar.enabled=e);}_setContentDraggingEnabled(e){this._contentDragHelper&&(this._contentDragHelper.enabled=e);}_onMouseWheel(e){if(!this.useMouseWheel||!this._contentEntity?.element)return;let t=e.event,i=t.deltaX/this._contentEntity.element.calculatedWidth*this.mouseWheelSensitivity.x,s=t.deltaY/this._contentEntity.element.calculatedHeight*this.mouseWheelSensitivity.y,r=ei.clamp(this._scroll.x+i,0,this._getMaxScrollValue(0)),a=ei.clamp(this._scroll.y+s,0,this._getMaxScrollValue(1));this.scroll=new ef(r,a);}_enableContentInput(){for(;this._disabledContentInputEntities.length;){let e=this._disabledContentInputEntities.pop();e.element&&(e.element.useInput=true);}this._disabledContentInput=false;}_disableContentInput(){let e=t=>{t.element&&t.element.useInput&&(this._disabledContentInputEntities.push(t),t.element.useInput=false);let i=t.children;for(let t=0,s=i.length;t<s;t++)e(i[t]);};if(this._contentEntity){let t=this._contentEntity.children;for(let i=0,s=t.length;i<s;i++)e(t[i]);}this._disabledContentInput=true;}onEnable(){this._setScrollbarComponentsEnabled(true),this._setContentDraggingEnabled(true),this._syncAll();}onDisable(){this._setScrollbarComponentsEnabled(false),this._setContentDraggingEnabled(false);}onRemove(){this._toggleLifecycleListeners("off"),this._toggleElementListeners("off"),this._destroyDragHelper();}resolveDuplicatedEntityReferenceProperties(e,t){e.viewportEntity&&(this.viewportEntity=t[e.viewportEntity.getGuid()]),e.contentEntity&&(this.contentEntity=t[e.contentEntity.getGuid()]),e.horizontalScrollbarEntity&&(this.horizontalScrollbarEntity=t[e.horizontalScrollbarEntity.getGuid()]),e.verticalScrollbarEntity&&(this.verticalScrollbarEntity=t[e.verticalScrollbarEntity.getGuid()]);}constructor(e,t){super(e,t),this._viewportEntity=null,this._contentEntity=null,this._horizontalScrollbarEntity=null,this._verticalScrollbarEntity=null,this._evtElementRemove=null,this._evtViewportElementRemove=null,this._evtViewportResize=null,this._evtContentEntityElementAdd=null,this._evtContentElementRemove=null,this._evtContentResize=null,this._evtHorizontalScrollbarAdd=null,this._evtHorizontalScrollbarRemove=null,this._evtHorizontalScrollbarValue=null,this._evtVerticalScrollbarAdd=null,this._evtVerticalScrollbarRemove=null,this._evtVerticalScrollbarValue=null,this._scrollbarUpdateFlags={},this._scrollbarEntities={},this._prevContentSizes={},this._prevContentSizes[0]=null,this._prevContentSizes[1]=null,this._scroll=new ef,this._velocity=new ed,this._dragStartPosition=new ed,this._disabledContentInput=false,this._disabledContentInputEntities=[],this._toggleLifecycleListeners("on"),this._toggleElementListeners("on");}}gC.EVENT_SETSCROLL="set:scroll";class gP{constructor(){this.enabled=true,this.dragThreshold=10,this.useMouseWheel=true,this.mouseWheelSensitivity=new ef(1,1),this.horizontalScrollbarVisibility=0,this.verticalScrollbarVisibility=0,this.viewportEntity=null,this.contentEntity=null,this.horizontalScrollbarEntity=null,this.verticalScrollbarEntity=null;}}let gI=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"useMouseWheel",type:"boolean"},{name:"mouseWheelSensitivity",type:"vec2"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"}];class gD extends f8{initializeComponentData(e,t,i){ void 0===t.dragThreshold&&(t.dragThreshold=10),void 0===t.useMouseWheel&&(t.useMouseWheel=true),void 0===t.mouseWheelSensitivity&&(t.mouseWheelSensitivity=new ef(1,1)),super.initializeComponentData(e,t,gI),e.viewportEntity=t.viewportEntity,e.contentEntity=t.contentEntity,e.horizontalScrollbarEntity=t.horizontalScrollbarEntity,e.verticalScrollbarEntity=t.verticalScrollbarEntity;}onUpdate(e){let t=this.store;for(let e in t){let i=t[e].entity,s=i.scrollview;s.enabled&&i.enabled&&s.onUpdate();}}_onRemoveComponent(e,t){t.onRemove();}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this);}constructor(e){super(e),this.id="scrollview",this.ComponentType=gC,this.DataType=gP,this.schema=gI,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this);}}class gR extends f5{get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e);}get enabled(){return this.data.enabled}set orientation(e){this._setValue("orientation",e);}get orientation(){return this.data.orientation}set value(e){this._setValue("value",e);}get value(){return this.data.value}set handleSize(e){this._setValue("handleSize",e);}get handleSize(){return this.data.handleSize}set handleEntity(e){if(this._handleEntity===e)return;let t="string"==typeof e;(!this._handleEntity||!t||this._handleEntity.getGuid()!==e)&&(this._handleEntity&&this._handleEntityUnsubscribe(),e instanceof oX?this._handleEntity=e:t?this._handleEntity=this.system.app.getEntityFromIndex(e)||null:this._handleEntity=null,this._handleEntity&&this._handleEntitySubscribe(),this._handleEntity?this.data.handleEntity=this._handleEntity.getGuid():t&&e&&(this.data.handleEntity=e));}get handleEntity(){return this._handleEntity}_setValue(e,t){let i=this.data,s=i[e];i[e]=t,this.fire("set",e,s,t);}_toggleLifecycleListeners(e){this[e]("set_value",this._onSetValue,this),this[e]("set_handleSize",this._onSetHandleSize,this),this[e]("set_orientation",this._onSetOrientation,this);}_handleEntitySubscribe(){this._evtHandleEntityElementAdd=this._handleEntity.on("element:add",this._onHandleElementGain,this),this._handleEntity.element&&this._onHandleElementGain();}_handleEntityUnsubscribe(){this._evtHandleEntityElementAdd?.off(),this._evtHandleEntityElementAdd=null,this._handleEntity?.element&&this._onHandleElementLose();}_handleEntityElementSubscribe(){let e=this._handleEntity.element,t=this._evtHandleEntityChanges;t.push(e.once("beforeremove",this._onHandleElementLose,this)),t.push(e.on("set:anchor",this._onSetHandleAlignment,this)),t.push(e.on("set:margin",this._onSetHandleAlignment,this)),t.push(e.on("set:pivot",this._onSetHandleAlignment,this));}_handleEntityElementUnsubscribe(){for(let e=0;e<this._evtHandleEntityChanges.length;e++)this._evtHandleEntityChanges[e].off();this._evtHandleEntityChanges.length=0;}_onHandleElementGain(){this._handleEntityElementSubscribe(),this._destroyDragHelper(),this._handleDragHelper=new gb(this._handleEntity.element,this._getAxis()),this._handleDragHelper.on("drag:move",this._onHandleDrag,this),this._updateHandlePositionAndSize();}_onHandleElementLose(){this._handleEntityElementUnsubscribe(),this._destroyDragHelper();}_onHandleDrag(e){this._handleEntity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(e[this._getAxis()]));}_onSetValue(e,t,i){Math.abs(i-t)>1e-5&&(this.data.value=ei.clamp(i,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value));}_onSetHandleSize(e,t,i){Math.abs(i-t)>1e-5&&(this.data.handleSize=ei.clamp(i,0,1),this._updateHandlePositionAndSize());}_onSetHandleAlignment(){this._updateHandlePositionAndSize();}_onSetOrientation(e,t,i){i!==t&&this._handleEntity?.element&&(this._handleEntity.element[this._getOppositeDimension()]=0);}_updateHandlePositionAndSize(){let e=this._handleEntity,t=e?.element;if(e){let t=e.getLocalPosition();t[this._getAxis()]=this._getHandlePosition(),e.setLocalPosition(t);}t&&(t[this._getDimension()]=this._getHandleLength());}_handlePositionToScrollValue(e){return e*this._getSign()/this._getUsableTrackLength()}_scrollValueToHandlePosition(e){return e*this._getSign()*this._getUsableTrackLength()}_getUsableTrackLength(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)}_getTrackLength(){return this.entity.element?0===this.orientation?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0}_getHandleLength(){return this._getTrackLength()*this.handleSize}_getHandlePosition(){return this._scrollValueToHandlePosition(this.value)}_getSign(){return 0===this.orientation?1:-1}_getAxis(){return 0===this.orientation?"x":"y"}_getDimension(){return 0===this.orientation?"width":"height"}_getOppositeDimension(){return 0===this.orientation?"height":"width"}_destroyDragHelper(){this._handleDragHelper&&this._handleDragHelper.destroy();}_setHandleDraggingEnabled(e){this._handleDragHelper&&(this._handleDragHelper.enabled=e);}onEnable(){this._setHandleDraggingEnabled(true);}onDisable(){this._setHandleDraggingEnabled(false);}onRemove(){this._destroyDragHelper(),this._toggleLifecycleListeners("off");}resolveDuplicatedEntityReferenceProperties(e,t){e.handleEntity&&(this.handleEntity=t[e.handleEntity.getGuid()]);}constructor(e,t){super(e,t),this._handleEntity=null,this._evtHandleEntityElementAdd=null,this._evtHandleEntityChanges=[],this._toggleLifecycleListeners("on");}}gR.EVENT_SETVALUE="set:value";class gL{constructor(){this.enabled=true,this.orientation=0,this.value=0,this.handleSize=0,this.handleEntity=null;}}let gM=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"}];class gO extends f8{initializeComponentData(e,t,i){super.initializeComponentData(e,t,gM),e.handleEntity=t.handleEntity;}_onAddComponent(e){e.fire("scrollbar:add");}_onRemoveComponent(e,t){t.onRemove();}constructor(e){super(e),this.id="scrollbar",this.ComponentType=gR,this.DataType=gL,this.schema=gM,this.on("add",this._onAddComponent,this),this.on("beforeremove",this._onRemoveComponent,this);}}let gF={volume:0,pitch:0,loop:false,startTime:0,duration:0,position:new ed,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null};class gN extends X{play(){if(this.overlap||this.stop(),!this.isLoaded&&!this._hasAsset())return;let e=this._createInstance();if(this.instances.push(e),this.isLoaded)e.play();else {let t=function(t){let i=e._playWhenLoaded;e.sound=t,i&&e.play();};this.off("load",t),this.once("load",t),this.load();}return e}pause(){let e=false,t=this.instances;for(let i=0,s=t.length;i<s;i++)t[i].pause()&&(e=true);return e}resume(){let e=false,t=this.instances;for(let i=0,s=t.length;i<s;i++)t[i].resume()&&(e=true);return e}stop(){let e=false,t=this.instances,i=t.length;for(;i--;)t[i].stop(),e=true;return t.length=0,e}load(){if(!this._hasAsset())return;let e=this._assets.get(this._asset);if(!e){this._assets.off(`add:${this._asset}`,this._onAssetAdd,this),this._assets.once(`add:${this._asset}`,this._onAssetAdd,this);return}if(e.off("remove",this._onAssetRemoved,this),e.on("remove",this._onAssetRemoved,this),!e.resource){e.off("load",this._onAssetLoad,this),e.once("load",this._onAssetLoad,this),this._assets.load(e);return}this.fire("load",e.resource);}setExternalNodes(e,t){if(e&&(t||(t=e),this._firstNode=e,this._lastNode=t,!this._overlap)){let i=this.instances;for(let s=0,r=i.length;s<r;s++)i[s].setExternalNodes(e,t);}}clearExternalNodes(){if(this._firstNode=null,this._lastNode=null,!this._overlap){let e=this.instances;for(let t=0,i=e.length;t<i;t++)e[t].clearExternalNodes();}}getExternalNodes(){return [this._firstNode,this._lastNode]}_hasAsset(){return null!=this._asset}_createInstance(){let e=null,t=this._component,i=null;if(this._hasAsset()){let e=this._assets.get(this._asset);e&&(i=e.resource);}return gF.volume=this._volume*t.volume,gF.pitch=this._pitch*t.pitch,gF.loop=this._loop,gF.startTime=this._startTime,gF.duration=this._duration,gF.onPlay=this._onInstancePlayHandler,gF.onPause=this._onInstancePauseHandler,gF.onResume=this._onInstanceResumeHandler,gF.onStop=this._onInstanceStopHandler,gF.onEnd=this._onInstanceEndHandler,t.positional?(gF.position.copy(t.entity.getPosition()),gF.maxDistance=t.maxDistance,gF.refDistance=t.refDistance,gF.rollOffFactor=t.rollOffFactor,gF.distanceModel=t.distanceModel,e=new a5(this._manager,i,gF)):e=new a4(this._manager,i,gF),this._firstNode&&e.setExternalNodes(this._firstNode,this._lastNode),e}_onInstancePlay(e){this.fire("play",e),this._component.fire("play",this,e);}_onInstancePause(e){this.fire("pause",e),this._component.fire("pause",this,e);}_onInstanceResume(e){this.fire("resume",e),this._component.fire("resume",this,e);}_onInstanceStop(e){let t=this.instances.indexOf(e);-1!==t&&this.instances.splice(t,1),this.fire("stop",e),this._component.fire("stop",this,e);}_onInstanceEnd(e){let t=this.instances.indexOf(e);-1!==t&&this.instances.splice(t,1),this.fire("end",e),this._component.fire("end",this,e);}_onAssetAdd(e){this.load();}_onAssetLoad(e){this.load();}_onAssetRemoved(e){e.off("remove",this._onAssetRemoved,this),this._assets.off(`add:${e.id}`,this._onAssetAdd,this),this.stop();}updatePosition(e){let t=this.instances;for(let i=0,s=t.length;i<s;i++)t[i].position=e;}set asset(e){let t=this._asset;if(t){this._assets.off(`add:${t}`,this._onAssetAdd,this);let e=this._assets.get(t);e&&e.off("remove",this._onAssetRemoved,this);}this._asset=e,this._asset instanceof fy&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load();}get asset(){return this._asset}set autoPlay(e){this._autoPlay=!!e;}get autoPlay(){return this._autoPlay}set duration(e){if(this._duration=Math.max(0,Number(e)||0)||null,!this._overlap){let e=this.instances;for(let t=0,i=e.length;t<i;t++)e[t].duration=this._duration;}}get duration(){let e=0;if(this._hasAsset()){let t=this._assets.get(this._asset);e=t?.resource?t.resource.duration:0;}return null!=this._duration?this._duration%(e||1):e}get isLoaded(){if(this._hasAsset()){let e=this._assets.get(this._asset);if(e)return !!e.resource}return  false}get isPaused(){let e=this.instances,t=e.length;if(0===t)return  false;for(let i=0;i<t;i++)if(!e[i].isPaused)return  false;return  true}get isPlaying(){let e=this.instances;for(let t=0,i=e.length;t<i;t++)if(e[t].isPlaying)return  true;return  false}get isStopped(){let e=this.instances;for(let t=0,i=e.length;t<i;t++)if(!e[t].isStopped)return  false;return  true}set loop(e){this._loop=!!e;let t=this.instances;for(let e=0,i=t.length;e<i;e++)t[e].loop=this._loop;}get loop(){return this._loop}set overlap(e){this._overlap=!!e;}get overlap(){return this._overlap}set pitch(e){if(this._pitch=Math.max(Number(e)||0,.01),!this._overlap){let e=this.instances;for(let t=0,i=e.length;t<i;t++)e[t].pitch=this.pitch*this._component.pitch;}}get pitch(){return this._pitch}set startTime(e){if(this._startTime=Math.max(0,Number(e)||0),!this._overlap){let e=this.instances;for(let t=0,i=e.length;t<i;t++)e[t].startTime=this._startTime;}}get startTime(){return this._startTime}set volume(e){if(this._volume=ei.clamp(Number(e)||0,0,1),!this._overlap){let e=this.instances;for(let t=0,i=e.length;t<i;t++)e[t].volume=this._volume*this._component.volume;}}get volume(){return this._volume}constructor(e,t="Untitled",i={}){super(),this.instances=[],this._component=e,this._assets=e.system.app.assets,this._manager=e.system.manager,this.name=t,this._volume=void 0!==i.volume?ei.clamp(Number(i.volume)||0,0,1):1,this._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,this._loop=!!(void 0!==i.loop&&i.loop),this._duration=i.duration>0?i.duration:null,this._startTime=Math.max(0,Number(i.startTime)||0),this._overlap=!!i.overlap,this._autoPlay=!!i.autoPlay,this._firstNode=null,this._lastNode=null,this._asset=i.asset,this._asset instanceof fy&&(this._asset=this._asset.id),this._onInstancePlayHandler=this._onInstancePlay.bind(this),this._onInstancePauseHandler=this._onInstancePause.bind(this),this._onInstanceResumeHandler=this._onInstanceResume.bind(this),this._onInstanceStopHandler=this._onInstanceStop.bind(this),this._onInstanceEndHandler=this._onInstanceEnd.bind(this);}}gN.EVENT_PLAY="play",gN.EVENT_PAUSE="pause",gN.EVENT_RESUME="resume",gN.EVENT_STOP="stop",gN.EVENT_END="end",gN.EVENT_LOAD="load";class gB extends f5{_updateSoundInstances(e,t,i){let s=this._slots;for(let r in s){let a=s[r];if(!a.overlap){let s=a.instances;for(let r=0,n=s.length;r<n;r++)s[r][e]=i?a[e]*t:t;}}}set distanceModel(e){this._distanceModel=e,this._updateSoundInstances("distanceModel",e,false);}get distanceModel(){return this._distanceModel}set maxDistance(e){this._maxDistance=e,this._updateSoundInstances("maxDistance",e,false);}get maxDistance(){return this._maxDistance}set refDistance(e){this._refDistance=e,this._updateSoundInstances("refDistance",e,false);}get refDistance(){return this._refDistance}set rollOffFactor(e){this._rollOffFactor=e,this._updateSoundInstances("rollOffFactor",e,false);}get rollOffFactor(){return this._rollOffFactor}set pitch(e){this._pitch=e,this._updateSoundInstances("pitch",e,true);}get pitch(){return this._pitch}set volume(e){this._volume=e,this._updateSoundInstances("volume",e,true);}get volume(){return this._volume}set positional(e){this._positional=e;let t=this._slots;for(let e in t){let i=t[e];if(!i.overlap){let e=i.instances,t=e.length;for(let s=t-1;s>=0;s--){let t=e[s].isPlaying||e[s].isSuspended,r=e[s].currentTime;t&&e[s].stop();let a=i._createInstance();t&&(a.play(),a.currentTime=r),e.push(a);}}}}get positional(){return this._positional}set slots(e){let t=this._slots;if(t)for(let e in t)t[e].stop();let i={};for(let t in e)e[t]instanceof gN?i[e[t].name]=e[t]:e[t].name&&(i[e[t].name]=new gN(this,e[t].name,e[t]));this._slots=i,this.enabled&&this.entity.enabled&&this.onEnable();}get slots(){return this._slots}onEnable(){if(this.system._inTools)return;let e=this._slots,t=this._playingBeforeDisable;for(let i in e){let s=e[i];s.autoPlay&&s.isStopped?s.play():t[i]?s.resume():s.isLoaded||s.load();}}onDisable(){let e=this._slots,t={};for(let i in e)!e[i].overlap&&e[i].isPlaying&&(e[i].pause(),t[i]=true);this._playingBeforeDisable=t;}onRemove(){this.off();}addSlot(e,t){let i=this._slots;if(i[e])return null;let s=new gN(this,e,t);return i[e]=s,s.autoPlay&&this.enabled&&this.entity.enabled&&s.play(),s}removeSlot(e){let t=this._slots;t[e]&&(t[e].stop(),delete t[e]);}slot(e){return this._slots[e]}_getSlotProperty(e,t){if(!this.enabled||!this.entity.enabled)return;let i=this._slots[e];if(i)return i[t]}isPlaying(e){return this._getSlotProperty(e,"isPlaying")||false}isLoaded(e){return this._getSlotProperty(e,"isLoaded")||false}isPaused(e){return this._getSlotProperty(e,"isPaused")||false}isStopped(e){return this._getSlotProperty(e,"isStopped")||false}play(e){if(!this.enabled||!this.entity.enabled)return null;let t=this._slots[e];return t?t.play():null}pause(e){let t=this._slots;if(e){let i=t[e];if(!i)return;i.pause();}else for(let e in t)t[e].pause();}resume(e){let t=this._slots;if(e){let i=t[e];if(!i)return;i.isPaused&&i.resume();}else for(let e in t)t[e].resume();}stop(e){let t=this._slots;if(e){let i=t[e];if(!i)return;i.stop();}else for(let e in t)t[e].stop();}constructor(...e){super(...e),this._volume=1,this._pitch=1,this._positional=true,this._refDistance=1,this._maxDistance=1e4,this._rollOffFactor=1,this._distanceModel=aj,this._slots={},this._playingBeforeDisable={};}}gB.EVENT_PLAY="play",gB.EVENT_PAUSE="pause",gB.EVENT_RESUME="resume",gB.EVENT_STOP="stop",gB.EVENT_END="end";class gk{constructor(){this.enabled=true;}}let gU=["enabled"];class gz extends f8{set volume(e){this.manager.volume=e;}get volume(){return this.manager.volume}get context(){return a3()?this.manager.context:null}initializeComponentData(e,t,i){i=["volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots"];for(let s=0;s<i.length;s++)t.hasOwnProperty(i[s])&&(e[i[s]]=t[i[s]]);super.initializeComponentData(e,t,["enabled"]);}cloneComponent(e,t){let i=e.sound,s=i.slots,r={};for(let e in s){let t=s[e];r[e]={name:t.name,volume:t.volume,pitch:t.pitch,loop:t.loop,duration:t.duration,startTime:t.startTime,overlap:t.overlap,autoPlay:t.autoPlay,asset:t.asset};}let a={distanceModel:i.distanceModel,enabled:i.enabled,maxDistance:i.maxDistance,pitch:i.pitch,positional:i.positional,refDistance:i.refDistance,rollOffFactor:i.rollOffFactor,slots:r,volume:i.volume};return this.addComponent(t,a)}onUpdate(e){let t=this.store;for(let e in t)if(t.hasOwnProperty(e)){let i=t[e].entity;if(i.enabled){let e=i.sound;if(e.enabled&&e.positional){let t=i.getPosition(),s=e.slots;for(let e in s)s[e].updatePosition(t);}}}}onBeforeRemove(e,t){let i=t.slots;for(let e in i)i[e].overlap||i[e].stop();t.onRemove();}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this);}constructor(e){super(e),this.id="sound",this.ComponentType=gB,this.DataType=gk,this.schema=gU,this.manager=e.soundManager,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this);}}f5._buildAccessors(gB.prototype,gU);let gV="simple",gG="animated";class gH extends X{get duration(){if(this._sprite){let e=this.fps||5e-324;return this._sprite.frameKeys.length/Math.abs(e)}return 0}set frame(e){this._setFrame(e);let t=this.fps||5e-324;this._setTime(this._frame/t);}get frame(){return this._frame}get isPaused(){return this._paused}get isPlaying(){return this._playing}set sprite(e){if(this._sprite&&(this._evtSetMeshes?.off(),this._evtSetMeshes=null,this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this)),this._sprite=e,this._sprite&&(this._evtSetMeshes=this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this)),this._component.currentClip===this){let t;e&&e.atlas?(e.atlas.texture&&((t=this._component._meshInstance)&&(t.setParameter("texture_emissiveMap",e.atlas.texture),t.setParameter("texture_opacityMap",e.atlas.texture)),this._component.enabled&&this._component.entity.enabled&&this._component._showModel()),this.time&&this.fps?this.time=this.time:this.frame=this.frame):((t=this._component._meshInstance)&&(t.deleteParameter("texture_emissiveMap"),t.deleteParameter("texture_opacityMap")),this._component._hideModel());}}get sprite(){return this._sprite}set spriteAsset(e){let t=this._component.system.app.assets,i=e;if(e instanceof fy&&(i=e.id),this._spriteAsset!==i){if(this._spriteAsset){let e=t.get(this._spriteAsset);e&&this._unbindSpriteAsset(e);}if(this._spriteAsset=i,this._spriteAsset){let e=t.get(this._spriteAsset);e?this._bindSpriteAsset(e):(this.sprite=null,t.on(`add:${this._spriteAsset}`,this._onSpriteAssetAdded,this));}else this.sprite=null;}}get spriteAsset(){return this._spriteAsset}set time(e){this._setTime(e),this._sprite?this.frame=Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):this.frame=0;}get time(){return this._time}_onSpriteAssetAdded(e){this._component.system.app.assets.off(`add:${e.id}`,this._onSpriteAssetAdded,this),this._spriteAsset===e.id&&this._bindSpriteAsset(e);}_bindSpriteAsset(e){e.on("load",this._onSpriteAssetLoad,this),e.on("remove",this._onSpriteAssetRemove,this),e.resource?this._onSpriteAssetLoad(e):this._component.system.app.assets.load(e);}_unbindSpriteAsset(e){e&&(e.off("load",this._onSpriteAssetLoad,this),e.off("remove",this._onSpriteAssetRemove,this),e.resource&&!e.resource.atlas&&this._component.system.app.assets.off(`load:${e.data.textureAtlasAsset}`,this._onTextureAtlasLoad,this));}_onSpriteAssetLoad(e){if(e.resource)if(e.resource.atlas)this.sprite=e.resource;else {let t=e.data.textureAtlasAsset,i=this._component.system.app.assets;i.off(`load:${t}`,this._onTextureAtlasLoad,this),i.once(`load:${t}`,this._onTextureAtlasLoad,this);}else this.sprite=null;}_onTextureAtlasLoad(e){let t=this._spriteAsset;t instanceof fy?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._component.system.app.assets.get(t));}_onSpriteAssetRemove(e){this.sprite=null;}_onSpriteMeshesChange(){this._component.currentClip===this&&this._component._showFrame(this.frame);}_onSpritePpuChanged(){this._component.currentClip===this&&0!==this.sprite.renderMode&&this._component._showFrame(this.frame);}_update(e){if(0===this.fps||!this._playing||this._paused||!this._sprite)return;let t=this.fps<0?-1:1,i=this._time+e*this._component.speed*t,s=this.duration,r=i>s||i<0;this._setTime(i);let a=this.frame;(a=this._sprite?Math.floor(this._sprite.frameKeys.length*this._time/s):0)!==this._frame&&this._setFrame(a),r&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._playing=false,this._paused=false,this.fire("end"),this._component.fire("end",this)));}_setTime(e){this._time=e;let t=this.duration;this._time<0?this.loop?this._time=this._time%t+t:this._time=0:this._time>t&&(this.loop?this._time%=t:this._time=t);}_setFrame(e){this._sprite?this._frame=ei.clamp(e,0,this._sprite.frameKeys.length-1):this._frame=e,this._component.currentClip===this&&this._component._showFrame(this._frame);}_destroy(){if(this._spriteAsset){let e=this._component.system.app.assets;this._unbindSpriteAsset(e.get(this._spriteAsset));}this._sprite&&(this.sprite=null),this._spriteAsset&&(this.spriteAsset=null);}play(){this._playing||(this._playing=true,this._paused=false,this.frame=0,this.fire("play"),this._component.fire("play",this));}pause(){this._playing&&!this._paused&&(this._paused=true,this.fire("pause"),this._component.fire("pause",this));}resume(){this._paused&&(this._paused=false,this.fire("resume"),this._component.fire("resume",this));}stop(){this._playing&&(this._playing=false,this._paused=false,this._time=0,this.frame=0,this.fire("stop"),this._component.fire("stop",this));}constructor(e,t){super(),this._evtSetMeshes=null,this._component=e,this._frame=0,this._sprite=null,this._spriteAsset=null,this.spriteAsset=t.spriteAsset,this.name=t.name,this.fps=t.fps||0,this.loop=t.loop||false,this._playing=false,this._paused=false,this._time=0;}}gH.EVENT_PLAY="play",gH.EVENT_PAUSE="pause",gH.EVENT_RESUME="resume",gH.EVENT_STOP="stop",gH.EVENT_END="end",gH.EVENT_LOOP="loop";let gW="texture_emissiveMap",gX="texture_opacityMap",gY="material_emissive",gq="material_opacity";class g$ extends f5{set type(e){this._type!==e&&(this._type=e,this._type===gV?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):this._type===gG&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()));}get type(){return this._type}set frame(e){this._currentClip.frame=e;}get frame(){return this._currentClip.frame}set spriteAsset(e){this._defaultClip.spriteAsset=e;}get spriteAsset(){return this._defaultClip._spriteAsset}set sprite(e){this._currentClip.sprite=e;}get sprite(){return this._currentClip.sprite}set material(e){this._material=e,this._meshInstance&&(this._meshInstance.material=e);}get material(){return this._material}set color(e){this._color.r=e.r,this._color.g=e.g,this._color.b=e.b,this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(gY,this._colorUniform));}get color(){return this._color}set opacity(e){this._color.a=e,this._meshInstance&&this._meshInstance.setParameter(gq,e);}get opacity(){return this._color.a}set clips(e){if(!e){for(let e in this._clips)this.removeClip(e);return}for(let t in this._clips){let i=false;for(let s in e)if(e[s].name===t){i=true,this._clips[t].fps=e[s].fps,this._clips[t].loop=e[s].loop,e[s].hasOwnProperty("sprite")?this._clips[t].sprite=e[s].sprite:e[s].hasOwnProperty("spriteAsset")&&(this._clips[t].spriteAsset=e[s].spriteAsset);break}i||this.removeClip(t);}for(let t in e)this._clips[e[t].name]||this.addClip(e[t]);this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.sprite||this._hideModel();}get clips(){return this._clips}get currentClip(){return this._currentClip}set speed(e){this._speed=e;}get speed(){return this._speed}set flipX(e){this._flipX!==e&&(this._flipX=e,this._updateTransform());}get flipX(){return this._flipX}set flipY(e){this._flipY!==e&&(this._flipY=e,this._updateTransform());}get flipY(){return this._flipY}set width(e){e!==this._width&&(this._width=e,this._outerScale.x=this._width,this.sprite&&(2===this.sprite.renderMode||1===this.sprite.renderMode)&&this._updateTransform());}get width(){return this._width}set height(e){e!==this._height&&(this._height=e,this._outerScale.y=this.height,this.sprite&&(2===this.sprite.renderMode||1===this.sprite.renderMode)&&this._updateTransform());}get height(){return this._height}set batchGroupId(e){if(this._batchGroupId===e)return;let t=this._batchGroupId;this._batchGroupId=e,this.entity.enabled&&t>=0&&this.system.app.batcher?.remove(n2.SPRITE,t,this.entity),this.entity.enabled&&e>=0?this.system.app.batcher?.insert(n2.SPRITE,e,this.entity):t>=0&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel();}get batchGroupId(){return this._batchGroupId}set autoPlayClip(e){this._autoPlayClip=e instanceof gH?e.name:e,this._tryAutoPlay();}get autoPlayClip(){return this._autoPlayClip}set drawOrder(e){this._drawOrder=e,this._meshInstance&&(this._meshInstance.drawOrder=e);}get drawOrder(){return this._drawOrder}set layers(e){this._addedModel&&this._hideModel(),this._layers=e,this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel();}get layers(){return this._layers}get aabb(){return this._meshInstance?this._meshInstance.aabb:null}onEnable(){let e=this.system.app,t=e.scene,i=t.layers;this._evtLayersChanged=t.on("set:layers",this._onLayersChanged,this),i&&(this._evtLayerAdded=i.on("add",this._onLayerAdded,this),this._evtLayerRemoved=i.on("remove",this._onLayerRemoved,this)),this._showModel(),this._autoPlayClip&&this._tryAutoPlay(),this._batchGroupId>=0&&e.batcher?.insert(n2.SPRITE,this._batchGroupId,this.entity);}onDisable(){let e=this.system.app,t=e.scene.layers;this._evtLayersChanged?.off(),this._evtLayersChanged=null,t&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this.stop(),this._hideModel(),this._batchGroupId>=0&&e.batcher?.remove(n2.SPRITE,this._batchGroupId,this.entity);}onDestroy(){for(let e in this._currentClip=null,this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null),this._clips)this._clips[e]._destroy();this._clips=null,this._hideModel(),this._model=null,this._node?.remove(),this._node=null,this._meshInstance&&(this._meshInstance.material=null,this._meshInstance.mesh=null,this._meshInstance=null);}_showModel(){if(this._addedModel||!this._meshInstance)return;let e=[this._meshInstance];for(let t=0,i=this._layers.length;t<i;t++){let i=this.system.app.scene.layers.getLayerById(this._layers[t]);i&&i.addMeshInstances(e);}this._addedModel=true;}_hideModel(){if(!this._addedModel||!this._meshInstance)return;let e=[this._meshInstance];for(let t=0,i=this._layers.length;t<i;t++){let i=this.system.app.scene.layers.getLayerById(this._layers[t]);i&&i.removeMeshInstances(e);}this._addedModel=false;}_showFrame(e){let t;if(!this.sprite)return;let i=this.sprite.meshes[e];if(!i){this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=false);return}if(t=1===this.sprite.renderMode?this.system.default9SlicedMaterialSlicedMode:2===this.sprite.renderMode?this.system.default9SlicedMaterialTiledMode:this.system.defaultMaterial,!this._meshInstance&&(this._meshInstance=new od(i,this._material,this._node),this._meshInstance.castShadow=false,this._meshInstance.receiveShadow=false,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(gY,this._colorUniform),this._meshInstance.setParameter(gq,this._color.a),this.enabled&&this.entity.enabled&&this._showModel()),this._meshInstance.material!==t&&(this._meshInstance.material=t),this._meshInstance.mesh!==i&&(this._meshInstance.mesh=i,this._meshInstance.visible=true,this._meshInstance._aabbVer=-1),this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter(gW,this.sprite.atlas.texture),this._meshInstance.setParameter(gX,this.sprite.atlas.texture)):(this._meshInstance.deleteParameter(gW),this._meshInstance.deleteParameter(gX)),this.sprite.atlas&&(1===this.sprite.renderMode||2===this.sprite.renderMode)){this._meshInstance._updateAabbFunc=this._updateAabbFunc;let t=this.sprite.atlas.frames[this.sprite.frameKeys[e]];if(t){let e=2/t.rect.z,i=2/t.rect.w;this._innerOffset.set(t.border.x*e,t.border.y*i,t.border.z*e,t.border.w*i);let s=this.sprite.atlas.texture;this._atlasRect.set(t.rect.x/s.width,t.rect.y/s.height,t.rect.z/s.width,t.rect.w/s.height);}else this._innerOffset.set(0,0,0,0);this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter("atlasRect",this._atlasRectUniform);}else this._meshInstance._updateAabbFunc=null;this._updateTransform();}_updateTransform(){let e=this.flipX?-1:1,t=this.flipY?-1:1,i=0,s=0;if(this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)){let r=1,a=1;if(this.sprite.atlas){let e=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];e&&(r=e.rect.z,a=e.rect.w,i=(.5-e.pivot.x)*this._width,s=(.5-e.pivot.y)*this._height);}let n=r/this.sprite.pixelsPerUnit,o=a/this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*n),Math.max(this._height,this._innerOffset.y*o)),e*=n,t*=o,this._outerScale.x/=n,this._outerScale.y/=o,e*=ei.clamp(this._width/(this._innerOffset.x*n),1e-4,1),t*=ei.clamp(this._height/(this._innerOffset.y*o),1e-4,1),this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter("outerScale",this._outerScaleUniform));}this._node.setLocalScale(e,t,1),this._node.setLocalPosition(i,s,0);}_updateAabb(e){return e.center.set(0,0,0),e.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),e.setFromTransformedAabb(e,this._node.getWorldTransform()),e}_tryAutoPlay(){if(!this._autoPlayClip||this.type!==gG)return;let e=this._clips[this._autoPlayClip];e&&!e.isPlaying&&(!this._currentClip||!this._currentClip.isPlaying)&&this.enabled&&this.entity.enabled&&this.play(e.name);}_onLayersChanged(e,t){e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this),this.enabled&&this.entity.enabled&&this._showModel();}_onLayerAdded(e){!(0>this.layers.indexOf(e.id))&&this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&e.addMeshInstances([this._meshInstance]);}_onLayerRemoved(e){!this._meshInstance||0>this.layers.indexOf(e.id)||e.removeMeshInstances([this._meshInstance]);}removeModelFromLayers(){for(let e=0;e<this.layers.length;e++){let t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&t.removeMeshInstances([this._meshInstance]);}}addClip(e){let t=new gH(this,{name:e.name,fps:e.fps,loop:e.loop,spriteAsset:e.spriteAsset});return this._clips[e.name]=t,t.name&&t.name===this._autoPlayClip&&this._tryAutoPlay(),t}removeClip(e){delete this._clips[e];}clip(e){return this._clips[e]}play(e){let t=this._clips[e],i=this._currentClip;return i&&i!==t&&(i._playing=false),this._currentClip=t,this._currentClip&&(this._currentClip=t,this._currentClip.play()),t}pause(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause();}resume(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume();}stop(){this._currentClip!==this._defaultClip&&this._currentClip.stop();}constructor(e,t){super(e,t),this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._type=gV,this._material=e.defaultMaterial,this._color=new es(1,1,1,1),this._colorUniform=new Float32Array(3),this._speed=1,this._flipX=false,this._flipY=false,this._width=1,this._height=1,this._drawOrder=0,this._layers=[0],this._outerScale=new ef(1,1),this._outerScaleUniform=new Float32Array(2),this._innerOffset=new ep,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new ep,this._atlasRectUniform=new Float32Array(4),this._batchGroupId=-1,this._batchGroup=null,this._node=new oX,this._model=new hA,this._model.graph=this._node,this._meshInstance=null,t.addChild(this._model.graph),this._model._entity=t,this._updateAabbFunc=this._updateAabb.bind(this),this._addedModel=false,this._autoPlayClip=null,this._clips={},this._defaultClip=new gH(this,{name:this.entity.name,fps:0,loop:false,spriteAsset:null}),this._currentClip=this._defaultClip;}}g$.EVENT_PLAY="play",g$.EVENT_PAUSE="pause",g$.EVENT_RESUME="resume",g$.EVENT_STOP="stop",g$.EVENT_END="end",g$.EVENT_LOOP="loop";class gj{constructor(){this.enabled=true;}}let gK=["enabled"];class gZ extends f8{set defaultMaterial(e){this._defaultMaterial=e;}get defaultMaterial(){if(!this._defaultMaterial){let e=new ih(this.app.graphicsDevice,{width:1,height:1,format:20,name:"sprite"}),t=new Uint8Array(e.lock());t[0]=t[1]=t[2]=t[3]=255,e.unlock();let i=new d0;i.diffuse.set(0,0,0),i.emissive.set(1,1,1),i.emissiveMap=e,i.opacityMap=e,i.opacityMapChannel="a",i.useLighting=false,i.useTonemap=false,i.useFog=false,i.useSkybox=false,i.blendType=4,i.depthWrite=false,i.pixelSnap=false,i.cull=0,i.update(),this._defaultTexture=e,this._defaultMaterial=i;}return this._defaultMaterial}set default9SlicedMaterialSlicedMode(e){this._default9SlicedMaterialSlicedMode=e;}get default9SlicedMaterialSlicedMode(){if(!this._default9SlicedMaterialSlicedMode){let e=this.defaultMaterial.clone();e.nineSlicedMode=1,e.update(),this._default9SlicedMaterialSlicedMode=e;}return this._default9SlicedMaterialSlicedMode}set default9SlicedMaterialTiledMode(e){this._default9SlicedMaterialTiledMode=e;}get default9SlicedMaterialTiledMode(){if(!this._default9SlicedMaterialTiledMode){let e=this.defaultMaterial.clone();e.nineSlicedMode=2,e.update(),this._default9SlicedMaterialTiledMode=e;}return this._default9SlicedMaterialTiledMode}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),this._defaultTexture&&(this._defaultTexture.destroy(),this._defaultTexture=null);}initializeComponentData(e,t,i){if(void 0!==t.enabled&&(e.enabled=t.enabled),e.type=t.type,t.layers&&Array.isArray(t.layers)&&(e.layers=t.layers.slice(0)),void 0!==t.drawOrder&&(e.drawOrder=t.drawOrder),void 0!==t.color&&(t.color instanceof es?e.color.set(t.color.r,t.color.g,t.color.b,t.opacity??1):e.color.set(t.color[0],t.color[1],t.color[2],t.opacity??1),e.color=e.color),void 0!==t.opacity&&(e.opacity=t.opacity),void 0!==t.flipX&&(e.flipX=t.flipX),void 0!==t.flipY&&(e.flipY=t.flipY),void 0!==t.width&&(e.width=t.width),void 0!==t.height&&(e.height=t.height),void 0!==t.spriteAsset&&(e.spriteAsset=t.spriteAsset),t.sprite&&(e.sprite=t.sprite),void 0!==t.frame&&(e.frame=t.frame),t.clips)for(let i in t.clips)e.addClip(t.clips[i]);void 0!==t.speed&&(e.speed=t.speed),t.autoPlayClip&&(e.autoPlayClip=t.autoPlayClip),e.batchGroupId=void 0===t.batchGroupId||null===t.batchGroupId?-1:t.batchGroupId,super.initializeComponentData(e,t,i);}cloneComponent(e,t){let i=e.sprite;return this.addComponent(t,{enabled:i.enabled,type:i.type,spriteAsset:i.spriteAsset,sprite:i.sprite,width:i.width,height:i.height,frame:i.frame,color:i.color.clone(),opacity:i.opacity,flipX:i.flipX,flipY:i.flipY,speed:i.speed,clips:i.clips,autoPlayClip:i.autoPlayClip,batchGroupId:i.batchGroupId,drawOrder:i.drawOrder,layers:i.layers.slice(0)})}onUpdate(e){let t=this.store;for(let i in t)if(t.hasOwnProperty(i)){let s=t[i];if(s.data.enabled&&s.entity.enabled){let t=s.entity.sprite;t._currentClip&&t._currentClip._update(e);}}}onBeforeRemove(e,t){t.onDestroy();}constructor(e){super(e),this.id="sprite",this.ComponentType=g$,this.DataType=gj,this.schema=gK,this._defaultTexture=null,this._defaultMaterial=null,this._default9SlicedMaterialSlicedMode=null,this._default9SlicedMaterialTiledMode=null,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this);}}f5._buildAccessors(g$.prototype,gK);class gQ extends f5{set size(e){e instanceof ed?this._size.copy(e):e instanceof Array&&e.length>=3&&this.size.set(e[0],e[1],e[2]);}get size(){return this._size}onEnable(){this._checkState();}onDisable(){this._checkState();}_onSetEnabled(e,t,i){this._checkState();}_checkState(){let e=this.enabled&&this.entity.enabled;e!==this._oldState&&(this._oldState=e,this.fire("enable"),this.fire("state",this.enabled));}_onBeforeRemove(){this.fire("remove");}constructor(e,t){super(e,t),this._oldState=true,this._size=new ed,this.on("set_enabled",this._onSetEnabled,this);}}gQ.EVENT_ENABLE="enable",gQ.EVENT_DISABLE="disable",gQ.EVENT_STATE="state",gQ.EVENT_REMOVE="remove";class gJ{constructor(){this.enabled=true;}}let g0=["enabled"];class g1 extends f8{initializeComponentData(e,t,i){e.enabled=!t.hasOwnProperty("enabled")||!!t.enabled,t.size&&(t.size instanceof ed?e.size.copy(t.size):t.size instanceof Array&&t.size.length>=3&&e.size.set(t.size[0],t.size[1],t.size[2]));}cloneComponent(e,t){let i={enabled:e.zone.enabled,size:e.zone.size};return this.addComponent(t,i)}_onBeforeRemove(e,t){t._onBeforeRemove();}constructor(e){super(e),this.id="zone",this.ComponentType=gQ,this.DataType=gJ,this.schema=g0,this.on("beforeremove",this._onBeforeRemove,this);}}f5._buildAccessors(gQ.prototype,g0);class g2{constructor(e,t){this.effect=e,this.inputTarget=t,this.outputTarget=null,this.name=e.constructor.name;}}class g3{_allocateColorBuffer(e,t){let i=this.camera.rect,s=this.destinationRenderTarget,r=this.app.graphicsDevice,a=Math.floor(i.z*(s?.width??r.width)),n=Math.floor(i.w*(s?.height??r.height));return new ih(r,{name:t,format:e,width:a,height:n,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1})}_createOffscreenTarget(e,t){let i=this.app.graphicsDevice,s=(this.destinationRenderTarget??i.backBuffer).isColorBufferSrgb(0),r=(t&&i.getRenderableHdrFormat([12,14],true))??(s?20:7),a=`${this.camera.entity.name}-posteffect-${this.effects.length}`;return new iU({colorBuffer:this._allocateColorBuffer(r,a),depth:e,stencil:e&&this.app.graphicsDevice.supportsStencil,samples:e?i.samples:1})}_resizeOffscreenTarget(e){let t=e.colorBuffer.format,i=e.colorBuffer.name;e.destroyFrameBuffers(),e.destroyTextureBuffers(),e._colorBuffer=this._allocateColorBuffer(t,i),e._colorBuffers=[e._colorBuffer],e.evaluateDimensions();}_destroyOffscreenTarget(e){e.destroyTextureBuffers(),e.destroy();}addEffect(e){let t=this.effects,i=0===t.length,s=this._createOffscreenTarget(i,e.hdr),r=new g2(e,s);t.push(r),this._sourceTarget=r.inputTarget,t.length>1&&(t[t.length-2].outputTarget=r.inputTarget),this._newPostEffect=e,e.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0;}removeEffect(e){let t=-1;for(let i=0,s=this.effects.length;i<s;i++)if(this.effects[i].effect===e){t=i;break}t>=0&&(t>0?this.effects[t-1].outputTarget=t+1<this.effects.length?this.effects[t+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(true,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[t].inputTarget),this.effects.splice(t,1)),this.enabled&&e.needsDepthBuffer&&this._releaseDepthMap(),0===this.effects.length&&this.disable();}_requestDepthMaps(){for(let e=0,t=this.effects.length;e<t;e++){let t=this.effects[e].effect;this._newPostEffect!==t&&t.needsDepthBuffer&&this._requestDepthMap();}}_releaseDepthMaps(){for(let e=0,t=this.effects.length;e<t;e++)this.effects[e].effect.needsDepthBuffer&&this._releaseDepthMap();}_requestDepthMap(){let e=this.app.scene.layers.getLayerById(1);e&&(e.incrementCounter(),this.camera.requestSceneDepthMap(true));}_releaseDepthMap(){let e=this.app.scene.layers.getLayerById(1);e&&(e.decrementCounter(),this.camera.requestSceneDepthMap(false));}destroy(){for(let e=0,t=this.effects.length;e<t;e++)this.effects[e].inputTarget.destroy();this.effects.length=0,this.disable();}enable(){!this.enabled&&this.effects.length&&(this.enabled=true,this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=()=>{if(this.enabled){let e=null,t=this.effects.length;if(t)for(let i=0;i<t;i++){let s=this.effects[i],r=s.outputTarget;i===t-1&&(e=this.camera.rect,this.destinationRenderTarget&&(r=this.destinationRenderTarget)),s.effect.render(s.inputTarget,r,e);}}});}disable(){this.enabled&&(this.enabled=false,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=this.destinationRenderTarget,this.camera.onPostprocessing=null);}_onCanvasResized(e,t){let i=this.camera.rect,s=this.destinationRenderTarget;e=s?.width??e,t=s?.height??t,this.camera.camera.aspectRatio=e*i.z/(t*i.w),this.resizeRenderTargets();}resizeRenderTargets(){let e=this.app.graphicsDevice,t=this.destinationRenderTarget,i=t?.width??e.width,s=t?.height??e.height,r=this.camera.rect,a=Math.floor(r.z*i),n=Math.floor(r.w*s),o=this.effects;for(let e=0,t=o.length;e<t;e++){let t=o[e];(t.inputTarget.width!==a||t.inputTarget.height!==n)&&this._resizeOffscreenTarget(t.inputTarget);}}onCameraRectChanged(e,t,i){this.enabled&&this.resizeRenderTargets();}constructor(e,t){this.app=e,this.camera=t,this.destinationRenderTarget=null,this.effects=[],this.enabled=false,this.depthTarget=null,t.on("set:rect",this.onCameraRectChanged,this);}}class g4 extends f5{setShaderPass(e){let t=nz.get(this.system.app.graphicsDevice),i=e?t.allocate(e,{isForward:true}):null;return this._camera.shaderPassInfo=i,i.index}getShaderPass(){return this._camera.shaderPassInfo?.name}set renderPasses(e){this._camera.renderPasses=e||[],this.dirtyLayerCompositionCameras(),this.system.app.scene.updateShaders=true;}get renderPasses(){return this._camera.renderPasses}get shaderParams(){return this._camera.shaderParams}set gammaCorrection(e){this.camera.shaderParams.gammaCorrection=e;}get gammaCorrection(){return this.camera.shaderParams.gammaCorrection}set toneMapping(e){this.camera.shaderParams.toneMapping=e;}get toneMapping(){return this.camera.shaderParams.toneMapping}set fog(e){this._camera.fogParams=e;}get fog(){return this._camera.fogParams}set aperture(e){this._camera.aperture=e;}get aperture(){return this._camera.aperture}set aspectRatio(e){this._camera.aspectRatio=e;}get aspectRatio(){return this._camera.aspectRatio}set aspectRatioMode(e){this._camera.aspectRatioMode=e;}get aspectRatioMode(){return this._camera.aspectRatioMode}set calculateProjection(e){this._camera.calculateProjection=e;}get calculateProjection(){return this._camera.calculateProjection}set calculateTransform(e){this._camera.calculateTransform=e;}get calculateTransform(){return this._camera.calculateTransform}get camera(){return this._camera}set clearColor(e){this._camera.clearColor=e;}get clearColor(){return this._camera.clearColor}set clearColorBuffer(e){this._camera.clearColorBuffer=e,this.dirtyLayerCompositionCameras();}get clearColorBuffer(){return this._camera.clearColorBuffer}set clearDepth(e){this._camera.clearDepth=e;}get clearDepth(){return this._camera.clearDepth}set clearDepthBuffer(e){this._camera.clearDepthBuffer=e,this.dirtyLayerCompositionCameras();}get clearDepthBuffer(){return this._camera.clearDepthBuffer}set clearStencilBuffer(e){this._camera.clearStencilBuffer=e,this.dirtyLayerCompositionCameras();}get clearStencilBuffer(){return this._camera.clearStencilBuffer}set cullFaces(e){this._camera.cullFaces=e;}get cullFaces(){return this._camera.cullFaces}set disablePostEffectsLayer(e){this._disablePostEffectsLayer=e,this.dirtyLayerCompositionCameras();}get disablePostEffectsLayer(){return this._disablePostEffectsLayer}set farClip(e){this._camera.farClip=e;}get farClip(){return this._camera.farClip}set flipFaces(e){this._camera.flipFaces=e;}get flipFaces(){return this._camera.flipFaces}set fov(e){this._camera.fov=e;}get fov(){return this._camera.fov}get frustum(){return this._camera.frustum}set frustumCulling(e){this._camera.frustumCulling=e;}get frustumCulling(){return this._camera.frustumCulling}set horizontalFov(e){this._camera.horizontalFov=e;}get horizontalFov(){return this._camera.horizontalFov}set layers(e){let t=this._camera.layers,i=this.system.app.scene;t.forEach(e=>{let t=i.layers.getLayerById(e);t?.removeCamera(this);}),this._camera.layers=e,this.enabled&&this.entity.enabled&&e.forEach(e=>{let t=i.layers.getLayerById(e);t?.addCamera(this);}),this.fire("set:layers");}get layers(){return this._camera.layers}get layersSet(){return this._camera.layersSet}set jitter(e){this._camera.jitter=e;}get jitter(){return this._camera.jitter}set nearClip(e){this._camera.nearClip=e;}get nearClip(){return this._camera.nearClip}set orthoHeight(e){this._camera.orthoHeight=e;}get orthoHeight(){return this._camera.orthoHeight}get postEffects(){return this._postEffects}get postEffectsEnabled(){return this._postEffects.enabled}set priority(e){this._priority=e,this.dirtyLayerCompositionCameras();}get priority(){return this._priority}set projection(e){this._camera.projection=e;}get projection(){return this._camera.projection}get projectionMatrix(){return this._camera.projectionMatrix}set rect(e){this._camera.rect=e,this.fire("set:rect",this._camera.rect);}get rect(){return this._camera.rect}set renderSceneColorMap(e){e&&!this._sceneColorMapRequested?(this.requestSceneColorMap(true),this._sceneColorMapRequested=true):this._sceneColorMapRequested&&(this.requestSceneColorMap(false),this._sceneColorMapRequested=false);}get renderSceneColorMap(){return this._renderSceneColorMap>0}set renderSceneDepthMap(e){e&&!this._sceneDepthMapRequested?(this.requestSceneDepthMap(true),this._sceneDepthMapRequested=true):this._sceneDepthMapRequested&&(this.requestSceneDepthMap(false),this._sceneDepthMapRequested=false);}get renderSceneDepthMap(){return this._renderSceneDepthMap>0}set renderTarget(e){this._camera.renderTarget=e,this.dirtyLayerCompositionCameras();}get renderTarget(){return this._camera.renderTarget}set scissorRect(e){this._camera.scissorRect=e;}get scissorRect(){return this._camera.scissorRect}set sensitivity(e){this._camera.sensitivity=e;}get sensitivity(){return this._camera.sensitivity}set shutter(e){this._camera.shutter=e;}get shutter(){return this._camera.shutter}get viewMatrix(){return this._camera.viewMatrix}_enableDepthLayer(e){if(this.layers.find(e=>1===e)){let t=this.system.app.scene.layers.getLayerById(1);e?t?.incrementCounter():t?.decrementCounter();}else if(e)return  false;return  true}requestSceneColorMap(e){this._renderSceneColorMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassColorGrab(this.system.app.graphicsDevice,this.renderSceneColorMap),this.system.app.scene.layers.markDirty();}requestSceneDepthMap(e){this._renderSceneDepthMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassDepthGrab(this.system.app.graphicsDevice,this.system.app.renderer,this.renderSceneDepthMap),this.system.app.scene.layers.markDirty();}dirtyLayerCompositionCameras(){this.system.app.scene.layers._dirty=true;}screenToWorld(e,t,i,s){let{width:r,height:a}=this.system.app.graphicsDevice.clientRect;return this._camera.screenToWorld(e,t,i,r,a,s)}worldToScreen(e,t){let{width:i,height:s}=this.system.app.graphicsDevice.clientRect;return this._camera.worldToScreen(e,i,s,t)}onAppPrerender(){this._camera._viewMatDirty=true,this._camera._viewProjMatDirty=true;}addCameraToLayers(){let e=this.layers;for(let t=0;t<e.length;t++){let i=this.system.app.scene.layers.getLayerById(e[t]);i&&i.addCamera(this);}}removeCameraFromLayers(){let e=this.layers;for(let t=0;t<e.length;t++){let i=this.system.app.scene.layers.getLayerById(e[t]);i&&i.removeCamera(this);}}onLayersChanged(e,t){this.addCameraToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);}onLayerAdded(e){0>this.layers.indexOf(e.id)||e.addCamera(this);}onLayerRemoved(e){0>this.layers.indexOf(e.id)||e.removeCamera(this);}onEnable(){let e=this.system.app.scene,t=e.layers;this.system.addCamera(this),this._evtLayersChanged?.off(),this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded?.off(),this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved?.off(),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable();}onDisable(){let e=this.system.app.scene.layers;this.postEffects.disable(),this.removeCameraFromLayers(),this._evtLayersChanged?.off(),this._evtLayersChanged=null,e&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this.system.removeCamera(this);}onRemove(){this.onDisable(),this.off(),this.camera.destroy();}calculateAspectRatio(e){let t=this.system.app.graphicsDevice,i=e?e.width:t.width,s=e?e.height:t.height;return i*this.rect.z/(s*this.rect.w)}frameUpdate(e){0===this.aspectRatioMode&&(this.aspectRatio=this.calculateAspectRatio(e));}startXr(e,t,i){this.system.app.xr.start(this,e,t,i);}endXr(e){if(!this._camera.xr){e&&e(Error("Camera is not in XR"));return}this._camera.xr.end(e);}copy(e){this.aperture=e.aperture,this.aspectRatio=e.aspectRatio,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.disablePostEffectsLayer=e.disablePostEffectsLayer,this.farClip=e.farClip,this.flipFaces=e.flipFaces,this.fov=e.fov,this.frustumCulling=e.frustumCulling,this.horizontalFov=e.horizontalFov,this.layers=e.layers,this.nearClip=e.nearClip,this.orthoHeight=e.orthoHeight,this.priority=e.priority,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.sensitivity=e.sensitivity,this.shutter=e.shutter;}constructor(e,t){super(e,t),this.onPostprocessing=null,this._renderSceneDepthMap=0,this._renderSceneColorMap=0,this._sceneDepthMapRequested=false,this._sceneColorMapRequested=false,this._priority=0,this._disablePostEffectsLayer=4,this._camera=new oP,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._camera.node=t,this._postEffects=new g3(e.app,this);}}class g5{constructor(){this.enabled=true;}}let g8=["enabled"];class g6 extends f8{initializeComponentData(e,t,i){i=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepth","clearDepthBuffer","clearStencilBuffer","renderSceneColorMap","renderSceneDepthMap","cullFaces","farClip","flipFaces","fog","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect","aperture","shutter","sensitivity","gammaCorrection","toneMapping"];for(let s=0;s<i.length;s++){let r=i[s];if(t.hasOwnProperty(r)){let i=t[r];switch(r){case "rect":case "scissorRect":Array.isArray(i)?e[r]=new ep(i[0],i[1],i[2],i[3]):e[r]=i;break;case "clearColor":Array.isArray(i)?e[r]=new es(i[0],i[1],i[2],i[3]):e[r]=i;break;default:e[r]=i;}}}super.initializeComponentData(e,t,["enabled"]);}cloneComponent(e,t){let i=e.camera;return this.addComponent(t,{aspectRatio:i.aspectRatio,aspectRatioMode:i.aspectRatioMode,calculateProjection:i.calculateProjection,calculateTransform:i.calculateTransform,clearColor:i.clearColor,clearColorBuffer:i.clearColorBuffer,clearDepthBuffer:i.clearDepthBuffer,clearStencilBuffer:i.clearStencilBuffer,renderSceneDepthMap:i.renderSceneDepthMap,renderSceneColorMap:i.renderSceneColorMap,cullFaces:i.cullFaces,enabled:i.enabled,farClip:i.farClip,flipFaces:i.flipFaces,fov:i.fov,frustumCulling:i.frustumCulling,horizontalFov:i.horizontalFov,layers:i.layers,renderTarget:i.renderTarget,nearClip:i.nearClip,orthoHeight:i.orthoHeight,projection:i.projection,priority:i.priority,rect:i.rect,scissorRect:i.scissorRect,aperture:i.aperture,sensitivity:i.sensitivity,shutter:i.shutter,gammaCorrection:i.gammaCorrection,toneMapping:i.toneMapping})}onBeforeRemove(e,t){this.removeCamera(t),t.onRemove();}onAppPrerender(){for(let e=0,t=this.cameras.length;e<t;e++)this.cameras[e].onAppPrerender();}addCamera(e){this.cameras.push(e),this.cameras.sort(hu);}removeCamera(e){let t=this.cameras.indexOf(e);t>=0&&(this.cameras.splice(t,1),this.cameras.sort(hu));}destroy(){this.app.off("prerender",this.onAppPrerender,this),super.destroy();}constructor(e){super(e),this.cameras=[],this.id="camera",this.ComponentType=g4,this.DataType=g5,this.schema=g8,this.on("beforeremove",this.onBeforeRemove,this),this.app.on("prerender",this.onAppPrerender,this);}}f5._buildAccessors(g4.prototype,g8);class g9{constructor(){this.enabled=true,this.type="directional",this.color=new es(1,1,1),this.intensity=1,this.luminance=0,this.shape=0,this.affectSpecularity=true,this.castShadows=false,this.shadowDistance=40,this.shadowIntensity=1,this.shadowResolution=1024,this.shadowBias=.05,this.numCascades=1,this.cascadeBlend=0,this.bakeNumSamples=1,this.bakeArea=0,this.cascadeDistribution=.5,this.normalOffsetBias=0,this.range=10,this.innerConeAngle=40,this.outerConeAngle=45,this.falloffMode=0,this.shadowType=0,this.vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this.cookieAsset=null,this.cookie=null,this.cookieIntensity=1,this.cookieFalloff=true,this.cookieChannel="rgb",this.cookieAngle=0,this.cookieScale=null,this.cookieOffset=null,this.shadowUpdateMode=2,this.mask=1,this.affectDynamic=true,this.affectLightmapped=false,this.bake=false,this.bakeDir=true,this.isStatic=false,this.layers=[0],this.penumbraSize=1,this.penumbraFalloff=1,this.shadowSamples=16,this.shadowBlockerSamples=16;}}let g7=Object.keys(new g9);class ve extends f5{get data(){let e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e,function(e,t){this.onSetEnabled(null,t,e);});}get enabled(){return this.data.enabled}set light(e){this._setValue("light",e);}get light(){return this.data.light}set type(e){this._setValue("type",e,function(e,t){this.system.changeType(this,t,e),this.refreshProperties();});}get type(){return this.data.type}set color(e){this._setValue("color",e,function(e,t){this.light.setColor(e);},true);}get color(){return this.data.color}set intensity(e){this._setValue("intensity",e,function(e,t){this.light.intensity=e;});}get intensity(){return this.data.intensity}set luminance(e){this._setValue("luminance",e,function(e,t){this.light.luminance=e;});}get luminance(){return this.data.luminance}set shape(e){this._setValue("shape",e,function(e,t){this.light.shape=e;});}get shape(){return this.data.shape}set affectSpecularity(e){this._setValue("affectSpecularity",e,function(e,t){this.light.affectSpecularity=e;});}get affectSpecularity(){return this.data.affectSpecularity}set castShadows(e){this._setValue("castShadows",e,function(e,t){this.light.castShadows=e;});}get castShadows(){return this.data.castShadows}set shadowDistance(e){this._setValue("shadowDistance",e,function(e,t){this.light.shadowDistance=e;});}get shadowDistance(){return this.data.shadowDistance}set shadowIntensity(e){this._setValue("shadowIntensity",e,function(e,t){this.light.shadowIntensity=e;});}get shadowIntensity(){return this.data.shadowIntensity}set shadowResolution(e){this._setValue("shadowResolution",e,function(e,t){this.light.shadowResolution=e;});}get shadowResolution(){return this.data.shadowResolution}set shadowBias(e){this._setValue("shadowBias",e,function(e,t){this.light.shadowBias=-0.01*ei.clamp(e,0,1);});}get shadowBias(){return this.data.shadowBias}set numCascades(e){this._setValue("numCascades",e,function(e,t){this.light.numCascades=ei.clamp(Math.floor(e),1,4);});}get numCascades(){return this.data.numCascades}set cascadeBlend(e){this._setValue("cascadeBlend",e,function(e,t){this.light.cascadeBlend=ei.clamp(e,0,1);});}get cascadeBlend(){return this.data.cascadeBlend}set bakeNumSamples(e){this._setValue("bakeNumSamples",e,function(e,t){this.light.bakeNumSamples=ei.clamp(Math.floor(e),1,255);});}get bakeNumSamples(){return this.data.bakeNumSamples}set bakeArea(e){this._setValue("bakeArea",e,function(e,t){this.light.bakeArea=ei.clamp(e,0,180);});}get bakeArea(){return this.data.bakeArea}set cascadeDistribution(e){this._setValue("cascadeDistribution",e,function(e,t){this.light.cascadeDistribution=ei.clamp(e,0,1);});}get cascadeDistribution(){return this.data.cascadeDistribution}set normalOffsetBias(e){this._setValue("normalOffsetBias",e,function(e,t){this.light.normalOffsetBias=ei.clamp(e,0,1);});}get normalOffsetBias(){return this.data.normalOffsetBias}set range(e){this._setValue("range",e,function(e,t){this.light.attenuationEnd=e;});}get range(){return this.data.range}set innerConeAngle(e){this._setValue("innerConeAngle",e,function(e,t){this.light.innerConeAngle=e;});}get innerConeAngle(){return this.data.innerConeAngle}set outerConeAngle(e){this._setValue("outerConeAngle",e,function(e,t){this.light.outerConeAngle=e;});}get outerConeAngle(){return this.data.outerConeAngle}set falloffMode(e){this._setValue("falloffMode",e,function(e,t){this.light.falloffMode=e;});}get falloffMode(){return this.data.falloffMode}set shadowType(e){this._setValue("shadowType",e,function(e,t){this.light.shadowType=e;});}get shadowType(){return this.data.shadowType}set vsmBlurSize(e){this._setValue("vsmBlurSize",e,function(e,t){this.light.vsmBlurSize=e;});}get vsmBlurSize(){return this.data.vsmBlurSize}set vsmBlurMode(e){this._setValue("vsmBlurMode",e,function(e,t){this.light.vsmBlurMode=e;});}get vsmBlurMode(){return this.data.vsmBlurMode}set vsmBias(e){this._setValue("vsmBias",e,function(e,t){this.light.vsmBias=ei.clamp(e,0,1);});}get vsmBias(){return this.data.vsmBias}set cookieAsset(e){this._setValue("cookieAsset",e,function(e,t){if(!this._cookieAssetId||(!(e instanceof fy)||e.id!==this._cookieAssetId)&&e!==this._cookieAssetId){if(this.onCookieAssetRemove(),this._cookieAssetId=null,e instanceof fy)this.data.cookieAsset=e.id,this._cookieAssetId=e.id,this.onCookieAssetAdd(e);else if("number"==typeof e){this._cookieAssetId=e;let t=this.system.app.assets.get(e);t?this.onCookieAssetAdd(t):(this._cookieAssetAdd=true,this.system.app.assets.on(`add:${this._cookieAssetId}`,this.onCookieAssetAdd,this));}}});}get cookieAsset(){return this.data.cookieAsset}set cookie(e){this._setValue("cookie",e,function(e,t){this.light.cookie=e;});}get cookie(){return this.data.cookie}set cookieIntensity(e){this._setValue("cookieIntensity",e,function(e,t){this.light.cookieIntensity=ei.clamp(e,0,1);});}get cookieIntensity(){return this.data.cookieIntensity}set cookieFalloff(e){this._setValue("cookieFalloff",e,function(e,t){this.light.cookieFalloff=e;});}get cookieFalloff(){return this.data.cookieFalloff}set cookieChannel(e){this._setValue("cookieChannel",e,function(e,t){this.light.cookieChannel=e;});}get cookieChannel(){return this.data.cookieChannel}set cookieAngle(e){this._setValue("cookieAngle",e,function(e,t){if(0!==e||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new ep);let t=1,i=1;this.cookieScale&&(t=this.cookieScale.x,i=this.cookieScale.y);let s=Math.cos(e*ei.DEG_TO_RAD),r=Math.sin(e*ei.DEG_TO_RAD);this._cookieMatrix.set(s/t,-r/t,r/i,s/i),this.light.cookieTransform=this._cookieMatrix;}else this.light.cookieTransform=null;});}get cookieAngle(){return this.data.cookieAngle}set cookieScale(e){this._setValue("cookieScale",e,function(e,t){if(null!==e||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new ep);let t=e.x,i=e.y,s=Math.cos(this.cookieAngle*ei.DEG_TO_RAD),r=Math.sin(this.cookieAngle*ei.DEG_TO_RAD);this._cookieMatrix.set(s/t,-r/t,r/i,s/i),this.light.cookieTransform=this._cookieMatrix;}else this.light.cookieTransform=null;},true);}get cookieScale(){return this.data.cookieScale}set cookieOffset(e){this._setValue("cookieOffset",e,function(e,t){this.light.cookieOffset=e;},true);}get cookieOffset(){return this.data.cookieOffset}set shadowUpdateMode(e){this._setValue("shadowUpdateMode",e,function(e,t){this.light.shadowUpdateMode=e;},true);}get shadowUpdateMode(){return this.data.shadowUpdateMode}set mask(e){this._setValue("mask",e,function(e,t){this.light.mask=e;});}get mask(){return this.data.mask}set affectDynamic(e){this._setValue("affectDynamic",e,function(e,t){e?this.light.mask|=1:this.light.mask&=-2,this.light.layersDirty();});}get affectDynamic(){return this.data.affectDynamic}set affectLightmapped(e){this._setValue("affectLightmapped",e,function(e,t){e?(this.light.mask|=2,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=4));});}get affectLightmapped(){return this.data.affectLightmapped}set bake(e){this._setValue("bake",e,function(e,t){e?(this.light.mask|=4,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=2)),this.light.layersDirty();});}get bake(){return this.data.bake}set bakeDir(e){this._setValue("bakeDir",e,function(e,t){this.light.bakeDir=e;});}get bakeDir(){return this.data.bakeDir}set isStatic(e){this._setValue("isStatic",e,function(e,t){this.light.isStatic=e;});}get isStatic(){return this.data.isStatic}set layers(e){this._setValue("layers",e,function(e,t){for(let e=0;e<t.length;e++){let i=this.system.app.scene.layers.getLayerById(t[e]);i&&(i.removeLight(this),this.light.removeLayer(i));}for(let t=0;t<e.length;t++){let i=this.system.app.scene.layers.getLayerById(e[t]);i&&this.enabled&&this.entity.enabled&&(i.addLight(this),this.light.addLayer(i));}});}get layers(){return this.data.layers}set shadowUpdateOverrides(e){this.light.shadowUpdateOverrides=e;}get shadowUpdateOverrides(){return this.light.shadowUpdateOverrides}set shadowSamples(e){this.light.shadowSamples=e;}get shadowSamples(){return this.light.shadowSamples}set shadowBlockerSamples(e){this.light.shadowBlockerSamples=e;}get shadowBlockerSamples(){return this.light.shadowBlockerSamples}set penumbraSize(e){this.light.penumbraSize=e;}get penumbraSize(){return this.light.penumbraSize}set penumbraFalloff(e){this.light.penumbraFalloff=e;}get penumbraFalloff(){return this.light.penumbraFalloff}_setValue(e,t,i,s){let r=this.data,a=r[e];(s||a!==t)&&(r[e]=t,i&&i.call(this,t,a));}addLightToLayers(){for(let e=0;e<this.layers.length;e++){let t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.addLight(this),this.light.addLayer(t));}}removeLightFromLayers(){for(let e=0;e<this.layers.length;e++){let t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.removeLight(this),this.light.removeLayer(t));}}onLayersChanged(e,t){this.enabled&&this.entity.enabled&&this.addLightToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);}onLayerAdded(e){this.layers.indexOf(e.id)>=0&&this.enabled&&this.entity.enabled&&(e.addLight(this),this.light.addLayer(e));}onLayerRemoved(e){this.layers.indexOf(e.id)>=0&&(e.removeLight(this),this.light.removeLayer(e));}refreshProperties(){for(let e=0;e<g7.length;e++){let t=g7[e];this[t]=this[t];}this.enabled&&this.entity.enabled&&this.onEnable();}onCookieAssetSet(){let e=false;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(this._cookieAsset.loadFaces=true,e=true),(!this._cookieAsset.resource||e)&&this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad();}onCookieAssetAdd(e){this._cookieAssetId===e.id&&(this._cookieAsset=e,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this));}onCookieAssetLoad(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource);}onCookieAssetRemove(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off(`add:${this._cookieAssetId}`,this.onCookieAssetAdd,this),this._cookieAssetAdd=false),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null);}onEnable(){let e=this.system.app.scene,t=e.layers;this.light.enabled=true,this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet();}onDisable(){let e=this.system.app.scene.layers;this.light.enabled=false,this._evtLayersChanged?.off(),this._evtLayersChanged=null,e&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this.removeLightFromLayers();}onRemove(){this.onDisable(),this.light.destroy(),this.cookieAsset=null;}constructor(...e){super(...e),this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=false,this._cookieMatrix=null;}}class vt extends f8{initializeComponentData(e,t){let i={...t};i.type||(i.type=e.data.type),e.data.type=i.type,i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0)),i.color&&Array.isArray(i.color)&&(i.color=new es(i.color[0],i.color[1],i.color[2])),i.cookieOffset&&i.cookieOffset instanceof Array&&(i.cookieOffset=new ef(i.cookieOffset[0],i.cookieOffset[1])),i.cookieScale&&i.cookieScale instanceof Array&&(i.cookieScale=new ef(i.cookieScale[0],i.cookieScale[1])),i.enable&&(i.enabled=i.enable),i.shape||(i.shape=0);let s=new hE(this.app.graphicsDevice,this.app.scene.clusteredLightingEnabled);s.type=hv[i.type],s._node=e.entity,e.data.light=s,super.initializeComponentData(e,i,g7);}_onRemoveComponent(e,t){t.onRemove();}cloneComponent(e,t){let i,s=e.light,r=[];for(let e=0;e<g7.length;e++)"light"!==(i=g7[e])&&(s[i]&&s[i].clone?r[i]=s[i].clone():r[i]=s[i]);return this.addComponent(t,r)}changeType(e,t,i){t!==i&&(e.light.type=hv[i]);}constructor(e){super(e),this.id="light",this.ComponentType=ve,this.DataType=g9,this.on("beforeremove",this._onRemoveComponent,this);}}let vi=["x","y","z","w"],vs=[void 0,void 0,ef,ed,ep];function vr(e,t,i,s){switch(t.type){case "boolean":return !!i;case "number":if("number"==typeof i)break;if("string"==typeof i){let e=parseInt(i,10);if(isNaN(e))return null;return e}if("boolean"==typeof i)return 0+i;return null;case "json":{let s={};if(Array.isArray(t.schema)){i&&"object"==typeof i||(i={});for(let r=0;r<t.schema.length;r++){let a=t.schema[r];if(a.name)if(a.array){s[a.name]=[];let t=Array.isArray(i[a.name])?i[a.name]:[];for(let i=0;i<t.length;i++)s[a.name].push(vr(e,a,t[i]));}else {let t=i.hasOwnProperty(a.name)?i[a.name]:a.default;s[a.name]=vr(e,a,t);}}}return s}case "asset":if(i instanceof fy)break;if("number"==typeof i)return e.assets.get(i)||null;if("string"==typeof i)return e.assets.get(parseInt(i,10))||null;return null;case "entity":if(i instanceof oX)break;if("string"==typeof i)return e.getEntityFromIndex(i);return null;case "rgb":case "rgba":if(i instanceof es){if(s instanceof es)return s.copy(i),s;return i.clone()}if(i instanceof Array&&i.length>=3&&i.length<=4){for(let e=0;e<i.length;e++)if("number"!=typeof i[e])return null;return s||(s=new es),s.r=i[0],s.g=i[1],s.b=i[2],s.a=3===i.length?1:i[3],s}if("string"==typeof i&&/#(?:[0-9a-f]{2}){3,4}/i.test(i))return s||(s=new es),s.fromString(i),s;return null;case "vec2":case "vec3":case "vec4":{let e=parseInt(t.type.slice(3),10),r=vs[e];if(i instanceof r){if(s instanceof r)return s.copy(i),s;return i.clone()}if(i instanceof Array&&i.length===e){for(let e=0;e<i.length;e++)if("number"!=typeof i[e])return null;s||(s=new r);for(let t=0;t<e;t++)s[vi[t]]=i[t];return s}return null}case "curve":if(i){let e;return i instanceof ea||i instanceof en?e=i.clone():(e=new(i.keys[0]instanceof Array?en:ea)(i.keys)).type=i.type,e}}return i}function va(e,t,i,s){return t.array?i.map((i,r)=>vr(e,t,i,s?s[r]:null)):vr(e,t,i,s)}function vn(e,t,i,s){if(i)for(let r in t){let a=t[r],n=i[r];void 0!==n&&(s[r]=va(e,a,n,s[r]));}}class vo{add(e,t){if(t&&t.type){if(!(this.index[e]||vo.reservedNames.has(e)))this.index[e]=t,Object.defineProperty(this.scriptType.prototype,e,{get:function(){return this.__attributes[e]},set:function(i){let s="attr",r=`attr:${e}`,a=this.__attributes[e],n=a;if(a&&"json"!==t.type&&"entity"!==t.type&&a.clone&&(this.hasEvent(s)||this.hasEvent(r))&&(n=a.clone()),t.array){if(this.__attributes[e]=[],i)for(let s=0,r=i.length;s<r;s++)this.__attributes[e].push(vr(this.app,t,i[s],a?a[s]:null));}else this.__attributes[e]=vr(this.app,t,i,a);this.fire(s,e,this.__attributes[e],n),this.fire(r,this.__attributes[e],n);}});}}remove(e){return !!this.index[e]&&(delete this.index[e],delete this.scriptType.prototype[e],true)}has(e){return !!this.index[e]}get(e){return this.index[e]||null}constructor(e){this.scriptType=e,this.index={};}}vo.assignAttributesToScript=vn,vo.attributeToValue=va,vo.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent"]);let vl="initialize",vh="postInitialize";class vc extends X{set enabled(e){this._enabled=!!e,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=true,this.fire("preInitialize"),this.initialize&&this.entity.script._scriptMethod(this,vl)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=true,this.postInitialize&&this.entity.script._scriptMethod(this,vh)));}get enabled(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled}initScript(e){let t=this.constructor;this.app=e.app,this.entity=e.entity,this._enabled="boolean"!=typeof e.enabled||e.enabled,this._enabledOld=this.enabled,this.__destroyed=false,this.__scriptType=t,this.__executionOrder=-1;}static set scriptName(e){this.__name=e;}static get scriptName(){return this.__name}constructor(e){super(),this.initScript(e);}}vc.EVENT_ENABLE="enable",vc.EVENT_DISABLE="disable",vc.EVENT_STATE="state",vc.EVENT_DESTROY="destroy",vc.EVENT_ATTR="attr",vc.EVENT_ERROR="error",vc.__name=null,vc.__getScriptName=vu;let vd=/^\s*function(?:\s|\s*\/\*.*\*\/\s*)+([^(\s\/]*)\s*/;function vu(e){if("function"!=typeof e)return;if(e.scriptName)return e.scriptName;if("name"in Function.prototype)return e.name;if(e===Function||e===Function.prototype.constructor)return "Function";let t=`${e}`.match(vd);return t?t[1]:void 0}class vf extends vc{static get attributes(){return this.hasOwnProperty("__attributes")||(this.__attributes=new vo(this)),this.__attributes}initScript(e){vc.prototype.initScript.call(this,e),this.__attributes={},this.__attributesRaw=e.attributes||{};}initScriptType(e){this.initScript(e);}__initializeAttributes(e){if(e||this.__attributesRaw){for(let e in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(e)?this[e]=this.__attributesRaw[e]:this.__attributes.hasOwnProperty(e)||(this.__scriptType.attributes.index[e].hasOwnProperty("default")?this[e]=this.__scriptType.attributes.index[e].default:this[e]=null);this.__attributesRaw=null;}}static extend(e){for(let t in e)e.hasOwnProperty(t)&&(this.prototype[t]=e[t]);}constructor(e){super(e),this.initScriptType(e);}}class vp extends f5{set scripts(e){for(let t in this._scriptsData=e,e){if(!e.hasOwnProperty(t))continue;let i=this._scriptsIndex[t];if(i&&("boolean"==typeof e[t].enabled&&(i.once("preInitialize",()=>{this.initializeAttributes(i);}),i.enabled=!!e[t].enabled),"object"==typeof e[t].attributes)){for(let s in e[t].attributes)if(!vo.reservedNames.has(s)){if(!i.__attributes.hasOwnProperty(s)){let e=this.system.app.scripts.get(t);e&&e.attributes.add(s,{});}i[s]=e[t].attributes[s];}}}}get scripts(){return this._scripts}set enabled(e){let t=this._enabled;this._enabled=e,this.fire("set","enabled",t,e);}get enabled(){return this._enabled}onEnable(){this._beingEnabled=true,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=false;}onDisable(){this._checkState();}onPostStateChange(){let e=this._beginLooping();for(let e=0,t=this.scripts.length;e<t;e++){let t=this.scripts[e];t._initialized&&!t._postInitialized&&t.enabled&&(t._postInitialized=true,t.postInitialize&&this._scriptMethod(t,vh));}this._endLooping(e);}_beginLooping(){let e=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=true,e}_endLooping(e){this._isLoopingThroughScripts=e,this._isLoopingThroughScripts||this._removeDestroyedScripts();}_onSetEnabled(e,t,i){this._beingEnabled=true,this._checkState(),this._beingEnabled=false;}_checkState(){let e=this.enabled&&this.entity.enabled;if(e===this._oldState)return;this._oldState=e,this.fire(e?"enable":"disable"),this.fire("state",e),e?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);let t=this._beginLooping();for(let e=0,t=this.scripts.length;e<t;e++){let t=this.scripts[e];t.once("preInitialize",()=>{this.initializeAttributes(t);}),t.enabled=t._enabled;}this._endLooping(t);}_onBeforeRemove(){this.fire("remove");let e=this._beginLooping();for(let e=0;e<this.scripts.length;e++){let t=this.scripts[e];t&&this.destroy(t.__scriptType.__name);}this._endLooping(e);}_removeDestroyedScripts(){let e=this._destroyedScripts.length;if(e){for(let t=0;t<e;t++){let e=this._destroyedScripts[t];this._removeScriptInstance(e);}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length);}}_onInitializeAttributes(){for(let e=0,t=this.scripts.length;e<t;e++){let t=this.scripts[e];this.initializeAttributes(t);}}initializeAttributes(e){if(e instanceof vf)e.__initializeAttributes();else {let t=e.__scriptType.__name,i=this._attributeDataMap.get(t);if(!i)return;let s=this.system.app.scripts?.getSchema(t);vn(this.system.app,s.attributes,i,e);}}_scriptMethod(e,t,i){e[t](i);}_onInitialize(){let e=this._scripts,t=this._beginLooping();for(let t=0,i=e.length;t<i;t++){let i=e[t];!i._initialized&&i.enabled&&(i._initialized=true,i.initialize&&this._scriptMethod(i,vl));}this._endLooping(t);}_onPostInitialize(){this.onPostStateChange();}_onUpdate(e){let t=this._updateList;if(!t.length)return;let i=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){let i=t.items[t.loopIndex];i.enabled&&this._scriptMethod(i,"update",e);}this._endLooping(i);}_onPostUpdate(e){let t=this._postUpdateList;if(!t.length)return;let i=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){let i=t.items[t.loopIndex];i.enabled&&this._scriptMethod(i,"postUpdate",e);}this._endLooping(i);}_insertScriptInstance(e,t,i){ -1===t?(this._scripts.push(e),e.__executionOrder=i,e.update&&this._updateList.append(e),e.postUpdate&&this._postUpdateList.append(e)):(this._scripts.splice(t,0,e),e.__executionOrder=t,this._resetExecutionOrder(t+1,i+1),e.update&&this._updateList.insert(e),e.postUpdate&&this._postUpdateList.insert(e));}_removeScriptInstance(e){let t=this._scripts.indexOf(e);return -1===t||(this._scripts.splice(t,1),e.update&&this._updateList.remove(e),e.postUpdate&&this._postUpdateList.remove(e)),t}_resetExecutionOrder(e,t){for(let i=e;i<t;i++)this._scripts[i].__executionOrder=i;}_resolveEntityScriptAttribute(e,t,i,s,r,a){if(e.array){let e=i.length;if(!e)return;let n=i.slice();for(let t=0;t<e;t++){let e=n[t]instanceof fB?n[t].getGuid():n[t];a[e]&&(n[t]=s?a[e].getGuid():a[e]);}r[t]=n;}else {if(i instanceof fB)i=i.getGuid();else if("string"!=typeof i)return;a[i]&&(r[t]=a[i]);}}has(e){if("string"==typeof e)return !!this._scriptsIndex[e];if(!e)return  false;let t=e.__name,i=this._scriptsIndex[t];return (i&&i.instance)instanceof e}get(e){if("string"==typeof e){let t=this._scriptsIndex[e];return t?t.instance:null}if(!e)return null;let t=e.__name,i=this._scriptsIndex[t],s=i&&i.instance;return s instanceof e?s:null}create(e,t={}){let i=this,s=e,r=e;if("string"==typeof s)s=this.system.app.scripts.get(s);else if(s){var a;let e,t=(e=vu(s))[0].toLowerCase()+e.substring(1);s.prototype instanceof vf||s.scriptName,(a=s).__name??(a.__name=s.scriptName??t),r=s.__name;}if(s){if(!this._scriptsIndex[r]||!this._scriptsIndex[r].instance){let e=new s({app:this.system.app,entity:this.entity,enabled:!t.hasOwnProperty("enabled")||t.enabled,attributes:t.attributes||{}});t.properties&&"object"==typeof t.properties&&Object.assign(e,t.properties),e instanceof vf||!t.attributes||this._attributeDataMap.set(r,{...t.attributes});let a=this._scripts.length,n=-1;return "number"==typeof t.ind&&-1!==t.ind&&a>t.ind&&(n=t.ind),this._insertScriptInstance(e,n,a),this._scriptsIndex[r]={instance:e,onSwap:function(){i.swap(r);}},this[r]=e,t.preloading||this.initializeAttributes(e),this.fire("create",r,e),this.fire(`create:${r}`,e),this.system.app.scripts.on(`swap:${r}`,this._scriptsIndex[r].onSwap),!t.preloading&&(e.enabled&&!e._initialized&&(e._initialized=true,e.initialize&&this._scriptMethod(e,vl)),e.enabled&&!e._postInitialized&&(e._postInitialized=true,e.postInitialize&&this._scriptMethod(e,vh))),e}}else this._scriptsIndex[r]={awaiting:true,ind:this._scripts.length};return null}destroy(e){let t=e,i=e;"string"==typeof i?i=this.system.app.scripts.get(i):i&&(t=i.__name);let s=this._scriptsIndex[t];if(delete this._scriptsIndex[t],!s)return  false;this._attributeDataMap.delete(t);let r=s.instance;if(r&&!r._destroyed)if(r.enabled=false,r._destroyed=true,this._isLoopingThroughScripts)this._destroyedScripts.push(r);else {let e=this._removeScriptInstance(r);e>=0&&this._resetExecutionOrder(e,this._scripts.length);}return this.system.app.scripts.off(`swap:${t}`,s.onSwap),delete this[t],this.fire("destroy",t,r||null),this.fire(`destroy:${t}`,r||null),r&&r.fire("destroy"),true}swap(e){let t=e,i=e;"string"==typeof i?i=this.system.app.scripts.get(i):i&&(t=i.__name);let s=this._scriptsIndex[t];if(!s||!s.instance)return  false;let r=s.instance,a=this._scripts.indexOf(r),n=new i({app:this.system.app,entity:this.entity,enabled:r.enabled,attributes:r.__attributes});return !!n.swap&&(this.initializeAttributes(n),this._scripts[a]=n,this._scriptsIndex[t].instance=n,this[t]=n,n.__executionOrder=a,r.update&&this._updateList.remove(r),r.postUpdate&&this._postUpdateList.remove(r),n.update&&this._updateList.insert(n),n.postUpdate&&this._postUpdateList.insert(n),this._scriptMethod(n,"swap",r),this.fire("swap",t,n),this.fire(`swap:${t}`,n),true)}resolveDuplicatedEntityReferenceProperties(e,t){let i=this.entity.script;for(let s in e._scriptsIndex){let r=this.system.app.scripts.get(s);if(!r)continue;let a=e._scriptsIndex[s];if(!a||!a.instance)continue;let n=i[s].__attributesRaw??i._attributeDataMap.get(s),o=i[s].__attributes;if(!n&&!o)continue;let l=!!n,h=a.instance.__attributes??i._attributeDataMap.get(s);for(let e in h){if(!h[e])continue;let i=r.attributes?.get(e)??this.system.app.scripts.getSchema(s)?.attributes?.[e];if(i){if("entity"===i.type)this._resolveEntityScriptAttribute(i,e,h[e],l,n||o,t);else if("json"===i.type&&Array.isArray(i.schema)){let s=h[e],r=n?n[e]:o[e];for(let e=0;e<i.schema.length;e++){let a=i.schema[e];if("entity"===a.type)if(i.array)for(let e=0;e<s.length;e++)this._resolveEntityScriptAttribute(a,a.name,s[e][a.name],l,r[e],t);else this._resolveEntityScriptAttribute(a,a.name,s[a.name],l,r,t);}}}}}}move(e,t){let i=this._scripts.length;if(t>=i||t<0)return  false;let s=e,r=e;"string"!=typeof r?r=e.__name:s=null;let a=this._scriptsIndex[r];if(!a||!a.instance)return  false;let n=a.instance;if(s&&!(n instanceof s))return  false;let o=this._scripts.indexOf(n);return -1!==o&&o!==t&&(this._scripts.splice(t,0,this._scripts.splice(o,1)[0]),this._resetExecutionOrder(0,i),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",r,n,t,o),this.fire(`move:${r}`,n,t,o),true)}constructor(e,t){super(e,t),this._attributeDataMap=new Map,this._scripts=[],this._updateList=new K({sortBy:"__executionOrder"}),this._postUpdateList=new K({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=false,this._scriptsData=null,this._oldState=true,this._enabled=true,this._beingEnabled=false,this._isLoopingThroughScripts=false,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this);}}vp.EVENT_CREATE="create",vp.EVENT_DESTROY="destroy",vp.EVENT_ENABLE="enable",vp.EVENT_DISABLE="disable",vp.EVENT_REMOVE="remove",vp.EVENT_STATE="state",vp.EVENT_MOVE="move",vp.EVENT_ERROR="error";class vm{constructor(){this.enabled=true;}}let v_=0;class vg extends f8{initializeComponentData(e,t){if(e._executionOrder=v_++,this._components.append(e),v_>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),e.enabled=!t.hasOwnProperty("enabled")||!!t.enabled,e.enabled&&e.entity.enabled&&this._enabledComponents.append(e),t.hasOwnProperty("order")&&t.hasOwnProperty("scripts")){e._scriptsData=t.scripts;for(let i=0;i<t.order.length;i++)e.create(t.order[i],{enabled:t.scripts[t.order[i]].enabled,attributes:t.scripts[t.order[i]].attributes,preloading:this.preloading});}}cloneComponent(e,t){let i=[],s={};for(let t=0;t<e.script._scripts.length;t++){let r=e.script._scripts[t],a=r.__scriptType.__name;i.push(a);let n=e.script._attributeDataMap?.get(a)||{};for(let e in r.__attributes)n[e]=r.__attributes[e];s[a]={enabled:r._enabled,attributes:n};}for(let t in e.script._scriptsIndex)t.awaiting&&i.splice(t.ind,0,t);let r={enabled:e.script.enabled,order:i,scripts:s};return this.addComponent(t,r)}_resetExecutionOrder(){v_=0;for(let e=0,t=this._components.length;e<t;e++)this._components.items[e]._executionOrder=v_++;}_callComponentMethod(e,t,i){for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++)e.items[e.loopIndex][t](i);}_onInitialize(){this.preloading=false,this._callComponentMethod(this._components,"_onInitializeAttributes"),this._callComponentMethod(this._enabledComponents,"_onInitialize");}_onPostInitialize(){this._callComponentMethod(this._enabledComponents,"_onPostInitialize");}_onUpdate(e){this._callComponentMethod(this._enabledComponents,"_onUpdate",e);}_onPostUpdate(e){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",e);}_addComponentToEnabled(e){this._enabledComponents.insert(e);}_removeComponentFromEnabled(e){this._enabledComponents.remove(e);}_onBeforeRemove(e,t){this._components.items.indexOf(t)>=0&&t._onBeforeRemove(),this._removeComponentFromEnabled(t),this._components.remove(t);}destroy(){super.destroy(),this.app.systems.off("initialize",this._onInitialize,this),this.app.systems.off("postInitialize",this._onPostInitialize,this),this.app.systems.off("update",this._onUpdate,this),this.app.systems.off("postUpdate",this._onPostUpdate,this);}constructor(e){super(e),this.id="script",this.ComponentType=vp,this.DataType=vm,this._components=new K({sortBy:"_executionOrder"}),this._enabledComponents=new K({sortBy:"_executionOrder"}),this.preloading=true,this.on("beforeremove",this._onBeforeRemove,this),this.app.systems.on("initialize",this._onInitialize,this),this.app.systems.on("postInitialize",this._onPostInitialize,this),this.app.systems.on("update",this._onUpdate,this),this.app.systems.on("postUpdate",this._onPostUpdate,this);}}var vv=`
precision highp usampler2D;
uniform usampler2D uIntervalsTexture;
uniform int uNumIntervals;
uniform int uTextureWidth;
uniform int uActiveSplats;
ivec2 getCoordFromIndex(int index, int textureWidth) {
	return ivec2(index % textureWidth, index / textureWidth);
}
void main() {
	ivec2 coord = ivec2(gl_FragCoord.xy);
	int targetIndex = coord.y * uTextureWidth + coord.x;
	
	if (targetIndex >= uActiveSplats) {
		gl_FragColor = 0u;
		return;
	}
	
	int left = 0;
	int right = uNumIntervals - 1;
	int intervalIndex = 0;
	
	while (left <= right) {
		int mid = (left + right) / 2;
		
		int textureWidth = textureSize(uIntervalsTexture, 0).x;
		ivec2 intervalCoord = getCoordFromIndex(mid, textureWidth);
		uvec2 intervalData = texelFetch(uIntervalsTexture, intervalCoord, 0).rg;
		
		uint accumulatedSum = intervalData.g;
		
		if (uint(targetIndex) < accumulatedSum) {
			intervalIndex = mid;
			right = mid - 1;
		} else {
			left = mid + 1;
		}
	}
	
	int textureWidth = textureSize(uIntervalsTexture, 0).x;
	ivec2 intervalCoord = getCoordFromIndex(intervalIndex, textureWidth);
	uvec2 intervalData = texelFetch(uIntervalsTexture, intervalCoord, 0).rg;
	
	uint intervalStart = intervalData.r;
	uint currentAccSum = intervalData.g;
	
	uint prevAccSum = 0u;
	if (intervalIndex > 0) {
		ivec2 prevCoord = getCoordFromIndex(intervalIndex - 1, textureWidth);
		prevAccSum = texelFetch(uIntervalsTexture, prevCoord, 0).g;
	}
	
	uint offsetInInterval = uint(targetIndex) - prevAccSum;
	uint originalIndex = intervalStart + offsetInInterval;
	
	gl_FragColor = originalIndex;
}
`,vS=`
var uIntervalsTexture: texture_2d<u32>;
uniform uNumIntervals: i32;
uniform uTextureWidth: i32;
uniform uActiveSplats: i32;
fn getCoordFromIndex(index: i32, textureWidth: i32) -> vec2i {
	return vec2i(index % textureWidth, index / textureWidth);
}
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	
	let coord = vec2i(i32(input.position.x), i32(input.position.y));
	let targetIndex = coord.y * uniform.uTextureWidth + coord.x;
	
	if (targetIndex >= uniform.uActiveSplats) {
		output.color = 0u;
		return output;
	}
	
	var left = 0i;
	var right = uniform.uNumIntervals - 1;
	var intervalIndex = 0i;
	
	while (left <= right) {
		let mid = (left + right) / 2;
		
		let textureWidth = i32(textureDimensions(uIntervalsTexture, 0).x);
		let intervalCoord = getCoordFromIndex(mid, textureWidth);
		let intervalData = textureLoad(uIntervalsTexture, intervalCoord, 0).rg;
		
		let accumulatedSum = intervalData.g;
		
		if (u32(targetIndex) < accumulatedSum) {
			intervalIndex = mid;
			right = mid - 1;
		} else {
			left = mid + 1;
		}
	}
	
	let textureWidth = i32(textureDimensions(uIntervalsTexture, 0).x);
	let intervalCoord = getCoordFromIndex(intervalIndex, textureWidth);
	let intervalData = textureLoad(uIntervalsTexture, intervalCoord, 0).rg;
	
	let intervalStart = intervalData.r;
	let currentAccSum = intervalData.g;
	
	var prevAccSum = 0u;
	if (intervalIndex > 0) {
		let prevCoord = getCoordFromIndex(intervalIndex - 1, textureWidth);
		prevAccSum = textureLoad(uIntervalsTexture, prevCoord, 0).g;
	}
	
	let offsetInInterval = u32(targetIndex) - prevAccSum;
	let originalIndex = intervalStart + offsetInInterval;
	
	output.color = originalIndex;
	return output;
}
`;class vy{destroy(){this.texture?.destroy(),this.texture=null,this.rt?.destroy(),this.rt=null,this.intervalsDataTexture?.destroy(),this.intervalsDataTexture=null,this.shader=null;}getShader(){return this.shader||(this.shader=nY.createShader(this.device,{uniqueName:"GSplatIntervalsShader",attributes:{aPosition:e6},vertexChunk:"quadVS",fragmentGLSL:vv,fragmentWGSL:vS,fragmentOutputTypes:["uint"]})),this.shader}createTexture(e,t,i,s){return new ih(this.device,{name:e,width:i,height:s,format:t,cubemap:false,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1})}update(e,t){let i=this.device.maxTextureSize,s=Math.ceil(Math.sqrt(t)),r=Math.ceil(t/(s=Math.min(s,i)));this.texture=this.createTexture("intervalsTexture",37,s,r),this.rt=new iU({colorBuffer:this.texture,depth:false});let a=e.length/2,n=Math.ceil(Math.sqrt(a));this.intervalsDataTexture=this.createTexture("intervalsData",43,n,n);let o=this.intervalsDataTexture.lock(),l=0;for(let t=0;t<a;t++){let i=e[2*t];l+=e[2*t+1]-i,o[2*t]=i,o[2*t+1]=l;}this.intervalsDataTexture.unlock();let h=this.device.scope;return h.resolve("uIntervalsTexture").setValue(this.intervalsDataTexture),h.resolve("uNumIntervals").setValue(a),h.resolve("uTextureWidth").setValue(s),h.resolve("uActiveSplats").setValue(t),this.device.setCullMode(0),this.device.setBlendState(iS.NOBLEND),this.device.setDepthState(ix.NODEPTH),n0(this.device,this.rt,this.getShader()),t}constructor(e){this.texture=null,this.rt=null,this.intervalsDataTexture=null,this.shader=null,this.device=e;}}let vx=[];class vT{destroy(){this.intervals.length=0,this.intervalTexture?.destroy();}setLines(e,t,i,s){this.lineStart=e,this.lineCount=t,this.padding=i*t-s,this.viewport.set(0,e,i,t);}updateIntervals(e){let t=this.resource;if(this.intervals.length=0,this.activeSplats=t.numSplats,e.size>0){let t=0,i=0;for(let s of e.values())t+=s.y-s.x+1,vx[i++]=s;if(t!==this.numSplats){vx.length=i,vx.sort((e,t)=>e.x-t.x),this.intervals.length=2*i;let e=0,s=vx[0].x,r=vx[0].y;for(let t=1;t<i;t++){let i=vx[t];i.x===r+1||(this.intervals[e++]=s,this.intervals[e++]=r+1,s=i.x),r=i.y;}this.intervals[e++]=s,this.intervals[e++]=r+1,this.intervals.length=e,this.intervalTexture=new vy(this.device),this.activeSplats=this.intervalTexture.update(this.intervals,t);}vx.length=0;}else {let e=t.centers?.length/3;e&&this.activeSplats<e&&(this.intervals[0]=0,this.intervals[1]=this.activeSplats);}}update(){let e=this.node.getWorldTransform(),t=!this.previousWorldTransform.equals(e);t&&this.previousWorldTransform.copy(e);let i=!!this._consumeRenderDirty&&this._consumeRenderDirty();return t||i}resetColorAccumulators(e,t){let i=Math.random();this.colorAccumulatedRotation=i*e,this.colorAccumulatedTranslation=i*t;}get hasSphericalHarmonics(){return this.resource.gsplatData?.shBands>0}constructor(e,t,i,s=null){this.activeSplats=0,this.intervals=[],this.lineStart=0,this.lineCount=0,this.padding=0,this.viewport=new ep,this.previousWorldTransform=new ey,this.aabb=new eC,this.intervalTexture=null,this.colorAccumulatedRotation=0,this.colorAccumulatedTranslation=0,this.parameters=null,this.getWorkBufferModifier=null,this.getInstanceStreams=null,this._consumeRenderDirty=null,this.device=e,this.resource=t,this.node=i.node,this.lodIndex=i.lodIndex,this.placementId=i.id,this.numSplats=t.numSplats,this.aabb.copy(i.aabb),this.parameters=i.parameters,this.getWorkBufferModifier=()=>i.workBufferModifier,this.getInstanceStreams=()=>i.streams,this._consumeRenderDirty=s,this.updateIntervals(i.intervals);}}function vE(){let e,t,i,s="undefined"!=typeof self&&self||require("node:worker_threads").parentPort,r=new Map,a=false,n=false,o=new Float32Array(33),l=new Float32Array(33),h=new GSplatSortBinWeights,c=(e,t,i,s,a,n,o)=>{let{ids:l,lineStarts:h,padding:c,intervals:d,textureSize:u}=n,f=32/i;for(let n=0;n<e.length;n++){let p=e[n],m=l[n],_=r.get(m),g=h[n]*u,v=d[n].length>0?d[n]:[0,_.length/3];for(let e=0;e<v.length;e+=2)g=o(_,p,3*v[e],3*v[e+1],g,f,t,i,s,a);let S=c[n];a[0]+=S,s.fill(0,g,g+S),g+=S;}};s.addEventListener("message",d=>{let u=d.data??d;switch(u.command){case "addCenters":r.set(u.id,new Float32Array(u.centers));break;case "removeCenters":r.delete(u.id);break;case "sort":{a=u.radialSorting||false;let r=new Uint32Array(u.order);((e,r,d)=>{let u=performance.now(),{minDist:f,maxDist:p}=a?(e=>{let t=-1/0;for(let i=0;i<e.length;i++){let{transformedPosition:s,scale:r,aabbMin:a,aabbMax:n}=e[i],o=s.x,l=s.y,h=s.z;for(let e=0;e<8;e++){let i=1&e?n[0]:a[0],s=2&e?n[1]:a[1],c=4&e?n[2]:a[2],d=i-o,u=s-l,f=c-h,p=Math.sqrt(d*d+u*u+f*f)*r;p>t&&(t=p);}}return t<0&&(t=0),{minDist:0,maxDist:t}})(e):(e=>{let t=1/0,i=-1/0;for(let s=0;s<e.length;s++){let{transformedDirection:r,offset:a,scale:n,aabbMin:o,aabbMax:l}=e[s],h=r.x,c=r.y,d=r.z,u=h>=0?o[0]:l[0],f=c>=0?o[1]:l[1],p=d>=0?o[2]:l[2],m=h>=0?l[0]:o[0],_=c>=0?l[1]:o[1],g=d>=0?l[2]:o[2],v=(u*h+f*c+p*d)*n+a,S=(m*h+_*c+g*d)*n+a,y=Math.min(v,S),x=Math.max(v,S);y<t&&(t=y),x>i&&(i=x);}return t===1/0&&(t=0,i=0),{minDist:t,maxDist:i}})(e),m=d.totalUsedPixels,_=Math.max(10,Math.min(20,Math.round(Math.log2(m/4)))),g=2**_+1;t?.length!==m&&(t=new Uint32Array(m)),i&&i.length===g?i.fill(0):i=new Uint32Array(g);let v=p-f,S=GSplatSortBinWeights.computeCameraBin(a,f,v);var y=h.compute(S,g);for(let e=0;e<32;e++)o[e]=y[2*e],l[e]=y[2*e+1];(o[32]=o[31]+l[31],l[32]=0,a)?c(e,f,v,t,i,d,(e,t,i,s,r,a,n,h,c,d)=>{let{transformedPosition:u,scale:f}=t,p=u.x,m=u.y,_=u.z;for(let t=i;t<s;t+=3){let i=e[t]-p,s=e[t+1]-m,n=e[t+2]-_,u=(h-Math.sqrt(i*i+s*s+n*n)*f)*a,g=u>>>0,v=o[g]+l[g]*(u-g)>>>0;c[r++]=v,d[v]++;}return r}):c(e,f,v,t,i,d,(e,t,i,s,r,a,n,h,c,d)=>{let{transformedDirection:u,offset:f,scale:p}=t,m=u.x,_=u.y,g=u.z,v=m*p,S=_*p,y=g*p,x=f-n;for(let t=i;t<s;t+=3){let i=(e[t]*v+e[t+1]*S+e[t+2]*y+x)*a,s=i>>>0,n=o[s]+l[s]*(i-s)>>>0;c[r++]=n,d[n]++;}return r});var x=i,T=t;for(let e=1;e<g;e++)x[e]+=x[e-1];x[g-1]===m||n||(n=true);for(let e=0;e<m;e++){let t=T[e];r[--x[t]]=e;}let E=performance.now()-u,w=[r.buffer],b={order:r.buffer,count:m,version:d.version,sortTime:E};s.postMessage(b,w);})(u.sortParams,r,e);break}case "intervals":e=u;}});}let vw=class e{static get NUM_BINS(){return 32}static get WEIGHT_TIERS(){return [{maxDistance:0,weight:40},{maxDistance:2,weight:20},{maxDistance:5,weight:8},{maxDistance:10,weight:3},{maxDistance:1/0,weight:1}]}static computeCameraBin(t,i,s){let r=e.NUM_BINS;return t?r-1:Math.max(0,Math.min(r-1,Math.floor(-i/s*r)))}compute(t,i){if(t===this.lastCameraBin&&i===this.lastBucketCount)return this.binWeights;this.lastCameraBin=t,this.lastBucketCount=i;let s=e.NUM_BINS,r=this.bitsPerBin;for(let e=0;e<s;e++){let i=Math.abs(e-t);r[e]=this.weightByDistance[i];}let a=0;for(let e=0;e<s;e++)a+=r[e];let n=0;for(let e=0;e<s;e++){let t=Math.max(1,Math.floor(r[e]/a*i));this.binWeights[2*e]=n,this.binWeights[2*e+1]=t,n+=t;}if(n>i){let e=n-i,t=(s-1)*2+1;this.binWeights[t]=Math.max(1,this.binWeights[t]-e);}return this.binWeights}constructor(){this.binWeights=new Float32Array(2*e.NUM_BINS),this.lastCameraBin=-1,this.lastBucketCount=-1;let t=e.NUM_BINS,i=e.WEIGHT_TIERS;this.bitsPerBin=new Float32Array(t),this.weightByDistance=new Float32Array(t);for(let e=0;e<t;e++){let t=1;for(let s=0;s<i.length;s++)if(e<=i[s].maxDistance){t=i[s].weight;break}this.weightByDistance[e]=t;}}},vb=new Set;class vA extends X{onSorted(e){if(this._destroyed)return;let t=e.data??e;this.scene&&void 0!==t.sortTime&&this.scene.fire("gsplat:sorted",t.sortTime);let i=new Uint32Array(t.order);this.jobsInFlight--,this.pendingSorted&&this.releaseOrderData(this.pendingSorted.orderData),this.pendingSorted={count:t.count,version:t.version,orderData:i};}applyPendingSorted(){if(this.pendingSorted){let{count:e,version:t,orderData:i}=this.pendingSorted;this.pendingSorted=null,this.fire("sorted",e,t,i),this.releaseOrderData(i);}}releaseOrderData(e){e.length===this.bufferLength&&this.availableOrderData.push(e);}destroy(){this._destroyed=true,this.pendingSorted=null,this.worker.terminate(),this.worker=null;}setCenters(e,t){if(t){if(!this.centersSet.has(e)){this.centersSet.add(e);let i=t.buffer.slice();this.worker.postMessage({command:"addCenters",id:e,centers:i},[i]);}}else this.centersSet.has(e)&&(this.centersSet.delete(e),this.worker.postMessage({command:"removeCenters",id:e}));}updateCentersForSplats(e){for(let t of e){let e=t.resource.id;vb.add(e),this.centersSet.has(e)||this.setCenters(e,t.resource.centers);}for(let e of this.centersSet)vb.has(e)||this.setCenters(e,null);vb.clear();}setSortParameters(e){this.hasNewVersion=true;let{textureSize:t}=e,i=t*t;i!==this.bufferLength&&(this.bufferLength=i,this.availableOrderData.length=0),this.worker.postMessage(e);}setSortParams(e,t){if(this.hasNewVersion||0===this.jobsInFlight){let i=this.availableOrderData.pop();i||(i=new Uint32Array(this.bufferLength)),this.jobsInFlight++,this.hasNewVersion=false,this.worker.postMessage({command:"sort",sortParams:e,radialSorting:t,order:i.buffer},[i.buffer]);}}constructor(e){super(),this.bufferLength=0,this.availableOrderData=[],this.jobsInFlight=0,this.hasNewVersion=false,this.pendingSorted=null,this.centersSet=new Set,this._destroyed=false,this.scene=null,this.scene=e??null;let t=`
						const GSplatSortBinWeights = ${vw.toString()};
						(${vE.toString()})()
				`;"node"===k.environment?(this.worker=new Worker(t,{eval:true}),this.worker.on("message",this.onSorted.bind(this))):(this.worker=new Worker(URL.createObjectURL(new Blob([t],{type:"application/javascript"}))),this.worker.addEventListener("message",this.onSorted.bind(this)));}}class vC{setRenderMode(e){let t=this.renderMode??0,i=(1&t)!=0,s=(2&t)!=0,r=(1&e)!=0,a=(2&e)!=0;this.meshInstance.castShadow=a,i&&!r&&this.layer.removeMeshInstances([this.meshInstance],true),s&&!a&&this.layer.removeShadowCasters([this.meshInstance]),!i&&r&&this.layer.addMeshInstances([this.meshInstance],true),!s&&a&&this.layer.addShadowCasters([this.meshInstance]),this.renderMode=e;}destroy(){this.renderMode&&(1&this.renderMode&&this.layer.removeMeshInstances([this.meshInstance],true),2&this.renderMode&&this.layer.removeShadowCasters([this.meshInstance])),this._material.destroy(),this.meshInstance.destroy();}get material(){return this._material}configureMaterial(){let{device:e,workBuffer:t}=this;this._injectFormatChunks(),this._material.setDefine("STORAGE_ORDER",e.isWebGPU),this._material.setDefine("SH_BANDS","0");let i=t.format.getStream("dataColor");i&&47!==i.format&&this._material.setDefine("GSPLAT_COLOR_FLOAT",""),this._updateIdDefines(),this._bindWorkBufferTextures(),this._material.setParameter("numSplats",0),t.orderTexture&&this._material.setParameter("splatOrder",t.orderTexture),this._material.setParameter("alphaClip",.3),this._material.setDefine("DITHER_NONE",""),this._material.cull=0,this._material.blendType=4,this._material.depthWrite=false,this._material.update();}_bindWorkBufferTextures(){let{workBuffer:e}=this;for(let t of e.format.resourceStreams){let i=e.getTexture(t.name);i&&this._material.setParameter(t.name,i);}}_injectFormatChunks(){let e=this.device.isWebGPU?this._material.shaderChunks.wgsl:this._material.shaderChunks.glsl,t=this.workBuffer.format;e.set("gsplatDeclarationsVS",t.getInputDeclarations()),e.set("gsplatReadVS",t.getReadCode());}update(e,t){this.meshInstance.instancingCount=Math.ceil(e/ux.instanceSize),this._material.setParameter("numSplats",e),this._material.setParameter("splatTextureSize",t),this.meshInstance.visible=e>0;}setOrderData(){this.device.isWebGPU?this._material.setParameter("splatOrder",this.workBuffer.orderBuffer):this._material.setParameter("splatOrder",this.workBuffer.orderTexture);}setOrderBuffer(e){this._material.setParameter("splatOrder",e);}frameUpdate(e){e.colorRamp&&this._material.setParameter("colorRampIntensity",e.colorRampIntensity),this._syncWithWorkBufferFormat(),(this.forceCopyMaterial||e.material.dirty)&&(this.copyMaterialSettings(e.material),this.forceCopyMaterial=false);}_updateIdDefines(){let e=!!this.workBuffer.format.getStream("pcId");this._material.setDefine("GSPLAT_UNIFIED_ID",e),this._material.setDefine("PICK_CUSTOM_ID",e);}_syncWithWorkBufferFormat(){let e=this.workBuffer.format;this._workBufferFormatVersion!==e.extraStreamsVersion&&(this._workBufferFormatVersion=e.extraStreamsVersion,this.workBuffer.syncWithFormat(),this._injectFormatChunks(),this._bindWorkBufferTextures(),this._updateIdDefines(),this._material.update());}copyMaterialSettings(e){let t=[];this._material.defines.forEach((e,i)=>{this._internalDefines.has(i)||t.push(i);}),t.forEach(e=>this._material.defines.delete(e)),e.defines.forEach((e,t)=>{this._material.defines.set(t,e);});let i=e.parameters;for(let e in i)i.hasOwnProperty(e)&&this._material.setParameter(e,i[e].data);e.hasShaderChunks&&this._material.shaderChunks.copy(e.shaderChunks),this._injectFormatChunks(),this._material.update();}updateOverdrawMode(e){let t=!!e.colorRamp,i=this._material.getDefine("GSPLAT_OVERDRAW");t&&(this._material.setParameter("colorRamp",e.colorRamp),this._material.setParameter("colorRampIntensity",e.colorRampIntensity)),t!==i&&(this._material.setDefine("GSPLAT_OVERDRAW",t),t?(this.originalBlendType=this._material.blendType,this._material.blendType=1):this._material.blendType=this.originalBlendType,this._material.update());}setMaxNumSplats(e){let t=ei.roundUp(e,ux.instanceSize);this.instanceIndicesCount<t&&(this.instanceIndicesCount=t,this.instanceIndices?.destroy(),this.instanceIndices=ux.createInstanceIndices(this.device,e),this.meshInstance.setInstancing(this.instanceIndices,true),this._material.setParameter("splatTextureSize",this.workBuffer.textureSize));}createMeshInstance(){let e=ux.createMesh(this.device),t=this.workBuffer.textureSize,i=ux.createInstanceIndices(this.device,t*t),s=new od(e,this._material);s.node=this.node,s.setInstancing(i,true),s.instancingCount=0;let r=this.cameraNode.camera;return s.isVisibleFunc=e=>{let t=this.renderMode??0;return r.camera===e&&!!(1&t)||!!(2&t)&&e.node?.name===nM},s}constructor(e,t,i,s,r){this.instanceIndices=null,this.instanceIndicesCount=0,this.originalBlendType=1,this._internalDefines=new Set,this.forceCopyMaterial=true,this._workBufferFormatVersion=-1,this.device=e,this.node=t,this.cameraNode=i,this.layer=s,this.workBuffer=r,this._workBufferFormatVersion=r.format.extraStreamsVersion,this._material=new cf({uniqueName:"UnifiedSplatMaterial",vertexGLSL:'#include "gsplatVS"',fragmentGLSL:'#include "gsplatPS"',vertexWGSL:'#include "gsplatVS"',fragmentWGSL:'#include "gsplatPS"',attributes:{vertex_position:e6,vertex_id_attrib:tb}}),this.configureMaterial(),this._material.defines.forEach((e,t)=>{this._internalDefines.add(t);}),this._internalDefines.add("GSPLAT_UNIFIED_ID"),this._internalDefines.add("PICK_CUSTOM_ID"),this.meshInstance=this.createMeshInstance();}}class vP{destroy(){this._streams?.destroy(),this._streams=null,this.intervals.clear(),this.resource=null;}set workBufferModifier(e){this._workBufferModifier=e,this.renderDirty=true;}get workBufferModifier(){return this._parentPlacement?.workBufferModifier??this._workBufferModifier}consumeRenderDirty(){let e=this.resource?.format;e&&this._lastFormatVersion!==e.extraStreamsVersion&&(this._lastFormatVersion=e.extraStreamsVersion,this.renderDirty=true),2===this.workBufferUpdate?this.renderDirty=true:1===this.workBufferUpdate&&(this.renderDirty=true,this.workBufferUpdate=0);let t=this.renderDirty;return this.renderDirty=false,t}set aabb(e){this._aabb=e?.clone()??null;}get aabb(){return this._aabb??this.resource?.aabb}set lodDistances(e){this.resource&&this.resource.octree&&(e?(this.resource.octree?.lodLevels,this._lodDistances=e.slice()):this._lodDistances=null);}get lodDistances(){return this._lodDistances?this._lodDistances.slice():null}getInstanceTexture(e,t){let i=this.resource;if(i?.format)return !this._streams&&i.format.instanceStreams.length>0&&(this._streams=new up(t,true),this._streams.textureDimensions.copy(i.streams.textureDimensions),this._streams.syncWithFormat(i.format)),this._streams?.getTexture(e)}get streams(){return this._parentPlacement?.streams??this._streams}ensureInstanceStreams(e){let t=this.resource;t?.format&&!this._streams&&t.format.instanceStreams.length>0&&(this._streams=new up(e,true),this._streams.textureDimensions.copy(t.streams.textureDimensions),this._streams.syncWithFormat(t.format));}constructor(e,t,i=0,s=null,r=null,a=null){this.intervals=new Map,this.id=0,this.lodIndex=0,this._lodDistances=null,this.splatBudget=0,this._aabb=null,this.parameters=null,this._streams=null,this.renderDirty=false,this.workBufferUpdate=0,this._lastFormatVersion=-1,this._workBufferModifier=null,this._parentPlacement=null,this.id=a??r?.id??0,this.resource=e,this.node=t,this.lodIndex=i,this.parameters=s??r?.parameters??null,this._parentPlacement=r;}}let vI=new ey,vD=new ed,vR=new ed,vL=new ed,vM=[];new eC,new es(1,0,0),new es(0,1,0),new es(0,0,1),new es(1,1,0),new es(1,0,1);class vO{reset(){this.currentLod=-1,this.optimalLod=-1,this.importance=0;}constructor(){this.currentLod=-1,this.optimalLod=-1,this.importance=0;}}class vF{get pendingLoadCount(){let e=this.pending.size+this.prefetchPending.size;return this.octree.environmentUrl&&!this.environmentPlacement&&e++,e}destroy(){if(this.octree&&!this.octree.destroyed){for(let e of this.getFileDecrements())this.octree.decRefCount(e,0);for(let e of this.pending)this.filePlacements[e]||this.octree.unloadResource(e);for(let e of this.prefetchPending)this.filePlacements[e]||this.octree.unloadResource(e);this.environmentPlacement&&this.octree.decEnvironmentRefCount();}this.pending.clear(),this.pendingDecrements.clear(),this.filePlacements.length=0,this.environmentPlacement&&(this.activePlacements.delete(this.environmentPlacement),this.environmentPlacement=null),this._deviceLostEvent?.off(),this._deviceLostEvent=null;}_onDeviceLost(){for(let e=0;e<this.filePlacements.length;e++)this.filePlacements[e]&&this.octree.decRefCount(e,0);for(let e of(this.filePlacements.fill(null),this.activePlacements.clear(),this.pending.clear(),this.pendingDecrements.clear(),this.removedCandidates.clear(),this.prefetchPending.clear(),this.pendingVisibleAdds.clear(),this.nodeInfos))e.reset();this.environmentPlacement&&(this.activePlacements.delete(this.environmentPlacement),this.environmentPlacement=null,this.octree.unloadEnvironmentResource()),this.dirtyModifiedPlacements=true,this.needsLodUpdate=true;}getFileDecrements(){let e=[];for(let t=0;t<this.filePlacements.length;t++)this.filePlacements[t]&&e.push(t);return e}calculateNodeLod(e,t,i,s,r,a){this.octree.nodes[i].bounds.closestPoint(e,vL),vL.sub(e);let n=vL.length();if(a>1&&n>.01){let e=t.dot(vL)/n;e<0&&(n*=1+-e*(a-1));}for(let e=0;e<s;e++)if(n<r[e])return e;return s}selectDesiredLodIndex(e,t,i,s){if(s>0){let r=Math.min(i,t+s);for(let i=t;i<=r;i++){let t=e.lods[i].fileIndex;if(-1!==t&&this.octree.getFileResource(t))return i}for(let i=r;i>=t;i--)if(-1!==e.lods[i].fileIndex)return i}return t}prefetchNextLod(e,t,i){if(-1===t||-1===i)return;if(t===i){let t=e.lods[i].fileIndex;-1!==t&&(this.octree.ensureFileResource(t),this.octree.getFileResource(t)||this.prefetchPending.add(t));return}let s=Math.max(i,t-1);for(let t=s;t>=i;t--){let i=e.lods[t].fileIndex;if(-1!==i){this.octree.ensureFileResource(i),this.octree.getFileResource(i)||this.prefetchPending.add(i);break}}}updateLod(e,t){let i=this.octree.lodLevels-1,s=this.placement.lodDistances||[5,10,15,20,25,30,35,40,45,50,55,60],{lodRangeMin:r,lodRangeMax:a}=t,n=Math.max(0,Math.min(r??0,i)),o=Math.max(n,Math.min(a??i,i)),l=this.evaluateNodeLods(e,i,s,n,o,t);this.splatBudget>0&&this.enforceSplatBudget(l,this.splatBudget,n,o),this.applyLodChanges(i,t);}evaluateNodeLods(e,t,i,s,r,a){let{lodBehindPenalty:n}=a,o=e.getPosition(),l=this.placement.node.getWorldTransform();vI.copy(l).invert();let h=vI.transformPoint(o,vD),c=e.forward,d=vI.transformVector(c,vR).normalize(),u=this.octree.nodes,f=this.nodeInfos,p=0,m=i[r]||100;for(let e=0;e<u.length;e++){u[e].bounds.closestPoint(h,vL),vL.sub(h);let a=vL.length(),o=a,l=1;if(n>1&&a>.01){let e=d.dot(vL)/a;if(e<0){let t=1+-e*(n-1);o=a*t,l=1/t;}}let c=t;for(let e=0;e<t;e++)if(o<i[e]){c=e;break}c<s&&(c=s),c>r&&(c=r);let _=(1-Math.min(a/m,1))*l;f[e].optimalLod=c,f[e].importance=_;let g=u[e].lods[c];g&&g.count&&(p+=g.count);}return p}enforceSplatBudget(e,t,i,s){let r=this.octree.nodes,a=this.nodeInfos;if(!this._nodeIndices){this._nodeIndices=new Uint32Array(r.length);for(let e=0;e<r.length;e++)this._nodeIndices[e]=e;}let n=this._nodeIndices;n.sort((e,t)=>a[e].importance-a[t].importance);let o=e;if(o===t)return;let l=o>t,h=l?1:-1;for(;l?o>t:o<t;){let e=false;if(l)for(let i=0;i<n.length;i++){let l=n[i],c=a[l],d=r[l],u=c.optimalLod;if(u<s){let i=d.lods[u],s=d.lods[u+1],r=i.count-s.count;if(c.optimalLod+=h,e=true,(o-=r)<=t)break}}else for(let s=n.length-1;s>=0;s--){let l=n[s],c=a[l],d=r[l],u=c.optimalLod;if(u>i){let i=d.lods[u],s=d.lods[u-1].count-i.count;if(o+s<=t&&(c.optimalLod+=h,e=true,(o+=s)>=t))break}}if(!e)break}}applyLodChanges(e,t){let i=this.octree.nodes,{lodUnderfillLimit:s=0}=t;for(let t=0;t<i.length;t++){let r=i[t],a=this.nodeInfos[t],n=a.optimalLod,o=a.currentLod,l=this.selectDesiredLodIndex(r,n,e,s);if(l!==o){let e=o>=0?r.lods[o].fileIndex:-1,i=l>=0?r.lods[l].fileIndex:-1,s=-1!==e,n=-1!==i,h=this.pendingDecrements.get(t);if(h&&h.newFileIndex!==i&&(this.filePlacements[h.newFileIndex]&&this.decrementFileRef(h.newFileIndex,t),s&&n?this.pendingDecrements.set(t,{oldFileIndex:h.oldFileIndex,newFileIndex:i}):this.pendingDecrements.delete(t)),!s&&n){let e=this.pendingVisibleAdds.get(t);void 0!==e&&e!==i&&(this.decrementFileRef(e,t),this.pendingVisibleAdds.delete(t)),this.incrementFileRef(i,t,l);let s=this.filePlacements[i];s?.resource?(a.currentLod=l,this.pendingVisibleAdds.delete(t)):this.pendingVisibleAdds.set(t,i);}else if(s&&!n){let i=this.pendingDecrements.get(t);i&&(this.decrementFileRef(i.newFileIndex,t),this.pendingDecrements.delete(t)),this.decrementFileRef(e,t),a.currentLod=-1,this.pendingVisibleAdds.delete(t);}else if(s&&n){this.incrementFileRef(i,t,l);let s=this.filePlacements[i];s?.resource?(this.decrementFileRef(e,t),this.pendingDecrements.delete(t),a.currentLod=l):this.pendingDecrements.set(t,{oldFileIndex:e,newFileIndex:i}),this.pendingVisibleAdds.delete(t);}}this.prefetchNextLod(r,l,n);}}incrementFileRef(e,t,i){if(-1===e)return;let s=this.filePlacements[e];!s&&(s=new vP(null,this.placement.node,i,null,this.placement),this.filePlacements[e]=s,this.removedCandidates.delete(e)||this.octree.incRefCount(e),this.addFilePlacement(e)||(this.octree.ensureFileResource(e),this.pending.add(e)));let r=this.octree.nodes[t].lods[i],a=new ef(r.offset,r.offset+r.count-1);s.intervals.set(t,a),this.dirtyModifiedPlacements=true;}decrementFileRef(e,t){if(-1===e)return;let i=this.filePlacements[e];i&&i&&(i.intervals.delete(t),this.dirtyModifiedPlacements=true,0===i.intervals.size&&(i.resource&&this.activePlacements.delete(i),this.removedCandidates.add(e),this.filePlacements[e]=null,this.pending.delete(e)));}addFilePlacement(e){let t=this.octree.getFileResource(e);if(t){let i=this.filePlacements[e];if(i)return i.resource=t,this.activePlacements.add(i),this.dirtyModifiedPlacements=true,this.removedCandidates.delete(e),true}return  false}testMoved(e){return this.placement.node.getPosition().distance(this.previousPosition)>e}updateMoved(){this.previousPosition.copy(this.placement.node.getPosition());}update(e){let t=this.placement.splatBudget;if(t!==this.splatBudget&&(this.splatBudget=t,this.needsLodUpdate=true),this.pending.size){for(let e of this.pending)if(this.octree.ensureFileResource(e),this.addFilePlacement(e)){for(let[t,{oldFileIndex:i,newFileIndex:s}]of(vM.push(e),this.pendingDecrements))if(s===e){this.decrementFileRef(i,t),this.pendingDecrements.delete(t);let e=0,r=this.octree.nodes[t].lods;for(let t=0;t<r.length;t++)if(r[t].fileIndex===s){e=t;break}this.nodeInfos[t].currentLod=e;}}for(let e of(vM.length>0&&(this.needsLodUpdate=true),vM))this.pending.delete(e);vM.length=0;}if(this.pollPrefetchCompletions(),this.octree.environmentUrl&&!this.environmentPlacement){this.octree.ensureEnvironmentResource();let e=this.octree.environmentResource;e&&(this.environmentPlacement=new vP(e,this.placement.node,0,null,this.placement),this.environmentPlacement.aabb.copy(e.aabb),this.activePlacements.add(this.environmentPlacement),this.dirtyModifiedPlacements=true);}let i=this.dirtyModifiedPlacements;return this.dirtyModifiedPlacements=false,i}debugRender(e){}consumeNeedsLodUpdate(){let e=this.needsLodUpdate;return this.needsLodUpdate=false,e}pollPrefetchCompletions(){if(this.prefetchPending.size){for(let e of this.prefetchPending)this.octree.ensureFileResource(e),this.octree.getFileResource(e)&&vM.push(e);for(let e of(vM.length>0&&(this.needsLodUpdate=true),vM))this.prefetchPending.delete(e);vM.length=0;}}constructor(e,t,i){this.activePlacements=new Set,this.dirtyModifiedPlacements=false,this.pending=new Set,this.pendingDecrements=new Map,this.removedCandidates=new Set,this.previousPosition=new ed,this.needsLodUpdate=false,this.prefetchPending=new Set,this.pendingVisibleAdds=new Map,this.splatBudget=0,this._nodeIndices=null,this.environmentPlacement=null,this._deviceLostEvent=null,this.device=e,this.octree=t,this.placement=i,this.nodeInfos=Array(t.nodes.length);for(let e=0;e<t.nodes.length;e++)this.nodeInfos[e]=new vO;let s=t.files.length;this.filePlacements=Array(s).fill(null),t.environmentUrl&&(t.incEnvironmentRefCount(),t.ensureEnvironmentResource()),this._deviceLostEvent=e.on("devicelost",this._onDeviceLost,this);}}let vN=new ed,vB=new ed;class vk{constructor(e,t){this.bounds=new eC,this.lods=e,vN.set(t.min[0],t.min[1],t.min[2]),vB.set(t.max[0],t.max[1],t.max[2]),this.bounds.setMinMax(vN,vB);}}let vU=[];class vz{destroy(){this.destroyed=true,this.fileResources.clear(),this.cooldowns.clear(),this.assetLoader?.destroy(),this.assetLoader=null,this.environmentResource=null;}_traceLodCounts(){}_extractLeafNodes(e,t){if(e.lods)t.push({lods:e.lods,bound:e.bound});else if(e.children)for(let i of e.children)this._extractLeafNodes(i,t);}getFileResource(e){return this.fileResources.get(e)}incRefCount(e){let t=this.fileRefCounts[e]+1;this.fileRefCounts[e]=t,this.cooldowns.delete(e);}decRefCount(e,t){let i=this.fileRefCounts[e]-1;this.fileRefCounts[e]=i,0===i&&(0===t?this.unloadResource(e):this.cooldowns.set(e,t));}unloadResource(e){if(!this.assetLoader)return;let t=this.files[e].url;this.assetLoader.unload(t),this.fileResources.has(e)&&(this.fileResources.delete(e),this._traceLodCounts());}updateCooldownTick(e){this.cooldownTicks=e,this.cooldowns.size>0&&(this.cooldowns.forEach((e,t)=>{e<=1?(0===this.fileRefCounts[t]&&this.unloadResource(t),vU.push(t)):this.cooldowns.set(t,e-1);}),vU.forEach(e=>this.cooldowns.delete(e)),vU.length=0);}ensureFileResource(e){if(this.fileResources.has(e))return;let t=this.files[e].url,i=this.assetLoader?.getResource(t);if(i){this.fileResources.set(e,i),0===this.fileRefCounts[e]&&this.cooldowns.set(e,this.cooldownTicks),this._traceLodCounts();return}this.assetLoader?.load(t);}incEnvironmentRefCount(){this.environmentRefCount++;}decEnvironmentRefCount(){this.environmentRefCount--,0===this.environmentRefCount&&this.unloadEnvironmentResource();}ensureEnvironmentResource(){if(!this.assetLoader||!this.environmentUrl||this.environmentResource)return;let e=this.assetLoader.getResource(this.environmentUrl);if(e){this.environmentResource=e,0===this.environmentRefCount&&this.unloadEnvironmentResource();return}this.assetLoader.load(this.environmentUrl);}unloadEnvironmentResource(){this.assetLoader&&this.environmentResource&&this.environmentUrl&&(this.assetLoader.unload(this.environmentUrl),this.environmentResource=null);}constructor(e,t){this.fileResources=new Map,this.cooldowns=new Map,this.environmentUrl=null,this.environmentResource=null,this.environmentRefCount=0,this.assetLoader=null,this.destroyed=false,this.cooldownTicks=100,this.lodLevels=t.lodLevels,this.assetFileUrl=e;let i=P.getDirectory(e);this.files=t.filenames.map(e=>({url:P.isRelativePath(e)?P.join(i,e):e,lodLevel:-1})),this.fileRefCounts=new Int32Array(this.files.length),t.environment&&(this.environmentUrl=P.isRelativePath(t.environment)?P.join(i,t.environment):t.environment);let s=[];this._extractLeafNodes(t.tree,s),this.nodes=s.map(e=>{let t=[];for(let i=0;i<this.lodLevels;i++){let s=e.lods[i.toString()];s?(t.push({file:this.files[s.file].url||"",fileIndex:s.file,offset:s.offset||0,count:s.count||0}),this.files[s.file].lodLevel=i):t.push({file:"",fileIndex:-1,offset:0,count:0});}return new vk(t,e.bound)});}}class vV{destroy(){this.octree?.destroy(),this.octree=null;}constructor(e,t,i){this.aabb=new eC,this.centersVersion=0,this.octree=new vz(e,t),this.octree.assetLoader=i,this.aabb.setMinMax(new ed(t.tree.bound.min),new ed(t.tree.bound.max));}}class vG{estimateTextureSize(e,t){let i=t=>{let i=0;for(let s of e)if((i+=Math.ceil(s.activeSplats/t))>t)return  false;return  true},s=1,r=t,a=null;for(;s<=r;){let e=Math.floor((s+r)/2);i(e)?(a=e,r=e-1):s=e+1;}return null===a?(this.textureSize=0,false):(this.textureSize=a,true)}destroy(){this.splats.forEach(e=>e.destroy()),this.splats.length=0;}assignLines(e,t){if(0===e.length){this.totalUsedPixels=0;return}let i=0;for(let s of e){let e=s.activeSplats,r=Math.ceil(e/t);s.setLines(i,r,t,e),i+=r;}this.totalUsedPixels=i*t;}constructor(e,t,i){this.version=0,this.sortParametersSet=false,this.sortedBefore=false,this.splats=[],this.textureSize=0,this.totalUsedPixels=0,this.pendingReleases=[],this.version=t,this.splats=i,this.estimateTextureSize(this.splats,e.maxTextureSize),this.assignLines(this.splats,this.textureSize);}}class vH{hasChanges(e){let t=false;for(let i of e){if(!i.resource)continue;let e=i.resource.format?.extraStreamsVersion??0,s=i.workBufferModifier?.hash??0,r=i.resource.numSplats??0,a=i.resource.centersVersion,n=this._states.get(i);n?(n.formatVersion!==e||n.modifierHash!==s||n.numSplats!==r||n.centersVersion!==a)&&(n.formatVersion=e,n.modifierHash=s,n.numSplats=r,n.centersVersion=a,t=true):(this._states.set(i,{formatVersion:e,modifierHash:s,numSplats:r,centersVersion:a}),t=true);}return t}constructor(){this._states=new WeakMap;}}let vW=`
@group(0) @binding(0) var dataTransformA: texture_2d<u32>;
@group(0) @binding(1) var<storage, read_write> sortKeys: array<u32>;
struct SortKeyUniforms {
	cameraPosition: vec3f,
	elementCount: u32,
	cameraDirection: vec3f,
	numBits: u32,
	textureSize: u32,
	minDist: f32,
	invRange: f32,
	numWorkgroupsX: u32,
	numBins: u32
};
@group(0) @binding(2) var<uniform> uniforms: SortKeyUniforms;
struct BinWeight {
	base: f32,
	divider: f32
};
@group(0) @binding(3) var<storage, read> binWeights: array<BinWeight>;
@compute @workgroup_size({WORKGROUP_SIZE_X}, {WORKGROUP_SIZE_Y}, 1)
fn computeSortKey(@builtin(global_invocation_id) global_id: vec3u) {
	let gid = global_id.x + global_id.y * ({WORKGROUP_SIZE_X} * uniforms.numWorkgroupsX);
	
	if (gid >= uniforms.elementCount) {
		return;
	}
	
	let textureSize = uniforms.textureSize;
	let uv = vec2i(i32(gid % textureSize), i32(gid / textureSize));
	
	let packed = textureLoad(dataTransformA, uv, 0);
	let worldCenter = vec3f(
		bitcast<f32>(packed.r),
		bitcast<f32>(packed.g),
		bitcast<f32>(packed.b)
	);
	
	var dist: f32;
	
	#ifdef RADIAL_SORT
		let delta = worldCenter - uniforms.cameraPosition;
		let radialDist = length(delta);
		dist = (1.0 / uniforms.invRange) - radialDist - uniforms.minDist;
	#else
		let toSplat = worldCenter - uniforms.cameraPosition;
		dist = dot(toSplat, uniforms.cameraDirection) - uniforms.minDist;
	#endif
	
	let numBins = uniforms.numBins;
	let d = dist * uniforms.invRange * f32(numBins);
	let binFloat = clamp(d, 0.0, f32(numBins) - 0.001);
	let bin = u32(binFloat);
	let binFrac = binFloat - f32(bin);
	
	let sortKey = u32(binWeights[bin].base + binWeights[bin].divider * binFrac);
	
	sortKeys[gid] = sortKey;
}
`,vX=new ed;class vY{destroy(){this.keysBuffer?.destroy(),this.binWeightsBuffer?.destroy(),this.compute?.shader?.destroy(),this.bindGroupFormat?.destroy(),this.keysBuffer=null,this.binWeightsBuffer=null,this.compute=null,this.bindGroupFormat=null,this.uniformBufferFormat=null;}_getCompute(e){if(!this.compute||this.computeRadialSort!==e){this.compute?.shader?.destroy();let t=e?"GSplatSortKeyCompute-Radial":"GSplatSortKeyCompute-Linear",i=new Map([["{WORKGROUP_SIZE_X}","16"],["{WORKGROUP_SIZE_Y}","16"]]);e&&i.set("RADIAL_SORT","");let s=new rd(this.device,{name:t,shaderLanguage:tV,cshader:vW,cdefines:i,computeEntryPoint:"computeSortKey",computeBindGroupFormat:this.bindGroupFormat,computeUniformBufferFormats:{uniforms:this.uniformBufferFormat}});this.compute=new r6(this.device,s,t),this.computeRadialSort=e;}return this.compute}_createBindGroupFormat(){let e=this.device;this.uniformBufferFormat=new sf(e,[new su("cameraPosition",4),new su("elementCount",26),new su("cameraDirection",4),new su("numBits",26),new su("textureSize",26),new su("minDist",2),new su("invRange",2),new su("numWorkgroupsX",26),new su("numBins",26)]),this.bindGroupFormat=new it(e,[new t7("dataTransformA",4,void 0,4,false),new t9("sortKeys",4,false),new t6("uniforms",4),new t9("binWeights",4,true)]);}_ensureCapacity(e){e>this.allocatedCount&&(this.keysBuffer?.destroy(),this.allocatedCount=e,this.keysBuffer=new rI(this.device,4*e,4));}generate(e,t,i,s,r,a,n){this._ensureCapacity(s);let o=Math.ceil(s/256),l=Math.min(o,this.device.limits.maxComputeWorkgroupsPerDimension||65535),h=Math.ceil(o/l),c=this._getCompute(i),d=t.getPosition(),u=t.getWorldTransform().getZ(vX).normalize(),f=n-a,p=vw.computeCameraBin(i,a,f),m=this.binWeightsUtil.compute(p,1<<r);return this.binWeightsBuffer.write(0,m),c.setParameter("dataTransformA",e.getTexture("dataTransformA")),c.setParameter("sortKeys",this.keysBuffer),c.setParameter("binWeights",this.binWeightsBuffer),this.cameraPositionData[0]=d.x,this.cameraPositionData[1]=d.y,this.cameraPositionData[2]=d.z,c.setParameter("cameraPosition",this.cameraPositionData),this.cameraDirectionData[0]=u.x,this.cameraDirectionData[1]=u.y,this.cameraDirectionData[2]=u.z,c.setParameter("cameraDirection",this.cameraDirectionData),c.setParameter("elementCount",s),c.setParameter("numBits",r),c.setParameter("textureSize",e.textureSize),c.setParameter("minDist",a),c.setParameter("invRange",f>0?1/f:1),c.setParameter("numWorkgroupsX",l),c.setParameter("numBins",vw.NUM_BINS),c.setupDispatch(l,h,1),this.device.computeDispatch([c],"GSplatSortKeyCompute"),this.keysBuffer}constructor(e){this.allocatedCount=0,this.keysBuffer=null,this.binWeightsBuffer=null,this.compute=null,this.computeRadialSort=false,this.bindGroupFormat=null,this.uniformBufferFormat=null,this.cameraPositionData=new Float32Array(3),this.cameraDirectionData=new Float32Array(3),this.device=e,this.binWeightsUtil=new vw,this.binWeightsBuffer=new rI(e,2*vw.NUM_BINS*4,12),this._createBindGroupFormat();}}let vq=new ed,v$=new ed,vj=new ed,vK=new ed,vZ=new ey,vQ=new Set,vJ=new Set,v0=[],v1=[],v2={rotationDelta:0,translationDelta:0},v3=new Set,v4=[[1,0,0],[0,1,0],[0,0,1],[1,1,0],[1,0,1],[0,1,1],[1,.5,0],[.5,0,1]];new es(1,0,0),new es(0,1,0),new es(0,0,1),new es(1,1,0),new es(1,0,1),new es(0,1,1),new es(1,.5,0),new es(.5,0,1);let v5=null;class v8{setRenderMode(e){this.renderMode=e,this.renderer.setRenderMode(e);}destroy(){for(let[,e]of(this._destroyed=true,this.worldStates)){for(let t of e.splats)t.resource.decRefCount();e.destroy();}for(let[,e]of(this.worldStates.clear(),this.octreeInstances))e.destroy();for(let e of(this.octreeInstances.clear(),this.octreeInstancesToDestroy))e.destroy();this.octreeInstancesToDestroy.length=0,this.workBuffer.destroy(),this.renderer.destroy(),this.keyGenerator?.destroy(),this.gpuSorter?.destroy(),this.cpuSorter?.destroy();}get material(){return this.renderer.material}createSorter(){let e=new vA(this.scene);return e.on("sorted",(e,t,i)=>{this.onSorted(e,t,i);}),e}reconcile(e){for(let t of(vQ.clear(),e))t.resource instanceof vV?(this.octreeInstances.has(t)||(this.octreeInstances.set(t,new vF(this.device,t.resource.octree,t)),this.hasNewOctreeInstances=true),vJ.add(t)):vQ.add(t);for(let[e,t]of this.octreeInstances)vJ.has(e)||(this.octreeInstances.delete(e),this.layerPlacementsDirty=true,this.octreeInstancesToDestroy.push(t));if(this.layerPlacementsDirty=this.layerPlacements.length!==vQ.size,!this.layerPlacementsDirty)for(let e=0;e<this.layerPlacements.length;e++){let t=this.layerPlacements[e];if(!vQ.has(t)){this.layerPlacementsDirty=true;break}}for(let e of(this.layerPlacements.length=0,vQ))this.layerPlacements.push(e);vQ.clear(),vJ.clear();}updateWorldState(){let e=this._stateTracker.hasChanges(this.layerPlacements);for(let[,t]of this.octreeInstances)this._stateTracker.hasChanges(t.activePlacements)&&(e=true);if(this.layerPlacementsDirty||e||0===this.worldStates.size){this.lastWorldStateVersion++;let e=[],{colorUpdateAngle:t,colorUpdateDistance:i}=this.scene.gsplat;for(let s of this.layerPlacements){s.ensureInstanceStreams(this.device);let r=new vT(this.device,s.resource,s,s.consumeRenderDirty.bind(s));r.resetColorAccumulators(t,i),e.push(r);}for(let[,s]of this.octreeInstances)s.activePlacements.forEach(s=>{if(s.resource){s.ensureInstanceStreams(this.device);let r=new vT(this.device,s.resource,s,s.consumeRenderDirty.bind(s));r.resetColorAccumulators(t,i),e.push(r);}});if(this.cpuSorter)for(let t of e){let e=t.resource;this._centersVersions.get(e.id)!==e.centersVersion&&(this._centersVersions.set(e.id,e.centersVersion),this.cpuSorter.setCenters(e.id,null),this.cpuSorter.setCenters(e.id,e.centers));}this.cpuSorter?.updateCentersForSplats(e);let s=new vG(this.device,this.lastWorldStateVersion,e);for(let e of s.splats)e.resource.incRefCount();for(let[,e]of this.octreeInstances)if(e.removedCandidates&&e.removedCandidates.size){for(let t of e.removedCandidates)s.pendingReleases.push([e.octree,t]);e.removedCandidates.clear();}if(this.octreeInstancesToDestroy.length){for(let e of this.octreeInstancesToDestroy){for(let t of e.getFileDecrements())s.pendingReleases.push([e.octree,t]);e.destroy();}this.octreeInstancesToDestroy.length=0;}this.worldStates.set(this.lastWorldStateVersion,s),this.layerPlacementsDirty=false,this.sortNeeded=true;}}onSorted(e,t,i){this.cleanupOldWorldStates(t),this.sortedVersion=t;let s=this.worldStates.get(t);s&&(s.sortedBefore||(s.sortedBefore=true,this.rebuildWorkBuffer(s,e)),this.workBuffer.setOrderData(i),this.renderer.setOrderData());}rebuildWorkBuffer(e,t){let i=e.textureSize;i!==this.workBuffer.textureSize&&(this.workBuffer.resize(i),this.renderer.setMaxNumSplats(i*i)),this.workBuffer.render(e.splats,this.cameraNode,this.getDebugColors());let{colorUpdateAngle:s,colorUpdateDistance:r}=this.scene.gsplat;if(e.splats.forEach(e=>{e.update(),e.resetColorAccumulators(s,r);}),this.updateColorCameraTracking(),e.pendingReleases&&e.pendingReleases.length){let t=this.scene.gsplat.cooldownTicks;for(let[i,s]of e.pendingReleases)i.decRefCount(s,t);e.pendingReleases.length=0;}this.renderer.update(t,i);}cleanupOldWorldStates(e){for(let t=this.sortedVersion;t<e;t++){let e=this.worldStates.get(t);if(e){for(let t of e.splats)t.resource.decRefCount();this.worldStates.delete(t),e.destroy();}}}applyWorkBufferUpdates(e){let{colorUpdateAngle:t,colorUpdateDistance:i,colorUpdateDistanceLodScale:s,colorUpdateAngleLodScale:r}=this.scene.gsplat,{rotationDelta:a,translationDelta:n}=this.calculateColorCameraDeltas();e.splats.forEach(e=>{if(e.update())v0.push(e),e.resetColorAccumulators(t,i),this.sortNeeded=true;else if(e.hasSphericalHarmonics){e.colorAccumulatedRotation+=a,e.colorAccumulatedTranslation+=n;let o=e.lodIndex??0,l=i*Math.pow(s,o),h=t*Math.pow(r,o);(e.colorAccumulatedRotation>=h||e.colorAccumulatedTranslation>=l)&&(v1.push(e),e.resetColorAccumulators(h,l));}}),v0.length>0&&(this.workBuffer.render(v0,this.cameraNode,this.getDebugColors()),v0.length=0),v1.length>0&&(this.workBuffer.renderColor(v1,this.cameraNode,this.getDebugColors()),v1.length=0);}testCameraMovedForLod(){let e=this.scene.gsplat.lodUpdateDistance,t=this.cameraNode.getPosition(),i=this.lastLodCameraPos.distance(t)>e;if(i)return  true;let s=false,r=this.scene.gsplat.lodUpdateAngle;if(r>0)if(Number.isFinite(this.lastLodCameraFwd.x)){let e=this.cameraNode.forward;s=Math.acos(Math.min(1,Math.max(-1,this.lastLodCameraFwd.dot(e))))>r*ei.DEG_TO_RAD;}else s=true;return i||s}testCameraMovedForSort(){if(this.scene.gsplat.radialSorting){let e=this.cameraNode.getPosition();return this.lastSortCameraPos.distance(e)>.001}if(Number.isFinite(this.lastSortCameraFwd.x)){let e=this.cameraNode.forward;return Math.acos(Math.min(1,Math.max(-1,this.lastSortCameraFwd.dot(e))))>.001}return  true}updateColorCameraTracking(){this.lastColorUpdateCameraPos.copy(this.cameraNode.getPosition()),this.lastColorUpdateCameraFwd.copy(this.cameraNode.forward);}getDebugColors(){if(this.scene.gsplat.colorizeColorUpdate){v5??(v5=[]);let i=Math.random(),s=Math.random(),r=Math.random();for(let a=0;a<v4.length;a++){var e,t;(e=v5)[t=a]??(e[t]=[0,0,0]),v5[a][0]=i,v5[a][1]=s,v5[a][2]=r;}return v5}if(this.scene.gsplat.colorizeLod)return v4}calculateColorCameraDeltas(){if(v2.rotationDelta=0,v2.translationDelta=0,isFinite(this.lastColorUpdateCameraPos.x)){let e=this.cameraNode.forward;v2.rotationDelta=Math.acos(Math.min(1,Math.max(-1,this.lastColorUpdateCameraFwd.dot(e))))*ei.RAD_TO_DEG;let t=this.cameraNode.getPosition();v2.translationDelta=this.lastColorUpdateCameraPos.distance(t);}return v2}fireFrameReadyEvent(){let e=this.sortedVersion===this.lastWorldStateVersion,t=0;for(let[,e]of this.octreeInstances)t+=e.pendingLoadCount;this.director.eventHandler.fire("frame:ready",this.cameraNode.camera,this.renderer.layer,e,t);}update(){let e=this.workBuffer.format.extraStreamsVersion;this._workBufferFormatVersion!==e&&(this._workBufferFormatVersion=e,this.workBuffer.syncWithFormat(),this._workBufferRebuildRequired=true),this.cpuSorter&&this.cpuSorter.applyPendingSorted();let t=this.useGpuSorting||this.cpuSorter&&this.cpuSorter.jobsInFlight<3,i=false;this.framesTillFullUpdate--,this.framesTillFullUpdate<=0&&(this.framesTillFullUpdate=10,t&&(i=true));let s=this.hasNewOctreeInstances&&t;s&&(this.hasNewOctreeInstances=false);let r=false,a=false,n=false;if(i){for(let[,e]of this.octreeInstances){let t=e.update(this.scene);this.layerPlacementsDirty||(this.layerPlacementsDirty=t);let i=e.consumeNeedsLodUpdate();r||(r=i);}let e=this.scene.gsplat.lodUpdateDistance;for(let[,t]of this.octreeInstances){let i=t.testMoved(e);a||(a=i);}n=this.testCameraMovedForLod();}if(this.testCameraMovedForSort()&&(this.sortNeeded=true),this.scene.gsplat.dirty&&(this.layerPlacementsDirty=true,this.renderer.updateOverdrawMode(this.scene.gsplat)),n||a||this.scene.gsplat.dirty||r||s){for(let[,e]of this.octreeInstances)e.updateMoved();for(let[,e]of(this.lastLodCameraPos.copy(this.cameraNode.getPosition()),this.lastLodCameraFwd.copy(this.cameraNode.forward),this.octreeInstances))e.updateLod(this.cameraNode,this.scene.gsplat);}this.updateWorldState();let o=this.worldStates.get(this.lastWorldStateVersion);if(o&&this.cpuSorter&&!o.sortParametersSet){o.sortParametersSet=true;let e=this.prepareSortParameters(o);this.cpuSorter.setSortParameters(e);}let l=this.worldStates.get(this.sortedVersion);if(l&&(this._workBufferRebuildRequired?(this.rebuildWorkBuffer(l,l.totalUsedPixels),this._workBufferRebuildRequired=false):this.applyWorkBufferUpdates(l)),this.sortNeeded&&o&&(this.useGpuSorting?this.sortGpu(o):this.sortCpu(o),this.sortNeeded=false,this.lastSortCameraPos.copy(this.cameraNode.getPosition()),this.lastSortCameraFwd.copy(this.cameraNode.forward)),l&&(this.renderer.frameUpdate(this.scene.gsplat),this.updateColorCameraTracking()),this.octreeInstances.size){let e=this.scene.gsplat.cooldownTicks;for(let[,t]of this.octreeInstances){let i=t.octree;v3.has(i)||(v3.add(i),i.updateCooldownTick(e));}v3.clear();}this.fireFrameReadyEvent();let{textureSize:h}=this.workBuffer;return h*h}sortGpu(e){let t=this.keyGenerator,i=this.gpuSorter;if(!t||!i)return;let s=e.totalUsedPixels;if(0===s)return;e.sortedBefore||(e.sortedBefore=true,this.rebuildWorkBuffer(e,s),this.cleanupOldWorldStates(e.version),this.sortedVersion=e.version);let r=4*Math.ceil(Math.max(10,Math.min(20,Math.round(Math.log2(s/4))))/4),{minDist:a,maxDist:n}=this.computeDistanceRange(e),o=t.generate(this.workBuffer,this.cameraNode,this.scene.gsplat.radialSorting,s,r,a,n),l=i.sort(o,s,r);this.renderer.setOrderBuffer(l),this.renderer.update(s,e.textureSize);}computeDistanceRange(e){let t=this.cameraNode.getWorldTransform();t.getTranslation(vq),t.getZ(v$).normalize();let i=this.scene.gsplat.radialSorting,s=i?0:1/0,r=i?0:-1/0;for(let t of e.splats){let e=t.node.getWorldTransform(),a=t.aabb.getMin(),n=t.aabb.getMax();for(let t=0;t<8;t++)if(vK.x=1&t?n.x:a.x,vK.y=2&t?n.y:a.y,vK.z=4&t?n.z:a.z,e.transformPoint(vK,vK),i){let e=vK.distance(vq);e>r&&(r=e);}else {let e=vK.sub(vq).dot(v$);e<s&&(s=e),e>r&&(r=e);}}return 0===r||r===-1/0?{minDist:0,maxDist:1}:{minDist:s,maxDist:r}}sortCpu(e){if(!this.cpuSorter)return;let t=this.cameraNode.getWorldTransform();t.getTranslation(vq),t.getZ(v$).normalize();let i=[];e.splats.forEach(e=>{let t=e.node.getWorldTransform();vZ.copy(t).invert();let s=t.getScale().x,r=vZ.transformVector(v$).normalize(),a=vZ.transformPoint(vq);t.getTranslation(vj);let n=vj.sub(vq).dot(v$),o=e.aabb.getMin(),l=e.aabb.getMax();i.push({transformedDirection:r,transformedPosition:a,offset:n,scale:s,modelMat:t.data.slice(),aabbMin:[o.x,o.y,o.z],aabbMax:[l.x,l.y,l.z]});}),this.cpuSorter.setSortParams(i,this.scene.gsplat.radialSorting);}prepareSortParameters(e){return {command:"intervals",textureSize:e.textureSize,totalUsedPixels:e.totalUsedPixels,version:e.version,ids:e.splats.map(e=>e.resource.id),lineStarts:e.splats.map(e=>e.lineStart),padding:e.splats.map(e=>e.padding),intervals:e.splats.map(e=>e.intervals)}}constructor(e,t,i,s){this.node=new oX("GSplatManager"),this.worldStates=new Map,this.lastWorldStateVersion=0,this.useGpuSorting=false,this.cpuSorter=null,this.keyGenerator=null,this.gpuSorter=null,this.sortedVersion=0,this._workBufferFormatVersion=-1,this._workBufferRebuildRequired=false,this._stateTracker=new vH,this._centersVersions=new Map,this.framesTillFullUpdate=0,this.lastLodCameraPos=new ed(1/0,1/0,1/0),this.lastLodCameraFwd=new ed(1/0,1/0,1/0),this.lastSortCameraPos=new ed(1/0,1/0,1/0),this.lastSortCameraFwd=new ed(1/0,1/0,1/0),this.sortNeeded=true,this.lastColorUpdateCameraPos=new ed(1/0,1/0,1/0),this.lastColorUpdateCameraFwd=new ed(1/0,1/0,1/0),this.layerPlacements=[],this.layerPlacementsDirty=false,this.octreeInstances=new Map,this.octreeInstancesToDestroy=[],this.hasNewOctreeInstances=false,this.device=e,this.scene=t.scene,this.director=t,this.cameraNode=s,this.workBuffer=new ug(e,this.scene.gsplat.format),this.renderer=new vC(e,this.node,this.cameraNode,i,this.workBuffer),this._workBufferFormatVersion=this.workBuffer.format.extraStreamsVersion,this.useGpuSorting=e.isWebGPU&&t.scene.gsplat.gpuSorting,this.useGpuSorting?(this.keyGenerator=new vY(e),this.gpuSorter=new dS(e)):this.cpuSorter=this.createSorter();}}class v6{static equals(e,t){if(e.size!==t.size)return  false;for(let i of e)if(!t.has(i))return  false;return  true}}let v9=[];class v7{createManager(e,t,i,s,r,a){let n=new v8(e,t,i,s);return n.setRenderMode(a),t.eventHandler&&t.eventHandler.fire("material:created",n.material,r,i),n}updateConfiguration(e,t,i,s){let r=s.node,a=i.gsplatPlacements.length>0,n=i.gsplatShadowCasters.length>0,o=v6.equals(i.gsplatPlacementsSet,i.gsplatShadowCastersSet)&&a,l=o?3:+!!a,h=o?0:2*!!n;l?this.gsplatManager?this.gsplatManager.setRenderMode(l):this.gsplatManager=this.createManager(e,t,i,r,s,l):this.gsplatManager&&(this.gsplatManager.destroy(),this.gsplatManager=null),h?this.gsplatManagerShadow?this.gsplatManagerShadow.setRenderMode(h):this.gsplatManagerShadow=this.createManager(e,t,i,r,s,h):this.gsplatManagerShadow&&(this.gsplatManagerShadow.destroy(),this.gsplatManagerShadow=null);}destroy(){this.gsplatManager?.destroy(),this.gsplatManager=null,this.gsplatManagerShadow?.destroy(),this.gsplatManagerShadow=null;}constructor(e,t,i,s){this.gsplatManager=null,this.gsplatManagerShadow=null,this.updateConfiguration(e,t,i,s);}}class Se{destroy(){this.layersMap.forEach(e=>e.destroy()),this.layersMap.clear();}removeLayerData(e){let t=this.layersMap.get(e);t&&(t.destroy(),this.layersMap.delete(e));}getLayerData(e,t,i,s){let r=this.layersMap.get(i);return r||(r=new v7(e,t,i,s),this.layersMap.set(i,r)),r}constructor(){this.layersMap=new Map;}}class St{destroy(){this.camerasMap.forEach(e=>e.destroy()),this.camerasMap.clear();}getCameraData(e){let t=this.camerasMap.get(e);return t||(t=new Se,this.camerasMap.set(e,t)),t}update(e){uv.process(this.device),this.camerasMap.forEach((t,i)=>{if(e.camerasSet.has(i)){t.layersMap.forEach((e,t)=>{i.layersSet.has(t.id)&&t.enabled||v9.push(t);});for(let e=0;e<v9.length;e++){let i=v9[e],s=t.layersMap.get(i);s&&(s.destroy(),t.layersMap.delete(i));}v9.length=0;}else t.destroy(),this.camerasMap.delete(i);});let t=0,i=e.cameras;for(let s=0;s<i.length;s++){let r=i[s].camera,a=this.camerasMap.get(r),n=r.layers;for(let t=0;t<n.length;t++){let i=e.getLayerById(n[t]);if(i?.enabled&&(i.gsplatPlacementsDirty||!a)){let e=i.gsplatPlacements.length>0,t=i.gsplatShadowCasters.length>0;if(e||t){a??(a=this.getCameraData(r));let e=a.getLayerData(this.device,this,i,r);e.updateConfiguration(this.device,this,i,r),e.gsplatManager&&e.gsplatManager.reconcile(i.gsplatPlacements),e.gsplatManagerShadow&&e.gsplatManagerShadow.reconcile(i.gsplatShadowCasters);}else a&&a.removeLayerData(i);}}if(a)for(let e of a.layersMap.values())e.gsplatManager&&(t+=e.gsplatManager.update()),e.gsplatManagerShadow&&(t+=e.gsplatManagerShadow.update());}this.renderer._gsplatCount=t,this.scene.gsplat.frameEnd();for(let t=0;t<e.layerList.length;t++)e.layerList[t].gsplatPlacementsDirty=false;}constructor(e,t,i,s){this.camerasMap=new Map,this.device=e,this.renderer=t,this.scene=i,this.eventHandler=s;}}class Si extends f5{set customAabb(e){this._customAabb=e,this._instance?.meshInstance?.setCustomAabb(this._customAabb),this._placement&&(this._placement.aabb=this._customAabb);}get customAabb(){return this._customAabb??this._placement?.aabb??this.resource?.aabb??null}set instance(e){if(!this.unified&&(this.destroyInstance(),this._instance=e,this._instance)){let e=this._instance.meshInstance;e.node||(e.node=this.entity),e.castShadow=this._castShadows,e.setCustomAabb(this._customAabb),this.enabled&&this.entity.enabled&&this.addToLayers();}}get instance(){return this._instance}set material(e){this.unified||(this._instance?this._instance.material=e:this._materialTmp=e);}get material(){return this.unified?null:this._instance?.material??this._materialTmp??null}set highQualitySH(e){e!==this._highQualitySH&&(this._highQualitySH=e,this._instance?.setHighQualitySH(e));}get highQualitySH(){return this._highQualitySH}set castShadows(e){if(this._castShadows!==e){let t=this.layers,i=this.system.app.scene;if(this._placement)if(e)for(let e=0;e<t.length;e++){let s=i.layers.getLayerById(t[e]);s?.addGSplatShadowCaster(this._placement);}else for(let e=0;e<t.length;e++){let s=i.layers.getLayerById(t[e]);s?.removeGSplatShadowCaster(this._placement);}let s=this.instance?.meshInstance;if(s){if(this._castShadows&&!e)for(let e=0;e<t.length;e++){let t=i.layers.getLayerById(this.layers[e]);t?.removeShadowCasters([s]);}if(s.castShadow=e,!this._castShadows&&e)for(let e=0;e<t.length;e++){let r=i.layers.getLayerById(t[e]);r?.addShadowCasters([s]);}}this._castShadows=e;}}get castShadows(){return this._castShadows}set lodDistances(e){this._lodDistances=Array.isArray(e)?e.slice():null,this._placement&&(this._placement.lodDistances=this._lodDistances);}get lodDistances(){return this._lodDistances?this._lodDistances.slice():null}set splatBudget(e){this._splatBudget=e,this._placement&&(this._placement.splatBudget=this._splatBudget);}get splatBudget(){return this._splatBudget}set unified(e){this._unified!==e&&(this._unified=e,this._onGSplatAssetAdded());}get unified(){return this._unified}get id(){return this._id}set workBufferUpdate(e){this._workBufferUpdate=e,this._placement&&(this._placement.workBufferUpdate=e);}get workBufferUpdate(){return this._workBufferUpdate}setWorkBufferModifier(e){if(e){let t=(this.system.app.graphicsDevice.isWebGPU?e.wgsl:e.glsl)??null;this._workBufferModifier=t?{code:t,hash:iI(t)}:null;}else this._workBufferModifier=null;this._placement&&(this._placement.workBufferModifier=this._workBufferModifier);}set layers(e){this.removeFromLayers(),this._layers.length=0;for(let t=0;t<e.length;t++)this._layers[t]=e[t];this.enabled&&this.entity.enabled&&this.addToLayers();}get layers(){return this._layers}set asset(e){let t=e instanceof fy?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onGSplatAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onGSplatAssetAdded());}get asset(){return this._assetReference.id}set resource(e){this._resource!==e&&((this._resource||this._assetReference.asset?.resource)&&this._onGSplatAssetRemove(),e&&this._assetReference.id&&(this._assetReference.id=null),this._resource=e,this._resource&&this.enabled&&this.entity.enabled&&this._onGSplatAssetLoad());}get resource(){return this._resource??this._assetReference.asset?.resource??null}destroyInstance(){this._placement&&(this.removeFromLayers(),this._placement.destroy(),this._placement=null),this._instance&&(this.removeFromLayers(),this._instance?.destroy(),this._instance=null);}addToLayers(){if(this._placement){let e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){let i=e.getLayerById(this._layers[t]);i&&(i.addGSplatPlacement(this._placement),this._castShadows&&i.addGSplatShadowCaster(this._placement));}return}let e=this.instance?.meshInstance;if(e){let t=this.system.app.scene.layers;for(let i=0;i<this._layers.length;i++)t.getLayerById(this._layers[i])?.addMeshInstances([e]);}}removeFromLayers(){if(this._placement){let e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){let i=e.getLayerById(this._layers[t]);i&&(i.removeGSplatPlacement(this._placement),i.removeGSplatShadowCaster(this._placement));}return}let e=this.instance?.meshInstance;if(e){let t=this.system.app.scene.layers;for(let i=0;i<this._layers.length;i++)t.getLayerById(this._layers[i])?.removeMeshInstances([e]);}}onRemoveChild(){this.removeFromLayers();}onInsertChild(){this.enabled&&this.entity.enabled&&(this._instance||this._placement)&&this.addToLayers();}onRemove(){this.destroyInstance(),this.asset=null,this._assetReference.id=null,this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this);}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this);}onLayerAdded(e){0>this.layers.indexOf(e.id)||!this.unified&&this._instance&&e.addMeshInstances(this._instance.meshInstance);}onLayerRemoved(e){0>this.layers.indexOf(e.id)||!this.unified&&this._instance&&e.removeMeshInstances(this._instance.meshInstance);}onEnable(){let e=this.system.app.scene,t=e.layers;this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this._instance||this._placement?this.addToLayers():this.asset?this._onGSplatAssetAdded():this._resource&&this._onGSplatAssetLoad();}onDisable(){let e=this.system.app.scene.layers;this._evtLayersChanged?.off(),this._evtLayersChanged=null,e&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this.removeFromLayers();}hide(){this._instance&&(this._instance.meshInstance.visible=false);}show(){this._instance&&(this._instance.meshInstance.visible=true);}setParameter(e,t){let i=this.system.app.graphicsDevice.scope.resolve(e);this._parameters.set(e,{scopeId:i,data:t}),this._placement&&(this._placement.renderDirty=true);}getParameter(e){return this._parameters.get(e)?.data}deleteParameter(e){this._parameters.delete(e),this._placement&&(this._placement.renderDirty=true);}getInstanceTexture(e){if(this._placement)return this._placement.getInstanceTexture(e,this.system.app.graphicsDevice)}_onGSplatAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onGSplatAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset));}_onGSplatAssetLoad(){this.destroyInstance();let e=this._resource??this._assetReference.asset?.resource;e&&(this.unified?(this._placement=null,this._placement=new vP(e,this.entity,0,this._parameters,null,this._id),this._placement.lodDistances=this._lodDistances,this._placement.splatBudget=this._splatBudget,this._placement.workBufferUpdate=this._workBufferUpdate,this._placement.workBufferModifier=this._workBufferModifier,this.enabled&&this.entity.enabled&&this.addToLayers()):(this.instance=new u3(e,{material:this._materialTmp,highQualitySH:this._highQualitySH,scene:this.system.app.scene}),this._materialTmp=null));}_onGSplatAssetUnload(){this.destroyInstance();}_onGSplatAssetRemove(){this._onGSplatAssetUnload();}constructor(e,t){super(e,t),this._layers=[0],this._instance=null,this._placement=null,this._id=os.get(),this._materialTmp=null,this._highQualitySH=true,this._lodDistances=[5,10,15,20,25,30,35,40,45,50,55,60],this._splatBudget=0,this._customAabb=null,this._resource=null,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._castShadows=false,this._unified=false,this._parameters=new Map,this._workBufferUpdate=0,this._workBufferModifier=null,this._assetReference=new _2("asset",this,e.app.assets,{add:this._onGSplatAssetAdded,load:this._onGSplatAssetLoad,remove:this._onGSplatAssetRemove,unload:this._onGSplatAssetUnload},this),t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this);}}class Ss{constructor(){this.enabled=true;}}let Sr={gsplatCenterVS:`
uniform mat4 matrix_model;
uniform mat4 matrix_view;
#ifndef GSPLAT_CENTER_NOPROJ
	uniform vec4 camera_params;
	uniform mat4 matrix_projection;
#endif
bool initCenter(vec3 modelCenter, inout SplatCenter center) {
	mat4 modelView = matrix_view * matrix_model;
	vec4 centerView = modelView * vec4(modelCenter, 1.0);
	#ifndef GSPLAT_CENTER_NOPROJ
		if (camera_params.w != 1.0 && centerView.z > 0.0) {
			return false;
		}
		vec4 centerProj = matrix_projection * centerView;
		#if WEBGPU
			centerProj.z = clamp(centerProj.z, 0, abs(centerProj.w));
		#else
			centerProj.z = clamp(centerProj.z, -abs(centerProj.w), abs(centerProj.w));
		#endif
		center.proj = centerProj;
		center.projMat00 = matrix_projection[0][0];
	#endif
	center.view = centerView.xyz / centerView.w;
	center.modelView = modelView;
	return true;
}
`,gsplatCornerVS:`
uniform vec4 viewport_size;
void computeCovariance(vec4 rotation, vec3 scale, out vec3 covA, out vec3 covB) {
	mat3 rot = quatToMat3(rotation);
	mat3 M = transpose(mat3(
		scale.x * rot[0],
		scale.y * rot[1],
		scale.z * rot[2]
	));
	covA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));
	covB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));
}
bool initCornerCov(SplatSource source, SplatCenter center, out SplatCorner corner, vec3 covA, vec3 covB) {
	mat3 Vrk = mat3(
		covA.x, covA.y, covA.z, 
		covA.y, covB.x, covB.y,
		covA.z, covB.y, covB.z
	);
	float focal = viewport_size.x * center.projMat00;
	vec3 v = camera_params.w == 1.0 ? vec3(0.0, 0.0, 1.0) : center.view.xyz;
	float J1 = focal / v.z;
	vec2 J2 = -J1 / v.z * v.xy;
	mat3 J = mat3(
		J1, 0.0, J2.x, 
		0.0, J1, J2.y, 
		0.0, 0.0, 0.0
	);
	mat3 W = transpose(mat3(center.modelView));
	mat3 T = W * J;
	mat3 cov = transpose(T) * Vrk * T;
	#if GSPLAT_AA
		float detOrig = cov[0][0] * cov[1][1] - cov[0][1] * cov[0][1];
		float detBlur = (cov[0][0] + 0.3) * (cov[1][1] + 0.3) - cov[0][1] * cov[0][1];
		corner.aaFactor = sqrt(max(detOrig / detBlur, 0.0));
	#endif
	float diagonal1 = cov[0][0] + 0.3;
	float offDiagonal = cov[0][1];
	float diagonal2 = cov[1][1] + 0.3;
	float mid = 0.5 * (diagonal1 + diagonal2);
	float radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));
	float lambda1 = mid + radius;
	float lambda2 = max(mid - radius, 0.1);
	float vmin = min(1024.0, min(viewport_size.x, viewport_size.y));
	float l1 = 2.0 * min(sqrt(2.0 * lambda1), vmin);
	float l2 = 2.0 * min(sqrt(2.0 * lambda2), vmin);
	if (l1 < 2.0 && l2 < 2.0) {
		return false;
	}
	vec2 c = center.proj.ww * viewport_size.zw;
	if (any(greaterThan(abs(center.proj.xy) - vec2(max(l1, l2)) * c, center.proj.ww))) {
		return false;
	}
	vec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));
	vec2 v1 = l1 * diagonalVector;
	vec2 v2 = l2 * vec2(diagonalVector.y, -diagonalVector.x);
	corner.offset = vec3((source.cornerUV.x * v1 + source.cornerUV.y * v2) * c, 0.0);
	corner.uv = source.cornerUV;
	return true;
}
#if GSPLAT_2DGS
void initCorner2DGS(SplatSource source, vec4 rotation, vec3 scale, out SplatCorner corner) {
	vec2 localPos = source.cornerUV * vec2(scale.x, scale.y) * 3.0;
	vec3 v = vec3(localPos, 0.0);
	vec3 t = 2.0 * cross(rotation.xyz, v);
	corner.offset = v + rotation.w * t + cross(rotation.xyz, t);
	corner.uv = source.cornerUV;
}
#endif
bool initCorner(SplatSource source, SplatCenter center, out SplatCorner corner) {
	vec4 rotation = getRotation().yzwx;
	vec3 scale = getScale();
	modifySplatRotationScale(center.modelCenterOriginal, center.modelCenterModified, rotation, scale);
	#if GSPLAT_2DGS
		initCorner2DGS(source, rotation, scale, corner);
		return true;
	#else
		vec3 covA, covB;
		computeCovariance(rotation.wxyz, scale, covA, covB);
		return initCornerCov(source, center, corner, covA, covB);
	#endif
}
`,gsplatCommonVS:`
#include "gsplatHelpersVS"
#include "gsplatFormatVS"
#include "gsplatStructsVS"
#include "gsplatDeclarationsVS"
#include "gsplatModifyVS"
#include "gsplatEvalSHVS"
#include "gsplatQuatToMat3VS"
#include "gsplatReadVS"
#include "gsplatSourceVS"
#include "gsplatCenterVS"
#include "gsplatCornerVS"
#include "gsplatOutputVS"
void clipCorner(inout SplatCorner corner, float alpha) {
	float clip = min(1.0, sqrt(-log(1.0 / (255.0 * alpha))) / 2.0);
	corner.offset *= clip;
	corner.uv *= clip;
}
`,gsplatSplatVS:`
struct Splat {
	uint index;
	ivec2 uv;
};
Splat splat;
void setSplat(uint idx) {
	splat.index = idx;
	splat.uv = ivec2(idx % splatTextureSize, idx / splatTextureSize);
}
`,gsplatEvalSHVS:`
	#if SH_BANDS == 1
		#define SH_COEFFS 3
	#elif SH_BANDS == 2
		#define SH_COEFFS 8
	#elif SH_BANDS == 3
		#define SH_COEFFS 15
	#else
		#define SH_COEFFS 0
	#endif
	#if SH_BANDS > 0
	const float SH_C1 = 0.4886025119029199f;
	#if SH_BANDS > 1
		const float SH_C2_0 = 1.0925484305920792f;
		const float SH_C2_1 = -1.0925484305920792f;
		const float SH_C2_2 = 0.31539156525252005f;
		const float SH_C2_3 = -1.0925484305920792f;
		const float SH_C2_4 = 0.5462742152960396f;
	#endif
	#if SH_BANDS > 2
		const float SH_C3_0 = -0.5900435899266435f;
		const float SH_C3_1 = 2.890611442640554f;
		const float SH_C3_2 = -0.4570457994644658f;
		const float SH_C3_3 = 0.3731763325901154f;
		const float SH_C3_4 = -0.4570457994644658f;
		const float SH_C3_5 = 1.445305721320277f;
		const float SH_C3_6 = -0.5900435899266435f;
	#endif
	vec3 evalSH(in vec3 sh[SH_COEFFS], in vec3 dir) {
		float x = dir.x;
		float y = dir.y;
		float z = dir.z;
		vec3 result = SH_C1 * (-sh[0] * y + sh[1] * z - sh[2] * x);
		#if SH_BANDS > 1
			float xx = x * x;
			float yy = y * y;
			float zz = z * z;
			float xy = x * y;
			float yz = y * z;
			float xz = x * z;
			result +=
				sh[3] * (SH_C2_0 * xy) +
				sh[4] * (SH_C2_1 * yz) +
				sh[5] * (SH_C2_2 * (2.0 * zz - xx - yy)) +
				sh[6] * (SH_C2_3 * xz) +
				sh[7] * (SH_C2_4 * (xx - yy));
		#endif
		#if SH_BANDS > 2
			result +=
				sh[8]  * (SH_C3_0 * y * (3.0 * xx - yy)) +
				sh[9]  * (SH_C3_1 * xy * z) +
				sh[10] * (SH_C3_2 * y * (4.0 * zz - xx - yy)) +
				sh[11] * (SH_C3_3 * z * (2.0 * zz - 3.0 * xx - 3.0 * yy)) +
				sh[12] * (SH_C3_4 * x * (4.0 * zz - xx - yy)) +
				sh[13] * (SH_C3_5 * z * (xx - yy)) +
				sh[14] * (SH_C3_6 * x * (xx - 3.0 * yy));
		#endif
		return result;
	}
	#endif
`,gsplatHelpersVS:`
void gsplatMakeSpherical(inout vec3 scale, float size) {
	scale = vec3(size);
}
float gsplatGetSizeFromScale(vec3 scale) {
	return sqrt((scale.x * scale.x + scale.y * scale.y + scale.z * scale.z) / 3.0);
}
`,gsplatModifyVS:`
void modifySplatCenter(inout vec3 center) {
}
void modifySplatRotationScale(vec3 originalCenter, vec3 modifiedCenter, inout vec4 rotation, inout vec3 scale) {
}
void modifySplatColor(vec3 center, inout vec4 color) {
}
`,gsplatQuatToMat3VS:`
mat3 quatToMat3(vec4 R) {
	vec4 R2 = R + R;
	float X = R2.x * R.w;
	vec4 Y  = R2.y * R;
	vec4 Z  = R2.z * R;
	float W = R2.w * R.w;
	return mat3(
		1.0 - Z.z - W,
			  Y.z + X,
			  Y.w - Z.x,
			  Y.z - X,
		1.0 - Y.y - W,
			  Z.w + Y.x,
			  Y.w + Z.x,
			  Z.w - Y.x,
		1.0 - Y.y - Z.z
	);
}
vec4 quatMul(vec4 a, vec4 b) {
	return vec4(
		a.w * b.x + a.x * b.w + a.y * b.z - a.z * b.y,
		a.w * b.y - a.x * b.z + a.y * b.w + a.z * b.x,
		a.w * b.z + a.x * b.y - a.y * b.x + a.z * b.w,
		a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z
	);
}
`,gsplatStructsVS:`
#include "gsplatSplatVS"
struct SplatSource {
	uint order;
	vec2 cornerUV;
};
struct SplatCenter {
	vec3 view;
	vec4 proj;
	mat4 modelView;
	float projMat00;
	vec3 modelCenterOriginal;
	vec3 modelCenterModified;
};
struct SplatCorner {
	vec3 offset;
	vec2 uv;
	#if GSPLAT_AA
		float aaFactor;
	#endif
	vec2 v;
	float dlen;
};
`,gsplatOutputVS:`
#include "tonemappingPS"
#include "decodePS"
#include "gammaPS"
vec3 prepareOutputFromGamma(vec3 gammaColor) {
	#if TONEMAP == NONE
		#if GAMMA == NONE
			return decodeGamma(gammaColor);
		#else
			return gammaColor;
		#endif
	#else
		return gammaCorrectOutput(toneMap(decodeGamma(gammaColor)));
	#endif
}
`,gsplatPS:`
#ifndef DITHER_NONE
	#include "bayerPS"
	#include "opacityDitherPS"
	varying float id;
#endif
#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)
	uniform float alphaClip;
#endif
#ifdef PREPASS_PASS
	varying float vLinearDepth;
	#include "floatAsUintPS"
#endif
varying mediump vec2 gaussianUV;
varying mediump vec4 gaussianColor;
#if defined(GSPLAT_UNIFIED_ID) && defined(PICK_PASS)
	flat varying uint vPickId;
#endif
#ifdef PICK_PASS
	#include "pickPS"
#endif
const float EXP4 = exp(-4.0);
const float INV_EXP4 = 1.0 / (1.0 - EXP4);
float normExp(float x) {
	return (exp(x * -4.0) - EXP4) * INV_EXP4;
}
void main(void) {
	mediump float A = dot(gaussianUV, gaussianUV);
	if (A > 1.0) {
		discard;
	}
	mediump float alpha = normExp(A) * gaussianColor.a;
	#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)
		if (alpha < alphaClip) {
			discard;
		}
	#endif
	#ifdef PICK_PASS
		#ifdef GSPLAT_UNIFIED_ID
			pcFragColor0 = encodePickOutput(vPickId);
		#else
			pcFragColor0 = getPickOutput();
		#endif
		#ifdef DEPTH_PICK_PASS
			pcFragColor1 = getPickDepth();
		#endif
	#elif SHADOW_PASS
		gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
	#elif PREPASS_PASS
		gl_FragColor = float2vec4(vLinearDepth);
	#else
		if (alpha < 1.0 / 255.0) {
			discard;
		}
		#ifndef DITHER_NONE
			opacityDither(alpha, id * 0.013);
		#endif
		gl_FragColor = vec4(gaussianColor.xyz * alpha, alpha);
	#endif
}
`,gsplatSourceVS:`
attribute vec3 vertex_position;
attribute uint vertex_id_attrib;
uniform uint numSplats;
uniform highp usampler2D splatOrder;
bool initSource(out SplatSource source) {
	source.order = vertex_id_attrib + uint(vertex_position.z);
	if (source.order >= numSplats) {
		return false;
	}
	ivec2 orderUV = ivec2(source.order % splatTextureSize, source.order / splatTextureSize);
	uint splatId = texelFetch(splatOrder, orderUV, 0).r;
	setSplat(splatId);
	source.cornerUV = vertex_position.xy;
	return true;
}
`,gsplatVS:`
#include "gsplatCommonVS"
varying mediump vec2 gaussianUV;
varying mediump vec4 gaussianColor;
#ifndef DITHER_NONE
	varying float id;
#endif
mediump vec4 discardVec = vec4(0.0, 0.0, 2.0, 1.0);
#ifdef PREPASS_PASS
	varying float vLinearDepth;
#endif
#if defined(GSPLAT_UNIFIED_ID) && defined(PICK_PASS)
	flat varying uint vPickId;
#endif
#ifdef GSPLAT_OVERDRAW
	uniform sampler2D colorRamp;
	uniform float colorRampIntensity;
#endif
void main(void) {
	SplatSource source;
	if (!initSource(source)) {
		gl_Position = discardVec;
		return;
	}
	vec3 modelCenter = getCenter();
	SplatCenter center;
	center.modelCenterOriginal = modelCenter;
	
	modifySplatCenter(modelCenter);
	center.modelCenterModified = modelCenter;
	if (!initCenter(modelCenter, center)) {
		gl_Position = discardVec;
		return;
	}
	SplatCorner corner;
	if (!initCorner(source, center, corner)) {
		gl_Position = discardVec;
		return;
	}
	vec4 clr = getColor();
	#if GSPLAT_AA
		clr.a *= corner.aaFactor;
	#endif
	#if SH_BANDS > 0
		vec3 dir = normalize(center.view * mat3(center.modelView));
		vec3 sh[SH_COEFFS];
		float scale;
		readSHData(sh, scale);
		clr.xyz += evalSH(sh, dir) * scale;
	#endif
	modifySplatColor(modelCenter, clr);
	clipCorner(corner, clr.w);
	#if GSPLAT_2DGS
		vec3 modelCorner = center.modelCenterModified + corner.offset;
		gl_Position = matrix_projection * center.modelView * vec4(modelCorner, 1.0);
	#else
		gl_Position = center.proj + vec4(corner.offset.xyz, 0);
	#endif
	gaussianUV = corner.uv;
	#ifdef GSPLAT_OVERDRAW
		float t = clamp(modelCenter.y / 20.0, 0.0, 1.0);
		vec3 rampColor = textureLod(colorRamp, vec2(t, 0.5), 0.0).rgb;
		clr.a *= (1.0 / 32.0) * colorRampIntensity;
		gaussianColor = vec4(rampColor, clr.a);
	#else
		gaussianColor = vec4(prepareOutputFromGamma(max(clr.xyz, 0.0)), clr.w);
	#endif
	#ifndef DITHER_NONE
		id = float(splat.index);
	#endif
	#ifdef PREPASS_PASS
		vLinearDepth = -center.view.z;
	#endif
	#if defined(GSPLAT_UNIFIED_ID) && defined(PICK_PASS)
		vPickId = loadPcId().r;
	#endif
}
`,gsplatPackingPS:uX,gsplatFormatVS:`
uniform uint splatTextureSize;
`,gsplatUncompressedVS:`
uint tAw;
vec4 tBcached;
vec4 unpackRotation(vec3 packed) {
	return vec4(packed.xyz, sqrt(max(0.0, 1.0 - dot(packed, packed))));
}
vec3 getCenter() {
	uvec4 tA = loadTransformA();
	tAw = tA.w;
	tBcached = loadTransformB();
	return uintBitsToFloat(tA.xyz);
}
vec4 getColor() {
	return loadSplatColor();
}
vec4 getRotation() {
	return unpackRotation(vec3(unpackHalf2x16(tAw), tBcached.w)).wxyz;
}
vec3 getScale() {
	return tBcached.xyz;
}
#include "gsplatUncompressedSHVS"
`,gsplatUncompressedSHVS:`
#if SH_BANDS > 0
vec3 unpack111011s(uint bits) {
	return vec3((uvec3(bits) >> uvec3(21u, 11u, 0u)) & uvec3(0x7ffu, 0x3ffu, 0x7ffu)) / vec3(2047.0, 1023.0, 2047.0) * 2.0 - 1.0;
}
void fetchScale(in uvec4 t, out float scale, out vec3 a, out vec3 b, out vec3 c) {
	scale = uintBitsToFloat(t.x);
	a = unpack111011s(t.y);
	b = unpack111011s(t.z);
	c = unpack111011s(t.w);
}
void fetch(in uvec4 t, out vec3 a, out vec3 b, out vec3 c, out vec3 d) {
	a = unpack111011s(t.x);
	b = unpack111011s(t.y);
	c = unpack111011s(t.z);
	d = unpack111011s(t.w);
}
void fetch(in uint t, out vec3 a) {
	a = unpack111011s(t);
}
#if SH_BANDS == 1
	void readSHData(out vec3 sh[3], out float scale) {
		fetchScale(loadSplatSH_1to3(), scale, sh[0], sh[1], sh[2]);
	}
#elif SH_BANDS == 2
	void readSHData(out vec3 sh[8], out float scale) {
		fetchScale(loadSplatSH_1to3(), scale, sh[0], sh[1], sh[2]);
		fetch(loadSplatSH_4to7(), sh[3], sh[4], sh[5], sh[6]);
		fetch(loadSplatSH_8to11().x, sh[7]);
	}
#else
	void readSHData(out vec3 sh[15], out float scale) {
		fetchScale(loadSplatSH_1to3(), scale, sh[0], sh[1], sh[2]);
		fetch(loadSplatSH_4to7(), sh[3], sh[4], sh[5], sh[6]);
		fetch(loadSplatSH_8to11(), sh[7], sh[8], sh[9], sh[10]);
		fetch(loadSplatSH_12to15(), sh[11], sh[12], sh[13], sh[14]);
	}
#endif
#endif
`,gsplatCompressedVS:`
#include "gsplatPackingPS"
uniform highp sampler2D chunkTexture;
vec4 chunkDataA;
vec4 chunkDataB;
vec4 chunkDataC;
vec4 chunkDataD;
vec4 chunkDataE;
uvec4 packedData;
vec3 unpack111011(uint bits) {
	return vec3(
		float(bits >> 21u) / 2047.0,
		float((bits >> 11u) & 0x3ffu) / 1023.0,
		float(bits & 0x7ffu) / 2047.0
	);
}
const float norm = sqrt(2.0);
vec4 unpackRotation(uint bits) {
	float a = (float((bits >> 20u) & 0x3ffu) / 1023.0 - 0.5) * norm;
	float b = (float((bits >> 10u) & 0x3ffu) / 1023.0 - 0.5) * norm;
	float c = (float(bits & 0x3ffu) / 1023.0 - 0.5) * norm;
	float m = sqrt(1.0 - (a * a + b * b + c * c));
	uint mode = bits >> 30u;
	if (mode == 0u) return vec4(m, a, b, c);
	if (mode == 1u) return vec4(a, m, b, c);
	if (mode == 2u) return vec4(a, b, m, c);
	return vec4(a, b, c, m);
}
vec3 getCenter() {
	uint w = uint(textureSize(chunkTexture, 0).x) / 5u;
	uint chunkId = splat.index / 256u;
	ivec2 chunkUV = ivec2((chunkId % w) * 5u, chunkId / w);
	chunkDataA = texelFetch(chunkTexture, chunkUV, 0);
	chunkDataB = texelFetch(chunkTexture, chunkUV + ivec2(1, 0), 0);
	chunkDataC = texelFetch(chunkTexture, chunkUV + ivec2(2, 0), 0);
	chunkDataD = texelFetch(chunkTexture, chunkUV + ivec2(3, 0), 0);
	chunkDataE = texelFetch(chunkTexture, chunkUV + ivec2(4, 0), 0);
	packedData = loadPackedTexture();
	return mix(chunkDataA.xyz, vec3(chunkDataA.w, chunkDataB.xy), unpack111011(packedData.x));
}
vec4 getColor() {
	vec4 r = unpack8888(packedData.w);
	return vec4(mix(chunkDataD.xyz, vec3(chunkDataD.w, chunkDataE.xy), r.rgb), r.w);
}
vec4 getRotation() {
	return unpackRotation(packedData.y);
}
vec3 getScale() {
	return exp(mix(vec3(chunkDataB.zw, chunkDataC.x), chunkDataC.yzw, unpack111011(packedData.z)));
}
#include "gsplatCompressedSHVS"
`,gsplatCompressedSHVS:`
#if SH_BANDS > 0
vec4 unpack8888s(in uint bits) {
	return vec4((uvec4(bits) >> uvec4(0u, 8u, 16u, 24u)) & 0xffu) * (8.0 / 255.0) - 4.0;
}
void readSHData(out vec3 sh[15], out float scale) {
	uvec4 shData0 = loadShTexture0();
	uvec4 shData1 = loadShTexture1();
	uvec4 shData2 = loadShTexture2();
	vec4 r0 = unpack8888s(shData0.x);
	vec4 r1 = unpack8888s(shData0.y);
	vec4 r2 = unpack8888s(shData0.z);
	vec4 r3 = unpack8888s(shData0.w);
	vec4 g0 = unpack8888s(shData1.x);
	vec4 g1 = unpack8888s(shData1.y);
	vec4 g2 = unpack8888s(shData1.z);
	vec4 g3 = unpack8888s(shData1.w);
	vec4 b0 = unpack8888s(shData2.x);
	vec4 b1 = unpack8888s(shData2.y);
	vec4 b2 = unpack8888s(shData2.z);
	vec4 b3 = unpack8888s(shData2.w);
	sh[0] =  vec3(r0.x, g0.x, b0.x);
	sh[1] =  vec3(r0.y, g0.y, b0.y);
	sh[2] =  vec3(r0.z, g0.z, b0.z);
	sh[3] =  vec3(r0.w, g0.w, b0.w);
	sh[4] =  vec3(r1.x, g1.x, b1.x);
	sh[5] =  vec3(r1.y, g1.y, b1.y);
	sh[6] =  vec3(r1.z, g1.z, b1.z);
	sh[7] =  vec3(r1.w, g1.w, b1.w);
	sh[8] =  vec3(r2.x, g2.x, b2.x);
	sh[9] =  vec3(r2.y, g2.y, b2.y);
	sh[10] = vec3(r2.z, g2.z, b2.z);
	sh[11] = vec3(r2.w, g2.w, b2.w);
	sh[12] = vec3(r3.x, g3.x, b3.x);
	sh[13] = vec3(r3.y, g3.y, b3.y);
	sh[14] = vec3(r3.z, g3.z, b3.z);
	scale = 1.0;
}
#endif
`,gsplatSogVS:`
#include "gsplatPackingPS"
uniform vec3 means_mins;
uniform vec3 means_maxs;
uniform float scales_mins;
uniform float scales_maxs;
uniform float sh0_mins;
uniform float sh0_maxs;
uniform highp sampler2D packedSh0;
const float SH_C0 = 0.28209479177387814;
uvec4 packedSample;
const float norm = sqrt(2.0);
vec3 getCenter() {
	packedSample = loadPackedTexture();
	vec3 l = unpack8888(packedSample.x).xyz;
	vec3 u = unpack8888(packedSample.y).xyz;
	vec3 n = (l + u * 256.0) / 257.0;
	vec3 v = mix(means_mins, means_maxs, n);
	return sign(v) * (exp(abs(v)) - 1.0);
}
vec4 getColor() {
	vec3 clr = mix(vec3(sh0_mins), vec3(sh0_maxs), unpack111110(pack8888(texelFetch(packedSh0, splat.uv, 0))));
	float alpha = float(packedSample.z & 0xffu) / 255.0;
	return vec4(vec3(0.5) + clr * SH_C0, alpha);
}
vec4 getRotation() {
	vec3 qdata = unpack8888(packedSample.z).xyz;
	uint qmode = packedSample.w & 0x3u;
	vec3 abc = (qdata - 0.5) * norm;
	float d = sqrt(max(0.0, 1.0 - dot(abc, abc)));
	return (qmode == 0u) ? vec4(d, abc) :
		   ((qmode == 1u) ? vec4(abc.x, d, abc.yz) :
		   ((qmode == 2u) ? vec4(abc.xy, d, abc.z) : vec4(abc, d)));
}
vec3 getScale() {
	vec3 sdata = unpack101010(packedSample.w >> 2u);
	return exp(mix(vec3(scales_mins), vec3(scales_maxs), sdata));
}
#include "gsplatSogSHVS"
`,gsplatSogSHVS:`
#if SH_BANDS > 0
uniform highp sampler2D packedShN;
uniform float shN_mins;
uniform float shN_maxs;
void readSHData(out vec3 sh[SH_COEFFS], out float scale) {
	ivec2 t = ivec2(packedSample.xy & 255u);
	int n = t.x + t.y * 256;
	int u = (n % 64) * SH_COEFFS;
	int v = n / 64;
	for (int i = 0; i < SH_COEFFS; i++) {
		sh[i] = mix(vec3(shN_mins), vec3(shN_maxs), unpack111110(pack8888(texelFetch(packedShN, ivec2(u + i, v), 0))));
	}
	scale = 1.0;
}
#endif
`,gsplatContainerDeclVS:`
#include "gsplatContainerDeclarationsVS"
vec3 splatCenter;
vec4 splatColor;
vec3 splatScale;
vec4 splatRotation;
`,gsplatContainerReadVS:`
vec3 getCenter() {
	#include "gsplatContainerUserReadVS"
	return splatCenter;
}
vec4 getRotation() {
	return splatRotation;
}
vec3 getScale() {
	return splatScale;
}
vec4 getColor() {
	return splatColor;
}
`,gsplatContainerPackedReadVS:`
uvec4 cachedTransformA;
uvec2 cachedTransformB;
vec3 getCenter() {
	cachedTransformA = loadDataTransformA();
	cachedTransformB = loadDataTransformB().xy;
	return vec3(uintBitsToFloat(cachedTransformA.r), uintBitsToFloat(cachedTransformA.g), uintBitsToFloat(cachedTransformA.b));
}
vec4 getColor() {
	#ifdef GSPLAT_COLOR_FLOAT
		return loadDataColor();
	#else
		uvec4 packedColor = loadDataColor();
		uint packed_rg = packedColor.r | (packedColor.g << 16u);
		uint packed_ba = packedColor.b | (packedColor.a << 16u);
		return vec4(unpackHalf2x16(packed_rg), unpackHalf2x16(packed_ba));
	#endif
}
vec4 getRotation() {
	vec2 rotXY = unpackHalf2x16(cachedTransformA.a);
	vec2 rotZscaleX = unpackHalf2x16(cachedTransformB.x);
	vec3 rotXYZ = vec3(rotXY, rotZscaleX.x);
	return vec4(rotXYZ, sqrt(max(0.0, 1.0 - dot(rotXYZ, rotXYZ)))).wxyz;
}
vec3 getScale() {
	vec2 rotZscaleX = unpackHalf2x16(cachedTransformB.x);
	vec2 scaleYZ = unpackHalf2x16(cachedTransformB.y);
	return vec3(rotZscaleX.y, scaleYZ);
}
`,gsplatContainerFloatReadVS:cv},Sa={gsplatCenterVS:`
uniform matrix_model: mat4x4f;
uniform matrix_view: mat4x4f;
#ifndef GSPLAT_CENTER_NOPROJ
	uniform camera_params: vec4f;
	uniform matrix_projection: mat4x4f;
#endif
fn initCenter(modelCenter: vec3f, center: ptr<function, SplatCenter>) -> bool {
	let modelView: mat4x4f = uniform.matrix_view * uniform.matrix_model;
	let centerView: vec4f = modelView * vec4f(modelCenter, 1.0);
	#ifndef GSPLAT_CENTER_NOPROJ
		if (uniform.camera_params.w != 1.0 && centerView.z > 0.0) {
			return false;
		}
		var centerProj: vec4f = uniform.matrix_projection * centerView;
		centerProj.z = clamp(centerProj.z, 0.0, abs(centerProj.w));
		center.proj = centerProj;
		center.projMat00 = uniform.matrix_projection[0][0];
	#endif
	center.view = centerView.xyz / centerView.w;
	center.modelView = modelView;
	return true;
}
`,gsplatCornerVS:`
uniform viewport_size: vec4f;
fn computeCovariance(rotation: vec4f, scale: vec3f, covA_ptr: ptr<function, vec3f>, covB_ptr: ptr<function, vec3f>) {
	let rot = quatToMat3(rotation);
	let M = transpose(mat3x3f(
		scale.x * rot[0],
		scale.y * rot[1],
		scale.z * rot[2]
	));
	*covA_ptr = vec3f(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));
	*covB_ptr = vec3f(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));
}
fn initCornerCov(source: ptr<function, SplatSource>, center: ptr<function, SplatCenter>, corner: ptr<function, SplatCorner>, covA: vec3f, covB: vec3f) -> bool {
	let Vrk = mat3x3f(
		vec3f(covA.x, covA.y, covA.z),
		vec3f(covA.y, covB.x, covB.y),
		vec3f(covA.z, covB.y, covB.z)
	);
	let focal = uniform.viewport_size.x * center.projMat00;
	let v = select(center.view.xyz, vec3f(0.0, 0.0, 1.0), uniform.camera_params.w == 1.0);
	let J1 = focal / v.z;
	let J2 = -J1 / v.z * v.xy;
	let J = mat3x3f(
		vec3f(J1, 0.0, J2.x),
		vec3f(0.0, J1, J2.y),
		vec3f(0.0, 0.0, 0.0)
	);
	let W = transpose(mat3x3f(center.modelView[0].xyz, center.modelView[1].xyz, center.modelView[2].xyz));
	let T = W * J;
	let cov = transpose(T) * Vrk * T;
	#if GSPLAT_AA
		let detOrig = cov[0][0] * cov[1][1] - cov[0][1] * cov[1][0];
		let detBlur = (cov[0][0] + 0.3) * (cov[1][1] + 0.3) - cov[0][1] * cov[1][0];
		corner.aaFactor = sqrt(detOrig / detBlur);
	#endif
	let diagonal1 = cov[0][0] + 0.3;
	let offDiagonal = cov[0][1];
	let diagonal2 = cov[1][1] + 0.3;
	let mid = 0.5 * (diagonal1 + diagonal2);
	let radius = length(vec2f((diagonal1 - diagonal2) / 2.0, offDiagonal));
	let lambda1 = mid + radius;
	let lambda2 = max(mid - radius, 0.1);
	let vmin = min(1024.0, min(uniform.viewport_size.x, uniform.viewport_size.y));
	let l1 = 2.0 * min(sqrt(2.0 * lambda1), vmin);
	let l2 = 2.0 * min(sqrt(2.0 * lambda2), vmin);
	if (l1 < 2.0 && l2 < 2.0) {
		return false;
	}
	let c = center.proj.ww * uniform.viewport_size.zw;
	if (any((abs(center.proj.xy) - vec2f(max(l1, l2)) * c) > center.proj.ww)) {
		return false;
	}
	let diagonalVector = normalize(vec2f(offDiagonal, lambda1 - diagonal1));
	let v1 = l1 * diagonalVector;
	let v2 = l2 * vec2f(diagonalVector.y, -diagonalVector.x);
	corner.offset = vec3f((source.cornerUV.x * v1 + source.cornerUV.y * v2) * c, 0.0);
	corner.uv = source.cornerUV;
	return true;
}
#if GSPLAT_2DGS
fn initCorner2DGS(source: ptr<function, SplatSource>, rotation: vec4f, scale: vec3f, corner: ptr<function, SplatCorner>) {
	let localPos: vec2f = source.cornerUV * vec2f(scale.x, scale.y) * 3.0;
	let v: vec3f = vec3f(localPos, 0.0);
	let t: vec3f = 2.0 * cross(rotation.xyz, v);
	corner.offset = v + rotation.w * t + cross(rotation.xyz, t);
	corner.uv = source.cornerUV;
}
#endif
fn initCorner(source: ptr<function, SplatSource>, center: ptr<function, SplatCenter>, corner: ptr<function, SplatCorner>) -> bool {
	var rotation: vec4f = getRotation().yzwx;
	var scale: vec3f = getScale();
	modifySplatRotationScale(center.modelCenterOriginal, center.modelCenterModified, &rotation, &scale);
	#if GSPLAT_2DGS
		initCorner2DGS(source, rotation, scale, corner);
		return true;
	#else
		var covA: vec3f;
		var covB: vec3f;
		computeCovariance(rotation.wxyz, scale, &covA, &covB);
		return initCornerCov(source, center, corner, covA, covB);
	#endif
}
`,gsplatCommonVS:`
#include "gsplatHelpersVS"
#include "gsplatFormatVS"
#include "gsplatStructsVS"
#include "gsplatDeclarationsVS"
#include "gsplatModifyVS"
#include "gsplatEvalSHVS"
#include "gsplatQuatToMat3VS"
#include "gsplatReadVS"
#include "gsplatSourceVS"
#include "gsplatCenterVS"
#include "gsplatCornerVS"
#include "gsplatOutputVS"
fn clipCorner(corner: ptr<function, SplatCorner>, alpha: f32) {
	let clip: f32 = min(1.0, sqrt(-log(1.0 / (255.0 * alpha))) / 2.0);
	corner.offset = corner.offset * clip;
	corner.uv = corner.uv * clip;
}
`,gsplatSplatVS:`
struct Splat {
	index: u32,
	uv: vec2i
}
var<private> splat: Splat;
fn setSplat(idx: u32) {
	splat.index = idx;
	splat.uv = vec2i(i32(idx % uniform.splatTextureSize), i32(idx / uniform.splatTextureSize));
}
`,gsplatEvalSHVS:`
	#if SH_BANDS == 1
		const SH_COEFFS: i32 = 3;
	#elif SH_BANDS == 2
		const SH_COEFFS: i32 = 8;
	#elif SH_BANDS == 3
		const SH_COEFFS: i32 = 15;
	#else
		const SH_COEFFS: i32 = 0;
	#endif
	#if SH_BANDS > 0
	const SH_C1: f32 = 0.4886025119029199;
	#if SH_BANDS > 1
		const SH_C2_0: f32 = 1.0925484305920792;
		const SH_C2_1: f32 = -1.0925484305920792;
		const SH_C2_2: f32 = 0.31539156525252005;
		const SH_C2_3: f32 = -1.0925484305920792;
		const SH_C2_4: f32 = 0.5462742152960396;
	#endif
	#if SH_BANDS > 2
		const SH_C3_0: f32 = -0.5900435899266435;
		const SH_C3_1: f32 = 2.890611442640554;
		const SH_C3_2: f32 = -0.4570457994644658;
		const SH_C3_3: f32 = 0.3731763325901154;
		const SH_C3_4: f32 = -0.4570457994644658;
		const SH_C3_5: f32 = 1.445305721320277;
		const SH_C3_6: f32 = -0.5900435899266435;
	#endif
	fn evalSH(sh: ptr<function, array<vec3f, SH_COEFFS>>, dir: vec3f) -> vec3f {
		let x = dir.x;
		let y = dir.y;
		let z = dir.z;
		var result = SH_C1 * (-sh[0] * y + sh[1] * z - sh[2] * x);
		#if SH_BANDS > 1
			let xx = x * x;
			let yy = y * y;
			let zz = z * z;
			let xy = x * y;
			let yz = y * z;
			let xz = x * z;
			result = result + (
				sh[3] * (SH_C2_0 * xy) +
				sh[4] * (SH_C2_1 * yz) +
				sh[5] * (SH_C2_2 * (2.0 * zz - xx - yy)) +
				sh[6] * (SH_C2_3 * xz) +
				sh[7] * (SH_C2_4 * (xx - yy))
			);
		#endif
		#if SH_BANDS > 2
			result = result + (
				sh[8]  * (SH_C3_0 * y * (3.0 * xx - yy)) +
				sh[9]  * (SH_C3_1 * xy * z) +
				sh[10] * (SH_C3_2 * y * (4.0 * zz - xx - yy)) +
				sh[11] * (SH_C3_3 * z * (2.0 * zz - 3.0 * xx - 3.0 * yy)) +
				sh[12] * (SH_C3_4 * x * (4.0 * zz - xx - yy)) +
				sh[13] * (SH_C3_5 * z * (xx - yy)) +
				sh[14] * (SH_C3_6 * x * (xx - 3.0 * yy))
			);
		#endif
		return result;
	}
	#endif
`,gsplatHelpersVS:`
fn gsplatMakeSpherical(scale: ptr<function, vec3f>, size: f32) {
	*scale = vec3f(size);
}
fn gsplatGetSizeFromScale(scale: vec3f) -> f32 {
	return sqrt((scale.x * scale.x + scale.y * scale.y + scale.z * scale.z) / 3.0);
}
`,gsplatModifyVS:`
fn modifySplatCenter(center: ptr<function, vec3f>) {
}
fn modifySplatRotationScale(originalCenter: vec3f, modifiedCenter: vec3f, rotation: ptr<function, vec4f>, scale: ptr<function, vec3f>) {
}
fn modifySplatColor(center: vec3f, color: ptr<function, vec4f>) {
}
`,gsplatStructsVS:`
#include "gsplatSplatVS"
struct SplatSource {
	order: u32,
	cornerUV: vec2f
}
struct SplatCenter {
	view: vec3f,
	proj: vec4f,
	modelView: mat4x4f,
	projMat00: f32,
	modelCenterOriginal: vec3f,
	modelCenterModified: vec3f,
}
struct SplatCorner {
	offset: vec3f,
	uv: vec2f,
	#if GSPLAT_AA
		aaFactor: f32,
	#endif
}
`,gsplatQuatToMat3VS:`
fn quatToMat3(R: vec4<f32>) -> mat3x3<f32> {
	let R2: vec4<f32> = R + R;
	let X: f32	   = R2.x * R.w;
	let Y: vec4<f32> = R2.y * R;
	let Z: vec4<f32> = R2.z * R;
	let W: f32	   = R2.w * R.w;
	return mat3x3<f32>(
		1.0 - Z.z - W,  Y.z + X,	  Y.w - Z.x,
		Y.z - X,		1.0 - Y.y - W, Z.w + Y.x,
		Y.w + Z.x,	  Z.w - Y.x,	 1.0 - Y.y - Z.z
	);
}
fn quatMul(a: vec4<f32>, b: vec4<f32>) -> vec4<f32> {
	return vec4<f32>(
		a.w * b.x + a.x * b.w + a.y * b.z - a.z * b.y,
		a.w * b.y - a.x * b.z + a.y * b.w + a.z * b.x,
		a.w * b.z + a.x * b.y - a.y * b.x + a.z * b.w,
		a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z
	);
}
`,gsplatOutputVS:`
#include "tonemappingPS"
#include "decodePS"
#include "gammaPS"
fn prepareOutputFromGamma(gammaColor: vec3f) -> vec3f {
	#if TONEMAP == NONE
		#if GAMMA == NONE
			return decodeGamma3(gammaColor);
		#else 
			return gammaColor;
		#endif
	#else
		return gammaCorrectOutput(toneMap(decodeGamma3(gammaColor)));
	#endif
}
`,gsplatPS:`
#ifndef DITHER_NONE
	#include "bayerPS"
	#include "opacityDitherPS"
	varying id: f32;
#endif
#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)
	uniform alphaClip: f32;
#endif
#ifdef PREPASS_PASS
	varying vLinearDepth: f32;
	#include "floatAsUintPS"
#endif
const EXP4	  = exp(-4.0);
const INV_EXP4  = 1.0 / (1.0 - EXP4);
fn normExp(x: f32) -> f32 {
	return (exp(x * -4.0) - EXP4) * INV_EXP4;
}
varying gaussianUV: vec2f;
varying gaussianColor: vec4f;
#if defined(GSPLAT_UNIFIED_ID) && defined(PICK_PASS)
	varying @interpolate(flat) vPickId: u32;
#endif
#ifdef PICK_PASS
	#include "pickPS"
#endif
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let A: f32 = dot(gaussianUV, gaussianUV);
	if (A > 1.0) {
		discard;
		return output;
	}
	var alpha = normExp(A) * gaussianColor.a;
	#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)
		if (alpha < uniform.alphaClip) {
			discard;
			return output;
		}
	#endif
	#ifdef PICK_PASS
		#ifdef GSPLAT_UNIFIED_ID
			output.color = encodePickOutput(vPickId);
		#else
			output.color = getPickOutput();
		#endif
		#ifdef DEPTH_PICK_PASS
			output.color1 = getPickDepth();
		#endif
	#elif SHADOW_PASS
		output.color = vec4f(0.0, 0.0, 0.0, 1.0);
	#elif PREPASS_PASS
		output.color = float2vec4(vLinearDepth);
	#else
		if (alpha < (1.0 / 255.0)) {
			discard;
			return output;
		}
		#ifndef DITHER_NONE
			opacityDither(&alpha, id * 0.013);
		#endif
		output.color = vec4f(input.gaussianColor.xyz * alpha, alpha);
	#endif
	return output;
}`,gsplatSourceVS:`
attribute vertex_position: vec3f;
attribute vertex_id_attrib: u32;
uniform numSplats: u32;
#ifdef STORAGE_ORDER
	var<storage, read> splatOrder: array<u32>;
#else
	var splatOrder: texture_2d<u32>;
#endif
fn initSource(source: ptr<function, SplatSource>) -> bool {
	(*source).order = vertex_id_attrib + u32(vertex_position.z);
	if ((*source).order >= uniform.numSplats) {
		return false;
	}
	var splatId: u32;
	#ifdef STORAGE_ORDER
		splatId = splatOrder[(*source).order];
	#else
		let uv = vec2u((*source).order % uniform.splatTextureSize, (*source).order / uniform.splatTextureSize);
		splatId = textureLoad(splatOrder, vec2i(uv), 0).r;
	#endif
	setSplat(splatId);
	(*source).cornerUV = vertex_position.xy;
	return true;
}
`,gsplatVS:`
#include "gsplatCommonVS"
varying gaussianUV: vec2f;
varying gaussianColor: vec4f;
#ifndef DITHER_NONE
	varying id: f32;
#endif
const discardVec: vec4f = vec4f(0.0, 0.0, 2.0, 1.0);
#ifdef PREPASS_PASS
	varying vLinearDepth: f32;
#endif
#if defined(GSPLAT_UNIFIED_ID) && defined(PICK_PASS)
	varying @interpolate(flat) vPickId: u32;
#endif
#ifdef GSPLAT_OVERDRAW
	uniform colorRampIntensity: f32;
	var colorRamp: texture_2d<f32>;
	var colorRampSampler: sampler;
#endif
@vertex
fn vertexMain(input: VertexInput) -> VertexOutput {
	var output: VertexOutput;
	var source: SplatSource;
	if (!initSource(&source)) {
		output.position = discardVec;
		return output;
	}
	var modelCenter: vec3f = getCenter();
	var center: SplatCenter;
	center.modelCenterOriginal = modelCenter;
	
	modifySplatCenter(&modelCenter);
	center.modelCenterModified = modelCenter;
	if (!initCenter(modelCenter, &center)) {
		output.position = discardVec;
		return output;
	}
	var corner: SplatCorner;
	if (!initCorner(&source, &center, &corner)) {
		output.position = discardVec;
		return output;
	}
	var clr: vec4f = getColor();
	#if GSPLAT_AA
		clr.a = clr.a * corner.aaFactor;
	#endif
	#if SH_BANDS > 0
		let modelView3x3 = mat3x3f(center.modelView[0].xyz, center.modelView[1].xyz, center.modelView[2].xyz);
		let dir = normalize(center.view * modelView3x3);
		var sh: array<vec3f, SH_COEFFS>;
		var scale: f32;
		readSHData(&sh, &scale);
		clr = vec4f(clr.xyz + evalSH(&sh, dir) * scale, clr.a);
	#endif
	modifySplatColor(modelCenter, &clr);
	clipCorner(&corner, clr.w);
	#if GSPLAT_2DGS
		let modelCorner: vec3f = center.modelCenterModified + corner.offset;
		output.position = uniform.matrix_projection * center.modelView * vec4f(modelCorner, 1.0);
	#else
		output.position = center.proj + vec4f(corner.offset.xyz, 0.0);
	#endif
	output.gaussianUV = corner.uv;
	#ifdef GSPLAT_OVERDRAW
		let t: f32 = clamp(originalCenter.y / 20.0, 0.0, 1.0);
		let rampColor: vec3f = textureSampleLevel(colorRamp, colorRampSampler, vec2f(t, 0.5), 0.0).rgb;
		clr.a = clr.a * (1.0 / 32.0) * uniform.colorRampIntensity;
		output.gaussianColor = vec4f(rampColor, clr.a);
	#else
		output.gaussianColor = vec4f(prepareOutputFromGamma(max(clr.xyz, vec3f(0.0))), clr.w);
	#endif
	#ifndef DITHER_NONE
		output.id = f32(splat.index);
	#endif
	#ifdef PREPASS_PASS
		output.vLinearDepth = -center.view.z;
	#endif
	#if defined(GSPLAT_UNIFIED_ID) && defined(PICK_PASS)
		output.vPickId = loadPcId().r;
	#endif
	return output;
}
`,gsplatPackingPS:uq,gsplatFormatVS:`
uniform splatTextureSize: u32;
`,gsplatUncompressedVS:`
var<private> tAw: u32;
var<private> tBcached: vec4f;
fn unpackRotation(packed: vec3f) -> vec4f {
	return vec4f(packed.xyz, sqrt(max(0.0, 1.0 - dot(packed, packed))));
}
fn getCenter() -> vec3f {
	let tA: vec4<u32> = loadTransformA();
	tAw = tA.w;
	tBcached = loadTransformB();
	return bitcast<vec3f>(tA.xyz);
}
fn getColor() -> vec4f {
	return loadSplatColor();
}
fn getRotation() -> vec4f {
	return unpackRotation(vec3f(unpack2x16float(tAw), tBcached.w)).wxyz;
}
fn getScale() -> vec3f {
	return tBcached.xyz;
}
#include "gsplatUncompressedSHVS"
`,gsplatUncompressedSHVS:`
#if SH_BANDS > 0
fn unpack111011s(bits: u32) -> vec3f {
	return (vec3f((vec3<u32>(bits) >> vec3<u32>(21u, 11u, 0u)) & vec3<u32>(0x7ffu, 0x3ffu, 0x7ffu)) / vec3f(2047.0, 1023.0, 2047.0)) * 2.0 - 1.0;
}
struct ScaleAndSH {
	scale: f32,
	a: vec3f,
	b: vec3f,
	c: vec3f
};
fn fetchScale(t_in: vec4<u32>) -> ScaleAndSH {
	var result: ScaleAndSH;
	result.scale = bitcast<f32>(t_in.x);
	result.a = unpack111011s(t_in.y);
	result.b = unpack111011s(t_in.z);
	result.c = unpack111011s(t_in.w);
	return result;
}
struct SH {
	a: vec3f,
	b: vec3f,
	c: vec3f,
	d: vec3f
};
fn fetch4(t_in: vec4<u32>) -> SH {
	var result: SH;
	result.a = unpack111011s(t_in.x);
	result.b = unpack111011s(t_in.y);
	result.c = unpack111011s(t_in.z);
	result.d = unpack111011s(t_in.w);
	return result;
}
fn fetch1(t_in: u32) -> vec3f {
	return unpack111011s(t_in);
}
#if SH_BANDS == 1
	fn readSHData(sh: ptr<function, array<vec3f, 3>>, scale: ptr<function, f32>) {
		let result = fetchScale(loadSplatSH_1to3());
		*scale = result.scale;
		sh[0] = result.a;
		sh[1] = result.b;
		sh[2] = result.c;
	}
#elif SH_BANDS == 2
	fn readSHData(sh: ptr<function, array<vec3f, 8>>, scale: ptr<function, f32>) {
		let first: ScaleAndSH = fetchScale(loadSplatSH_1to3());
		*scale = first.scale;
		sh[0] = first.a;
		sh[1] = first.b;
		sh[2] = first.c;
		let second: SH = fetch4(loadSplatSH_4to7());
		sh[3] = second.a;
		sh[4] = second.b;
		sh[5] = second.c;
		sh[6] = second.d;
		sh[7] = fetch1(loadSplatSH_8to11().x);
	}
#else
	fn readSHData(sh: ptr<function, array<vec3f, 15>>, scale: ptr<function, f32>) {
		let first: ScaleAndSH = fetchScale(loadSplatSH_1to3());
		*scale = first.scale;
		sh[0] = first.a;
		sh[1] = first.b;
		sh[2] = first.c;
		let second: SH = fetch4(loadSplatSH_4to7());
		sh[3] = second.a;
		sh[4] = second.b;
		sh[5] = second.c;
		sh[6] = second.d;
		let third: SH = fetch4(loadSplatSH_8to11());
		sh[7] = third.a;
		sh[8] = third.b;
		sh[9] = third.c;
		sh[10] = third.d;
		let fourth: SH = fetch4(loadSplatSH_12to15());
		sh[11] = fourth.a;
		sh[12] = fourth.b;
		sh[13] = fourth.c;
		sh[14] = fourth.d;
	}
#endif
#endif
`,gsplatCompressedVS:`
#include "gsplatPackingPS"
var chunkTexture: texture_2d<f32>;
var<private> chunkDataA: vec4f;
var<private> chunkDataB: vec4f;
var<private> chunkDataC: vec4f;
var<private> chunkDataD: vec4f;
var<private> chunkDataE: vec4f;
var<private> packedData: vec4u;
fn unpack111011(bits: u32) -> vec3f {
	return (vec3f((vec3<u32>(bits) >> vec3<u32>(21u, 11u, 0u)) & vec3<u32>(0x7ffu, 0x3ffu, 0x7ffu))) / vec3f(2047.0, 1023.0, 2047.0);
}
const norm_const: f32 = sqrt(2.0);
fn unpackRotation(bits: u32) -> vec4f {
	let a = (f32((bits >> 20u) & 0x3ffu) / 1023.0 - 0.5) * norm_const;
	let b = (f32((bits >> 10u) & 0x3ffu) / 1023.0 - 0.5) * norm_const;
	let c = (f32(bits & 0x3ffu) / 1023.0 - 0.5) * norm_const;
	let m = sqrt(1.0 - (a * a + b * b + c * c));
	let mode = bits >> 30u;
	if (mode == 0u) { return vec4f(m, a, b, c); }
	if (mode == 1u) { return vec4f(a, m, b, c); }
	if (mode == 2u) { return vec4f(a, b, m, c); }
	return vec4f(a, b, c, m);
}
fn getCenter() -> vec3f {
	let tex_size_u = textureDimensions(chunkTexture, 0);
	let w: u32 = tex_size_u.x / 5u;
	let chunkId: u32 = splat.index / 256u;
	let chunkUV: vec2<i32> = vec2<i32>(i32((chunkId % w) * 5u), i32(chunkId / w));
	chunkDataA = textureLoad(chunkTexture, chunkUV + vec2<i32>(0, 0), 0);
	chunkDataB = textureLoad(chunkTexture, chunkUV + vec2<i32>(1, 0), 0);
	chunkDataC = textureLoad(chunkTexture, chunkUV + vec2<i32>(2, 0), 0);
	chunkDataD = textureLoad(chunkTexture, chunkUV + vec2<i32>(3, 0), 0);
	chunkDataE = textureLoad(chunkTexture, chunkUV + vec2<i32>(4, 0), 0);
	packedData = loadPackedTexture();
	return mix(chunkDataA.xyz, vec3f(chunkDataA.w, chunkDataB.xy), unpack111011(packedData.x));
}
fn getColor() -> vec4f {
	let r = unpack8888(packedData.w);
	return vec4f(mix(chunkDataD.xyz, vec3f(chunkDataD.w, chunkDataE.xy), r.rgb), r.w);
}
fn getRotation() -> vec4f {
	return unpackRotation(packedData.y);
}
fn getScale() -> vec3f {
	return exp(mix(vec3f(chunkDataB.zw, chunkDataC.x), chunkDataC.yzw, unpack111011(packedData.z)));
}
#include "gsplatCompressedSHVS"
`,gsplatCompressedSHVS:`
#if SH_BANDS > 0
fn unpack8888s(bits: u32) -> vec4f {
	let unpacked_u = (vec4<u32>(bits) >> vec4<u32>(0u, 8u, 16u, 24u)) & vec4<u32>(0xffu);
	return vec4f(unpacked_u) * (8.0 / 255.0) - 4.0;
}
fn readSHData(sh: ptr<function, array<vec3f, 15>>, scale: ptr<function, f32>) {
	let shData0: vec4<u32> = loadShTexture0();
	let shData1: vec4<u32> = loadShTexture1();
	let shData2: vec4<u32> = loadShTexture2();
	let r0 = unpack8888s(shData0.x);
	let r1 = unpack8888s(shData0.y);
	let r2 = unpack8888s(shData0.z);
	let r3 = unpack8888s(shData0.w);
	let g0 = unpack8888s(shData1.x);
	let g1 = unpack8888s(shData1.y);
	let g2 = unpack8888s(shData1.z);
	let g3 = unpack8888s(shData1.w);
	let b0 = unpack8888s(shData2.x);
	let b1 = unpack8888s(shData2.y);
	let b2 = unpack8888s(shData2.z);
	let b3 = unpack8888s(shData2.w);
	sh[0] =  vec3f(r0.x, g0.x, b0.x);
	sh[1] =  vec3f(r0.y, g0.y, b0.y);
	sh[2] =  vec3f(r0.z, g0.z, b0.z);
	sh[3] =  vec3f(r0.w, g0.w, b0.w);
	sh[4] =  vec3f(r1.x, g1.x, b1.x);
	sh[5] =  vec3f(r1.y, g1.y, b1.y);
	sh[6] =  vec3f(r1.z, g1.z, b1.z);
	sh[7] =  vec3f(r1.w, g1.w, b1.w);
	sh[8] =  vec3f(r2.x, g2.x, b2.x);
	sh[9] =  vec3f(r2.y, g2.y, b2.y);
	sh[10] = vec3f(r2.z, g2.z, b2.z);
	sh[11] = vec3f(r2.w, g2.w, b2.w);
	sh[12] = vec3f(r3.x, g3.x, b3.x);
	sh[13] = vec3f(r3.y, g3.y, b3.y);
	sh[14] = vec3f(r3.z, g3.z, b3.z);
	*scale = 1.0;
}
#endif
`,gsplatSogVS:`
#include "gsplatPackingPS"
uniform means_mins: vec3f;
uniform means_maxs: vec3f;
uniform scales_mins: f32;
uniform scales_maxs: f32;
uniform sh0_mins: f32;
uniform sh0_maxs: f32;
var packedSh0: texture_2d<f32>;
const SH_C0: f32 = 0.28209479177387814;
var<private> packedSample: vec4<u32>;
const norm: f32 = sqrt(2.0);
fn getCenter() -> vec3f {
	packedSample = loadPackedTexture();
	let l = unpack8888(packedSample.x).xyz;
	let u = unpack8888(packedSample.y).xyz;
	let n = (l + u * 256.0) / 257.0;
	let v = mix(uniform.means_mins, uniform.means_maxs, n);
	return sign(v) * (exp(abs(v)) - 1.0);
}
fn getColor() -> vec4f {
	let clr = mix(vec3f(uniform.sh0_mins), vec3f(uniform.sh0_maxs), unpack111110(pack8888(textureLoad(packedSh0, splat.uv, 0))));
	let alpha = f32(packedSample.z & 0xffu) / 255.0;
	return vec4f(vec3f(0.5) + clr * SH_C0, alpha);
}
fn getRotation() -> vec4f {
	let qdata = unpack8888(packedSample.z).xyz;
	let qmode = packedSample.w & 0x3u;
	let abc = (qdata - 0.5) * norm;
	let d = sqrt(max(0.0, 1.0 - dot(abc, abc)));
	var quat: vec4f;
	if (qmode == 0u) {
		quat = vec4f(d, abc);
	} else if (qmode == 1u) {
		quat = vec4f(abc.x, d, abc.y, abc.z);
	} else if (qmode == 2u) {
		quat = vec4f(abc.x, abc.y, d, abc.z);
	} else {
		quat = vec4f(abc.x, abc.y, abc.z, d);
	}
	return quat;
}
fn getScale() -> vec3f {
	let sdata = unpack101010(packedSample.w >> 2u);
	return exp(mix(vec3f(uniform.scales_mins), vec3f(uniform.scales_maxs), sdata));
}
#include "gsplatSogSHVS"
`,gsplatSogSHVS:`
#if SH_BANDS > 0
var packedShN: texture_2d<f32>;
uniform shN_mins: f32;
uniform shN_maxs: f32;
fn readSHData(sh: ptr<function, array<vec3f, SH_COEFFS>>, scale: ptr<function, f32>) {
	let t = vec2i(packedSample.xy & vec2u(255u));
	let n = t.x + t.y * 256;
	let u = (n % 64) * SH_COEFFS;
	let v = n / 64;
	for (var i: i32 = 0; i < SH_COEFFS; i = i + 1) {
		sh[i] = mix(vec3f(uniform.shN_mins), vec3f(uniform.shN_maxs), unpack111110(pack8888(textureLoad(packedShN, vec2i(u + i, v), 0))));
	}
	*scale = 1.0;
}
#endif
`,gsplatContainerDeclVS:`
#include "gsplatContainerDeclarationsVS"
var<private> splatCenter: vec3f;
var<private> splatColor: vec4f;
var<private> splatScale: vec3f;
var<private> splatRotation: vec4f;
`,gsplatContainerReadVS:`
fn getCenter() -> vec3f {
	#include "gsplatContainerUserReadVS"
	return splatCenter;
}
fn getRotation() -> vec4f {
	return splatRotation;
}
fn getScale() -> vec3f {
	return splatScale;
}
fn getColor() -> vec4f {
	return splatColor;
}
`,gsplatContainerPackedReadVS:`
var<private> cachedTransformA: vec4u;
var<private> cachedTransformB: vec2u;
fn getCenter() -> vec3f {
	cachedTransformA = loadDataTransformA();
	cachedTransformB = loadDataTransformB().xy;
	return vec3f(bitcast<f32>(cachedTransformA.r), bitcast<f32>(cachedTransformA.g), bitcast<f32>(cachedTransformA.b));
}
fn getColor() -> vec4f {
	#ifdef GSPLAT_COLOR_FLOAT
		return loadDataColor();
	#else
		let packedColor = loadDataColor();
		let packed_rg = packedColor.r | (packedColor.g << 16u);
		let packed_ba = packedColor.b | (packedColor.a << 16u);
		return vec4f(unpack2x16float(packed_rg), unpack2x16float(packed_ba));
	#endif
}
fn getRotation() -> vec4f {
	let rotXY = unpack2x16float(cachedTransformA.a);
	let rotZscaleX = unpack2x16float(cachedTransformB.x);
	let rotXYZ = vec3f(rotXY, rotZscaleX.x);
	return vec4f(rotXYZ, sqrt(max(0.0, 1.0 - dot(rotXYZ, rotXYZ)))).wxyz;
}
fn getScale() -> vec3f {
	let rotZscaleX = unpack2x16float(cachedTransformB.x);
	let scaleYZ = unpack2x16float(cachedTransformB.y);
	return vec3f(rotZscaleX.y, scaleYZ);
}
`,gsplatContainerFloatReadVS:cS},Sn=["enabled"],So=["unified","lodDistances","castShadows","material","highQualitySH","asset","resource","layers"];class Sl extends f8{initializeComponentData(e,t,i){t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let i=0;i<So.length;i++)t.hasOwnProperty(So[i])&&(e[So[i]]=t[So[i]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new eC(new ed(t.aabbCenter),new ed(t.aabbHalfExtents))),super.initializeComponentData(e,t,Sn);}cloneComponent(e,t){let i=e.gsplat,s={};So.forEach(e=>{if("material"===e){if(!i.unified){let t=i[e];t&&(s[e]=t.clone());}}else s[e]=i[e];}),s.enabled=i.enabled;let r=this.addComponent(t,s);return r.customAabb=i.customAabb?.clone()??null,r}onRemove(e,t){t.onRemove();}getMaterial(e,t){let i=this.app.renderer.gsplatDirector;if(!i)return null;let s=i.camerasMap.get(e);if(!s)return null;let r=s.layersMap.get(t);return r?.gsplatManager?.material??null}getGSplatMaterial(e,t){return this.getMaterial(e,t)}constructor(e){super(e),this.id="gsplat",this.ComponentType=Si,this.DataType=Ss,this.schema=Sn,e.renderer.gsplatDirector=new St(e.graphicsDevice,e.renderer,e.scene,this),nH.get(e.graphicsDevice,tz).add(Sr),nH.get(e.graphicsDevice,tV).add(Sa),this.on("beforeremove",this.onRemove,this);}}Sl.EVENT_MATERIALCREATED="material:created",Sl.EVENT_FRAMEREADY="frame:ready",f5._buildAccessors(Si.prototype,Sn);class Sh extends X{set meshes(e){this.decRefMeshes(),this._meshes=e,this.incRefMeshes(),this.fire("set:meshes",e);}get meshes(){return this._meshes}destroy(){this.meshes=null;}decRefMeshes(){this._meshes?.forEach((e,t)=>{e&&(e.decRefCount(),e.refCount<1&&(e.destroy(),this._meshes[t]=null));});}incRefMeshes(){this._meshes?.forEach(e=>{e?.incRefCount();});}constructor(...e){super(...e),this._meshes=null;}}function Sc(e){if(!this.resource)return;let t=e.resource,i=t.renders&&t.renders[this.data.renderIndex];i&&(this.resource.meshes=i.resource.meshes);}function Sd(e){this.registry.off(`load:${e.id}`,Sc,this),this.registry.on(`load:${e.id}`,Sc,this),this.registry.off(`remove:${e.id}`,Su,this),this.registry.once(`remove:${e.id}`,Su,this),e.resource?Sc.call(this,e):this.registry.load(e);}function Su(e){this.registry.off(`load:${e.id}`,Sc,this),this.resource&&this.resource.destroy();}Sh.EVENT_SETMESHES="set:meshes";class Sf extends fC{open(e,t){return new Sh}patch(e,t){if(!e.data.containerAsset)return;let i=t.get(e.data.containerAsset);i?Sd.call(e,i):t.once(`add:${e.data.containerAsset}`,Sd,e);}constructor(e){super(e,"render"),this._registry=e.assets;}}class Sp{get paths(){return this._paths}get input(){return this._input}get output(){return this._output}get interpolation(){return this._interpolation}constructor(e,t,i,s){this._paths=e,this._input=t,this._output=i,this._interpolation=s;}}class Sm{get components(){return this._components}get data(){return this._data}constructor(e,t){this._components=e,this._data=t;}}function S_(e,t){let i,s=(e,t)=>{switch(t){case i.DT_INT8:return new Int8Array(e.buffer,e.byteOffset,e.byteLength);case i.DT_INT16:return new Int16Array(e.buffer,e.byteOffset,e.byteLength/2);case i.DT_INT32:return new Int32Array(e.buffer,e.byteOffset,e.byteLength/4);case i.DT_UINT8:return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);case i.DT_UINT16:return new Uint16Array(e.buffer,e.byteOffset,e.byteLength/2);case i.DT_UINT32:return new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4);case i.DT_FLOAT32:return new Float32Array(e.buffer,e.byteOffset,e.byteLength/4)}return null},r=e=>e.num_components()*(e=>{switch(e){case i.DT_INT8:break;case i.DT_INT16:return 2;case i.DT_INT32:return 4;case i.DT_UINT8:break;case i.DT_UINT16:return 2;case i.DT_UINT32:case i.DT_FLOAT32:return 4}return 1})(e.data_type()),a={0:0,1:1,5:2,2:3,7:4,8:5,4:6,3:7},n=(e,t)=>{let i=(e,t,i)=>{e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2];},s=(e,t,i)=>{e[0]=t[1]*i[2]-i[1]*t[2],e[1]=t[2]*i[0]-i[2]*t[0],e[2]=t[0]*i[1]-i[0]*t[1];},r=(e,t)=>{let i=e[t+0],s=e[t+1],r=e[t+2],a=1/Math.sqrt(i*i+s*s+r*r);e[t+0]*=a,e[t+1]*=a,e[t+2]*=a;},a=(e,t,i)=>{for(let s=0;s<3;++s)e[s]=t[i+s];},n=t.length/3,o=e.length/3,l=new Float32Array(e.length),h=[0,0,0],c=[0,0,0],d=[0,0,0],u=[0,0,0],f=[0,0,0],p=[0,0,0];for(let o=0;o<n;++o){let n=3*t[3*o+0],m=3*t[3*o+1],_=3*t[3*o+2];a(h,e,n),a(c,e,m),a(d,e,_),i(u,c,h),i(f,d,h),s(p,u,f),r(p,0);for(let e=0;e<3;++e)l[n+e]+=p[e],l[m+e]+=p[e],l[_+e]+=p[e];}for(let e=0;e<o;++e)r(l,3*e);return new Uint8Array(l.buffer)},o=e=>{let t=(e=>{let t={},o=new i.DecoderBuffer;o.Init(e,e.length);let l=new i.Decoder;if(l.GetEncodedGeometryType(o)!==i.TRIANGULAR_MESH)return t.error="Failed to decode draco mesh: not a mesh",t;let h=new i.Mesh,c=l.DecodeBufferToMesh(o,h);if(!c||!c.ok()||0===i.getPointer(h))return t.error="Failed to decode draco asset",t;let d=3*h.num_faces(),u=65535>=h.num_points(),f=d*(u?2:4),p=i._malloc(f);u?(l.GetTrianglesUInt16Array(h,f,p),t.indices=new Uint16Array(i.HEAPU16.buffer,p,d).slice().buffer):(l.GetTrianglesUInt32Array(h,f,p),t.indices=new Uint32Array(i.HEAPU32.buffer,p,d).slice().buffer),i._free(p);let m=[];for(let e=0;e<h.num_attributes();++e)m.push(l.GetAttribute(h,e));m.sort((e,t)=>(a[e.attribute_type()]??a.length)-(a[t.attribute_type()]??a.length));let _=0,g=m.map(e=>{let t=_;return _+=4*Math.ceil(r(e)/4),t}),v=m.some(e=>1===e.attribute_type()),S=g[1]??0;if(!v){S=g[0]+4*Math.ceil(r(m[0])/4);for(let e=1;e<g.length;++e)g[e]+=12;_+=12;}t.attributes=m.map((e,t)=>({id:e.unique_id(),dataType:(e=>{switch(e){case i.DT_INT8:return 0;case i.DT_UINT8:return 1;case i.DT_INT16:return 2;case i.DT_UINT16:return 3;case i.DT_INT32:return 4;case i.DT_UINT32:return 5;case i.DT_FLOAT32:default:return 6}})(e.data_type()),numComponents:e.num_components(),offset:g[t]})),v||t.attributes.splice(1,0,{id:-1,dataType:6,numComponents:3,offset:S}),t.stride=_,t.vertices=new ArrayBuffer(h.num_points()*_);let y=new Uint8Array(t.vertices);for(let e=0;e<h.num_attributes();++e){let a=m[e],o=r(a),c=h.num_points()*o,d=i._malloc(c);l.GetAttributeDataArrayForAllPoints(h,a,a.data_type(),c,d);let f=new Uint8Array(i.HEAPU8.buffer,d,c);for(let t=0;t<h.num_points();++t)for(let i=0;i<o;++i)y[t*_+g[e]+i]=f[t*o+i];if(!v&&0===a.attribute_type()){let e=n(s(f,a.data_type()),u?new Uint16Array(t.indices):new Uint32Array(t.indices));for(let t=0;t<h.num_points();++t)for(let i=0;i<12;++i)y[t*_+S+i]=e[12*t+i];}i._free(d);}return i.destroy(h),i.destroy(l),i.destroy(o),t})(new Uint8Array(e.buffer));self.postMessage({jobId:e.jobId,error:t.error,indices:t.indices,vertices:t.vertices,attributes:t.attributes,stride:t.stride},[t.indices,t.vertices].filter(e=>null!=e));},l=[];self.onmessage=e=>{let t=e.data;switch(t.type){case "init":self.DracoDecoderModule({instantiateWasm:(e,i)=>(WebAssembly.instantiate(t.module,e).then(e=>i(e)).catch(e=>void 0),{})}).then(e=>{i=e,l.forEach(e=>o(e));});break;case "decodeMesh":i?o(t):l.push(t);}};}class Sg{init(e){for(e.forEach(e=>{e.addEventListener("message",t=>{let i=t.data,s=this.jobCallbacks.get(i.jobId);if(s&&s(i.error,{indices:i.indices,vertices:i.vertices,attributes:i.attributes,stride:i.stride}),this.jobCallbacks.delete(i.jobId),this.jobQueue.length>0){let t=this.jobQueue.shift();this.run(e,t);}else {let t=this.workers[2].indexOf(e);if(-1!==t)this.workers[2].splice(t,1),this.workers[1].push(e);else {let t=this.workers[1].indexOf(e);-1!==t&&(this.workers[1].splice(t,1),this.workers[0].push(e));}}});}),this.workers[0]=e;this.jobQueue.length&&(this.workers[0].length||this.workers[1].length);){let e=this.jobQueue.shift();if(this.workers[0].length>0){let t=this.workers[0].shift();this.workers[1].push(t),this.run(t,e);}else {let t=this.workers[1].shift();this.workers[2].push(t),this.run(t,e);}}}enqueueJob(e,t){let i={jobId:this.jobId++,buffer:e};if(this.jobCallbacks.set(i.jobId,t),this.workers[0].length>0){let e=this.workers[0].shift();this.workers[1].push(e),this.run(e,i);}else if(this.workers[1].length>0){let e=this.workers[1].shift();this.workers[2].push(e),this.run(e,i);}else this.jobQueue.push(i);}constructor(){this.workers=[[],[],[]],this.jobId=0,this.jobQueue=[],this.jobCallbacks=new Map,this.run=(e,t)=>{e.postMessage({type:"decodeMesh",jobId:t.jobId,buffer:t.buffer},[t.buffer]);};}}let Sv=e=>{var t;let i,s;if(m)return  true;if(!e)if(_)e=_;else {let t=$.getConfig("DracoDecoderModule");e=t?{jsUrl:t.glueUrl,wasmUrl:t.wasmUrl,numWorkers:t.numWorkers}:{jsUrl:"draco.wasm.js",wasmUrl:"draco.wasm.wasm",numWorkers:1};}return !!e.jsUrl&&!!e.wasmUrl&&(m=new Sg,Promise.all([(i=e.jsUrl,new Promise((e,t)=>{a$.get(i,{cache:true,responseType:"text",retry:true,maxRetries:3},(i,s)=>{i?t(i):e(s);});})),(t=e.wasmUrl,s=()=>fetch(t).then(e=>e.arrayBuffer()).then(e=>WebAssembly.compile(e)),WebAssembly.compileStreaming?WebAssembly.compileStreaming(fetch(t)).catch(e=>s()):s())]).then(([t,i])=>{let s=new Blob([["/* draco */",t,"/* worker */",`(
${S_.toString()}
)()

`].join("\n")],{type:"application/javascript"}),r=URL.createObjectURL(s),a=Math.max(1,Math.min(16,e.numWorkers||1)),n=[];for(let e=0;e<a;++e){let e=new Worker(r);e.postMessage({type:"init",module:i}),n.push(e);}m.init(n);}),true)};class SS{destroy(){this.renders&&this.renders.forEach(e=>{e.meshes=null;});}}let Sy=e=>{switch(e){case "SCALAR":return 1;case "VEC2":return 2;case "VEC3":default:return 3;case "VEC4":case "MAT2":return 4;case "MAT3":return 9;case "MAT4":return 16}},Sx=e=>{switch(e){case 5120:default:return 0;case 5121:return 1;case 5122:return 2;case 5123:return 3;case 5124:return 4;case 5125:return 5;case 5126:return 6}},ST=e=>{switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}},SE={POSITION:e6,NORMAL:e9,TANGENT:e7,COLOR_0:ti,JOINTS_0:tt,WEIGHTS_0:te,TEXCOORD_0:tr,TEXCOORD_1:ta,TEXCOORD_2:tn,TEXCOORD_3:to,TEXCOORD_4:tl,TEXCOORD_5:th,TEXCOORD_6:tc,TEXCOORD_7:td},Sw={[e6]:0,[e9]:1,[e7]:2,[ti]:3,[tt]:4,[te]:5,[tr]:6,[ta]:7,[tn]:8,[to]:9,[tl]:10,[th]:11,[tc]:12,[td]:13},Sb=(e,t,i)=>{let s=(e=>{switch(e){case 0:return e=>Math.max(e/127,-1);case 1:return e=>e/255;case 2:return e=>Math.max(e/32767,-1);case 3:return e=>e/65535;default:return e=>e}})(i),r=t.length;for(let i=0;i<r;++i)e[i]=s(t[i]);return e},SA=(e,t,i=false)=>{let s,r=Sy(e.type),a=(e=>{switch(e){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}})(e.componentType);if(!a)return null;if(e.sparse){let i=e.sparse,n=SA(Object.assign({count:i.count,type:"SCALAR"},i.indices),t,true),o=SA(Object.assign({count:i.count,type:e.type,componentType:e.componentType},i.values),t,true);s=e.hasOwnProperty("bufferView")?SA({bufferView:e.bufferView,byteOffset:e.byteOffset,componentType:e.componentType,count:e.count,type:e.type},t,true).slice():new a(e.count*r);for(let e=0;e<i.count;++e){let t=n[e];for(let i=0;i<r;++i)s[t*r+i]=o[e*r+i];}}else if(e.hasOwnProperty("bufferView")){let n=t[e.bufferView];if(i&&n.hasOwnProperty("byteStride")){let t=r*a.BYTES_PER_ELEMENT,i=new ArrayBuffer(e.count*t),o=new Uint8Array(i),l=0;for(let i=0;i<e.count;++i){let s=(e.byteOffset||0)+i*n.byteStride;for(let e=0;e<t;++e)o[l++]=n[s++];}s=new a(i);}else s=new a(n.buffer,n.byteOffset+(e.byteOffset||0),e.count*r);}else s=new a(e.count*r);return s},SC=(e,t)=>{let i=SA(e,t,true);if(i instanceof Float32Array||!e.normalized)return i;let s=new Float32Array(i.length);return Sb(s,i,Sx(e.componentType)),s},SP=e=>{let t=e.min,i=e.max;if(!t||!i)return null;if(e.normalized){let s=Sx(e.componentType);t=Sb([],t,s),i=Sb([],i,s);}return new eC(new ed((i[0]+t[0])*.5,(i[1]+t[1])*.5,(i[2]+t[2])*.5),new ed((i[0]-t[0])*.5,(i[1]-t[1])*.5,(i[2]-t[2])*.5))},SI=e=>{if(!e.hasOwnProperty("mode"))return 4;switch(e.mode){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:default:return 4;case 5:return 5;case 6:return 6}},SD=(e,t,i)=>{let s,r=e.texCoord;if(r)for(s=0;s<i.length;++s)t[`${i[s]}MapUv`]=r;let a=e.extensions?.KHR_texture_transform;if(a){let e=a.offset||[0,0],r=a.scale||[1,1],n=a.rotation?-a.rotation*ei.RAD_TO_DEG:0,o=new ef(r[0],r[1]),l=new ef(e[0],1-r[1]-e[1]);for(s=0;s<i.length;++s)t[`${i[s]}MapTiling`]=o,t[`${i[s]}MapOffset`]=l,t[`${i[s]}MapRotation`]=n;}},SR=(e,t,i)=>{let s;if(e.hasOwnProperty("diffuseFactor")){let[i,s,r,a]=e.diffuseFactor;t.diffuse.set(i,s,r).gamma(),t.opacity=a;}else t.diffuse.set(1,1,1),t.opacity=1;if(e.hasOwnProperty("diffuseTexture")){let r=e.diffuseTexture;t.diffuseMap=s=i[r.index],t.diffuseMapChannel="rgb",t.opacityMap=s,t.opacityMapChannel="a",SD(r,t,["diffuse","opacity"]);}if(t.useMetalness=false,e.hasOwnProperty("specularFactor")){let[i,s,r]=e.specularFactor;t.specular.set(i,s,r).gamma();}else t.specular.set(1,1,1);if(e.hasOwnProperty("glossinessFactor")?t.gloss=e.glossinessFactor:t.gloss=1,e.hasOwnProperty("specularGlossinessTexture")){let s=e.specularGlossinessTexture;t.specularMap=t.glossMap=i[s.index],t.specularMapChannel="rgb",t.glossMapChannel="a",SD(s,t,["gloss","metalness"]);}},SL=(e,t,i)=>{if(e.hasOwnProperty("clearcoatFactor")?t.clearCoat=.25*e.clearcoatFactor:t.clearCoat=0,e.hasOwnProperty("clearcoatTexture")){let s=e.clearcoatTexture;t.clearCoatMap=i[s.index],t.clearCoatMapChannel="r",SD(s,t,["clearCoat"]);}if(e.hasOwnProperty("clearcoatRoughnessFactor")?t.clearCoatGloss=e.clearcoatRoughnessFactor:t.clearCoatGloss=0,e.hasOwnProperty("clearcoatRoughnessTexture")){let s=e.clearcoatRoughnessTexture;t.clearCoatGlossMap=i[s.index],t.clearCoatGlossMapChannel="g",SD(s,t,["clearCoatGloss"]);}if(e.hasOwnProperty("clearcoatNormalTexture")){let s=e.clearcoatNormalTexture;t.clearCoatNormalMap=i[s.index],SD(s,t,["clearCoatNormal"]),s.hasOwnProperty("scale")?t.clearCoatBumpiness=s.scale:t.clearCoatBumpiness=1;}t.clearCoatGlossInvert=true;},SM=(e,t,i)=>{t.useLighting=false,t.emissive.copy(t.diffuse),t.emissiveMap=t.diffuseMap,t.emissiveMapUv=t.diffuseMapUv,t.emissiveMapTiling.copy(t.diffuseMapTiling),t.emissiveMapOffset.copy(t.diffuseMapOffset),t.emissiveMapRotation=t.diffuseMapRotation,t.emissiveMapChannel=t.diffuseMapChannel,t.emissiveVertexColor=t.diffuseVertexColor,t.emissiveVertexColorChannel=t.diffuseVertexColorChannel,t.useLighting=false,t.useSkybox=false,t.diffuse.set(1,1,1),t.diffuseMap=null,t.diffuseVertexColor=false;},SO=(e,t,i)=>{if(t.useMetalnessSpecularColor=true,e.hasOwnProperty("specularColorTexture")&&(t.specularMap=i[e.specularColorTexture.index],t.specularMapChannel="rgb",SD(e.specularColorTexture,t,["specular"])),e.hasOwnProperty("specularColorFactor")){let[i,s,r]=e.specularColorFactor;t.specular.set(i,s,r).gamma();}else t.specular.set(1,1,1);e.hasOwnProperty("specularFactor")?t.specularityFactor=e.specularFactor:t.specularityFactor=1,e.hasOwnProperty("specularTexture")&&(t.specularityFactorMapChannel="a",t.specularityFactorMap=i[e.specularTexture.index],SD(e.specularTexture,t,["specularityFactor"]));},SF=(e,t,i)=>{e.hasOwnProperty("ior")&&(t.refractionIndex=1/e.ior);},SN=(e,t,i)=>{e.hasOwnProperty("dispersion")&&(t.dispersion=e.dispersion);},SB=(e,t,i)=>{t.blendType=2,t.useDynamicRefraction=true,e.hasOwnProperty("transmissionFactor")&&(t.refraction=e.transmissionFactor),e.hasOwnProperty("transmissionTexture")&&(t.refractionMapChannel="r",t.refractionMap=i[e.transmissionTexture.index],SD(e.transmissionTexture,t,["refraction"]));},Sk=(e,t,i)=>{if(t.useSheen=true,e.hasOwnProperty("sheenColorFactor")){let[i,s,r]=e.sheenColorFactor;t.sheen.set(i,s,r).gamma();}else t.sheen.set(1,1,1);e.hasOwnProperty("sheenColorTexture")&&(t.sheenMap=i[e.sheenColorTexture.index],SD(e.sheenColorTexture,t,["sheen"])),t.sheenGloss=e.hasOwnProperty("sheenRoughnessFactor")?e.sheenRoughnessFactor:0,e.hasOwnProperty("sheenRoughnessTexture")&&(t.sheenGlossMap=i[e.sheenRoughnessTexture.index],t.sheenGlossMapChannel="a",SD(e.sheenRoughnessTexture,t,["sheenGloss"])),t.sheenGlossInvert=true;},SU=(e,t,i)=>{if(t.blendType=2,t.useDynamicRefraction=true,e.hasOwnProperty("thicknessFactor")&&(t.thickness=e.thicknessFactor),e.hasOwnProperty("thicknessTexture")&&(t.thicknessMap=i[e.thicknessTexture.index],t.thicknessMapChannel="g",SD(e.thicknessTexture,t,["thickness"])),e.hasOwnProperty("attenuationDistance")&&(t.attenuationDistance=e.attenuationDistance),e.hasOwnProperty("attenuationColor")){let[i,s,r]=e.attenuationColor;t.attenuation.set(i,s,r).gamma();}},Sz=(e,t,i)=>{e.hasOwnProperty("emissiveStrength")&&(t.emissiveIntensity=e.emissiveStrength);},SV=(e,t,i)=>{t.useIridescence=true,e.hasOwnProperty("iridescenceFactor")&&(t.iridescence=e.iridescenceFactor),e.hasOwnProperty("iridescenceTexture")&&(t.iridescenceMapChannel="r",t.iridescenceMap=i[e.iridescenceTexture.index],SD(e.iridescenceTexture,t,["iridescence"])),e.hasOwnProperty("iridescenceIor")&&(t.iridescenceRefractionIndex=e.iridescenceIor),e.hasOwnProperty("iridescenceThicknessMinimum")&&(t.iridescenceThicknessMin=e.iridescenceThicknessMinimum),e.hasOwnProperty("iridescenceThicknessMaximum")&&(t.iridescenceThicknessMax=e.iridescenceThicknessMaximum),e.hasOwnProperty("iridescenceThicknessTexture")&&(t.iridescenceThicknessMapChannel="g",t.iridescenceThicknessMap=i[e.iridescenceThicknessTexture.index],SD(e.iridescenceThicknessTexture,t,["iridescenceThickness"]));},SG=(e,t,i)=>{if(t.enableGGXSpecular=true,e.hasOwnProperty("anisotropyStrength")?t.anisotropyIntensity=e.anisotropyStrength:t.anisotropyIntensity=0,e.hasOwnProperty("anisotropyTexture")){let s=e.anisotropyTexture;t.anisotropyMap=i[s.index],SD(s,t,["anisotropy"]);}e.hasOwnProperty("anisotropyRotation")?t.anisotropyRotation=e.anisotropyRotation*ei.RAD_TO_DEG:t.anisotropyRotation=0;},SH=(e,t)=>{let i,s=new d0;if(e.hasOwnProperty("name")&&(s.name=e.name),s.occludeSpecular=1,s.diffuseVertexColor=true,s.specularTint=true,s.specularVertexColor=true,s.specular.set(1,1,1),s.gloss=1,s.glossInvert=true,s.useMetalness=true,e.hasOwnProperty("pbrMetallicRoughness")){let r=e.pbrMetallicRoughness;if(r.hasOwnProperty("baseColorFactor")){let[e,t,i,a]=r.baseColorFactor;s.diffuse.set(e,t,i).gamma(),s.opacity=a;}if(r.hasOwnProperty("baseColorTexture")){let e=r.baseColorTexture;s.diffuseMap=i=t[e.index],s.diffuseMapChannel="rgb",s.opacityMap=i,s.opacityMapChannel="a",SD(e,s,["diffuse","opacity"]);}if(r.hasOwnProperty("metallicFactor")&&(s.metalness=r.metallicFactor),r.hasOwnProperty("roughnessFactor")&&(s.gloss=r.roughnessFactor),r.hasOwnProperty("metallicRoughnessTexture")){let e=r.metallicRoughnessTexture;s.metalnessMap=s.glossMap=t[e.index],s.metalnessMapChannel="b",s.glossMapChannel="g",SD(e,s,["gloss","metalness"]);}}if(e.hasOwnProperty("normalTexture")){let i=e.normalTexture;s.normalMap=t[i.index],SD(i,s,["normal"]),i.hasOwnProperty("scale")&&(s.bumpiness=i.scale);}if(e.hasOwnProperty("occlusionTexture")){let i=e.occlusionTexture;s.aoMap=t[i.index],s.aoMapChannel="r",SD(i,s,["ao"]);}if(e.hasOwnProperty("emissiveFactor")){let[t,i,r]=e.emissiveFactor;s.emissive.set(t,i,r).gamma();}if(e.hasOwnProperty("emissiveTexture")){let i=e.emissiveTexture;s.emissiveMap=t[i.index],SD(i,s,["emissive"]);}if(e.hasOwnProperty("alphaMode"))switch(e.alphaMode){case "MASK":s.blendType=3,e.hasOwnProperty("alphaCutoff")?s.alphaTest=e.alphaCutoff:s.alphaTest=.5;break;case "BLEND":s.blendType=2,s.depthWrite=false;break;default:s.blendType=3;}else s.blendType=3;e.hasOwnProperty("doubleSided")?(s.twoSidedLighting=e.doubleSided,s.cull=+!e.doubleSided):(s.twoSidedLighting=false,s.cull=1);let r={KHR_materials_clearcoat:SL,KHR_materials_emissive_strength:Sz,KHR_materials_ior:SF,KHR_materials_dispersion:SN,KHR_materials_iridescence:SV,KHR_materials_pbrSpecularGlossiness:SR,KHR_materials_sheen:Sk,KHR_materials_specular:SO,KHR_materials_transmission:SB,KHR_materials_unlit:SM,KHR_materials_volume:SU,KHR_materials_anisotropy:SG};if(e.hasOwnProperty("extensions"))for(let i in e.extensions){let a=r[i];void 0!==a&&a(e.extensions[i],s,t);}return s.update(),s},SW=new ey,SX=new ed,SY=new ex,Sq=(e,t,i)=>{let s=new oX;if(e.hasOwnProperty("name")&&e.name.length>0?s.name=e.name:s.name=`node_${t}`,e.hasOwnProperty("matrix")&&(SW.data.set(e.matrix),SW.getTranslation(SX),s.setLocalPosition(SX),SY.setFromMat4(SW),s.setLocalRotation(SY),SW.getScale(SX),SX.x*=SW.scaleSign,s.setLocalScale(SX)),e.hasOwnProperty("rotation")){let t=e.rotation;s.setLocalRotation(t[0],t[1],t[2],t[3]);}if(e.hasOwnProperty("translation")){let t=e.translation;s.setLocalPosition(t[0],t[1],t[2]);}if(e.hasOwnProperty("scale")){let t=e.scale;s.setLocalScale(t[0],t[1],t[2]);}return e.hasOwnProperty("extensions")&&e.extensions.EXT_mesh_gpu_instancing&&i.set(e,{ext:e.extensions.EXT_mesh_gpu_instancing}),s},S$=(e,t)=>{let i="orthographic"===e.type,s=i?e.orthographic:e.perspective,r={enabled:false,projection:+!!i,nearClip:s.znear,aspectRatioMode:0};s.zfar&&(r.farClip=s.zfar),i?(r.orthoHeight=s.ymag,s.xmag&&s.ymag&&(r.aspectRatioMode=1,r.aspectRatio=s.xmag/s.ymag)):(r.fov=s.yfov*ei.RAD_TO_DEG,s.aspectRatio&&(r.aspectRatioMode=1,r.aspectRatio=s.aspectRatio));let a=new fB(e.name);return a.addComponent("camera",r),a},Sj=(e,t)=>{let i={enabled:false,type:"point"===e.type?"omni":e.type,color:e.hasOwnProperty("color")?new es(e.color):es.WHITE,range:e.hasOwnProperty("range")?e.range:9999,falloffMode:1,intensity:e.hasOwnProperty("intensity")?ei.clamp(e.intensity,0,2):1};if(e.hasOwnProperty("spot")&&(i.innerConeAngle=e.spot.hasOwnProperty("innerConeAngle")?e.spot.innerConeAngle*ei.RAD_TO_DEG:0,i.outerConeAngle=e.spot.hasOwnProperty("outerConeAngle")?e.spot.outerConeAngle*ei.RAD_TO_DEG:45),e.hasOwnProperty("intensity")){let t=e.spot?.outerConeAngle??Math.PI/4,s=e.spot?.innerConeAngle??0;i.luminance=e.intensity*hE.getLightUnitConversion(hv[i.type],t,s);}let s=new fB(t.name);return s.rotateLocal(90,0,0),s.addComponent("light",i),s},SK=async(e,t,i,s,r)=>{let a,n,o,l,h,c=r?.global?.preprocess,d=r?.global?.postprocess;c&&c(t),t.asset&&t.asset.generator;let u=new Map,f=((e,t,i)=>{if(!e.hasOwnProperty("nodes")||0===e.nodes.length)return [];let s=t?.node?.preprocess,r=t?.node?.process??Sq,a=t?.node?.postprocess,n=e.nodes.map((e,t)=>{s&&s(e);let n=r(e,t,i);return a&&a(e,n),n});for(let t=0;t<e.nodes.length;++t){let i=e.nodes[t];if(i.hasOwnProperty("children")){let e=n[t],s={};for(let t=0;t<i.children.length;++t){let r=n[i.children[t]];r.parent||(s.hasOwnProperty(r.name)?r.name+=s[r.name]++:s[r.name]=1,e.addChild(r));}}}return n})(t,r,u),p=((e,t)=>{let i=[],s=e.scenes.length;if(1===s&&e.scenes[0].nodes?.length===1){let s=e.scenes[0].nodes[0];i.push(t[s]);}else for(let r=0;r<s;r++){let s=e.scenes[r];if(s.nodes){let e=new oX(s.name);for(let i=0;i<s.nodes.length;i++){let r=t[s.nodes[i]];e.addChild(r);}i.push(e);}}return i})(t,f),_=((e,t,i)=>{let s=null;if(e.hasOwnProperty("nodes")&&e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_lights_punctual")&&e.extensions.KHR_lights_punctual.hasOwnProperty("lights")){let r=e.extensions.KHR_lights_punctual.lights;if(r.length){let a=i?.light?.preprocess,n=i?.light?.process??Sj,o=i?.light?.postprocess;e.nodes.forEach((e,i)=>{if(e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_lights_punctual")&&e.extensions.KHR_lights_punctual.hasOwnProperty("light")){let l=r[e.extensions.KHR_lights_punctual.light];if(l){a&&a(l);let r=n(l,t[i]);o&&o(l,r),r&&(s||(s=new Map),s.set(e,r));}}});}}return s})(t,f,r),g=((e,t,i)=>{let s=null;if(e.hasOwnProperty("nodes")&&e.hasOwnProperty("cameras")&&e.cameras.length>0){let r=i?.camera?.preprocess,a=i?.camera?.process??S$,n=i?.camera?.postprocess;e.nodes.forEach((i,o)=>{if(i.hasOwnProperty("camera")){let l=e.cameras[i.camera];if(l){r&&r(l);let e=a(l,t[o]);n&&n(l,e),e&&(s||(s=new Map),s.set(i,e));}}});}return s})(t,f,r),v=(e=>{if(!e.hasOwnProperty("extensions")||!e.extensions.hasOwnProperty("KHR_materials_variants"))return null;let t=e.extensions.KHR_materials_variants.variants,i={};for(let e=0;e<t.length;e++)i[t[e].name]=e;return i})(t),S=await Promise.all(i),{meshes:y,meshVariants:x,meshDefaultMaterials:T,promises:E}=(a={},n={},o={},l=[],{meshes:!r.skipMeshes&&t?.meshes?.length&&t?.accessors?.length&&t?.bufferViews?.length?t.meshes.map(i=>{var s;let h;return s=t.accessors,h=[],i.primitives.forEach(t=>{if(t.extensions?.KHR_draco_mesh_compression)h.push(((e,t,i,s,r,a,n)=>{let o=new n7(e);if(o.aabb=SP(i[t.attributes.POSITION]),n.push(new Promise((r,a)=>{var n;let l=t.extensions.KHR_draco_mesh_compression;n=s[l.bufferView].slice().buffer,Sv()&&m.enqueueJob(n,(s,n)=>{if(s)a(s);else {let s={};for(let[e,t]of Object.entries(l.attributes))s[t]=SE[e];s[-1]=e9;let a=[];for(let e of n.attributes){let r=s[e.id];if(void 0!==r){let s=false;if(-1!==e.id){for(let[a,n]of Object.entries(l.attributes))if(n===e.id&&void 0!==t.attributes[a]){s=i[t.attributes[a]].normalized??(r===ti&&(1===e.dataType||3===e.dataType));break}}a.push({semantic:r,components:e.numComponents,type:e.dataType,normalize:s,offset:e.offset,stride:n.stride});}}let h=new iO(e,a),c=n.vertices.byteLength/n.stride,d=n.indices.byteLength/(c<=65535?2:4),u=new iP(e,h,c,{data:n.vertices}),f=new ae(e,c<=65535?1:2,d,0,n.indices);o.vertexBuffer=u,o.indexBuffer[0]=f,o.primitive[0].type=SI(t),o.primitive[0].base=0,o.primitive[0].count=f?d:c,o.primitive[0].indexed=!!f,r();}});})),t?.extensions?.KHR_materials_variants){let e=t.extensions.KHR_materials_variants,i={};e.mappings.forEach(e=>{e.variants.forEach(t=>{i[t]=e.material;});}),r[o.id]=i;}return a[o.id]=t.material,o})(e,t,s,S,n,o,l));else {let l=t.hasOwnProperty("indices")?SA(s[t.indices],S,true):null,c=((e,t,i,s,r,a)=>{let n={},o=[];for(let e in t)t.hasOwnProperty(e)&&SE.hasOwnProperty(e)&&(n[e]=t[e],o.push(`${e}:${t[e]}`));o.sort();let l=o.join(),h=a[l];if(!h){let o={};for(let e in n){let i=s[t[e]],a=SA(i,r),n=r[i.bufferView],l=SE[e],h=Sy(i.type)*ST(i.componentType),c=n&&n.hasOwnProperty("byteStride")?n.byteStride:h;o[l]={buffer:a.buffer,size:h,offset:a.byteOffset,stride:c,count:i.count,components:Sy(i.type),type:Sx(i.componentType),normalize:i.normalized};}o.hasOwnProperty(e9)||((e,t)=>{let i,s=e[e6];if(!s||3!==s.components)return;if(s.size!==s.stride){let e=s.stride/t0[s.type],t=new tJ[s.type](s.buffer,s.offset,s.count*e);i=new tJ[s.type](3*s.count);for(let r=0;r<s.count;++r)i[3*r+0]=t[r*e+0],i[3*r+1]=t[r*e+1],i[3*r+2]=t[r*e+2];}else i=new tJ[s.type](s.buffer,s.offset,3*s.count);let r=s.count;t||(t=(e=>{let t=new Uint16Array(e);for(let i=0;i<e;i++)t[i]=i;return t})(r));let a=cN(i,t),n=new Float32Array(a.length);n.set(a),e[e9]={buffer:n.buffer,size:12,offset:0,stride:12,count:r,components:3,type:6};})(o,i),h=((e,t)=>{let i,s,r,a,n,o,l,h=t[e6];if(!h)return null;let c=h.count,d=[];for(let i in t)if(t.hasOwnProperty(i)){let s={semantic:i,components:t[i].components,type:t[i].type,normalize:!!t[i].normalize};!iO.isElementValid(e,s)&&s.components++,d.push(s);}d.sort((e,t)=>Sw[e.semantic]-Sw[t.semantic]);let u=new iO(e,d),f=true;for(i=0;i<u.elements.length;++i)if(o=(a=t[(n=u.elements[i]).name]).offset-h.offset,a.buffer!==h.buffer||a.stride!==n.stride||a.size!==n.size||o!==n.offset){f=false;break}let p=new iP(e,u,c),m=new Uint32Array(p.lock());if(f)l=new Uint32Array(h.buffer,h.offset,c*p.format.size/4),m.set(l);else {let e,o;for(i=0;i<p.format.elements.length;++i){e=(n=p.format.elements[i]).stride/4,o=(a=t[n.name]).stride/4,l=new Uint32Array(a.buffer,a.offset,(a.count-1)*o+(a.size+3)/4);let h=0,d=n.offset/4,u=Math.floor((a.size+3)/4);for(s=0;s<c;++s){for(r=0;r<u;++r)m[d+r]=l[h+r];h+=o,d+=e;}}}return p.unlock(),p})(e,o),a[l]=h;}return h})(e,t.attributes,l,s,S,a),d=SI(t),u=new n7(e);if(u.vertexBuffer=c,u.primitive[0].type=d,u.primitive[0].base=0,u.primitive[0].indexed=null!==l,null!==l){let t;0==(t=l instanceof Uint8Array?0:l instanceof Uint16Array?1:2)&&e.isWebGPU&&(t=1,l=new Uint16Array(l));let i=new ae(e,t,l.length,0,l);u.indexBuffer[0]=i,u.primitive[0].count=l.length;}else u.primitive[0].count=c.numVertices;if(t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_materials_variants")){let e=t.extensions.KHR_materials_variants,i={};e.mappings.forEach(e=>{e.variants.forEach(t=>{i[t]=e.material;});}),n[u.id]=i;}o[u.id]=t.material;let f=s[t.attributes.POSITION];if(u.aabb=SP(f),t.hasOwnProperty("targets")){let a=[];t.targets.forEach((e,t)=>{let n={};e.hasOwnProperty("POSITION")&&(n.deltaPositions=SC(f=s[e.POSITION],S),n.aabb=SP(f)),e.hasOwnProperty("NORMAL")&&(n.deltaNormals=SC(f=s[e.NORMAL],S)),i.hasOwnProperty("extras")&&i.extras.hasOwnProperty("targetNames")?n.name=i.extras.targetNames[t]:n.name=t.toString(10),i.hasOwnProperty("weights")&&(n.defaultWeight=i.weights[t]),n.preserveData=r.morphPreserveData,a.push(new hP(n));}),u.morph=new hC(a,e,{preferHighPrecision:r.morphPreferHighPrecision});}h.push(u);}}),h}):[],meshVariants:n,meshDefaultMaterials:o,promises:l}),w=((e,t,i,s)=>{if(!e.hasOwnProperty("animations")||0===e.animations.length)return [];let r=s?.animation?.preprocess,a=s?.animation?.postprocess;return e.animations.map((s,n)=>{r&&r(s);let o=((e,t,i,s,r,a,n)=>{let o,l,h=e=>new Sm(Sy(e.type),SC(e,s)),c={STEP:0,LINEAR:1,CUBICSPLINE:2},d={},u={},f={},p=1;for(o=0;o<e.samplers.length;++o){let t=e.samplers[o];d.hasOwnProperty(t.input)||(d[t.input]=h(i[t.input])),u.hasOwnProperty(t.output)||(u[t.output]=h(i[t.output]));let s=t.hasOwnProperty("interpolation")&&c.hasOwnProperty(t.interpolation)?c[t.interpolation]:1,r={paths:[],input:t.input,output:t.output,interpolation:s};f[o]=r;}let m=[],_={translation:"localPosition",rotation:"localRotation",scale:"localScale"},g=e=>{let t=[];for(;e;)t.unshift(e.name),e=e.parent;return t},v=(e,t,i)=>{let s,r=u[e.output];if(!r)return;if(a&&a[t.mesh]){let e=a[t.mesh];e.hasOwnProperty("extras")&&e.extras.hasOwnProperty("targetNames")&&(s=e.extras.targetNames);}let n=r.data,l=n.length/d[e.input].data.length,h=n.length/l,c=4*h,m=new ArrayBuffer(c*l);for(let t=0;t<l;t++){let r=new Float32Array(m,c*t,h);for(let e=0;e<h;e++)r[e]=n[e*l+t];let a=new Sm(1,r),d=s?.[t]?`name.${s[t]}`:t;u[-p]=a;let _={paths:[{entityPath:i,component:"graph",propertyPath:[`weight.${d}`]}],input:e.input,output:-p,interpolation:e.interpolation};p++,f[`morphCurve-${o}-${t}`]=_;}};for(o=0;o<e.channels.length;++o){let t=e.channels[o],i=t.target,s=f[t.sampler],a=r[i.node],l=n[i.node],h=g(a);i.path.startsWith("weights")?(v(s,l,h),f[t.sampler].morphCurve=true):s.paths.push({entityPath:h,component:"graph",propertyPath:[_[i.path]]});}let S=[],y=[],x=[];for(let e in d)S.push(d[e]),d[e]=S.length-1;for(let e in u)y.push(u[e]),u[e]=y.length-1;for(let e in f){let t=f[e];!t.morphCurve&&(x.push(new Sp(t.paths,d[t.input],u[t.output],t.interpolation)),t.paths.length>0&&"localRotation"===t.paths[0].propertyPath[0]&&2!==t.interpolation&&m.push(x[x.length-1].output));}m.sort();let T=null;for(o=0;o<m.length;++o){let e=m[o];if(0===o||e!==T){if(4===(l=y[e]).components){let e=l.data,t=e.length-4;for(let i=0;i<t;i+=4)e[i+0]*e[i+4]+e[i+1]*e[i+5]+e[i+2]*e[i+6]+e[i+3]*e[i+7]<0&&(e[i+4]*=-1,e[i+5]*=-1,e[i+6]*=-1,e[i+7]*=-1);}T=e;}}let E=0;for(o=0;o<S.length;o++)E=Math.max(E,0===(l=S[o]._data).length?0:l[l.length-1]);return new pA(e.hasOwnProperty("name")?e.name:`animation_${t}`,E,S,y,x)})(s,n,e.accessors,i,t,e.meshes,e.nodes);return a&&a(s,o),o})})(t,f,S,r);h=t.accessors,u.forEach((e,t)=>{let i,s,r,a=e.ext.attributes;a.hasOwnProperty("TRANSLATION")&&(i=SC(h[a.TRANSLATION],S)),a.hasOwnProperty("ROTATION")&&(s=SC(h[a.ROTATION],S)),a.hasOwnProperty("SCALE")&&(r=SC(h[a.SCALE],S));let n=(i?i.length/3:0)||(s?s.length/4:0)||(r?r.length/3:0);if(n){let t=new Float32Array(16*n),a=new ed,o=new ex,l=new ed(1,1,1),h=new ey,c=0;for(let e=0;e<n;e++){let n=3*e;if(i&&a.set(i[n],i[n+1],i[n+2]),s){let t=4*e;o.set(s[t],s[t+1],s[t+2],s[t+3]);}r&&l.set(r[n],r[n+1],r[n+2]),h.setTRS(a,o,l);for(let e=0;e<16;e++)t[c++]=h.data[e];}e.matrices=t;}});let b=await Promise.all(s),A=((e,t,i)=>{if(!e.hasOwnProperty("materials")||0===e.materials.length)return [];let s=i?.material?.preprocess,r=i?.material?.process??SH,a=i?.material?.postprocess;return e.materials.map(e=>{s&&s(e);let i=r(e,t);return a&&a(e,i),i})})(t,b.map(e=>e.resource),r),C=((e,t,i,s)=>{if(!t.hasOwnProperty("skins")||0===t.skins.length)return [];let r=new Map;return t.skins.map(a=>((e,t,i,s,r,a)=>{let n,o,l,h=t.joints,c=h.length,d=[];if(t.hasOwnProperty("inverseBindMatrices")){let e=SA(i[t.inverseBindMatrices],s,true),r=[];for(n=0;n<c;n++){for(o=0;o<16;o++)r[o]=e[16*n+o];(l=new ey).set(r),d.push(l);}}else for(n=0;n<c;n++)l=new ey,d.push(l);let u=[];for(n=0;n<c;n++)u[n]=r[h[n]].name;let f=u.join("#"),p=a.get(f);return p||(p=new dr(e,d,u),a.set(f,p)),p})(e,a,t.accessors,s,i,r))})(e,t,f,S),P=[];for(let e=0;e<y.length;e++)P[e]=new Sh,P[e].meshes=y[e];t.nodes.forEach(e=>{e.hasOwnProperty("mesh")&&e.hasOwnProperty("skin")&&P[e.mesh].meshes.forEach(t=>{t.skin=C[e.skin];});});let I=new SS;return I.gltf=t,I.nodes=f,I.scenes=p,I.animations=w,I.textures=b,I.materials=A,I.variants=v,I.meshVariants=x,I.meshDefaultMaterials=T,I.renders=P,I.skins=C,I.lights=_,I.cameras=g,I.nodeInstancingMap=u,d&&d(t,I),await Promise.all(E),I},SZ=0,SQ=e=>e.extensions?.KHR_texture_basisu?.source??e.extensions?.EXT_texture_webp?.source??e.source;class SJ{static parse(e,t,i,s,r,a,n){let o;var l=(e,i)=>{var o,l;let h;e?n(e):(o=i.gltfChunk,l=(e,o)=>{if(e)return void n(e);let l=((e,t,i,s)=>{if(!e.buffers||0===e.buffers.length)return [];let r=s?.buffer?.preprocess,a=s?.buffer?.processAsync,n=s?.buffer?.postprocess;return e.buffers.map((s,o)=>{let l;return r&&r(s),l=(l=new Promise(a?(e,t)=>{a(s,(i,s)=>{i?t(i):e(s);});}:e=>{e(null);})).then(e=>{if(e)return e;if(s.hasOwnProperty("uri")){let e;if(e=s.uri,/^data:[^\n\r,\u2028\u2029]*,.*$/i.test(e)){let e=atob(s.uri.split(",")[1]),t=new Uint8Array(e.length);for(let i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t}return new Promise((e,t)=>{a$.get(fm.test(s.uri)?s.uri:P.join(i,s.uri),{cache:true,responseType:"arraybuffer",retry:false},(i,s)=>{i?t(i):e(new Uint8Array(s));});})}return t}),n&&(l=l.then(t=>(n(e.buffers[o],t),t))),l})})(o,i.binaryChunk,t,a),h=((e,t,i)=>{let s=[],r=i?.bufferView?.preprocess,a=i?.bufferView?.processAsync,n=i?.bufferView?.postprocess;if(!e.bufferViews?.length)return s;for(let i=0;i<e.bufferViews.length;++i){let o,l=e.bufferViews[i];r&&r(l),o=(o=new Promise(a?(e,i)=>{a(l,t,(t,s)=>{t?i(t):e(s);});}:e=>{e(null);})).then(e=>e||t[l.buffer].then(e=>new Uint8Array(e.buffer,e.byteOffset+(l.byteOffset||0),l.byteLength))),l.hasOwnProperty("byteStride")&&(o=o.then(e=>(e.byteStride=l.byteStride,e))),n&&(o=o.then(e=>(n(l,e),e))),s.push(o);}return s})(o,l,a),c=((e,t,i,s,r)=>{let a;if(!e.images||0===e.images.length)return [];let n=r?.image?.preprocess,o=r?.image?.processAsync,l=r?.image?.postprocess,h={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/ktx2":"ktx2","image/vnd-ms.dds":"dds"},c=(e,t,i,r,a,n)=>new Promise((o,l)=>{let c=i=>{let c=`${e.name||"gltf-texture"}-${SZ++}`,d={url:t||c};if(i&&(d.contents=i.slice(0).buffer),r){let e=h[r];e&&(d.filename=`${d.url}.${e}`);}let u=new fy(c,"texture",d,{srgb:n},a);u.on("load",e=>o(e)),u.on("error",e=>l(e)),s.add(u),s.load(u);};i?i.then(e=>c(e)):c(null);}),d=(a=new Set,e.hasOwnProperty("materials")&&e.materials.forEach(t=>{if(t.hasOwnProperty("pbrMetallicRoughness")){let i=t.pbrMetallicRoughness;if(i.hasOwnProperty("baseColorTexture")){let t=e.textures[i.baseColorTexture.index];a.add(SQ(t));}}if(t.hasOwnProperty("emissiveTexture")){let i=e.textures[t.emissiveTexture.index];a.add(SQ(i));}if(t.hasOwnProperty("extensions")){let i=t.extensions.KHR_materials_sheen;if(i&&i.hasOwnProperty("sheenColorTexture")){let t=e.textures[i.sheenColorTexture.index];a.add(SQ(t));}let s=t.extensions.KHR_materials_pbrSpecularGlossiness;if(s&&s.hasOwnProperty("specularGlossinessTexture")){let t=e.textures[s.specularGlossinessTexture.index];a.add(SQ(t));}let r=t.extensions.KHR_materials_specular;if(r&&r.hasOwnProperty("specularColorTexture")){let t=e.textures[r.specularColorTexture.index];a.add(SQ(t));}}}),a);return e.images.map((e,s)=>{let r;return n&&n(e),r=(r=new Promise(o?(t,i)=>{o(e,(e,s)=>{e?i(e):t(s);});}:e=>{e(null);})).then(r=>{let a=d.has(s);if(r)return r;if(e.hasOwnProperty("uri")){let t;if(t=e.uri,/^data:[^\n\r,\u2028\u2029]*,.*$/i.test(t)){let t;return c(e,e.uri,null,(t=e.uri).substring(t.indexOf(":")+1,t.indexOf(";")),null,a)}return c(e,fm.test(e.uri)?e.uri:P.join(i,e.uri),null,null,{crossOrigin:"anonymous"},a)}return e.hasOwnProperty("bufferView")&&e.hasOwnProperty("mimeType")?c(e,null,t[e.bufferView],e.mimeType,null,a):Promise.reject(Error(`Invalid image found in gltf (neither uri or bufferView found). index=${s}`))}),l&&(r=r.then(t=>(l(e,t),t))),r})})(o,h,t,r,a),d=((e,t,i)=>{if(!e?.images?.length||!e?.textures?.length)return [];let s=i?.texture?.preprocess,r=i?.texture?.processAsync,a=i?.texture?.postprocess,n=new Set;return e.textures.map(i=>{let o;return s&&s(i),o=(o=new Promise(r?(t,s)=>{r(i,e.images,(e,i)=>{e?s(e):t(i);});}:e=>{e(null);})).then(s=>{s=s??SQ(i);let r=n.has(s);return n.add(s),t[s].then(t=>{var s,a,n;let o,l,h,c,d=r?((o=new fy(`${t.name}_clone`,t.type,t.file,t.data,t.options)).loaded=true,(l=new ih((s=t.resource).device,s))._levels=(e=>{let t=[];for(let i=0;i<e._levels.length;++i){let s=[];if(e.cubemap)for(let t=0;t<6;++t)s.push(e._levels[i][t]);else s=e._levels[i];t.push(s);}return t})(s),o.resource=l,t.registry.add(o),o):t;return a=d.resource,n=(e.samplers??[])[i.sampler],h=(e,t)=>{switch(e){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return t}},c=(e,t)=>{switch(e){case 33071:return 1;case 33648:return 2;case 10497:return 0;default:return t}},a&&(a.minFilter=h((n=n??{}).minFilter,5),a.magFilter=h(n.magFilter,1),a.addressU=c(n.wrapS,0),a.addressV=c(n.wrapT,0)),d})}),a&&(o=o.then(e=>(a(i,e),e))),o})})(o,c,a);SK(s,o,h,d,a).then(e=>n(null,e)).catch(e=>n(e));},(h=JSON.parse((e=>{if("undefined"!=typeof TextDecoder)return new TextDecoder().decode(e);let t="";for(let i=0;i<e.length;i++)t+=String.fromCharCode(e[i]);return decodeURIComponent(escape(t))})(o))).asset&&h.asset.version&&2>parseFloat(h.asset.version)?l(`Invalid gltf version. Expected version 2.0 or above but found version '${h.asset.version}'.`):l(null,h));};e&&e.toLowerCase().endsWith(".glb")||103===(o=new Uint8Array(i))[0]&&108===o[1]&&84===o[2]&&70===o[3]?((e,t)=>{let i=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),s=i.getUint32(0,true),r=i.getUint32(4,true),a=i.getUint32(8,true);if(0x46546c67!==s)return t(`Invalid magic number found in glb header. Expected 0x46546C67, found 0x${s.toString(16)}`);if(2!==r)return t(`Invalid version number found in glb header. Expected 2, found ${r}`);if(a<=0||a>i.byteLength)return t(`Invalid length found in glb header. Found ${a}`);let n=[],o=12;for(;o<a;){let e=i.getUint32(o,true);o+e+8>i.byteLength&&t(`Invalid chunk length found in glb. Found ${e}`);let s=i.getUint32(o+4,true),r=new Uint8Array(i.buffer,i.byteOffset+o+8,e);n.push({length:e,type:s,data:r}),o+=e+8;}1!==n.length&&2!==n.length?t("Invalid number of chunks found in glb file."):0x4e4f534a!==n[0].type?t(`Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x${n[0].type.toString(16)}`):n.length>1&&5130562!==n[1].type?t(`Invalid chunk type found in glb file. Expected 0x004E4942, found 0x${n[1].type.toString(16)}`):t(null,{gltfChunk:n[0].data,binaryChunk:2===n.length?n[1].data:null});})(i,l):l(null,{gltfChunk:i,binaryChunk:null});}static createDefaultMaterial(){return SH({name:"defaultGlbMaterial"},[])}}class S0 extends fC{load(e,t,i){"string"==typeof e&&(e={load:e,original:e});let s={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.load.startsWith("blob:")||e.load.startsWith("data:"))&&(".glb"===P.getExtension(e.original).toLowerCase()?s.responseType=aq.ResponseType.ARRAY_BUFFER:s.responseType=aq.ResponseType.JSON),a$.get(e.load,s,(s,r)=>{s?t(`Error loading animation resource: ${e.original} [${s}]`):".glb"===P.getExtension(e.original).toLowerCase()?SJ.parse("filename.glb","",r,this.device,this.assets,i?.options??{},(e,s)=>{if(e)t(e);else {let e=s.animations;if(i?.data?.events)for(let t=0;t<e.length;t++)e[t].events=new pb(Object.values(i.data.events));s.destroy(),t(null,e);}}):t(null,this[`_parseAnimationV${r.animation.version}`](r));});}open(e,t,i){return t}_parseAnimationV3(e){let t=e.animation,i=new du;i.name=t.name,i.duration=t.duration;for(let e=0;e<t.nodes.length;e++){let s=new dd,r=t.nodes[e];s._name=r.name;for(let e=0;e<r.keys.length;e++){let t=r.keys[e],i=t.time,a=t.pos,n=t.rot,o=t.scale,l=new dc(i,new ed(a[0],a[1],a[2]),new ex().setFromEulerAngles(n[0],n[1],n[2]),new ed(o[0],o[1],o[2]));s._keys.push(l);}i.addNode(s);}return i}_parseAnimationV4(e){let t=e.animation,i=new du;i.name=t.name,i.duration=t.duration;for(let e=0;e<t.nodes.length;e++){let s=new dd,r=t.nodes[e];s._name=r.name;let a=r.defaults.p,n=r.defaults.r,o=r.defaults.s;for(let e=0;e<r.keys.length;e++){let t=r.keys[e],i=t.t,l=a||t.p,h=n||t.r,c=o||t.s,d=new dc(i,new ed(l[0],l[1],l[2]),new ex().setFromEulerAngles(h[0],h[1],h[2]),new ed(c[0],c[1],c[2]));s._keys.push(d);}i.addNode(s);}return i}constructor(e){super(e,"animation"),this.device=e.graphicsDevice,this.assets=e.assets;}}class S1 extends fC{load(e,t){"string"==typeof e&&(e={load:e,original:e});let i={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(i.responseType=aq.ResponseType.JSON),a$.get(e.load,i,(i,s)=>{i?t(`Error loading animation clip resource: ${e.original} [${i}]`):t(null,s);});}open(e,t){return new pA(t.name,t.duration,t.inputs.map(e=>new Sm(1,e)),t.outputs.map(e=>new Sm(e.components,e.data)),t.curves.map(e=>new Sp([e.path],e.inputIndex,e.outputIndex,e.interpolation)))}constructor(e){super(e,"animclip");}}class S2 extends fC{load(e,t){"string"==typeof e&&(e={load:e,original:e});let i={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(i.responseType=aq.ResponseType.JSON),a$.get(e.load,i,(i,s)=>{i?t(`Error loading animation state graph resource: ${e.original} [${i}]`):t(null,s);});}open(e,t){return new pK(t)}constructor(e){super(e,"animstategraph");}}let S3=function(){if("undefined"==typeof window)return  false;let e=window.navigator.userAgent,t=e.indexOf("MSIE ");if(t>0)return parseInt(e.substring(t+5,e.indexOf(".",t)),10);if(e.indexOf("Trident/")>0){let t=e.indexOf("rv:");return parseInt(e.substring(t+3,e.indexOf(".",t)),10)}return  false}(),S4=[".ogg",".mp3",".wav",".mp4a",".m4a",".mp4",".aac",".opus"];class S5 extends fC{_isSupported(e){let t=P.getExtension(e);return S4.indexOf(t)>-1}load(e,t){"string"==typeof e&&(e={load:e,original:e});let i=function(i){let s=`Error loading audio url: ${e.original}`;i&&(s+=`: ${i.message||i}`),t(s);};if(this._createSound){if(!this._isSupported(e.original))return void i(`Audio format for ${e.original} not supported`);this._createSound(e.load,function(e){t(null,new a2(e));},i);}else i(null);}_createSound(e,t,i){if(a3()){let s=this.manager;if(!s.context)return void i("Audio manager has no audio context");let r={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.startsWith("blob:")||e.startsWith("data:"))&&(r.responseType=aq.ResponseType.ARRAY_BUFFER),a$.get(e,r,(e,r)=>{e?i(e):s.context.decodeAudioData(r,t,i);});}else {let s=null;try{s=new Audio;}catch(e){i("No support for Audio element");return}S3&&document.body.appendChild(s);let r=function(){s.removeEventListener("canplaythrough",r),S3&&document.body.removeChild(s),t(s);};s.onerror=function(){s.onerror=null,S3&&document.body.removeChild(s),i();},s.addEventListener("canplaythrough",r),s.src=e;}}constructor(e){super(e,"audio"),this.manager=e.soundManager;}}class S8 extends fC{load(e,t){"string"==typeof e&&(e={load:e,original:e}),a$.get(e.load,{responseType:aq.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},(i,s)=>{i?t(`Error loading binary resource: ${e.original} [${i}]`):t(null,s);});}openBinary(e){return e.buffer}constructor(e){super(e,"binary");}}class S6{get model(){if(!this._model){let e=S6.createModel(this.data,this._defaultMaterial),t=S6.createAsset(this._assetName,"model",e,0);this._assets.add(t),this._model=t;}return this._model}static createAsset(e,t,i,s){let r=new fy(`${e}/${t}/${s}`,t,{url:""});return r.resource=i,r.loaded=true,r}instantiateModelEntity(e){let t=new fB(void 0,this._assets._loader._app);return t.addComponent("model",Object.assign({type:"asset",asset:this.model},e)),t}instantiateRenderEntity(e){let t=this._defaultMaterial,i=[],s=function(e,s,r,a,n,o,l,h){let c=n[r.id],d=new od(r,void 0===c?t:a[c]);r.morph&&(d.morphInstance=new hb(r.morph)),l.hasOwnProperty("skin")&&i.push({meshInstance:d,rootBone:e,entity:s});let u=h.get(l);if(u){let e=u.matrices,t=iO.getDefaultInstancingFormat(r.device),i=new iP(r.device,t,e.length/16,{data:e});d.setInstancing(i),d.instancingData._destroyVertexBuffer=true;}return d},r=(t,i,a)=>{let n=new fB(void 0,this._assets._loader._app);i._cloneInternal(n),t||(t=n);let o=null,l=null;for(let e=0;e<a.nodes.length;e++)if(a.nodes[e]===i){let i=a.gltf.nodes[e];if(i.hasOwnProperty("mesh")){let e=a.renders[i.mesh].meshes;l=this.renders[i.mesh];for(let r=0;r<e.length;r++){let l=e[r];if(l){let e=s(t,n,l,a.materials,a.meshDefaultMaterials,a.skins,i,a.nodeInstancingMap);o||(o=[]),o.push(e);}}}if(a.lights){let e=a.lights.get(i);e&&n.addChild(e.clone());}if(a.cameras){let e=a.cameras.get(i);e&&e.camera.system.cloneComponent(e,n);}}o&&(n.addComponent("render",Object.assign({type:"asset",meshInstances:o},e)),n.render.assignAsset(l));let h=i.children;for(let e=0;e<h.length;e++){let i=r(t,h[e],a);n.addChild(i);}return n},a=[];for(let e of this.data.scenes)a.push(r(null,e,this.data));return i.forEach(e=>{e.meshInstance.skinInstance=_1.createCachedSkinInstance(e.meshInstance.mesh.skin,e.rootBone,e.entity),e.meshInstance.node.render.rootBone=e.rootBone;}),S6.createSceneHierarchy(a,fB)}getMaterialVariants(){return this.data.variants?Object.keys(this.data.variants):[]}applyMaterialVariant(e,t){let i=t?this.data.variants[t]:null;if(void 0===i)return;let s=e.findComponents("render");for(let e=0;e<s.length;e++){let t=s[e];this._applyMaterialVariant(i,t.meshInstances);}}applyMaterialVariantInstances(e,t){let i=t?this.data.variants[t]:null;void 0!==i&&this._applyMaterialVariant(i,e);}_applyMaterialVariant(e,t){t.forEach(t=>{if(null===e)t.material=this._defaultMaterial;else {let i=this.data.meshVariants[t.mesh.id];i&&(t.material=this.data.materials[i[e]]);}});}static createSceneHierarchy(e,t){let i=null;if(1===e.length)i=e[0];else for(let s of(i=new t("SceneGroup"),e))i.addChild(s);return i}static createModel(e,t){let i=new hA,s=[];for(let t of e.skins){let e=new n4(t);e.bones=t.bones,s.push(e);}i.graph=S6.createSceneHierarchy(e.scenes,oX);for(let r=0;r<e.nodes.length;r++){let a=e.nodes[r];if(a.root===i.graph){let n=e.gltf.nodes[r];if(n.hasOwnProperty("mesh")){let r=e.renders[n.mesh].meshes;for(let o=0;o<r.length;o++){let l=r[o];l&&function(i,s,r,a,n,o,l){let h=e.meshDefaultMaterials[s.id],c=new od(s,void 0===h?t:n[h],o);if(s.morph){let e=new hb(s.morph);c.morphInstance=e,i.morphInstances.push(e);}if(l.hasOwnProperty("skin")){let e=l.skin;s.skin=r[e];let t=a[e];c.skinInstance=t,i.skinInstances.push(t);}i.meshInstances.push(c);}(i,l,e.skins,s,e.materials,a,n);}}}}return i}destroy(){let e=this._assets,t=function(t){e.remove(t),t.unload();},i=function(e){e.forEach(e=>{t(e);});};this.animations&&(i(this.animations),this.animations=null),this.textures&&(i(this.textures),this.textures=null),this.materials&&(i(this.materials),this.materials=null),this.renders&&(i(this.renders),this.renders=null),this._model&&(t(this._model),this._model=null),this.data=null,this.assets=null;}constructor(e,t,i,s){let r=function(e,s,r){let a=S6.createAsset(t.name,e,s,r);return i.add(a),a},a=[];for(let t=0;t<e.renders.length;++t)a.push(r("render",e.renders[t],t));let n=[];for(let t=0;t<e.materials.length;++t)n.push(r("material",e.materials[t],t));let o=[];for(let t=0;t<e.animations.length;++t)o.push(r("animation",e.animations[t],t));this.data=e,this._model=null,this._assetName=t.name,this._assets=i,this._defaultMaterial=s,this.renders=a,this.materials=n,this.textures=e.textures,this.animations=o;}}class S9{_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}load(e,t,i){fy.fetchArrayBuffer(e.load,(s,r)=>{s?t(s):SJ.parse(this._getUrlWithoutParams(e.original),P.extractPath(e.load),r,this._device,i.registry,i.options,(e,s)=>{e?t(e):t(null,new S6(s,i,this._assets,this._defaultMaterial));});},i,this.maxRetries);}open(e,t,i){return t}patch(e,t){}constructor(e,t,i){this._device=e,this._assets=t,this._defaultMaterial=SJ.createDefaultMaterial(),this.maxRetries=i;}}class S7 extends fC{set maxRetries(e){for(let t in this.glbContainerParser.maxRetries=e,this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e);}get maxRetries(){return this.glbContainerParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){let t=e?P.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".",""):null;return this.parsers[t]||this.glbContainerParser}load(e,t,i){"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,i);}open(e,t,i){return this._getParser(e).open(e,t,i)}constructor(e){super(e,"container"),this.glbContainerParser=new S9(e.graphicsDevice,e.assets,0),this.parsers={};}}class ye extends fC{load(e,t){"string"==typeof e&&(e={load:e,original:e}),a$.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(i,s)=>{i?t(`Error loading css resource: ${e.original} [${i}]`):t(null,s);});}openBinary(e){return this.decoder??(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)}constructor(e){super(e,"css"),this.decoder=null;}}class yt extends fC{load(e,t,i){this.loadAssets(i,t);}open(e,t,i){return i?i.resource:null}patch(e,t){this.loadAssets(e,(i,s)=>{i&&(t.fire("error",e),t.fire(`error:${e.id}`,i,e),e.fire("error",e));});}getAssetIds(e){let t=[];if(t[0]=e.file,(e.loadFaces||!e.file)&&e.data&&e.data.textures)for(let i=0;i<6;++i)t[i+1]=e.data.textures[i];else t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=null;return t}compareAssetIds(e,t){return e&&t?parseInt(e,10)===e||"string"==typeof e?e===t:e.url===t.url:null!==e==(null!==t)}update(e,t,i){let s,r,a,n=e.data||{},o=e._handlerState.assets,l=e._resources,h=[null,null,null,null,null,null,null],c=function(){return n.hasOwnProperty("type")?n.type:n.hasOwnProperty("rgbm")?n.rgbm?tI:tP:null};if(e.loaded&&i[0]===o[0])h[1]=l[1]||null,h[2]=l[2]||null,h[3]=l[3]||null,h[4]=l[4]||null,h[5]=l[5]||null,h[6]=l[6]||null;else if(i[0])if((s=i[0].resource).cubemap)for(a=0;a<6;++a)h[a+1]=new ih(this._device,{name:`${e.name}_prelitCubemap${s.width>>a}`,cubemap:true,type:c()||s.type,width:s.width>>a,height:s.height>>a,format:s.format,levels:[s._levels[a]],addressU:1,addressV:1,mipmaps:0===a});else h[1]=s;let d=i.slice(1);if(e.loaded&&this.cmpArrays(d,o.slice(1)))h[0]=l[0]||null;else if(-1===d.indexOf(null)){let t=d.map(e=>e.resource),i=[];for(r=0;r<t[0]._levels.length;++r)i.push(t.map(e=>e._levels[r]));let s=t[0].format,a=new ih(this._device,{name:`${e.name}_faces`,cubemap:true,type:c()||t[0].type,width:t[0].width,height:t[0].height,format:6===s?7:s,mipmaps:n.mipmaps??true,levels:i,minFilter:n.hasOwnProperty("minFilter")?n.minFilter:t[0].minFilter,magFilter:n.hasOwnProperty("magFilter")?n.magFilter:t[0].magFilter,anisotropy:n.hasOwnProperty("anisotropy")?n.anisotropy:1,addressU:1,addressV:1});h[0]=a;}if(!this.cmpArrays(h,l))for(a=0,e.resources=h,e._handlerState.assetIds=t,e._handlerState.assets=i;a<l.length;++a)null!==l[a]&&-1===h.indexOf(l[a])&&l[a].destroy();for(a=0;a<o.length;++a)null!==o[a]&&-1===i.indexOf(o[a])&&o[a].unload();}cmpArrays(e,t){if(e.length!==t.length)return  false;for(let i=0;i<e.length;++i)if(e[i]!==t[i])return  false;return  true}resolveId(e){let t=parseInt(e,10);return t===e||t.toString()===e?t:e}loadAssets(e,t){let i;e.hasOwnProperty("_handlerState")||(e._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});let s=this,r=s.getAssetIds(e),a=[null,null,null,null,null,null,null],n=e._handlerState.assetIds,o=e._handlerState.assets,l=s._registry,h=7,c=function(i,n){a[i]=n,0==--h&&(s.update(e,r,a),t(null,e.resources));},d=function(e,i,s){t(i);},u=function(e,t){t.loaded?c(e,t):(l.once(`load:${t.id}`,c.bind(s,e)),l.once(`error:${t.id}`,d.bind(s,e)),t.loading||l.load(t));};for(let t=0;t<7;++t){let a=this.resolveId(r[t]);if(a)if(s.compareAssetIds(a,n[t]))u(t,o[t]);else if(parseInt(a,10)===a)(i=l.get(a))?u(t,i):setTimeout(((e,t)=>{let i=l.get(t);i?u(e,i):d(e,`failed to find dependent cubemap asset=${t}`);}).bind(null,t,a));else {let s="string"==typeof a?{url:a,filename:a}:a,r=-1===s.url.search(".dds")?{type:"rgbp",addressu:"clamp",addressv:"clamp",mipmaps:false}:null;i=new fy(`${e.name}_part_${t}`,"texture",s,r),l.add(i),u(t,i);}else c(t,null);}}constructor(e){super(e,"cubemap"),this._device=e.graphicsDevice,this._registry=e.assets,this._loader=e.loader;}}class yi extends fC{load(e,t){t(null,null);}constructor(e){super(e,"folder");}}class ys{set data(e){if(this._data=e,e&&(void 0!==this._data.intensity&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),!this._data.version||this._data.version<2)&&(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars))for(let e in this._data.chars)this._data.chars[e].map=0;}get data(){return this._data}constructor(e,t){this.type=t&&t.type||mV,this.em=1,this.textures=e,this.intensity=0,this._data=null,this.data=t;}}function yr(e){return e.version<3&&(e.version<2&&(e.info.maps=e.info.maps||[{width:e.info.width,height:e.info.height}]),e.chars=Object.keys(e.chars||{}).reduce((t,i)=>{let s=e.chars[i],r=void 0!==s.letter?s.letter:H.fromCodePoint(i);return e.version<2&&(s.map=s.map||0),t[r]=s,t},{}),e.version=3),e}class ya extends fC{load(e,t,i){"string"==typeof e&&(e={load:e,original:e});let s=this;".json"===P.getExtension(e.original)?a$.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(i,r)=>{if(i)t(`Error loading font resource: ${e.original} [${i}]`);else {let i=yr(r);s._loadTextures(e.load.replace(".json",".png"),i,(e,s)=>{e?t(e):t(null,{data:i,textures:s});});}}):(i&&i.data&&(i.data=yr(i.data)),this._loadTextures(e.load,i&&i.data,t));}_loadTextures(e,t,i){let s=t.info.maps.length,r=0,a=null,n=Array(s),o=this._loader,l=function(t){let l=function(e,o){if(!a){if(e){a=e,i(e);return}o.upload(),n[t]=o,++r===s&&i(null,n);}};0===t?o.load(e,"texture",l):o.load(e.replace(".png",`${t}.png`),"texture",l);};for(let e=0;e<s;e++)l(e);}open(e,t,i){return t.textures?new ys(t.textures,t.data):new ys(t,null)}patch(e,t){let i=e.resource;!i.data&&e.data?i.data=e.data:!e.data&&i.data&&(e.data=i.data),e.data&&(e.data=yr(e.data));}constructor(e){super(e,"font"),this._loader=e.loader,this.maxRetries=0;}}class yn{constructor(e,t,i,s,r,a){let n=(e,t)=>{let i=(1<<t)-1;return (e&i)/i},o=(e,t)=>{e.x=n(t>>>21,11),e.y=n(t>>>11,10),e.z=n(t,11);},l=(e,t,i)=>e*(1-i)+t*i,{chunkData:h,chunkSize:c,vertexData:d,shData0:u,shData1:f,shData2:p,shBands:m}=e,_=[3,8,15][m-1];this.read=e=>{let g=Math.floor(e/256)*c;if(t&&(o(t,d[4*e+0]),t.x=l(h[g+0],h[g+3],t.x),t.y=l(h[g+1],h[g+4],t.y),t.z=l(h[g+2],h[g+5],t.z)),i&&((e,t)=>{let i=Math.SQRT2,s=(n(t>>>20,10)-.5)*i,r=(n(t>>>10,10)-.5)*i,a=(n(t,10)-.5)*i,o=Math.sqrt(1-(s*s+r*r+a*a));switch(t>>>30){case 0:e.set(s,r,a,o);break;case 1:e.set(o,r,a,s);break;case 2:e.set(r,o,a,s);break;case 3:e.set(r,a,o,s);}})(i,d[4*e+1]),s&&(o(s,d[4*e+2]),s.x=l(h[g+6],h[g+9],s.x),s.y=l(h[g+7],h[g+10],s.y),s.z=l(h[g+8],h[g+11],s.z)),r){var v;r.x=n((v=d[4*e+3])>>>24,8),r.y=n(v>>>16,8),r.z=n(v>>>8,8),r.w=n(v,8),c>12&&(r.x=l(h[g+12],h[g+15],r.x),r.y=l(h[g+13],h[g+16],r.y),r.z=l(h[g+14],h[g+17],r.z));}if(a&&m>0){let t=[u,f,p];for(let i=0;i<3;++i)for(let s=0;s<15;++s)a[15*i+s]=s<_?t[i][16*e+s]*(8/255)-4:0;}};}}class yo{createIter(e,t,i,s,r){return new yn(this,e,t,i,s,r)}calcAabb(e){let{chunkData:t,numChunks:i,chunkSize:s}=this,r=Math.exp(Math.max(t[9],t[10],t[11])),a=t[0]-r,n=t[1]-r,o=t[2]-r,l=t[3]+r,h=t[4]+r,c=t[5]+r;for(let e=1;e<i;++e){let i=e*s;r=Math.exp(Math.max(t[i+9],t[i+10],t[i+11])),a=Math.min(a,t[i+0]-r),n=Math.min(n,t[i+1]-r),o=Math.min(o,t[i+2]-r),l=Math.max(l,t[i+3]+r),h=Math.max(h,t[i+4]+r),c=Math.max(c,t[i+5]+r);}return e.center.set((a+l)*.5,(n+h)*.5,(o+c)*.5),e.halfExtents.set((l-a)*.5,(h-n)*.5,(c-o)*.5),true}getCenters(){let e,t,i,s,r,a,{vertexData:n,chunkData:o,numChunks:l,chunkSize:h}=this,c=new Float32Array(3*this.numSplats);for(let d=0;d<l;++d){let l=d*h;e=o[l+0],t=o[l+1],i=o[l+2],s=o[l+3],r=o[l+4],a=o[l+5];let u=Math.min(this.numSplats,(d+1)*256);for(let o=256*d;o<u;++o){let l=n[4*o],h=(l>>>21)/2047,d=(l>>>11&1023)/1023,u=(2047&l)/2047;c[3*o+0]=(1-h)*e+h*s,c[3*o+1]=(1-d)*t+d*r,c[3*o+2]=(1-u)*i+u*a;}}return c}getChunks(e){let t,i,s,r,a,n,{chunkData:o,numChunks:l,chunkSize:h}=this;for(let c=0;c<l;++c){let l=c*h;t=o[l+0],i=o[l+1],s=o[l+2],r=o[l+3],a=o[l+4],n=o[l+5],e[6*c+0]=t,e[6*c+1]=i,e[6*c+2]=s,e[6*c+3]=r,e[6*c+4]=a,e[6*c+5]=n;}}calcFocalPoint(e){let{chunkData:t,numChunks:i,chunkSize:s}=this;e.x=0,e.y=0,e.z=0;for(let r=0;r<i;++r){let i=r*s;e.x+=t[i+0]+t[i+3],e.y+=t[i+1]+t[i+4],e.z+=t[i+2]+t[i+5];}e.mulScalar(.5/i);}get isCompressed(){return  true}get numChunks(){return Math.ceil(this.numSplats/256)}get chunkSize(){return this.chunkData.length/this.numChunks}decompress(){let e=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3"],{shBands:t}=this;if(t>0){let t=[];for(let e=0;e<45;++e)t.push(`f_rest_${e}`);let i=Math.max(...["f_dc_0","f_dc_1","f_dc_2"].map(t=>e.indexOf(t)));e.splice(i+1,0,...t);}let i={};e.forEach(e=>{i[e]=new Float32Array(this.numSplats);});let s=new ed,r=new ex,a=new ed,n=new ep,o=t>0?new Float32Array(45):null,l=this.createIter(s,r,a,n,o);for(let e=0;e<this.numSplats;++e)if(l.read(e),i.x[e]=s.x,i.y[e]=s.y,i.z[e]=s.z,i.rot_1[e]=r.x,i.rot_2[e]=r.y,i.rot_3[e]=r.z,i.rot_0[e]=r.w,i.scale_0[e]=a.x,i.scale_1[e]=a.y,i.scale_2[e]=a.z,i.f_dc_0[e]=(n.x-.5)/.28209479177387814,i.f_dc_1[e]=(n.y-.5)/.28209479177387814,i.f_dc_2[e]=(n.z-.5)/.28209479177387814,i.opacity[e]=n.w<=0?-40:n.w>=1?40:-Math.log(1/n.w-1),o)for(let t=0;t<45;++t)i[`f_rest_${t}`][e]=o[t];return new uI([{name:"vertex",count:this.numSplats,properties:e.map(e=>({name:e,type:"float",byteSize:4,storage:i[e]}))}],this.comments)}}class yl extends ux{destroy(){super.destroy();}configureMaterialDefines(e){e.set("SH_BANDS",3*!!this.streams.textures.has("shTexture0"));}evalChunkTextureSize(e){let t=Math.ceil(Math.sqrt(e)),i=Math.ceil(e/t);return new ef(5*t,i)}constructor(e,t){super(e,t);let{chunkData:i,chunkSize:s,numChunks:r,numSplats:a,vertexData:n,shBands:o}=t;this.chunks=new Float32Array(6*r),t.getChunks(this.chunks);let l=[{name:"packedTexture",format:49}];o>0&&(l.push({name:"shTexture0",format:49}),l.push({name:"shTexture1",format:49}),l.push({name:"shTexture2",format:49})),this._format=new cR(e,l,{readGLSL:'#include "gsplatCompressedVS"',readWGSL:'#include "gsplatCompressedVS"'}),this.streams.init(this.format,a);let h=this.streams.getTexture("packedTexture");if(h.lock().set(n),h.unlock(),o>0){let e=this.streams.getTexture("shTexture0"),i=this.streams.getTexture("shTexture1"),s=this.streams.getTexture("shTexture2");e.lock().set(new Uint32Array(t.shData0.buffer)),e.unlock(),i.lock().set(new Uint32Array(t.shData1.buffer)),i.unlock(),s.lock().set(new Uint32Array(t.shData2.buffer)),s.unlock();}let c=this.evalChunkTextureSize(r),d=this.streams.createTexture("chunkTexture",14,c);this.streams.textures.set("chunkTexture",d);let u=d.lock();for(let e=0;e<r;++e)for(let t=0;t<s;++t)u[20*e+t]=i[e*s+t];if(12===s)for(let e=0;e<r;++e)u[20*e+15]=1,u[20*e+16]=1,u[20*e+17]=1;d.unlock();}}let yh=new Uint8Array([112,108,121,10]),yc=new Uint8Array([10,101,110,100,95,104,101,97,100,101,114,10]),yd=new Map([["char",Int8Array],["uchar",Uint8Array],["short",Int16Array],["ushort",Uint16Array],["int",Int32Array],["uint",Uint32Array],["float",Float32Array],["double",Float64Array]]);class yu{async read(){let{value:e,done:t}=await this.reader.read();if(t)throw Error("Stream finished before end of header");this.push(e),this.progressFunc?.(e.byteLength);}push(e){if(this.data){let t=this.tail-this.head,i=t+e.length;if(this.data.length>=i)this.head>0?(this.data.copyWithin(0,this.head,this.tail),this.data.set(e,t),this.head=0,this.tail=i):(this.data.set(e,this.tail),this.tail+=e.length);else {let s=new Uint8Array(i);this.head>0||this.tail<this.data.length?s.set(this.data.subarray(this.head,this.tail),0):s.set(this.data,0),s.set(e,t),this.data=s,this.view=new DataView(this.data.buffer),this.head=0,this.tail=i;}}else this.data=e,this.view=new DataView(this.data.buffer),this.tail=e.length;}compact(){this.head>0&&(this.data.copyWithin(0,this.head,this.tail),this.tail-=this.head,this.head=0);}get remaining(){return this.tail-this.head}getInt8(){let e=this.view.getInt8(this.head);return this.head++,e}getUint8(){let e=this.view.getUint8(this.head);return this.head++,e}getInt16(){let e=this.view.getInt16(this.head,true);return this.head+=2,e}getUint16(){let e=this.view.getUint16(this.head,true);return this.head+=2,e}getInt32(){let e=this.view.getInt32(this.head,true);return this.head+=4,e}getUint32(){let e=this.view.getUint32(this.head,true);return this.head+=4,e}getFloat32(){let e=this.view.getFloat32(this.head,true);return this.head+=4,e}getFloat64(){let e=this.view.getFloat64(this.head,true);return this.head+=8,e}constructor(e,t){this.head=0,this.tail=0,this.reader=e,this.progressFunc=t;}}let yf=async(e,t,i)=>{let s,r,a=new yo;a.comments=i;let n=t[0].count,o=t[0].properties.length,l=t[1].count,h=(s=Math.ceil(Math.sqrt(l)),r=Math.ceil(l/s),s*r);a.numSplats=l,a.chunkData=new Float32Array(n*o),a.vertexData=new Uint32Array(4*h);let c=async(t,i)=>{let s=new Uint8Array(t),r=0;for(;r<i;){for(;0===e.remaining;)await e.read();let t=Math.min(i-r,e.remaining),a=e.data;for(let i=0;i<t;++i)s[r++]=a[e.head++];}};if(await c(a.chunkData.buffer,n*o*4),await c(a.vertexData.buffer,4*l*4),3===t.length){let e=16*h,i=new Uint8Array(e),s=new Uint8Array(e),r=new Uint8Array(e),n=t[2].properties.length/3,o=new Uint8Array(1024*n*3);for(let e=0;e<a.numSplats;e+=1024){let t=Math.min(1024,a.numSplats-e);await c(o.buffer,t*n*3);for(let a=0;a<t;++a)for(let t=0;t<15;++t){let l=(e+a)*16+t;t<n?(i[l]=o[(3*a+0)*n+t],s[l]=o[(3*a+1)*n+t],r[l]=o[(3*a+2)*n+t]):(i[l]=127,s[l]=127,r[l]=127);}}a.shData0=i,a.shData1=s,a.shData2=r,a.shBands=({3:1,8:2,15:3})[n];}else a.shBands=0;return a},yp=async(e,t,i)=>{let s,r=t[0],a=r.properties,n=a.length,o=a.map(e=>e.storage),l=a.reduce((e,t)=>e+t.byteSize,0),h=0,c=()=>{let t=e.data.buffer;s?.buffer!==t&&(s=new Float32Array(t,0,t.byteLength/4));};for(c();h<r.count;){for(;e.remaining<l;)await e.read(),c();let t=Math.min(r.count-h,Math.floor(e.remaining/l));for(let e=0;e<n;++e){let i=o[e];for(let r=0;r<t;++r)i[r+h]=s[r*n+e];}h+=t,e.head+=t*l;}return new uI(t,i)},ym=async(e,t,i)=>{for(let i=0;i<t.length;++i){let s=t[i],r=s.properties.reduce((e,t)=>e+t.byteSize,0),a=s.properties.map(e=>{if(!e.storage)return t=>{t.head+=e.byteSize;};switch(e.type){case "char":return (t,i)=>{e.storage[i]=t.getInt8();};case "uchar":return (t,i)=>{e.storage[i]=t.getUint8();};case "short":return (t,i)=>{e.storage[i]=t.getInt16();};case "ushort":return (t,i)=>{e.storage[i]=t.getUint16();};case "int":return (t,i)=>{e.storage[i]=t.getInt32();};case "uint":return (t,i)=>{e.storage[i]=t.getUint32();};case "float":return (t,i)=>{e.storage[i]=t.getFloat32();};case "double":return (t,i)=>{e.storage[i]=t.getFloat64();};default:throw Error(`Unsupported property data type '${e.type}' in ply header`)}}),n=0;for(;n<s.count;){for(;e.remaining<r;)await e.read();let t=Math.min(s.count-n,Math.floor(e.remaining/r));for(let i=0;i<t;++i){for(let t=0;t<s.properties.length;++t)a[t](e,n);n++;}}}return new uI(t,i)},y_=async(e,t=null,i=null)=>{let s,r=(e,t)=>{let i,s,r=e.length-t.length;for(i=0;i<=r;++i){for(s=0;s<t.length&&e[i+s]===t[s];++s);if(s===t.length)return i}return -1},a=(e,t)=>{if(e.length<t.length)return  false;for(let i=0;i<t.length;++i)if(e[i]!==t[i])return  false;return  true},n=new yu(e,i);for(;;){if(await n.read(),n.tail>=yh.length&&!a(n.data,yh))throw Error("Invalid ply header");if(-1!==(s=r(n.data,yc)))break}let{elements:o,format:l,comments:h}=(e=>{let t,i=[],s=[];for(let r=1;r<e.length;++r){let a=e[r].split(" ");switch(a[0]){case "comment":s.push(a.slice(1).join(" "));break;case "format":t=a[1];break;case "element":i.push({name:a[1],count:parseInt(a[2],10),properties:[]});break;case "property":if(!yd.has(a[1]))throw Error(`Unrecognized property data type '${a[1]}' in ply header`);i[i.length-1].properties.push({type:a[1],name:a[2],storage:null,byteSize:yd.get(a[1]).BYTES_PER_ELEMENT});break;default:throw Error(`Unrecognized header value '${a[0]}' in ply header`)}}return {elements:i,format:t,comments:s}})(new TextDecoder("ascii").decode(n.data.subarray(0,s)).split("\n"));if("binary_little_endian"!==l)throw Error("Unsupported ply format");n.head=s+yc.length,n.compact();let c=async()=>{let e,i,s,r;return (e=["min_x","min_y","min_z","max_x","max_y","max_z","min_scale_x","min_scale_y","min_scale_z","max_scale_x","max_scale_y","max_scale_z","min_r","min_g","min_b","max_r","max_g","max_b"],i=["packed_position","packed_rotation","packed_scale","packed_color"],s=Array(45).fill("").map((e,t)=>`f_rest_${t}`),r=()=>"chunk"===o[0].name&&o[0].properties.every((t,i)=>t.name===e[i]&&"float"===t.type)&&"vertex"===o[1].name&&o[1].properties.every((e,t)=>e.name===i[t]&&"uint"===e.type),2===o.length&&r()||3===o.length&&r()&&"sh"===o[2].name&&-1!==[9,24,45].indexOf(o[2].properties.length)&&o[2].properties.every((e,t)=>e.name===s[t]&&"uchar"===e.type))?await yf(n,o,h):(o.forEach(e=>{e.properties.forEach(i=>{let s=yd.get(i.type);if(s){let r=!t||t(i.name)?new s(e.count):null;i.storage=r;}});}),1===o.length&&"vertex"===o[0].name&&o[0].properties.every(e=>"float"===e.type)?await yp(n,o,h):await ym(n,o,h))};return await c()},yg=e=>true;class yv{async load(e,t,i){try{let s=await (i.file?.contents??fetch(e.load));if(s&&s.body){let e=parseInt(s.headers.get("content-length")??"0",10),r=0,a=await y_(s.body.getReader(),i.data.elementFilter??yg,t=>{r+=t,i&&i.fire("progress",r,e);});i.fire("load:data",a),!a.isCompressed&&(i.data.reorder??!0)&&a.reorderData();let n=a.isCompressed&&!i.data.decompress?new yl(this.app.graphicsDevice,a):new u8(this.app.graphicsDevice,a.isCompressed?a.decompress():a);t(null,n);}else t("Error loading resource",null);}catch(e){t(e,null);}}open(e,t){return t}constructor(e,t){this.app=e,this.maxRetries=t;}}class yS{_shouldAbort(e,t){return !(!t&&this.app.assets.get(e.id)&&this.app?.graphicsDevice&&!this.app.graphicsDevice._destroyed)}async loadTextures(e,t,i,s){var r;let a,n;2!==s.version&&(a={version:1,count:(r=s).means.shape[0],means:{mins:r.means.mins,maxs:r.means.maxs,files:r.means.files},scales:{mins:r.scales.mins,maxs:r.scales.maxs,files:r.scales.files},quats:{files:r.quats.files},sh0:{mins:r.sh0.mins,maxs:r.sh0.maxs,files:r.sh0.files}},r.shN&&(a.shN={mins:r.shN.mins,maxs:r.shN.maxs,files:r.shN.files}),s=a);let{assets:o}=this.app,l=["means","quats","scales","sh0","shN"],h={},c=[];l.forEach(t=>{let r=s[t]?.files??[];h[t]=r.map(t=>{let s=new fy(t,"texture",{url:i.options?.mapUrl?.(t)??new URL(t,new URL(e.load,window.location.href).toString()).toString(),filename:t},{mipmaps:false},{crossOrigin:"anonymous"}),r=new Promise((e,t)=>{s.on("load",()=>e(null)),s.on("error",e=>t(e));});return o.add(s),c.push(r),s});});let d=l.map(e=>h[e]).flat(),u=false;if(i.once("unload",()=>{u=true,d.forEach(e=>{o.remove(e),e.unload();});}),n=new Map,d.forEach(e=>{let t=(t,s)=>{let r,a;n.set(e,{loaded:t,total:s}),r=0,a=0,n.forEach(e=>{r+=e.loaded,a+=e.total;}),i.fire("progress",r,a);},s=()=>{e.off("progress",t),e.off("load",s),e.off("error",s);};e.on("progress",t),e.on("load",s),e.on("error",s);}),d.forEach(e=>o.load(e)),await Promise.allSettled(c),this._shouldAbort(i,u)){d.forEach(e=>{o.remove(e),e.unload();}),t(null,null);return}let f=new uJ;f.url=e.original,f.meta=s,f.numSplats=s.count,f.means_l=h.means[0].resource,f.means_u=h.means[1].resource,f.quats=h.quats[0].resource,f.scales=h.scales[0].resource,f.sh0=h.sh0[0].resource,f.sh_centroids=h.shN?.[0]?.resource,f.sh_labels=h.shN?.[1]?.resource,f.shBands=uJ.calcBands(f.sh_centroids?.width);let p=i.data?.decompress;if(f.minimalMemory=i.options?.minimalMemory??false,!p){if(this._shouldAbort(i,u)){f.destroy(),t(null,null);return}await f.prepareGpuData();}if(this._shouldAbort(i,u)){f.destroy(),t(null,null);return}let m=p?new u8(this.app.graphicsDevice,await f.decompress()):new u6(this.app.graphicsDevice,f);if(this._shouldAbort(i,u)){m.destroy(),t(null,null);return}t(null,m);}load(e,t,i){if(i.data?.means)this.loadTextures(e,t,i,i.data);else {"string"==typeof e&&(e={load:e,original:e});let s={retry:this.maxRetries>0,maxRetries:this.maxRetries,responseType:aq.ResponseType.JSON};a$.get(e.load,s,(s,r)=>{this._shouldAbort(i,false)?t(null,null):s?t(`Error loading gsplat meta: ${e.original} [${s}]`):this.loadTextures(e,t,i,r);});}}constructor(e,t){this.app=e,this.maxRetries=t;}}let yy=async e=>{let t=new DecompressionStream("deflate-raw"),i=new Blob([e]).stream().pipeThrough(t);return new Uint8Array(await new Response(i).arrayBuffer())},yx=async(e,t)=>{let i=await (t.file?.contents??fetch(e.load));if(!i)throw Error("Error loading resource");if(i instanceof Response){if(!i.ok)throw Error(`Error loading resource: ${i.status} ${i.statusText}`);let e=parseInt(i.headers.get("content-length")??"0",10);if(!i.body||!i.body.getReader){let s=await i.arrayBuffer();return t.fire("progress",s.byteLength,e),s}let s=i.body.getReader(),r=[],a=0;try{for(;;){let{done:i,value:n}=await s.read();if(i)break;r.push(n),a+=n.byteLength,t.fire("progress",a,e);}}finally{s.releaseLock();}return new Blob(r).arrayBuffer()}return i};class yT{async load(e,t,i){try{let s,r=await yx(e,i),a=(e=>{var t;let i,s,r,a,n=new DataView(e),o=t=>{let i,s,r,a,o,l,h,c=(i=t+28,n.getUint16(i,!0)),d=(s=t+30,n.getUint16(s,!0)),u=(r=t+32,n.getUint16(r,!0));return {magic:n.getUint32(t,!0),compressionMethod:(a=t+10,n.getUint16(a,!0)),compressedSizeBytes:(o=t+20,n.getUint32(o,!0)),uncompressedSizeBytes:(l=t+24,n.getUint32(l,!0)),lfhOffsetBytes:(h=t+42,n.getUint32(h,!0)),filename:new TextDecoder().decode(new Uint8Array(e,t+46,c)),recordSizeBytes:46+c+d+u}},l=e=>{let t,i,s=(t=e+26,n.getUint16(t,!0)),r=(i=e+28,n.getUint16(i,!0));return {magic:n.getUint32(e,!0),offsetBytes:e+30+s+r}},h={magic:(i=t=n.byteLength-22,n.getUint32(i,!0)),numFiles:(s=t+8,n.getUint16(s,!0)),cdSizeBytes:(r=t+12,n.getUint32(r,!0)),cdOffsetBytes:(a=t+16,n.getUint32(a,!0))};if(0x6054b50!==h.magic)throw Error("Invalid zip file: EOCDR not found");if(0xffffffff===h.cdOffsetBytes||0xffffffff===h.cdSizeBytes)throw Error("Invalid zip file: Zip64 not supported");let c=[],d=h.cdOffsetBytes;for(let t=0;t<h.numFiles;t++){let t=o(d);if(0x2014b50!==t.magic)throw Error("Invalid zip file: CDR not found");let i=l(t.lfhOffsetBytes);if(0x4034b50!==i.magic)throw Error("Invalid zip file: LFH not found");c.push({filename:t.filename,compression:{0:"none",8:"deflate"}[t.compressionMethod]??"unknown",data:new Uint8Array(e,i.offsetBytes,t.compressedSizeBytes)}),d+=t.recordSizeBytes;}return c})(r);for(let e of a)"deflate"===e.compression&&(e.data=await yy(e.data));let n=a.find(e=>"meta.json"===e.filename);if(!n)return void t("Error: meta.json not found");try{s=JSON.parse(new TextDecoder().decode(n.data));}catch(e){t(`Error parsing meta.json: ${e}`);return}let o=["means","scales","quats","sh0","shN"].map(e=>s[e]?.files??[]).flat(),l={},h=[];for(let t of o){let i,s=a.find(e=>e.filename===t);if(s)i=new fy(t,"texture",{url:`${e.load}/${t}`,filename:t,contents:s.data},{mipmaps:!1},{crossOrigin:"anonymous"});else {let e=new URL(t,new URL(t,window.location.href).toString()).toString();i=new fy(t,"texture",{url:e,filename:t},{mipmaps:!1},{crossOrigin:"anonymous"});}let r=new Promise((e,t)=>{i.on("load",()=>e(null)),i.on("error",e=>t(e));});this.app.assets.add(i),l[t]=i,h.push(r);}Object.values(l).forEach(e=>this.app.assets.load(e)),await Promise.allSettled(h);let{assets:c}=this.app;i.once("unload",()=>{Object.values(l).forEach(e=>{c.remove(e),e.unload();});});let d=i.data?.decompress,u=i.options?.minimalMemory??!1,f=new uJ;f.url=e.original,f.minimalMemory=u,f.meta=s,f.numSplats=s.count,f.means_l=l[s.means.files[0]].resource,f.means_u=l[s.means.files[1]].resource,f.quats=l[s.quats.files[0]].resource,f.scales=l[s.scales.files[0]].resource,f.sh0=l[s.sh0.files[0]].resource,f.sh_centroids=l[s.shN?.files[0]]?.resource,f.sh_labels=l[s.shN?.files[1]]?.resource,f.shBands=uJ.calcBands(f.sh_centroids?.width),d||await f.prepareGpuData();let p=d?new u8(this.app.graphicsDevice,await f.decompress()):new u6(this.app.graphicsDevice,f);t(null,p);}catch(e){t(e);}}constructor(e,t=3){this.app=e,this.maxRetries=t;}}class yE{load(e){}unload(e){}getResource(e){}destroy(){}}class yw extends yE{destroy(){for(let e of(this._destroyed=true,this._urlToAsset.values()))e.fire("unload",e),e.off("load"),e.off("error"),this._registry.remove(e),e.unload();this._urlToAsset.clear(),this._loadQueue.length=0,this._currentlyLoading.clear(),this._retryCount.clear();}_canLoad(){return !!this._registry.loader?.getHandler("gsplat")}load(e){let t=this._urlToAsset.get(e);t?.loaded||this._currentlyLoading.has(e)||this._loadQueue.includes(e)||(this._currentlyLoading.size<this.maxConcurrentLoads?this._startLoading(e):this._loadQueue.push(e));}_startLoading(e){this._currentlyLoading.add(e);let t=this._urlToAsset.get(e);t||(t=new fy(e,"gsplat",{url:e},{},{minimalMemory:true}),this._registry.add(t),this._urlToAsset.set(e,t)),t.once("load",()=>this._onAssetLoadSuccess(e,t)),t.once("error",i=>this._onAssetLoadError(e,t,i)),t.loaded||t.loading||this._registry.load(t);}_onAssetLoadSuccess(e,t){!this._destroyed&&this._urlToAsset.has(e)&&(this._currentlyLoading.delete(e),this._retryCount.delete(e),this._processQueue());}_onAssetLoadError(e,t,i){if(this._destroyed||!this._canLoad()||!this._urlToAsset.has(e))return;let s=this._retryCount.get(e)||0;s<this.maxRetries?(this._retryCount.set(e,s+1),t.loaded=false,t.loading=false,this._registry.load(t)):(this._currentlyLoading.delete(e),this._retryCount.delete(e),this._processQueue());}_processQueue(){if(!this._destroyed&&this._canLoad())for(;this._currentlyLoading.size<this.maxConcurrentLoads&&this._loadQueue.length>0;){let e=this._loadQueue.shift();e&&this._startLoading(e);}}unload(e){this._currentlyLoading.delete(e);let t=this._loadQueue.indexOf(e);-1!==t&&this._loadQueue.splice(t,1),this._retryCount.delete(e);let i=this._urlToAsset.get(e);i&&(i.fire("unload",i),i.off("load"),i.off("error"),this._registry.remove(i),i.unload(),this._urlToAsset.delete(e)),this._processQueue();}getResource(e){let t=this._urlToAsset.get(e);return t?.resource}constructor(e){super(),this._urlToAsset=new Map,this.maxConcurrentLoads=2,this.maxRetries=2,this._currentlyLoading=new Set,this._loadQueue=[],this._retryCount=new Map,this._destroyed=false,this._registry=e;}}class yb{load(e,t,i){"string"==typeof e&&(e={load:e,original:e});let s={retry:this.maxRetries>0,maxRetries:this.maxRetries,responseType:aq.ResponseType.JSON};a$.get(e.load,s,(s,r)=>{if(s)t(`Error loading gsplat octree: ${e.original} [${s}]`);else {let e=new yw(this.app.assets);t(null,new vV(i.file.url,r,e));}});}constructor(e,t){this.app=e,this.maxRetries=t;}}class yA extends fC{_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){let t=P.getBasename(this._getUrlWithoutParams(e)).toLowerCase();if("lod-meta.json"===t)return this.parsers.octree;let i=P.getExtension(t).replace(".","");return this.parsers[i]||this.parsers.ply}load(e,t,i){"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,i);}open(e,t,i){return t}constructor(e){super(e,"gsplat"),this.parsers={ply:new yv(e,3),sog:new yT(e),json:new yS(e,3),octree:new yb(e,3)};}}class yC{static setCompressedPRS(e,t,i){let s,r,a=i.singleVecs,n=t.___1;n||(s=i.tripleVecs,r=t.___2);let o=n?n[0]:s[r];e.setLocalPosition(a[o],a[o+1],a[o+2]),o=n?n[1]:s[r+1],e.setLocalEulerAngles(a[o],a[o+1],a[o+2]),o=n?n[2]:s[r+2],e.setLocalScale(a[o],a[o+1],a[o+2]);}static oneCharToKey(e,t){let i=e.charCodeAt(0)-t.fieldFirstCode;return t.fieldArray[i]}static multCharToKey(e,t){let i=0;for(let s=0;s<e.length;s++)i=i*t.fieldCodeBase+e.charCodeAt(s)-t.fieldFirstCode;return t.fieldArray[i]}}class yP{run(){let e=Object.prototype.toString.call(this._node);return "[object Object]"===e?this._handleMap():"[object Array]"===e?this._handleArray():this._result=this._node,this._result}_handleMap(){this._result={},Object.keys(this._node).forEach(this._handleKey,this);}_handleKey(e){let t=e,i=e.length;1===i?t=yC.oneCharToKey(e,this._data):2===i&&(t=yC.multCharToKey(e,this._data)),this._result[t]=new yP(this._node[e],this._data).run();}_handleArray(){this._result=[],this._node.forEach(this._handleArElt,this);}_handleArElt(e){let t=new yP(e,this._data).run();this._result.push(t);}constructor(e,t){this._node=e,this._data=t;}}class yI{parse(e){let t={},i=null,s=e.compressedFormat;for(let r in s&&!e.entDecompressed&&(e.entDecompressed=true,e.entities=new yP(e.entities,s).run()),e.entities){let a=e.entities[r],n=this._createEntity(a,s);t[r]=n,null===a.parent&&(i=n);}for(let i in e.entities){let s=t[i],r=e.entities[i].children,a=r.length;for(let e=0;e<a;e++){let i=t[r[e]];i&&s.addChild(i);}}return this._openComponentData(i,e.entities),i}_createEntity(e,t){let i=new fB(e.name,this._app);if(i.setGuid(e.resource_id),this._setPosRotScale(i,e,t),i._enabled=e.enabled??true,this._isTemplate?i._template=true:i._enabledInHierarchy=i._enabled,i.template=e.template,e.tags)for(let t=0;t<e.tags.length;t++)i.tags.add(e.tags[t]);return i}_setPosRotScale(e,t,i){if(i)yC.setCompressedPRS(e,t,i);else {let i=t.position,s=t.rotation,r=t.scale;e.setLocalPosition(i[0],i[1],i[2]),e.setLocalEulerAngles(s[0],s[1],s[2]),e.setLocalScale(r[0],r[1],r[2]);}}_openComponentData(e,t){let i=this._app.systems.list,s=i.length,r=t[e.getGuid()];for(let t=0;t<s;t++){let s=i[t],a=r.components[s.id];a&&s.addComponent(e,a);}s=r.children.length;let a=e._children;for(let e=0;e<s;e++)a[e]&&(a[e]=this._openComponentData(a[e],t));return e}constructor(e,t){this._app=e,this._isTemplate=t;}}class yD{static load(e,t,i){"string"==typeof e&&(e={load:e,original:e}),a$.get(e.load,{retry:t>0,maxRetries:t},(t,s)=>{if(t){let s=`Error while loading scene JSON ${e.original}`;t.message?(s+=`: ${t.message}`,t.stack&&(s+=`
${t.stack}`)):s+=`: ${t}`,i(s);}else i(t,s);});}}class yR extends fC{load(e,t){yD.load(e,this.maxRetries,t);}open(e,t){this._app.systems.script.preloading=true;let i=new yI(this._app,false).parse(t);return this._app.systems.script.preloading=false,i}constructor(e){super(e,"hierarchy");}}class yL extends fC{load(e,t){"string"==typeof e&&(e={load:e,original:e}),a$.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(i,s)=>{i?t(`Error loading html resource: ${e.original} [${i}]`):t(null,s);});}openBinary(e){return this.decoder??(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)}constructor(e){super(e,"html"),this.decoder=null;}}class yM extends fC{load(e,t){"string"==typeof e&&(e={load:e,original:e});let i={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(i.responseType=aq.ResponseType.JSON),a$.get(e.load,i,(i,s)=>{i?t(`Error loading JSON resource: ${e.original} [${i}]`):t(null,s);});}openBinary(e){return this.decoder??(this.decoder=new TextDecoder("utf-8")),JSON.parse(this.decoder.decode(e))}constructor(e){super(e,"json"),this.decoder=null;}}class yO{setInvalid(e,t){this.valid=false,this.removeInvalid&&delete t[e];}validate(e){let t="path"===e.mappingFormat;for(let i in e){let s=dY[i];if(!s){dj[i]?delete e[i]:this.valid=false;continue}if(s.startsWith("enum")){let t=s.split(":")[1];this.enumValidators[t]&&!this.enumValidators[t](e[i])&&this.setInvalid(i,e);}else if("number"===s)"number"!=typeof e[i]&&this.setInvalid(i,e);else if("boolean"===s)"boolean"!=typeof e[i]&&this.setInvalid(i,e);else if("string"===s)"string"!=typeof e[i]&&this.setInvalid(i,e);else if("vec2"===s)e[i]instanceof Array&&2===e[i].length||this.setInvalid(i,e);else if("rgb"===s)e[i]instanceof Array&&3===e[i].length||this.setInvalid(i,e);else if("texture"===s)t?"string"==typeof e[i]||null===e[i]||e[i]instanceof ih||this.setInvalid(i,e):"number"==typeof e[i]||null===e[i]||e[i]instanceof ih||this.setInvalid(i,e);else if("boundingbox"===s)e[i].center&&e[i].center instanceof Array&&3===e[i].center.length||this.setInvalid(i,e),e[i].halfExtents&&e[i].halfExtents instanceof Array&&3===e[i].halfExtents.length||this.setInvalid(i,e);else if("cubemap"===s)"number"==typeof e[i]||null===e[i]||void 0===e[i]||e[i]instanceof ih&&e[i].cubemap||this.setInvalid(i,e);else if("chunks"===s){let t=Object.keys(e[i]);for(let s=0;s<t.length;s++)"string"!=typeof e[i][t[s]]&&this.setInvalid(t[s],e[i]);}}return e.validated=true,this.valid}_createEnumValidator(e){return function(t){return e.indexOf(t)>=0}}constructor(){this.removeInvalid=true,this.valid=true,this.enumValidators={occludeSpecular:this._createEnumValidator([0,1,2]),cull:this._createEnumValidator([0,1,2,3]),blendType:this._createEnumValidator([0,1,2,3,4,5,6,7,8,9,10]),depthFunc:this._createEnumValidator([0,1,2,3,4,5,6,7])};}}class yF{parse(e){let t=this.migrate(e),i=this._validate(t),s=new d0;return this.initialize(s,i),s}initialize(e,t){if(t.validated||(t=this._validate(t)),t.chunks&&t.chunks&&Object.keys(t.chunks).length>0){let i=e.shaderChunks.glsl;Object.entries(t.chunks).forEach(([e,t])=>i.set(e,t));}for(let i in t){let s=dY[i],r=t[i];if("vec2"===s)e[i]=new ef(r[0],r[1]);else if("rgb"===s)e[i]=new es(r[0],r[1],r[2]);else if("texture"===s)r instanceof ih?e[i]=r:e[i]instanceof ih&&"number"==typeof r&&r>0||(e[i]=null);else if("cubemap"===s)r instanceof ih?e[i]=r:e[i]instanceof ih&&"number"==typeof r&&r>0||(e[i]=null),"cubeMap"!==i||r||(e.prefilteredCubemaps=null);else if("boundingbox"===s){let t=new ed(r.center[0],r.center[1],r.center[2]),s=new ed(r.halfExtents[0],r.halfExtents[1],r.halfExtents[2]);e[i]=new eC(t,s);}else e[i]=t[i];}e.update();}migrate(e){let t;e.shader&&delete e.shader,e.mapping_format&&(e.mappingFormat=e.mapping_format,delete e.mapping_format);let i=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["specularMapTint","specularTint"],["metalnessMapTint","metalnessTint"],["clearCoatGlossiness","clearCoatGloss"]];for(t=0;t<i.length;t++){let s=i[t][0],r=i[t][1];void 0!==e[s]&&(void 0===e[r]&&(e[r]=e[s]),delete e[s]);}let s=["fresnelFactor","shadowSampleType"];for(t=0;t<s.length;t++){let i=s[t];e.hasOwnProperty(i)&&delete e[i];}return e}_validate(e){return e.validated||(this._validator||(this._validator=new yO),this._validator.validate(e)),e}constructor(){this._validator=null;}}let yN={aoMap:"white",aoDetailMap:"white",diffuseMap:"gray",diffuseDetailMap:"gray",specularMap:"gray",specularityFactorMap:"white",metalnessMap:"black",glossMap:"gray",sheenMap:"black",sheenGlossMap:"gray",clearCoatMap:"black",clearCoatGlossMap:"gray",clearCoatNormalMap:"normal",refractionMap:"white",emissiveMap:"gray",normalMap:"normal",normalDetailMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white",thicknessMap:"black",iridescenceMap:"black",iridescenceThicknessMap:"black",envAtlas:"black",anisotropyMap:"black"};class yB extends fC{load(e,t){"string"==typeof e&&(e={load:e,original:e}),a$.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(i,s)=>{i?t&&t(`Error loading material: ${e.original} [${i}]`):t&&(s._engine=true,t(null,s));});}open(e,t){let i=this._parser.parse(t);return t._engine&&(i._data=t,delete t._engine),i}patch(e,t){e.resource._data&&(e._data=e.resource._data,delete e.resource._data),e.data.name=e.name,e.resource.name=e.name,this._bindAndAssignAssets(e,t),e.off("unload",this._onAssetUnload,this),e.on("unload",this._onAssetUnload,this);}_onAssetUnload(e){delete e.data.parameters,delete e.data.chunks,delete e.data.name;}_assignTexture(e,t,i){t.resource[e]=i;}_getPlaceholderTexture(e){let t=yN[e];return ip(this._device,t)}_assignPlaceholderTexture(e,t){t.resource[e]=this._getPlaceholderTexture(e);}_onTextureLoad(e,t,i){this._assignTexture(e,t,i.resource),t.resource.update();}_onTextureAdd(e,t,i){this._assets.load(i);}_onTextureRemoveOrUnload(e,t,i){let s=t.resource;s&&t.resource[e]===i.resource&&(this._assignPlaceholderTexture(e,t),s.update());}_assignCubemap(e,t,i){if(t.resource[e]=i[0],"cubeMap"===e){let e=i.slice(1);e.every(e=>e)?t.resource.prefilteredCubemaps=e:e[0]&&(t.resource.envAtlas=e[0]);}}_onCubemapLoad(e,t,i){this._assignCubemap(e,t,i.resources),this._parser.initialize(t.resource,t.data);}_onCubemapAdd(e,t,i){this._assets.load(i);}_onCubemapRemoveOrUnload(e,t,i){let s=t.resource;t.data.prefilteredCubeMap128===i.resources[1]&&(this._assignCubemap(e,t,[null,null,null,null,null,null,null]),s.update());}_bindAndAssignAssets(e,t){let i,s,r,a=this._parser.migrate(e.data),n=e.resource,o="path"===a.mappingFormat;for(i=0;i<dq.length;i++){s=dq[i],r=n._assetReferences[s];let l=a[s],h=n[s],c=h===this._getPlaceholderTexture(s),d=a.validated;l&&(!h||!d||c)?(r||(r=new _2(s,e,t,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemoveOrUnload,unload:this._onTextureRemoveOrUnload},this),n._assetReferences[s]=r),o?r.url=e.getAbsoluteUrl(l):r.id=l,r.asset&&(r.asset.resource?this._assignTexture(s,e,r.asset.resource):this._assignPlaceholderTexture(s,e),t.load(r.asset))):r&&(o?r.url=null:r.id=null);}for(i=0;i<d$.length;i++)s=d$[i],r=n._assetReferences[s],a[s]&&!e.data.prefilteredCubeMap128&&(r||(r=new _2(s,e,t,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemoveOrUnload,unload:this._onCubemapRemoveOrUnload},this),n._assetReferences[s]=r),o?r.url=a[s]:r.id=a[s],r.asset&&(r.asset.loaded&&this._assignCubemap(s,e,r.asset.resources),t.load(r.asset)));this._parser.initialize(n,a);}constructor(e){super(e,"material"),this._assets=e.assets,this._device=e.graphicsDevice,this._parser=new yF;}}class yk{parse(e,t,i){SJ.parse("filename.glb","",e,this._device,this._assets,i?.options??{},(e,i)=>{if(e)t(e);else {let e=S6.createModel(i,this._defaultMaterial);i.destroy(),t(null,e);}});}constructor(e){this._device=e.device,this._defaultMaterial=e.defaultMaterial,this._assets=e.assets;}}let yU={points:0,lines:1,lineloop:2,linestrip:3,triangles:4,trianglestrip:5,trianglefan:6},yz={int8:0,uint8:1,int16:2,uint16:3,int32:4,uint32:5,float32:6};class yV{parse(e,t){let i=e.model;if(!i)return void t(null,null);if(i.version<=1)return void t("JsonModelParser#parse: Trying to parse unsupported model format.");let s=this._parseNodes(e),r=this._parseSkins(e,s),a=this._parseVertexBuffers(e),n=this._parseIndexBuffers(e,a),o=this._parseMorphs(e,s,a),l=this._parseMeshes(e,r.skins,o.morphs,a,n.buffer,n.data),h=this._parseMeshInstances(e,s,l,r.skins,r.instances,o.morphs,o.instances),c=new hA;c.graph=s[0],c.meshInstances=h,c.skinInstances=r.instances,c.morphInstances=o.instances,c.getGraph().syncHierarchy(),t(null,c);}_parseNodes(e){let t,i=e.model,s=[];for(t=0;t<i.nodes.length;t++){let e=i.nodes[t],r=new oX(e.name);r.setLocalPosition(e.position[0],e.position[1],e.position[2]),r.setLocalEulerAngles(e.rotation[0],e.rotation[1],e.rotation[2]),r.setLocalScale(e.scale[0],e.scale[1],e.scale[2]),r.scaleCompensation=!!e.scaleCompensation,s.push(r);}for(t=1;t<i.parents.length;t++)s[i.parents[t]].addChild(s[t]);return s}_parseSkins(e,t){let i,s,r=e.model,a=[],n=[];for(i=0;i<r.skins.length;i++){let e=r.skins[i],o=[];for(s=0;s<e.inverseBindMatrices.length;s++){let t=e.inverseBindMatrices[s];o[s]=new ey().set(t);}let l=new dr(this._device,o,e.boneNames);a.push(l);let h=new n4(l),c=[];for(s=0;s<l.boneNames.length;s++){let e=l.boneNames[s],i=t[0].findByName(e);c.push(i);}h.bones=c,n.push(h);}return {skins:a,instances:n}}_getMorphVertexCount(e,t,i){for(let s=0;s<e.meshes.length;s++){let r=e.meshes[s];if(r.morph===t)return i[r.vertices].numVertices}}_parseMorphs(e,t,i){let s,r,a,n,o,l,h=e.model,c=[],d=[];if(h.morphs){let e=function(e,t,i){let s=new Float32Array(3*i);for(let i=0;i<t.length;i++){let r=3*t[i];s[r]=e[3*i],s[r+1]=e[3*i+1],s[r+2]=e[3*i+2];}return s};for(s=0;s<h.morphs.length;s++){for(r=0,n=h.morphs[s].targets,l=[],a=this._getMorphVertexCount(h,s,i);r<n.length;r++){let t=n[r].aabb,i=t.min,s=t.max,h=new eC(new ed((s[0]+i[0])*.5,(s[1]+i[1])*.5,(s[2]+i[2])*.5),new ed((s[0]-i[0])*.5,(s[1]-i[1])*.5,(s[2]-i[2])*.5)),c=n[r].indices,d=n[r].deltaPositions,u=n[r].deltaNormals;c&&(d=e(d,c,a),u=e(u,c,a)),o=new hP({deltaPositions:d,deltaNormals:u,name:n[r].name,aabb:h}),l.push(o);}let t=new hC(l,this._device);c.push(t);let u=new hb(t);d.push(u);}}return {morphs:c,instances:d}}_parseVertexBuffers(e){let t=e.model,i=[],s={position:e6,normal:e9,tangent:e7,blendWeight:te,blendIndices:tt,color:ti,texCoord0:tr,texCoord1:ta,texCoord2:tn,texCoord3:to,texCoord4:tl,texCoord5:th,texCoord6:tc,texCoord7:td};for(let e=0;e<t.vertices.length;e++){let r=t.vertices[e],a=[];for(let e in r){let t=r[e];a.push({semantic:s[e],components:t.components,type:yz[t.type],normalize:s[e]===ti});}let n=new iO(this._device,a),o=r.position.data.length/r.position.components,l=new iP(this._device,n,o),h=new ag(l);for(let e=0;e<o;e++){for(let t in r){let i=r[t];switch(i.components){case 1:h.element[s[t]].set(i.data[e]);break;case 2:h.element[s[t]].set(i.data[2*e],1-i.data[2*e+1]);break;case 3:h.element[s[t]].set(i.data[3*e],i.data[3*e+1],i.data[3*e+2]);break;case 4:h.element[s[t]].set(i.data[4*e],i.data[4*e+1],i.data[4*e+2],i.data[4*e+3]);}}h.next();}h.end(),i.push(l);}return i}_parseIndexBuffers(e,t){let i,s=e.model,r=null,a=null,n=0;for(i=0;i<s.meshes.length;i++){let e=s.meshes[i];void 0!==e.indices&&(n+=e.indices.length);}let o=0;for(i=0;i<t.length;i++)o=Math.max(o,t[i].numVertices);return n>0&&(a=o>65535?new Uint32Array((r=new ae(this._device,2,n)).lock()):new Uint16Array((r=new ae(this._device,1,n)).lock())),{buffer:r,data:a}}_parseMeshes(e,t,i,s,r,a){let n=e.model,o=[],l=0;for(let e=0;e<n.meshes.length;e++){let h=n.meshes[e],c=h.aabb,d=c.min,u=c.max,f=new eC(new ed((u[0]+d[0])*.5,(u[1]+d[1])*.5,(u[2]+d[2])*.5),new ed((u[0]-d[0])*.5,(u[1]-d[1])*.5,(u[2]-d[2])*.5)),p=void 0!==h.indices,m=new n7(this._device);m.vertexBuffer=s[h.vertices],m.indexBuffer[0]=p?r:null,m.primitive[0].type=yU[h.type],m.primitive[0].base=p?h.base+l:h.base,m.primitive[0].count=h.count,m.primitive[0].indexed=p,m.skin=void 0!==h.skin?t[h.skin]:null,m.morph=void 0!==h.morph?i[h.morph]:null,m.aabb=f,p&&(a.set(h.indices,l),l+=h.indices.length),o.push(m);}return null!==r&&r.unlock(),o}_parseMeshInstances(e,t,i,s,r,a,n){let o,l=e.model,h=[];for(o=0;o<l.meshInstances.length;o++){let e=l.meshInstances[o],c=t[e.node],d=i[e.mesh],u=new od(d,this._defaultMaterial,c);d.skin&&(u.skinInstance=r[s.indexOf(d.skin)]),d.morph&&(u.morphInstance=n[a.indexOf(d.morph)]),h.push(u);}return h}constructor(e){this._device=e.device,this._defaultMaterial=e.defaultMaterial;}}class yG extends fC{load(e,t,i){"string"==typeof e&&(e={load:e,original:e});let s={retry:this.maxRetries>0,maxRetries:this.maxRetries};(e.load.startsWith("blob:")||e.load.startsWith("data:"))&&(".glb"===P.getExtension(e.original).toLowerCase()?s.responseType=aq.ResponseType.ARRAY_BUFFER:s.responseType=aq.ResponseType.JSON),a$.get(e.load,s,(s,r)=>{if(t)if(s)t(`Error loading model: ${e.original} [${s}]`);else {for(let s=0;s<this._parsers.length;s++){let a=this._parsers[s];if(a.decider(e.original,r))return void a.parser.parse(r,(e,i)=>{e?t(e):t(null,i);},i)}t("No parsers found");}});}open(e,t){return t}patch(e,t){if(!e.resource)return;let i=e.data,s=this;e.resource.meshInstances.forEach((r,a)=>{if(i.mapping){let n,o=function(e){e.resource?r.material=e.resource:(e.once("load",o),t.load(e)),e.once("remove",e=>{r.material===e.resource&&(r.material=s.defaultMaterial);});};if(!i.mapping[a]){r.material=s.defaultMaterial;return}let l=i.mapping[a].material,h=i.mapping[a].path;if(void 0!==l)l?(n=t.get(l))?o(n):t.once(`add:${l}`,o):r.material=s.defaultMaterial;else if(h){let s=e.getAbsoluteUrl(i.mapping[a].path);(n=t.getByUrl(s))?o(n):t.once(`add:url:${s}`,o);}}});}addParser(e,t){this._parsers.push({parser:e,decider:t});}constructor(e){super(e,"model"),this._parsers=[],this.device=e.graphicsDevice,this.assets=e.assets,this.defaultMaterial=ot(this.device),this.addParser(new yV(this),(e,t)=>".json"===P.getExtension(e)),this.addParser(new yk(this),(e,t)=>".glb"===P.getExtension(e));}}class yH extends fC{load(e,t){yD.load(e,this.maxRetries,t);}open(e,t){this._app.systems.script.preloading=true;let i=new yI(this._app,false).parse(t),s=this._app.scene;return s.root=i,this._app.applySceneSettings(t.settings),this._app.systems.script.preloading=false,s}constructor(e){super(e,"scene");}}class yW{static push(e){yW._types.push(e);}}yW._types=[];let yX=new Set(["system","entity","create","destroy","swap","move","data","scripts","_scripts","_scriptsIndex","_scriptsData","enabled","_oldState","onEnable","onDisable","onPostStateChange","_onSetEnabled","_checkState","_onBeforeRemove","_onInitializeAttributes","_onInitialize","_onPostInitialize","_onUpdate","_onPostUpdate","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent","worker"]);function yY(e,t){if(yX.has(e))throw Error(`Script name '${e}' is reserved, please rename the script`);let i=function(e){X.prototype.initEventHandler.call(this),vf.prototype.initScriptType.call(this,e);};return i.prototype=Object.create(vf.prototype),i.prototype.constructor=i,i.extend=vf.extend,i.attributes=new vo(i),y$(i,e,t),i}let yq={};function y$(e,t,i){if("function"!=typeof e)throw Error(`script class: '${e}' must be a constructor function (i.e. class).`);if(!(e.prototype instanceof vc))throw Error(`script class: '${vf.__getScriptName(e)}' does not extend pc.Script.`);if(t=t||e.__name||vf.__getScriptName(e),yX.has(t))throw Error(`script name: '${t}' is reserved, please change script name`);e.__name=t,(i?i.scripts:fH.getApplication().scripts).add(e),yW.push(e);}vo.reservedNames.forEach((e,t,i)=>{yq[e]=1;}),yY.reservedAttributes=yq;let yj=e=>e[0].toLowerCase()+e.substring(1);class yK extends fC{clearCache(){for(let e in this._cache){let t=this._cache[e],i=t.parentNode;i&&i.removeChild(t);}this._cache={};}load(e,t){"string"==typeof e&&(e={load:e,original:e});let i=this;fs.app=this._app;let s=(e.load,(e,s,r)=>{if(e)t(e);else {let e={};for(let t=0;t<yW._types.length;t++)e[yW._types[t].name]=yW._types[t];yW._types.length=0,t(null,e,r);let a=s.split("&hash=")[0];delete i._loader._cache[fI.makeKey(a,"script")];}}),[r]=e.load.split("?");r.endsWith(".mjs")?this._loadModule(r,s):this._loadScript(e.load,s);}open(e,t){return t}patch(e,t){}_loadScript(e,t){let i=document.head,s=document.createElement("script");this._cache[e]=s,s.async=false,s.addEventListener("error",e=>{t(`Script: ${e.target.src} failed to load`);},false);let r=false;s.onload=s.onreadystatechange=function(){r||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(r=true,t(null,e,s));},s.src=e,i.appendChild(s);}_loadModule(e,t){let i=k.browser&&"null"!==window.location.origin?window.location.origin+window.location.pathname:"undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:T&&"SCRIPT"===T.tagName.toUpperCase()&&T.src||new URL("playcanvas.js",document.baseURI).href,s=new URL(e,i);Function("modulePath","return import(modulePath)")(s.toString()).then(i=>{let r=s.pathname.split("/").pop(),a=this._app.assets.find(r,"script")?.data?.scripts;for(let e in i){let t=i[e];if(t.prototype instanceof vc){let e=yj(t.name);t.scriptName;let i=t.scriptName??e;y$(t,i),a&&this._app.scripts.addSchema(i,a[i]);}}t(null,e,null);}).catch(e=>{t(e);});}constructor(e){super(e,"script"),this._scripts={},this._cache={};}}class yZ extends fC{load(e,t){"string"==typeof e&&(e={load:e,original:e}),a$.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(i,s)=>{i?t(`Error loading shader resource: ${e.original} [${i}]`):t(null,s);});}openBinary(e){return this.decoder??(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)}constructor(e){super(e,"shader"),this.decoder=null;}}function yQ(e){this.resource&&(this.resource.atlas=e.resource);}function yJ(e){this.registry.load(e);}class y0 extends fC{load(e,t){"string"==typeof e&&(e={load:e,original:e}),".json"===P.getExtension(e.original)&&a$.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(e,i)=>{e?t(e):t(null,i);});}open(e,t){let i=new dl(this._device);return e&&(i.__data=t),i}patch(e,t){let i=e.resource;if(i.__data&&(e.data.pixelsPerUnit=i.__data.pixelsPerUnit,e.data.renderMode=i.__data.renderMode,e.data.frameKeys=i.__data.frameKeys,i.__data.textureAtlasAsset)){let s=t.getByUrl(i.__data.textureAtlasAsset);s&&(e.data.textureAtlasAsset=s.id);}i.startUpdate(),i.renderMode=e.data.renderMode,i.pixelsPerUnit=e.data.pixelsPerUnit,i.frameKeys=e.data.frameKeys,this._updateAtlas(e),i.endUpdate(),e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this);}_updateAtlas(e){let t=e.resource;if(!e.data.textureAtlasAsset){t.atlas=null;return}this._assets.off(`load:${e.data.textureAtlasAsset}`,yQ,e),this._assets.on(`load:${e.data.textureAtlasAsset}`,yQ,e);let i=this._assets.get(e.data.textureAtlasAsset);i&&i.resource?t.atlas=i.resource:i?this._assets.load(i):(this._assets.off(`add:${e.data.textureAtlasAsset}`,yJ,e),this._assets.on(`add:${e.data.textureAtlasAsset}`,yJ,e));}_onAssetChange(e,t,i,s){"data"===t&&i&&i.textureAtlasAsset&&s&&i.textureAtlasAsset!==s.textureAtlasAsset&&(this._assets.off(`load:${s.textureAtlasAsset}`,yQ,e),this._assets.off(`add:${s.textureAtlasAsset}`,yJ,e));}constructor(e){super(e,"sprite"),this._assets=e.assets,this._device=e.graphicsDevice;}}class y1{instantiate(){return this._templateRoot||this._parseTemplate(),this._templateRoot.clone()}_parseTemplate(){let e=new yI(this._app,true);this._templateRoot=e.parse(this._data);}set data(e){this._data=e,this._templateRoot=null;}get data(){return this._data}constructor(e,t){this._templateRoot=null,this._app=e,this._data=t;}}class y2 extends fC{load(e,t){"string"==typeof e&&(e={load:e,original:e});let i={retry:this.maxRetries>0,maxRetries:this.maxRetries};a$.get(e.load,i,(i,s)=>{i?t(`Error requesting template: ${e.original}`):t(i,s);});}open(e,t){return new y1(this._app,t)}openBinary(e){return this.decoder??(this.decoder=new TextDecoder("utf-8")),new y1(this._app,JSON.parse(this.decoder.decode(e)))}patch(e,t){e&&e.resource&&e.data&&e.data.entities&&(e.resource.data=e.data);}constructor(e){super(e,"template"),this.decoder=null;}}class y3 extends fC{load(e,t){"string"==typeof e&&(e={load:e,original:e}),a$.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(i,s)=>{i?t(`Error loading text resource: ${e.original} [${i}]`):t(null,s);});}openBinary(e){return this.decoder??(this.decoder=new TextDecoder("utf-8")),this.decoder.decode(e)}constructor(e){super(e,"text"),this.decoder=null;}}let y4={repeat:0,clamp:1,mirror:2},y5={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},y8=/^data\.frames\.(\d+)$/;class y6 extends fC{load(e,t){"string"==typeof e&&(e={load:e,original:e});let i=this,s=this._loader.getHandler("texture");".json"===P.getExtension(e.original)?a$.get(e.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,r)=>{if(s)t(s);else {let s=e.original.replace(".json",".png");i._loader.load(s,"texture",(e,i)=>{e?t(e):t(null,{data:r,texture:i});});}}):s.load(e,t);}open(e,t,i){let s=new dh;if(t.texture&&t.data)s.texture=t.texture,s.__data=t.data;else {let r=this._loader.getHandler("texture").open(e,t,i);if(!r)return null;s.texture=r;}return s}patch(e,t){if(!e.resource)return;e.resource.__data&&(void 0!==e.resource.__data.minfilter&&(e.data.minfilter=e.resource.__data.minfilter),void 0!==e.resource.__data.magfilter&&(e.data.magfilter=e.resource.__data.magfilter),void 0!==e.resource.__data.addressu&&(e.data.addressu=e.resource.__data.addressu),void 0!==e.resource.__data.addressv&&(e.data.addressv=e.resource.__data.addressv),void 0!==e.resource.__data.mipmaps&&(e.data.mipmaps=e.resource.__data.mipmaps),void 0!==e.resource.__data.anisotropy&&(e.data.anisotropy=e.resource.__data.anisotropy),void 0!==e.resource.__data.rgbm&&(e.data.rgbm=!!e.resource.__data.rgbm),e.data.frames=e.resource.__data.frames,delete e.resource.__data);let i=e.resource.texture;if(i&&(i.name=e.name,e.data.hasOwnProperty("minfilter")&&i.minFilter!==y5[e.data.minfilter]&&(i.minFilter=y5[e.data.minfilter]),e.data.hasOwnProperty("magfilter")&&i.magFilter!==y5[e.data.magfilter]&&(i.magFilter=y5[e.data.magfilter]),e.data.hasOwnProperty("addressu")&&i.addressU!==y4[e.data.addressu]&&(i.addressU=y4[e.data.addressu]),e.data.hasOwnProperty("addressv")&&i.addressV!==y4[e.data.addressv]&&(i.addressV=y4[e.data.addressv]),e.data.hasOwnProperty("mipmaps")&&i.mipmaps!==e.data.mipmaps&&(i.mipmaps=e.data.mipmaps),e.data.hasOwnProperty("anisotropy")&&i.anisotropy!==e.data.anisotropy&&(i.anisotropy=e.data.anisotropy),e.data.hasOwnProperty("rgbm"))){let t=e.data.rgbm?tI:tP;i.type!==t&&(i.type=t);}e.resource.texture=i;let s={};for(let t in e.data.frames){let i=e.data.frames[t];s[t]={rect:new ep(i.rect),pivot:new ef(i.pivot),border:new ep(i.border)};}e.resource.frames=s,e.off("change",this._onAssetChange,this),e.on("change",this._onAssetChange,this);}_onAssetChange(e,t,i){let s;if("data"===t||"data.frames"===t){let t={};for(let e in i.frames)s=i.frames[e],t[e]={rect:new ep(s.rect),pivot:new ef(s.pivot),border:new ep(s.border)};e.resource.frames=t;}else {let r=t.match(y8);if(r){let t=r[1];i?(e.resource.frames[t]?((s=e.resource.frames[t]).rect.set(i.rect[0],i.rect[1],i.rect[2],i.rect[3]),s.pivot.set(i.pivot[0],i.pivot[1]),s.border.set(i.border[0],i.border[1],i.border[2],i.border[3])):e.resource.frames[t]={rect:new ep(i.rect),pivot:new ef(i.pivot),border:new ep(i.border)},e.resource.fire("set:frame",t,e.resource.frames[t])):e.resource.frames[t]&&(delete e.resource.frames[t],e.resource.fire("remove:frame",t));}}}constructor(e){super(e,"textureatlas"),this._loader=e.loader;}}function y9(){let e,t,i,s={astc:10,dxt:2,etc1:0,etc2:0,pvr:8,atc:11,none:14},r={astc:10,dxt:3,etc1:16,etc2:1,pvr:9,atc:12,none:16},a=(e,t)=>{switch(e){case 0:return t.formats.etc2?22:21;case 1:return 23;case 2:return 8;case 3:return 10;case 8:return 26;case 9:return 27;case 10:return 28;case 11:return 29;case 12:return 30;case 13:return 7;case 14:return 3;case 16:return 5}},n=e=>{for(let t=0;t<e.length;t+=4){let i=e[t+3],s=e[t+1];e[t+0]=i,e[t+2]=function(e,t){let i=2/255*e-1,s=2/255*t-1;return Math.max(0,Math.min(255,Math.floor((Math.sqrt(1-Math.min(1,i*i+s*s))+1)*127.5)))}(i,s),e[t+3]=255;}return e},o=e=>{let t=new Uint16Array(e.length/4);for(let i=0;i<e.length;i+=4){let s=e[i+0],r=e[i+1],a=e[i+2];t[i/4]=(248&s)<<8|(252&r)<<3|a>>3;}return t},l=()=>"undefined"!=typeof performance?performance.now():0,h=(e,s,r)=>{if(r){if(e.formats.astc)return "astc"}else if(s){if(e.formats.etc2)return "etc2"}else {if(e.formats.etc2)return "etc2";if(e.formats.etc1)return "etc1"}var a=s?i:t;for(let t=0;t<a.length;++t){let i=a[t];if(e.formats[i])return i}return "none"},c=(e,t,i)=>{switch(i){case 0:case 1:case 10:case 11:case 12:return  true;case 2:case 3:return (3&e)==0&&(3&t)==0;case 8:case 9:return (e&e-1)==0&&(t&t-1)==0}return  false},d=(t,i,d)=>{try{let u=d.isKTX2?((t,i,d)=>{let u,f;if(!e.KTX2File)throw Error("Basis transcoder module does not include support for KTX2.");let p=l(),m=new e.KTX2File(new Uint8Array(i)),_=m.getWidth(),g=m.getHeight(),v=m.getLevels(),S=!!m.getHasAlpha(),y=m.isUASTC&&m.isUASTC();if(!_||!g||!v)throw m.close(),m.delete(),Error(`Invalid image dimensions url=${t} width=${_} height=${g} levels=${v}`);let x=h(d.deviceDetails,S,y),T=!!d.isGGGR&&"pvr"===x;if(T?u=13:c(_,g,u=S?r[x]:s[x])||(u=S?13:14),!m.startTranscoding())throw m.close(),m.delete(),Error(`Failed to start transcoding url=${t}`);let E=[];for(let e=0;e<v;++e){let i=new Uint8Array(m.getImageTranscodedSizeInBytes(e,0,0,u));if(!m.transcodeImage(i,e,0,0,u,0,-1,-1))throw m.close(),m.delete(),Error(`Failed to transcode image url=${t}`);let s=14===u||16===u;E.push(s?new Uint16Array(i.buffer):i);}if(m.close(),m.delete(),T)for(f=0,u=14;f<E.length;++f)E[f]=o(n(E[f]));return {format:a(u,d.deviceDetails),width:_,height:g,levels:E,cubemap:!1,transcodeTime:l()-p,url:t,unswizzledGGGR:T}})(t,i,d):((t,i,d)=>{let u,f,p=l(),m=new e.BasisFile(new Uint8Array(i)),_=m.getImageWidth(0,0),g=m.getImageHeight(0,0),v=m.getNumImages(),S=m.getNumLevels(0),y=!!m.getHasAlpha(),x=m.isUASTC&&m.isUASTC();if(!_||!g||!v||!S)throw m.close(),m.delete(),Error(`Invalid image dimensions url=${t} width=${_} height=${g} images=${v} levels=${S}`);let T=h(d.deviceDetails,y,x),E=!!d.isGGGR&&"pvr"===T;if(E?u=13:c(_,g,u=y?r[T]:s[T])||(u=y?13:14),!m.startTranscoding())throw m.close(),m.delete(),Error(`Failed to start transcoding url=${t}`);let w=[];for(let e=0;e<S;++e){let i=m.getImageTranscodedSizeInBytes(0,e,u),s=new Uint8Array(i);if(!m.transcodeImage(s,0,e,u,0,0))if(e===S-1&&i===w[e-1].buffer.byteLength)s.set(new Uint8Array(w[e-1].buffer));else throw m.close(),m.delete(),Error(`Failed to transcode image url=${t}`);let r=14===u||16===u;w.push(r?new Uint16Array(s.buffer):s);}if(m.close(),m.delete(),E)for(f=0,u=14;f<w.length;++f)w[f]=o(n(w[f]));return {format:a(u,d.deviceDetails),width:_,height:g,levels:w,cubemap:!1,transcodeTime:l()-p,url:t,unswizzledGGGR:E}})(t,i,d);u.levels=u.levels.map(e=>e.buffer),self.postMessage({url:t,data:u},u.levels);}catch(e){self.postMessage({url:t,err:e},null);}},u=[];self.onmessage=s=>{let r=s.data;switch(r.type){case "init":var a;a=r.config,self.BASIS(a.module?{instantiateWasm:(e,t)=>(WebAssembly.instantiate(a.module,e).then(e=>{t(e);}).catch(e=>{}),{})}:null).then(s=>{s.initializeBasis(),e=s,t=a.rgbPriority,i=a.rgbaPriority,(()=>{for(let e=0;e<u.length;++e)d(u[e].url,u[e].data,u[e].options);u.length=0;})();});break;case "transcode":e?d(r.url,r.data,r.options):u.push(r);}};}class y7{run(e){let t=[];e.data instanceof ArrayBuffer&&t.push(e.data),this.worker.postMessage({type:"transcode",url:e.url,format:e.format,data:e.data,options:e.options},t),this.eager&&this.queue.enqueueClient(this);}constructor(e,t,i){this.queue=e,this.worker=new Worker(t.workerUrl),this.worker.addEventListener("message",e=>{let t=e.data;this.queue.handleResponse(t.url,t.err,t.data),this.eager||this.queue.enqueueClient(this);}),this.worker.postMessage({type:"init",config:t}),this.eager=i;}}let xe=["etc2","etc1","astc","dxt","pvr","atc"],xt=["astc","dxt","etc2","pvr","atc"],xi=new class{enqueueJob(e,t,i,s){if(this.callbacks.hasOwnProperty(e))this.callbacks[e].push(i);else {this.callbacks[e]=[i];let r={url:e,data:t,options:s};this.clients.length>0?this.clients.shift().run(r):this.queue.push(r);}}enqueueClient(e){this.queue.length>0?e.run(this.queue.shift()):this.clients.push(e);}handleResponse(e,t,i){let s=this.callbacks[e];if(t)for(let e=0;e<s.length;++e)s[e](t);else {3===i.format||5===i.format?i.levels=i.levels.map(e=>new Uint16Array(e)):i.levels=i.levels.map(e=>new Uint8Array(e));for(let e=0;e<s.length;++e)s[e](null,i);}delete this.callbacks[e];}constructor(){this.callbacks={},this.queue=[],this.clients=[];}},xs=null,xr=false;function xa(e){if(!xr){if(e){if(e.lazyInit){xs=e;return}}else e=xs||{};if(!e.glueUrl||!e.wasmUrl||!e.fallbackUrl){let t=$.getConfig("BASIS");t&&(e={glueUrl:t.glueUrl,wasmUrl:t.wasmUrl,fallbackUrl:t.fallbackUrl,numWorkers:t.numWorkers});}if(e.glueUrl||e.wasmUrl||e.fallbackUrl){xr=true;let t=Math.max(1,Math.min(16,e.numWorkers||1)),i=1===e.numWorkers||!e.hasOwnProperty("eagerWorkers")||e.eagerWorkers;e.rgbPriority=e.rgbPriority||xe,e.rgbaPriority=e.rgbaPriority||xt,e.maxRetries=e.hasOwnProperty("maxRetries")?e.maxRetries:5,((e,t)=>{let i=(i,s)=>{t(null,{workerUrl:URL.createObjectURL(new Blob([["/* basis */",i,"",`(${y9.toString()})()

`].join("\n")],{type:"application/javascript"})),module:s,rgbPriority:e.rgbPriority,rgbaPriority:e.rgbaPriority});},s={cache:true,responseType:"text",retry:e.maxRetries>0,maxRetries:e.maxRetries};if(e.glueUrl&&e.wasmUrl&&(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){let e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return  false})()){let r=null,a=null;a$.get(e.glueUrl,s,(e,s)=>{e?t(e):a?i(s,a):r=s;});let n=fetch(e.wasmUrl),o=()=>{n.then(e=>e.arrayBuffer()).then(e=>WebAssembly.compile(e)).then(e=>{r?i(r,e):a=e;}).catch(e=>{t(e,null);});};WebAssembly.compileStreaming?WebAssembly.compileStreaming(n).then(e=>{r?i(r,e):a=e;}).catch(e=>{o();}):o();}else a$.get(e.fallbackUrl,s,(e,s)=>{e?t(e,null):i(s,null);});})(e,(e,s)=>{if(e);else for(let e=0;e<t;++e)xi.enqueueClient(new y7(xi,s,i));});}}}let xn=null;function xo(e,t,i,s,r){return xa(),xn||(xn={formats:{astc:!!e.extCompressedTextureASTC,atc:!!e.extCompressedTextureATC,dxt:!!e.extCompressedTextureS3TC,etc1:!!e.extCompressedTextureETC1,etc2:!!e.extCompressedTextureETC,pvr:!!e.extCompressedTexturePVRTC}}),xi.enqueueJob(t,i,s,{deviceDetails:xn,isGGGR:!!r?.isGGGR,isKTX2:!!r?.isKTX2}),xr}class xl{load(e,t,i){throw Error("not implemented")}open(e,t,i){throw Error("not implemented")}}class xh extends xl{load(e,t,i){let s=this.device;fy.fetchArrayBuffer(e.load,(r,a)=>{if(r)t(r);else xo(s,e.load,a,t,{isGGGR:(i?.file?.variants?.basis?.opt&8)!=0})||t(`Basis module not found. Asset [${i.name}](${i.getFileUrl()}) basis texture variant will not be loaded.`);},i,this.maxRetries);}open(e,t,i,s={}){let r=s.srgb?e3(t.format):t.format,a=new ih(i,{name:e,addressU:+!!t.cubemap,addressV:+!!t.cubemap,width:t.width,height:t.height,format:r,cubemap:t.cubemap,levels:t.levels,...s});return a.upload(),a}constructor(e,t){super(),this.device=t,this.maxRetries=0;}}class xc extends xl{load(e,t,i){let s,r=!!i?.file?.contents;if(r){if(this.device.supportsImageBitmap)return void this._loadImageBitmapFromBlob(new Blob([i.file.contents]),t);e={load:URL.createObjectURL(new Blob([i.file.contents])),original:e.original};}let a=(i,s)=>{r&&URL.revokeObjectURL(e.load),t(i,s);};i&&i.options&&i.options.hasOwnProperty("crossOrigin")?s=i.options.crossOrigin:fm.test(e.load)&&(s=this.crossOrigin),this.device.supportsImageBitmap?this._loadImageBitmap(e.load,e.original,s,a,i):this._loadImage(e.load,e.original,s,a,i);}open(e,t,i,s={}){let r=new ih(i,{name:e,width:t.width,height:t.height,format:s.srgb?20:7,...s});return r.setSource(t),r}_loadImage(e,t,i,s,r){let a,n=new Image;i&&(n.crossOrigin=i);let o=0,l=this.maxRetries;r?.fire("progress",0,1048576),n.onload=function(){r?.fire("progress",1048576,1048576),s(null,n);},n.onerror=function(){if(!a)if(l>0&&++o<=l){let t=100*Math.pow(2,o),i=e.indexOf("?")>=0?"&":"?";a=setTimeout(()=>{n.src=`${e+i}retry=${Date.now()}`,a=null;},t);}else s(`Error loading Texture from: '${t}'`);},n.src=e;}_loadImageBitmap(e,t,i,s,r){let a={cache:true,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries,progress:r};a$.get(e,a,(e,t)=>{e?s(e):this._loadImageBitmapFromBlob(t,s);});}_loadImageBitmapFromBlob(e,t){createImageBitmap(e,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then(e=>t(null,e)).catch(e=>t(e));}constructor(e,t){super(),this.crossOrigin=e.prefix?"anonymous":null,this.maxRetries=0,this.device=t;}}let xd={33776:8,33778:9,33779:10,36196:21,37492:22,37496:23,35840:26,35841:24,35842:27,35843:25,32849:6,32856:7,35905:19,35907:20,35898:18,34843:11,34842:12};class xu extends xl{load(e,t,i){fy.fetchArrayBuffer(e.load,t,i,this.maxRetries);}open(e,t,i,s={}){let r=this.parse(t);if(!r)return null;let a=s.srgb?e3(r.format):r.format,n=new ih(i,{name:e,addressU:+!!r.cubemap,addressV:+!!r.cubemap,width:r.width,height:r.height,format:a,cubemap:r.cubemap,levels:r.levels,...s});return n.upload(),n}parse(e){let t=new Uint32Array(e);if(0x58544bab!==t[0]||0xbb313120!==t[1]||0xa1a0a0d!==t[2])return null;let i={endianness:t[3],glType:t[4],glTypeSize:t[5],glFormat:t[6],glInternalFormat:t[7],glBaseInternalFormat:t[8],pixelWidth:t[9],pixelHeight:t[10],pixelDepth:t[11],numberOfArrayElements:t[12],numberOfFaces:t[13],numberOfMipmapLevels:t[14],bytesOfKeyValueData:t[15]};if(i.pixelDepth>1||0!==i.numberOfArrayElements)return null;let s=xd[i.glInternalFormat];if(void 0===s)return null;let r=16+i.bytesOfKeyValueData/4,a=i.numberOfFaces>1,n=[];for(let l=0;l<(i.numberOfMipmapLevels||1);l++){let i=t[r++];a&&n.push([]);let h=a?n[l]:n;for(let t=0;t<(a?6:1);++t){var o;h.push((o=4*r,18===s?new Uint32Array(e,o,i/4):new Uint8Array(e,o,i))),r+=i+3>>2;}}return {format:s,width:i.pixelWidth,height:i.pixelHeight,levels:n,cubemap:a}}constructor(e){super(),this.maxRetries=0;}}class xf extends xl{load(e,t,i){fy.fetchArrayBuffer(e.load,(s,r)=>{s?t(s,r):this.parse(r,e,t,i);},i,this.maxRetries);}open(e,t,i,s={}){let r=s.srgb?e3(t.format):t.format,a=new ih(i,{name:e,addressU:+!!t.cubemap,addressV:+!!t.cubemap,width:t.width,height:t.height,format:r,cubemap:t.cubemap,levels:t.levels,...s});return a.upload(),a}parse(e,t,i,s){let r=new j(e),a=[r.readU32be(),r.readU32be(),r.readU32be()];if(0xab4b5458!==a[0]||0x203230bb!==a[1]||0xd0a1a0a!==a[2])return null;let n={vkFormat:r.readU32(),typeSize:r.readU32(),pixelWidth:r.readU32(),pixelHeight:r.readU32(),pixelDepth:r.readU32(),layerCount:r.readU32(),faceCount:r.readU32(),levelCount:r.readU32(),supercompressionScheme:r.readU32()},o={dfdByteOffset:r.readU32(),dfdByteLength:r.readU32(),kvdByteOffset:r.readU32(),kvdByteLength:r.readU32(),sgdByteOffset:r.readU64(),sgdByteLength:r.readU64()},l=[];for(let e=0;e<Math.max(1,n.levelCount);++e)l.push({byteOffset:r.readU64(),byteLength:r.readU64(),uncompressedByteLength:r.readU64()});if(r.readU32()!==o.kvdByteOffset-o.dfdByteOffset)return null;r.skip(8);let h=r.readU8();r.skip(o.dfdByteLength-9),r.skip(o.kvdByteLength),1===n.supercompressionScheme||166===h?xo(this.device,t.load,e,i,{isGGGR:(s?.file?.variants?.basis?.opt&8)!=0,isKTX2:true})||i(`Basis module not found. Asset [${s.name}](${s.getFileUrl()}) basis texture variant will not be loaded.`):i("unsupported KTX2 pixel format");}constructor(e,t){super(),this.maxRetries=0,this.device=t;}}class xp extends xl{load(e,t,i){fy.fetchArrayBuffer(e.load,t,i,this.maxRetries);}open(e,t,i,s={}){let r,a,n=new Uint32Array(t,0,32),o=n[4],l=n[3],h=Math.max(n[7],1),c=4===n[20],d=n[21],u=n[22],f=65024===n[28],p=false,m=false,_=false,g=false,v=null,S=1;if(c?0x31545844===d?(v=8,p=true):0x35545844===d?(v=10,p=true):113===d?(v=12,S=2):116===d?(v=14,S=4):0x31435445===d?(v=21,p=true,m=true):0x31333250===d||0x31343250===d?(v=0x31333250===d?24:25,p=true,_=true):(0x31333450===d||0x31343450===d)&&(v=0x31333450===d?26:27,p=true,g=true):32===u&&(v=7),!v)return new ih(i,{width:4,height:4,format:6,name:"dds-legacy-empty"});r=new ih(i,{name:e,addressU:+!!f,addressV:+!!f,width:o,height:l,format:v,cubemap:f,mipmaps:h>1,...s});let y=128,x=f?6:1,T=0x31545844===d?8:16;for(let e=0;e<x;e++){let i=o,s=l;for(let n=0;n<h;n++){a=p?m?Math.floor((i+3)/4)*Math.floor((s+3)/4)*8:_?Math.max(i,16)*Math.max(s,8)/4:g?Math.max(i,8)*Math.max(s,8)/2:Math.floor((i+4-1)/4)*Math.floor((s+4-1)/4)*T:i*s*4;let o=14===v?new Float32Array(t,y,a):12===v?new Uint16Array(t,y,a):new Uint8Array(t,y,a);f?(r._levels[n]||(r._levels[n]=[]),r._levels[n][e]=o):r._levels[n]=o,y+=a*S,i=Math.max(.5*i,1),s=Math.max(.5*s,1);}}return r.upload(),r}constructor(e){super(),this.maxRetries=0;}}class xm extends xl{load(e,t,i){fy.fetchArrayBuffer(e.load,t,i,this.maxRetries),i.data&&!i.data.type&&(i.data.type=tD);}open(e,t,i,s={}){let r=this.parse(t);if(!r)return null;let a=new ih(i,{name:e,addressU:0,addressV:1,minFilter:0,magFilter:0,width:r.width,height:r.height,levels:r.levels,format:7,type:tD,mipmaps:false,...s});return a.upload(),a}parse(e){let t=new j(e);if(!t.readLine().startsWith("#?RADIANCE"))return null;let i={};for(;;){let e=t.readLine();if(0===e.length)break;{let t=e.split("=");2===t.length&&(i[t[0]]=t[1]);}}if(!i.hasOwnProperty("FORMAT"))return null;let s=t.readLine().split(" ");if(4!==s.length)return null;let r=parseInt(s[1],10),a=parseInt(s[3],10),n=this._readPixels(t,a,r,"-Y"===s[0]);return n?{width:a,height:r,levels:[n]}:null}_readPixels(e,t,i,s){let r,a,n,o,l,h;if(t<8||t>32767)return this._readPixelsFlat(e,t,i);let c=[0,0,0,0];if(e.readArray(c),2!==c[0]||2!==c[1]||(128&c[2])!=0)return e.skip(-4),this._readPixelsFlat(e,t,i);let d=new Uint8Array(new ArrayBuffer(t*i*4)),u=s?0:4*t*(i-1);for(a=0;a<i;++a){if(a&&e.readArray(c),(c[2]<<8)+c[3]!==t)return null;for(o=0;o<4;++o)for(r=0;r<t;)if((l=e.readU8())>128){if(r+(l-=128)>t)return null;for(n=0,h=e.readU8();n<l;++n)d[u+o+4*r++]=h;}else {if(0===l||r+l>t)return null;for(n=0;n<l;++n)d[u+o+4*r++]=e.readU8();}u+=4*t*(s?1:-1);}return d}_readPixelsFlat(e,t,i){return e.remainingBytes===t*i*4?new Uint8Array(e.arraybuffer,e.offset):null}constructor(e){super(),this.maxRetries=0;}}let x_={repeat:0,clamp:1,mirror:2},xg={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},xv={default:tP,rgbm:tI,rgbe:tD,rgbp:tR,swizzleGGGR:tL},xS=function(e){var t;let i=is.calcMipLevelsCount(e._width,e._height);if(7!==e._format&&14!==e._format||e._volume||e._compressed||1===e._levels.length||e._levels.length===i||(t=e._cubemap?e._levels[0][0]:e._levels[0])instanceof HTMLCanvasElement||t instanceof HTMLImageElement||t instanceof HTMLVideoElement)return;let s=function(e,t,i){let s=Math.max(1,e>>1),r=Math.max(1,t>>1),a=new i.constructor(s*r*4),n=Math.floor(e/s),o=Math.floor(t/r),l=n*o;for(let t=0;t<r;++t)for(let r=0;r<s;++r)for(let h=0;h<4;++h){let c=0;for(let s=0;s<o;++s)for(let a=0;a<n;++a)c+=i[(r*n+a+(t*o+s)*e)*4+h];a[(r+t*s)*4+h]=c/l;}return a};for(let t=e._levels.length;t<i;++t){let i=Math.max(1,e._width>>t-1),r=Math.max(1,e._height>>t-1);if(e._cubemap){let a=[];for(let n=0;n<6;++n)a.push(s(i,r,e._levels[t-1][n]));e._levels.push(a);}else e._levels.push(s(i,r,e._levels[t-1]));}e._levelsUpdated=e._cubemap?[[true,true,true,true,true,true]]:[true];};class xy extends fC{set crossOrigin(e){this.imgParser.crossOrigin=e;}get crossOrigin(){return this.imgParser.crossOrigin}set maxRetries(e){for(let t in this.imgParser.maxRetries=e,this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e);}get maxRetries(){return this.imgParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){let t=P.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".","");return this.parsers[t]||this.imgParser}_getTextureOptions(e){let t={};if(e){e.name?.length>0&&(t.name=e.name);let i=e.data;i.hasOwnProperty("minfilter")&&(t.minFilter=xg[i.minfilter]),i.hasOwnProperty("magfilter")&&(t.magFilter=xg[i.magfilter]),i.hasOwnProperty("addressu")&&(t.addressU=x_[i.addressu]),i.hasOwnProperty("addressv")&&(t.addressV=x_[i.addressv]),i.hasOwnProperty("mipmaps")&&(t.mipmaps=i.mipmaps),i.hasOwnProperty("anisotropy")&&(t.anisotropy=i.anisotropy),i.hasOwnProperty("flipY")&&(t.flipY=!!i.flipY),i.hasOwnProperty("srgb")&&(t.srgb=!!i.srgb),t.type=tP,i.hasOwnProperty("type")?t.type=xv[i.type]:i.hasOwnProperty("rgbm")&&i.rgbm?t.type=tI:e.file&&(8&e.file.opt)!=0&&(t.type=tL);}return t}load(e,t,i){"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,i);}open(e,t,i){if(!e)return;let s=this._getTextureOptions(i),r=this._getParser(e).open(e,t,this._device,s);return null===r?r=new ih(this._device,{width:4,height:4,format:6}):(xS(r),t.unswizzledGGGR&&(i.file.variants.basis.opt&=-9)),r}patch(e,t){let i=e.resource;if(!i)return;let s=this._getTextureOptions(e);for(let e of Object.keys(s))i[e]=s[e];}constructor(e){super(e,"texture");let t=e.assets,i=e.graphicsDevice;this._device=i,this._assets=t,this.imgParser=new xc(t,i),this.parsers={dds:new xp(t),ktx:new xu(t),ktx2:new xf(t,i),basis:new xh(t,i),hdr:new xm(t)};}}let xx="inline",xT="immersive-vr",xE="immersive-ar",xw="viewer",xb="left",xA="cpu-optimized",xC="gpu-optimized",xP="luminance-alpha",xI="unsigned-short",xD="float32";class xR{get supported(){return this._supported}get available(){return this._supported&&this._manager.active&&null!==this._manager._session.domOverlayState}get state(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState?this._manager._session.domOverlayState.type:null}set root(e){this._supported&&!this._manager.active&&(this._root=e);}get root(){return this._root}constructor(e){this._supported=k.browser&&!!window.XRDOMOverlayState,this._root=null,this._manager=e;}}let xL=[],xM=[];class xO extends X{remove(){if(!this._xrHitTestSource)return;let e=this.manager.hitTest.sources,t=e.indexOf(this);-1!==t&&e.splice(t,1),this.onStop();}onStop(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this);}update(e){if(this._transient){let t=e.getHitTestResultsForTransientInput(this._xrHitTestSource);for(let e=0;e<t.length;e++){let i,s=t[e];s.results.length&&(s.inputSource&&(i=this.manager.input._getByInputSource(s.inputSource)),this.updateHitResults(s.results,i));}}else {let t=e.getHitTestResults(this._xrHitTestSource);if(!t.length)return;this.updateHitResults(t);}}updateHitResults(e,t){if(this._inputSource&&this._inputSource!==t)return;let i=xL.pop()??new ed;t?i.copy(t.getOrigin()):i.copy(this.manager.camera.getPosition());let s=1/0,r=null,a=xL.pop()??new ed,n=xM.pop()??new ex;for(let t=0;t<e.length;t++){let o=e[t].getPose(this.manager._referenceSpace),l=i.distance(o.transform.position);l>=s||(s=l,r=e[t],a.copy(o.transform.position),n.copy(o.transform.orientation));}this.fire("result",a,n,t||this._inputSource,r),this.manager.hitTest.fire("result",this,a,n,t||this._inputSource,r),xL.push(i),xL.push(a),xM.push(n);}constructor(e,t,i,s=null){super(),this.manager=e,this._xrHitTestSource=t,this._transient=i,this._inputSource=s;}}xO.EVENT_REMOVE="remove",xO.EVENT_RESULT="result";class xF extends X{_onSessionStart(){if(this.manager.session.enabledFeatures){let e=-1!==this.manager.session.enabledFeatures.indexOf("hit-test");e&&(this._available=e,this.fire("available"));}else this._checkingAvailability||(this._checkingAvailability=true,this.manager.session.requestReferenceSpace(xw).then(e=>{this.manager.session.requestHitTestSource({space:e}).then(e=>{e.cancel(),this.manager.active&&(this._available=true,this.fire("available"));}).catch(()=>{});}).catch(()=>{}));}_onSessionEnd(){if(this._available){this._available=false;for(let e=0;e<this.sources.length;e++)this.sources[e].onStop();this.sources=[],this.fire("unavailable");}}start(e={}){let t;if(!this._supported)return void e.callback?.(Error("XR HitTest is not supported"),null);if(!this._available)return void e.callback?.(Error("XR HitTest is not available"),null);e.profile||e.spaceType||(e.spaceType=xw);let i=e.offsetRay;i&&(t=new XRRay(new DOMPoint(i.origin.x,i.origin.y,i.origin.z,1),new DOMPoint(i.direction.x,i.direction.y,i.direction.z,0)));let s=e.callback;e.spaceType?this.manager.session.requestReferenceSpace(e.spaceType).then(i=>{if(!this.manager.session){let e=Error("XR Session is not started (2)");s&&s(e),this.fire("error",e);return}this.manager.session.requestHitTestSource({space:i,entityTypes:e.entityTypes||void 0,offsetRay:t}).then(t=>{this._onHitTestSource(t,false,e.inputSource,s);}).catch(e=>{s&&s(e),this.fire("error",e);});}).catch(e=>{s&&s(e),this.fire("error",e);}):this.manager.session.requestHitTestSourceForTransientInput({profile:e.profile,entityTypes:e.entityTypes||void 0,offsetRay:t}).then(t=>{this._onHitTestSource(t,true,e.inputSource,s);}).catch(e=>{s&&s(e),this.fire("error",e);});}_onHitTestSource(e,t,i,s){if(!this.manager.session){e.cancel();let t=Error("XR Session is not started (3)");s&&s(t),this.fire("error",t);return}let r=new xO(this.manager,e,t,i??null);this.sources.push(r),s&&s(null,r),this.fire("add",r);}update(e){if(this._available)for(let t=0;t<this.sources.length;t++)this.sources[t].update(e);}get supported(){return this._supported}get available(){return this._available}constructor(e){super(),this._supported=k.browser&&!!(window.XRSession&&window.XRSession.prototype.requestHitTestSource),this._available=false,this._checkingAvailability=false,this.sources=[],this.manager=e,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this));}}xF.EVENT_AVAILABLE="available",xF.EVENT_UNAVAILABLE="unavailable",xF.EVENT_ADD="add",xF.EVENT_REMOVE="remove",xF.EVENT_RESULT="result",xF.EVENT_ERROR="error";class xN extends X{get image(){return this._image}set width(e){this._width=e;}get width(){return this._width}get trackable(){return this._trackable}get tracking(){return this._tracking}get emulated(){return this._emulated}prepare(){return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then(e=>(this._bitmap=e,{image:this._bitmap,widthInMeters:this._width}))}destroy(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null);}getPosition(){return this._pose&&this._position.copy(this._pose.transform.position),this._position}getRotation(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation}constructor(e,t){super(),this._bitmap=null,this._measuredWidth=0,this._trackable=false,this._tracking=false,this._emulated=false,this._pose=null,this._position=new ed,this._rotation=new ex,this._image=e,this._width=t;}}xN.EVENT_TRACKED="tracked",xN.EVENT_UNTRACKED="untracked";class xB extends X{add(e,t){if(!this._supported||this._manager.active)return null;let i=new xN(e,t);return this._images.push(i),i}remove(e){if(this._manager.active)return;let t=this._images.indexOf(e);-1!==t&&(e.destroy(),this._images.splice(t,1));}_onSessionStart(){this._manager.session.getTrackedImageScores().then(e=>{this._available=true;for(let t=0;t<e.length;t++)this._images[t]._trackable="trackable"===e[t];}).catch(e=>{this._available=false,this.fire("error",e);});}_onSessionEnd(){this._available=false;for(let e=0;e<this._images.length;e++){let t=this._images[e];t._pose=null,t._measuredWidth=0,t._tracking&&(t._tracking=false,t.fire("untracked"));}}prepareImages(e){this._images.length?Promise.all(this._images.map(e=>e.prepare())).then(t=>{e(null,t);}).catch(t=>{e(t,null);}):e(null,null);}update(e){if(!this._available)return;let t=e.getImageTrackingResults(),i={};for(let s=0;s<t.length;s++){i[t[s].index]=t[s];let r=this._images[t[s].index];r._emulated="emulated"===t[s].trackingState,r._measuredWidth=t[s].measuredWidthInMeters,r._pose=e.getPose(t[s].imageSpace,this._manager._referenceSpace);}for(let e=0;e<this._images.length;e++)this._images[e]._tracking&&!i[e]?(this._images[e]._tracking=false,this._images[e].fire("untracked")):!this._images[e]._tracking&&i[e]&&(this._images[e]._tracking=true,this._images[e].fire("tracked"));}get supported(){return this._supported}get available(){return this._available}get images(){return this._images}constructor(e){super(),this._supported=k.browser&&!!window.XRImageTrackingResult,this._available=false,this._images=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this));}}xB.EVENT_ERROR="error";class xk{get index(){return this._index}get hand(){return this._hand}get joints(){return this._joints}get tip(){return this._tip}constructor(e,t){this._joints=[],this._tip=null,this._index=e,this._hand=t,this._hand._fingers.push(this);}}let xU=k.browser&&window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],xz={};for(let e=0;e<xU.length;e++)xz[xU[e]]=true;class xV{update(e){this._dirtyLocal=true,this._radius=e.radius,this._localPosition.copy(e.transform.position),this._localRotation.copy(e.transform.orientation);}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=false,this._localTransform.setTRS(this._localPosition,this._localRotation,ed.ONE));let e=this._hand._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform);}getPosition(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position}getRotation(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation}get id(){return this._id}get index(){return this._index}get hand(){return this._hand}get finger(){return this._finger}get wrist(){return this._wrist}get tip(){return this._tip}get radius(){return this._radius||.005}constructor(e,t,i,s=null){this._radius=null,this._localTransform=new ey,this._worldTransform=new ey,this._localPosition=new ed,this._localRotation=new ex,this._position=new ed,this._rotation=new ex,this._dirtyLocal=true,this._index=e,this._id=t,this._hand=i,this._finger=s,this._wrist="wrist"===t,this._tip=this._finger&&!!xz[t];}}let xG=[],xH=new ed,xW=new ed,xX=new ed;k.browser&&window.XRHand&&(xG=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);class xY extends X{update(e){let t=this._inputSource._xrInputSource;for(let i=0;i<this._joints.length;i++){let s=this._joints[i],r=t.hand.get(s._id);if(r){let t;if("hidden"!==e.session.visibilityState&&(t=e.getJointPose(r,this._manager._referenceSpace)),t)s.update(t),s.wrist&&!this._tracking&&(this._tracking=true,this.fire("tracking"));else if(s.wrist){this._tracking&&(this._tracking=false,this.fire("trackinglost"));break}}}let i=this._jointsById["thumb-metacarpal"],s=this._jointsById["thumb-tip"],r=this._jointsById["index-finger-phalanx-proximal"],a=this._jointsById["index-finger-tip"],n=this._jointsById["ring-finger-phalanx-proximal"],o=this._jointsById["pinky-finger-phalanx-proximal"];if(i&&s&&r&&a&&n&&o){this._inputSource._dirtyRay=true,this._inputSource._rayLocal.origin.lerp(s._localPosition,a._localPosition,.5);let e=i,t=o;if(this._inputSource.handedness===xb){let i=e;e=t,t=i;}xH.sub2(e._localPosition,this._wrist._localPosition),xW.sub2(t._localPosition,this._wrist._localPosition),xX.cross(xH,xW).normalize(),xH.lerp(r._localPosition,n._localPosition,.5),xH.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(xX,xH,.5).normalize();}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=true,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=false,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource));}_fingerIsClosed(e){let t=this._fingers[e];return xH.sub2(t.joints[0]._localPosition,t.joints[1]._localPosition).normalize(),xW.sub2(t.joints[2]._localPosition,t.joints[3]._localPosition).normalize(),-0.8>xH.dot(xW)}getJointById(e){return this._jointsById[e]||null}get fingers(){return this._fingers}get joints(){return this._joints}get tips(){return this._tips}get wrist(){return this._wrist}get tracking(){return this._tracking}constructor(e){super(),this._tracking=false,this._fingers=[],this._joints=[],this._jointsById={},this._tips=[],this._wrist=null;let t=e._xrInputSource.hand;if(this._manager=e._manager,this._inputSource=e,t.get("wrist")){let e=new xV(0,"wrist",this,null);this._wrist=e,this._joints.push(e),this._jointsById.wrist=e;}for(let e=0;e<xG.length;e++){let i=new xk(e,this);for(let s=0;s<xG[e].length;s++){let r=xG[e][s];if(!t.get(r))continue;let a=new xV(s,r,this,i);this._joints.push(a),this._jointsById[r]=a,a.tip&&(this._tips.push(a),i._tip=a),i._joints.push(a);}}}}xY.EVENT_TRACKING="tracking",xY.EVENT_TRACKINGLOST="trackinglost";let xq=new ed,x$=new ex,xj=0;class xK extends X{get id(){return this._id}get inputSource(){return this._xrInputSource}get targetRayMode(){return this._xrInputSource.targetRayMode}get handedness(){return this._xrInputSource.handedness}get profiles(){return this._xrInputSource.profiles}get grip(){return this._grip}get hand(){return this._hand}get gamepad(){return this._xrInputSource.gamepad||null}get selecting(){return this._selecting}get squeezing(){return this._squeezing}set elementInput(e){this._elementInput!==e&&(this._elementInput=e,this._elementInput||(this._elementEntity=null));}get elementInput(){return this._elementInput}get elementEntity(){return this._elementEntity}get hitTestSources(){return this._hitTestSources}update(e){if(this._hand)this._hand.update(e);else {let t=this._xrInputSource.gripSpace;if(t){let i=e.getPose(t,this._manager._referenceSpace);if(i){this._grip||(this._grip=true,this._localTransform=new ey,this._worldTransform=new ey,this._localPositionLast=new ed,this._localPosition=new ed,this._localRotation=new ex,this._linearVelocity=new ed);let e=Q(),t=(e-this._velocitiesTimestamp)/1e3;this._velocitiesTimestamp=e,this._dirtyLocal=true,this._localPositionLast.copy(this._localPosition),this._localPosition.copy(i.transform.position),this._localRotation.copy(i.transform.orientation),this._velocitiesAvailable=true,this._manager.input.velocitiesSupported&&i.linearVelocity?this._linearVelocity.copy(i.linearVelocity):t>0&&(xq.sub2(this._localPosition,this._localPositionLast).divScalar(t),this._linearVelocity.lerp(this._linearVelocity,xq,.15));}else this._velocitiesAvailable=false;}let i=e.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);i&&(this._dirtyRay=true,this._rayLocal.origin.copy(i.transform.position),this._rayLocal.direction.set(0,0,-1),x$.copy(i.transform.orientation),x$.transformVector(this._rayLocal.direction,this._rayLocal.direction));}}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=false,this._localTransform.setTRS(this._localPosition,this._localRotation,ed.ONE));let e=this._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform);}_updateRayTransforms(){let e=this._dirtyRay;this._dirtyRay=false;let t=this._manager.camera.parent;if(t){let e=t.getWorldTransform();e.getTranslation(this._position),this._rotation.setFromMat4(e),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction);}else e&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction));}getPosition(){return this._grip?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null}getLocalPosition(){return this._localPosition}getRotation(){return this._grip?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null}getLocalRotation(){return this._localRotation}getLinearVelocity(){return this._velocitiesAvailable?this._linearVelocity:null}getOrigin(){return this._updateRayTransforms(),this._ray.origin}getDirection(){return this._updateRayTransforms(),this._ray.direction}hitTestStart(e={}){e.inputSource=this,e.profile=this._xrInputSource.profiles[0];let t=e.callback;e.callback=(e,i)=>{i&&this.onHitTestSourceAdd(i),t&&t(e,i);},this._manager.hitTest.start(e);}onHitTestSourceAdd(e){this._hitTestSources.push(e),this.fire("hittest:add",e),e.on("result",(t,i,s,r)=>{s===this&&this.fire("hittest:result",e,t,i,r);}),e.once("remove",()=>{this.onHitTestSourceRemove(e),this.fire("hittest:remove",e);});}onHitTestSourceRemove(e){let t=this._hitTestSources.indexOf(e);-1!==t&&this._hitTestSources.splice(t,1);}constructor(e,t){super(),this._ray=new eM,this._rayLocal=new eM,this._grip=false,this._hand=null,this._velocitiesAvailable=false,this._velocitiesTimestamp=Q(),this._localTransform=null,this._worldTransform=null,this._position=new ed,this._rotation=new ex,this._localPosition=null,this._localPositionLast=null,this._localRotation=null,this._linearVelocity=null,this._dirtyLocal=true,this._dirtyRay=false,this._selecting=false,this._squeezing=false,this._elementInput=true,this._elementEntity=null,this._hitTestSources=[],this._id=++xj,this._manager=e,this._xrInputSource=t,t.hand&&(this._hand=new xY(this));}}xK.EVENT_REMOVE="remove",xK.EVENT_SELECT="select",xK.EVENT_SELECTSTART="selectstart",xK.EVENT_SELECTEND="selectend",xK.EVENT_SQUEEZE="squeeze",xK.EVENT_SQUEEZESTART="squeezestart",xK.EVENT_SQUEEZEEND="squeezeend",xK.EVENT_HITTESTADD="hittest:add",xK.EVENT_HITTESTREMOVE="hittest:remove",xK.EVENT_HITTESTRESULT="hittest:result";class xZ extends X{_onSessionStart(){let e=this.manager.session;e.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),e.addEventListener("select",e=>{let t=this._getByInputSource(e.inputSource);t.update(e.frame),t.fire("select",e),this.fire("select",t,e);}),e.addEventListener("selectstart",e=>{let t=this._getByInputSource(e.inputSource);t.update(e.frame),t._selecting=true,t.fire("selectstart",e),this.fire("selectstart",t,e);}),e.addEventListener("selectend",e=>{let t=this._getByInputSource(e.inputSource);t.update(e.frame),t._selecting=false,t.fire("selectend",e),this.fire("selectend",t,e);}),e.addEventListener("squeeze",e=>{let t=this._getByInputSource(e.inputSource);t.update(e.frame),t.fire("squeeze",e),this.fire("squeeze",t,e);}),e.addEventListener("squeezestart",e=>{let t=this._getByInputSource(e.inputSource);t.update(e.frame),t._squeezing=true,t.fire("squeezestart",e),this.fire("squeezestart",t,e);}),e.addEventListener("squeezeend",e=>{let t=this._getByInputSource(e.inputSource);t.update(e.frame),t._squeezing=false,t.fire("squeezeend",e),this.fire("squeezeend",t,e);});let t=e.inputSources;for(let e=0;e<t.length;e++)this._addInputSource(t[e]);}_onSessionEnd(){let e=this._inputSources.length;for(;e--;){let t=this._inputSources[e];this._inputSources.splice(e,1),t.fire("remove"),this.fire("remove",t);}this.manager.session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt);}_onInputSourcesChange(e){for(let t=0;t<e.removed.length;t++)this._removeInputSource(e.removed[t]);for(let t=0;t<e.added.length;t++)this._addInputSource(e.added[t]);}_getByInputSource(e){for(let t=0;t<this._inputSources.length;t++)if(this._inputSources[t].inputSource===e)return this._inputSources[t];return null}_addInputSource(e){if(this._getByInputSource(e))return;let t=new xK(this.manager,e);this._inputSources.push(t),this.fire("add",t);}_removeInputSource(e){for(let t=0;t<this._inputSources.length;t++){if(this._inputSources[t].inputSource!==e)continue;let i=this._inputSources[t];this._inputSources.splice(t,1);let s=i.hitTestSources.length;for(;s--;)i.hitTestSources[s].remove();i.fire("remove"),this.fire("remove",i);return}}update(e){for(let t=0;t<this._inputSources.length;t++)this._inputSources[t].update(e);}get inputSources(){return this._inputSources}constructor(e){super(),this._inputSources=[],this.velocitiesSupported=false,this.manager=e,this.velocitiesSupported=!!(k.browser&&window.XRPose?.prototype?.hasOwnProperty("linearVelocity")),this._onInputSourcesChangeEvt=e=>{this._onInputSourcesChange(e);},this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this);}}xZ.EVENT_ADD="add",xZ.EVENT_REMOVE="remove",xZ.EVENT_SELECT="select",xZ.EVENT_SELECTSTART="selectstart",xZ.EVENT_SELECTEND="selectend",xZ.EVENT_SQUEEZE="squeeze",xZ.EVENT_SQUEEZESTART="squeezestart",xZ.EVENT_SQUEEZEEND="squeezeend";let xQ=new ed,xJ=new ed,x0=new ey,x1=new ey;class x2 extends X{_onSessionStart(){this._manager.session.requestLightProbe&&(this._supported=true);}_onSessionEnd(){this._supported=false,this._available=false,this._lightProbeRequested=false,this._lightProbe=null;}start(){let e;(this._manager.session||(e=Error("XR session is not running")),e||this._manager.type===xE||(e=Error("XR session type is not AR")),e||this._supported||(e=Error("light-estimation is not supported")),(!e&&this._lightProbe||this._lightProbeRequested)&&(e=Error("light estimation is already requested")),e)?this.fire("error",e):(this._lightProbeRequested=true,this._manager.session.requestLightProbe().then(e=>{let t=this._lightProbeRequested;this._lightProbeRequested=false,this._manager.active?t&&(this._lightProbe=e):this.fire("error",Error("XR session is not active"));}).catch(e=>{this._lightProbeRequested=false,this.fire("error",e);}));}end(){this._lightProbeRequested=false,this._lightProbe=null,this._available=false;}update(e){if(!this._lightProbe)return;let t=e.getLightEstimate(this._lightProbe);if(!t)return;this._available||(this._available=true,this.fire("available"));let i=t.primaryLightIntensity;this._intensity=Math.max(1,Math.max(i.x,Math.max(i.y,i.z))),xQ.copy(i).mulScalar(1/this._intensity),this._color.set(xQ.x,xQ.y,xQ.z),xQ.set(0,0,0),xJ.copy(t.primaryLightDirection),x0.setLookAt(xJ,xQ,ed.UP),x1.setFromAxisAngle(ed.RIGHT,90),x0.mul(x1),this._rotation.setFromMat4(x0),this._sphericalHarmonics.set(t.sphericalHarmonicsCoefficients);}get supported(){return this._supported}get available(){return this._available}get intensity(){return this._available?this._intensity:null}get color(){return this._available?this._color:null}get rotation(){return this._available?this._rotation:null}get sphericalHarmonics(){return this._available?this._sphericalHarmonics:null}constructor(e){super(),this._supported=false,this._available=false,this._lightProbeRequested=false,this._lightProbe=null,this._intensity=0,this._rotation=new ex,this._color=new es,this._sphericalHarmonics=new Float32Array(27),this._manager=e,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this);}}x2.EVENT_AVAILABLE="available",x2.EVENT_ERROR="error";let x3=0;class x4 extends X{destroy(){this._xrPlane&&(this._xrPlane=null,this.fire("remove"));}update(e){let t=this._planeDetection._manager,i=e.getPose(this._xrPlane.planeSpace,t._referenceSpace);i&&(this._position.copy(i.transform.position),this._rotation.copy(i.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"));}getPosition(){return this._position}getRotation(){return this._rotation}get id(){return this._id}get orientation(){return this._orientation}get points(){return this._xrPlane.polygon}get label(){return this._xrPlane.semanticLabel||""}constructor(e,t){super(),this._position=new ed,this._rotation=new ex,this._id=++x3,this._planeDetection=e,this._xrPlane=t,this._lastChangedTime=t.lastChangedTime,this._orientation=t.orientation;}}x4.EVENT_REMOVE="remove",x4.EVENT_CHANGE="change";class x5 extends X{_onSessionStart(){this._manager.session.enabledFeatures&&-1!==this._manager.session.enabledFeatures.indexOf("plane-detection")&&(this._available=true,this.fire("available"));}_onSessionEnd(){for(let e=0;e<this._planes.length;e++)this._planes[e].destroy(),this.fire("remove",this._planes[e]);this._planesIndex.clear(),this._planes.length=0,this._available&&(this._available=false,this.fire("unavailable"));}update(e){if(!this._available)if(this._manager.session.enabledFeatures||!e.detectedPlanes.size)return;else this._available=true,this.fire("available");let t=e.detectedPlanes;for(let[e,i]of this._planesIndex)t.has(e)||(this._planesIndex.delete(e),this._planes.splice(this._planes.indexOf(i),1),i.destroy(),this.fire("remove",i));for(let i of t){let t=this._planesIndex.get(i);t?t.update(e):(t=new x4(this,i),this._planesIndex.set(i,t),this._planes.push(t),t.update(e),this.fire("add",t));}}get supported(){return this._supported}get available(){return this._available}get planes(){return this._planes}constructor(e){super(),this._supported=k.browser&&!!window.XRPlane,this._available=false,this._planesIndex=new Map,this._planes=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this));}}x5.EVENT_AVAILABLE="available",x5.EVENT_UNAVAILABLE="unavailable",x5.EVENT_ADD="add",x5.EVENT_REMOVE="remove";class x8 extends X{destroy(){if(!this._xrAnchor)return;let e=this._xrAnchor;this._xrAnchor.delete(),this._xrAnchor=null,this.fire("destroy",e,this);}update(e){if(!this._xrAnchor)return;let t=e.getPose(this._xrAnchor.anchorSpace,this._anchors.manager._referenceSpace);if(t){if(this._position.equals(t.transform.position)&&this._rotation.equals(t.transform.orientation))return;this._position.copy(t.transform.position),this._rotation.copy(t.transform.orientation),this.fire("change");}}getPosition(){return this._position}getRotation(){return this._rotation}persist(e){if(!this._anchors.persistence)return void e?.(Error("Persistent Anchors are not supported"),null);if(this._uuid)return void e?.(null,this._uuid);if(this._uuidRequests){e&&this._uuidRequests.push(e);return}this._uuidRequests=[],this._xrAnchor.requestPersistentHandle().then(t=>{for(let i of(this._uuid=t,this._anchors._indexByUuid.set(this._uuid,this),e?.(null,t),this._uuidRequests))i(null,t);this._uuidRequests=null,this.fire("persist",t);}).catch(t=>{for(let i of(e?.(t,null),this._uuidRequests))i(t,null);this._uuidRequests=null;});}forget(e){this._uuid?this._anchors.forget(this._uuid,t=>{this._uuid=null,e?.(t),this.fire("forget");}):e?.(Error("Anchor is not persistent"));}get uuid(){return this._uuid}get persistent(){return !!this._uuid}constructor(e,t,i=null){super(),this._position=new ed,this._rotation=new ex,this._uuid=null,this._uuidRequests=null,this._anchors=e,this._xrAnchor=t,this._uuid=i;}}x8.EVENT_DESTROY="destroy",x8.EVENT_CHANGE="change",x8.EVENT_PERSIST="persist",x8.EVENT_FORGET="forget";class x6 extends X{_onSessionStart(){let e=this.manager.session.enabledFeatures?.indexOf("anchors")>=0;e&&(this._available=e,this.fire("available"));}_onSessionEnd(){if(!this._available)return;this._available=false;for(let e=0;e<this._creationQueue.length;e++)this._creationQueue[e].callback&&this._creationQueue[e].callback(Error("session ended"),null);this._creationQueue.length=0,this._index.clear(),this._indexByUuid.clear();let e=this._list.length;for(;e--;)this._list[e].destroy();this._list.length=0,this.fire("unavailable");}_createAnchor(e,t=null){let i=new x8(this,e,t);return this._index.set(e,i),t&&this._indexByUuid.set(t,i),this._list.push(i),i.once("destroy",this._onAnchorDestroy,this),i}_onAnchorDestroy(e,t){this._index.delete(e),t.uuid&&this._indexByUuid.delete(t.uuid);let i=this._list.indexOf(t);-1!==i&&this._list.splice(i,1),this.fire("destroy",t);}create(e,t,i){if(!this._available)return void i?.(Error("Anchors API is not available"),null);if(window.XRHitTestResult&&e instanceof XRHitTestResult){if(i=t,!this._supported)return void i?.(Error("Anchors API is not supported"),null);if(!e.createAnchor)return void i?.(Error("Creating Anchor from Hit Test is not supported"),null);e.createAnchor().then(e=>{let t=this._createAnchor(e);i?.(null,t),this.fire("add",t);}).catch(e=>{i?.(e,null),this.fire("error",e);});}else this._creationQueue.push({transform:new XRRigidTransform(e,t),callback:i});}restore(e,t){this._available?this._persistence?this.manager.active?this.manager.session.restorePersistentAnchor(e).then(i=>{let s=this._createAnchor(i,e);t?.(null,s),this.fire("add",s);}).catch(e=>{t?.(e,null),this.fire("error",e);}):t?.(Error("WebXR session is not active"),null):t?.(Error("Anchor Persistence is not supported"),null):t?.(Error("Anchors API is not available"),null);}forget(e,t){this._available?this._persistence?this.manager.active?this.manager.session.deletePersistentAnchor(e).then(()=>{t?.(null);}).catch(e=>{t?.(e),this.fire("error",e);}):t?.(Error("WebXR session is not active")):t?.(Error("Anchor Persistence is not supported")):t?.(Error("Anchors API is not available"));}update(e){if(!this._available){this.manager.session.enabledFeatures||this._checkingAvailability||(this._checkingAvailability=true,e.createAnchor(new XRRigidTransform,this.manager._referenceSpace).then(e=>{e.delete(),this.manager.active&&(this._available=true,this.fire("available"));}).catch(()=>{}));return}if(this._creationQueue.length){for(let t=0;t<this._creationQueue.length;t++){let i=this._creationQueue[t];e.createAnchor(i.transform,this.manager._referenceSpace).then(e=>{i.callback&&this._callbacksAnchors.set(e,i.callback);}).catch(e=>{i.callback&&i.callback(e,null),this.fire("error",e);});}this._creationQueue.length=0;}for(let[t,i]of this._index)e.trackedAnchors.has(t)||(this._index.delete(t),i.destroy());for(let t=0;t<this._list.length;t++)this._list[t].update(e);for(let t of e.trackedAnchors){if(this._index.has(t))continue;try{t.anchorSpace;}catch(e){continue}let i=this._createAnchor(t);i.update(e);let s=this._callbacksAnchors.get(t);s&&(this._callbacksAnchors.delete(t),s(null,i)),this.fire("add",i);}}get supported(){return this._supported}get available(){return this._available}get persistence(){return this._persistence}get uuids(){return this._available&&this._persistence&&this.manager.active?this.manager.session.persistentAnchors:null}get list(){return this._list}constructor(e){super(),this._supported=k.browser&&!!window.XRAnchor,this._available=false,this._checkingAvailability=false,this._persistence=k.browser&&!!window?.XRSession?.prototype.restorePersistentAnchor,this._creationQueue=[],this._index=new Map,this._indexByUuid=new Map,this._list=[],this._callbacksAnchors=new Map,this.manager=e,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this));}}x6.EVENT_AVAILABLE="available",x6.EVENT_UNAVAILABLE="unavailable",x6.EVENT_ERROR="error",x6.EVENT_ADD="add",x6.EVENT_DESTROY="destroy";class x9 extends X{get xrMesh(){return this._xrMesh}get label(){return this._xrMesh.semanticLabel||""}get vertices(){return this._xrMesh.vertices}get indices(){return this._xrMesh.indices}destroy(){this._xrMesh&&(this._xrMesh=null,this.fire("remove"));}update(e){let t=this._meshDetection._manager,i=e.getPose(this._xrMesh.meshSpace,t._referenceSpace);i&&(this._position.copy(i.transform.position),this._rotation.copy(i.transform.orientation)),this._lastChanged!==this._xrMesh.lastChangedTime&&(this._lastChanged=this._xrMesh.lastChangedTime,this.fire("change"));}getPosition(){return this._position}getRotation(){return this._rotation}constructor(e,t){super(),this._lastChanged=0,this._position=new ed,this._rotation=new ex,this._meshDetection=e,this._xrMesh=t,this._lastChanged=this._xrMesh.lastChangedTime;}}x9.EVENT_REMOVE="remove",x9.EVENT_CHANGE="change";class x7 extends X{update(e){if(!this._available)if(this._manager.session.enabledFeatures||!e.detectedMeshes.size)return;else this._available=true,this.fire("available");for(let t of e.detectedMeshes){let i=this._index.get(t);i?i.update(e):(i=new x9(this,t),this._index.set(t,i),this._list.push(i),i.update(e),this.fire("add",i));}for(let t of this._index.values())e.detectedMeshes.has(t.xrMesh)||this._removeMesh(t);}_removeMesh(e){this._index.delete(e.xrMesh),this._list.splice(this._list.indexOf(e),1),e.destroy(),this.fire("remove",e);}_onSessionStart(){if(this._manager.session.enabledFeatures){let e=-1!==this._manager.session.enabledFeatures.indexOf("mesh-detection");e&&(this._available=e,this.fire("available"));}}_onSessionEnd(){if(this._available){for(let e of(this._available=false,this._index.values()))this._removeMesh(e);this.fire("unavailable");}}get supported(){return this._supported}get available(){return this._available}get meshes(){return this._list}constructor(e){super(),this._supported=k.browser&&!!window.XRMesh,this._available=false,this._index=new Map,this._list=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this));}}x7.EVENT_AVAILABLE="available",x7.EVENT_UNAVAILABLE="unavailable",x7.EVENT_ADD="add",x7.EVENT_REMOVE="remove";class Te extends X{get textureColor(){return this._textureColor}get textureDepth(){return this._textureDepth}get depthUvMatrix(){return this._depthMatrix}get depthValueToMeters(){return this._depthInfo?.rawValueToMeters||0}get eye(){return this._xrView.eye}get viewport(){return this._viewport}get projMat(){return this._projMat}get projViewOffMat(){return this._projViewOffMat}get viewOffMat(){return this._viewOffMat}get viewInvOffMat(){return this._viewInvOffMat}get viewMat3(){return this._viewMat3}get positionData(){return this._positionData}update(e,t){this._xrView=t,this._manager.views.availableColor&&(this._xrCamera=this._xrView.camera);let i=e.session.renderState.baseLayer.getViewport(this._xrView);this._viewport.x=i.x,this._viewport.y=i.y,this._viewport.z=i.width,this._viewport.w=i.height,this._projMat.set(this._xrView.projectionMatrix),this._viewMat.set(this._xrView.transform.inverse.matrix),this._viewInvMat.set(this._xrView.transform.matrix),this._updateTextureColor(),this._updateDepth(e);}_updateTextureColor(){if(!this._manager.views.availableColor||!this._xrCamera||!this._textureColor)return;let e=this._manager.webglBinding;if(!e)return;let t=e.getCameraImage(this._xrCamera);if(!t)return;let i=this._manager.app.graphicsDevice,s=i.gl;if(this._frameBufferSource){let e=s.COLOR_ATTACHMENT0,r=this._xrCamera.width,a=this._xrCamera.height;i.setFramebuffer(this._frameBufferSource),s.framebufferTexture2D(s.FRAMEBUFFER,e,s.TEXTURE_2D,t,0),i.setFramebuffer(this._frameBuffer),s.framebufferTexture2D(s.FRAMEBUFFER,e,s.TEXTURE_2D,this._textureColor.impl._glTexture,0),s.bindFramebuffer(s.READ_FRAMEBUFFER,this._frameBufferSource),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,this._frameBuffer),s.blitFramebuffer(0,a,r,0,0,0,r,a,s.COLOR_BUFFER_BIT,s.NEAREST);}else this._frameBufferSource=s.createFramebuffer(),this._frameBuffer=s.createFramebuffer();}_updateDepth(e){if(!this._manager.views.availableDepth||!this._textureDepth)return;let t=this._manager.views.depthGpuOptimized,i=t?this._manager.webglBinding:e;if(!i){this._depthInfo=null;return}let s=i.getDepthInformation(this._xrView);if(!s){this._depthInfo=null;return}let r=!this._depthInfo!=!s;this._depthInfo=s;let a=this._depthInfo?.width||4,n=this._depthInfo?.height||4,o=false;if((this._textureDepth.width!==a||this._textureDepth.height!==n)&&(this._textureDepth._width=a,this._textureDepth._height=n,r=true,o=true),r&&(this._depthInfo?this._depthMatrix.data.set(this._depthInfo.normDepthBufferFromNormView.matrix):this._depthMatrix.setIdentity()),this._depthInfo)if(t){if(this._depthInfo.texture){let e=this._manager.app.graphicsDevice.gl;switch(this._textureDepth.impl._glTexture=this._depthInfo.texture,"texture-array"===this._depthInfo.textureType?this._textureDepth.impl._glTarget=e.TEXTURE_2D_ARRAY:this._textureDepth.impl._glTarget=e.TEXTURE_2D,this._manager.views.depthPixelFormat){case 15:this._textureDepth.impl._glInternalFormat=e.R32F,this._textureDepth.impl._glPixelType=e.FLOAT,this._textureDepth.impl._glFormat=e.RED;break;case 16:this._textureDepth.impl._glInternalFormat=e.DEPTH_COMPONENT16,this._textureDepth.impl._glPixelType=e.UNSIGNED_SHORT,this._textureDepth.impl._glFormat=e.DEPTH_COMPONENT;}this._textureDepth.impl._glCreated=true;}}else this._textureDepth._levels[0]=new Uint8Array(this._depthInfo.data),this._textureDepth.upload();else this._textureDepth._levels[0]=this._emptyDepthBuffer,this._textureDepth.upload();o&&this.fire("depth:resize",a,n);}updateTransforms(e){e?(this._viewInvOffMat.mul2(e,this._viewInvMat),this.viewOffMat.copy(this._viewInvOffMat).invert()):(this._viewInvOffMat.copy(this._viewInvMat),this.viewOffMat.copy(this._viewMat)),this._viewMat3.setFromMat4(this._viewOffMat),this._projViewOffMat.mul2(this._projMat,this._viewOffMat),this._positionData[0]=this._viewInvOffMat.data[12],this._positionData[1]=this._viewInvOffMat.data[13],this._positionData[2]=this._viewInvOffMat.data[14];}_onDeviceLost(){this._frameBufferSource=null,this._frameBuffer=null,this._depthInfo=null;}getDepth(e,t){return this._manager.views.depthGpuOptimized?null:this._depthInfo?.getDepthInMeters(e,t)??null}destroy(){if(this._depthInfo=null,this._textureColor&&(this._textureColor.destroy(),this._textureColor=null),this._textureDepth&&(this._textureDepth.destroy(),this._textureDepth=null),this._frameBufferSource){let e=this._manager.app.graphicsDevice.gl;e.deleteFramebuffer(this._frameBufferSource),this._frameBufferSource=null,e.deleteFramebuffer(this._frameBuffer),this._frameBuffer=null;}}constructor(e,t,i){super(),this._positionData=new Float32Array(3),this._viewport=new ep,this._projMat=new ey,this._projViewOffMat=new ey,this._viewMat=new ey,this._viewOffMat=new ey,this._viewMat3=new eu,this._viewInvMat=new ey,this._viewInvOffMat=new ey,this._xrCamera=null,this._textureColor=null,this._textureDepth=null,this._depthInfo=null,this._emptyDepthBuffer=new Uint8Array(32),this._depthMatrix=new ey,this._manager=e,this._xrView=t;let s=this._manager.app.graphicsDevice;if(this._manager.views.supportedColor&&(this._xrCamera=this._xrView.camera,this._manager.views.availableColor&&this._xrCamera&&(this._textureColor=new ih(s,{format:6,mipmaps:false,addressU:1,addressV:1,minFilter:1,magFilter:1,width:this._xrCamera.width,height:this._xrCamera.height,name:`XrView-${this._xrView.eye}-Color`}))),this._manager.views.supportedDepth&&this._manager.views.availableDepth){let e=+!this._manager.views.depthGpuOptimized;this._textureDepth=new ih(s,{format:this._manager.views.depthPixelFormat,arrayLength:1===i?0:i,mipmaps:false,addressU:1,addressV:1,minFilter:e,magFilter:e,width:4,height:4,name:`XrView-${this._xrView.eye}-Depth`});for(let e=0;e<this._textureDepth._levels.length;e++)this._textureDepth._levels[e]=this._emptyDepthBuffer;this._textureDepth.upload();}(this._textureColor||this._textureDepth)&&s.on("devicelost",this._onDeviceLost,this);}}Te.EVENT_DEPTHRESIZE="depth:resize";class Tt extends X{get list(){return this._list}get supportedColor(){return this._supportedColor}get supportedDepth(){return this._supportedDepth}get availableColor(){return this._availableColor}get availableDepth(){return this._availableDepth}get depthUsage(){return this._depthUsage}get depthGpuOptimized(){return this._depthUsage===xC}get depthFormat(){return this._depthFormat}get depthPixelFormat(){return this._depthFormats[this._depthFormat]??null}update(e,t){for(let e=0;e<t.length;e++)this._indexTmp.set(t[e].eye,t[e]);for(let[i,s]of this._indexTmp){let r=this._index.get(i);r?r.update(e,s):(r=new Te(this._manager,s,t.length),this._index.set(i,r),this._list.push(r),r.update(e,s),this.fire("add",r));}for(let[e,t]of this._index){if(this._indexTmp.has(e))continue;t.destroy(),this._index.delete(e);let i=this._list.indexOf(t);-1!==i&&this._list.splice(i,1),this.fire("remove",t);}this._indexTmp.clear();}get(e){return this._index.get(e)||null}_onSessionStart(){if(this._manager.type===xE&&this._manager.session.enabledFeatures&&(this._availableColor=-1!==this._manager.session.enabledFeatures.indexOf("camera-access"),this._availableDepth=-1!==this._manager.session.enabledFeatures.indexOf("depth-sensing"),this._availableDepth)){let e=this._manager.session;this._depthUsage=e.depthUsage,this._depthFormat=e.depthDataFormat;}}_onSessionEnd(){for(let e of this._index.values())e.destroy();this._index.clear(),this._availableColor=false,this._availableDepth=false,this._depthUsage="",this._depthFormat="",this._list.length=0;}constructor(e){super(),this._index=new Map,this._indexTmp=new Map,this._list=[],this._supportedColor=k.browser&&!!window.XRCamera&&!!window.XRWebGLBinding,this._supportedDepth=k.browser&&!!window.XRDepthInformation,this._availableColor=false,this._availableDepth=false,this._depthUsage="",this._depthFormat="",this._depthFormats={[xP]:2,[xI]:16,[xD]:15},this._manager=e,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this);}}Tt.EVENT_ADD="add",Tt.EVENT_REMOVE="remove";class Ti extends X{destroy(){}start(e,t,i,s){let r=s;if("object"==typeof s&&(r=s.callback),!this._available[t]){r&&r(Error("XR is not available"));return}if(this._session){r&&r(Error("XR session is already started"));return}this._camera=e,this._camera.camera.xr=this,this._type=t,this._spaceType=i,this._framebufferScaleFactor=s?.framebufferScaleFactor??1,this._setClipPlanes(e.nearClip,e.farClip);let a={requiredFeatures:[i],optionalFeatures:[]},n=this.app.graphicsDevice;n?.isWebGPU&&a.requiredFeatures.push("webgpu");let o=n?.isWebGL2;if(t===xE){if(a.optionalFeatures.push("light-estimation"),a.optionalFeatures.push("hit-test"),s&&(s.imageTracking&&this.imageTracking.supported&&a.optionalFeatures.push("image-tracking"),s.planeDetection&&a.optionalFeatures.push("plane-detection"),s.meshDetection&&a.optionalFeatures.push("mesh-detection")),this.domOverlay.supported&&this.domOverlay.root&&(a.optionalFeatures.push("dom-overlay"),a.domOverlay={root:this.domOverlay.root}),s&&s.anchors&&this.anchors.supported&&a.optionalFeatures.push("anchors"),s&&s.depthSensing&&this.views.supportedDepth){a.optionalFeatures.push("depth-sensing");let e=[],t=[];if(e.push(xC,xA),t.push(xD,xP,xI),s.depthSensing.usagePreference){let t=e.indexOf(s.depthSensing.usagePreference);-1!==t&&e.splice(t,1),e.unshift(s.depthSensing.usagePreference);}if(s.depthSensing.dataFormatPreference){let e=t.indexOf(s.depthSensing.dataFormatPreference);-1!==e&&t.splice(e,1),t.unshift(s.depthSensing.dataFormatPreference);}a.depthSensing={usagePreference:e,dataFormatPreference:t};}o&&s&&s.cameraColor&&this.views.supportedColor&&a.optionalFeatures.push("camera-access");}a.optionalFeatures.push("hand-tracking"),s&&s.optionalFeatures&&(a.optionalFeatures=a.optionalFeatures.concat(s.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages((e,s)=>{if(e){r&&r(e),this.fire("error",e);return}null!==s&&(a.trackedImages=s),this._onStartOptionsReady(t,i,a,r);}):this._onStartOptionsReady(t,i,a,r);}_onStartOptionsReady(e,t,i,s){navigator.xr.requestSession(e,i).then(e=>{this._onSessionStart(e,t,s);}).catch(e=>{this._camera.camera.xr=null,this._camera=null,this._type=null,this._spaceType=null,s&&s(e),this.fire("error",e);});}end(e){if(!this._session){e&&e(Error("XR Session is not initialized"));return}this.webglBinding=null,e&&this.once("end",e),this._session.end();}isAvailable(e){return this._available[e]}_deviceAvailabilityCheck(){for(let e in this._available)this._sessionSupportCheck(e);}initiateRoomCapture(e){this._session?this._session.initiateRoomCapture?this._session.initiateRoomCapture().then(()=>{e&&e(null);}).catch(t=>{e&&e(t);}):e(Error("Session does not support manual room capture")):e(Error("Session is not active"));}updateTargetFrameRate(e,t){this._session?.updateTargetFrameRate?this._session.updateTargetFrameRate(e).then(()=>{t?.();}).catch(e=>{t?.(e);}):t?.(Error("unable to update frameRate"));}_sessionSupportCheck(e){navigator.xr.isSessionSupported(e).then(t=>{this._available[e]!==t&&(this._available[e]=t,this.fire("available",e,t),this.fire(`available:${e}`,t));}).catch(e=>{this.fire("error",e);});}_onSessionStart(e,t,i){let s=false;this._session=e;let r=()=>{this.fire("visibility:change",e.visibilityState);},a=()=>{this._setClipPlanes(this._camera.nearClip,this._camera.farClip);},n=()=>{this.fire("frameratechange",this._session?.frameRate);},o=()=>{this._camera&&(this._camera.off("set_nearClip",a),this._camera.off("set_farClip",a),this._camera.camera.xr=null,this._camera=null),e.removeEventListener("end",o),e.removeEventListener("visibilitychange",r),e.removeEventListener("frameratechange",n),s||this.fire("end"),this._session=null,this._referenceSpace=null,this._width=0,this._height=0,this._type=null,this._spaceType=null,this.app.systems&&this.app.requestAnimationFrame();};e.addEventListener("end",o),e.addEventListener("visibilitychange",r),this._camera.on("set_nearClip",a),this._camera.on("set_farClip",a),this._createBaseLayer(),this.session.supportedFrameRates?this._supportedFrameRates=Array.from(this.session.supportedFrameRates):this._supportedFrameRates=null,this._session.addEventListener("frameratechange",n),e.requestReferenceSpace(t).then(e=>{this._referenceSpace=e,this.app.requestAnimationFrame(),i&&i(null),this.fire("start");}).catch(t=>{s=true,e.end(),i&&i(t),this.fire("error",t);});}_setClipPlanes(e,t){this._depthNear===e&&this._depthFar===t||(this._depthNear=e,this._depthFar=t,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}));}_createBaseLayer(){let e=this.app.graphicsDevice,t=e.maxPixelRatio/window.devicePixelRatio*this._framebufferScaleFactor;if(this._baseLayer=new XRWebGLLayer(this._session,e.gl,{alpha:true,depth:true,stencil:true,framebufferScaleFactor:t,antialias:false}),e?.isWebGL2&&window.XRWebGLBinding)try{this.webglBinding=new XRWebGLBinding(this._session,e.gl);}catch(e){this.fire("error",e);}this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar});}_onDeviceLost(){this._session&&(this.webglBinding&&(this.webglBinding=null),this._baseLayer=null,this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}));}_onDeviceRestored(){this._session&&setTimeout(()=>{this.app.graphicsDevice.gl.makeXRCompatible().then(()=>{this._createBaseLayer();}).catch(e=>{this.fire("error",e);});},0);}update(e){if(!this._session)return  false;let t=e.session.renderState.baseLayer.framebufferWidth,i=e.session.renderState.baseLayer.framebufferHeight;(this._width!==t||this._height!==i)&&(this._width=t,this._height=i,this.app.graphicsDevice.setResolution(t,i));let s=e.getViewerPose(this._referenceSpace);if(!s)return  false;let r=this.views.list.length;this.views.update(e,s.views);let a=s.transform.position,n=s.transform.orientation;if(this._localPosition.set(a.x,a.y,a.z),this._localRotation.set(n.x,n.y,n.z,n.w),0===r&&this.views.list.length>0){let e=new ey,t=this.views.list[0];e.copy(t.projMat);let i=e.data,s=2*Math.atan(1/i[5])*180/Math.PI,r=i[5]/i[0],a=i[14]/(i[10]+1),n=i[14]/(i[10]-1);this._camera.camera.setXrProperties({aspectRatio:r,farClip:a,fov:s,horizontalFov:false,nearClip:n});}return this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(e),this._type===xE&&(this.hitTest.supported&&this.hitTest.update(e),this.lightEstimation.supported&&this.lightEstimation.update(e),this.imageTracking.supported&&this.imageTracking.update(e),this.anchors.supported&&this.anchors.update(e),this.planeDetection.supported&&this.planeDetection.update(e),this.meshDetection.supported&&this.meshDetection.update(e)),this.fire("update",e),true}get supported(){return this._supported}get active(){return !!this._session}get type(){return this._type}get spaceType(){return this._spaceType}get session(){return this._session}get frameRate(){return this._session?.frameRate??null}get supportedFrameRates(){return this._supportedFrameRates}get framebufferScaleFactor(){return this._framebufferScaleFactor}set fixedFoveation(e){(this._baseLayer?.fixedFoveation??null)!==null&&(this.app.graphicsDevice.samples,this._baseLayer.fixedFoveation=e);}get fixedFoveation(){return this._baseLayer?.fixedFoveation??null}get camera(){return this._camera?this._camera.entity:null}get visibilityState(){return this._session?this._session.visibilityState:null}constructor(e){super(),this._supported=k.browser&&!!navigator.xr,this._available={},this._type=null,this._spaceType=null,this._session=null,this._baseLayer=null,this.webglBinding=null,this._referenceSpace=null,this._camera=null,this._localPosition=new ed,this._localRotation=new ex,this._depthNear=.1,this._depthFar=1e3,this._supportedFrameRates=null,this._width=0,this._height=0,this._framebufferScaleFactor=1,this.app=e,this._available[xx]=false,this._available[xT]=false,this._available[xE]=false,this.domOverlay=new xR(this),this.hitTest=new xF(this),this.imageTracking=new xB(this),this.planeDetection=new x5(this),this.meshDetection=new x7(this),this.input=new xZ(this),this.lightEstimation=new x2(this),this.anchors=new x6(this),this.views=new Tt(this),this._supported&&(navigator.xr.addEventListener("devicechange",()=>{this._deviceAvailabilityCheck();}),this._deviceAvailabilityCheck(),this.app.graphicsDevice.on("devicelost",this._onDeviceLost,this),this.app.graphicsDevice.on("devicerestored",this._onDeviceRestored,this));}}Ti.EVENT_AVAILABLE="available",Ti.EVENT_START="start",Ti.EVENT_END="end",Ti.EVENT_UPDATE="update",Ti.EVENT_ERROR="error";class Ts{destroy(){this.texture.destroy();}clear(e){let{width:t,height:i}=this.canvas;this.ctx.clearRect(0,0,t,i),this.ctx.fillStyle=e,this.ctx.fillRect(0,0,t,i);}constructor(e,t,i,s){this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=i,this.texture=new ih(e,{name:s,format:20,width:t,height:i,mipmaps:true,minFilter:5,magFilter:1,addressU:1,addressV:1,levels:[this.canvas]}),this.ctx=this.canvas.getContext("2d",{alpha:true});}}let Tr=[],Ta=[[],[],[]],Tn=new Float32Array(2);class To extends as{destroy(){this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy();}),this.viewBindGroups.length=0;}update(e,t,i,s,r){this.camera=e,this.scene=t,this.layers=i,this.mapping=s,this.depth=r,t.clusteredLightingEnabled&&(this.emptyWorldClusters=this.renderer.worldClustersAllocator.empty);}execute(){let e=this.device,{renderer:t,camera:i,scene:s,layers:r,mapping:a,renderTarget:n}=this,o=s.layers.layerList,l=s.layers.subLayerEnabled,h=s.layers.subLayerList;for(let c=0;c<o.length;c++){let d=o[c];if(!(r&&0>r.indexOf(d))&&d.enabled&&l[c]&&d.camerasSet.has(i.camera)){let r=h[c];d._clearDepthBuffer&&t.clear(i.camera,false,true,false);let o=d.meshInstances;for(let e=0;e<o.length;e++){let t=o[e];t.pick&&t.transparent===r&&(Tr.push(t),a.set(t.id,t));}if(s.gsplat.enableIds){let e=d.gsplatPlacements;for(let t=0;t<e.length;t++){let i=e[t],s=i.node?.gsplat;s&&a.set(i.id,s);}}if(Tr.length>0){let r=s.clusteredLightingEnabled;r&&this.emptyWorldClusters.activate(),t.setCameraUniforms(i.camera,n),t.dispatchGlobalLights(s),e.scope.resolve("shadowAtlasParams").setValue(Tn),e.supportsUniformBuffers&&(t.initViewBindGroupFormat(r),t.setupViewUniformBuffers(this.viewBindGroups,t.viewUniformFormat,t.viewBindGroupFormat,null));let a=this.depth?4:3;t.renderForward(i.camera,n,Tr,Ta,a,t=>{e.setBlendState(this.blendState);}),Tr.length=0;}}}}constructor(e,t){super(e),this.viewBindGroups=[],this.blendState=iS.NOBLEND,this.renderer=t;}}let Tl=new Set,Th=new ep,Tc=new Float32Array(1),Td=new Int32Array(Tc.buffer),Tu=new ed,Tf=new ed,Tp=new eM,Tm=new eM,T_=new eM;Tp.end=new ed,Tm.end=new ed,T_.end=new ed;let Tg=new ed,Tv=new ed,TS=new ed,Ty=new ed,Tx=new ed,TT=new ed,TE=new ed,Tw=new ed,Tb=new ed,TA=new ed,TC=new ed,TP=new ed,TI=new ed,TD=new ed,TR=new ed,TL=new ed,TM=new ed,TO=new ed,TF=new ed,TN=new ed,TB=new ep;function Tk(e,t,i){return TC.cross(e,t).dot(i)}class TU{stopPropagation(){this._stopPropagation=true,this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation());}constructor(e,t,i){this.event=e,this.element=t,this.camera=i,this._stopPropagation=false;}}class Tz extends TU{constructor(e,t,i,s,r,a,n){super(e,t,i),this.x=s,this.y=r,this.ctrlKey=e.ctrlKey||false,this.altKey=e.altKey||false,this.shiftKey=e.shiftKey||false,this.metaKey=e.metaKey||false,this.button=e.button,aI.isPointerLocked()?(this.dx=e.movementX||e.webkitMovementX||e.mozMovementX||0,this.dy=e.movementY||e.webkitMovementY||e.mozMovementY||0):(this.dx=s-a,this.dy=r-n),this.wheelDelta=0,"wheel"===e.type&&(e.deltaY>0?this.wheelDelta=1:e.deltaY<0&&(this.wheelDelta=-1));}}class TV extends TU{constructor(e,t,i,s,r,a){super(e,t,i),this.touches=e.touches,this.changedTouches=e.changedTouches,this.x=s,this.y=r,this.touch=a;}}class TG extends TU{constructor(e,t,i,s){super(e,t,i),this.inputSource=s;}}class TH{set enabled(e){this._enabled=e;}get enabled(){return this._enabled}set app(e){this._app=e;}get app(){return this._app||r}attach(e){this._attached&&(this._attached=false,this.detach()),this._target=e,this._attached=true;let t=!!k.passiveEvents&&{passive:true};this._useMouse&&(window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t)),this._useTouch&&k.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,t),this._target.addEventListener("touchend",this._touchendHandler,false),this._target.addEventListener("touchmove",this._touchmoveHandler,false),this._target.addEventListener("touchcancel",this._touchcancelHandler,false)),this.attachSelectEvents();}attachSelectEvents(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),this._selectEventsAttached=true,this.app.xr.on("start",this._onXrStart,this));}detach(){if(!this._attached)return;this._attached=false;let e=!!k.passiveEvents&&{passive:true};this._useMouse&&(window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e)),this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,e),this._target.removeEventListener("touchend",this._touchendHandler,false),this._target.removeEventListener("touchmove",this._touchmoveHandler,false),this._target.removeEventListener("touchcancel",this._touchcancelHandler,false)),this._selectEventsAttached&&(this._selectEventsAttached=false,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)),this._target=null;}addElement(e){ -1===this._elements.indexOf(e)&&this._elements.push(e);}removeElement(e){let t=this._elements.indexOf(e);-1!==t&&this._elements.splice(t,1);}_handleUp(e){!this._enabled||aI.isPointerLocked()||(this._calcMouseCoords(e),this._onElementMouseEvent("mouseup",e));}_handleDown(e){!this._enabled||aI.isPointerLocked()||(this._calcMouseCoords(e),this._onElementMouseEvent("mousedown",e));}_handleMove(e){this._enabled&&(this._calcMouseCoords(e),this._onElementMouseEvent("mousemove",e),this._lastX=g,this._lastY=v);}_handleWheel(e){this._enabled&&(this._calcMouseCoords(e),this._onElementMouseEvent("mousewheel",e));}_determineTouchedElements(e){let t={},i=this.app.systems.camera.cameras;for(let s=i.length-1;s>=0;s--){let r=i[s],a=0,n=e.changedTouches.length;for(let i=0;i<n;i++){if(t[e.changedTouches[i].identifier]){a++;continue}let s=aH(e.changedTouches[i]),n=this._getTargetElementByCoords(r,s.x,s.y);n&&(a++,t[e.changedTouches[i].identifier]={element:n,camera:r,x:s.x,y:s.y});}if(a===n)break}return t}_handleTouchStart(e){if(!this._enabled)return;let t=this._determineTouchedElements(e);for(let i=0,s=e.changedTouches.length;i<s;i++){let s=e.changedTouches[i],r=t[s.identifier],a=this._touchedElements[s.identifier];r&&(!a||r.element!==a.element)&&(this._fireEvent(e.type,new TV(e,r.element,r.camera,r.x,r.y,s)),this._touchesForWhichTouchLeaveHasFired[s.identifier]=false);}for(let e in t)this._touchedElements[e]=t[e];}_handleTouchEnd(e){if(!this._enabled)return;let t=this.app.systems.camera.cameras;for(let e in this._clickedEntities)delete this._clickedEntities[e];for(let i=0,s=e.changedTouches.length;i<s;i++){let s=e.changedTouches[i],r=this._touchedElements[s.identifier];if(!r)continue;let a=r.element,n=r.camera,o=r.x,l=r.y;delete this._touchedElements[s.identifier],delete this._touchesForWhichTouchLeaveHasFired[s.identifier];let h=aH(s);for(let i=t.length-1;i>=0;i--)this._getTargetElementByCoords(t[i],h.x,h.y)!==a||this._clickedEntities[a.entity.getGuid()]||(this._fireEvent("click",new TV(e,a,n,o,l,s)),this._clickedEntities[a.entity.getGuid()]=Date.now());this._fireEvent(e.type,new TV(e,a,n,o,l,s));}}_handleTouchMove(e){if(e.preventDefault(),!this._enabled)return;let t=this._determineTouchedElements(e);for(let i=0,s=e.changedTouches.length;i<s;i++){let s=e.changedTouches[i],r=t[s.identifier],a=this._touchedElements[s.identifier];if(a){let t=aH(s);r&&r.element===a.element||this._touchesForWhichTouchLeaveHasFired[s.identifier]||(this._fireEvent("touchleave",new TV(e,a.element,a.camera,t.x,t.y,s)),this._touchesForWhichTouchLeaveHasFired[s.identifier]=true),this._fireEvent("touchmove",new TV(e,a.element,a.camera,t.x,t.y,s));}}}_onElementMouseEvent(e,t){let i,s=null,r=this._hoveredElement;this._hoveredElement=null;let a=this.app.systems.camera.cameras;for(let e=a.length-1;e>=0&&(i=a[e],!(s=this._getTargetElementByCoords(i,g,v)));e--);if(this._hoveredElement=s,("mousemove"===e||"mouseup"===e)&&this._pressedElement?this._fireEvent(e,new Tz(t,this._pressedElement,i,g,v,this._lastX,this._lastY)):s&&(this._fireEvent(e,new Tz(t,s,i,g,v,this._lastX,this._lastY)),"mousedown"===e&&(this._pressedElement=s)),r!==this._hoveredElement&&(r&&this._fireEvent("mouseleave",new Tz(t,r,i,g,v,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new Tz(t,this._hoveredElement,i,g,v,this._lastX,this._lastY))),"mouseup"===e&&this._pressedElement){if(this._pressedElement===this._hoveredElement){let e=this._hoveredElement.entity.getGuid(),s=!this._clickedEntities;if(this._clickedEntities){let t=this._clickedEntities[e]||0;s=Date.now()-t>300,delete this._clickedEntities[e];}s&&this._fireEvent("click",new Tz(t,this._hoveredElement,i,g,v,this._lastX,this._lastY));}this._pressedElement=null;}}_onXrStart(){this.app.xr.on("end",this._onXrEnd,this),this.app.xr.on("update",this._onXrUpdate,this),this.app.xr.input.on("selectstart",this._onSelectStart,this),this.app.xr.input.on("selectend",this._onSelectEnd,this),this.app.xr.input.on("remove",this._onXrInputRemove,this);}_onXrEnd(){this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this);}_onXrUpdate(){if(!this._enabled)return;let e=this.app.xr.input.inputSources;for(let t=0;t<e.length;t++)this._onElementSelectEvent("selectmove",e[t],null);}_onXrInputRemove(e){let t=this._selectedElements[e.id];t&&(e._elementEntity=null,this._fireEvent("selectleave",new TG(null,t,null,e))),delete this._selectedElements[e.id],delete this._selectedPressedElements[e.id];}_onSelectStart(e,t){this._enabled&&this._onElementSelectEvent("selectstart",e,t);}_onSelectEnd(e,t){this._enabled&&this._onElementSelectEvent("selectend",e,t);}_onElementSelectEvent(e,t,i){let s,r,a,n=this._selectedElements[t.id],o=this.app.systems.camera.cameras;if(t.elementInput){T_.set(t.getOrigin(),t.getDirection());for(let e=o.length-1;e>=0&&(a=o[e],!(s=this._getTargetElementByRay(T_,a)));e--);}t._elementEntity=s||null,s?(this._selectedElements[t.id]=s,r=s):delete this._selectedElements[t.id],n!==r&&(n&&this._fireEvent("selectleave",new TG(i,n,a,t)),r&&this._fireEvent("selectenter",new TG(i,r,a,t)));let l=this._selectedPressedElements[t.id];"selectmove"===e&&l&&this._fireEvent("selectmove",new TG(i,l,a,t)),"selectstart"===e&&(this._selectedPressedElements[t.id]=r,r&&this._fireEvent("selectstart",new TG(i,r,a,t))),!t.elementInput&&l&&(delete this._selectedPressedElements[t.id],n&&this._fireEvent("selectend",new TG(i,l,a,t))),"selectend"===e&&t.elementInput&&(delete this._selectedPressedElements[t.id],l&&this._fireEvent("selectend",new TG(i,l,a,t)),l&&l===n&&this._fireEvent("click",new TG(i,l,a,t)));}_fireEvent(e,t){let i=t.element;for(;i.fire(e,t),!t._stopPropagation&&i.entity.parent&&(i=i.entity.parent.element););}_calcMouseCoords(e){let t=this._target.getBoundingClientRect(),i=Math.floor(t.left),s=Math.floor(t.top);g=e.clientX-i,v=e.clientY-s;}_sortElements(e,t){let i=this.app.scene.layers.sortTransparentLayers(e.layers,t.layers);return 0!==i?i:e.screen&&!t.screen?-1:!e.screen&&t.screen?1:e.screen||t.screen?e.screen.screen.screenSpace&&!t.screen.screen.screenSpace?-1:t.screen.screen.screenSpace&&!e.screen.screen.screenSpace?1:t.drawOrder-e.drawOrder:0}_getTargetElementByCoords(e,t,i){let s=this._calculateRayScreen(t,i,e,Tp)?Tp:null,r=this._calculateRay3d(t,i,e,Tm)?Tm:null;return this._getTargetElement(e,s,r)}_getTargetElementByRay(e,t){Tp.origin.copy(e.origin),Tp.direction.copy(e.direction),Tp.end.copy(Tp.direction).mulScalar(2*t.farClip).add(Tp.origin);let i=t.worldToScreen(Tp.origin,Tu),s=this._calculateRayScreen(i.x,i.y,t,Tm)?Tm:null;return this._getTargetElement(t,s,Tp)}_getTargetElement(e,t,i){let s=null,r=1/0;this._elements.sort(this._sortHandler);for(let a=0,n=this._elements.length;a<n;a++){let n=this._elements[a];if(n.layers.some(t=>e.layersSet.has(t)))if(n.screen&&n.screen.screen.screenSpace){if(!t)continue;if(this._checkElement(t,n,true)>=0){s=n;break}}else {if(!i)continue;let e=this._checkElement(i,n,false);if(e>=0&&(e<r&&(s=n,r=e),n.screen)){s=n;break}}}return s}_calculateRayScreen(e,t,i,s){let r=this.app.graphicsDevice.width,a=this.app.graphicsDevice.height,n=i.rect.z*r,o=i.rect.w*a,l=i.rect.x*r,h=(1-i.rect.y)*a,c=h-o,d=e*r/this._target.clientWidth,u=t*a/this._target.clientHeight;return d>=l&&d<=l+n&&u<=h&&u>=c&&(d=r*(d-l)/n,u=a*(u-c)/o,u=a-u,s.origin.set(d,u,1),s.direction.set(0,0,-1),s.end.copy(s.direction).mulScalar(2).add(s.origin),true)}_calculateRay3d(e,t,i,s){let r=this._target.clientWidth,a=this._target.clientHeight,n=i.rect.z*r,o=i.rect.w*a,l=i.rect.x*r,h=(1-i.rect.y)*a,c=h-o,d=e,u=t;return e>=l&&e<=l+n&&t<=h&&u>=c&&(d=r*(d-l)/n,u=a*(u-c)/o,i.screenToWorld(d,u,i.nearClip,Tu),i.screenToWorld(d,u,i.farClip,Tf),s.origin.copy(Tu),s.direction.set(0,0,-1),s.end.copy(Tf),true)}_checkElement(e,t,i){let s;if(t.maskedBy&&0>this._checkElement(e,t.maskedBy.element,i))return -1;s=i?TH.calculateScaleToScreen(t):TH.calculateScaleToWorld(t);let r=TH.buildHitCorners(t,i?t.screenCorners:t.worldCorners,s);return function(e,t,i){let s,r;Tg.sub2(t,e),Tv.sub2(i[0],e),TS.sub2(i[1],e),Ty.sub2(i[2],e),TT.cross(Ty,Tg);let a=Tv.dot(TT);if(a>=0){if((s=-TS.dot(TT))<0||(r=Tk(Tg,TS,Tv))<0)return -1;let e=1/(s+a+r);TE.copy(i[0]).mulScalar(s*e),Tw.copy(i[1]).mulScalar(a*e),Tb.copy(i[2]).mulScalar(r*e),TA.copy(TE).add(Tw).add(Tb);}else {if(Tx.sub2(i[3],e),(s=Tx.dot(TT))<0||(r=Tk(Tg,Tv,Tx))<0)return -1;let t=1/(s+(a=-a)+r);TE.copy(i[0]).mulScalar(s*t),Tw.copy(i[3]).mulScalar(a*t),Tb.copy(i[2]).mulScalar(r*t),TA.copy(TE).add(Tw).add(Tb);}return 1e-8>Tg.sub2(i[0],i[2]).lengthSq()||1e-8>Tg.sub2(i[1],i[3]).lengthSq()?-1:TA.sub(e).lengthSq()}(e.origin,e.end,r)}static buildHitCorners(e,t,i){let s=t;if(e.entity&&e.entity.button){let t=e.entity.button.hitPadding||TB;TI.copy(e.entity.up),TD.copy(TI).mulScalar(-1),TL.copy(e.entity.right),TR.copy(TL).mulScalar(-1),TI.mulScalar(t.w*i.y),TD.mulScalar(t.y*i.y),TL.mulScalar(t.z*i.x),TR.mulScalar(t.x*i.x),TM.copy(s[0]).add(TD).add(TR),TO.copy(s[1]).add(TD).add(TL),TF.copy(s[2]).add(TI).add(TL),TN.copy(s[3]).add(TI).add(TR),s=[TM,TO,TF,TN];}if(i.x<0){let e=s[2].x,t=s[0].x;s[0].x=e,s[1].x=t,s[2].x=t,s[3].x=e;}if(i.y<0){let e=s[2].y,t=s[0].y;s[0].y=e,s[1].y=e,s[2].y=t,s[3].y=t;}if(i.z<0){let e=s[2].x,t=s[2].y,i=s[2].z;s[2].x=s[0].x,s[2].y=s[0].y,s[2].z=s[0].z,s[0].x=e,s[0].y=t,s[0].z=i;}return s}static calculateScaleToScreen(e){let t=e.entity,i=e.screen.screen.scale;for(TP.set(i,i,i);t&&!t.screen;)TP.mul(t.getLocalScale()),t=t.parent;return TP}static calculateScaleToWorld(e){let t=e.entity;for(TP.set(1,1,1);t;)TP.mul(t.getLocalScale()),t=t.parent;return TP}constructor(e,t){this._app=null,this._attached=false,this._target=null,this._enabled=true,this._lastX=0,this._lastY=0,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._touchstartHandler=this._handleTouchStart.bind(this),this._touchendHandler=this._handleTouchEnd.bind(this),this._touchcancelHandler=this._touchendHandler,this._touchmoveHandler=this._handleTouchMove.bind(this),this._sortHandler=this._sortElements.bind(this),this._elements=[],this._hoveredElement=null,this._pressedElement=null,this._touchedElements={},this._touchesForWhichTouchLeaveHasFired={},this._selectedElements={},this._selectedPressedElements={},this._useMouse=!t||false!==t.useMouse,this._useTouch=!t||false!==t.useTouch,this._useXr=!t||false!==t.useXr,this._selectEventsAttached=false,k.touch&&(this._clickedEntities={}),this.attach(e);}}ef.prototype.scale=ef.prototype.mulScalar,ed.prototype.scale=ed.prototype.mulScalar,ep.prototype.scale=ep.prototype.mulScalar;let TW=new ep;Object.defineProperties(iU.prototype,{_glFrameBuffer:{get:function(){return this.impl._glFrameBuffer},set:function(e){}}}),Object.defineProperty(iO,"defaultInstancingFormat",{get:function(){return null}}),Object.defineProperties(ih.prototype,{rgbm:{get:function(){return this.type===tI},set:function(e){this.type=e?tI:tP;}},swizzleGGGR:{get:function(){return this.type===tL},set:function(e){this.type=e?tL:tP;}},_glTexture:{get:function(){return this.impl._glTexture}}}),Object.defineProperty(iB.prototype,"boneLimit",{get:function(){return 1024}}),Object.defineProperty(iB.prototype,"webgl2",{get:function(){return this.isWebGL2}}),Object.defineProperty(iB.prototype,"textureFloatHighPrecision",{get:function(){return  true}}),Object.defineProperty(iB.prototype,"extBlendMinmax",{get:function(){return  true}}),Object.defineProperty(iB.prototype,"extTextureHalfFloat",{get:function(){return  true}}),Object.defineProperty(iB.prototype,"extTextureLod",{get:function(){return  true}}),Object.defineProperty(iB.prototype,"textureHalfFloatFilterable",{get:function(){return  true}}),Object.defineProperty(iB.prototype,"supportsMrt",{get:function(){return  true}}),Object.defineProperty(iB.prototype,"supportsVolumeTextures",{get:function(){return  true}}),Object.defineProperty(iB.prototype,"supportsInstancing",{get:function(){return  true}}),Object.defineProperty(iB.prototype,"textureHalfFloatUpdatable",{get:function(){return  true}}),Object.defineProperty(iB.prototype,"extTextureFloat",{get:function(){return  true}}),Object.defineProperty(iB.prototype,"extStandardDerivatives",{get:function(){return  true}}),iS.DEFAULT=Object.freeze(new iS);let TX=new iS,TY=new ix;iB.prototype.setBlendFunction=function(e,t){let i=this.blendState;TX.copy(i),TX.setColorBlend(i.colorOp,e,t),TX.setAlphaBlend(i.alphaOp,e,t),this.setBlendState(TX);},iB.prototype.setBlendFunctionSeparate=function(e,t,i,s){let r=this.blendState;TX.copy(r),TX.setColorBlend(r.colorOp,e,t),TX.setAlphaBlend(r.alphaOp,i,s),this.setBlendState(TX);},iB.prototype.setBlendEquation=function(e){let t=this.blendState;TX.copy(t),TX.setColorBlend(e,t.colorSrcFactor,t.colorDstFactor),TX.setAlphaBlend(e,t.alphaSrcFactor,t.alphaDstFactor),this.setBlendState(TX);},iB.prototype.setBlendEquationSeparate=function(e,t){let i=this.blendState;TX.copy(i),TX.setColorBlend(e,i.colorSrcFactor,i.colorDstFactor),TX.setAlphaBlend(t,i.alphaSrcFactor,i.alphaDstFactor),this.setBlendState(TX);},iB.prototype.setColorWrite=function(e,t,i,s){let r=this.blendState;TX.copy(r),TX.setColorWrite(e,t,i,s),this.setBlendState(TX);},iB.prototype.getBlending=function(){return this.blendState.blend},iB.prototype.setBlending=function(e){TX.copy(this.blendState),TX.blend=e,this.setBlendState(TX);},iB.prototype.setDepthWrite=function(e){TY.copy(this.depthState),TY.write=e,this.setDepthState(TY);},iB.prototype.setDepthFunc=function(e){TY.copy(this.depthState),TY.func=e,this.setDepthState(TY);},iB.prototype.setDepthTest=function(e){TY.copy(this.depthState),TY.test=e,this.setDepthState(TY);},iB.prototype.getCullMode=function(){return this.cullMode};let Tq=new Proxy({},{get:(e,t)=>nH.get(r.graphicsDevice,tz).get(t),set:(e,t,i)=>(nH.get(r.graphicsDevice,tz).set(t,i),true)});function T$(e,t,i=""){Object.defineProperty(e.prototype,t,{set:function(e){},get:function(){}});}function Tj(e,t){Object.defineProperty(d0.prototype,t,{get:function(){return this[e]},set:function(t){this[e]=t;}});}function TK(e){Object.defineProperty(d0.prototype,e,{get:function(){return  true},set:function(e){}});}function TZ(e,t){"pass"!==e&&Object.defineProperty(dU.prototype,e,{get:function(){return this.litOptions[t||e]},set:function(i){this.litOptions[t||e]=i;}});}Object.defineProperty(ds.prototype,"defaultMaterial",{get:function(){return ot(r.graphicsDevice)}}),Object.defineProperty(ds.prototype,"fogColor",{set:function(e){this.fog.color=e;},get:function(){return this.fog.color}}),Object.defineProperty(ds.prototype,"fogEnd",{set:function(e){this.fog.end=e;},get:function(){return this.fog.end}}),Object.defineProperty(ds.prototype,"fogStart",{set:function(e){this.fog.start=e;},get:function(){return this.fog.start}}),Object.defineProperty(ds.prototype,"fogDensity",{set:function(e){this.fog.density=e;},get:function(){return this.fog.density}}),Object.defineProperty(ds.prototype,"toneMapping",{set:function(e){},get:function(){}}),Object.defineProperty(ds.prototype,"gammaCorrection",{set:function(e){},get:function(){}}),Object.defineProperty(ds.prototype,"rendering",{set:function(e){},get:function(){}}),Object.defineProperty(hf.prototype,"_meshInstances",{get:function(){return null}}),Object.defineProperty(ds.prototype,"drawCalls",{get:function(){return null}}),["128","64","32","16","8","4"].forEach((e,t)=>{Object.defineProperty(ds.prototype,`skyboxPrefiltered${e}`,{get:function(){return this._prefilteredCubemaps[t]},set:function(e){this._prefilteredCubemaps[t]=e,this.updateShaders=true;}});}),Object.defineProperty(ds.prototype,"models",{get:function(){return this._models||(this._models=[]),this._models}}),T$(hd,"renderTarget"),T$(hd,"onPreCull"),T$(hd,"onPreRender"),T$(hd,"onPreRenderOpaque"),T$(hd,"onPreRenderTransparent"),T$(hd,"onPostCull"),T$(hd,"onPostRender"),T$(hd,"onPostRenderOpaque"),T$(hd,"onPostRenderTransparent"),T$(hd,"onDrawCall"),T$(hd,"layerReference"),T$(g4,"onPreCull","Use Scene#EVENT_PRECULL event instead."),T$(g4,"onPostCull","Use Scene#EVENT_POSTCULL event instead."),T$(g4,"onPreRender","Use Scene#EVENT_PRERENDER event instead."),T$(g4,"onPostRender","Use Scene#EVENT_POSTRENDER event instead."),T$(g4,"onPreRenderLayer","Use Scene#EVENT_PRERENDER_LAYER event instead."),T$(g4,"onPostRenderLayer","Use Scene#EVENT_POSTRENDER_LAYER event instead."),ha.prototype.renderComposition=function(e){r.renderComposition(e);},od.prototype.syncAabb=function(){},hC.prototype.getTarget=function(e){return this.targets[e]},oX.prototype.getChildren=function(){return this.children},oX.prototype.getName=function(){return this.name},oX.prototype.getPath=function(){return this.path},oX.prototype.getRoot=function(){return this.root},oX.prototype.getParent=function(){return this.parent},oX.prototype.setName=function(e){this.name=e;},Object.defineProperty(lm.prototype,"shader",{set:function(e){},get:function(){return null}}),Object.defineProperty(lm.prototype,"blend",{set:function(e){this.blendState.blend=e;},get:function(){return this.blendState.blend}}),Object.defineProperty(d0.prototype,"shininess",{get:function(){return 100*this.gloss},set:function(e){this.gloss=.01*e;}}),Object.defineProperty(d0.prototype,"useGammaTonemap",{get:function(){return this.useTonemap},set:function(e){this.useTonemap=e;}}),Object.defineProperty(d0.prototype,"anisotropy",{get:function(){let e=Math.sign(Math.cos(this.anisotropyRotation*ei.DEG_TO_RAD*2));return this.anisotropyIntensity*e},set:function(e){this.anisotropyIntensity=Math.abs(e),e>=0?this.anisotropyRotation=0:this.anisotropyRotation=90;}}),TK("sheenTint"),TK("diffuseTint"),TK("emissiveTint"),TK("ambientTint"),Tj("specularTint","specularMapTint"),Tj("aoVertexColor","aoMapVertexColor"),Tj("diffuseVertexColor","diffuseMapVertexColor"),Tj("specularVertexColor","specularMapVertexColor"),Tj("emissiveVertexColor","emissiveMapVertexColor"),Tj("metalnessVertexColor","metalnessMapVertexColor"),Tj("glossVertexColor","glossMapVertexColor"),Tj("opacityVertexColor","opacityMapVertexColor"),Tj("lightVertexColor","lightMapVertexColor"),Tj("sheenGloss","sheenGlossiess"),Tj("clearCoatGloss","clearCostGlossiness"),TZ("refraction","useRefraction");let TQ=Object.getOwnPropertyNames(new dR);for(let e in TQ)TZ(TQ[e]);fT.prototype.getAssetById=function(e){return this.get(e)},Object.defineProperty(xK.prototype,"ray",{get:function(){return this._rayLocal}}),Object.defineProperty(xK.prototype,"position",{get:function(){return this._localPosition}}),Object.defineProperty(xK.prototype,"rotation",{get:function(){return this._localRotation}}),Object.defineProperty(TH.prototype,"wheel",{get:function(){return -2*this.wheelDelta}}),Object.defineProperty(aP.prototype,"wheel",{get:function(){return -2*this.wheelDelta}}),fH.prototype.isFullscreen=function(){return !!document.fullscreenElement},fH.prototype.enableFullscreen=function(e,t,i){e=e||this.graphicsDevice.canvas;let s=function(){t(),document.removeEventListener("fullscreenchange",s);},r=function(){i(),document.removeEventListener("fullscreenerror",r);};t&&document.addEventListener("fullscreenchange",s,false),i&&document.addEventListener("fullscreenerror",r,false),e.requestFullscreen?e.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):i();},fH.prototype.disableFullscreen=function(e){let t=function(){e(),document.removeEventListener("fullscreenchange",t);};e&&document.addEventListener("fullscreenchange",t,false),document.exitFullscreen();},fH.prototype.getSceneUrl=function(e){let t=this.scenes.find(e);return t?t.url:null},fH.prototype.loadScene=function(e,t){this.scenes.loadScene(e,t);},fH.prototype.loadSceneHierarchy=function(e,t){this.scenes.loadSceneHierarchy(e,t);},fH.prototype.loadSceneSettings=function(e,t){this.scenes.loadSceneSettings(e,t);},_z.prototype.setVisible=function(e){this.enabled=e;},Object.defineProperty(gi.prototype,"bodyType",{get:function(){return this.type},set:function(e){this.type=e;}}),gi.prototype.syncBodyToEntity=function(){this._updateDynamic();},gh.prototype.setGravity=function(){1==arguments.length?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2]);};class TJ{begin(e){if(!this.enabled)return;this._frameIndex<this._frameTimings.length&&this._frameTimings.splice(this._frameIndex);let t=this._prevTimings;this._prevTimings=this._timings,this._timings=this._frameTimings,this._frameTimings=t,this._frameIndex=0,this.mark(e);}mark(e){if(!this.enabled)return;let t=Q();if(this._frameIndex>0){let e=this._frameTimings[this._frameIndex-1];e[1]=t-e[1];}else if(this._timings.length>0){let e=this._timings[this._timings.length-1];e[1]=t-e[1];}if(this._frameIndex>=this._frameTimings.length)this._frameTimings.push([e,t]);else {let i=this._frameTimings[this._frameIndex];i[0]=e,i[1]=t;}this._frameIndex++;}get timings(){return this._timings.slice(0,-1).map(e=>e[1])}constructor(e){this._frameIndex=0,this._frameTimings=[],this._timings=[],this._prevTimings=[],this.unitsName="ms",this.decimalPlaces=1,this.enabled=true,e.on("frameupdate",this.begin.bind(this,"update")),e.on("framerender",this.mark.bind(this,"render")),e.on("frameend",this.mark.bind(this,"other"));}}class T0{get timings(){return this._timings[0]=this.device.gpuProfiler?._frameTime??0,this._timings}constructor(e){this.device=e,e.gpuProfiler&&(e.gpuProfiler.enabled=true),this.enabled=true,this.unitsName="ms",this.decimalPlaces=1,this._timings=[];}}class T1{get timings(){return this.values}constructor(e,t,i,s,r){this.app=e,this.values=[],this.statNames=t,this.statNames.length>3&&(this.statNames.length=3),this.unitsName=s,this.decimalPlaces=i,this.multiplier=r||1;let a=(e,t)=>e.split(".").reduce((e,t)=>e?e instanceof Map?e.get(t):e[t]:null,t||this);e.on("frameupdate",e=>{for(let e=0;e<this.statNames.length;e++){let t=a(this.statNames[e],this.app.stats);this.values[e]=(t??0)*this.multiplier;}});}}class T2{destroy(){this.app.off("frameupdate",this.update,this);}loseContext(){this.timer&&"function"==typeof this.timer.loseContext&&this.timer.loseContext();}update(e){let t=this.timer.timings,i=t.reduce((e,t)=>e+t,0);if(this.avgTotal+=i,this.avgTimer+=e,this.avgCount++,this.maxValue=Math.max(this.maxValue,i),this.avgTimer>this.textRefreshRate&&(this.timingText=(this.avgTotal/this.avgCount).toFixed(this.timer.decimalPlaces),this.maxText=this.maxValue.toFixed(this.timer.decimalPlaces),this.avgTimer=0,this.avgTotal=0,this.avgCount=0,this.maxValue=0),this.enabled){let e=0,i=1.5*this.watermark;for(let s=0;s<t.length;++s)e+=Math.floor(t[s]/i*255),this.sample[s]=e;if(this.sample[3]=this.watermark/i*255,this.yOffset>=this.texture.height)return;let s=this.texture.lock();if(this.needsClear){let e=this.yOffset*this.texture.width*4;s.fill(0,e,e+4*this.texture.width),this.needsClear=false;}s.set(this.sample,(this.cursor+this.yOffset*this.texture.width)*4),this.texture.unlock(),this.cursor++,this.cursor===this.texture.width&&(this.cursor=0);}}render(e,t,i,s,r){e.quad(t+s,i,-s,r,this.enabled?this.cursor:0,this.enabled?.5+this.yOffset:this.texture.height-1,-s,0,this.texture,this.graphType);}constructor(e,t,i,s,r){this.app=t,this.name=e,this.device=t.graphicsDevice,this.timer=r,this.watermark=i,this.enabled=false,this.textRefreshRate=s,this.avgTotal=0,this.avgTimer=0,this.avgCount=0,this.maxValue=0,this.timingText="",this.maxText="",this.texture=null,this.yOffset=0,this.graphType=0,this.cursor=0,this.sample=new Uint8ClampedArray(4),this.sample.set([0,0,0,255]),this.needsClear=false,this.counter=0,this.app.on("frameupdate",this.update,this);}}class T3{destroy(){this.texture.destroy(),this.texture=null;}render(e,t,i,s){let r=this.placements.get(t);if(r)return e.quad(i+r.l-1,s-r.d+1,r.w+2,r.h+2,r.x-1,this.texture.height-r.y-r.h-1,void 0,void 0,this.texture,1),r.w;let a=0;for(let r=0;r<t.length;r++){let n=t[r];if(" "===n){a+=5;continue}let o=this.placements.get(n);o&&(e.quad(i+a+o.l-1,s-o.d+1,o.w+2,o.h+2,o.x-1,this.texture.height-o.y-o.h-1,void 0,void 0,this.texture,1),a+=o.w);}return a}constructor(e,t){let i=e=>{e.font='10px "Lucida Console", Monaco, monospace',e.textAlign="left",e.textBaseline="alphabetic";},s=document.createElement("canvas"),r=s.getContext("2d",{alpha:true});i(r);let a=new Map,n=5,o=5;t.forEach(e=>{let t=r.measureText(e),i=Math.ceil(-t.actualBoundingBoxLeft),s=Math.ceil(t.actualBoundingBoxRight),l=Math.ceil(t.actualBoundingBoxAscent),h=Math.ceil(t.actualBoundingBoxDescent),c=i+s;n+c+5>=512&&(n=5,o+=16),a.set(e,{l:i,r:s,a:l,d:h,w:c,h:l+h,x:n,y:o}),n+=c+5;}),s.width=512,s.height=ei.nextPowerOfTwo(o+16+5),i(r),r.fillStyle="rgb(0, 0, 0)",r.fillRect(0,0,s.width,s.height),a.forEach((e,t)=>{r.fillStyle="."===t||1===t.length&&t.charCodeAt(0)>=48&&57>=t.charCodeAt(0)?"rgb(255, 240, 100)":"rgb(150, 220, 230)",r.fillText(t,e.x-e.l,e.y+e.a);}),this.placements=a;let l=r.getImageData(0,0,s.width,s.height).data;for(let e=0;e<l.length;e+=4){let t=Math.max(l[e+0],l[e+1],l[e+2]);l[e+3]=Math.min(2*t,255);}this.texture=new ih(e,{name:"mini-stats-word-atlas",width:s.width,height:s.height,mipmaps:false,minFilter:0,magFilter:0,levels:[l]});}}let T4="1.0, 0.412, 0.380",T5="0.467, 0.867, 0.467",T8="0.424, 0.627, 0.863",T6="0.0, 0.0, 0.0",T9="0.15, 0.15, 0.0",T7="0.15, 0.0, 0.1",Ee=`
	attribute vec3 vertex_position;
	attribute vec4 vertex_texCoord0;
	varying vec4 uv0;
	varying float wordFlag;
	void main(void) {
		gl_Position = vec4(vertex_position.xy * 2.0 - 1.0, 0.5, 1.0);
		uv0 = vertex_texCoord0;
		wordFlag = vertex_position.z;
	}
`,Et=`
	attribute vertex_position: vec3f;
	attribute vertex_texCoord0: vec4f;
	varying uv0: vec4f;
	varying wordFlag: f32;
	@vertex fn vertexMain(input : VertexInput) -> VertexOutput {
		var output : VertexOutput;
		output.position = vec4(input.vertex_position.xy * 2.0 - 1.0, 0.5, 1.0);
		output.uv0 = input.vertex_texCoord0;
		output.wordFlag = input.vertex_position.z;
		return output;
	}
`,Ei=`
	varying vec4 uv0;
	varying float wordFlag;
	uniform vec4 clr;
	uniform sampler2D graphTex;
	uniform sampler2D wordsTex;
	void main (void) {
		vec4 graphSample = texture2D(graphTex, uv0.xy);
		vec4 graph;
		if (uv0.w < graphSample.r)
			graph = vec4(${T4}, 1.0);
		else if (uv0.w < graphSample.g)
			graph = vec4(${T5}, 1.0);
		else if (uv0.w < graphSample.b)
			graph = vec4(${T8}, 1.0);
		else {
			vec3 bgColor = vec3(${T6});
			if (wordFlag > 0.5) {
				bgColor = vec3(${T7});
			} else if (wordFlag > 0.2) {
				bgColor = vec3(${T9});
			}
			graph = vec4(bgColor, 1.0);
		}
		vec4 words = texture2D(wordsTex, vec2(uv0.x, 1.0 - uv0.y));
		if (wordFlag > 0.99) {
			gl_FragColor = words * clr;
		} else {
			gl_FragColor = graph * clr;
		}
	}
`,Es=`
	varying uv0: vec4f;
	varying wordFlag: f32;
	uniform clr: vec4f;
	var graphTex : texture_2d<f32>;
	var graphTex_sampler : sampler;
	var wordsTex : texture_2d<f32>;
	var wordsTex_sampler : sampler;
	@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {
		var uv0: vec4f = input.uv0;
		var graphSample: vec4f = textureSample(graphTex, graphTex_sampler, uv0.xy);
		var graph: vec4f;
		if (uv0.w < graphSample.r) {
			graph = vec4f(${T4}, 1.0);
		} else if (uv0.w < graphSample.g) {
			graph = vec4f(${T5}, 1.0);
		} else if (uv0.w < graphSample.b) {
			graph = vec4f(${T8}, 1.0);
		} else {
			var bgColor: vec3f = vec3f(${T6});
			if (input.wordFlag > 0.5) {
				bgColor = vec3f(${T7});
			} else if (input.wordFlag > 0.2) {
				bgColor = vec3f(${T9});
			}
			graph = vec4f(bgColor, 1.0);
		}
		var words: vec4f = textureSample(wordsTex, wordsTex_sampler, vec2f(uv0.x, 1.0 - uv0.y));
		var output: FragmentOutput;
		if (input.wordFlag > 0.99) {
			output.color = words * uniform.clr;
		} else {
			output.color = graph * uniform.clr;
		}
		return output;
	}
`;class Er{quad(e,t,i,s,r,a,n,o,l,h=0){if(this.quads>=this.maxQuads)return;let c=this.targetSize.width,d=this.targetSize.height,u=e/c,f=t/d,p=(e+i)/c,m=(t+s)/d,_=l.width,g=l.height,v=r/_,S=a/g,y=(r+(n??i))/_,x=(a+(o??s))/g;this.data.set([u,f,h,v,S,0,0,p,f,h,y,S,1,0,p,m,h,y,x,1,1,u,m,h,v,x,0,1],28*this.quads),this.quads++,this.prim.count+=6;}startFrame(){this.quads=0,this.prim.count=0,this.targetSize.width=this.device.canvas.scrollWidth,this.targetSize.height=this.device.canvas.scrollHeight;}render(e,t,i,s,r,a){this.buffer.setData(this.data.buffer),this.uniforms.clr.set(r,0),this.material.setParameter("clr",this.uniforms.clr),this.material.setParameter("graphTex",i),this.material.setParameter("wordsTex",s),e.drawMeshInstance(this.meshInstance,t);}constructor(e,t=2048){let i=new iO(e,[{semantic:e6,components:3,type:6},{semantic:tr,components:4,type:6}]),s=new Uint16Array(6*t);for(let e=0;e<t;++e)s[6*e+0]=4*e,s[6*e+1]=4*e+1,s[6*e+2]=4*e+2,s[6*e+3]=4*e,s[6*e+4]=4*e+2,s[6*e+5]=4*e+3;this.device=e,this.maxQuads=t,this.buffer=new iP(e,i,4*t,{usage:2}),this.data=new Float32Array(this.buffer.numBytes/4),this.indexBuffer=new ae(e,1,6*t,0,s),this.prim={type:4,indexed:true,base:0,baseVertex:0,count:0},this.quads=0,this.mesh=new n7(e),this.mesh.vertexBuffer=this.buffer,this.mesh.indexBuffer[0]=this.indexBuffer,this.mesh.primitive=[this.prim];let r=new cf({uniqueName:"MiniStats",vertexGLSL:Ee,fragmentGLSL:Ei,vertexWGSL:Et,fragmentWGSL:Es,attributes:{vertex_position:e6,vertex_texCoord0:tr}});this.material=r,r.cull=0,r.depthState=ix.NODEPTH,r.blendState=new iS(true,0,6,8,0,1,1),r.update(),this.meshInstance=new od(this.mesh,r,new oX("MiniStatsMesh")),this.uniforms={clr:new Float32Array(4)},this.targetSize={width:e.width,height:e.height};}}let Ea={animUpdate:"anim",physicsTime:"physics",renderTime:"render",gsplatSort:"gsplatSort"},En=new Set(["physicsTime","animUpdate","gsplatSort"]);class Eo{destroy(){this.device.off("resizecanvas",this.updateDiv,this),this.device.off("losecontext",this.loseContext,this),this.app.off("postrender",this.postRender,this),this.graphs.forEach(e=>e.destroy()),this.gpuPassGraphs.clear(),this.wordAtlas.destroy(),this.texture.destroy(),this.div.remove();}static getDefaultOptions(){return {sizes:[{width:100,height:16,spacing:0,graphs:false},{width:128,height:32,spacing:2,graphs:true},{width:256,height:64,spacing:2,graphs:true}],startSizeIndex:0,textRefreshRate:500,cpu:{enabled:true,watermark:33},gpu:{enabled:true,watermark:33},stats:[{name:"Frame",stats:["frame.ms"],decimalPlaces:1,unitsName:"ms",watermark:33},{name:"DrawCalls",stats:["drawCalls.total"],watermark:1e3}],gpuTimingMinSize:1,cpuTimingMinSize:1}}set activeSizeIndex(e){if(this._activeSizeIndex=e,this.gspacing=this.sizes[e].spacing,this.resize(this.sizes[e].width,this.sizes[e].height,this.sizes[e].graphs),this.opacity=e>0?.85:.7,e<this.gpuTimingMinSize&&this.gpuPassGraphs){for(let e of this.gpuPassGraphs.values()){let t=this.graphs.indexOf(e.graph);-1!==t&&this.graphs.splice(t,1),this.freeRow(e.graph),e.graph.destroy();}this.gpuPassGraphs.clear();let e=this.graphs.find(e=>"GPU"===e.name);e&&(e.graphType=0);}if(e<this.cpuTimingMinSize&&this.cpuGraphs){for(let e of this.cpuGraphs.values()){let t=this.graphs.indexOf(e.graph);-1!==t&&this.graphs.splice(t,1),this.freeRow(e.graph),e.graph.destroy();}this.cpuGraphs.clear();let e=this.graphs.find(e=>"CPU"===e.name);e&&(e.graphType=0);}}get activeSizeIndex(){return this._activeSizeIndex}set opacity(e){this.clr[3]=e;}get opacity(){return this.clr[3]}get overallHeight(){let e=this.graphs,t=this.gspacing;return this.height*e.length+t*(e.length-1)}set enabled(e){if(e!==this._enabled){this._enabled=e;for(let t=0;t<this.graphs.length;++t)this.graphs[t].enabled=e,this.graphs[t].timer.enabled=e;}}get enabled(){return this._enabled}initGraphs(e,t,i){if(this.graphs=[],i.cpu.enabled){let t=new TJ(e),s=new T2("CPU",e,i.cpu.watermark,i.textRefreshRate,t);this.graphs.push(s);}if(i.gpu.enabled){let s=new T0(t),r=new T2("GPU",e,i.gpu.watermark,i.textRefreshRate,s);this.graphs.push(r);}i.stats&&i.stats.forEach(t=>{let s=new T1(e,t.stats,t.decimalPlaces,t.unitsName,t.multiplier),r=new T2(t.name,e,t.watermark,i.textRefreshRate,s);this.graphs.push(r);}),this.texture=new ih(t,{name:"mini-stats-graph-texture",width:1,height:1,mipmaps:false,minFilter:0,magFilter:0,addressU:0,addressV:0}),this.graphs.forEach(e=>{e.texture=this.texture,this.allocateRow(e);});}render(){let e=this.graphs,t=this.wordAtlas,i=this.render2d,s=this.width,r=this.height,a=this.gspacing;i.startFrame();for(let n=0;n<e.length;++n){let o=e[n],l=n*(r+a);o.render(i,0,l,s,r);let h=1;l+=r-13,h+=t.render(i,o.name,h,l)+10;let c=o.timingText;for(let e=0;e<c.length;++e)h+=t.render(i,c[e],h,l);if(o.maxText&&this._activeSizeIndex>0){h+=5,h+=t.render(i,"max",h,l),h+=5;let e=o.maxText;for(let s=0;s<e.length;++s)h+=t.render(i,e[s],h,l);}o.timer.unitsName&&(h+=t.render(i,o.timer.unitsName,h,l));}i.render(this.app,this.drawLayer,this.texture,this.wordAtlas.texture,this.clr,r);}resize(e,t,i){let s=this.graphs;for(let e=0;e<s.length;++e)s[e].enabled=i;this.width=e,this.height=t,this.updateDiv();}updateDiv(){let e=this.device.canvas.getBoundingClientRect();this.div.style.left=`${e.left}px`,this.div.style.bottom=`${window.innerHeight-e.bottom}px`,this.div.style.width=`${this.width}px`,this.div.style.height=`${this.overallHeight}px`;}loseContext(){this.graphs.forEach(e=>e.loseContext());}updateSubStats(e,t,i,s,r){let a=[];for(let[t,n]of e)(i instanceof Map?i.get(t)||0:i[t]||0)>0?n.lastNonZeroFrame=this.frameIndex:r>0&&"gpu"===s&&this.frameIndex-n.lastNonZeroFrame>r&&a.push(t);for(let t of a){let i=e.get(t);if(i){let s=this.graphs.indexOf(i.graph);-1!==s&&this.graphs.splice(s,1),this.freeRow(i.graph),i.graph.destroy(),e.delete(t);}}for(let[a,n]of i instanceof Map?i:Object.entries(i))if(!e.has(a)){if(("gpu"===s||En.has(a))&&0===n)continue;let i=a;"frame"===s&&(i=Ea[a]||a);let o=`  ${i}`,l=`${s}.${a}`,h=new T1(this.app,[l],1,"ms",1),c=new T2(o,this.app,10,this.textRefreshRate,h);"gpu"===s?c.graphType=.33:"frame"===s&&(c.graphType=.66),c.texture=this.texture,this.allocateRow(c),c.enabled=this.sizes[this._activeSizeIndex].graphs;let d=this.graphs.findIndex(e=>e.name===t);-1===d&&(d=0);let u=d;for(let e=d-1;e>=0;e--)if(this.graphs[e].name.startsWith(" "))u=e;else break;this.graphs.splice(u,0,c),e.set(a,{graph:c,lastNonZeroFrame:n>0?this.frameIndex:this.frameIndex-r-1});}let n=this.graphs.find(e=>e.name===t);if(n){for(let t of e.values())t.graph.watermark=n.watermark;e.size>0?"gpu"===s?n.graphType=.33:"frame"===s&&(n.graphType=.66):n.graphType=0;}}allocateRow(e){let t;return this.freeRows.length>0?t=this.freeRows.pop():(t=this.nextRowIndex++,this.ensureTextureHeight(this.nextRowIndex)),this.graphRows.set(e,t),e.yOffset=t,e.needsClear=true,t}freeRow(e){let t=this.graphRows.get(e);void 0!==t&&(this.freeRows.push(t),this.graphRows.delete(e));}ensureTextureHeight(e){let t=this.sizes[this.sizes.length-1].width,i=ei.nextPowerOfTwo(t),s=ei.nextPowerOfTwo(e);s>this.texture.height&&this.texture.resize(i,s);}postRender(){if(this._enabled){if(this.render(),this._activeSizeIndex>=this.gpuTimingMinSize){let e=this.app.stats.gpu;e&&this.updateSubStats(this.gpuPassGraphs,"GPU",e,"gpu",240);}if(this._activeSizeIndex>=this.cpuTimingMinSize){let e={scriptUpdate:this.app.stats.frame.scriptUpdate,scriptPostUpdate:this.app.stats.frame.scriptPostUpdate,animUpdate:this.app.stats.frame.animUpdate,physicsTime:this.app.stats.frame.physicsTime,renderTime:this.app.stats.frame.renderTime,gsplatSort:this.app.stats.frame.gsplatSort};this.updateSubStats(this.cpuGraphs,"CPU",e,"frame",240);}}this.frameIndex++;}constructor(e,t=Eo.getDefaultOptions()){let i=e.graphicsDevice;this.graphRows=new Map,this.freeRows=[],this.nextRowIndex=0,this.sizes=t.sizes,this.initGraphs(e,i,t);let s=new Set(["","ms","0","1","2","3","4","5","6","7","8","9",".","-"," "].concat(this.graphs.map(e=>e.name)).concat(t.stats?t.stats.map(e=>e.unitsName):[]).filter(e=>!!e));for(let e=97;e<=122;e++)s.add(String.fromCharCode(e));for(let e=65;e<=90;e++)s.add(String.fromCharCode(e));this.wordAtlas=new T3(i,s),this._activeSizeIndex=t.startSizeIndex;let r=t.gpuTimingMinSize??1,a=t.cpuTimingMinSize??1;if(r<this.sizes.length||a<this.sizes.length){let e=this.sizes[this.sizes.length-1].width;for(let t=1;t<this.sizes.length-1;t++)this.sizes[t].width=e;}let n=document.createElement("div");n.setAttribute("id","mini-stats"),n.style.cssText="position:fixed;bottom:0;left:0;background:transparent;",document.body.appendChild(n),n.addEventListener("mouseenter",e=>{this.opacity=1;}),n.addEventListener("mouseleave",e=>{this.opacity=this._activeSizeIndex>0?.85:.7;}),n.addEventListener("click",e=>{e.preventDefault(),this._enabled&&(this.activeSizeIndex=(this.activeSizeIndex+1)%this.sizes.length,this.resize(this.sizes[this.activeSizeIndex].width,this.sizes[this.activeSizeIndex].height,this.sizes[this.activeSizeIndex].graphs));}),i.on("resizecanvas",this.updateDiv,this),i.on("losecontext",this.loseContext,this),e.on("postrender",this.postRender,this),this.app=e,this.drawLayer=e.scene.layers.getLayerById(4),this.device=i,this.render2d=new Er(i),this.div=n,this.width=0,this.height=0,this.gspacing=2,this.clr=[1,1,1,t.startSizeIndex>0?.85:.7],this._enabled=true,this.gpuTimingMinSize=r,this.gpuPassGraphs=new Map,this.cpuTimingMinSize=a,this.cpuGraphs=new Map,this.frameIndex=0,this.textRefreshRate=t.textRefreshRate,this.activeSizeIndex=this._activeSizeIndex;}}let El=`
	varying vec2 vUv0;
	uniform vec2 uOffset;
	uniform float uSrcMultiplier;
	uniform sampler2D source;
	void main(void)
	{
		vec4 pixel;
		vec4 texel = texture2D(source, vUv0);
		vec4 firstTexel = texel;
		float diff = texel.a * uSrcMultiplier;
		pixel = texture2D(source, vUv0 + uOffset * -2.0);
		texel = max(texel, pixel);
		diff = max(diff, length(firstTexel.rgb - pixel.rgb));
		pixel = texture2D(source, vUv0 + uOffset * -1.0);
		texel = max(texel, pixel);
		diff = max(diff, length(firstTexel.rgb - pixel.rgb));
		pixel = texture2D(source, vUv0 + uOffset * 1.0);
		texel = max(texel, pixel);
		diff = max(diff, length(firstTexel.rgb - pixel.rgb));
		pixel = texture2D(source, vUv0 + uOffset * 2.0);
		texel = max(texel, pixel);
		diff = max(diff, length(firstTexel.rgb - pixel.rgb));
	   gl_FragColor = vec4(texel.rgb, min(diff, 1.0));
	}
`,Eh=`
	varying vUv0: vec2f;
	uniform uOffset: vec2f;
	uniform uSrcMultiplier: f32;
	var source: texture_2d<f32>;
	var sourceSampler: sampler;
	@fragment
	fn fragmentMain(input: FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		
		var pixel: vec4f;
		var texel = textureSample(source, sourceSampler, input.vUv0);
		let firstTexel = texel;
		var diff = texel.a * uniform.uSrcMultiplier;
		pixel = textureSample(source, sourceSampler, input.vUv0 + uniform.uOffset * -2.0);
		texel = max(texel, pixel);
		diff = max(diff, length(firstTexel.rgb - pixel.rgb));
		pixel = textureSample(source, sourceSampler, input.vUv0 + uniform.uOffset * -1.0);
		texel = max(texel, pixel);
		diff = max(diff, length(firstTexel.rgb - pixel.rgb));
		pixel = textureSample(source, sourceSampler, input.vUv0 + uniform.uOffset * 1.0);
		texel = max(texel, pixel);
		diff = max(diff, length(firstTexel.rgb - pixel.rgb));
		pixel = textureSample(source, sourceSampler, input.vUv0 + uniform.uOffset * 2.0);
		texel = max(texel, pixel);
		diff = max(diff, length(firstTexel.rgb - pixel.rgb));
		output.color = vec4f(texel.rgb, min(diff, 1.0));
		return output;
	}
`,Ec=new Float32Array(2),Ed=new es;class Eu{textureToCanvas(e,t={}){let i=e.getSource();if("undefined"!=typeof HTMLImageElement&&i instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&i instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&i instanceof OffscreenCanvas||"undefined"!=typeof ImageBitmap&&i instanceof ImageBitmap){let{width:e,height:s}=this.calcTextureSize(i.width,i.height,t.maxTextureSize),r=document.createElement("canvas");r.width=e,r.height=s;let a=r.getContext("2d");if(null===a)return Promise.resolve(void 0);if(a.drawImage(i,0,0,r.width,r.height),t.color){let{r:i,g:r,b:n}=t.color,o=a.getImageData(0,0,e,s),l=o.data;for(let e=0;e<l.length;e+=4)l[e+0]=l[e+0]*i,l[e+1]=l[e+1]*r,l[e+2]=l[e+2]*n;a.putImageData(o,0,0);}return Promise.resolve(r)}let s=e.device,{width:r,height:a}=this.calcTextureSize(e.width,e.height,t.maxTextureSize),n=new ih(s,{name:"ExtractedTexture",width:r,height:a,format:eY(e.format)?7:e.format,cubemap:false,mipmaps:false,minFilter:1,magFilter:1,addressU:1,addressV:1}),o=new iU({colorBuffer:n,depth:false}),l=nY.createShader(s,{uniqueName:"ShaderCoreExporterBlit",attributes:{vertex_position:e6},vertexChunk:"fullscreenQuadVS",fragmentChunk:"outputTex2DPS"});return s.scope.resolve("source").setValue(e),s.setBlendState(iS.NOBLEND),n0(s,o,l),n.read(0,0,r,a,{renderTarget:o,immediate:true}).then(e=>{n.destroy(),o.destroy();let t=new Uint8ClampedArray(r*a*4);t.set(e);let i=new ImageData(t,r,a),s=document.createElement("canvas");s.width=r,s.height=a;let l=s.getContext("2d");return l?(l.putImageData(i,0,0),Promise.resolve(s)):Promise.resolve(void 0)})}calcTextureSize(e,t,i){if(i){let s=Math.min(i/Math.max(e,t),1);e=Math.round(e*s),t=Math.round(t*s);}return {width:e,height:t}}}var Ef=Uint8Array,Ep=Uint16Array,Em=Int32Array,E_=new Ef([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Eg=new Ef([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Ev=new Ef([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),ES=function(e,t){for(var i=new Ep(31),s=0;s<31;++s)i[s]=t+=1<<e[s-1];for(var r=new Em(i[30]),s=1;s<30;++s)for(var a=i[s];a<i[s+1];++a)r[a]=a-i[s]<<5|s;return {b:i,r:r}},Ey=ES(E_,2),Ex=Ey.b,ET=Ey.r;Ex[28]=258,ET[258]=28;for(var EE=ES(Eg,0).r,Ew=new Ep(32768),Eb=0;Eb<32768;++Eb){var EA=(43690&Eb)>>1|(21845&Eb)<<1;EA=(61680&(EA=(52428&EA)>>2|(13107&EA)<<2))>>4|(3855&EA)<<4,Ew[Eb]=((65280&EA)>>8|(255&EA)<<8)>>1;}for(var EC=function(e,t,i){for(var s,r=e.length,a=0,n=new Ep(t);a<r;++a)e[a]&&++n[e[a]-1];var o=new Ep(t);for(a=1;a<t;++a)o[a]=o[a-1]+n[a-1]<<1;if(i){s=new Ep(1<<t);var l=15-t;for(a=0;a<r;++a)if(e[a])for(var h=a<<4|e[a],c=t-e[a],d=o[e[a]-1]++<<c,u=d|(1<<c)-1;d<=u;++d)s[Ew[d]>>l]=h;}else for(a=0,s=new Ep(r);a<r;++a)e[a]&&(s[a]=Ew[o[e[a]-1]++]>>15-e[a]);return s},EP=new Ef(288),Eb=0;Eb<144;++Eb)EP[Eb]=8;for(var Eb=144;Eb<256;++Eb)EP[Eb]=9;for(var Eb=256;Eb<280;++Eb)EP[Eb]=7;for(var Eb=280;Eb<288;++Eb)EP[Eb]=8;for(var EI=new Ef(32),Eb=0;Eb<32;++Eb)EI[Eb]=5;var ED=EC(EP,9,0);EC(EP,9,1);var ER=EC(EI,5,0);EC(EI,5,1);var EL=function(e){return (e+7)/8|0},EM=function(e,t,i){return (null==i||i>e.length)&&(i=e.length),new Ef(e.subarray(t,i))},EO=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],EF=function(e,t,i){var s=Error(t||EO[e]);if(s.code=e,Error.captureStackTrace&&Error.captureStackTrace(s,EF),!i)throw s;return s},EN=function(e,t,i){i<<=7&t;var s=t/8|0;e[s]|=i,e[s+1]|=i>>8;},EB=function(e,t,i){i<<=7&t;var s=t/8|0;e[s]|=i,e[s+1]|=i>>8,e[s+2]|=i>>16;},Ek=function(e,t){for(var i=[],s=0;s<e.length;++s)e[s]&&i.push({s:s,f:e[s]});var r=i.length,a=i.slice();if(!r)return {t:EX,l:0};if(1==r){var n=new Ef(i[0].s+1);return n[i[0].s]=1,{t:n,l:1}}i.sort(function(e,t){return e.f-t.f}),i.push({s:-1,f:25001});var o=i[0],l=i[1],h=0,c=1,d=2;for(i[0]={s:-1,f:o.f+l.f,l:o,r:l};c!=r-1;)o=i[i[h].f<i[d].f?h++:d++],l=i[h!=c&&i[h].f<i[d].f?h++:d++],i[c++]={s:-1,f:o.f+l.f,l:o,r:l};for(var u=a[0].s,s=1;s<r;++s)a[s].s>u&&(u=a[s].s);var f=new Ep(u+1),p=EU(i[c-1],f,0);if(p>t){var s=0,m=0,_=p-t,g=1<<_;for(a.sort(function(e,t){return f[t.s]-f[e.s]||e.f-t.f});s<r;++s){var v=a[s].s;if(f[v]>t)m+=g-(1<<p-f[v]),f[v]=t;else break}for(m>>=_;m>0;){var S=a[s].s;f[S]<t?m-=1<<t-f[S]++-1:++s;}for(;s>=0&&m;--s){var y=a[s].s;f[y]==t&&(--f[y],++m);}p=t;}return {t:new Ef(f),l:p}},EU=function(e,t,i){return -1==e.s?Math.max(EU(e.l,t,i+1),EU(e.r,t,i+1)):t[e.s]=i},Ez=function(e){for(var t=e.length;t&&!e[--t];);for(var i=new Ep(++t),s=0,r=e[0],a=1,n=function(e){i[s++]=e;},o=1;o<=t;++o)if(e[o]==r&&o!=t)++a;else {if(!r&&a>2){for(;a>138;a-=138)n(32754);a>2&&(n(a>10?a-11<<5|28690:a-3<<5|12305),a=0);}else if(a>3){for(n(r),--a;a>6;a-=6)n(8304);a>2&&(n(a-3<<5|8208),a=0);}for(;a--;)n(r);a=1,r=e[o];}return {c:i.subarray(0,s),n:t}},EV=function(e,t){for(var i=0,s=0;s<t.length;++s)i+=e[s]*t[s];return i},EG=function(e,t,i){var s=i.length,r=EL(t+2);e[r]=255&s,e[r+1]=s>>8,e[r+2]=255^e[r],e[r+3]=255^e[r+1];for(var a=0;a<s;++a)e[r+a+4]=i[a];return (r+4+s)*8},EH=function(e,t,i,s,r,a,n,o,l,h,c){EN(t,c++,i),++r[256];for(var d,u,f,p,m=Ek(r,15),_=m.t,g=m.l,v=Ek(a,15),S=v.t,y=v.l,x=Ez(_),T=x.c,E=x.n,w=Ez(S),b=w.c,A=w.n,C=new Ep(19),P=0;P<T.length;++P)++C[31&T[P]];for(var P=0;P<b.length;++P)++C[31&b[P]];for(var I=Ek(C,7),D=I.t,R=I.l,L=19;L>4&&!D[Ev[L-1]];--L);var M=h+5<<3,O=EV(r,EP)+EV(a,EI)+n,F=EV(r,_)+EV(a,S)+n+14+3*L+EV(C,D)+2*C[16]+3*C[17]+7*C[18];if(l>=0&&M<=O&&M<=F)return EG(t,c,e.subarray(l,l+h));if(EN(t,c,1+(F<O)),c+=2,F<O){d=EC(_,g,0),u=_,f=EC(S,y,0),p=S;var N=EC(D,R,0);EN(t,c,E-257),EN(t,c+5,A-1),EN(t,c+10,L-4),c+=14;for(var P=0;P<L;++P)EN(t,c+3*P,D[Ev[P]]);c+=3*L;for(var B=[T,b],k=0;k<2;++k)for(var U=B[k],P=0;P<U.length;++P){var z=31&U[P];EN(t,c,N[z]),c+=D[z],z>15&&(EN(t,c,U[P]>>5&127),c+=U[P]>>12);}}else d=ED,u=EP,f=ER,p=EI;for(var P=0;P<o;++P){var V=s[P];if(V>255){var z=V>>18&31;EB(t,c,d[z+257]),c+=u[z+257],z>7&&(EN(t,c,V>>23&31),c+=E_[z]);var G=31&V;EB(t,c,f[G]),c+=p[G],G>3&&(EB(t,c,V>>5&8191),c+=Eg[G]);}else EB(t,c,d[V]),c+=u[V];}return EB(t,c,d[256]),c+u[256]},EW=new Em([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),EX=new Ef(0),EY=function(e,t,i,s,r,a){var n=a.z||e.length,o=new Ef(s+n+5*(1+Math.ceil(n/7e3))+r),l=o.subarray(s,o.length-r),h=a.l,c=7&(a.r||0);if(t){c&&(l[0]=a.r>>3);for(var d=EW[t-1],u=d>>13,f=8191&d,p=(1<<i)-1,m=a.p||new Ep(32768),_=a.h||new Ep(p+1),g=Math.ceil(i/3),v=2*g,S=function(t){return (e[t]^e[t+1]<<g^e[t+2]<<v)&p},y=new Em(25e3),x=new Ep(288),T=new Ep(32),E=0,w=0,b=a.i||0,A=0,C=a.w||0,P=0;b+2<n;++b){var I=S(b),D=32767&b,R=_[I];if(m[D]=R,_[I]=D,C<=b){var L=n-b;if((E>7e3||A>24576)&&(L>423||!h)){c=EH(e,l,0,y,x,T,w,A,P,b-P,c),A=E=w=0,P=b;for(var M=0;M<286;++M)x[M]=0;for(var M=0;M<30;++M)T[M]=0;}var O=2,F=0,N=f,B=D-R&32767;if(L>2&&I==S(b-B))for(var k=Math.min(u,L)-1,U=Math.min(32767,b),z=Math.min(258,L);B<=U&&--N&&D!=R;){if(e[b+O]==e[b+O-B]){for(var V=0;V<z&&e[b+V]==e[b+V-B];++V);if(V>O){if(O=V,F=B,V>k)break;for(var G=Math.min(B,V-2),H=0,M=0;M<G;++M){var W=b-B+M&32767,X=m[W],Y=W-X&32767;Y>H&&(H=Y,R=W);}}}R=m[D=R],B+=D-R&32767;}if(F){y[A++]=0x10000000|ET[O]<<18|EE[F];var q=31&ET[O],$=31&EE[F];w+=E_[q]+Eg[$],++x[257+q],++T[$],C=b+O,++E;}else y[A++]=e[b],++x[e[b]];}}for(b=Math.max(b,C);b<n;++b)y[A++]=e[b],++x[e[b]];c=EH(e,l,h,y,x,T,w,A,P,b-P,c),h||(a.r=7&c|l[c/8|0]<<3,c-=7,a.h=_,a.p=m,a.i=b,a.w=C);}else {for(var b=a.w||0;b<n+h;b+=65535){var j=b+65535;j>=n&&(l[c/8|0]=h,j=n),c=EG(l,c+1,e.subarray(b,j));}a.i=n;}return EM(o,0,s+EL(c)+r)},Eq=function(){for(var e=new Int32Array(256),t=0;t<256;++t){for(var i=t,s=9;--s;)i=(1&i&&-306674912)^i>>>1;e[t]=i;}return e}(),E$=function(){var e=-1;return {p:function(t){for(var i=e,s=0;s<t.length;++s)i=Eq[255&i^t[s]]^i>>>8;e=i;},d:function(){return ~e}}},Ej=function(e,t,i,s,r){if(!r&&(r={l:1},t.dictionary)){var a=t.dictionary.subarray(-32768),n=new Ef(a.length+e.length);n.set(a),n.set(e,a.length),e=n,r.w=a.length;}return EY(e,null==t.level?6:t.level,null==t.mem?r.l?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):20:12+t.mem,i,s,r)},EK=function(e,t){var i={};for(var s in e)i[s]=e[s];for(var s in t)i[s]=t[s];return i},EZ=function(e,t,i){for(;i;++t)e[t]=i,i>>>=8;},EQ=function(e,t,i,s){for(var r in e){var a=e[r],n=t+r,o=s;Array.isArray(a)&&(o=EK(s,a[1]),a=a[0]),a instanceof Ef?i[n]=[a,o]:(i[n+="/"]=[new Ef(0),o],EQ(a,n,i,s));}},EJ="undefined"!=typeof TextEncoder&&new TextEncoder,E0="undefined"!=typeof TextDecoder&&new TextDecoder;try{E0.decode(EX,{stream:!0});}catch(e){}function E1(e,t){if(EJ)return EJ.encode(e);for(var i,s=e.length,r=new Ef(e.length+(e.length>>1)),a=0,n=function(e){r[a++]=e;},i=0;i<s;++i){if(a+5>r.length){var o=new Ef(a+8+(s-i<<1));o.set(r),r=o;}var l=e.charCodeAt(i);l<128||t?n(l):(l<2048?n(192|l>>6):(l>55295&&l<57344?(n(240|(l=65536+(1047552&l)|1023&e.charCodeAt(++i))>>18),n(128|l>>12&63)):n(224|l>>12),n(128|l>>6&63)),n(128|63&l));}return EM(r,0,a)}var E2=function(e){var t=0;if(e)for(var i in e){var s=e[i].length;s>65535&&EF(9),t+=s+4;}return t},E3=function(e,t,i,s,r,a,n,o){var l=s.length,h=i.extra,c=o&&o.length,d=E2(h);EZ(e,t,null!=n?0x2014b50:0x4034b50),t+=4,null!=n&&(e[t++]=20,e[t++]=i.os),e[t]=20,t+=2,e[t++]=i.flag<<1|(a<0&&8),e[t++]=r&&8,e[t++]=255&i.compression,e[t++]=i.compression>>8;var u=new Date(null==i.mtime?Date.now():i.mtime),f=u.getFullYear()-1980;if((f<0||f>119)&&EF(10),EZ(e,t,f<<25|u.getMonth()+1<<21|u.getDate()<<16|u.getHours()<<11|u.getMinutes()<<5|u.getSeconds()>>1),t+=4,-1!=a&&(EZ(e,t,i.crc),EZ(e,t+4,a<0?-a-2:a),EZ(e,t+8,i.size)),EZ(e,t+12,l),EZ(e,t+14,d),t+=16,null!=n&&(EZ(e,t,c),EZ(e,t+6,i.attrs),EZ(e,t+10,n),t+=14),e.set(s,t),t+=l,d)for(var p in h){var m=h[p],_=m.length;EZ(e,t,+p),EZ(e,t+2,_),e.set(m,t+4),t+=4+_;}return c&&(e.set(o,t),t+=c),t},E4=function(e,t,i,s,r){EZ(e,t,0x6054b50),EZ(e,t+8,i),EZ(e,t+10,i),EZ(e,t+12,s),EZ(e,t+16,r);};let E5="root",E8=`#usda 1.0
(
		customLayerData = {
				string creator = "PlayCanvas UsdzExporter"
		}
		metersPerUnit = 1
		upAxis = "Y"
)
`,E6=(e,t,i)=>`                    ${e} inputs:${t} = ${i}`,E9=e=>{switch(e){case 0:return 5120;case 1:return 5121;case 2:return 5122;case 3:return 5123;case 4:return 5124;case 5:return 5125;case 6:return 5126}return 0},E7=function(e){switch(e){case 0:return 9728;case 1:return 9729;case 2:return 9984;case 4:return 9985;case 3:return 9986;case 5:return 9987}return 0},we=function(e){switch(e){case 1:return 33071;case 2:return 33648;case 0:return 10497}return 0},wt=["anisotropyMap","clearCoatGlossMap","clearCoatMap","clearCoatNormalMap","colorMap","diffuseMap","emissiveMap","iridescenceMap","iridescenceThicknessMap","metalnessMap","normalMap","refractionMap","sheenGlossMap","sheenMap","specularityFactorMap","specularMap","thicknessMap"];class wi extends Eu{collectResources(e){let t={buffers:[],cameras:[],entities:[],materials:[],skins:[],textures:[],entityMeshInstances:[],bufferViewMap:new Map,compressableTexture:new Set},{materials:i,buffers:s,entityMeshInstances:r,textures:a}=t;e.forEach(e=>{t.entities.push(e);});let n=e=>{e.forEach(e=>{let n=e.material;0>i.indexOf(n)&&(t.materials.push(n),wt.forEach(e=>{let i=n[e];i&&0>a.indexOf(i)&&("normalMap"!==e&&t.compressableTexture.add(i),a.push(i));}));let o=e.node,l=r.find(e=>e.node===o);l||(l={node:o,meshInstances:[]},r.push(l)),l.meshInstances.push(e);let h=e.mesh,c=h.vertexBuffer;0>s.indexOf(c)&&s.unshift(c);let d=h.indexBuffer[0];0>s.indexOf(d)&&s.push(d),h.skin&&0>t.skins.indexOf(h.skin)&&t.skins.push(h.skin);});};return t.entities.forEach(e=>{e.camera&&t.cameras.push(e.camera),e.render&&e.render.enabled&&n(e.render.meshInstances),e.model&&e.model.enabled&&e.model.meshInstances&&n(e.model.meshInstances);}),t}writeBufferViews(e,t){for(let i of(t.bufferViews=[],e.buffers))wi.writeBufferView(e,t,i);}static writeBufferView(e,t,i){let s;t.buffers=t.buffers??[],t.buffers[0]=t.buffers[0]??{byteLength:0};let r=t.buffers[0];r.byteLength=ei.roundUp(r.byteLength,4);let a=r.byteLength,n=(e,i,s,r)=>{let a={buffer:0,byteLength:i,byteOffset:s};return (34962===e||34963===e)&&(a.target=e),void 0!==r&&(a.byteStride=r),t.bufferViews.push(a)-1};if(i instanceof iP){s=i.lock();let t=i.getFormat();if(t.interleaved){let r=n(34962,s.byteLength,a,t.size);e.bufferViewMap.set(i,[r]);}else {let s=[];for(let e of t.elements){let i=n(34962,e.size*t.vertexCount,a+e.offset,e.size);s.push(i);}e.bufferViewMap.set(i,s);}}else if(i instanceof ae){let t=n(34963,(s=i.lock()).byteLength,a);e.bufferViewMap.set(i,[t]);}else {let t=n(void 0,(s=i).byteLength,a);e.bufferViewMap.set(i,[t]);}r.byteLength+=s.byteLength;}writeCameras(e,t){e.cameras.length>0&&(t.cameras=e.cameras.map(e=>{let t=e.projection,i=e.nearClip,s=e.farClip,r={};if(1===t)r.type="orthographic",r.orthographic={xmag:1,ymag:1,znear:i,zfar:s};else {let t=e.fov;r.type="perspective",r.perspective={yfov:t*ei.DEG_TO_RAD,znear:i,zfar:s};}return r}));}attachTexture(e,t,i,s,r,a){let n=t[r];if(n){let o=e.textures.indexOf(n);i[s]={index:o};let l=t[`${r}Tiling`],h=t[`${r}Offset`],c=t[`${r}Rotation`];(l&&!l.equals(ef.ONE)||h&&!h.equals(ef.ZERO)||0!==c)&&(i[s].extensions={KHR_texture_transform:{}},a.extensionsUsed=a.extensionsUsed??[],a.extensionsUsed.includes("KHR_texture_transform")||a.extensionsUsed.push("KHR_texture_transform"),a.extensionsRequired=a.extensionsRequired??[],a.extensionsRequired.includes("KHR_texture_transform")||a.extensionsRequired.push("KHR_texture_transform"),l&&!l.equals(ef.ONE)&&(i[s].extensions.KHR_texture_transform.scale=[l.x,l.y]),h&&!h.equals(ef.ZERO)&&(i[s].extensions.KHR_texture_transform.offset=[h.x,h.y-1+l.y]),0!==c&&(i[s].extensions.KHR_texture_transform.rotation=c*ei.DEG_TO_RAD));}}addExtension(e,t,i,s={}){t.extensions=t.extensions||{},t.extensions[i]=s,e.extensionsUsed=e.extensionsUsed??[],e.extensionsUsed.includes(i)||e.extensionsUsed.push(i);}writeStandardMaterial(e,t,i,s){let{diffuse:r,emissive:a,opacity:n,metalness:o,gloss:l,glossInvert:h}=t,c=i.pbrMetallicRoughness,d=t.useLighting?r:a;if(!d.equals(es.WHITE)||1!==n){let{r:e,g:t,b:i}=d.clone().linear();c.baseColorFactor=[e,t,i,n];}t.useMetalness?1!==o&&(c.metallicFactor=o):c.metallicFactor=0;let u=h?l:1-l;if(1!==u&&(c.roughnessFactor=u),this.attachTexture(e,t,c,"baseColorTexture",t.useLighting?"diffuseMap":"emissiveMap",s),this.attachTexture(e,t,c,"metallicRoughnessTexture","metalnessMap",s),t.useLighting&&!a.equals(es.BLACK)){let{r:e,g:t,b:s}=a.clone().linear();i.emissiveFactor=[e,t,s];}if(t.enableGGXSpecular&&(0!==t.anisotropyIntensity||0!==t.anisotropyRotation||t.anisotropyMap)){let r={};0!==t.anisotropyIntensity&&(r.anisotropyStrength=t.anisotropyIntensity),0!==t.anisotropyRotation&&(r.anisotropyRotation=t.anisotropyRotation*ei.DEG_TO_RAD),this.attachTexture(e,t,r,"anisotropyTexture","anisotropyMap",s),Object.keys(r).length>0&&this.addExtension(s,i,"KHR_materials_anisotropy",r);}if(t.clearCoat>0){let r={clearcoatFactor:Math.min(4*t.clearCoat,1)};0!==t.clearCoatGloss&&(r.clearcoatRoughnessFactor=t.clearCoatGloss),this.attachTexture(e,t,r,"clearcoatTexture","clearCoatMap",s),this.attachTexture(e,t,r,"clearcoatRoughnessTexture","clearCoatGlossMap",s),t.clearCoatNormalMap&&(this.attachTexture(e,t,r,"clearcoatNormalTexture","clearCoatNormalMap",s),1!==t.clearCoatBumpiness&&(r.clearcoatNormalTexture.scale=t.clearCoatBumpiness)),this.addExtension(s,i,"KHR_materials_clearcoat",r);}if(0!==t.dispersion&&this.addExtension(s,i,"KHR_materials_dispersion",{dispersion:t.dispersion}),t.useLighting&&1!==t.emissiveIntensity&&this.addExtension(s,i,"KHR_materials_emissive_strength",{emissiveStrength:t.emissiveIntensity}),t.refractionIndex!==1/1.5&&t.refractionIndex>0&&this.addExtension(s,i,"KHR_materials_ior",{ior:1/t.refractionIndex}),t.useIridescence){let r={};0!==t.iridescence&&(r.iridescenceFactor=t.iridescence),1.3!==t.iridescenceRefractionIndex&&(r.iridescenceIor=t.iridescenceRefractionIndex),100!==t.iridescenceThicknessMin&&(r.iridescenceThicknessMinimum=t.iridescenceThicknessMin),400!==t.iridescenceThicknessMax&&(r.iridescenceThicknessMaximum=t.iridescenceThicknessMax),this.attachTexture(e,t,r,"iridescenceTexture","iridescenceMap",s),this.attachTexture(e,t,r,"iridescenceThicknessTexture","iridescenceThicknessMap",s),Object.keys(r).length>0&&this.addExtension(s,i,"KHR_materials_iridescence",r);}if(t.useSheen){let r={};if(!t.sheen.equals(es.BLACK)){let{r:e,g:i,b:s}=t.sheen.clone().linear();r.sheenColorFactor=[e,i,s];}0!==t.sheenGloss&&(r.sheenRoughnessFactor=t.sheenGloss),this.attachTexture(e,t,r,"sheenColorTexture","sheenMap",s),this.attachTexture(e,t,r,"sheenRoughnessTexture","sheenGlossMap",s),Object.keys(r).length>0&&this.addExtension(s,i,"KHR_materials_sheen",r);}if(t.useMetalnessSpecularColor||!t.useMetalness){let r={};if(!t.specular.equals(es.WHITE)){let{r:e,g:i,b:s}=t.specular.clone().linear();r.specularColorFactor=[e,i,s];}1!==t.specularityFactor&&(r.specularFactor=t.specularityFactor),this.attachTexture(e,t,r,"specularColorTexture","specularMap",s),this.attachTexture(e,t,r,"specularTexture","specularityFactorMap",s),Object.keys(r).length>0&&this.addExtension(s,i,"KHR_materials_specular",r);}if(t.useDynamicRefraction&&(0!==t.refraction||t.refractionMap)){let r={};0!==t.refraction&&(r.transmissionFactor=t.refraction),this.attachTexture(e,t,r,"transmissionTexture","refractionMap",s),Object.keys(r).length>0&&this.addExtension(s,i,"KHR_materials_transmission",r);}if(t.useLighting||this.addExtension(s,i,"KHR_materials_unlit"),t.useDynamicRefraction&&(0!==t.thickness||0!==t.attenuationDistance||!t.attenuation.equals(es.WHITE)||t.thicknessMap)){let r={};if(0!==t.thickness&&(r.thicknessFactor=t.thickness),0!==t.attenuationDistance&&(r.attenuationDistance=t.attenuationDistance),!t.attenuation.equals(es.WHITE)){let{r:e,g:i,b:s}=t.attenuation.clone().linear();r.attenuationColor=[e,i,s];}this.attachTexture(e,t,r,"thicknessTexture","thicknessMap",s),Object.keys(r).length>0&&this.addExtension(s,i,"KHR_materials_volume",r);}}writeMaterials(e,t){e.materials.length>0&&(t.materials=e.materials.map(i=>{let{name:s,blendType:r,cull:a,alphaTest:n}=i,o={pbrMetallicRoughness:{}};return s&&s.length>0&&(o.name=s),i instanceof d0&&this.writeStandardMaterial(e,i,o,t),2===r?o.alphaMode="BLEND":3===r&&0!==n&&(o.alphaMode="MASK",o.alphaCutoff=n),0===a&&(o.doubleSided=true),this.attachTexture(e,i,o,"normalTexture","normalMap",t),this.attachTexture(e,i,o,"occlusionTexture","aoMap",t),this.attachTexture(e,i,o,"emissiveTexture","emissiveMap",t),o}));}writeNodes(e,t){e.entities.length>0&&(t.nodes=e.entities.map(t=>{let i=t.name,s=t.getLocalPosition(),r=t.getLocalRotation(),a=t.getLocalScale(),n={};i&&i.length>0&&(n.name=i),s.equals(ed.ZERO)||(n.translation=[s.x,s.y,s.z]),r.equals(ex.IDENTITY)||(n.rotation=[r.x,r.y,r.z,r.w]),a.equals(ed.ONE)||(n.scale=[a.x,a.y,a.z]),t.camera&&t.camera.enabled&&(n.camera=e.cameras.indexOf(t.camera));let o=e.entityMeshInstances.find(e=>e.node===t);if(o){n.mesh=e.entityMeshInstances.indexOf(o);let t=o.meshInstances[0];t&&t.mesh.skin&&(n.skin=e.skins.indexOf(t.mesh.skin));}return t.children.length>0&&(n.children=[],t.children.forEach(t=>{n.children.push(e.entities.indexOf(t));})),n}));}writeMeshes(e,t,i){e.entityMeshInstances.length>0&&(t.accessors=[],t.meshes=[],e.entityMeshInstances.forEach(s=>{let r={primitives:[]};s.meshInstances.forEach(s=>{let a=wi.createPrimitive(e,t,s.mesh,i);a.material=e.materials.indexOf(s.material),r.primitives.push(a);}),t.meshes.push(r);}));}static createPrimitive(e,t,i,s={}){let r={attributes:{}},{vertexBuffer:a}=i,{format:n}=a,{interleaved:o,elements:l}=n,h=a.getNumVertices();l.forEach((n,l)=>{let c=(e=>{switch(e){case e6:return "POSITION";case e9:return "NORMAL";case e7:return "TANGENT";case ti:return "COLOR_0";case tt:return "JOINTS_0";case te:return "WEIGHTS_0";case tr:return "TEXCOORD_0";case ta:return "TEXCOORD_1";case tn:return "TEXCOORD_2";case to:return "TEXCOORD_3";case tl:return "TEXCOORD_4";case th:return "TEXCOORD_5";case tc:return "TEXCOORD_6";case td:return "TEXCOORD_7"}return ""})(n.name);if(s.stripUnusedAttributes){let t=true;if(c.startsWith("TEXCOORD_")){let i=parseInt(c.split("_")[1],10);t=e.materials.some(e=>wt.some(t=>e[t]&&(0===i||e[`${t}Tiling`]?.uv===i)));}if("COLOR_0"===c&&(t=e.materials.some(e=>e.vertexColors)),"TANGENT"===c&&(t=e.materials.some(e=>e.normalMap)),("JOINTS_0"===c||"WEIGHTS_0"===c)&&(t=e.entityMeshInstances.some(e=>e.meshInstances.some(e=>e.mesh.skin))),!t)return}let d=e.bufferViewMap.get(a);d||(wi.writeBufferView(e,t,a),e.buffers.push(a),d=e.bufferViewMap.get(a));let u={bufferView:d[o?0:l],byteOffset:o?n.offset:0,componentType:E9(n.dataType),type:(e=>{switch(e){case 1:return "SCALAR";case 2:return "VEC2";case 3:return "VEC3";case 4:return "VEC4"}return 0})(n.numComponents),count:h},f=t.accessors.push(u)-1;if(r.attributes[c]=f,n.name===e6){let e=[];i.getPositions(e);let t=new ed,s=new ed;eC.computeMinMax(e,t,s),u.min=[t.x,t.y,t.z],u.max=[s.x,s.y,s.z];}});let c=i.indexBuffer[0];if(c){let i=e.bufferViewMap.get(c);i||(wi.writeBufferView(e,t,c),e.buffers.push(c),i=e.bufferViewMap.get(c));let s={bufferView:i[0],componentType:(e=>{switch(e){case 0:return 5121;case 1:return 5123;case 2:return 5125}return 0})(c.getFormat()),count:c.getNumIndices(),type:"SCALAR"};r.indices=t.accessors.push(s)-1;}return r}writeSkins(e,t){e.skins.length>0&&(t.skins=e.skins.map(i=>{let s=new Float32Array(16*i.inverseBindPose.length);for(let e=0;e<i.inverseBindPose.length;e++){let t=i.inverseBindPose[e];s.set(t.data,16*e);}let r=s.buffer;wi.writeBufferView(e,t,r),e.buffers.push(r);let a={bufferView:e.bufferViewMap.get(r)[0],componentType:E9(6),count:i.inverseBindPose.length,type:"MAT4"};return {inverseBindMatrices:t.accessors.push(a)-1,joints:i.boneNames.map(t=>{let i=e.entities.find(e=>e.name===t);return e.entities.indexOf(i)})}}));}convertTextures(e,t){let i={maxTextureSize:t.maxTextureSize},s=[];return e.forEach(e=>{let t=this.textureToCanvas(e,i);t.then(e=>new Promise(t=>t(e))),s.push(t);}),s}writeTextures(e,t,i,s){let r=e.textures,a=[];for(let s=0;s<t.length;s++){let n=r[s],o=t[s],l=function(e){let t=e.getContext("2d").getImageData(0,0,e.width,e.height).data;for(let e=3;e<t.length;e+=4)if(t[e]<255)return  true;return  false}(o)||!e.compressableTexture.has(n)?"image/png":"image/jpeg";a.push(this.getBlob(o,l).then(e=>{let t=new FileReader;return t.readAsArrayBuffer(e),new Promise(e=>{t.onloadend=()=>{e(t);};})}).then(t=>{let r=this.getPaddedArrayBuffer(t.result);wi.writeBufferView(e,i,r),e.buffers.push(r);let a=e.bufferViewMap.get(r);i.images[s]={mimeType:l,bufferView:a[0]},i.samplers[s]={minFilter:E7(n.minFilter),magFilter:E7(n.magFilter),wrapS:we(n.addressU),wrapT:we(n.addressV)},i.textures[s]={sampler:s,source:s};}));}return Promise.all(a)}getBlob(e,t){if(void 0!==e.toBlob)return new Promise(i=>{e.toBlob(i,t);});let i=1;return "image/jpeg"===t&&(i=.92),e.convertToBlob({type:t,quality:i})}getPaddedArrayBuffer(e,t=0){let i=ei.roundUp(e.byteLength,4);if(i!==e.byteLength){let s=new Uint8Array(i);if(s.set(new Uint8Array(e)),0!==t)for(let r=e.byteLength;r<i;r++)s[r]=t;return s.buffer}return e}buildJson(e,t){return Promise.all(this.convertTextures(e.textures,t)).then(async i=>{let s={asset:{version:"2.0",generator:"PlayCanvas GltfExporter"},scenes:[{nodes:[0]}],images:[],samplers:[],textures:[],scene:0};return this.writeBufferViews(e,s),this.writeCameras(e,s),this.writeMeshes(e,s,t),this.writeMaterials(e,s),this.writeNodes(e,s,t),this.writeSkins(e,s),await this.writeTextures(e,i,s,t),s.images.length||delete s.images,s.samplers.length||delete s.samplers,s.textures.length||delete s.textures,s})}build(e,t={}){let i=this.collectResources(e);return this.buildJson(i,t).then(e=>{let t=new TextEncoder().encode(JSON.stringify(e)),s=t.length,r=4-(3&s)&3,a=e.buffers.reduce((e,t)=>ei.roundUp(e+t.byteLength,4),0),n=20+s+r;a>0&&(n+=8+a);let o=new ArrayBuffer(n),l=new DataView(o);l.setUint32(0,0x46546c67,true),l.setUint32(4,2,true),l.setUint32(8,n,true),l.setUint32(12,s+r,true),l.setUint32(16,0x4e4f534a,true);let h=20;new Uint8Array(o,20,s).set(t),h+=s;for(let e=0;e<r;e++)l.setUint8(h+e,32);return h+=r,a>0&&(l.setUint32(h,a,true),l.setUint32(h+4,5130562,true),h+=8,i.buffers.forEach(t=>{let s,r=i.bufferViewMap.get(t)[0],a=e.bufferViews[r].byteOffset;if(t instanceof ArrayBuffer)s=new Uint8Array(t);else {let e=t.lock();s=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength);}new Uint8Array(o,h+a,s.byteLength).set(s);})),Promise.resolve(o)})}}let ws="none",wr="lighting",wa="combine";var wn=`
uniform sampler2D sourceTexture;
uniform vec2 sourceInvResolution;
varying vec2 uv0;
#ifdef PREMULTIPLY
	uniform sampler2D premultiplyTexture;
#endif
void main()
{
	vec3 e = texture2D (sourceTexture, uv0).rgb;
	#ifdef BOXFILTER
		vec3 value = e;
		#ifdef PREMULTIPLY
			float premultiply = texture2D(premultiplyTexture, uv0).{PREMULTIPLY_SRC_CHANNEL};
			value *= vec3(premultiply);
		#endif
	#else
		float x = sourceInvResolution.x;
		float y = sourceInvResolution.y;
		vec3 a = texture2D(sourceTexture, vec2 (uv0.x - 2.0 * x, uv0.y + 2.0 * y)).rgb;
		vec3 b = texture2D(sourceTexture, vec2 (uv0.x,		   uv0.y + 2.0 * y)).rgb;
		vec3 c = texture2D(sourceTexture, vec2 (uv0.x + 2.0 * x, uv0.y + 2.0 * y)).rgb;
		vec3 d = texture2D(sourceTexture, vec2 (uv0.x - 2.0 * x, uv0.y)).rgb;
		vec3 f = texture2D(sourceTexture, vec2 (uv0.x + 2.0 * x, uv0.y)).rgb;
		vec3 g = texture2D(sourceTexture, vec2 (uv0.x - 2.0 * x, uv0.y - 2.0 * y)).rgb;
		vec3 h = texture2D(sourceTexture, vec2 (uv0.x,		   uv0.y - 2.0 * y)).rgb;
		vec3 i = texture2D(sourceTexture, vec2 (uv0.x + 2.0 * x, uv0.y - 2.0 * y)).rgb;
		vec3 j = texture2D(sourceTexture, vec2 (uv0.x - x, uv0.y + y)).rgb;
		vec3 k = texture2D(sourceTexture, vec2 (uv0.x + x, uv0.y + y)).rgb;
		vec3 l = texture2D(sourceTexture, vec2 (uv0.x - x, uv0.y - y)).rgb;
		vec3 m = texture2D(sourceTexture, vec2 (uv0.x + x, uv0.y - y)).rgb;
		vec3 value = e * 0.125;
		value += (a + c + g + i) * 0.03125;
		value += (b + d + f + h) * 0.0625;
		value += (j + k + l + m) * 0.125;
	#endif
	#ifdef REMOVE_INVALID
		value = max(value, vec3(0.0));
	#endif
	gl_FragColor = vec4(value, 1.0);
}
`,wo=`
var sourceTexture: texture_2d<f32>;
var sourceTextureSampler: sampler;
uniform sourceInvResolution: vec2f;
varying uv0: vec2f;
#ifdef PREMULTIPLY
	var premultiplyTexture: texture_2d<f32>;
	var premultiplyTextureSampler: sampler;
#endif
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let e: vec3f = textureSample(sourceTexture, sourceTextureSampler, input.uv0).rgb;
	#ifdef BOXFILTER
		var value: vec3f = e;
		#ifdef PREMULTIPLY
			let premultiply: f32 = textureSample(premultiplyTexture, premultiplyTextureSampler, input.uv0).{PREMULTIPLY_SRC_CHANNEL};
			value = value * vec3f(premultiply);
		#endif
	#else
		let x: f32 = uniform.sourceInvResolution.x;
		let y: f32 = uniform.sourceInvResolution.y;
		let a: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - 2.0 * x, input.uv0.y + 2.0 * y)).rgb;
		let b: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x,		   input.uv0.y + 2.0 * y)).rgb;
		let c: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + 2.0 * x, input.uv0.y + 2.0 * y)).rgb;
		let d: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - 2.0 * x, input.uv0.y)).rgb;
		let f: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + 2.0 * x, input.uv0.y)).rgb;
		let g: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - 2.0 * x, input.uv0.y - 2.0 * y)).rgb;
		let h: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x,		   input.uv0.y - 2.0 * y)).rgb;
		let i: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + 2.0 * x, input.uv0.y - 2.0 * y)).rgb;
		let j: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - x, input.uv0.y + y)).rgb;
		let k: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + x, input.uv0.y + y)).rgb;
		let l: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - x, input.uv0.y - y)).rgb;
		let m: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + x, input.uv0.y - y)).rgb;
		var value: vec3f = e * 0.125;
		value = value + (a + c + g + i) * 0.03125;
		value = value + (b + d + f + h) * 0.0625;
		value = value + (j + k + l + m) * 0.125;
	#endif
	#ifdef REMOVE_INVALID
		value = max(value, vec3f(0.0));
	#endif
	output.color = vec4f(value, 1.0);
	return output;
}
`;class wl extends dT{setSourceTexture(e){this._sourceTexture=e,this.options.resizeSource=e;}execute(){this.sourceTextureId.setValue(this.sourceTexture),this.premultiplyTexture&&this.premultiplyTextureId.setValue(this.premultiplyTexture),this.sourceInvResolutionValue[0]=1/this.sourceTexture.width,this.sourceInvResolutionValue[1]=1/this.sourceTexture.height,this.sourceInvResolutionId.setValue(this.sourceInvResolutionValue),super.execute();}constructor(e,t,i={}){super(e),this.sourceTexture=t,this.premultiplyTexture=i.premultiplyTexture,nH.get(e,tz).set("downsamplePS",wn),nH.get(e,tV).set("downsamplePS",wo);let s=i.boxFilter??false,r=`${s?"Box":""}-${i.premultiplyTexture?"Premultiply":""}-${i.premultiplySrcChannel??""}-${i.removeInvalid?"RemoveInvalid":""}`,a=new Map;s&&a.set("BOXFILTER",""),i.premultiplyTexture&&a.set("PREMULTIPLY",""),i.removeInvalid&&a.set("REMOVE_INVALID",""),a.set("{PREMULTIPLY_SRC_CHANNEL}",i.premultiplySrcChannel??"x"),this.shader=nY.createShader(e,{uniqueName:`DownSampleShader:${r}`,attributes:{aPosition:e6},vertexChunk:"quadVS",fragmentChunk:"downsamplePS",fragmentDefines:a}),this.sourceTextureId=e.scope.resolve("sourceTexture"),this.premultiplyTextureId=e.scope.resolve("premultiplyTexture"),this.sourceInvResolutionId=e.scope.resolve("sourceInvResolution"),this.sourceInvResolutionValue=new Float32Array(2);}}var wh=`
	uniform sampler2D sourceTexture;
	uniform vec2 sourceInvResolution;
	varying vec2 uv0;
	void main()
	{
		float x = sourceInvResolution.x;
		float y = sourceInvResolution.y;
		vec3 a = texture2D (sourceTexture, vec2 (uv0.x - x, uv0.y + y)).rgb;
		vec3 b = texture2D (sourceTexture, vec2 (uv0.x,	 uv0.y + y)).rgb;
		vec3 c = texture2D (sourceTexture, vec2 (uv0.x + x, uv0.y + y)).rgb;
		vec3 d = texture2D (sourceTexture, vec2 (uv0.x - x, uv0.y)).rgb;
		vec3 e = texture2D (sourceTexture, vec2 (uv0.x,	 uv0.y)).rgb;
		vec3 f = texture2D (sourceTexture, vec2 (uv0.x + x, uv0.y)).rgb;
		vec3 g = texture2D (sourceTexture, vec2 (uv0.x - x, uv0.y - y)).rgb;
		vec3 h = texture2D (sourceTexture, vec2 (uv0.x,	 uv0.y - y)).rgb;
		vec3 i = texture2D (sourceTexture, vec2 (uv0.x + x, uv0.y - y)).rgb;
		vec3 value = e * 4.0;
		value += (b + d + f + h) * 2.0;
		value += (a + c + g + i);
		value *= 1.0 / 16.0;
		gl_FragColor = vec4(value, 1.0);
	}
`,wc=`
	var sourceTexture: texture_2d<f32>;
	var sourceTextureSampler: sampler;
	uniform sourceInvResolution: vec2f;
	varying uv0: vec2f;
	@fragment
	fn fragmentMain(input: FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		let x: f32 = uniform.sourceInvResolution.x;
		let y: f32 = uniform.sourceInvResolution.y;
		let a: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - x, input.uv0.y + y)).rgb;
		let b: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x,	 input.uv0.y + y)).rgb;
		let c: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + x, input.uv0.y + y)).rgb;
		let d: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - x, input.uv0.y)).rgb;
		let e: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x,	 input.uv0.y)).rgb;
		let f: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + x, input.uv0.y)).rgb;
		let g: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x - x, input.uv0.y - y)).rgb;
		let h: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x,	 input.uv0.y - y)).rgb;
		let i: vec3f = textureSample(sourceTexture, sourceTextureSampler, vec2f(input.uv0.x + x, input.uv0.y - y)).rgb;
		var value: vec3f = e * 4.0;
		value = value + (b + d + f + h) * 2.0;
		value = value + (a + c + g + i);
		value = value * (1.0 / 16.0);
		output.color = vec4f(value, 1.0);
		return output;
	}
`;class wd extends dT{execute(){this.sourceTextureId.setValue(this.sourceTexture),this.sourceInvResolutionValue[0]=1/this.sourceTexture.width,this.sourceInvResolutionValue[1]=1/this.sourceTexture.height,this.sourceInvResolutionId.setValue(this.sourceInvResolutionValue),super.execute();}constructor(e,t){super(e),this.sourceTexture=t,nH.get(e,tz).set("upsamplePS",wh),nH.get(e,tV).set("upsamplePS",wc),this.shader=nY.createShader(e,{uniqueName:"UpSampleShader",attributes:{aPosition:e6},vertexChunk:"quadVS",fragmentChunk:"upsamplePS"}),this.sourceTextureId=e.scope.resolve("sourceTexture"),this.sourceInvResolutionId=e.scope.resolve("sourceInvResolution"),this.sourceInvResolutionValue=new Float32Array(2);}}class wu extends as{destroy(){this.destroyRenderPasses(),this.destroyRenderTargets();}destroyRenderTargets(e=0){for(let t=e;t<this.renderTargets.length;t++){let e=this.renderTargets[t];e.destroyTextureBuffers(),e.destroy();}this.renderTargets.length=0;}destroyRenderPasses(){for(let e=0;e<this.beforePasses.length;e++)this.beforePasses[e].destroy();this.beforePasses.length=0;}createRenderTarget(e){return new iU({depth:false,colorBuffer:new ih(this.device,{name:`BloomTexture${e}`,width:1,height:1,format:this.textureFormat,mipmaps:false,minFilter:1,magFilter:1,addressU:1,addressV:1})})}createRenderTargets(e){for(let t=0;t<e;t++){let e=0===t?this.bloomRenderTarget:this.createRenderTarget(t);this.renderTargets.push(e);}}calcMipLevels(e,t,i){return Math.floor(Math.log2(Math.min(e,t))-Math.log2(i))}createRenderPasses(e){let t=this.device,i=this._sourceTexture;for(let s=0;s<e;s++){let e=new wl(t,i),r=this.renderTargets[s];e.init(r,{resizeSource:i,scaleX:.5,scaleY:.5}),e.setClearColor(es.BLACK),this.beforePasses.push(e),i=r.colorBuffer;}i=this.renderTargets[e-1].colorBuffer;for(let s=e-2;s>=0;s--){let e=new wd(t,i),r=this.renderTargets[s];e.init(r),e.blendState=iS.ADDBLEND,this.beforePasses.push(e),i=r.colorBuffer;}}onDisable(){this.renderTargets[0]?.resize(1,1),this.destroyRenderPasses(),this.destroyRenderTargets(1);}frameUpdate(){super.frameUpdate();let e=this.calcMipLevels(this._sourceTexture.width,this._sourceTexture.height,1),t=ei.clamp(e,1,this.blurLevel);this.renderTargets.length!==t&&(this.destroyRenderPasses(),this.destroyRenderTargets(1),this.createRenderTargets(t),this.createRenderPasses(t));}constructor(e,t,i){super(e),this.blurLevel=16,this.renderTargets=[],this._sourceTexture=t,this.textureFormat=i,this.bloomRenderTarget=this.createRenderTarget(0),this.bloomTexture=this.bloomRenderTarget.colorBuffer;}}let wf={composePS:`
	#include "tonemappingPS"
	#include "gammaPS"
	varying vec2 uv0;
	uniform sampler2D sceneTexture;
	uniform vec2 sceneTextureInvRes;
	#include "composeBloomPS"
	#include "composeDofPS"
	#include "composeSsaoPS"
	#include "composeGradingPS"
	#include "composeVignettePS"
	#include "composeFringingPS"
	#include "composeCasPS"
	#include "composeColorLutPS"
	#include "composeDeclarationsPS"
	void main() {
		#include "composeMainStartPS"
		vec2 uv = uv0;
		#ifdef TAA
		#ifdef WEBGPU
			uv.y = 1.0 - uv.y;
		#endif
		#endif
		vec4 scene = texture2DLod(sceneTexture, uv, 0.0);
		vec3 result = scene.rgb;
		#ifdef CAS
			result = applyCas(result, uv, sharpness);
		#endif
		#ifdef DOF
			result = applyDof(result, uv0);
		#endif
		#ifdef SSAO_TEXTURE
			result = applySsao(result, uv0);
		#endif
		#ifdef FRINGING
			result = applyFringing(result, uv);
		#endif
		#ifdef BLOOM
			result = applyBloom(result, uv0);
		#endif
		#ifdef GRADING
			result = applyGrading(result);
		#endif
		result = toneMap(max(vec3(0.0), result));
		#ifdef COLOR_LUT
			result = applyColorLUT(result);
		#endif
		#ifdef VIGNETTE
			result = applyVignette(result, uv);
		#endif
		#include "composeMainEndPS"
		#ifdef DEBUG_COMPOSE
			#if DEBUG_COMPOSE == scene
				result = scene.rgb;
			#elif defined(BLOOM) && DEBUG_COMPOSE == bloom
				result = dBloom * bloomIntensity;
			#elif defined(DOF) && DEBUG_COMPOSE == dofcoc
				result = vec3(dCoc, 0.0);
			#elif defined(DOF) && DEBUG_COMPOSE == dofblur
				result = dBlur;
			#elif defined(SSAO_TEXTURE) && DEBUG_COMPOSE == ssao
				result = vec3(dSsao);
			#elif defined(VIGNETTE) && DEBUG_COMPOSE == vignette
				result = vec3(dVignette);
			#endif
		#endif
		result = gammaCorrectOutput(result);
		gl_FragColor = vec4(result, scene.a);
	}
`,composeBloomPS:`
	#ifdef BLOOM
		uniform sampler2D bloomTexture;
		uniform float bloomIntensity;
		
		vec3 dBloom;
		
		vec3 applyBloom(vec3 color, vec2 uv) {
			dBloom = texture2DLod(bloomTexture, uv, 0.0).rgb;
			return color + dBloom * bloomIntensity;
		}
	#endif
`,composeDofPS:`
	#ifdef DOF
		uniform sampler2D cocTexture;
		uniform sampler2D blurTexture;
		
		vec2 dCoc;
		vec3 dBlur;
		vec3 getDofBlur(vec2 uv) {
			dCoc = texture2DLod(cocTexture, uv, 0.0).rg;
			#if DOF_UPSCALE
				vec2 blurTexelSize = 1.0 / vec2(textureSize(blurTexture, 0));
				vec3 bilinearBlur = vec3(0.0);
				float totalWeight = 0.0;
				for (int i = -1; i <= 1; i++) {
					for (int j = -1; j <= 1; j++) {
						vec2 offset = vec2(i, j) * blurTexelSize;
						vec2 cocSample = texture2DLod(cocTexture, uv + offset, 0.0).rg;
						vec3 blurSample = texture2DLod(blurTexture, uv + offset, 0.0).rgb;
						float cocWeight = clamp(cocSample.r + cocSample.g, 0.0, 1.0);
						bilinearBlur += blurSample * cocWeight;
						totalWeight += cocWeight;
					}
				}
				if (totalWeight > 0.0) {
					bilinearBlur /= totalWeight;
				}
				dBlur = bilinearBlur;
				return bilinearBlur;
			#else
				dBlur = texture2DLod(blurTexture, uv, 0.0).rgb;
				return dBlur;
			#endif
		}
		vec3 applyDof(vec3 color, vec2 uv) {
			vec3 blur = getDofBlur(uv);
			return mix(color, blur, dCoc.r + dCoc.g);
		}
	#endif
`,composeSsaoPS:`
	#ifdef SSAO
		#define SSAO_TEXTURE
	#endif
	#if DEBUG_COMPOSE == ssao
		#define SSAO_TEXTURE
	#endif
	#ifdef SSAO_TEXTURE
		uniform sampler2D ssaoTexture;
		
		float dSsao;
		
		vec3 applySsao(vec3 color, vec2 uv) {
			dSsao = texture2DLod(ssaoTexture, uv, 0.0).r;
			
			#ifdef SSAO
				return color * dSsao;
			#else
				return color;
			#endif
		}
	#endif
`,composeGradingPS:`
	#ifdef GRADING
		uniform vec3 brightnessContrastSaturation;
		uniform vec3 tint;
		vec3 colorGradingHDR(vec3 color, float brt, float sat, float con) {
			color *= tint;
			color = color * brt;
			float grey = dot(color, vec3(0.3, 0.59, 0.11));
			grey = grey / max(1.0, max(color.r, max(color.g, color.b)));
			color = mix(vec3(grey), color, sat);
			return mix(vec3(0.5), color, con);
		}
		vec3 applyGrading(vec3 color) {
			return colorGradingHDR(color, 
				brightnessContrastSaturation.x, 
				brightnessContrastSaturation.z, 
				brightnessContrastSaturation.y);
		}
	#endif
`,composeVignettePS:`
	#ifdef VIGNETTE
		uniform vec4 vignetterParams;
		uniform vec3 vignetteColor;
		
		float dVignette;
		
		float calcVignette(vec2 uv) {
			float inner = vignetterParams.x;
			float outer = vignetterParams.y;
			float curvature = vignetterParams.z;
			float intensity = vignetterParams.w;
			vec2 curve = pow(abs(uv * 2.0 -1.0), vec2(1.0 / curvature));
			float edge = pow(length(curve), curvature);
			dVignette = 1.0 - intensity * smoothstep(inner, outer, edge);
			return dVignette;
		}
		vec3 applyVignette(vec3 color, vec2 uv) {
			return mix(vignetteColor, color, calcVignette(uv));
		}
	#endif
`,composeFringingPS:`
	#ifdef FRINGING
		uniform float fringingIntensity;
		vec3 applyFringing(vec3 color, vec2 uv) {
			vec2 centerDistance = uv - 0.5;
			vec2 offset = fringingIntensity * centerDistance * centerDistance;
			color.r = texture2D(sceneTexture, uv - offset).r;
			color.b = texture2D(sceneTexture, uv + offset).b;
			return color;
		}
	#endif
`,composeCasPS:`
	#ifdef CAS
		uniform float sharpness;
		float maxComponent(float x, float y, float z) { return max(x, max(y, z)); }
		vec3 toSDR(vec3 c) { return c / (1.0 + maxComponent(c.r, c.g, c.b)); }
		vec3 toHDR(vec3 c) { return c / (1.0 - maxComponent(c.r, c.g, c.b)); }
		vec3 applyCas(vec3 color, vec2 uv, float sharpness) {
			float x = sceneTextureInvRes.x;
			float y = sceneTextureInvRes.y;
			vec3 a = toSDR(texture2DLod(sceneTexture, uv + vec2(0.0, -y), 0.0).rgb);
			vec3 b = toSDR(texture2DLod(sceneTexture, uv + vec2(-x, 0.0), 0.0).rgb);
			vec3 c = toSDR(color.rgb);
			vec3 d = toSDR(texture2DLod(sceneTexture, uv + vec2(x, 0.0), 0.0).rgb);
			vec3 e = toSDR(texture2DLod(sceneTexture, uv + vec2(0.0, y), 0.0).rgb);
			float min_g = min(a.g, min(b.g, min(c.g, min(d.g, e.g))));
			float max_g = max(a.g, max(b.g, max(c.g, max(d.g, e.g))));
			float sharpening_amount = sqrt(min(1.0 - max_g, min_g) / max_g);
			float w = sharpening_amount * sharpness;
			vec3 res = (w * (a + b + d + e) + c) / (4.0 * w + 1.0);
			res = max(res, 0.0);
			return toHDR(res);
		}
	#endif
`,composeColorLutPS:`
	#ifdef COLOR_LUT
		uniform sampler2D colorLUT;
		uniform vec4 colorLUTParams;
		vec3 applyColorLUT(vec3 color) {
			vec3 c = clamp(color, 0.0, 1.0);
			float width = colorLUTParams.x;
			float height = colorLUTParams.y;
			float maxColor = colorLUTParams.z;
			float cell = c.b * maxColor;
			float cell_l = floor(cell);
			float cell_h = ceil(cell);
			float half_px_x = 0.5 / width;
			float half_px_y = 0.5 / height;
			float r_offset = half_px_x + c.r / height * (maxColor / height);
			float g_offset = half_px_y + c.g * (maxColor / height);
			vec2 uv_l = vec2(cell_l / height + r_offset, g_offset);
			vec2 uv_h = vec2(cell_h / height + r_offset, g_offset);
			vec3 color_l = texture2DLod(colorLUT, uv_l, 0.0).rgb;
			vec3 color_h = texture2DLod(colorLUT, uv_h, 0.0).rgb;
			vec3 lutColor = mix(color_l, color_h, fract(cell));
			return mix(color, lutColor, colorLUTParams.w);
		}
	#endif
`,composeDeclarationsPS:"",composeMainStartPS:"",composeMainEndPS:""},wp={composePS:`
	#include "tonemappingPS"
	#include "gammaPS"
	varying uv0: vec2f;
	var sceneTexture: texture_2d<f32>;
	var sceneTextureSampler: sampler;
	uniform sceneTextureInvRes: vec2f;
	#include "composeBloomPS"
	#include "composeDofPS"
	#include "composeSsaoPS"
	#include "composeGradingPS"
	#include "composeVignettePS"
	#include "composeFringingPS"
	#include "composeCasPS"
	#include "composeColorLutPS"
	#include "composeDeclarationsPS"
	@fragment
	fn fragmentMain(input: FragmentInput) -> FragmentOutput {
		#include "composeMainStartPS"
		var output: FragmentOutput;
		var uv = uv0;
		#ifdef TAA
			uv.y = 1.0 - uv.y;
		#endif
		let scene = textureSampleLevel(sceneTexture, sceneTextureSampler, uv, 0.0);
		var result = scene.rgb;
		#ifdef CAS
			result = applyCas(result, uv, uniform.sharpness);
		#endif
		#ifdef DOF
			result = applyDof(result, uv0);
		#endif
		#ifdef SSAO_TEXTURE
			result = applySsao(result, uv0);
		#endif
		#ifdef FRINGING
			result = applyFringing(result, uv);
		#endif
		#ifdef BLOOM
			result = applyBloom(result, uv0);
		#endif
		#ifdef GRADING
			result = applyGrading(result);
		#endif
		result = toneMap(max(vec3f(0.0), result));
		#ifdef COLOR_LUT
			result = applyColorLUT(result);
		#endif
		#ifdef VIGNETTE
			result = applyVignette(result, uv);
		#endif
		#include "composeMainEndPS"
		#ifdef DEBUG_COMPOSE
			#if DEBUG_COMPOSE == scene
				result = scene.rgb;
			#elif defined(BLOOM) && DEBUG_COMPOSE == bloom
				result = dBloom * uniform.bloomIntensity;
			#elif defined(DOF) && DEBUG_COMPOSE == dofcoc
				result = vec3f(dCoc, 0.0);
			#elif defined(DOF) && DEBUG_COMPOSE == dofblur
				result = dBlur;
			#elif defined(SSAO_TEXTURE) && DEBUG_COMPOSE == ssao
				result = vec3f(dSsao);
			#elif defined(VIGNETTE) && DEBUG_COMPOSE == vignette
				result = vec3f(dVignette);
			#endif
		#endif
		result = gammaCorrectOutput(result);
		output.color = vec4f(result, scene.a);
		return output;
	}
`,composeBloomPS:`
	#ifdef BLOOM
		var bloomTexture: texture_2d<f32>;
		var bloomTextureSampler: sampler;
		uniform bloomIntensity: f32;
		
		var<private> dBloom: vec3f;
		
		fn applyBloom(color: vec3f, uv: vec2f) -> vec3f {
			dBloom = textureSampleLevel(bloomTexture, bloomTextureSampler, uv, 0.0).rgb;
			return color + dBloom * uniform.bloomIntensity;
		}
	#endif
`,composeDofPS:`
	#ifdef DOF
		var cocTexture: texture_2d<f32>;
		var cocTextureSampler: sampler;
		var blurTexture: texture_2d<f32>;
		var blurTextureSampler: sampler;
		
		var<private> dCoc: vec2f;
		var<private> dBlur: vec3f;
		fn getDofBlur(uv: vec2f) -> vec3f {
			dCoc = textureSampleLevel(cocTexture, cocTextureSampler, uv, 0.0).rg;
			#if DOF_UPSCALE
				let blurTexelSize = 1.0 / vec2f(textureDimensions(blurTexture, 0));
				var bilinearBlur = vec3f(0.0);
				var totalWeight = 0.0;
				for (var i = -1; i <= 1; i++) {
					for (var j = -1; j <= 1; j++) {
						let offset = vec2f(f32(i), f32(j)) * blurTexelSize;
						let cocSample = textureSampleLevel(cocTexture, cocTextureSampler, uv + offset, 0.0).rg;
						let blurSample = textureSampleLevel(blurTexture, blurTextureSampler, uv + offset, 0.0).rgb;
						let cocWeight = clamp(cocSample.r + cocSample.g, 0.0, 1.0);
						bilinearBlur += blurSample * cocWeight;
						totalWeight += cocWeight;
					}
				}
				if (totalWeight > 0.0) {
					bilinearBlur /= totalWeight;
				}
				dBlur = bilinearBlur;
				return bilinearBlur;
			#else
				dBlur = textureSampleLevel(blurTexture, blurTextureSampler, uv, 0.0).rgb;
				return dBlur;
			#endif
		}
		fn applyDof(color: vec3f, uv: vec2f) -> vec3f {
			let blur = getDofBlur(uv);
			return mix(color, blur, dCoc.r + dCoc.g);
		}
	#endif
`,composeSsaoPS:`
	#ifdef SSAO
		#define SSAO_TEXTURE
	#endif
	#if DEBUG_COMPOSE == ssao
		#define SSAO_TEXTURE
	#endif
	#ifdef SSAO_TEXTURE
		var ssaoTexture: texture_2d<f32>;
		var ssaoTextureSampler: sampler;
		
		var<private> dSsao: f32;
		
		fn applySsao(color: vec3f, uv: vec2f) -> vec3f {
			dSsao = textureSampleLevel(ssaoTexture, ssaoTextureSampler, uv, 0.0).r;
			
			#ifdef SSAO
				return color * dSsao;
			#else
				return color;
			#endif
		}
	#endif
`,composeGradingPS:`
	#ifdef GRADING
		uniform brightnessContrastSaturation: vec3f;
		uniform tint: vec3f;
		fn colorGradingHDR(color: vec3f, brt: f32, sat: f32, con: f32) -> vec3f {
			var colorOut = color * uniform.tint;
			colorOut = colorOut * brt;
			let grey = dot(colorOut, vec3f(0.3, 0.59, 0.11));
			let normalizedGrey = grey / max(1.0, max(colorOut.r, max(colorOut.g, colorOut.b)));
			colorOut = mix(vec3f(normalizedGrey), colorOut, sat);
			return mix(vec3f(0.5), colorOut, con);
		}
		fn applyGrading(color: vec3f) -> vec3f {
			return colorGradingHDR(color, 
				uniform.brightnessContrastSaturation.x, 
				uniform.brightnessContrastSaturation.z, 
				uniform.brightnessContrastSaturation.y);
		}
	#endif
`,composeVignettePS:`
	#ifdef VIGNETTE
		uniform vignetterParams: vec4f;
		uniform vignetteColor: vec3f;
		
		var<private> dVignette: f32;
		
		fn calcVignette(uv: vec2f) -> f32 {
			let inner = uniform.vignetterParams.x;
			let outer = uniform.vignetterParams.y;
			let curvature = uniform.vignetterParams.z;
			let intensity = uniform.vignetterParams.w;
			let curve = pow(abs(uv * 2.0 - 1.0), vec2f(1.0 / curvature));
			let edge = pow(length(curve), curvature);
			dVignette = 1.0 - intensity * smoothstep(inner, outer, edge);
			return dVignette;
		}
		fn applyVignette(color: vec3f, uv: vec2f) -> vec3f {
			return mix(uniform.vignetteColor, color, calcVignette(uv));
		}
	#endif
`,composeFringingPS:`
	#ifdef FRINGING
		uniform fringingIntensity: f32;
		fn applyFringing(color: vec3f, uv: vec2f) -> vec3f {
			let centerDistance = uv - 0.5;
			let offset = uniform.fringingIntensity * centerDistance * centerDistance;
			var colorOut = color;
			colorOut.r = textureSample(sceneTexture, sceneTextureSampler, uv - offset).r;
			colorOut.b = textureSample(sceneTexture, sceneTextureSampler, uv + offset).b;
			return colorOut;
		}
	#endif
`,composeCasPS:`
	#ifdef CAS
		uniform sharpness: f32;
		fn maxComponent(x: f32, y: f32, z: f32) -> f32 { return max(x, max(y, z)); }
		fn toSDR(c: vec3f) -> vec3f { return c / (1.0 + maxComponent(c.r, c.g, c.b)); }
		fn toHDR(c: vec3f) -> vec3f { return c / (1.0 - maxComponent(c.r, c.g, c.b)); }
		fn applyCas(color: vec3f, uv: vec2f, sharpness: f32) -> vec3f {
			let x = uniform.sceneTextureInvRes.x;
			let y = uniform.sceneTextureInvRes.y;
			let a = toSDR(textureSampleLevel(sceneTexture, sceneTextureSampler, uv + vec2f(0.0, -y), 0.0).rgb);
			let b = toSDR(textureSampleLevel(sceneTexture, sceneTextureSampler, uv + vec2f(-x, 0.0), 0.0).rgb);
			let c = toSDR(color.rgb);
			let d = toSDR(textureSampleLevel(sceneTexture, sceneTextureSampler, uv + vec2f(x, 0.0), 0.0).rgb);
			let e = toSDR(textureSampleLevel(sceneTexture, sceneTextureSampler, uv + vec2f(0.0, y), 0.0).rgb);
			let min_g = min(a.g, min(b.g, min(c.g, min(d.g, e.g))));
			let max_g = max(a.g, max(b.g, max(c.g, max(d.g, e.g))));
			let sharpening_amount = sqrt(min(1.0 - max_g, min_g) / max_g);
			let w = sharpening_amount * uniform.sharpness;
			var res = (w * (a + b + d + e) + c) / (4.0 * w + 1.0);
			res = max(res, vec3f(0.0));
			return toHDR(res);
		}
	#endif
`,composeColorLutPS:`
	#ifdef COLOR_LUT
		var colorLUT: texture_2d<f32>;
		var colorLUTSampler: sampler;
		uniform colorLUTParams: vec4f;
		fn applyColorLUT(color: vec3f) -> vec3f {
			var c: vec3f = clamp(color, vec3f(0.0), vec3f(1.0));
			let width: f32 = uniform.colorLUTParams.x;
			let height: f32 = uniform.colorLUTParams.y;
			let maxColor: f32 = uniform.colorLUTParams.z;
			let cell: f32 = c.b * maxColor;
			let cell_l: f32 = floor(cell);
			let cell_h: f32 = ceil(cell);
			let half_px_x: f32 = 0.5 / width;
			let half_px_y: f32 = 0.5 / height;
			let r_offset: f32 = half_px_x + c.r / height * (maxColor / height);
			let g_offset: f32 = half_px_y + c.g * (maxColor / height);
			let uv_l: vec2f = vec2f(cell_l / height + r_offset, g_offset);
			let uv_h: vec2f = vec2f(cell_h / height + r_offset, g_offset);
			let color_l: vec3f = textureSampleLevel(colorLUT, colorLUTSampler, uv_l, 0.0).rgb;
			let color_h: vec3f = textureSampleLevel(colorLUT, colorLUTSampler, uv_h, 0.0).rgb;
			let lutColor: vec3f = mix(color_l, color_h, fract(cell));
			return mix(color, lutColor, uniform.colorLUTParams.w);
		}
	#endif
`,composeDeclarationsPS:"",composeMainStartPS:"",composeMainEndPS:""};class wm extends dT{set debug(e){this._debug!==e&&(this._debug=e,this._shaderDirty=true);}get debug(){return this._debug}set colorLUT(e){this._colorLUT!==e&&(this._colorLUT=e,this._shaderDirty=true);}get colorLUT(){return this._colorLUT}set bloomTexture(e){this._bloomTexture!==e&&(this._bloomTexture=e,this._shaderDirty=true);}get bloomTexture(){return this._bloomTexture}set cocTexture(e){this._cocTexture!==e&&(this._cocTexture=e,this._shaderDirty=true);}get cocTexture(){return this._cocTexture}set ssaoTexture(e){this._ssaoTexture!==e&&(this._ssaoTexture=e,this._shaderDirty=true);}get ssaoTexture(){return this._ssaoTexture}set taaEnabled(e){this._taaEnabled!==e&&(this._taaEnabled=e,this._shaderDirty=true);}get taaEnabled(){return this._taaEnabled}set gradingEnabled(e){this._gradingEnabled!==e&&(this._gradingEnabled=e,this._shaderDirty=true);}get gradingEnabled(){return this._gradingEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._shaderDirty=true);}get vignetteEnabled(){return this._vignetteEnabled}set fringingEnabled(e){this._fringingEnabled!==e&&(this._fringingEnabled=e,this._shaderDirty=true);}get fringingEnabled(){return this._fringingEnabled}set toneMapping(e){this._toneMapping!==e&&(this._toneMapping=e,this._shaderDirty=true);}get toneMapping(){return this._toneMapping}set sharpness(e){this._sharpness!==e&&(this._sharpness=e,this._shaderDirty=true);}get sharpness(){return this._sharpness}get isSharpnessEnabled(){return this._sharpness>0}postInit(){this.setClearColor(es.BLACK),this.setClearDepth(1),this.setClearStencil(0);}frameUpdate(){let e=+!(this.renderTarget??this.device.backBuffer).isColorBufferSrgb(0);this._gammaCorrection!==e&&(this._gammaCorrection=e,this._shaderDirty=true);let t=nH.get(this.device,this.device.isWebGPU?tV:tz);for(let[e,i]of this._customComposeChunks.entries()){let s=t.get(e);s!==i&&(this._customComposeChunks.set(e,s),this._shaderDirty=true);}if(this._shaderDirty){this._shaderDirty=false;let e=na[this._gammaCorrection],i=this._customComposeChunks,s=iI(i.get("composeDeclarationsPS")??""),r=iI(i.get("composeMainStartPS")??""),a=iI(i.get("composeMainEndPS")??""),n=`${this.toneMapping}-${e}-${this.bloomTexture?"bloom":"nobloom"}-${this.cocTexture?"dof":"nodof"}-${this.blurTextureUpscale?"dofupscale":""}-${this.ssaoTexture?"ssao":"nossao"}-${this.gradingEnabled?"grading":"nograding"}-${this.colorLUT?"colorlut":"nocolorlut"}-${this.vignetteEnabled?"vignette":"novignette"}-${this.fringingEnabled?"fringing":"nofringing"}-${this.taaEnabled?"taa":"notaa"}-${this.isSharpnessEnabled?"cas":"nocas"}-${this._debug??""}-decl${s}-start${r}-end${a}`;if(this._key!==n){this._key=n;let i=new Map;i.set("TONEMAP",nn[this.toneMapping]),i.set("GAMMA",e),this.bloomTexture&&i.set("BLOOM",true),this.cocTexture&&i.set("DOF",true),this.blurTextureUpscale&&i.set("DOF_UPSCALE",true),this.ssaoTexture&&i.set("SSAO",true),this.gradingEnabled&&i.set("GRADING",true),this.colorLUT&&i.set("COLOR_LUT",true),this.vignetteEnabled&&i.set("VIGNETTE",true),this.fringingEnabled&&i.set("FRINGING",true),this.taaEnabled&&i.set("TAA",true),this.isSharpnessEnabled&&i.set("CAS",true),this._debug&&i.set("DEBUG_COMPOSE",this._debug);let s=new Map(t);this.shader=nY.createShader(this.device,{uniqueName:`ComposeShader-${n}`,attributes:{aPosition:e6},vertexChunk:"quadVS",fragmentChunk:"composePS",fragmentDefines:i,fragmentIncludes:s});}}}execute(){let e=this.sceneTexture;this.sceneTextureId.setValue(e),this.sceneTextureInvResValue[0]=1/e.width,this.sceneTextureInvResValue[1]=1/e.height,this.sceneTextureInvResId.setValue(this.sceneTextureInvResValue),this._bloomTexture&&(this.bloomTextureId.setValue(this._bloomTexture),this.bloomIntensityId.setValue(this.bloomIntensity)),this._cocTexture&&(this.cocTextureId.setValue(this._cocTexture),this.blurTextureId.setValue(this.blurTexture)),this._ssaoTexture&&this.ssaoTextureId.setValue(this._ssaoTexture),this._gradingEnabled&&(this.bcsId.setValue([this.gradingBrightness,this.gradingContrast,this.gradingSaturation]),this.tintId.setValue([this.gradingTint.r,this.gradingTint.g,this.gradingTint.b]));let t=this._colorLUT;t&&(this.colorLUTParams[0]=t.width,this.colorLUTParams[1]=t.height,this.colorLUTParams[2]=t.height-1,this.colorLUTParams[3]=this.colorLUTIntensity,this.colorLUTParamsId.setValue(this.colorLUTParams),this.colorLUTId.setValue(t)),this._vignetteEnabled&&(this.vignetterParamsId.setValue([this.vignetteInner,this.vignetteOuter,this.vignetteCurvature,this.vignetteIntensity]),this.vignetteColorId.setValue([this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b])),this._fringingEnabled&&this.fringingIntensityId.setValue(this.fringingIntensity/1024),this.isSharpnessEnabled&&this.sharpnessId.setValue(ei.lerp(-0.125,-0.2,this.sharpness)),super.execute();}constructor(e){super(e),this.sceneTexture=null,this.bloomIntensity=.01,this._bloomTexture=null,this._cocTexture=null,this.blurTexture=null,this.blurTextureUpscale=false,this._ssaoTexture=null,this._toneMapping=0,this._gradingEnabled=false,this.gradingSaturation=1,this.gradingContrast=1,this.gradingBrightness=1,this.gradingTint=new es(1,1,1,1),this._shaderDirty=true,this._vignetteEnabled=false,this.vignetteInner=.5,this.vignetteOuter=1,this.vignetteCurvature=.5,this.vignetteIntensity=.3,this.vignetteColor=new es(0,0,0),this._fringingEnabled=false,this.fringingIntensity=10,this._taaEnabled=false,this._sharpness=.5,this._gammaCorrection=1,this._colorLUT=null,this.colorLUTIntensity=1,this._key="",this._debug=null,this._customComposeChunks=new Map([["composeDeclarationsPS",""],["composeMainStartPS",""],["composeMainEndPS",""]]),nH.get(e,tz).add(wf,false),nH.get(e,tV).add(wp,false);let{scope:t}=e;this.sceneTextureId=t.resolve("sceneTexture"),this.bloomTextureId=t.resolve("bloomTexture"),this.cocTextureId=t.resolve("cocTexture"),this.ssaoTextureId=t.resolve("ssaoTexture"),this.blurTextureId=t.resolve("blurTexture"),this.bloomIntensityId=t.resolve("bloomIntensity"),this.bcsId=t.resolve("brightnessContrastSaturation"),this.tintId=t.resolve("tint"),this.vignetterParamsId=t.resolve("vignetterParams"),this.vignetteColorId=t.resolve("vignetteColor"),this.fringingIntensityId=t.resolve("fringingIntensity"),this.sceneTextureInvResId=t.resolve("sceneTextureInvRes"),this.sceneTextureInvResValue=new Float32Array(2),this.sharpnessId=t.resolve("sharpness"),this.colorLUTId=t.resolve("colorLUT"),this.colorLUTParams=new Float32Array(4),this.colorLUTParamsId=t.resolve("colorLUTParams");}}var w_=`
vec4 SampleTextureCatmullRom(TEXTURE_ACCEPT(tex), vec2 uv, vec2 texSize) {
	vec2 samplePos = uv * texSize;
	vec2 texPos1 = floor(samplePos - 0.5) + 0.5;
	vec2 f = samplePos - texPos1;
	vec2 w0 = f * (-0.5 + f * (1.0 - 0.5 * f));
	vec2 w1 = 1.0 + f * f * (-2.5 + 1.5 * f);
	vec2 w2 = f * (0.5 + f * (2.0 - 1.5 * f));
	vec2 w3 = f * f * (-0.5 + 0.5 * f);
	vec2 w12 = w1 + w2;
	vec2 offset12 = w2 / (w1 + w2);
	vec2 texPos0 = (texPos1 - 1.0) / texSize;
	vec2 texPos3 = (texPos1 + 2.0) / texSize;
	vec2 texPos12 = (texPos1 + offset12) / texSize;
	vec4 result = vec4(0.0);
	result += texture2DLod(tex, vec2(texPos0.x, texPos0.y), 0.0) * w0.x * w0.y;
	result += texture2DLod(tex, vec2(texPos12.x, texPos0.y), 0.0) * w12.x * w0.y;
	result += texture2DLod(tex, vec2(texPos3.x, texPos0.y), 0.0) * w3.x * w0.y;
	result += texture2DLod(tex, vec2(texPos0.x, texPos12.y), 0.0) * w0.x * w12.y;
	result += texture2DLod(tex, vec2(texPos12.x, texPos12.y), 0.0) * w12.x * w12.y;
	result += texture2DLod(tex, vec2(texPos3.x, texPos12.y), 0.0) * w3.x * w12.y;
	result += texture2DLod(tex, vec2(texPos0.x, texPos3.y), 0.0) * w0.x * w3.y;
	result += texture2DLod(tex, vec2(texPos12.x, texPos3.y), 0.0) * w12.x * w3.y;
	result += texture2DLod(tex, vec2(texPos3.x, texPos3.y), 0.0) * w3.x * w3.y;
	return result;
}
`,wg=`
fn SampleTextureCatmullRom(tex: texture_2d<f32>, texSampler: sampler, uv: vec2f, texSize: vec2f) -> vec4f {
	let samplePos: vec2f = uv * texSize;
	let texPos1: vec2f = floor(samplePos - 0.5) + 0.5;
	let f: vec2f = samplePos - texPos1;
	let w0: vec2f = f * (-0.5 + f * (1.0 - 0.5 * f));
	let w1: vec2f = 1.0 + f * f * (-2.5 + 1.5 * f);
	let w2: vec2f = f * (0.5 + f * (2.0 - 1.5 * f));
	let w3: vec2f = f * f * (-0.5 + 0.5 * f);
	let w12: vec2f = w1 + w2;
	let offset12: vec2f = w2 / w12;
	let texPos0: vec2f = (texPos1 - 1.0) / texSize;
	let texPos3: vec2f = (texPos1 + 2.0) / texSize;
	let texPos12: vec2f = (texPos1 + offset12) / texSize;
	var result: vec4f = vec4f(0.0);
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos0.x, texPos0.y), 0.0) * w0.x * w0.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos12.x, texPos0.y), 0.0) * w12.x * w0.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos3.x, texPos0.y), 0.0) * w3.x * w0.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos0.x, texPos12.y), 0.0) * w0.x * w12.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos12.x, texPos12.y), 0.0) * w12.x * w12.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos3.x, texPos12.y), 0.0) * w3.x * w12.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos0.x, texPos3.y), 0.0) * w0.x * w3.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos12.x, texPos3.y), 0.0) * w12.x * w3.y;
	result = result + textureSampleLevel(tex, texSampler, vec2f(texPos3.x, texPos3.y), 0.0) * w3.x * w3.y;
	return result;
}
`,wv=`
	#include  "sampleCatmullRomPS"
	#include  "screenDepthPS"
	uniform sampler2D sourceTexture;
	uniform sampler2D historyTexture;
	uniform mat4 matrix_viewProjectionPrevious;
	uniform mat4 matrix_viewProjectionInverse;
	uniform vec4 jitters;
	uniform vec2 textureSize;
	varying vec2 uv0;
	vec2 reproject(vec2 uv, float depth) {
		#ifndef WEBGPU
			depth = depth * 2.0 - 1.0;
		#endif
		vec4 ndc = vec4(uv * 2.0 - 1.0, depth, 1.0);
		ndc.xy -= jitters.xy;
		vec4 worldPosition = matrix_viewProjectionInverse * ndc;
		worldPosition /= worldPosition.w;
		vec4 screenPrevious = matrix_viewProjectionPrevious * worldPosition;
		return (screenPrevious.xy / screenPrevious.w) * 0.5 + 0.5;
	}
	vec4 colorClamp(vec2 uv, vec4 historyColor) {
		vec3 minColor = vec3(9999.0);
		vec3 maxColor = vec3(-9999.0);
		for(float x = -1.0; x <= 1.0; ++x) {
			for(float y = -1.0; y <= 1.0; ++y) {
				vec3 color = texture2D(sourceTexture, uv + vec2(x, y) / textureSize).rgb;
				minColor = min(minColor, color);
				maxColor = max(maxColor, color);
			}
		}
		vec3 clamped = clamp(historyColor.rgb, minColor, maxColor);
		return vec4(clamped, historyColor.a);
	}
	void main()
	{
		vec2 uv = uv0;
		#ifdef WEBGPU
			uv.y = 1.0 - uv.y;
		#endif
		vec4 srcColor = texture2D(sourceTexture, uv);
		float linearDepth = getLinearScreenDepth(uv0);
		float depth = delinearizeDepth(linearDepth);
		vec2 historyUv = reproject(uv0, depth);
		#ifdef QUALITY_HIGH
			vec4 historyColor = SampleTextureCatmullRom(TEXTURE_PASS(historyTexture), historyUv, textureSize);
		#else
			vec4 historyColor = texture2D(historyTexture, historyUv);
		#endif
		vec4 historyColorClamped = colorClamp(uv, historyColor);
		float mixFactor = (historyUv.x < 0.0 || historyUv.x > 1.0 || historyUv.y < 0.0 || historyUv.y > 1.0) ?
			1.0 : 0.05;
		gl_FragColor = mix(historyColorClamped, srcColor, mixFactor);
	}
`,wS=`
	#include "sampleCatmullRomPS"
	#include "screenDepthPS"
	var sourceTexture: texture_2d<f32>;
	var sourceTextureSampler: sampler;
	var historyTexture: texture_2d<f32>;
	var historyTextureSampler: sampler;
	uniform matrix_viewProjectionPrevious: mat4x4f;
	uniform matrix_viewProjectionInverse: mat4x4f;
	uniform jitters: vec4f;
	uniform textureSize: vec2f;
	varying uv0: vec2f;
	fn reproject(uv: vec2f, depth: f32) -> vec2f {
		var ndc = vec4f(uv * 2.0 - 1.0, depth, 1.0);
		ndc = vec4f(ndc.xy - uniform.jitters.xy, ndc.zw);
		var worldPosition = uniform.matrix_viewProjectionInverse * ndc;
		worldPosition = worldPosition / worldPosition.w;
		let screenPrevious = uniform.matrix_viewProjectionPrevious * worldPosition;
		return (screenPrevious.xy / screenPrevious.w) * 0.5 + 0.5;
	}
	fn colorClamp(uv: vec2f, historyColor: vec4f) -> vec4f {
		var minColor = vec3f(9999.0);
		var maxColor = vec3f(-9999.0);
		for (var ix: i32 = -1; ix <= 1; ix = ix + 1) {
			for (var iy: i32 = -1; iy <= 1; iy = iy + 1) {
				let color_sample = textureSample(sourceTexture, sourceTextureSampler, uv + vec2f(f32(ix), f32(iy)) / uniform.textureSize).rgb;
				minColor = min(minColor, color_sample);
				maxColor = max(maxColor, color_sample);
			}
		}
		let clamped = clamp(historyColor.rgb, minColor, maxColor);
		return vec4f(clamped, historyColor.a);
	}
	@fragment
	fn fragmentMain(input: FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		var uv = input.uv0;
		uv.y = 1.0 - uv.y;
		let srcColor = textureSample(sourceTexture, sourceTextureSampler, uv);
		let linearDepth = getLinearScreenDepth(uv0);
		let depth = delinearizeDepth(linearDepth);
		let historyUv = reproject(uv0, depth);
		#ifdef QUALITY_HIGH
			var historyColor: vec4f = SampleTextureCatmullRom(historyTexture, historyTextureSampler, historyUv, uniform.textureSize);
		#else
			var historyColor: vec4f = textureSample(historyTexture, historyTextureSampler, historyUv);
		#endif
		let historyColorClamped = colorClamp(uv, historyColor);
		let mixFactor_condition = historyUv.x < 0.0 || historyUv.x > 1.0 || historyUv.y < 0.0 || historyUv.y > 1.0;
		let mixFactor = select(0.05, 1.0, mixFactor_condition);
		output.color = mix(historyColorClamped, srcColor, mixFactor);
		return output;
	}
`;class wy extends dT{destroy(){this.renderTarget&&(this.renderTarget.destroyTextureBuffers(),this.renderTarget.destroy(),this.renderTarget=null);}setup(){for(let e=0;e<2;++e)this.historyTextures[e]=new ih(this.device,{name:`TAA-History-${e}`,width:4,height:4,format:this.sourceTexture.format,mipmaps:false,minFilter:1,magFilter:1,addressU:1,addressV:1}),this.historyRenderTargets[e]=new iU({colorBuffer:this.historyTextures[e],depth:false});this.historyTexture=this.historyTextures[0],this.init(this.historyRenderTargets[0],{resizeSource:this.sourceTexture});}before(){this.sourceTextureId.setValue(this.sourceTexture),this.historyTextureId.setValue(this.historyTextures[1-this.historyIndex]),this.textureSize[0]=this.sourceTexture.width,this.textureSize[1]=this.sourceTexture.height,this.textureSizeId.setValue(this.textureSize);let e=this.cameraComponent.camera;this.viewProjPrevId.setValue(e._viewProjPrevious.data),this.viewProjInvId.setValue(e._viewProjInverse.data),this.jittersId.setValue(e._jitters),this.cameraParamsId.setValue(e.fillShaderParams(this.cameraParams));}update(){return this.historyIndex=1-this.historyIndex,this.historyTexture=this.historyTextures[this.historyIndex],this.renderTarget=this.historyRenderTargets[this.historyIndex],this.historyTexture}constructor(e,t,i){super(e),this.historyIndex=0,this.historyTexture=null,this.historyTextures=[],this.historyRenderTargets=[],this.sourceTexture=t,this.cameraComponent=i,nH.get(e,tz).set("sampleCatmullRomPS",w_),nH.get(e,tV).set("sampleCatmullRomPS",wg),nH.get(e,tz).set("taaResolvePS",wv),nH.get(e,tV).set("taaResolvePS",wS);let s=new Map;s.set("QUALITY_HIGH",true),nY.addScreenDepthChunkDefines(e,i.shaderParams,s),this.shader=nY.createShader(e,{uniqueName:"TaaResolveShader",attributes:{aPosition:e6},vertexChunk:"quadVS",fragmentChunk:"taaResolvePS",fragmentDefines:s});let{scope:r}=e;this.sourceTextureId=r.resolve("sourceTexture"),this.textureSizeId=r.resolve("textureSize"),this.textureSize=new Float32Array(2),this.historyTextureId=r.resolve("historyTexture"),this.viewProjPrevId=r.resolve("matrix_viewProjectionPrevious"),this.viewProjInvId=r.resolve("matrix_viewProjectionInverse"),this.jittersId=r.resolve("jitters"),this.cameraParams=new Float32Array(4),this.cameraParamsId=r.resolve("camera_params"),this.setup();}}var wx=`
	#include "screenDepthPS"
	varying vec2 uv0;
	uniform vec3 params;
	void main()
	{
		float depth = getLinearScreenDepth(uv0);
		float focusDistance = params.x;
		float focusRange = params.y;
		float invRange = params.z;
		float farRange = focusDistance + focusRange * 0.5;
		
		float cocFar = min((depth - farRange) * invRange, 1.0);
		#ifdef NEAR_BLUR
			float nearRange = focusDistance - focusRange * 0.5;
			float cocNear = min((nearRange - depth) * invRange, 1.0);
		#else
			float cocNear = 0.0;
		#endif
		gl_FragColor = vec4(cocFar, cocNear, 0.0, 0.0);
	}
`,wT=`
#include "screenDepthPS"
varying uv0: vec2f;
uniform params: vec3f;
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let depth: f32 = getLinearScreenDepth(uv0);
	let focusDistance: f32 = uniform.params.x;
	let focusRange: f32 = uniform.params.y;
	let invRange: f32 = uniform.params.z;
	let farRange: f32 = focusDistance + focusRange * 0.5;
	let cocFar: f32 = min((depth - farRange) * invRange, 1.0);
	#ifdef NEAR_BLUR
		let nearRange: f32 = focusDistance - focusRange * 0.5;
		var cocNear: f32 = min((nearRange - depth) * invRange, 1.0);
	#else
		var cocNear: f32 = 0.0;
	#endif
	output.color = vec4f(cocFar, cocNear, 0.0, 0.0);
	return output;
}
`;class wE extends dT{execute(){let{paramsValue:e,focusRange:t}=this;e[0]=this.focusDistance+.001,e[1]=t,e[2]=1/t,this.paramsId.setValue(e);let i=this.cameraComponent.camera;this.cameraParamsId.setValue(i.fillShaderParams(this.cameraParams)),super.execute();}constructor(e,t,i){super(e),this.cameraComponent=t,nH.get(e,tz).set("cocPS",wx),nH.get(e,tV).set("cocPS",wT);let s=new Map;i&&s.set("NEAR_BLUR",""),nY.addScreenDepthChunkDefines(e,t.shaderParams,s),this.shader=nY.createShader(e,{uniqueName:`CocShader-${i}`,attributes:{aPosition:e6},vertexChunk:"quadVS",fragmentChunk:"cocPS",fragmentDefines:s}),this.paramsId=e.scope.resolve("params"),this.paramsValue=new Float32Array(3),this.cameraParams=new Float32Array(4),this.cameraParamsId=e.scope.resolve("camera_params");}}var ww=`
	#if defined(NEAR_BLUR)
		uniform sampler2D nearTexture;
	#endif
	uniform sampler2D farTexture;
	uniform sampler2D cocTexture;
	uniform vec2 kernel[{KERNEL_COUNT}];
	uniform float blurRadiusNear;
	uniform float blurRadiusFar;
	varying vec2 uv0;
	void main()
	{
		vec2 coc = texture2D(cocTexture, uv0).rg;
		float cocFar = coc.r;
		vec3 sum = vec3(0.0, 0.0, 0.0);
		#if defined(NEAR_BLUR)
			float cocNear = coc.g;
			if (cocNear > 0.0001) {
				ivec2 nearTextureSize = textureSize(nearTexture, 0);
				vec2 step = cocNear * blurRadiusNear / vec2(nearTextureSize);
				for (int i = 0; i < {KERNEL_COUNT}; i++) {
					vec2 uv = uv0 + step * kernel[i];
					vec3 tap = texture2DLod(nearTexture, uv, 0.0).rgb;
					sum += tap.rgb;
				}
				sum *= float({INV_KERNEL_COUNT});
			} else
		#endif
			
			if (cocFar > 0.0001) {
			ivec2 farTextureSize = textureSize(farTexture, 0);
			vec2 step = cocFar * blurRadiusFar / vec2(farTextureSize);
			float sumCoC = 0.0; 
			for (int i = 0; i < {KERNEL_COUNT}; i++) {
				vec2 uv = uv0 + step * kernel[i];
				vec3 tap = texture2DLod(farTexture, uv, 0.0).rgb;
				float cocThis = texture2DLod(cocTexture, uv, 0.0).r;
				tap *= cocThis;
				sumCoC += cocThis;
				sum += tap;
			}
			if (sumCoC > 0.0)
				sum /= sumCoC;
			sum /= cocFar;
		}
		pcFragColor0 = vec4(sum, 1.0);
	}
`,wb=`
#if defined(NEAR_BLUR)
	var nearTexture: texture_2d<f32>;
	var nearTextureSampler: sampler;
#endif
var farTexture: texture_2d<f32>;
var farTextureSampler: sampler;
var cocTexture: texture_2d<f32>;
var cocTextureSampler: sampler;
uniform kernel: array<vec2f, {KERNEL_COUNT}>;
uniform blurRadiusNear: f32;
uniform blurRadiusFar: f32;
varying uv0: vec2f;
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let coc: vec2f = textureSample(cocTexture, cocTextureSampler, input.uv0).rg;
	let cocFar: f32 = coc.r;
	var sum: vec3f = vec3f(0.0, 0.0, 0.0);
	#if defined(NEAR_BLUR)
		let cocNear: f32 = coc.g;
		if (cocNear > 0.0001) {
			let nearTextureSize: vec2f = vec2f(textureDimensions(nearTexture, 0));
			let step: vec2f = cocNear * uniform.blurRadiusNear / nearTextureSize;
			for (var i: i32 = 0; i < {KERNEL_COUNT}; i = i + 1) {
				let uv: vec2f = uv0 + step * uniform.kernel[i].element;
				let tap: vec3f = textureSampleLevel(nearTexture, nearTextureSampler, uv, 0.0).rgb;
				sum = sum + tap;
			}
			sum = sum * f32({INV_KERNEL_COUNT});
		} else
	#endif
		if (cocFar > 0.0001) {
			let farTextureSize: vec2f = vec2f(textureDimensions(farTexture, 0));
			let step: vec2f = cocFar * uniform.blurRadiusFar / farTextureSize;
			var sumCoC: f32 = 0.0;
			for (var i: i32 = 0; i < {KERNEL_COUNT}; i = i + 1) {
				let uv: vec2f = uv0 + step * uniform.kernel[i].element;
				var tap: vec3f = textureSampleLevel(farTexture, farTextureSampler, uv, 0.0).rgb;
				let cocThis: f32 = textureSampleLevel(cocTexture, cocTextureSampler, uv, 0.0).r;
				tap = tap * cocThis;
				sumCoC = sumCoC + cocThis;
				sum = sum + tap;
			}
			if (sumCoC > 0.0) {
				sum = sum / sumCoC;
			}
			sum = sum / cocFar;
		}
	output.color = vec4f(sum, 1.0);
	return output;
}
`;class wA extends dT{set blurRings(e){this._blurRings!==e&&(this._blurRings=e,this.shader=null);}get blurRings(){return this._blurRings}set blurRingPoints(e){this._blurRingPoints!==e&&(this._blurRingPoints=e,this.shader=null);}get blurRingPoints(){return this._blurRingPoints}createShader(){this.kernel=new Float32Array(ec.concentric(this.blurRings,this.blurRingPoints));let e=this.kernel.length>>1,t=null!==this.nearTexture,i=new Map;i.set("{KERNEL_COUNT}",e),i.set("{INV_KERNEL_COUNT}",1/e),t&&i.set("NEAR_BLUR",""),this.shader=nY.createShader(this.device,{uniqueName:`DofBlurShader-${e}-${t?"nearBlur":"noNearBlur"}`,attributes:{aPosition:e6},vertexChunk:"quadVS",fragmentChunk:"dofBlurPS",fragmentDefines:i});}execute(){this.shader||this.createShader(),this.nearTextureId.setValue(this.nearTexture),this.farTextureId.setValue(this.farTexture),this.cocTextureId.setValue(this.cocTexture),this.kernelId.setValue(this.kernel),this.kernelCountId.setValue(this.kernel.length>>1),this.blurRadiusNearId.setValue(this.blurRadiusNear),this.blurRadiusFarId.setValue(this.blurRadiusFar),super.execute();}constructor(e,t,i,s){super(e),this.blurRadiusNear=1,this.blurRadiusFar=1,this._blurRings=3,this._blurRingPoints=3,this.nearTexture=t,this.farTexture=i,this.cocTexture=s,nH.get(e,tz).set("dofBlurPS",ww),nH.get(e,tV).set("dofBlurPS",wb);let{scope:r}=e;this.kernelId=r.resolve("kernel[0]"),this.kernelCountId=r.resolve("kernelCount"),this.blurRadiusNearId=r.resolve("blurRadiusNear"),this.blurRadiusFarId=r.resolve("blurRadiusFar"),this.nearTextureId=r.resolve("nearTexture"),this.farTextureId=r.resolve("farTexture"),this.cocTextureId=r.resolve("cocTexture");}}class wC extends as{destroy(){this.destroyRenderPasses(),this.cocPass=null,this.farPass=null,this.blurPass=null,this.destroyRT(this.cocRT),this.destroyRT(this.farRt),this.destroyRT(this.blurRt),this.cocRT=null,this.farRt=null,this.blurRt=null;}destroyRenderPasses(){for(let e=0;e<this.beforePasses.length;e++)this.beforePasses[e].destroy();this.beforePasses.length=0;}destroyRT(e){e&&(e.destroyTextureBuffers(),e.destroy());}setupCocPass(e,t,i,s){this.cocRT=this.createRenderTarget("CoCTexture",s?53:52),this.cocTexture=this.cocRT.colorBuffer;let r=new wE(e,t,s);return r.init(this.cocRT,{resizeSource:i}),r.setClearColor(es.BLACK),r}setupFarPass(e,t,i){this.farRt=this.createRenderTarget("FarDofTexture",t.format);let s=new wl(e,t,{boxFilter:true,premultiplyTexture:this.cocTexture,premultiplySrcChannel:"r"});return s.init(this.farRt,{resizeSource:t,scaleX:i,scaleY:i}),s.setClearColor(es.BLACK),s}setupBlurPass(e,t,i,s){let r=this.farRt?.colorBuffer;this.blurRt=this.createRenderTarget("DofBlurTexture",t.format),this.blurTexture=this.blurRt.colorBuffer;let a=new wA(e,i?t:null,r,this.cocTexture);return a.init(this.blurRt,{resizeSource:t,scaleX:s,scaleY:s}),a.setClearColor(es.BLACK),a}createTexture(e,t){return new ih(this.device,{name:e,width:1,height:1,format:t,mipmaps:false,minFilter:1,magFilter:1,addressU:1,addressV:1})}createRenderTarget(e,t){return new iU({colorBuffer:this.createTexture(e,t),depth:false,stencil:false})}frameUpdate(){super.frameUpdate(),this.cocPass.focusDistance=this.focusDistance,this.cocPass.focusRange=this.focusRange,this.blurPass.blurRadiusNear=this.blurRadius,this.blurPass.blurRadiusFar=this.blurRadius*(this.highQuality?1:.5),this.blurPass.blurRings=this.blurRings,this.blurPass.blurRingPoints=this.blurRingPoints;}constructor(e,t,i,s,r,a){super(e),this.focusDistance=100,this.focusRange=50,this.blurRadius=1,this.blurRings=3,this.blurRingPoints=3,this.highQuality=true,this.cocTexture=null,this.blurTexture=null,this.cocPass=null,this.farPass=null,this.blurPass=null,this.highQuality=r,this.cocPass=this.setupCocPass(e,t,i,a),this.beforePasses.push(this.cocPass);let n=r?i:s;this.farPass=this.setupFarPass(e,n,.5),this.beforePasses.push(this.farPass),this.blurPass=this.setupBlurPass(e,s,a,r?2:.5),this.beforePasses.push(this.blurPass);}}let wP=[];class wI extends as{destroy(){super.destroy(),this.renderTarget?.destroy(),this.renderTarget=null,this.linearDepthTexture?.destroy(),this.linearDepthTexture=null,this.viewBindGroups.forEach(e=>{e.defaultUniformBuffer.destroy(),e.destroy();}),this.viewBindGroups.length=0;}setupRenderTarget(e){let{device:t}=this;this.linearDepthFormat=t.textureFloatRenderable?15:7,this.linearDepthTexture=new ih(t,{name:"SceneLinearDepthTexture",width:1,height:1,format:this.linearDepthFormat,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1});let i=new iU({name:"PrepassRT",colorBuffer:this.linearDepthTexture,depth:true,samples:1});this.camera.shaderParams.sceneDepthMapLinear=true,this.init(i,e);}after(){this.device.scope.resolve("uSceneDepthMap").setValue(this.linearDepthTexture);}execute(){let{renderer:e,scene:t,renderTarget:i}=this,s=this.camera.camera,r=t.layers.layerList,a=t.layers.subLayerEnabled,n=t.layers.subLayerList;for(let t=0;t<r.length;t++){let o=r[t];if(1===o.id)break;if(o.enabled&&a[t]&&o.camerasSet.has(s)){let r=o.getCulledInstances(s),a=n[t]?r.transparent:r.opaque;for(let e=0;e<a.length;e++){let t=a[e];t.material?.depthWrite&&wP.push(t);}e.renderForwardLayer(s,i,null,void 0,1,this.viewBindGroups,{meshInstances:wP}),wP.length=0;}}}frameUpdate(){let e;super.frameUpdate();let{camera:t}=this;if(this.setClearDepth(t.clearDepthBuffer?1:void 0),t.clearDepthBuffer){let i=t.farClip-5e-324;e=this.linearDepthClearValue,15===this.linearDepthFormat?e.r=i:eh.float2RGBA8(i,e);}this.setClearColor(e);}constructor(e,t,i,s,r){super(e),this.viewBindGroups=[],this.linearDepthClearValue=new es(0,0,0,0),this.scene=t,this.renderer=i,this.camera=s,this.setupRenderTarget(r);}}var wD=`
	#include "screenDepthPS"
	varying vec2 uv0;
	uniform sampler2D sourceTexture;
	uniform vec2 sourceInvResolution;
	uniform int filterSize;
	float random(const highp vec2 w) {
		const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);
		return fract(m.z * fract(dot(w, m.xy)));
	}
	mediump float bilateralWeight(in mediump float depth, in mediump float sampleDepth) {
		mediump float diff = (sampleDepth - depth);
		return max(0.0, 1.0 - diff * diff);
	}
	void tap(inout float sum, inout float totalWeight, float weight, float depth, vec2 position) {
		mediump float color = texture2D(sourceTexture, position).r;
		mediump float textureDepth = -getLinearScreenDepth(position);
	
		mediump float bilateral = bilateralWeight(depth, textureDepth);
		bilateral *= weight;
		sum += color * bilateral;
		totalWeight += bilateral;
	}
	void main() {
		mediump float depth = -getLinearScreenDepth(uv0);
		mediump float totalWeight = 1.0;
		mediump float color = texture2D(sourceTexture, uv0 ).r;
		mediump float sum = color * totalWeight;
		for (mediump int i = -filterSize; i <= filterSize; i++) {
			mediump float weight = 1.0;
			#ifdef HORIZONTAL
				vec2 offset = vec2(i, 0) * sourceInvResolution;
			#else
				vec2 offset = vec2(0, i) * sourceInvResolution;
			#endif
			tap(sum, totalWeight, weight, depth, uv0 + offset);
		}
		mediump float ao = sum / totalWeight;
		gl_FragColor.r = ao;
	}
`,wR=`
#include "screenDepthPS"
varying uv0: vec2f;
var sourceTexture: texture_2d<f32>;
var sourceTextureSampler: sampler;
uniform sourceInvResolution: vec2f;
uniform filterSize: i32;
fn random(w: vec2f) -> f32 {
	const m: vec3f = vec3f(0.06711056, 0.00583715, 52.9829189);
	return fract(m.z * fract(dot(w, m.xy)));
}
fn bilateralWeight(depth: f32, sampleDepth: f32) -> f32 {
	let diff: f32 = (sampleDepth - depth);
	return max(0.0, 1.0 - diff * diff);
}
fn tap(sum_ptr: ptr<function, f32>, totalWeight_ptr: ptr<function, f32>, weight: f32, depth: f32, position: vec2f) {
	let color: f32 = textureSample(sourceTexture, sourceTextureSampler, position).r;
	let textureDepth: f32 = -getLinearScreenDepth(position);
	let bilateral: f32 = bilateralWeight(depth, textureDepth) * weight;
	*sum_ptr = *sum_ptr + color * bilateral;
	*totalWeight_ptr = *totalWeight_ptr + bilateral;
}
@fragment
fn fragmentMain(input: FragmentInput) -> FragmentOutput {
	var output: FragmentOutput;
	let depth: f32 = -getLinearScreenDepth(input.uv0);
	var totalWeight: f32 = 1.0;
	let color: f32 = textureSample(sourceTexture, sourceTextureSampler, input.uv0 ).r;
	var sum: f32 = color * totalWeight;
	for (var i: i32 = -uniform.filterSize; i <= uniform.filterSize; i = i + 1) {
		let weight: f32 = 1.0;
		#ifdef HORIZONTAL
			var offset: vec2f = vec2f(f32(i), 0.0) * uniform.sourceInvResolution;
		#else
			var offset: vec2f = vec2f(0.0, f32(i)) * uniform.sourceInvResolution;
		#endif
		tap(&sum, &totalWeight, weight, depth, input.uv0 + offset);
	}
	let ao: f32 = sum / totalWeight;
	output.color = vec4f(ao, ao, ao, 1.0);
	return output;
}
`;class wL extends dT{execute(){this.filterSizeId.setValue(4),this.sourceTextureId.setValue(this.sourceTexture);let{width:e,height:t}=this.sourceTexture;this.sourceInvResolutionValue[0]=1/e,this.sourceInvResolutionValue[1]=1/t,this.sourceInvResolutionId.setValue(this.sourceInvResolutionValue),super.execute();}constructor(e,t,i,s){super(e),this.sourceTexture=t,nH.get(e,tz).set("depthAwareBlurPS",wD),nH.get(e,tV).set("depthAwareBlurPS",wR);let r=new Map;s&&r.set("HORIZONTAL",""),nY.addScreenDepthChunkDefines(e,i.shaderParams,r),this.shader=nY.createShader(e,{uniqueName:`DepthAware${s?"Horizontal":"Vertical"}BlurShader`,attributes:{aPosition:e6},vertexChunk:"quadVS",fragmentChunk:"depthAwareBlurPS",fragmentDefines:r});let a=this.device.scope;this.sourceTextureId=a.resolve("sourceTexture"),this.sourceInvResolutionId=a.resolve("sourceInvResolution"),this.sourceInvResolutionValue=new Float32Array(2),this.filterSizeId=a.resolve("filterSize");}}var wM=`
	#include "screenDepthPS"
	
	varying vec2 uv0;
	uniform vec2 uInvResolution;
	uniform float uAspect;
	#define saturate(x) clamp(x,0.0,1.0)
	highp float getWFromProjectionMatrix(const mat4 p, const vec3 v) {
		return -v.z;
	}
	highp float getViewSpaceZFromW(const mat4 p, const float w) {
		return -w;
	}
	const float kLog2LodRate = 3.0;
	float random(const highp vec2 w) {
		const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);
		return fract(m.z * fract(dot(w, m.xy)));
	}
	highp vec2 getFragCoord() {
		return gl_FragCoord.xy;
	}
	highp vec3 computeViewSpacePositionFromDepth(highp vec2 uv, highp float linearDepth) {
		return vec3((0.5 - uv) * vec2(uAspect, 1.0) * linearDepth, linearDepth);
	}
	highp vec3 faceNormal(highp vec3 dpdx, highp vec3 dpdy) {
		return normalize(cross(dpdx, dpdy));
	}
	highp vec3 computeViewSpaceNormal(const highp vec3 position) {
		return faceNormal(dFdx(position), dFdy(position));
	}
	highp vec3 computeViewSpaceNormal(const highp vec3 position, const highp vec2 uv) {
		highp vec2 uvdx = uv + vec2(uInvResolution.x, 0.0);
		highp vec2 uvdy = uv + vec2(0.0, uInvResolution.y);
		highp vec3 px = computeViewSpacePositionFromDepth(uvdx, -getLinearScreenDepth(uvdx));
		highp vec3 py = computeViewSpacePositionFromDepth(uvdy, -getLinearScreenDepth(uvdy));
		highp vec3 dpdx = px - position;
		highp vec3 dpdy = py - position;
		return faceNormal(dpdx, dpdy);
	}
	uniform vec2 uSampleCount;
	uniform float uSpiralTurns;
	#define PI (3.14159)
	mediump vec3 tapLocation(mediump float i, const mediump float noise) {
		mediump float offset = ((2.0 * PI) * 2.4) * noise;
		mediump float angle = ((i * uSampleCount.y) * uSpiralTurns) * (2.0 * PI) + offset;
		mediump float radius = (i + noise + 0.5) * uSampleCount.y;
		return vec3(cos(angle), sin(angle), radius * radius);
	}
	highp vec2 startPosition(const float noise) {
		float angle = ((2.0 * PI) * 2.4) * noise;
		return vec2(cos(angle), sin(angle));
	}
	uniform vec2 uAngleIncCosSin;
	highp mat2 tapAngleStep() {
		highp vec2 t = uAngleIncCosSin;
		return mat2(t.x, t.y, -t.y, t.x);
	}
	mediump vec3 tapLocationFast(mediump float i, mediump vec2 p, const mediump float noise) {
		mediump float radius = (i + noise + 0.5) * uSampleCount.y;
		return vec3(p, radius * radius);
	}
	uniform float uMaxLevel;
	uniform float uInvRadiusSquared;
	uniform float uMinHorizonAngleSineSquared;
	uniform float uBias;
	uniform float uPeak2;
	void computeAmbientOcclusionSAO(inout mediump float occlusion, mediump float i, mediump float ssDiskRadius,
			const highp vec2 uv, const highp vec3 origin, const mediump vec3 normal,
			const mediump vec2 tapPosition, const float noise) {
		mediump vec3 tap = tapLocationFast(i, tapPosition, noise);
		mediump float ssRadius = max(1.0, tap.z * ssDiskRadius);
		mediump vec2 uvSamplePos = uv + vec2(ssRadius * tap.xy) * uInvResolution;
		mediump float level = clamp(floor(log2(ssRadius)) - kLog2LodRate, 0.0, float(uMaxLevel));
		highp float occlusionDepth = -getLinearScreenDepth(uvSamplePos);
		highp vec3 p = computeViewSpacePositionFromDepth(uvSamplePos, occlusionDepth);
		vec3 v = p - origin;
		float vv = dot(v, v);
		float vn = dot(v, normal);
		mediump float w = max(0.0, 1.0 - vv * uInvRadiusSquared);
		w = w * w;
		w *= step(vv * uMinHorizonAngleSineSquared, vn * vn);
		occlusion += w * max(0.0, vn + origin.z * uBias) / (vv + uPeak2);
	}
	uniform float uProjectionScaleRadius;
	uniform float uIntensity;
	uniform float uRandomize;
	float scalableAmbientObscurance(highp vec2 uv, highp vec3 origin, vec3 normal) {
		float noise = random(getFragCoord()) + uRandomize;
		highp vec2 tapPosition = startPosition(noise);
		highp mat2 angleStep = tapAngleStep();
		float ssDiskRadius = -(uProjectionScaleRadius / origin.z);
		float occlusion = 0.0;
		for (float i = 0.0; i < uSampleCount.x; i += 1.0) {
			computeAmbientOcclusionSAO(occlusion, i, ssDiskRadius, uv, origin, normal, tapPosition, noise);
			tapPosition = angleStep * tapPosition;
		}
		return occlusion;
	}
	uniform float uPower;
	void main() {
		highp vec2 uv = uv0;
		highp float depth = -getLinearScreenDepth(uv0);
		highp vec3 origin = computeViewSpacePositionFromDepth(uv, depth);
		vec3 normal = computeViewSpaceNormal(origin, uv);
		float occlusion = 0.0;
		if (uIntensity > 0.0) {
			occlusion = scalableAmbientObscurance(uv, origin, normal);
		}
		float ao = max(0.0, 1.0 - occlusion * uIntensity);
		ao = pow(ao, uPower);
		gl_FragColor = vec4(ao, ao, ao, 1.0);
	}
`,wO=`
	#include "screenDepthPS"
	varying uv0: vec2f;
	uniform uInvResolution: vec2f;
	uniform uAspect: f32;
	fn getWFromProjectionMatrix(p: mat4x4f, v: vec3f) -> f32 {
		return -v.z;
	}
	fn getViewSpaceZFromW(p: mat4x4f, w: f32) -> f32 {
		return -w;
	}
	const kLog2LodRate: f32 = 3.0;
	fn random(w: vec2f) -> f32 {
		const m: vec3f = vec3f(0.06711056, 0.00583715, 52.9829189);
		return fract(m.z * fract(dot(w, m.xy)));
	}
	fn getFragCoord() -> vec2f {
		return pcPosition.xy;
	}
	fn computeViewSpacePositionFromDepth(uv: vec2f, linearDepth: f32) -> vec3f {
		return vec3f((0.5 - uv) * vec2f(uniform.uAspect, 1.0) * linearDepth, linearDepth);
	}
	fn faceNormal(dpdx: vec3f, dpdy: vec3f) -> vec3f {
		return normalize(cross(dpdx, dpdy));
	}
	fn computeViewSpaceNormalDeriv(position: vec3f) -> vec3f {
		return faceNormal(dpdx(position), dpdy(position));
	}
	fn computeViewSpaceNormalDepth(position: vec3f, uv: vec2f) -> vec3f {
		let uvdx: vec2f = uv + vec2f(uniform.uInvResolution.x, 0.0);
		let uvdy: vec2f = uv + vec2f(0.0, uniform.uInvResolution.y);
		let px: vec3f = computeViewSpacePositionFromDepth(uvdx, -getLinearScreenDepth(uvdx));
		let py: vec3f = computeViewSpacePositionFromDepth(uvdy, -getLinearScreenDepth(uvdy));
		let dpdx: vec3f = px - position;
		let dpdy: vec3f = py - position;
		return faceNormal(dpdx, dpdy);
	}
	uniform uSampleCount: vec2f;
	uniform uSpiralTurns: f32;
	const PI: f32 = 3.14159;
	fn tapLocation(i: f32, noise: f32) -> vec3f {
		let offset: f32 = ((2.0 * PI) * 2.4) * noise;
		let angle: f32 = ((i * uniform.uSampleCount.y) * uniform.uSpiralTurns) * (2.0 * PI) + offset;
		let radius: f32 = (i + noise + 0.5) * uniform.uSampleCount.y;
		return vec3f(cos(angle), sin(angle), radius * radius);
	}
	fn startPosition(noise: f32) -> vec2f {
		let angle: f32 = ((2.0 * PI) * 2.4) * noise;
		return vec2f(cos(angle), sin(angle));
	}
	uniform uAngleIncCosSin: vec2f;
	fn tapAngleStep() -> mat2x2f {
		let t: vec2f = uniform.uAngleIncCosSin;
		return mat2x2f(vec2f(t.x, t.y), vec2f(-t.y, t.x));
	}
	fn tapLocationFast(i: f32, p: vec2f, noise_in: f32) -> vec3f {
		let radius: f32 = (i + noise_in + 0.5) * uniform.uSampleCount.y;
		return vec3f(p.x, p.y, radius * radius);
	}
	uniform uMaxLevel: f32;
	uniform uInvRadiusSquared: f32;
	uniform uMinHorizonAngleSineSquared: f32;
	uniform uBias: f32;
	uniform uPeak2: f32;
	fn computeAmbientOcclusionSAO(occlusion_ptr: ptr<function, f32>, i: f32, ssDiskRadius: f32,
			uv: vec2f, origin: vec3f, normal: vec3f,
			tapPosition: vec2f, noise: f32) {
		let tap: vec3f = tapLocationFast(i, tapPosition, noise);
		let ssRadius: f32 = max(1.0, tap.z * ssDiskRadius);
		let uvSamplePos: vec2f = uv + (ssRadius * tap.xy) * uniform.uInvResolution;
		let level: f32 = clamp(floor(log2(ssRadius)) - kLog2LodRate, 0.0, uniform.uMaxLevel);
		let occlusionDepth: f32 = -getLinearScreenDepth(uvSamplePos);
		let p: vec3f = computeViewSpacePositionFromDepth(uvSamplePos, occlusionDepth);
		let v: vec3f = p - origin;
		let vv: f32 = dot(v, v);
		let vn: f32 = dot(v, normal);
		var w_val: f32 = max(0.0, 1.0 - vv * uniform.uInvRadiusSquared);
		w_val = w_val * w_val;
		w_val = w_val * step(vv * uniform.uMinHorizonAngleSineSquared, vn * vn);
		*occlusion_ptr = *occlusion_ptr + w_val * max(0.0, vn + origin.z * uniform.uBias) / (vv + uniform.uPeak2);
	}
	uniform uProjectionScaleRadius: f32;
	uniform uIntensity: f32;
	uniform uRandomize: f32;
	fn scalableAmbientObscurance(uv: vec2f, origin: vec3f, normal: vec3f) -> f32 {
		let noise: f32 = random(getFragCoord()) + uniform.uRandomize;
		var tapPosition: vec2f = startPosition(noise);
		let angleStep: mat2x2f = tapAngleStep();
		let ssDiskRadius: f32 = -(uniform.uProjectionScaleRadius / origin.z);
		var occlusion: f32 = 0.0;
		for (var i: i32 = 0; i < i32(uniform.uSampleCount.x); i = i + 1) {
			computeAmbientOcclusionSAO(&occlusion, f32(i), ssDiskRadius, uv, origin, normal, tapPosition, noise);
			tapPosition = angleStep * tapPosition;
		}
		return occlusion;
	}
	uniform uPower: f32;
	@fragment
	fn fragmentMain(input: FragmentInput) -> FragmentOutput {
		var output: FragmentOutput;
		let uv: vec2f = input.uv0;
		let depth: f32 = -getLinearScreenDepth(input.uv0);
		let origin: vec3f = computeViewSpacePositionFromDepth(uv, depth);
		let normal: vec3f = computeViewSpaceNormalDepth(origin, uv);
		var occlusion: f32 = 0.0;
		if (uniform.uIntensity > 0.0) {
			occlusion = scalableAmbientObscurance(uv, origin, normal);
		}
		var ao: f32 = max(0.0, 1.0 - occlusion * uniform.uIntensity);
		ao = pow(ao, uniform.uPower);
		output.color = vec4f(ao, ao, ao, 1.0);
		return output;
	}
`;class wF extends dT{destroy(){if(this.renderTarget?.destroyTextureBuffers(),this.renderTarget?.destroy(),this.renderTarget=null,this.afterPasses.length>0){let e=this.afterPasses[0].renderTarget;e?.destroyTextureBuffers(),e?.destroy();}this.afterPasses.forEach(e=>e.destroy()),this.afterPasses.length=0,super.destroy();}set scale(e){this._scale=e,this.scaleX=e,this.scaleY=e;}get scale(){return this._scale}createRenderTarget(e){return new iU({depth:false,colorBuffer:new ih(this.device,{name:e,width:1,height:1,format:52,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1})})}execute(){let{device:e,sourceTexture:t,sampleCount:i,minAngle:s,scale:r}=this,{width:a,height:n}=this.renderTarget.colorBuffer,o=e.scope;o.resolve("uAspect").setValue(a/n),o.resolve("uInvResolution").setValue([1/a,1/n]),o.resolve("uSampleCount").setValue([i,1/i]);let l=Math.sin(s*ei.DEG_TO_RAD);o.resolve("uMinHorizonAngleSineSquared").setValue(l*l);let h=1/(i-.5)*62.82,c=this.radius/r,d=.1*c,u=2*d*6.282*this.intensity/i,f=.5*t.height;o.resolve("uSpiralTurns").setValue(10),o.resolve("uAngleIncCosSin").setValue([Math.cos(h),Math.sin(h)]),o.resolve("uMaxLevel").setValue(0),o.resolve("uInvRadiusSquared").setValue(1/(c*c)),o.resolve("uBias").setValue(.001),o.resolve("uPeak2").setValue(d*d),o.resolve("uIntensity").setValue(u),o.resolve("uPower").setValue(this.power),o.resolve("uProjectionScaleRadius").setValue(f*c),o.resolve("uRandomize").setValue(this.randomize?this._blueNoise.value():0),super.execute();}after(){this.ssaoTextureId.setValue(this.ssaoTexture);let e=this.sourceTexture;this.ssaoTextureSizeInvId.setValue([1/e.width,1/e.height]);}constructor(e,t,i,s){super(e),this.radius=5,this.intensity=1,this.power=1,this.sampleCount=10,this.minAngle=5,this.randomize=false,this._scale=1,this._blueNoise=new li(19),this.sourceTexture=t,this.cameraComponent=i,nH.get(e,tz).set("ssaoPS",wM),nH.get(e,tV).set("ssaoPS",wO);let r=new Map;nY.addScreenDepthChunkDefines(e,i.shaderParams,r),this.shader=nY.createShader(e,{uniqueName:"SsaoShader",attributes:{aPosition:e6},vertexChunk:"quadVS",fragmentChunk:"ssaoPS",fragmentDefines:r});let a=this.createRenderTarget("SsaoFinalTexture");this.ssaoTexture=a.colorBuffer,this.init(a,{resizeSource:this.sourceTexture});let n=new es(0,0,0,0);if(this.setClearColor(n),s){let t=this.createRenderTarget("SsaoTempTexture"),s=new wL(e,a.colorBuffer,i,true);s.init(t,{resizeSource:a.colorBuffer}),s.setClearColor(n);let r=new wL(e,t.colorBuffer,i,false);r.init(a,{resizeSource:a.colorBuffer}),r.setClearColor(n),this.afterPasses.push(s),this.afterPasses.push(r);}this.ssaoTextureId=e.scope.resolve("ssaoTexture"),this.ssaoTextureSizeInvId=e.scope.resolve("ssaoTextureSizeInv");}}class wN{constructor(){this.stencil=false,this.samples=1,this.sceneColorMap=false,this.lastGrabLayerId=2,this.lastGrabLayerIsTransparent=false,this.lastSceneLayerId=3,this.lastSceneLayerIsTransparent=true,this.taaEnabled=false,this.bloomEnabled=false,this.ssaoType=ws,this.ssaoBlurEnabled=true,this.prepassEnabled=false,this.dofEnabled=false,this.dofNearBlur=false,this.dofHighQuality=true;}}let wB=new wN;class wk extends as{destroy(){this.reset();}reset(){this.sceneTexture=null,this.sceneTextureHalf=null,this.rt&&(this.rt.destroyTextureBuffers(),this.rt.destroy(),this.rt=null),this.rtHalf&&(this.rtHalf.destroyTextureBuffers(),this.rtHalf.destroy(),this.rtHalf=null),this.beforePasses.forEach(e=>e.destroy()),this.beforePasses.length=0,this.prePass=null,this.scenePass=null,this.scenePassTransparent=null,this.colorGrabPass=null,this.composePass=null,this.bloomPass=null,this.ssaoPass=null,this.taaPass=null,this.afterPass=null,this.scenePassHalf=null,this.dofPass=null;}sanitizeOptions(e){return ((e=Object.assign({},wB,e)).taaEnabled||e.ssaoType!==ws||e.dofEnabled)&&(e.prepassEnabled=true),e}set renderTargetScale(e){this._renderTargetScale=e,this.scenePass&&(this.scenePass.scaleX=e,this.scenePass.scaleY=e);}get renderTargetScale(){return this._renderTargetScale}needsReset(e){let t,i,s=this.options;return e.ssaoType!==s.ssaoType||e.ssaoBlurEnabled!==s.ssaoBlurEnabled||e.taaEnabled!==s.taaEnabled||e.samples!==s.samples||e.stencil!==s.stencil||e.bloomEnabled!==s.bloomEnabled||e.prepassEnabled!==s.prepassEnabled||e.sceneColorMap!==s.sceneColorMap||e.dofEnabled!==s.dofEnabled||e.dofNearBlur!==s.dofNearBlur||e.dofHighQuality!==s.dofHighQuality||(t=e.formats)!==(i=s.formats)&&(!(Array.isArray(t)&&Array.isArray(i))||t.length!==i.length||!t.every((e,t)=>e===i[t]))}update(e){e=this.sanitizeOptions(e),(this.needsReset(e)||this.layersDirty)&&(this.layersDirty=false,this.reset()),this.options=e,this.sceneTexture||this.setupRenderPasses(this.options);}createRenderTarget(e,t,i,s,r){return new iU({colorBuffer:new ih(this.device,{name:e,width:4,height:4,format:this.hdrFormat,mipmaps:false,minFilter:1,magFilter:1,addressU:1,addressV:1}),depth:t,stencil:i,samples:s,flipY:r})}setupRenderPasses(e){let{device:t}=this,i=this.cameraComponent,s=i.renderTarget;this.hdrFormat=t.getRenderableHdrFormat(e.formats,true,e.samples)||7,this._bloomEnabled=e.bloomEnabled&&7!==this.hdrFormat,this._sceneHalfEnabled=this._bloomEnabled||e.dofEnabled,i.shaderParams.ssaoEnabled=e.ssaoType===wr;let r=!!s?.flipY;this.rt=this.createRenderTarget("SceneColor",true,e.stencil,e.samples,r),this.sceneTexture=this.rt.colorBuffer,this._sceneHalfEnabled&&(this.rtHalf=this.createRenderTarget("SceneColorHalf",false,false,1,r),this.sceneTextureHalf=this.rtHalf.colorBuffer),this.sceneOptions={resizeSource:s,scaleX:this.renderTargetScale,scaleY:this.renderTargetScale},this.createPasses(e);let a=this.collectPasses();this.beforePasses=a.filter(e=>null!=e);}collectPasses(){return [this.prePass,this.ssaoPass,this.scenePass,this.colorGrabPass,this.scenePassTransparent,this.taaPass,this.scenePassHalf,this.bloomPass,this.dofPass,this.composePass,this.afterPass]}createPasses(e){this.setupScenePrepass(e),this.setupSsaoPass(e);let t=this.setupScenePass(e),i=this.setupTaaPass(e);this.setupSceneHalfPass(e,i),this.setupBloomPass(e,this.sceneTextureHalf),this.setupDofPass(e,this.sceneTexture,this.sceneTextureHalf),this.setupComposePass(e),this.setupAfterPass(e,t);}setupScenePrepass(e){if(e.prepassEnabled){let{app:e,device:t,cameraComponent:i}=this,{scene:s,renderer:r}=e;this.prePass=new wI(t,s,r,i,this.sceneOptions);}}setupScenePassSettings(e){e.gammaCorrection=0,e.toneMapping=6;}setupScenePass(e){let{app:t,device:i,cameraComponent:s}=this,{scene:r,renderer:a}=t,n=r.layers;this.scenePass=new he(i,n,r,a),this.setupScenePassSettings(this.scenePass),this.scenePass.init(this.rt,this.sceneOptions);let o=e.sceneColorMap?e.lastGrabLayerId:e.lastSceneLayerId,l=e.sceneColorMap?e.lastGrabLayerIsTransparent:e.lastSceneLayerIsTransparent,h={lastAddedIndex:0,clearRenderTarget:true};return h.lastAddedIndex=this.scenePass.addLayers(n,s,h.lastAddedIndex,h.clearRenderTarget,o,l),h.clearRenderTarget=false,e.sceneColorMap&&(this.colorGrabPass=new oS(i),this.colorGrabPass.source=this.rt,this.scenePassTransparent=new he(i,n,r,a),this.setupScenePassSettings(this.scenePassTransparent),this.scenePassTransparent.init(this.rt),h.lastAddedIndex=this.scenePassTransparent.addLayers(n,s,h.lastAddedIndex,h.clearRenderTarget,e.lastSceneLayerId,e.lastSceneLayerIsTransparent),this.scenePassTransparent.rendersAnything||(this.scenePassTransparent.destroy(),this.scenePassTransparent=null),this.scenePassTransparent&&e.prepassEnabled&&(this.scenePassTransparent.depthStencilOps.storeDepth=true)),h}setupSsaoPass(e){let{ssaoBlurEnabled:t,ssaoType:i}=e,{device:s,cameraComponent:r}=this;i!==ws&&(this.ssaoPass=new wF(s,this.sceneTexture,r,t));}setupSceneHalfPass(e,t){this._sceneHalfEnabled&&(this.scenePassHalf=new wl(this.device,this.sceneTexture,{boxFilter:true,removeInvalid:true}),this.scenePassHalf.name="RenderPassSceneHalf",this.scenePassHalf.init(this.rtHalf,{resizeSource:t,scaleX:.5,scaleY:.5}),this.scenePassHalf.setClearColor(es.BLACK));}setupBloomPass(e,t){this._bloomEnabled&&(this.bloomPass=new wu(this.device,t,this.hdrFormat));}setupDofPass(e,t,i){e.dofEnabled&&(this.dofPass=new wC(this.device,this.cameraComponent,t,i,e.dofHighQuality,e.dofNearBlur));}setupTaaPass(e){let t=this.sceneTexture;return e.taaEnabled&&(this.taaPass=new wy(this.device,this.sceneTexture,this.cameraComponent),t=this.taaPass.historyTexture),t}setupComposePass(e){this.composePass=new wm(this.device),this.composePass.bloomTexture=this.bloomPass?.bloomTexture,this.composePass.taaEnabled=e.taaEnabled,this.composePass.cocTexture=this.dofPass?.cocTexture,this.composePass.blurTexture=this.dofPass?.blurTexture,this.composePass.blurTextureUpscale=!this.dofPass?.highQuality;let t=this.cameraComponent.renderTarget;this.composePass.init(t),this.composePass.ssaoTexture=e.ssaoType===wa?this.ssaoPass.ssaoTexture:null;}setupAfterPass(e,t){let{app:i,cameraComponent:s}=this,{scene:r,renderer:a}=i,n=r.layers,o=s.renderTarget;this.afterPass=new he(this.device,n,r,a),this.afterPass.init(o),this.afterPass.addLayers(n,s,t.lastAddedIndex,t.clearRenderTarget);}frameUpdate(){this.layersDirty&&this.cameraFrame.update(),super.frameUpdate();let e=this.taaPass?.update()??this.rt.colorBuffer;this.composePass.sceneTexture=e,this.scenePassHalf?.setSourceTexture(e);}constructor(e,t,i,s={}){super(e.graphicsDevice),this._renderTargetScale=1,this.layersDirty=false,this.rt=null,this.app=e,this.cameraComponent=i,this.cameraFrame=t,this.options=this.sanitizeOptions(s),this.setupRenderPasses(this.options);}}let wU=new ed,wz=new ex;class wV{copy(e){return this.set(e.position,e.angles,e.distance)}clone(){return new wV(this.position.clone(),this.angles.clone(),this.distance)}equalsApprox(e,t=1e-6){return this.position.equalsApprox(e.position,t)&&this.angles.equalsApprox(e.angles,t)&&Math.abs(this.distance-e.distance)<t}lerp(e,t,i,s=i,r=i){return this.position.lerp(e.position,t.position,i),this.angles.x=ei.lerpAngle(e.angles.x,t.angles.x,s)%360,this.angles.y=ei.lerpAngle(e.angles.y,t.angles.y,s)%360,this.angles.z=ei.lerpAngle(e.angles.z,t.angles.z,s)%360,this.distance=ei.lerp(e.distance,t.distance,r),this}move(e){return this.position.add(e),this.position.x=ei.clamp(this.position.x,this.xRange.x,this.xRange.y),this.position.y=ei.clamp(this.position.y,this.yRange.x,this.yRange.y),this.position.z=ei.clamp(this.position.z,this.zRange.x,this.zRange.y),this}rotate(e){return this.angles.add(e),this.angles.x%=360,this.angles.y%=360,this.angles.z%=360,this.angles.x=ei.clamp(this.angles.x,this.pitchRange.x,this.pitchRange.y),this.angles.y=ei.clamp(this.angles.y,this.yawRange.x,this.yawRange.y),this}set(e,t,i){return this.position.copy(e),this.angles.copy(t),this.distance=i,this}look(e,t){this.position.copy(e),this.distance=e.distance(t);let i=wU.sub2(t,e).normalize(),s=Math.atan2(-i.y,Math.sqrt(i.x*i.x+i.z*i.z))*ei.RAD_TO_DEG,r=Math.atan2(-i.x,-i.z)*ei.RAD_TO_DEG;return this.angles.set(-s,r,0),this}getFocus(e){return wz.setFromEulerAngles(this.angles).transformVector(ed.FORWARD,e).mulScalar(this.distance).add(this.position)}constructor(e=ed.ZERO,t=ed.ZERO,i=0){this.position=new ed,this.angles=new ed,this.distance=0,this.pitchRange=new ef(-1/0,1/0),this.yawRange=new ef(-1/0,1/0),this.xRange=new ef(-1/0,1/0),this.yRange=new ef(-1/0,1/0),this.zRange=new ef(-1/0,1/0),this.set(e,t,i);}}class wG{add(e){for(let t=0;t<this._value.length;t++)this._value[t]+=e._value[t]||0;return this}append(e){for(let t=0;t<this._value.length;t++)this._value[t]+=e[t]||0;return this}copy(e){for(let t=0;t<this._value.length;t++)this._value[t]=e._value[t]||0;return this}length(){let e=0;for(let t of this._value)e+=t*t;return Math.sqrt(e)}read(){let e=this._value.slice();return this._value.fill(0),e}constructor(e){Array.isArray(e)?this._value=e.slice():this._value=Array(+e).fill(0);}}class wH{read(){let e={};for(let t in this.deltas)e[t]=this.deltas[t].read();return e}constructor(e){for(let t in this.deltas={},e)this.deltas[t]=new wG(e[t]);}}class wW extends wH{on(e,t){this._events.on(e,t);}off(e,t){this._events.off(e,t);}fire(e,...t){this._events.fire(e,...t);}attach(e){this._element&&this.detach(),this._element=e;}detach(){this._element&&(this._element=null,this.read());}destroy(){this.detach(),this._events.off();}constructor(...e){super(...e),this._element=null,this._events=new X;}}class wX{update(e,t){e.read();}}class wY extends wX{attach(e,t=true){}detach(){}update(e,t){return super.update(e,t),this._pose}destroy(){this.detach();}constructor(...e){super(...e),this._pose=new wV;}}let wq=()=>{let e=new Map;return {down:t=>{e.set(t.pointerId,[t.screenX,t.screenY]);},move:t=>{if(!e.has(t.pointerId))return [0,0];let i=e.get(t.pointerId),s=t.screenX-i[0],r=t.screenY-i[1];return i[0]=t.screenX,i[1]=t.screenY,[s,r]},up:t=>{e.delete(t.pointerId);}}},w$=new ef;class wj{get value(){return this._value}down(e,t){return this._position.set(e,t),this._value.set(0,0),[e,t,e,t]}move(e,t){w$.set(e-this._position.x,t-this._position.y),w$.length()>this._range&&w$.normalize().mulScalar(this._range),this._value.set(ei.clamp(w$.x/this._range,-1,1),ei.clamp(w$.y/this._range,-1,1));let{x:i,y:s}=this._position;return [i,s,i+w$.x,s+w$.y]}up(){return this._position.set(0,0),this._value.set(0,0),[-1,-1,-1,-1]}constructor({range:e}={}){this._range=70,this._position=new ef,this._value=new ef,this._range=e??this._range;}}let wK=(e,t)=>0===e.indexOf(t),wZ=(e,t)=>-1!==e.indexOf(t,e.length-t.length),wQ=new ef,wJ={passive:false},w0={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25,0:26,1:27,2:28,3:29,4:30,5:31,6:32,7:33,8:34,9:35,UP:36,DOWN:37,LEFT:38,RIGHT:39,SPACE:40,SHIFT:41,CTRL:42},w1=Object.keys(w0).length,w2=Array(w1).fill(0);class w3 extends wW{_onWheel(e){e.preventDefault(),this.deltas.wheel.append([e.deltaY]);}_onPointerDown(e){this._movementState.down(e),"mouse"!==e.pointerType||(this._pointerLock?document.pointerLockElement!==this._element&&this._element?.requestPointerLock():this._element?.setPointerCapture(e.pointerId),this._clearButtons(),this._button[e.button]=1,this.deltas.button.append(this._button),-1===this._pointerId&&(this._pointerId=e.pointerId));}_onPointerMove(e){let[t,i]=this._pointerLock&&document.pointerLockElement===this._element?[e.movementX,e.movementY]:this._movementState.move(e);if("mouse"===e.pointerType&&e.target===this._element){if(this._pointerLock){if(document.pointerLockElement!==this._element)return}else if(this._pointerId!==e.pointerId)return;this.deltas.mouse.append([t,i]);}}_onPointerUp(e){this._movementState.up(e),"mouse"!==e.pointerType||(this._pointerLock||this._element?.releasePointerCapture(e.pointerId),this._clearButtons(),this.deltas.button.append(this._button),this._pointerId===e.pointerId&&(this._pointerId=-1));}_onContextMenu(e){e.preventDefault();}_onKeyDown(e){this._pointerLock&&document.pointerLockElement!==this._element||(e.stopPropagation(),this._setKey(e.code,1));}_onKeyUp(e){e.stopPropagation(),this._setKey(e.code,0);}_clearButtons(){for(let e=0;e<this._button.length;e++){if(1===this._button[e]){this._button[e]=-1;continue}this._button[e]=0;}}_setKey(e,t){this._keyMap.has(e)&&(this._keyNow[this._keyMap.get(e)??0]=t);}attach(e){super.attach(e),this._element=e,this._element.addEventListener("wheel",this._onWheel,wJ),this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("pointercancel",this._onPointerUp),this._element.addEventListener("pointerleave",this._onPointerUp),this._element.addEventListener("contextmenu",this._onContextMenu),window.addEventListener("keydown",this._onKeyDown,false),window.addEventListener("keyup",this._onKeyUp,false);}detach(){this._element&&(this._element.removeEventListener("wheel",this._onWheel,wJ),this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("pointercancel",this._onPointerUp),this._element.removeEventListener("pointerleave",this._onPointerUp),this._element.removeEventListener("contextmenu",this._onContextMenu),window.removeEventListener("keydown",this._onKeyDown,false),window.removeEventListener("keyup",this._onKeyUp,false),this._keyNow.fill(0),this._keyPrev.fill(0),super.detach());}read(){for(let e=0;e<w2.length;e++)w2[e]=this._keyNow[e]-this._keyPrev[e],this._keyPrev[e]=this._keyNow[e];return this.deltas.key.append(w2),super.read()}constructor({pointerLock:e=false}={}){super({key:Array(w1).fill(0),button:[0,0,0],mouse:[0,0],wheel:[0]}),this._movementState=wq(),this._pointerId=-1,this._keyMap=new Map,this._keyPrev=Array(w1).fill(0),this._keyNow=Array(w1).fill(0),this._button=[,,,].fill(0),this._pointerLock=e??false;let{keyCode:t}=w3;for(let e=0;e<26;e++){let i=`Key${String.fromCharCode(65+e)}`;this._keyMap.set(i,t.A+e);}for(let e=0;e<10;e++){let i=`Digit${e}`;this._keyMap.set(i,t["0"]+e);}this._keyMap.set("ArrowUp",t.UP),this._keyMap.set("ArrowDown",t.DOWN),this._keyMap.set("ArrowLeft",t.LEFT),this._keyMap.set("ArrowRight",t.RIGHT),this._keyMap.set("Space",t.SPACE),this._keyMap.set("ShiftLeft",t.SHIFT),this._keyMap.set("ShiftRight",t.SHIFT),this._keyMap.set("ControlLeft",t.CTRL),this._keyMap.set("ControlRight",t.CTRL),this._onWheel=this._onWheel.bind(this),this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this);}}w3.keyCode=w0;let w4={A:0,B:1,X:2,Y:3,LB:4,RB:5,LT:6,RT:7,SELECT:8,START:9,LEFT_STICK:10,RIGHT_STICK:11},w5=Object.keys(w4).length;class w8 extends wW{read(){let e=navigator.getGamepads();for(let t=0;t<e.length;t++){let i=e[t];if(!i||"standard"!==i.mapping||i.axes.length<4||i.buttons.length<w5)continue;let{buttons:s,axes:r}=i;for(let e=0;e<this._buttonPrev.length;e++){let t=+s[e].pressed;this.deltas.buttons[e]=t-this._buttonPrev[e],this._buttonPrev[e]=t;}this.deltas.leftStick.append([r[0],r[1]]),this.deltas.rightStick.append([r[2],r[3]]);}return super.read()}constructor(){super({buttons:Array(w5).fill(0),leftStick:[0,0],rightStick:[0,0]}),this._buttonPrev=Array(w5).fill(0);}}w8.buttonCode=w4;let w6=(e,t)=>1-Math.pow(e,1e3*t),w9=new ed,w7=new ed,be=new ed,bt=new ed,bi=new ed,bs=new ex,br=new ed,ba=new ed,bn=new ed,bo=new ex,bl=new ed,bh=new ed,bc=new ex,bd=new ed,bu=new ed,bf=new ed,bp=new ex,bm=new ey,b_=new ey,bg=new eM;class bv extends X{static createLayer(e,t="Gizmo",i=e.scene.layers.layerList.length){let s=new hd({name:t,clearDepthBuffer:true,opaqueSortMode:0,transparentSortMode:0});return e.scene.layers.insert(s,i),s}set enabled(e){let t=this.root.getLocalPosition().distance(this.camera.entity.getPosition()),i=!!e&&this.nodes.length>0&&t>1e-4;i!==this.root.enabled&&(this.root.enabled=i,this._renderUpdate=true);}get enabled(){return this.root.enabled}get mouseButtons(){return this._mouseButtons}set layer(e){this._layer!==e&&(this._camera.layers=this._camera.layers.filter(e=>e!==this._layer.id),this._layer=e,this._camera.layers=this._camera.layers.concat(this._layer.id),this.enabled=true);}get layer(){return this._layer}set camera(e){this._camera!==e&&(this._camera.layers=this._camera.layers.filter(e=>e!==this._layer.id),this._camera=e,this._camera.layers=this._camera.layers.concat(this._layer.id),this.enabled=true);}get camera(){return this._camera}set coordSpace(e){this._coordSpace=e??this._coordSpace,this._updateRotation();}get coordSpace(){return this._coordSpace}set size(e){this._size=e,this._updateScale();}get size(){return this._size}get facingDir(){if(0===this._camera.projection){let e=this.root.getLocalPosition(),t=this._camera.entity.getPosition();return bf.sub2(t,e).normalize()}return bf.copy(this._camera.entity.forward).mulScalar(-1)}get cameraDir(){let e=this._camera.entity.getPosition(),t=this.root.getLocalPosition();return bf.sub2(e,t).normalize()}_onPointerDown(e){if(!this.enabled||document.pointerLockElement||!this.mouseButtons[e.button])return;let t=this._getSelection(e.offsetX,e.offsetY);t[0]&&(this.preventDefault&&e.preventDefault(),e.stopPropagation());let{canvas:i}=this._device;i.setPointerCapture(e.pointerId),this.fire(bv.EVENT_POINTERDOWN,e.offsetX,e.offsetY,t[0]);}_onPointerMove(e){if(!this.enabled||document.pointerLockElement)return;let t=this._getSelection(e.offsetX,e.offsetY);t[0]&&(this.preventDefault&&e.preventDefault(),e.stopPropagation()),this.fire(bv.EVENT_POINTERMOVE,e.offsetX,e.offsetY,t[0]);}_onPointerUp(e){if(!this.enabled||document.pointerLockElement||!this.mouseButtons[e.button])return;let t=this._getSelection(e.offsetX,e.offsetY);t[0]&&(this.preventDefault&&e.preventDefault(),e.stopPropagation());let{canvas:i}=this._device;i.releasePointerCapture(e.pointerId),this.fire(bv.EVENT_POINTERUP,e.offsetX,e.offsetY,t[0]);}_updatePosition(){if(bu.set(0,0,0),"local"===this._coordSpace)bu.copy(this.nodes[this.nodes.length-1].getPosition());else {for(let e=0;e<this.nodes.length;e++){let t=this.nodes[e];bu.add(t.getPosition());}bu.mulScalar(1/(this.nodes.length||1));}bu.equalsApprox(this.root.getLocalPosition(),1e-6)||(this.root.setLocalPosition(bu),this.fire(bv.EVENT_POSITIONUPDATE,bu),this._renderUpdate=true);}_updateRotation(){bp.set(0,0,0,1),"local"===this._coordSpace&&0!==this.nodes.length&&bp.copy(this.nodes[this.nodes.length-1].getRotation()),bp.equalsApprox(this.root.getRotation(),1e-6)||(this.root.setRotation(bp),this.fire(bv.EVENT_ROTATIONUPDATE,bp.getEulerAngles()),this._renderUpdate=true);}_updateScale(){if(0===this._camera.projection){let e=this.root.getLocalPosition(),t=this._camera.entity.getPosition(),i=bd.sub2(e,t).dot(this._camera.entity.forward);this._scale=Math.tan(.5*this._camera.fov*ei.DEG_TO_RAD)*i*.3;}else this._scale=.32*this._camera.orthoHeight;this._scale=Math.max(this._scale*this._size,1e-4),1e-6>Math.abs(this._scale-this.root.getLocalScale().x)||(this.root.setLocalScale(this._scale,this._scale,this._scale),this.fire(bv.EVENT_SCALEUPDATE,this._scale),this._renderUpdate=true);}_getSelection(e,t){let i=this._camera.screenToWorld(e,t,0),s=this._camera.screenToWorld(e,t,this._camera.farClip-this._camera.nearClip),r=bd.copy(s).sub(i).normalize(),a=[];for(let e=0;e<this.intersectShapes.length;e++){let t=this.intersectShapes[e];if(t.disabled||!t.entity.enabled)continue;let s=t.entity.getWorldTransform();for(let e=0;e<t.triData.length;e++){let{tris:n,transform:o,priority:l}=t.triData[e],h=bm.copy(s).mul(o),c=b_.copy(h).invert();c.transformPoint(i,bg.origin),c.transformVector(r,bg.direction),bg.direction.normalize();for(let e=0;e<n.length;e++)n[e].intersectsRay(bg,bd)&&a.push({dist:h.transformPoint(bd).sub(i).length(),meshInstances:t.meshInstances,priority:l});}}return a.length?(a.sort((e,t)=>0!==e.priority&&0!==t.priority?t.priority-e.priority:e.dist-t.dist),a[0].meshInstances):[]}attach(e=[]){if(Array.isArray(e)){if(0===e.length)return;this.nodes=e;}else this.nodes=[e];this._updatePosition(),this._updateRotation(),this._updateScale(),this.fire(bv.EVENT_NODESATTACH),this.enabled=true;}detach(){this.enabled=false,this.fire(bv.EVENT_NODESDETACH),this.nodes=[];}prerender(){}update(){this._renderUpdate&&(this._renderUpdate=false,this.fire(bv.EVENT_RENDERUPDATE)),this.enabled&&(this._updatePosition(),this._updateRotation(),this._updateScale());}destroy(){this.detach(),this._device.canvas.removeEventListener("pointerdown",this._onPointerDown),this._device.canvas.removeEventListener("pointermove",this._onPointerMove),this._device.canvas.removeEventListener("pointerup",this._onPointerUp),this._handles.forEach(e=>e.off()),this.root.destroy();}constructor(e,t,i="gizmo"){super(),this._size=1,this._scale=1,this._coordSpace="world",this._handles=[],this._mouseButtons=[true,true,true],this._renderUpdate=false,this.nodes=[],this.intersectShapes=[],this.preventDefault=true,this._layer=t,this._camera=e,this._camera.layers=this._camera.layers.concat(this._layer.id),this._app=this._camera.system.app,this._device=this._app.graphicsDevice,this.root=new fB(i),this._app.root.addChild(this.root),this.root.enabled=false,this._updateScale(),this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this),this._device.canvas.addEventListener("pointerdown",this._onPointerDown),this._device.canvas.addEventListener("pointermove",this._onPointerMove),this._device.canvas.addEventListener("pointerup",this._onPointerUp),this._handles.push(this._app.on("prerender",()=>this.prerender())),this._handles.push(this._app.on("update",()=>this.update())),this._handles.push(this._app.on("destroy",()=>this.destroy()));}}bv.EVENT_POINTERDOWN="pointer:down",bv.EVENT_POINTERMOVE="pointer:move",bv.EVENT_POINTERUP="pointer:up",bv.EVENT_POSITIONUPDATE="position:update",bv.EVENT_ROTATIONUPDATE="rotation:update",bv.EVENT_SCALEUPDATE="scale:update",bv.EVENT_NODESATTACH="nodes:attach",bv.EVENT_NODESDETACH="nodes:detach",bv.EVENT_RENDERUPDATE="render:update";let bS=Object.freeze(new es(1,.3,.3)),by=Object.freeze(new es(.3,1,.3)),bx=Object.freeze(new es(.3,.3,1));Object.freeze(new es(1,1,.5));let bT=Object.freeze(new es(.5,.5,.5,.5)),bE=(e,t)=>new es(e.r,e.g,e.b,t),bw=new ed,bb=new ed,bA=new ed,bC=new eM,bP=new eR,bI=new es,bD=["x","y","z"];class bR extends bv{get theme(){return this._theme}set xAxisColor(e){this.setTheme({shapeBase:{x:e},shapeHover:{x:bE(e,this.colorAlpha)},guideBase:{x:e},guideOcclusion:1});}get xAxisColor(){return this._theme.shapeBase.x}set yAxisColor(e){this.setTheme({shapeBase:{y:e},shapeHover:{y:bE(e,this.colorAlpha)},guideBase:{y:e},guideOcclusion:1});}get yAxisColor(){return this._theme.shapeBase.y}set zAxisColor(e){this.setTheme({shapeBase:{z:e},shapeHover:{z:bE(e,this.colorAlpha)},guideBase:{z:e},guideOcclusion:1});}get zAxisColor(){return this._theme.shapeBase.z}set colorAlpha(e){this.setTheme({shapeHover:{x:bE(this._theme.shapeHover.x,e),y:bE(this._theme.shapeHover.y,e),z:bE(this._theme.shapeHover.z,e),xyz:bE(this._theme.shapeHover.xyz,e),f:bE(this._theme.shapeHover.f,e)}});}get colorAlpha(){return (this._theme.shapeHover.x.a+this._theme.shapeHover.y.a+this._theme.shapeHover.z.a+this._theme.shapeHover.xyz.a+this._theme.shapeHover.f.a)/5}get _dragging(){return !this._hoverAxis&&!!this._selectedAxis}_getAxis(e){return e?e.node.name.split(":")[1]:""}_getIsPlane(e){return !!e&&-1!==e.node.name.indexOf("plane")}_hover(e){if(this._dragging)return;let t=new Set(this._hovering),i=false,s=e=>{t.has(e)?t.delete(e):(this._hovering.add(e),this._shapes[e]?.hover(true),i=true);};if(this._hoverAxis=this._getAxis(e),this._hoverIsPlane=this._getIsPlane(e),this._hoverAxis)if("xyz"===this._hoverAxis)s("x"),s("y"),s("z"),s("xyz");else if(this._hoverIsPlane)switch(this._hoverAxis){case "x":s("y"),s("z"),s("yz");break;case "y":s("x"),s("z"),s("xz");break;case "z":s("x"),s("y"),s("xy");}else s(this._hoverAxis);for(let e of t)this._hovering.delete(e),this._shapes[e]?.hover(false),i=true;i&&(this._renderUpdate=true);}_createRay(e){if(0===this._camera.projection)return bC.origin.copy(this._camera.entity.getPosition()),bC.direction.sub2(e,bC.origin).normalize(),bC;let t=this._camera.farClip-this._camera.nearClip;return bC.origin.sub2(e,bw.copy(this._camera.entity.forward).mulScalar(t)),bC.direction.copy(this._camera.entity.forward),bC}_createPlane(e,t,i){let s=bw.copy(this.facingDir),r=bP.normal.set(0,0,0);return t?r.copy(this._camera.entity.forward).mulScalar(-1):(r[e]=1,this._rootStartRot.transformVector(r,r),i&&(bb.cross(r,s).normalize(),r.cross(bb,r).normalize())),bP.setFromPointNormal(this._rootStartPos,r)}_dirFromAxis(e,t){return "f"===e?t.copy(this._camera.entity.forward).mulScalar(-1):(t.set(0,0,0),t[e]=1),t}_projectToAxis(e,t){bw.set(0,0,0),bw[t]=1,e.copy(bw.mulScalar(bw.dot(e)));let i=e[t];e.set(0,0,0),e[t]=i;}_screenToPoint(e,t,i=false,s=false){let r=this._camera.screenToWorld(e,t,1),a=this._selectedAxis,n=this._createRay(r);return !this._createPlane(a,i,s).intersectsRay(n,bA),bA}_drawGuideLines(e,t,i,s){for(let r of bD){if("xyz"===i){this._drawSpanLine(e,t,r);continue}s?r!==i&&this._drawSpanLine(e,t,r):r===i&&this._drawSpanLine(e,t,r);}}_drawSpanLine(e,t,i){let s=this._dirFromAxis(i,bw),r=this._theme.guideBase[i],a=bw.copy(s).mulScalar(this._camera.farClip-this._camera.nearClip),n=bb.copy(a).mulScalar(-1);if(t.transformVector(a,a).add(e),t.transformVector(n,n).add(e),this._theme.guideOcclusion<1){let e=bI.copy(r);e.a*=1-this._theme.guideOcclusion,this._app.drawLine(a,n,e,false,this._layer);}0!==r.a&&this._app.drawLine(a,n,r,true);}_createTransform(){for(let e in this._shapes){let t=this._shapes[e];this.root.addChild(t.entity),this.intersectShapes.push(t);for(let e=0;e<t.meshInstances.length;e++)this._shapeMap.set(t.meshInstances[e],t);}}enableShape(e,t){"face"===e&&(e="f");let i=this._shapes[e];i&&(i.disabled=!t);}isShapeEnabled(e){"face"===e&&(e="f");let t=this._shapes[e];return !!t&&!t.disabled}setTheme(e){let t={...this._theme,...e};if("object"==typeof t.shapeBase&&"object"==typeof t.shapeHover&&"object"==typeof t.guideBase){for(let e in t.shapeBase)t.shapeBase[e]instanceof es&&this._theme.shapeBase[e].copy(t.shapeBase[e]);for(let e in t.shapeHover)t.shapeHover[e]instanceof es&&this._theme.shapeHover[e].copy(t.shapeHover[e]);for(let e in t.guideBase)t.guideBase[e]instanceof es&&this._theme.guideBase[e].copy(t.guideBase[e]);for(let e in "number"==typeof t.guideOcclusion&&(this._theme.guideOcclusion=ei.clamp(t.guideOcclusion,0,1)),t.disabled instanceof es&&this._theme.disabled.copy(t.disabled),this._shapes)this._shapes[e].hover(!!this._hoverAxis);}}prerender(){if(super.prerender(),!this.enabled)return;let e=this.root.getLocalPosition(),t=this.root.getRotation(),i=this._hoverAxis||this._selectedAxis,s=this._hoverIsPlane||this._selectedIsPlane;this._drawGuideLines(e,t,i,s);}destroy(){for(let e in super.destroy(),this._shapes)this._shapes[e].destroy();}constructor(e,t,i="gizmo:transform"){super(e,t,i),this._theme={shapeBase:{x:bS.clone(),y:by.clone(),z:bx.clone(),xyz:new es(.8,.8,.8,1),f:new es(.8,.8,.8,1)},shapeHover:{x:new es().lerp(bS,es.WHITE,.75),y:new es().lerp(by,es.WHITE,.75),z:new es().lerp(bx,es.WHITE,.75),xyz:es.WHITE.clone(),f:es.WHITE.clone()},guideBase:{x:bS.clone(),y:by.clone(),z:bx.clone()},guideOcclusion:.8,disabled:bT.clone()},this._rootStartPos=new ed,this._rootStartRot=new ex,this._shapes={},this._shapeMap=new Map,this._hovering=new Set,this._hoverAxis="",this._hoverIsPlane=false,this._selectedAxis="",this._selectedIsPlane=false,this._selectionStartPoint=new ed,this.snap=false,this.snapIncrement=1,this.dragMode="selected",this.on(bv.EVENT_POINTERDOWN,(e,t,i)=>{let s=this._shapeMap.get(i);if(s?.disabled||this._dragging||!i)return;this._hoverAxis="",this._hoverIsPlane=false,this._selectedAxis=this._getAxis(i),this._selectedIsPlane=this._getIsPlane(i),this._rootStartPos.copy(this.root.getLocalPosition()),this._rootStartRot.copy(this.root.getRotation());let r=this._screenToPoint(e,t);this._selectionStartPoint.copy(r),this.fire(bR.EVENT_TRANSFORMSTART,r,e,t);}),this.on(bv.EVENT_POINTERMOVE,(e,t,i)=>{let s=this._shapeMap.get(i);if(s?.disabled||(this._hover(i),!this._dragging))return;let r=this._screenToPoint(e,t);this.fire(bR.EVENT_TRANSFORMMOVE,r,e,t);}),this.on(bv.EVENT_POINTERUP,(e,t,i)=>{this._hover(i),this._dragging&&(i&&(this._hoverAxis=this._selectedAxis,this._hoverIsPlane=this._selectedIsPlane),this._selectedAxis="",this._selectedIsPlane=false,this.fire(bR.EVENT_TRANSFORMEND));}),this.on(bv.EVENT_NODESDETACH,()=>{this._hoverAxis="",this._hoverIsPlane=false,this._hover(),this.fire(bv.EVENT_POINTERUP);});}}bR.EVENT_TRANSFORMSTART="transform:start",bR.EVENT_TRANSFORMMOVE="transform:move",bR.EVENT_TRANSFORMEND="transform:end";let bL=new ed,bM=new ed,bO=new ed;class bF{get transform(){return this._transform}get priority(){return this._priority}setTransform(e=new ed,t=new ex,i=new ed){this.transform.setTRS(e,t,i);}fromGeometry(e){if(!e||!(e instanceof ck))throw Error("No geometry provided.");let t=e.positions??[],i=e.indices??[];this.tris=[];for(let e=0;e<i.length;e+=3){let s=i[e],r=i[e+1],a=i[e+2];bL.set(t[3*s],t[3*s+1],t[3*s+2]),bM.set(t[3*r],t[3*r+1],t[3*r+2]),bO.set(t[3*a],t[3*a+1],t[3*a+2]);let n=new eH(bL,bM,bO);this.tris.push(n);}}constructor(e,t=0){this._priority=0,this._transform=new ey,this.tris=[],this.fromGeometry(e),this._priority=t;}}let bN={uniqueName:"gizmo-unlit",attributes:{vertex_position:e6},vertexGLSL:`
		attribute vec3 vertex_position;
	
		uniform mat4 matrix_model;
		uniform mat4 matrix_viewProjection;
	
		void main(void) {
			gl_Position = matrix_viewProjection * matrix_model * vec4(vertex_position, 1.0);
			gl_Position.z = clamp(gl_Position.z, -abs(gl_Position.w), abs(gl_Position.w));
		}
	`,fragmentGLSL:`
		#include "gammaPS"
	
		precision highp float;
	
		uniform vec4 uColor;
		uniform float uDepth;
		void main(void) {
			if (uColor.a < 1.0 / 255.0) {
				discard;
			}
			gl_FragColor = vec4(gammaCorrectOutput(decodeGamma(uColor)), uColor.a);
			#if DEPTH_WRITE == 1
				gl_FragDepth = uDepth;
			#endif
		}
	`,vertexWGSL:`
		attribute vertex_position: vec3f;
		uniform matrix_model: mat4x4f;
		uniform matrix_viewProjection: mat4x4f;
		@vertex
		fn vertexMain(input: VertexInput) -> VertexOutput {
			var output: VertexOutput;
			let pos = vec4f(input.vertex_position, 1.0);
			output.position = uniform.matrix_viewProjection * uniform.matrix_model * pos;
			output.position.z = clamp(output.position.z, -abs(output.position.w), abs(output.position.w));
			return output;
		}
	`,fragmentWGSL:`
		#include "gammaPS"
		uniform uColor: vec4f;
		uniform uDepth: f32;
		@fragment
		fn fragmentMain(input: FragmentInput) -> FragmentOutput {
			var output: FragmentOutput;
			if (uniform.uColor.a < 1.0 / 255.0) {
				discard;
			}
			output.color = vec4f(gammaCorrectOutput(decodeGamma(uniform.uColor)), uniform.uColor.a);
			#if DEPTH_WRITE == 1
				output.fragDepth = uniform.uDepth;
			#endif
			return output;
		}
	`},bB=new ck;bB.positions=[],bB.normals=[];class bk{set disabled(e){this._disabled=e??false,this.hover(false);}get disabled(){return this._disabled}set visible(e){if(e!==this._visible){for(let t=0;t<this.meshInstances.length;t++)this.meshInstances[t].visible=e;this._visible=e;}}get visible(){return this._visible}_createRenderComponent(e,t){let i=this._disabled?this._disabledColor:this._defaultColor;this._material.setDefine("DEPTH_WRITE",this._depth>0?"1":"0"),this._material.setParameter("uDepth",this._depth),this._material.setParameter("uColor",i.toArray()),this._material.cull=this._cull,this._material.blendType=2,this._material.update();let s=[];for(let e=0;e<t.length;e++){let i=new od(t[e],this._material);i.cull=false,s.push(i),this.meshInstances.push(i);}e.addComponent("render",{meshInstances:s,layers:this._layers,castShadows:false});}_update(){this.entity.setLocalPosition(this._position),this.entity.setLocalEulerAngles(this._rotation),this.entity.setLocalScale(this._scale);}hover(e){let t=this._disabled?this._disabledColor:e?this._hoverColor:this._defaultColor;this._material.setParameter("uColor",t.toArray());}destroy(){this.entity.destroy();}constructor(e,t,i){this._position=new ed,this._rotation=new ed,this._scale=new ed(1,1,1),this._layers=[],this._material=new cf(bN),this._disabled=false,this._visible=true,this._defaultColor=es.WHITE,this._hoverColor=es.BLACK,this._disabledColor=bT,this._cull=1,this._depth=-1,this.triData=[],this.meshInstances=[],this.device=e,this.axis=i.axis??"x",i.position instanceof ed&&this._position.copy(i.position),i.rotation instanceof ed&&this._rotation.copy(i.rotation),i.scale instanceof ed&&this._scale.copy(i.scale),this._disabled=i.disabled??this._disabled,this._visible=i.visible??this._visible,this._layers=i.layers??this._layers,i.defaultColor instanceof es&&(this._defaultColor=i.defaultColor),i.hoverColor instanceof es&&(this._hoverColor=i.hoverColor),i.disabledColor instanceof es&&(this._disabledColor=i.disabledColor),this._cull=i.cull??this._cull,this._depth=i.depth??this._depth,this.entity=new fB(`${t}:${this.axis}`),this.entity.setLocalPosition(this._position),this.entity.setLocalEulerAngles(this._rotation),this.entity.setLocalScale(this._scale);}}class bU extends bk{set size(e){this._size=e??this._size,this._update();}get size(){return this._size}set gap(e){this._gap=e??this._gap,this._update();}get gap(){return this._gap}set flipped(e){1e-6>this._flipped.distance(e)||(this._flipped.copy(e),this._update());}get flipped(){return this._flipped}_update(){let e=this._size/2+this._gap;this._position.set(this._flipped.x?-e:e,this._flipped.y?-e:e,this._flipped.z?-e:e),this._position[this.axis]=0,this.entity.setLocalPosition(this._position),this.entity.setLocalEulerAngles(this._rotation),this.entity.setLocalScale(this._size,this._size,this._size);}constructor(e,t={}){super(e,"plane",t),this._cull=0,this._size=.16,this._gap=0,this._flipped=new ed,this._size=t.size??this._size,this._gap=t.gap??this._gap,this.triData=[new bF(new us)],this._createRenderComponent(this.entity,[n7.fromGeometry(this.device,new us)]),this._update();}}let bz=new ed,bV=new ed,bG=new ex;class bH extends bk{set gap(e){this._gap=e??this._gap,this._update();}get gap(){return this._gap}set lineThickness(e){this._lineThickness=e??this._lineThickness,this._update();}get lineThickness(){return this._lineThickness}set lineLength(e){this._lineLength=e??this._lineLength,this._update();}get lineLength(){return this._lineLength}set arrowThickness(e){this._arrowThickness=e??this._arrowThickness,this._update();}get arrowThickness(){return this._arrowThickness}set arrowLength(e){this._arrowLength=e??this._arrowLength,this._update();}get arrowLength(){return this._arrowLength}set tolerance(e){this._tolerance=e,this._update();}get tolerance(){return this._tolerance}_update(){bz.set(0,this._gap+.5*this._arrowLength+this._lineLength,0),bG.set(0,0,0,1),bV.set(this._arrowThickness,this._arrowLength,this._arrowThickness),this.triData[0].setTransform(bz,bG,bV),bz.set(0,this._gap+.5*this._lineLength,0),bG.set(0,0,0,1),bV.set(this._lineThickness+this._tolerance,this._lineLength,this._lineThickness+this._tolerance),this.triData[1].setTransform(bz,bG,bV),this._head.setLocalPosition(0,this._gap+.5*this._arrowLength+this._lineLength,0),this._head.setLocalScale(this._arrowThickness,this._arrowLength,this._arrowThickness),this._line.setLocalPosition(0,this._gap+.5*this._lineLength,0),this._line.setLocalScale(this._lineThickness,this._lineLength,this._lineThickness);}constructor(e,t={}){super(e,"arrow",t),this._gap=0,this._lineThickness=.02,this._lineLength=.5,this._arrowThickness=.12,this._arrowLength=.18,this._tolerance=.1,this._gap=t.gap??this._gap,this._lineThickness=t.lineThickness??this._lineThickness,this._lineLength=t.lineLength??this._lineLength,this._arrowThickness=t.arrowThickness??this._arrowThickness,this._arrowLength=t.arrowLength??this._arrowLength,this._tolerance=t.tolerance??this._tolerance,this.triData=[new bF(new ut),new bF(new ui,1)],this._head=new fB(`head:${this.axis}`),this.entity.addChild(this._head),this._createRenderComponent(this._head,[n7.fromGeometry(this.device,new ut)]),this._line=new fB(`line:${this.axis}`),this.entity.addChild(this._line),this._createRenderComponent(this._line,[n7.fromGeometry(this.device,new ui)]),this._update();}}class bW extends bk{set radius(e){this._radius=e??this._radius,this._update();}get radius(){return this._radius}_update(){let e=2*this._radius;this.entity.setLocalScale(e,e,e);}constructor(e,t={}){super(e,"sphereCenter",t),this._radius=.03,this._radius=t.radius??this._radius,this.triData=[new bF(new cz,2)],this._createRenderComponent(this.entity,[n7.fromGeometry(this.device,new cz({latitudeBands:32,longitudeBands:32}))]),this._update();}}let bX=new ed,bY=new ed,bq=new ed,b$=new ed,bj=new ex,bK=["x","y","z"];class bZ extends bk{_createTorusGeometry(e){return new ur({tubeRadius:this._tubeRadius+this._tolerance,ringRadius:this._ringRadius,sectorAngle:e,segments:20})}_createTorusMesh(e){let t=new ur({tubeRadius:this._tubeRadius,ringRadius:this._ringRadius,sectorAngle:e,segments:80});return n7.fromGeometry(this.device,t)}set tubeRadius(e){this._tubeRadius=e??this._tubeRadius,this._update();}get tubeRadius(){return this._tubeRadius}set ringRadius(e){this._ringRadius=e??this._ringRadius,this._update();}get ringRadius(){return this._ringRadius}set tolerance(e){this._tolerance=e??this._tolerance,this._update();}get tolerance(){return this._tolerance}_update(){this._triDataCache[0].fromGeometry(this._createTorusGeometry(this._sectorAngle)),this._triDataCache[1].fromGeometry(this._createTorusGeometry(360)),this.meshInstances[0].mesh=this._createTorusMesh(this._sectorAngle),this.meshInstances[1].mesh=this._createTorusMesh(360);}show(e){switch(e){case "sector":this.triData[0]=this._triDataCache[0],this.meshInstances[0].visible=true,this.meshInstances[1].visible=false;break;case "ring":this.triData[0]=this._triDataCache[1],this.meshInstances[0].visible=false,this.meshInstances[1].visible=true;break;case "none":this.meshInstances[0].visible=false,this.meshInstances[1].visible=false;}}constructor(e,t={}){super(e,"disk",t),this._tubeRadius=.01,this._ringRadius=.5,this._sectorAngle=360,this._tolerance=.05,this._tubeRadius=t.tubeRadius??this._tubeRadius,this._ringRadius=t.ringRadius??this._ringRadius,this._sectorAngle=t.sectorAngle??this._sectorAngle,this._triDataCache=[new bF(this._createTorusGeometry(this._sectorAngle)),new bF(this._createTorusGeometry(360))],this.triData=[this._triDataCache[0]],this._createRenderComponent(this.entity,[this._createTorusMesh(this._sectorAngle),this._createTorusMesh(360)]),this.show("sector"),this._update();}}let bQ=new ed;class bJ{set thickness(e){this._thickness=e??this._thickness;}get thickness(){return this._thickness}draw(e,t,i,s){this._material.setParameter("uColor",s.toArray());let r=bQ.sub2(t,e).normalize(),a=Math.atan2(-r.y,Math.sqrt(r.x*r.x+r.z*r.z))*ei.RAD_TO_DEG,n=Math.atan2(-r.x,-r.z)*ei.RAD_TO_DEG;this.entity.setLocalEulerAngles(-a+90,n,0);let o=e.distance(t)*i;this.entity.setLocalPosition(r.mulScalar(.5*o).add(e)),this.entity.setLocalScale(this._thickness*i,o,this._thickness*i);}destroy(){this._material.destroy(),this.entity.destroy();}constructor(e,t,i={}){this._thickness=.02,this._material=new cf(bN),this.entity=new fB("mesh-line"),this._thickness=i.thickness??this._thickness,this._material.blendState=iS.ALPHABLEND,this._material.setDefine("DEPTH_WRITE","1"),this._material.setParameter("uDepth",0),this._material.update();let s=new od(n7.fromGeometry(e.graphicsDevice,new ui),this._material);this.entity.addComponent("render",{meshInstances:[s],layers:[t.id]});}}let b0=new ed,b1=new ed,b2=new ed,b3=new ed,b4=new ex,b5=new ex,b8=new es,b6=["x","y","z"];class b9 extends bk{set size(e){this._size=e??this._size,this._update();}get size(){return this._size}_update(){this.entity.setLocalScale(this._size,this._size,this._size);}constructor(e,t={}){super(e,"boxCenter",t),this._size=.06,this._size=t.size??this._size,this.triData=[new bF(new cU,2)],this._createRenderComponent(this.entity,[n7.fromGeometry(this.device,new cU)]),this._update();}}let b7=new ed,Ae=new ed,At=new ex;class Ai extends bk{set gap(e){this._gap=e??this._gap,this._update();}get gap(){return this._gap}set lineThickness(e){this._lineThickness=e??this._lineThickness,this._update();}get lineThickness(){return this._lineThickness}set lineLength(e){this._lineLength=e??this._lineLength,this._update();}get lineLength(){return this._lineLength}set boxSize(e){this._boxSize=e??this._boxSize,this._update();}get boxSize(){return this._boxSize}set tolerance(e){this._tolerance=e,this._update();}get tolerance(){return this._tolerance}set flipped(e){this._flipped!==e&&(this._flipped=e,this._rotation.equals(ed.ZERO)?b7.set(0,0,180*!!this._flipped):b7.copy(this._rotation).mulScalar(this._flipped?-1:1),this._line.enabled=!this._flipped,this.entity.setLocalEulerAngles(b7));}get flipped(){return this._flipped}_update(){b7.set(0,this._gap+.5*this._boxSize+this._lineLength,0),At.set(0,0,0,1),Ae.set(this._boxSize,this._boxSize,this._boxSize),this.triData[0].setTransform(b7,At,Ae),b7.set(0,this._gap+.5*this._lineLength,0),At.set(0,0,0,1),Ae.set(this._lineThickness+this._tolerance,this._lineLength,this._lineThickness+this._tolerance),this.triData[1].setTransform(b7,At,Ae),this._box.setLocalPosition(0,this._gap+.5*this._boxSize+this._lineLength,0),this._box.setLocalScale(this._boxSize,this._boxSize,this._boxSize),this._line.setLocalPosition(0,this._gap+.5*this._lineLength,0),this._line.setLocalScale(this._lineThickness,this._lineLength,this._lineThickness);}constructor(e,t={}){super(e,"boxLine",t),this._gap=0,this._lineThickness=.02,this._lineLength=.5,this._boxSize=.12,this._tolerance=.1,this._flipped=false,this._gap=t.gap??this._gap,this._lineThickness=t.lineThickness??this._lineThickness,this._lineLength=t.lineLength??this._lineLength,this._boxSize=t.boxSize??this._boxSize,this._tolerance=t.tolerance??this._tolerance,this.triData=[new bF(new cU),new bF(new ui,1)],this._box=new fB(`box:${this.axis}`),this.entity.addChild(this._box),this._createRenderComponent(this._box,[n7.fromGeometry(this.device,new cU)]),this._line=new fB(`line:${this.axis}`),this.entity.addChild(this._line),this._createRenderComponent(this._line,[n7.fromGeometry(this.device,new ui)]),this._update();}}let As=new ed,Ar=new ed,Aa=new ed,An=new ed,Ao=new ex,Al=new ed,Ah=new ed,Ac=new ed,Ad=new ey;class Au extends X{set anchor(e){this._anchor.copy(e),this.dom.style.top=this._anchor.x?"0px":"auto",this.dom.style.right=this._anchor.y?"0px":"auto",this.dom.style.bottom=this._anchor.z?"0px":"auto",this.dom.style.left=this._anchor.w?"0px":"auto";}get anchor(){return this._anchor}set colorX(e){this._colorX.copy(e),this._shapes.px.children[0].setAttribute("fill",this._colorX.toString(false)),this._shapes.px.children[0].setAttribute("stroke",this._colorX.toString(false)),this._shapes.nx.children[0].setAttribute("stroke",this._colorX.toString(false)),this._shapes.xaxis.setAttribute("stroke",this._colorX.toString(false));}get colorX(){return this._colorX}set colorY(e){this._colorY.copy(e),this._shapes.py.children[0].setAttribute("fill",this._colorY.toString(false)),this._shapes.py.children[0].setAttribute("stroke",this._colorY.toString(false)),this._shapes.ny.children[0].setAttribute("stroke",this._colorY.toString(false)),this._shapes.yaxis.setAttribute("stroke",this._colorY.toString(false));}get colorY(){return this._colorY}set colorZ(e){this._colorZ.copy(e),this._shapes.pz.children[0].setAttribute("fill",this._colorZ.toString(false)),this._shapes.pz.children[0].setAttribute("stroke",this._colorZ.toString(false)),this._shapes.nz.children[0].setAttribute("stroke",this._colorZ.toString(false)),this._shapes.zaxis.setAttribute("stroke",this._colorZ.toString(false));}get colorZ(){return this._colorZ}set colorNeg(e){this._colorNeg.copy(e),this._shapes.px.children[0].setAttribute("fill",this._colorNeg.toString(false)),this._shapes.py.children[0].setAttribute("fill",this._colorNeg.toString(false)),this._shapes.pz.children[0].setAttribute("fill",this._colorNeg.toString(false));}get colorNeg(){return this._colorNeg}set radius(e){this._radius=e,this._shapes.px.children[0].setAttribute("r",`${e}`),this._shapes.py.children[0].setAttribute("r",`${e}`),this._shapes.pz.children[0].setAttribute("r",`${e}`),this._shapes.nx.children[0].setAttribute("r",`${e}`),this._shapes.ny.children[0].setAttribute("r",`${e}`),this._shapes.nz.children[0].setAttribute("r",`${e}`),this._resize();}get radius(){return this._radius}set textSize(e){this._textSize=e,this._shapes.px.children[1].setAttribute("font-size",`${e}`),this._shapes.py.children[1].setAttribute("font-size",`${e}`),this._shapes.pz.children[1].setAttribute("font-size",`${e}`);}get textSize(){return this._textSize}set lineThickness(e){this._lineThickness=e,this._shapes.xaxis.setAttribute("stroke-width",`${e}`),this._shapes.yaxis.setAttribute("stroke-width",`${e}`),this._shapes.zaxis.setAttribute("stroke-width",`${e}`),this._shapes.px.children[0].setAttribute("stroke-width",`${e}`),this._shapes.py.children[0].setAttribute("stroke-width",`${e}`),this._shapes.pz.children[0].setAttribute("stroke-width",`${e}`),this._shapes.nx.children[0].setAttribute("stroke-width",`${e}`),this._shapes.ny.children[0].setAttribute("stroke-width",`${e}`),this._shapes.nz.children[0].setAttribute("stroke-width",`${e}`),this._resize();}get lineThickness(){return this._lineThickness}set lineLength(e){this._lineLength=e,this._resize();}get lineLength(){return this._lineLength}_resize(){this._size=2*(this.lineLength+this.radius+this.lineThickness),this.dom.style.width=`${this._size}px`,this.dom.style.height=`${this._size}px`,this._svg.setAttribute("width",`${this._size}`),this._svg.setAttribute("height",`${this._size}`),this._group.setAttribute("transform",`translate(${.5*this._size}, ${.5*this._size})`);}_transform(e,t,i){e.setAttribute("transform",`translate(${t*this._lineLength}, ${i*this._lineLength})`);}_x2y2(e,t,i){e.setAttribute("x2",`${t*this._lineLength}`),e.setAttribute("y2",`${i*this._lineLength}`);}_line(e){let t=document.createElementNS(this._svg.namespaceURI,"line");return t.setAttribute("stroke",e),t.setAttribute("stroke-width",`${this._lineThickness}`),this._group.appendChild(t),t}_circle(e,t=false,i){let s=document.createElementNS(this._svg.namespaceURI,"g"),r=document.createElementNS(this._svg.namespaceURI,"circle");if(r.setAttribute("fill",t?e:this._colorNeg.toString(false)),r.setAttribute("stroke",e),r.setAttribute("stroke-width",`${this._lineThickness}`),r.setAttribute("r",`${this._radius}`),r.setAttribute("cx","0"),r.setAttribute("cy","0"),r.setAttribute("pointer-events","all"),s.appendChild(r),i){let e=document.createElementNS(this._svg.namespaceURI,"text");e.setAttribute("font-size",`${this._textSize}`),e.setAttribute("font-family","Arial"),e.setAttribute("font-weight","bold"),e.setAttribute("text-anchor","middle"),e.setAttribute("alignment-baseline","central"),e.textContent=i,s.appendChild(e);}return s.setAttribute("cursor","pointer"),this._group.appendChild(s),s}update(e){if(!this._size)return;Ad.invert(e),Ad.getX(Al),Ad.getY(Ah),Ad.getZ(Ac),this._transform(this._shapes.px,Al.x,-Al.y),this._transform(this._shapes.nx,-Al.x,Al.y),this._transform(this._shapes.py,Ah.x,-Ah.y),this._transform(this._shapes.ny,-Ah.x,Ah.y),this._transform(this._shapes.pz,Ac.x,-Ac.y),this._transform(this._shapes.nz,-Ac.x,Ac.y),this._x2y2(this._shapes.xaxis,Al.x,-Al.y),this._x2y2(this._shapes.yaxis,Ah.x,-Ah.y),this._x2y2(this._shapes.zaxis,Ac.x,-Ac.y);let t=[{n:["xaxis","px"],value:Al.z},{n:["yaxis","py"],value:Ah.z},{n:["zaxis","pz"],value:Ac.z},{n:["nx"],value:-Al.z},{n:["ny"],value:-Ah.z},{n:["nz"],value:-Ac.z}].sort((e,t)=>e.value-t.value),i=document.createDocumentFragment();t.forEach(e=>{e.n.forEach(e=>{i.appendChild(this._shapes[e]);});}),this._group.appendChild(i);}destroy(){this.dom.remove(),this.off();}constructor(e){super(),this._size=0,this._anchor=new ep(1,1,1,1),this._colorX=bS.clone(),this._colorY=by.clone(),this._colorZ=bx.clone(),this._colorNeg=new es(.3,.3,.3),this._radius=10,this._textSize=10,this._lineThickness=2,this._lineLength=40,this.dom=document.createElement("div"),this.dom.id="view-cube-container",this.dom.style.cssText="position: absolute;margin: auto;pointer-events: none",document.body.appendChild(this.dom),this.anchor=e??this._anchor,this._svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._svg.id="view-cube-svg",this._group=document.createElementNS(this._svg.namespaceURI,"g"),this._svg.appendChild(this._group),this._resize();let t=this._colorX.toString(false),i=this._colorY.toString(false),s=this._colorZ.toString(false);this._shapes={nx:this._circle(t),ny:this._circle(i),nz:this._circle(s),px:this._circle(t,true,"X"),py:this._circle(i,true,"Y"),pz:this._circle(s,true,"Z"),xaxis:this._line(t),yaxis:this._line(i),zaxis:this._line(s)},this._shapes.px.children[0].addEventListener("pointerdown",()=>{this.fire(Au.EVENT_CAMERAALIGN,ed.RIGHT);}),this._shapes.py.children[0].addEventListener("pointerdown",()=>{this.fire(Au.EVENT_CAMERAALIGN,ed.UP);}),this._shapes.pz.children[0].addEventListener("pointerdown",()=>{this.fire(Au.EVENT_CAMERAALIGN,ed.BACK);}),this._shapes.nx.children[0].addEventListener("pointerdown",()=>{this.fire(Au.EVENT_CAMERAALIGN,ed.LEFT);}),this._shapes.ny.children[0].addEventListener("pointerdown",()=>{this.fire(Au.EVENT_CAMERAALIGN,ed.DOWN);}),this._shapes.nz.children[0].addEventListener("pointerdown",()=>{this.fire(Au.EVENT_CAMERAALIGN,ed.FORWARD);}),this.dom.appendChild(this._svg);}}Au.EVENT_CAMERAALIGN="camera:align",e.ABSOLUTE_URL=fm,e.ACTION_GAMEPAD=ay,e.ACTION_KEYBOARD=aS,e.ACTION_MOUSE=av,e.ADDRESS_CLAMP_TO_EDGE=1,e.ADDRESS_MIRRORED_REPEAT=2,e.ADDRESS_REPEAT=0,e.AMBIENTSRC_AMBIENTSH=np,e.AMBIENTSRC_CONSTANT=n_,e.AMBIENTSRC_ENVALATLAS=nm,e.ANIM_BLEND_1D="1D",e.ANIM_BLEND_2D_CARTESIAN=p_,e.ANIM_BLEND_2D_DIRECTIONAL=pm,e.ANIM_BLEND_DIRECT=pg,e.ANIM_CONTROL_STATES=pS,e.ANIM_EQUAL_TO=ph,e.ANIM_GREATER_THAN=pa,e.ANIM_GREATER_THAN_EQUAL_TO=po,e.ANIM_INTERRUPTION_NEXT=pi,e.ANIM_INTERRUPTION_NEXT_PREV=pr,e.ANIM_INTERRUPTION_NONE=pe,e.ANIM_INTERRUPTION_PREV=pt,e.ANIM_INTERRUPTION_PREV_NEXT=ps,e.ANIM_LAYER_ADDITIVE=px,e.ANIM_LAYER_OVERWRITE=py,e.ANIM_LESS_THAN=pn,e.ANIM_LESS_THAN_EQUAL_TO=pl,e.ANIM_NOT_EQUAL_TO=pc,e.ANIM_PARAMETER_BOOLEAN=pf,e.ANIM_PARAMETER_FLOAT=pu,e.ANIM_PARAMETER_INTEGER=pd,e.ANIM_PARAMETER_TRIGGER=pp,e.ANIM_STATE_ANY="ANY",e.ANIM_STATE_END="END",e.ANIM_STATE_START=pv,e.ASPECT_AUTO=0,e.ASPECT_MANUAL=1,e.ASSET_ANIMATION="animation",e.ASSET_AUDIO="audio",e.ASSET_CONTAINER="container",e.ASSET_CSS="css",e.ASSET_CUBEMAP="cubemap",e.ASSET_HTML="html",e.ASSET_IMAGE="image",e.ASSET_JSON="json",e.ASSET_MATERIAL="material",e.ASSET_MODEL="model",e.ASSET_SCRIPT="script",e.ASSET_SHADER="shader",e.ASSET_TEXT="text",e.ASSET_TEXTURE="texture",e.ASSET_TEXTUREATLAS="textureatlas",e.AXIS_KEY="key",e.AXIS_MOUSE_X="mousex",e.AXIS_MOUSE_Y="mousey",e.AXIS_PAD_L_X="padlx",e.AXIS_PAD_L_Y="padly",e.AXIS_PAD_R_X="padrx",e.AXIS_PAD_R_Y="padry",e.AnimBinder=pC,e.AnimClip=f7,e.AnimClipHandler=S1,e.AnimComponent=pZ,e.AnimComponentLayer=pj,e.AnimComponentSystem=p0,e.AnimController=pG,e.AnimCurve=Sp,e.AnimData=Sm,e.AnimEvaluator=pw,e.AnimEvents=pb,e.AnimSnapshot=f9,e.AnimStateGraph=pK,e.AnimStateGraphHandler=S2,e.AnimTarget=pP,e.AnimTrack=pA,e.Animation=du,e.AnimationComponent=pD,e.AnimationComponentSystem=pM,e.AnimationHandler=S0,e.AnimationKey=dc,e.AnimationNode=dd,e.AppBase=fH,e.AppOptions=fX,e.Application=class extends fH{createDevice(e,t){return t.graphicsDeviceOptions||(t.graphicsDeviceOptions={}),k.browser&&navigator.xr&&(t.graphicsDeviceOptions.xrCompatible=true),t.graphicsDeviceOptions.alpha=t.graphicsDeviceOptions.alpha||false,new rQ(e,t.graphicsDeviceOptions)}addComponentSystems(e){e.componentSystems=[gh,mF,__,pM,p0,_H,_6,g6,vt,vg,gz,p4,_J,g_,_o,mu,gD,gO,gZ,_N,_y,g1,Sl];}addResourceHandles(e){e.resourceHandlers=[Sf,S0,S1,S2,yG,yB,xy,y3,yM,S5,yK,yH,yt,yL,ye,yZ,yR,yi,ya,S8,y6,y0,y2,S7,yA];}constructor(e,t={}){super(e);let i=new fX;i.graphicsDevice=t.graphicsDevice??this.createDevice(e,t),this.addComponentSystems(i),this.addResourceHandles(i),i.elementInput=t.elementInput,i.keyboard=t.keyboard,i.mouse=t.mouse,i.touch=t.touch,i.gamepads=t.gamepads,i.scriptPrefix=t.scriptPrefix,i.assetPrefix=t.assetPrefix,i.scriptsOrder=t.scriptsOrder,i.soundManager=new a1,i.lightmapper=f4,i.batchManager=og,i.xr=Ti,this.init(i);}},e.Asset=fy,e.AssetListLoader=class extends X{destroy(){this._registry.off("load",this._onLoad),this._registry.off("error",this._onError),this._waitingAssets.forEach(e=>{this._registry.off(`add:${e}`,this._onAddAsset);}),this.off("progress"),this.off("load");}_assetHasDependencies(e){return "model"===e.type&&e.file?.url&&e.file.url&&e.file.url.match(/.json$/g)}load(e,t){if(this._loading)return;this._loading=true,this._callback=e,this._scope=t,this._registry.on("load",this._onLoad,this),this._registry.on("error",this._onError,this);let i=false;this._assets.forEach(e=>{e.loaded||(i=true,this._assetHasDependencies(e)&&this._registry.loadFromUrl(e.file.url,e.type,(t,i)=>{t?this._onError(t,e):this._onLoad(e);}),this._loadingAssets.add(e),this._registry.add(e));}),this._loadingAssets.forEach(e=>{this._assetHasDependencies(e)||this._registry.load(e);}),i||0!==this._waitingAssets.size||this._loadingComplete();}ready(e,t=this){this._loaded?e.call(t,Array.from(this._assets)):this.once("load",i=>{e.call(t,i);});}_loadingComplete(){this._loaded||(this._loaded=true,this._registry.off("load",this._onLoad,this),this._registry.off("error",this._onError,this),this._failed.length?(this._callback&&this._callback.call(this._scope,"Failed to load some assets",this._failed),this.fire("error",this._failed)):(this._callback&&this._callback.call(this._scope),this.fire("load",Array.from(this._assets))));}_onLoad(e){this._loadingAssets.has(e)&&(this.fire("progress",e),this._loadingAssets.delete(e)),0===this._loadingAssets.size&&setTimeout(()=>{this._loadingComplete();},0);}_onError(e,t){this._loadingAssets.has(t)&&(this._failed.push(t),this._loadingAssets.delete(t)),0===this._loadingAssets.size&&setTimeout(()=>{this._loadingComplete();},0);}_onAddAsset(e){this._waitingAssets.delete(e),this._assets.add(e),e.loaded||(this._loadingAssets.add(e),this._registry.load(e));}_waitForAsset(e){this._waitingAssets.add(e),this._registry.once(`add:${e}`,this._onAddAsset,this);}constructor(e,t){super(),this._assets=new Set,this._loadingAssets=new Set,this._waitingAssets=new Set,this._loading=false,this._loaded=false,this._failed=[],this._registry=t,e.forEach(e=>{if(e instanceof fy)e.registry||(e.registry=t),this._assets.add(e);else {let i=t.get(e);i?this._assets.add(i):this._waitForAsset(e);}});}},e.AssetReference=_2,e.AssetRegistry=fT,e.AudioHandler=S5,e.AudioListenerComponent=p1,e.AudioListenerComponentSystem=p4,e.BAKE_COLOR=0,e.BAKE_COLORDIR=1,e.BINDGROUP_MESH=1,e.BINDGROUP_MESH_UB=2,e.BINDGROUP_VIEW=0,e.BLENDEQUATION_ADD=0,e.BLENDEQUATION_MAX=4,e.BLENDEQUATION_MIN=3,e.BLENDEQUATION_REVERSE_SUBTRACT=2,e.BLENDEQUATION_SUBTRACT=1,e.BLENDMODE_CONSTANT=11,e.BLENDMODE_CONSTANT_ALPHA=11,e.BLENDMODE_CONSTANT_COLOR=11,e.BLENDMODE_DST_ALPHA=9,e.BLENDMODE_DST_COLOR=4,e.BLENDMODE_ONE=1,e.BLENDMODE_ONE_MINUS_CONSTANT=12,e.BLENDMODE_ONE_MINUS_CONSTANT_ALPHA=12,e.BLENDMODE_ONE_MINUS_CONSTANT_COLOR=12,e.BLENDMODE_ONE_MINUS_DST_ALPHA=10,e.BLENDMODE_ONE_MINUS_DST_COLOR=5,e.BLENDMODE_ONE_MINUS_SRC_ALPHA=8,e.BLENDMODE_ONE_MINUS_SRC_COLOR=3,e.BLENDMODE_SRC_ALPHA=6,e.BLENDMODE_SRC_ALPHA_SATURATE=7,e.BLENDMODE_SRC_COLOR=2,e.BLENDMODE_ZERO=0,e.BLEND_ADDITIVE=1,e.BLEND_ADDITIVEALPHA=6,e.BLEND_MAX=10,e.BLEND_MIN=9,e.BLEND_MULTIPLICATIVE=5,e.BLEND_MULTIPLICATIVE2X=7,e.BLEND_NONE=3,e.BLEND_NORMAL=2,e.BLEND_PREMULTIPLIED=4,e.BLEND_SCREEN=8,e.BLEND_SUBTRACTIVE=0,e.BLUR_BOX=0,e.BLUR_GAUSSIAN=1,e.BODYFLAG_KINEMATIC_OBJECT=2,e.BODYFLAG_NORESPONSE_OBJECT=4,e.BODYFLAG_STATIC_OBJECT=1,e.BODYGROUP_DEFAULT=1,e.BODYGROUP_DYNAMIC=1,e.BODYGROUP_ENGINE_1=8,e.BODYGROUP_ENGINE_2=32,e.BODYGROUP_ENGINE_3=64,e.BODYGROUP_KINEMATIC=4,e.BODYGROUP_NONE=0,e.BODYGROUP_STATIC=2,e.BODYGROUP_TRIGGER=16,e.BODYGROUP_USER_1=128,e.BODYGROUP_USER_2=256,e.BODYGROUP_USER_3=512,e.BODYGROUP_USER_4=1024,e.BODYGROUP_USER_5=2048,e.BODYGROUP_USER_6=4096,e.BODYGROUP_USER_7=8192,e.BODYGROUP_USER_8=16384,e.BODYMASK_ALL=65535,e.BODYMASK_NONE=0,e.BODYMASK_NOT_STATIC=65533,e.BODYMASK_NOT_STATIC_KINEMATIC=65529,e.BODYMASK_STATIC=2,e.BODYSTATE_ACTIVE_TAG=1,e.BODYSTATE_DISABLE_DEACTIVATION=4,e.BODYSTATE_DISABLE_SIMULATION=5,e.BODYSTATE_ISLAND_SLEEPING=2,e.BODYSTATE_WANTS_DEACTIVATION=3,e.BODYTYPE_DYNAMIC=mv,e.BODYTYPE_KINEMATIC=mS,e.BODYTYPE_STATIC=mg,e.BUFFERUSAGE_COPY_DST=8,e.BUFFERUSAGE_COPY_SRC=4,e.BUFFERUSAGE_INDEX=16,e.BUFFERUSAGE_INDIRECT=256,e.BUFFERUSAGE_READ=1,e.BUFFERUSAGE_STORAGE=128,e.BUFFERUSAGE_UNIFORM=64,e.BUFFERUSAGE_VERTEX=32,e.BUFFERUSAGE_WRITE=2,e.BUFFER_DYNAMIC=1,e.BUFFER_GPUDYNAMIC=3,e.BUFFER_STATIC=0,e.BUFFER_STREAM=2,e.BUTTON_TRANSITION_MODE_SPRITE_CHANGE=1,e.BUTTON_TRANSITION_MODE_TINT=0,e.Batch=n1,e.BatchGroup=n2,e.BatchManager=og,e.BinaryHandler=S8,e.BindGroupFormat=it,e.BindStorageBufferFormat=t9,e.BindStorageTextureFormat=ie,e.BindTextureFormat=t7,e.BindUniformBufferFormat=t6,e.BlendState=iS,e.BoundingBox=eC,e.BoundingSphere=eD,e.BoxGeometry=cU,e.Bundle=fb,e.BundleHandler=fP,e.BundleRegistry=fE,e.ButtonComponent=ml,e.ButtonComponentSystem=mu,e.CHUNKAPI_1_51="1.51",e.CHUNKAPI_1_55="1.55",e.CHUNKAPI_1_56="1.56",e.CHUNKAPI_1_57="1.57",e.CHUNKAPI_1_58="1.58",e.CHUNKAPI_1_60="1.60",e.CHUNKAPI_1_62="1.62",e.CHUNKAPI_1_65="1.65",e.CHUNKAPI_1_70="1.70",e.CHUNKAPI_2_1="2.1",e.CHUNKAPI_2_3="2.3",e.CHUNKAPI_2_5="2.5",e.CHUNKAPI_2_6="2.6",e.CHUNKAPI_2_7="2.7",e.CHUNKAPI_2_8="2.8",e.CLEARFLAG_COLOR=1,e.CLEARFLAG_DEPTH=2,e.CLEARFLAG_STENCIL=4,e.CUBEFACE_NEGX=1,e.CUBEFACE_NEGY=3,e.CUBEFACE_NEGZ=5,e.CUBEFACE_POSX=0,e.CUBEFACE_POSY=2,e.CUBEFACE_POSZ=4,e.CUBEPROJ_BOX=1,e.CUBEPROJ_NONE=0,e.CULLFACE_BACK=1,e.CULLFACE_FRONT=2,e.CULLFACE_FRONTANDBACK=3,e.CULLFACE_NONE=0,e.CURVE_LINEAR=0,e.CURVE_SMOOTHSTEP=1,e.CURVE_SPLINE=4,e.CURVE_STEP=5,e.Camera=oP,e.CameraComponent=g4,e.CameraComponentSystem=g6,e.CameraFrame=class{destroy(){this.disable(),this.cameraLayersChanged.off();}enable(){this.renderPassCamera=this.createRenderPass(),this.cameraComponent.renderPasses=[this.renderPassCamera];}disable(){let e=this.cameraComponent;e.renderPasses?.forEach(e=>{e.destroy();}),e.renderPasses=[],e.rendering=null,e.jitter=0,e.shaderParams.ssaoEnabled=false,this.renderPassCamera=null;}createRenderPass(){return new wk(this.app,this,this.cameraComponent,this.options)}set enabled(e){this._enabled!==e&&(e?this.enable():this.disable(),this._enabled=e);}get enabled(){return this._enabled}updateOptions(){let{options:e,rendering:t,bloom:i,taa:s,ssao:r}=this;e.stencil=t.stencil,e.samples=t.samples,e.sceneColorMap=t.sceneColorMap,e.prepassEnabled=t.sceneDepthMap,e.bloomEnabled=i.intensity>0,e.taaEnabled=s.enabled,e.ssaoType=r.type,e.ssaoBlurEnabled=r.blurEnabled,e.formats=t.renderFormats.slice(),e.dofEnabled=this.dof.enabled,e.dofNearBlur=this.dof.nearBlur,e.dofHighQuality=this.dof.highQuality;}update(){if(!this._enabled)return;let e=this.cameraComponent,{options:t,renderPassCamera:i,rendering:s,bloom:r,grading:a,vignette:n,fringing:o,taa:l,ssao:h}=this;this.updateOptions(),i.update(t);let{composePass:c,bloomPass:d,ssaoPass:u,dofPass:f}=i;i.renderTargetScale=ei.clamp(s.renderTargetScale,.1,1),c.toneMapping=s.toneMapping,c.sharpness=s.sharpness,t.bloomEnabled&&d&&(c.bloomIntensity=r.intensity,d.blurLevel=r.blurLevel),t.dofEnabled&&(f.focusDistance=this.dof.focusDistance,f.focusRange=this.dof.focusRange,f.blurRadius=this.dof.blurRadius,f.blurRings=this.dof.blurRings,f.blurRingPoints=this.dof.blurRingPoints),t.ssaoType!==ws&&(u.intensity=h.intensity,u.power=h.power,u.radius=h.radius,u.sampleCount=h.samples,u.minAngle=h.minAngle,u.scale=h.scale,u.randomize=h.randomize),c.gradingEnabled=a.enabled,a.enabled&&(c.gradingSaturation=a.saturation,c.gradingBrightness=a.brightness,c.gradingContrast=a.contrast,c.gradingTint=a.tint),c.colorLUT=this.colorLUT.texture,c.colorLUTIntensity=this.colorLUT.intensity,c.vignetteEnabled=n.intensity>0,c.vignetteEnabled&&(c.vignetteInner=n.inner,c.vignetteOuter=n.outer,c.vignetteCurvature=n.curvature,c.vignetteIntensity=n.intensity,c.vignetteColor.copy(n.color)),c.fringingEnabled=o.intensity>0,c.fringingEnabled&&(c.fringingIntensity=o.intensity),e.jitter=l.enabled?l.jitter:0,c.debug=this.debug,"ssao"===c.debug&&t.ssaoType===ws&&(c.debug=null),"vignette"!==c.debug||c.vignetteEnabled||(c.debug=null);}constructor(e,t){this._enabled=true,this.rendering={renderFormats:[18,12,14],stencil:false,renderTargetScale:1,samples:1,sceneColorMap:false,sceneDepthMap:false,toneMapping:0,sharpness:0},this.ssao={type:ws,blurEnabled:true,randomize:false,intensity:.5,radius:30,samples:12,power:6,minAngle:10,scale:1},this.bloom={intensity:0,blurLevel:16},this.grading={enabled:false,brightness:1,contrast:1,saturation:1,tint:new es(1,1,1,1)},this.colorLUT={texture:null,intensity:1},this.vignette={intensity:0,inner:.5,outer:1,curvature:.5,color:new es(0,0,0)},this.taa={enabled:false,jitter:1},this.fringing={intensity:0},this.dof={enabled:false,nearBlur:false,focusDistance:100,focusRange:10,blurRadius:3,blurRings:4,blurRingPoints:5,highQuality:true},this.debug=null,this.options=new wN,this.renderPassCamera=null,this.app=e,this.cameraComponent=t,this.updateOptions(),this.enable(),this.cameraLayersChanged=t.on("set:layers",()=>{this.renderPassCamera&&(this.renderPassCamera.layersDirty=true);});}},e.CameraFrameOptions=wN,e.CanvasFont=class extends X{createTextures(e){let t=this._normalizeCharsSet(e);if(t.length!==this.chars.length)return void this._renderAtlas(t);for(let e=0;e<t.length;e++)if(t[e]!==this.chars[e])return void this._renderAtlas(t)}updateTextures(e){let t=this._normalizeCharsSet(e),i=[];for(let e=0;e<t.length;e++){let s=t[e];this.data.chars[s]||i.push(s);}i.length>0&&this._renderAtlas(this.chars.concat(i));}destroy(){this.atlases.forEach(e=>e.destroy()),this.chars=null,this.color=null,this.data=null,this.fontName=null,this.fontSize=null,this.glyphSize=null,this.intensity=null,this.atlases=null,this.type=null,this.fontWeight=null;}_colorToRgbString(e,t){let i=Math.round(255*e.r),s=Math.round(255*e.g),r=Math.round(255*e.b);return t?`rgba(${i}, ${s}, ${r}, ${e.a})`:`rgb(${i}, ${s}, ${r})`}renderCharacter(e,t,i,s,r){e.fillStyle=r,e.fillText(t,i,s);}_getAtlas(e){return e>=this.atlases.length&&(this.atlases[e]=new Ts(this.app.graphicsDevice,this.width,this.height,`font-atlas-${this.fontName}-${e}`)),this.atlases[e]}_renderAtlas(e){this.chars=e;let t=this.width,i=this.height,s=this._colorToRgbString(this.color,false),r=this.color.a;this.color.a=1/255;let a=this._colorToRgbString(this.color,true);this.color.a=r;let n=0,o=this._getAtlas(n++);o.clear(a),this.data=this._createJson(this.chars,this.fontName,t,i);let l=H.getSymbols(this.chars.join("")),h=0,c=0,d={};for(let e=0;e<l.length;e++){let t=l[e];d[t]=this._getTextMetrics(t),h=Math.max(h,d[t].height),c=Math.max(c,d[t].descent);}this.glyphSize=Math.max(this.glyphSize,h);let u=this.glyphSize+2*this.padding,f=this.glyphSize+2*this.padding,p=this.glyphSize/2+this.padding,m=f-c-this.padding,_=0,g=0;for(let e=0;e<l.length;e++){let r=l[e],h=H.getCodePoint(l[e]),v=this.fontSize;o.ctx.font=`${this.fontWeight} ${v.toString()}px ${this.fontName}`,o.ctx.textAlign="center",o.ctx.textBaseline="alphabetic";let S=o.ctx.measureText(r).width;S>v&&(v=this.fontSize*this.fontSize/S,o.ctx.font=`${this.fontWeight} ${v.toString()}px ${this.fontName}`,S=this.fontSize),this.renderCharacter(o.ctx,r,_+p,g+m,s);let y=this.padding+(this.glyphSize-S)/2,x=-this.padding+d[r].descent-c,T=S;this._addChar(this.data,r,h,_,g,u,f,y,x,T,n-1,t,i),(_+=u)+u>t&&(_=0,(g+=f)+f>i&&((o=this._getAtlas(n++)).clear(a),g=0));}this.atlases.splice(n).forEach(e=>e.destroy()),this.atlases.forEach(e=>e.texture.upload()),this.fire("render");}_createJson(e,t,i,s){return {version:3,intensity:this.intensity,info:{face:t,width:i,height:s,maps:[{width:i,height:s}]},chars:{}}}_addChar(e,t,i,s,r,a,n,o,l,h,c,d,u){e.info.maps.length<c+1&&e.info.maps.push({width:d,height:u});let f=this.fontSize/32;e.chars[t]={id:i,letter:t,x:s,y:r,width:a,height:n,xadvance:h/f,xoffset:o/f,yoffset:(l+this.padding)/f,scale:f,range:1,map:c,bounds:[0,0,a/f,n/f]};}_normalizeCharsSet(e){let t=this.app.systems.element.getUnicodeConverter();t&&(e=t(e));let i={},s=H.getSymbols(e);for(let e=0;e<s.length;e++){let t=s[e];i[t]||(i[t]=t);}return Object.keys(i).sort()}_getTextMetrics(e){let t=document.createElement("span");t.id="content-span",t.innerHTML=e;let i=document.createElement("div");i.id="content-block",i.style.display="inline-block",i.style.width="1px",i.style.height="0px";let s=document.createElement("div");s.appendChild(t),s.appendChild(i),s.style.font=`${this.fontSize}px ${this.fontName}`,document.body.appendChild(s);let r=-1,a=-1,n=-1;try{i.style["vertical-align"]="baseline",r=i.offsetTop-t.offsetTop,i.style["vertical-align"]="bottom",a=(n=i.offsetTop-t.offsetTop)-r;}finally{document.body.removeChild(s);}return {ascent:r,descent:a,height:n}}get textures(){return this.atlases.map(e=>e.texture)}constructor(e,t={}){super(),this.type="bitmap",this.app=e,this.intensity=0,this.fontWeight=t.fontWeight||"normal",this.fontSize=parseInt(t.fontSize,10),this.glyphSize=this.fontSize,this.fontName=t.fontName||"Arial",this.color=t.color||new es(1,1,1),this.padding=t.padding||0,this.width=Math.min(4096,t.width||512),this.height=Math.min(4096,t.height||512),this.atlases=[],this.chars="",this.data={};}},e.CapsuleGeometry=ue,e.ChunkUtils=cF,e.CollisionComponent=mm,e.CollisionComponentSystem=mF,e.Color=es,e.Component=f5,e.ComponentSystem=f8,e.ComponentSystemRegistry=fw,e.Compute=r6,e.ComputeRadixSort=dS,e.ConeGeometry=ut,e.ContactPoint=gn,e.ContactResult=go,e.ContainerHandler=S7,e.ContainerResource=class{instantiateModelEntity(e){return null}instantiateRenderEntity(e){return null}getMaterialVariants(){return null}applyMaterialVariant(e,t){}applyMaterialVariantInstances(e,t){}},e.Controller=class{attach(e){this._element=e,this._keyboard&&this._keyboard.attach(e),this._mouse&&this._mouse.attach(e);}detach(){this._keyboard&&this._keyboard.detach(),this._mouse&&this._mouse.detach(),this._element=null;}disableContextMenu(){this._mouse||this._enableMouse(),this._mouse.disableContextMenu();}enableContextMenu(){this._mouse||this._enableMouse(),this._mouse.enableContextMenu();}update(e){for(let e in this._keyboard&&this._keyboard.update(),this._mouse&&this._mouse.update(),this._gamepads&&this._gamepads.update(),this._axesValues={},this._axes)this._axesValues[e]=[];}appendAction(e,t){this._actions[e]=this._actions[e]||[],this._actions[e].push(t);}registerKeys(e,t){if(this._keyboard||this._enableKeyboard(),this._actions[e])throw Error(`Action: ${e} already registered`);if(void 0===t)throw Error("Invalid button");t.length||(t=[t]),this.appendAction(e,{type:aS,keys:t});}registerMouse(e,t){if(this._mouse||this._enableMouse(),void 0===t)throw Error("Invalid button");this.appendAction(e,{type:av,button:t});}registerPadButton(e,t,i){if(void 0===i)throw Error("Invalid button");this.appendAction(e,{type:ay,button:i,pad:t});}registerAxis(e){let t=e.name;this._axes[t]||(this._axes[t]=[]);let i=this._axes[t].push(t);(e=e||{}).pad=e.pad||0;let s=function(s,r,a,n){switch(r){case "mousex":s._mouse.on("mousemove",e=>{s._axesValues[t][i]=e.dx/10;});break;case "mousey":s._mouse.on("mousemove",e=>{s._axesValues[t][i]=e.dy/10;});break;case "key":s._axes[t].push(()=>s._keyboard.isPressed(n)?a:0);break;case "padrx":s._axes[t].push(()=>s._gamepads.getAxis(e.pad,2));break;case "padry":s._axes[t].push(()=>s._gamepads.getAxis(e.pad,3));break;case "padlx":s._axes[t].push(()=>s._gamepads.getAxis(e.pad,0));break;case "padly":s._axes[t].push(()=>s._gamepads.getAxis(e.pad,1));break;default:throw Error("Unknown axis")}};s(this,e.positive,1,e.positiveKey),(e.negativeKey||e.negative!==e.positive)&&s(this,e.negative,-1,e.negativeKey);}isPressed(e){if(!this._actions[e])return  false;let t=this._actions[e].length;for(let i=0;i<t;++i){let t=this._actions[e][i];switch(t.type){case aS:if(this._keyboard){let e=t.keys.length;for(let i=0;i<e;i++)if(this._keyboard.isPressed(t.keys[i]))return  true}break;case av:if(this._mouse&&this._mouse.isPressed(t.button))return  true;break;case ay:if(this._gamepads&&this._gamepads.isPressed(t.pad,t.button))return  true}}return  false}wasPressed(e){if(!this._actions[e])return  false;let t=this._actions[e].length;for(let i=0;i<t;++i){let t=this._actions[e][i];switch(t.type){case aS:if(this._keyboard){let e=t.keys.length;for(let i=0;i<e;i++)if(this._keyboard.wasPressed(t.keys[i]))return  true}break;case av:if(this._mouse&&this._mouse.wasPressed(t.button))return  true;break;case ay:if(this._gamepads&&this._gamepads.wasPressed(t.pad,t.button))return  true}}return  false}getAxis(e){let t=0;if(this._axes[e]){let i=this._axes[e].length;for(let s=0;s<i;s++)if("function"==typeof this._axes[e][s]){let i=this._axes[e][s]();Math.abs(i)>Math.abs(t)&&(t=i);}else this._axesValues[e]&&Math.abs(this._axesValues[e][s])>Math.abs(t)&&(t=this._axesValues[e][s]);}return t}_enableMouse(){if(this._mouse=new aI,!this._element)throw Error("Controller must be attached to an Element");this._mouse.attach(this._element);}_enableKeyboard(){if(this._keyboard=new aA,!this._element)throw Error("Controller must be attached to an Element");this._keyboard.attach(this._element);}constructor(e,t={}){this._element=null,this._actions={},this._axes={},this._axesValues={},this._keyboard=t.keyboard||null,this._mouse=t.mouse||null,this._gamepads=t.gamepads||null,e&&this.attach(e);}},e.CssHandler=ye,e.CubemapHandler=yt,e.Curve=ea,e.CurveSet=en,e.CylinderGeometry=ui,e.DETAILMODE_ADD="add",e.DETAILMODE_MAX="max",e.DETAILMODE_MIN="min",e.DETAILMODE_MUL="mul",e.DETAILMODE_OVERLAY="overlay",e.DETAILMODE_SCREEN="screen",e.DEVICETYPE_NULL=t$,e.DEVICETYPE_WEBGL2=tY,e.DEVICETYPE_WEBGPU=tq,e.DISPLAYFORMAT_HDR="hdr",e.DISPLAYFORMAT_LDR="ldr",e.DISPLAYFORMAT_LDR_SRGB=tj,e.DISTANCE_EXPONENTIAL=aZ,e.DISTANCE_INVERSE=aK,e.DISTANCE_LINEAR=aj,e.DITHER_BAYER8=nT,e.DITHER_BLUENOISE=nE,e.DITHER_IGNNOISE=nw,e.DITHER_NONE=nx,e.DefaultAnimBinder=pI,e.DepthState=ix,e.DomeGeometry=cV,e.DrawCommands=r9,e.DualGestureSource=class extends wW{set layout(e){this._layout!==e&&(this._layout=e,this.read(),this._pointerData.clear());}get layout(){return this._layout}get leftJoystick(){return this._leftJoystick}get rightJoystick(){return this._rightJoystick}_onPointerDown(e){let{pointerType:t,pointerId:i,clientX:s,clientY:r}=e;if(this._movementState.down(e),"touch"!==t)return;this._element?.setPointerCapture(i);let a=s<.5*window.innerWidth;this._pointerData.set(i,{x:s,y:r,left:a});let n=Date.now();(this._lastPointer.x-s)**2+(this._lastPointer.y-r)**2<100&&n-this._lastPointer.time<250&&this.deltas.doubleTap.append([1]),this._lastPointer.x=s,this._lastPointer.y=r,this._lastPointer.time=n,a&&wK(this._layout,"joystick")&&this.fire("joystick:position:left",this._leftJoystick.down(s,r)),!a&&wZ(this._layout,"joystick")&&this.fire("joystick:position:right",this._rightJoystick.down(s,r));}_onPointerMove(e){let{pointerType:t,pointerId:i,target:s,clientX:r,clientY:a}=e,[n,o]=this._movementState.move(e);if("touch"!==t||s!==this._element)return;let l=this._pointerData.get(i);if(!l)return;let{left:h}=l;l.x=r,l.y=a,h?wK(this._layout,"joystick")?this.fire("joystick:position:left",this._leftJoystick.move(r,a)):this.deltas.leftInput.append([n,o]):wZ(this._layout,"joystick")?this.fire("joystick:position:right",this._rightJoystick.move(r,a)):this.deltas.rightInput.append([n,o]);}_onPointerUp(e){let{pointerType:t,pointerId:i}=e;if(this._movementState.up(e),"touch"!==t)return;this._element?.releasePointerCapture(i);let s=this._pointerData.get(i);if(!s)return;let{left:r}=s;this._pointerData.delete(i),r&&wK(this._layout,"joystick")&&this.fire("joystick:position:left",this._leftJoystick.up()),!r&&wZ(this._layout,"joystick")&&this.fire("joystick:position:right",this._rightJoystick.up());}attach(e){super.attach(e),this._element=e,this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("pointercancel",this._onPointerUp);}detach(){this._element&&(this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("pointercancel",this._onPointerUp),this._pointerData.clear(),super.detach());}read(){return this.deltas.leftInput.append([this._leftJoystick.value.x,this._leftJoystick.value.y]),this.deltas.rightInput.append([this._rightJoystick.value.x,this._rightJoystick.value.y]),super.read()}destroy(){this._leftJoystick.up(),this._rightJoystick.up(),super.destroy();}constructor(e){super({leftInput:[0,0],rightInput:[0,0],doubleTap:[0]}),this._movementState=wq(),this._layout="joystick-touch",this._pointerData=new Map,this._lastPointer={x:0,y:0,time:0},e&&(this.layout=e),this._leftJoystick=new wj,this._rightJoystick=new wj,this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this);}},e.ELEMENTTYPE_GROUP=p5,e.ELEMENTTYPE_IMAGE=p8,e.ELEMENTTYPE_TEXT=p6,e.EMITTERSHAPE_BOX=0,e.EMITTERSHAPE_SPHERE=1,e.EVENT_CULL_END=nL,e.EVENT_GAMEPADCONNECTED="gamepadconnected",e.EVENT_GAMEPADDISCONNECTED="gamepaddisconnected",e.EVENT_KEYDOWN="keydown",e.EVENT_KEYUP="keyup",e.EVENT_MOUSEDOWN="mousedown",e.EVENT_MOUSEMOVE="mousemove",e.EVENT_MOUSEUP="mouseup",e.EVENT_MOUSEWHEEL="mousewheel",e.EVENT_POSTCULL=nR,e.EVENT_POSTRENDER=nC,e.EVENT_POSTRENDER_LAYER=nI,e.EVENT_PRECULL=nD,e.EVENT_PRERENDER=nA,e.EVENT_PRERENDER_LAYER=nP,e.EVENT_SELECT="select",e.EVENT_SELECTEND="selectend",e.EVENT_SELECTSTART="selectstart",e.EVENT_TOUCHCANCEL="touchcancel",e.EVENT_TOUCHEND="touchend",e.EVENT_TOUCHMOVE="touchmove",e.EVENT_TOUCHSTART="touchstart",e.ElementComponent=_r,e.ElementComponentSystem=_o,e.ElementDragHelper=gb,e.ElementInput=TH,e.ElementInputEvent=TU,e.ElementMouseEvent=Tz,e.ElementSelectEvent=TG,e.ElementTouchEvent=TV,e.Entity=fB,e.EnvLighting=dt,e.EventHandle=W,e.EventHandler=X,e.FILLMODE_FILL_WINDOW=u9,e.FILLMODE_KEEP_ASPECT=u7,e.FILLMODE_NONE="NONE",e.FILTER_LINEAR=1,e.FILTER_LINEAR_MIPMAP_LINEAR=5,e.FILTER_LINEAR_MIPMAP_NEAREST=4,e.FILTER_NEAREST=0,e.FILTER_NEAREST_MIPMAP_LINEAR=3,e.FILTER_NEAREST_MIPMAP_NEAREST=2,e.FITMODE_CONTAIN=p7,e.FITMODE_COVER=me,e.FITMODE_STRETCH=p9,e.FITTING_BOTH=3,e.FITTING_NONE=0,e.FITTING_SHRINK=2,e.FITTING_STRETCH=1,e.FOG_EXP="exp",e.FOG_EXP2="exp2",e.FOG_LINEAR=a9,e.FOG_NONE=a6,e.FONT_BITMAP=mG,e.FONT_MSDF=mV,e.FRESNEL_NONE=0,e.FRESNEL_SCHLICK=2,e.FUNC_ALWAYS=7,e.FUNC_EQUAL=2,e.FUNC_GREATER=4,e.FUNC_GREATEREQUAL=6,e.FUNC_LESS=1,e.FUNC_LESSEQUAL=3,e.FUNC_NEVER=0,e.FUNC_NOTEQUAL=5,e.FloatPacking=eh,e.FlyController=class extends wY{set pitchRange(e){this._targetPose.pitchRange.copy(e),this._pose.copy(this._targetPose.rotate(ed.ZERO));}get pitchRange(){return this._targetPose.pitchRange}set yawRange(e){this._targetPose.yawRange.copy(e),this._pose.copy(this._targetPose.rotate(ed.ZERO));}get yawRange(){return this._targetPose.yawRange}attach(e,t=true){this._targetPose.copy(e),t||this._pose.copy(this._targetPose);}detach(){this._targetPose.copy(this._pose);}update(e,t){let{move:i,rotate:s}=e.read();return this._targetPose.rotate(w7.set(-s[1],-s[0],0)),bs.setFromEulerAngles(this._pose.angles),bs.transformVector(ed.FORWARD,be),bs.transformVector(ed.RIGHT,bt),bs.transformVector(ed.UP,bi),w9.set(0,0,0),w9.add(be.mulScalar(i[2])),w9.add(bt.mulScalar(i[0])),w9.add(bi.mulScalar(i[1])),this._targetPose.move(w9),this._pose.lerp(this._pose,this._targetPose,w6(this.moveDamping,t),w6(this.rotateDamping,t))}destroy(){this.detach();}constructor(...e){super(...e),this._targetPose=new wV,this.rotateDamping=.98,this.moveDamping=.98;}},e.FocusController=class extends wY{attach(e,t=true){this._targetRootPose.set(e.getFocus(bl),e.angles,0),this._targetChildPose.position.set(0,0,e.distance),t||(this._rootPose.copy(this._targetRootPose),this._childPose.copy(this._targetChildPose));}detach(){this._targetRootPose.copy(this._rootPose),this._targetChildPose.copy(this._childPose);}complete(){return this._targetRootPose.equalsApprox(this._rootPose,.001)&&this._targetChildPose.equalsApprox(this._childPose,.001)}update(e,t){return e.read(),this._rootPose.lerp(this._rootPose,this._targetRootPose,w6(this.focusDamping,t),w6(this.focusDamping,t),1),this._childPose.lerp(this._childPose,this._targetChildPose,w6(this.focusDamping,t),1,1),bc.setFromEulerAngles(this._rootPose.angles).transformVector(this._childPose.position,bh).add(this._rootPose.position),this._pose.set(bh,this._rootPose.angles,this._childPose.position.length())}destroy(){this.detach();}constructor(...e){super(...e),this._targetRootPose=new wV,this._rootPose=new wV,this._targetChildPose=new wV,this._childPose=new wV,this.focusDamping=.98;}},e.FogParams=di,e.FolderHandler=yi,e.Font=ys,e.FontHandler=ya,e.ForwardRenderer=ha,e.Frustum=eL,e.GAMMA_NONE=0,e.GAMMA_SRGB=1,e.GIZMOAXIS_FACE="face",e.GIZMOAXIS_X="x",e.GIZMOAXIS_XY="xy",e.GIZMOAXIS_XYZ="xyz",e.GIZMOAXIS_XZ="xz",e.GIZMOAXIS_Y="y",e.GIZMOAXIS_YZ="yz",e.GIZMOAXIS_Z="z",e.GIZMOSPACE_LOCAL="local",e.GIZMOSPACE_WORLD="world",e.GSPLAT_FORWARD=1,e.GSPLAT_SHADOW=2,e.GSPLAT_STREAM_INSTANCE=1,e.GSPLAT_STREAM_RESOURCE=0,e.GSplatComponent=Si,e.GSplatComponentSystem=Sl,e.GSplatContainer=class extends ux{get maxSplats(){return this._maxSplats}get numSplats(){return this._numSplats}update(e=this._numSplats,t=true){this._numSplats=ei.clamp(e,0,this._maxSplats),t&&this.centersVersion++;}configureMaterialDefines(e){e.set("SH_BANDS","0");}configureMaterial(e,t=null,i){super.configureMaterial(e,t,i);let s=this.device.isWebGPU?e.shaderChunks.wgsl:e.shaderChunks.glsl;s.set("gsplatContainerDeclarationsVS",this.format.getInputDeclarations()),s.set("gsplatDeclarationsVS",'#include "gsplatContainerDeclVS"'),s.set("gsplatReadVS",this.format.getReadCode());}constructor(e,t,i){let s=new Float32Array(3*t),r=new eC;super(e,{numSplats:t,getCenters:()=>s,calcAabb:e=>e.copy(r)}),this._maxSplats=0,this._numSplats=0,this._format=i,this._maxSplats=t,this._numSplats=t,this.streams.init(this._format,t);}},e.GSplatData=uI,e.GSplatFormat=cR,e.GSplatHandler=yA,e.GSplatInstance=u3,e.GSplatProcessor=class{destroy(){this._renderTarget?.destroy(),this._renderTarget=null,this._quadRender?.destroy(),this._quadRender=null,this._renderPass?.destroy(),this._renderPass=null,this._parameters.clear();}_resolveTexture(e,t,i){if(e.component){let s=i.format.getStream(t);if(s?.storage===1){let i=e.component.getInstanceTexture(t);if(i)return i}}return i.getTexture(t)}_createRenderTarget(){let e=[];for(let t of this._dstStreamDescriptors){let i=this._resolveTexture(this._destination,t.name,this._dstResource);i&&e.push(i);}e.length>0&&(this._renderTarget=new iU({name:"GSplatProcessor-MRT",colorBuffers:e,depth:false,flipY:true}));}_createShader(e){let{processGLSL:t="",processWGSL:i=""}=e,s=this._device,r=this._srcResource.format,a=this._dstResource.format,n="",o="";if(this._useAllInputStreams){let e=[...r.streams,...r.extraStreams],t=this._srcResource===this._dstResource,i=e.filter(e=>!t||!this._dstStreamNames.has(e.name)).map(e=>e.name);n=r.getInputDeclarations(i),o=r.getReadCode();}else n=r.getInputDeclarations(this._source.streams);let l=a.getOutputDeclarations(this._dstStreamDescriptors),h=this._dstStreamDescriptors.map(e=>e1(e.format).returnType),c=new Map;c.set("SH_BANDS","0");let d=s.isWebGPU,u=new Map;u.set("gsplatProcessInputVS",n),u.set("gsplatProcessOutputVS",l),u.set("gsplatProcessReadVS",o),u.set("gsplatProcessChunk",d?i:t);let f=iI([d?i:t,this._useAllInputStreams?"1":"0"].join("|")),p=this._dstStreamDescriptors.map(e=>e.name).join(","),m=nY.createShader(s,{uniqueName:`GSplatProcessor:${r.hash};${f};out=${p}`,attributes:{vertex_position:e6},vertexDefines:c,fragmentDefines:c,vertexChunk:"fullscreenQuadVS",fragmentGLSL:u4,fragmentWGSL:u5,fragmentIncludes:u,fragmentOutputTypes:h});this._quadRender=new nZ(m);}setParameter(e,t){let i=this._device.scope.resolve(e);this._parameters.set(e,{scopeId:i,data:t});}getParameter(e){return this._parameters.get(e)?.data}deleteParameter(e){this._parameters.delete(e);}process(){if(!this._renderPass)return;let e=this._device;for(let{name:t,texture:i}of this._srcTextures)e.scope.resolve(t).setValue(i);for(let[t,i]of(e.scope.resolve("splatTextureSize").setValue(this._srcResource.textureDimensions.x),e.scope.resolve("dstTextureSize").setValue(this._dstResource.textureDimensions.x),e.scope.resolve("srcNumSplats").setValue(this._srcResource.numSplats),e.scope.resolve("dstNumSplats").setValue(this._dstResource.numSplats),this._srcResource.parameters))e.scope.resolve(t).setValue(i);for(let[,e]of this._parameters)e.scopeId.setValue(e.data);this._renderPass.blendState=this.blendState,this._renderPass.render();}constructor(e,t,i,s){for(let s of(this._srcTextures=[],this._renderTarget=null,this._quadRender=null,this._renderPass=null,this._parameters=new Map,this.blendState=iS.NOBLEND,this._device=e,this._source=t,this._destination=i,this._srcResource=t.resource??t.component?.resource,this._dstResource=i.resource??i.component?.resource,this._dstStreamDescriptors=[],this._dstStreamNames=new Set,i.streams)){let e=this._dstResource.format.getStream(s);e&&(this._dstStreamDescriptors.push(e),this._dstStreamNames.add(e.name));}this._useAllInputStreams=!t.streams?.length;let r=this._srcResource.format;for(let e of this._useAllInputStreams?[...r.streams,...r.extraStreams]:t.streams.map(e=>({name:e}))){let i=this._resolveTexture(t,e.name,this._srcResource);this._srcTextures.push({name:e.name,texture:i});}this._createRenderTarget(),this._createShader(s),this._renderPass=new dT(e),this._renderPass.quadRender=this._quadRender,this._renderPass.init(this._renderTarget),this._renderPass.colorOps.clear=false,this._renderPass.depthStencilOps.clearDepth=false;}},e.GSplatResource=u8,e.GSplatResourceBase=ux,e.GSplatSogData=uJ,e.GSplatSogResource=u6,e.GamePads=aG,e.GamepadSource=w8,e.Geometry=ck,e.Gizmo=bv,e.GltfExporter=wi,e.GraphNode=oX,e.GraphicsDevice=iB,e.HierarchyHandler=yR,e.HtmlHandler=yL,e.Http=aq,e.I18n=fR,e.INDEXFORMAT_UINT16=1,e.INDEXFORMAT_UINT32=2,e.INDEXFORMAT_UINT8=0,e.INTERPOLATION_CUBIC=2,e.INTERPOLATION_LINEAR=1,e.INTERPOLATION_STEP=0,e.ImageElement=mU,e.IndexBuffer=ae,e.IndexedList=Y,e.InputConsumer=wX,e.InputController=wY,e.InputDelta=wG,e.InputFrame=wH,e.InputSource=wW,e.JointComponent=_u,e.JointComponentSystem=__,e.JsonHandler=yM,e.JsonStandardMaterialParser=yF,e.KEY_0=48,e.KEY_1=49,e.KEY_2=50,e.KEY_3=51,e.KEY_4=52,e.KEY_5=53,e.KEY_6=54,e.KEY_7=55,e.KEY_8=56,e.KEY_9=57,e.KEY_A=65,e.KEY_ADD=107,e.KEY_ALT=18,e.KEY_B=66,e.KEY_BACKSPACE=8,e.KEY_BACK_SLASH=220,e.KEY_C=67,e.KEY_CAPS_LOCK=20,e.KEY_CLOSE_BRACKET=221,e.KEY_COMMA=188,e.KEY_CONTEXT_MENU=93,e.KEY_CONTROL=17,e.KEY_D=68,e.KEY_DECIMAL=110,e.KEY_DELETE=46,e.KEY_DIVIDE=111,e.KEY_DOWN=40,e.KEY_E=69,e.KEY_END=35,e.KEY_ENTER=13,e.KEY_EQUAL=61,e.KEY_ESCAPE=27,e.KEY_F=70,e.KEY_F1=112,e.KEY_F10=121,e.KEY_F11=122,e.KEY_F12=123,e.KEY_F2=113,e.KEY_F3=114,e.KEY_F4=115,e.KEY_F5=116,e.KEY_F6=117,e.KEY_F7=118,e.KEY_F8=119,e.KEY_F9=120,e.KEY_G=71,e.KEY_H=72,e.KEY_HOME=36,e.KEY_I=73,e.KEY_INSERT=45,e.KEY_J=74,e.KEY_K=75,e.KEY_L=76,e.KEY_LEFT=37,e.KEY_M=77,e.KEY_META=224,e.KEY_MULTIPLY=106,e.KEY_N=78,e.KEY_NUMPAD_0=96,e.KEY_NUMPAD_1=97,e.KEY_NUMPAD_2=98,e.KEY_NUMPAD_3=99,e.KEY_NUMPAD_4=100,e.KEY_NUMPAD_5=101,e.KEY_NUMPAD_6=102,e.KEY_NUMPAD_7=103,e.KEY_NUMPAD_8=104,e.KEY_NUMPAD_9=105,e.KEY_O=79,e.KEY_OPEN_BRACKET=219,e.KEY_P=80,e.KEY_PAGE_DOWN=34,e.KEY_PAGE_UP=33,e.KEY_PAUSE=19,e.KEY_PERIOD=190,e.KEY_PRINT_SCREEN=44,e.KEY_Q=81,e.KEY_R=82,e.KEY_RETURN=13,e.KEY_RIGHT=39,e.KEY_S=83,e.KEY_SEMICOLON=59,e.KEY_SEPARATOR=108,e.KEY_SHIFT=16,e.KEY_SLASH=191,e.KEY_SPACE=32,e.KEY_SUBTRACT=109,e.KEY_T=84,e.KEY_TAB=9,e.KEY_U=85,e.KEY_UP=38,e.KEY_V=86,e.KEY_W=87,e.KEY_WINDOWS=91,e.KEY_X=88,e.KEY_Y=89,e.KEY_Z=90,e.Kernel=ec,e.Key=dc,e.Keyboard=aA,e.KeyboardEvent=ax,e.KeyboardMouseSource=w3,e.LAYERID_DEPTH=1,e.LAYERID_IMMEDIATE=3,e.LAYERID_SKYBOX=2,e.LAYERID_UI=4,e.LAYERID_WORLD=0,e.LAYER_GIZMO=1,e.LAYER_HUD=0,e.LAYER_WORLD=15,e.LIGHTFALLOFF_INVERSESQUARED=1,e.LIGHTFALLOFF_LINEAR=0,e.LIGHTSHAPE_DISK=2,e.LIGHTSHAPE_PUNCTUAL=0,e.LIGHTSHAPE_RECT=1,e.LIGHTSHAPE_SPHERE=3,e.LIGHTTYPE_COUNT=3,e.LIGHTTYPE_DIRECTIONAL=0,e.LIGHTTYPE_OMNI=1,e.LIGHTTYPE_POINT=1,e.LIGHTTYPE_SPOT=2,e.LIGHT_COLOR_DIVIDER=100,e.Layer=hd,e.LayerComposition=hf,e.LayoutCalculator=_D,e.LayoutChildComponent=_g,e.LayoutChildComponentSystem=_y,e.LayoutGroupComponent=_M,e.LayoutGroupComponentSystem=_N,e.Light=hE,e.LightComponent=ve,e.LightComponentSystem=vt,e.LightingParams=hw,e.Lightmapper=f4,e.LitMaterial=class extends lm{getShaderVariant(e){dk.usedUvs=this.usedUvs.slice(),dk.shaderChunkGLSL=this.shaderChunkGLSL,dk.shaderChunkWGSL=this.shaderChunkWGSL,dk.defines=nY.getCoreDefines(this,e),dL.update(dk.litOptions,this,e.scene,e.cameraShaderParams,e.objDefs,e.pass,e.sortedLights);let t=new nO(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),i=nN(e.device);return i.register("lit",dB),i.getProgram("lit",dk,t,this.userId)}constructor(...e){super(...e),this.usedUvs=[true],this.shaderChunkGLSL=null,this.shaderChunkWGSL=null,this.useLighting=true,this.useFog=true,this.useTonemap=true,this.useSkybox=true,this.ambientSH=null,this.pixelSnap=false,this.nineSlicedMode=null,this.twoSidedLighting=false,this.occludeDirect=false,this.occludeSpecular=1,this.occludeSpecularIntensity=1,this.opacityFadesSpecular=true,this.opacityDither=nx,this.opacityShadowDither=nx,this.shadowCatcher=false,this.ggxSpecular=false,this.fresnelModel=2,this.dynamicRefraction=false,this.hasAo=false,this.hasSpecular=false,this.hasSpecularityFactor=false,this.hasLighting=false,this.hasHeights=false,this.hasNormals=false,this.hasSheen=false,this.hasRefraction=false,this.hasIrridescence=false,this.hasMetalness=false,this.hasClearCoat=false,this.hasClearCoatNormals=false;}},e.LitOptions=dR,e.LitShaderOptions=dR,e.LocalizedAsset=mz,e.MASK_AFFECT_DYNAMIC=1,e.MASK_AFFECT_LIGHTMAPPED=2,e.MASK_BAKE=4,e.MOTION_FREE=_l,e.MOTION_LIMITED=_h,e.MOTION_LOCKED=_c,e.MOUSEBUTTON_LEFT=0,e.MOUSEBUTTON_MIDDLE=1,e.MOUSEBUTTON_NONE=-1,e.MOUSEBUTTON_RIGHT=2,e.Mat3=eu,e.Mat4=ey,e.Material=lm,e.MaterialHandler=yB,e.Mesh=n7,e.MeshInstance=od,e.MiniStats=Eo,e.Model=hA,e.ModelComponent=_z,e.ModelComponentSystem=_H,e.ModelHandler=yG,e.Morph=hC,e.MorphInstance=hb,e.MorphTarget=hP,e.Mouse=aI,e.MouseEvent=aP,e.MultiTouchSource=class extends wW{_onPointerDown(e){let{pointerId:t,pointerType:i}=e;this._movementState.down(e),"touch"===i&&(this._element?.setPointerCapture(t),this._pointerEvents.set(t,e),this.deltas.count.append([1]),this._pointerEvents.size>1&&(this._getMidPoint(this._pointerPos),this._pinchDist=this._getPinchDist()));}_onPointerMove(e){let{pointerType:t,target:i,pointerId:s}=e,[r,a]=this._movementState.move(e);if("touch"===t&&i===this._element&&0!==this._pointerEvents.size)if(this._pointerEvents.set(s,e),this._pointerEvents.size>1){let e=this._getMidPoint(wQ);this.deltas.touch.append([e.x-this._pointerPos.x,e.y-this._pointerPos.y]),this._pointerPos.copy(e);let t=this._getPinchDist();this._pinchDist>0&&this.deltas.pinch.append([this._pinchDist-t]),this._pinchDist=t;}else this.deltas.touch.append([r,a]);}_onPointerUp(e){let{pointerType:t,pointerId:i}=e;this._movementState.up(e),"touch"===t&&(this._element?.releasePointerCapture(i),this._pointerEvents.delete(i),this.deltas.count.append([-1]),this._pointerEvents.size<2&&(this._pinchDist=-1),this._pointerPos.set(0,0));}_onContextMenu(e){e.preventDefault();}_getMidPoint(e){if(this._pointerEvents.size<2)return e.set(0,0);let[t,i]=this._pointerEvents.values(),s=t.clientX-i.clientX,r=t.clientY-i.clientY;return e.set(i.clientX+.5*s,i.clientY+.5*r)}_getPinchDist(){if(this._pointerEvents.size<2)return 0;let[e,t]=this._pointerEvents.values(),i=e.clientX-t.clientX,s=e.clientY-t.clientY;return Math.sqrt(i*i+s*s)}attach(e){super.attach(e),this._element=e,this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("pointercancel",this._onPointerUp),this._element.addEventListener("contextmenu",this._onContextMenu);}detach(){this._element&&(this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("pointercancel",this._onPointerUp),this._element.removeEventListener("contextmenu",this._onContextMenu),this._pointerEvents.clear(),super.detach());}constructor(){super({touch:[0,0],count:[0],pinch:[0]}),this._movementState=wq(),this._pointerEvents=new Map,this._pointerPos=new ef,this._pinchDist=-1,this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this),this._onContextMenu=this._onContextMenu.bind(this);}},e.Node=dd,e.NullGraphicsDevice=r5,e.ORIENTATION_HORIZONTAL=0,e.ORIENTATION_VERTICAL=1,e.OrbitController=class extends wY{set pitchRange(e){this._targetRootPose.pitchRange.copy(e),this._rootPose.copy(this._targetRootPose.rotate(ed.ZERO));}get pitchRange(){return this._targetRootPose.pitchRange}set yawRange(e){this._targetRootPose.yawRange.copy(e),this._rootPose.copy(this._targetRootPose.rotate(ed.ZERO));}get yawRange(){return this._targetRootPose.yawRange}set zoomRange(e){this._targetChildPose.zRange.copy(e),this._childPose.copy(this._targetChildPose.move(ed.ZERO));}get zoomRange(){return this._targetRootPose.zRange}attach(e,t=true){this._targetRootPose.set(e.getFocus(br),e.angles,0),this._targetChildPose.position.set(0,0,e.distance),t||(this._rootPose.copy(this._targetRootPose),this._childPose.copy(this._targetChildPose));}detach(){this._targetRootPose.copy(this._rootPose),this._targetChildPose.copy(this._childPose);}update(e,t){let{move:i,rotate:s}=e.read();ba.set(i[0],i[1],0),bo.setFromEulerAngles(this._rootPose.angles).transformVector(ba,ba),this._targetRootPose.move(ba);let{z:r}=this._targetChildPose.position;return this._targetChildPose.move(ba.set(0,0,r*(1+i[2])-r)),this._targetRootPose.rotate(bn.set(-s[1],-s[0],0)),this._rootPose.lerp(this._rootPose,this._targetRootPose,w6(this.moveDamping,t),w6(this.rotateDamping,t),1),this._childPose.lerp(this._childPose,this._targetChildPose,w6(this.zoomDamping,t),1,1),bo.setFromEulerAngles(this._rootPose.angles).transformVector(this._childPose.position,ba).add(this._rootPose.position),this._pose.set(ba,this._rootPose.angles,this._childPose.position.z)}destroy(){this.detach();}constructor(...e){super(...e),this._targetRootPose=new wV,this._rootPose=new wV,this._targetChildPose=new wV,this._childPose=new wV,this.rotateDamping=.98,this.moveDamping=.98,this.zoomDamping=.98;}},e.OrientedBox=class{set worldTransform(e){this._worldTransform.copy(e),this._modelTransform.copy(e).invert();}get worldTransform(){return this._worldTransform}intersectsRay(e,t){if(this._modelTransform.transformPoint(e.origin,eO.origin),this._modelTransform.transformVector(e.direction,eO.direction),t){let e=this._aabb._intersectsRay(eO,t);return eB.copy(this._modelTransform).invert().transformPoint(t,t),e}return this._aabb._fastIntersectsRay(eO)}containsPoint(e){return this._modelTransform.transformPoint(e,eF),this._aabb.containsPoint(eF)}intersectsBoundingSphere(e){return this._modelTransform.transformPoint(e.center,eN.center),eN.radius=e.radius,!!this._aabb.intersectsBoundingSphere(eN)}constructor(e=new ey,t){this.halfExtents=new ed(.5,.5,.5),t&&this.halfExtents.copy(t),this._modelTransform=e.clone().invert(),this._worldTransform=e.clone(),this._aabb=new eC(new ed,this.halfExtents);}},e.OutlineRenderer=class{destroy(){this.whiteTex.destroy(),this.whiteTex=null,this.outlineCameraEntity.destroy(),this.outlineCameraEntity=null,this.rt.destroyTextureBuffers(),this.rt.destroy(),this.rt=null,this.tempRt.destroyTextureBuffers(),this.tempRt.destroy(),this.tempRt=null,this.app.scene.off("postrender",this.postRender),this.quadRenderer?.destroy(),this.quadRenderer=null;}getMeshInstances(e,t){let i=[];return e&&((t?e.findComponents("render"):e.render?[e.render]:[]).forEach(e=>{e.meshInstances&&i.push(...e.meshInstances);}),(t?e.findComponents("model"):e.model?[e.model]:[]).forEach(e=>{e.meshInstances&&i.push(...e.meshInstances);})),i}addEntity(e,t,i=true){let s=this.getMeshInstances(e,i);s.forEach(e=>{if(e.material instanceof d0){let i=this.outlineShaderPass;e.material.onUpdateShader=e=>{if(e.pass===i){let t=new dU;return t.defines=e.defines,t.opacityMap=e.opacityMap,t.opacityMapUv=e.opacityMapUv,t.opacityMapChannel=e.opacityMapChannel,t.opacityMapTransform=e.opacityMapTransform,t.opacityVertexColor=e.opacityVertexColor,t.opacityVertexColorChannel=e.opacityVertexColorChannel,t.litOptions.vertexColors=e.litOptions.vertexColors,t.litOptions.alphaTest=e.litOptions.alphaTest,t.litOptions.skin=e.litOptions.skin,t.litOptions.batch=e.litOptions.batch,t.litOptions.useInstancing=e.litOptions.useInstancing,t.litOptions.useMorphPosition=e.litOptions.useMorphPosition,t.litOptions.useMorphNormal=e.litOptions.useMorphNormal,t.litOptions.useMorphTextureBasedInt=e.litOptions.useMorphTextureBasedInt,t.litOptions.opacityFadesSpecular=e.litOptions.opacityFadesSpecular,t}return e},Ed.linear(t);let s=new Float32Array([Ed.r,Ed.g,Ed.b]);e.setParameter("material_emissive",s,1<<this.outlineShaderPass),e.setParameter("texture_emissiveMap",this.whiteTex,1<<this.outlineShaderPass);}}),this.renderingLayer.addMeshInstances(s,true);}removeEntity(e,t=true){let i=this.getMeshInstances(e,t);this.renderingLayer.removeMeshInstances(i),i.forEach(e=>{e.material instanceof d0&&(e.material.onUpdateShader=null,e.deleteParameter("material_emissive"));});}removeAllEntities(){this.renderingLayer.clearMeshInstances();}blendOutlines(){let e=this.app.graphicsDevice;e.scope.resolve("source").setValue(this.rt.colorBuffer),e.setDepthState(ix.NODEPTH),e.setCullMode(0),e.setBlendState(this.blendState),this.quadRenderer.render();}onPostRender(){let e=this.app.graphicsDevice,t=e.scope.resolve("uOffset"),i=e.scope.resolve("source"),s=e.scope.resolve("uSrcMultiplier"),{rt:r,tempRt:a,shaderExtend:n}=this,{width:o,height:l}=r;Ec[0]=1/o/2,Ec[1]=0,t.setValue(Ec),i.setValue(r.colorBuffer),s.setValue(0),n0(e,a,n),Ec[0]=0,Ec[1]=1/l/2,t.setValue(Ec),i.setValue(a.colorBuffer),s.setValue(1),n0(e,r,n);}createRenderTarget(e,t,i,s){return new iU({colorBuffer:new ih(this.app.graphicsDevice,{name:e,width:t,height:i,format:20,mipmaps:false,addressU:1,addressV:1,minFilter:5,magFilter:1}),depth:s,flipY:this.app.graphicsDevice.isWebGPU})}updateRenderTarget(e){let t=e.renderTarget?.width??this.app.graphicsDevice.width,i=e.renderTarget?.height??this.app.graphicsDevice.height,s=this.outlineCameraEntity.camera;s.renderTarget&&s.renderTarget.width===t&&s.renderTarget.height===i||(this.rt.resize(t,i),this.tempRt.resize(t,i));}frameUpdate(e,t,i){let s=e.camera;this.updateRenderTarget(s);let r=this.app.scene.on("prerender:layer",(e,a,n)=>{s===e&&n===i&&a===t&&(this.blendOutlines(),r.off());});this.outlineCameraEntity.setLocalPosition(e.getPosition()),this.outlineCameraEntity.setLocalRotation(e.getRotation());let a=this.outlineCameraEntity.camera;a.projection=s.projection,a.horizontalFov=s.horizontalFov,a.fov=s.fov,a.orthoHeight=s.orthoHeight,a.nearClip=s.nearClip,a.farClip=s.farClip;}constructor(e,t,i=-1){this.app=e,this.renderingLayer=t??e.scene.layers.getLayerByName("Immediate"),this.rt=this.createRenderTarget("OutlineTexture",1,1,true),this.outlineCameraEntity=new fB("OutlineCamera"),this.outlineCameraEntity.addComponent("camera",{layers:[this.renderingLayer.id],priority:i,clearColor:new es(0,0,0,0),renderTarget:this.rt}),this.outlineShaderPass=this.outlineCameraEntity.camera.setShaderPass("OutlineShaderPass"),this.postRender=e=>{this.outlineCameraEntity.camera===e&&this.onPostRender();},e.scene.on("postrender",this.postRender),this.app.root.addChild(this.outlineCameraEntity),this.tempRt=this.createRenderTarget("OutlineTempTexture",1,1,false),this.blendState=new iS(true,0,6,8);let s=this.app.graphicsDevice;this.shaderExtend=nY.createShader(s,{uniqueName:"OutlineExtendShader",attributes:{vertex_position:e6},vertexChunk:"fullscreenQuadVS",fragmentGLSL:El,fragmentWGSL:Eh}),this.shaderBlend=nY.createShader(s,{uniqueName:"OutlineBlendShader",attributes:{vertex_position:e6},vertexChunk:"fullscreenQuadVS",fragmentChunk:"outputTex2DPS"}),this.quadRenderer=new nZ(this.shaderBlend),this.whiteTex=new ih(s,{name:"OutlineWhiteTexture",width:1,height:1,format:20,mipmaps:false}),this.whiteTex.lock().set(new Uint8Array([255,255,255,255])),this.whiteTex.unlock();}},e.PAD_1=0,e.PAD_2=1,e.PAD_3=2,e.PAD_4=3,e.PAD_DOWN=13,e.PAD_FACE_1=0,e.PAD_FACE_2=1,e.PAD_FACE_3=2,e.PAD_FACE_4=3,e.PAD_LEFT=14,e.PAD_L_SHOULDER_1=4,e.PAD_L_SHOULDER_2=6,e.PAD_L_STICK_BUTTON=10,e.PAD_L_STICK_X=0,e.PAD_L_STICK_Y=1,e.PAD_RIGHT=15,e.PAD_R_SHOULDER_1=5,e.PAD_R_SHOULDER_2=7,e.PAD_R_STICK_BUTTON=11,e.PAD_R_STICK_X=2,e.PAD_R_STICK_Y=3,e.PAD_SELECT=8,e.PAD_START=9,e.PAD_UP=12,e.PAD_VENDOR=16,e.PARTICLEMODE_CPU=1,e.PARTICLEMODE_GPU=0,e.PARTICLEORIENTATION_EMITTER=2,e.PARTICLEORIENTATION_SCREEN=0,e.PARTICLEORIENTATION_WORLD=1,e.PARTICLESORT_DISTANCE=1,e.PARTICLESORT_NEWER_FIRST=2,e.PARTICLESORT_NONE=0,e.PARTICLESORT_OLDER_FIRST=3,e.PIXELFORMAT_111110F=18,e.PIXELFORMAT_A8=0,e.PIXELFORMAT_ASTC_4x4=28,e.PIXELFORMAT_ASTC_4x4_SRGB=63,e.PIXELFORMAT_ATC_RGB=29,e.PIXELFORMAT_ATC_RGBA=30,e.PIXELFORMAT_BC6F=65,e.PIXELFORMAT_BC6UF=66,e.PIXELFORMAT_BC7=67,e.PIXELFORMAT_BC7_SRGBA=68,e.PIXELFORMAT_BGRA8=31,e.PIXELFORMAT_DEPTH=16,e.PIXELFORMAT_DEPTH16=69,e.PIXELFORMAT_DEPTHSTENCIL=17,e.PIXELFORMAT_DXT1=8,e.PIXELFORMAT_DXT1_SRGB=54,e.PIXELFORMAT_DXT3=9,e.PIXELFORMAT_DXT3_SRGBA=55,e.PIXELFORMAT_DXT5=10,e.PIXELFORMAT_DXT5_SRGBA=56,e.PIXELFORMAT_ETC1=21,e.PIXELFORMAT_ETC2_RGB=22,e.PIXELFORMAT_ETC2_RGBA=23,e.PIXELFORMAT_ETC2_SRGB=61,e.PIXELFORMAT_ETC2_SRGBA=62,e.PIXELFORMAT_L8=1,e.PIXELFORMAT_L8_A8=2,e.PIXELFORMAT_LA8=2,e.PIXELFORMAT_PVRTC_2BPP_RGBA_1=25,e.PIXELFORMAT_PVRTC_2BPP_RGB_1=24,e.PIXELFORMAT_PVRTC_4BPP_RGBA_1=27,e.PIXELFORMAT_PVRTC_4BPP_RGB_1=26,e.PIXELFORMAT_R16F=50,e.PIXELFORMAT_R16I=34,e.PIXELFORMAT_R16U=35,e.PIXELFORMAT_R32F=15,e.PIXELFORMAT_R32I=36,e.PIXELFORMAT_R32U=37,e.PIXELFORMAT_R4_G4_B4_A4=5,e.PIXELFORMAT_R5_G5_B5_A1=4,e.PIXELFORMAT_R5_G6_B5=3,e.PIXELFORMAT_R8=52,e.PIXELFORMAT_R8I=32,e.PIXELFORMAT_R8U=33,e.PIXELFORMAT_R8_G8_B8=6,e.PIXELFORMAT_R8_G8_B8_A8=7,e.PIXELFORMAT_RG16F=51,e.PIXELFORMAT_RG16I=40,e.PIXELFORMAT_RG16U=41,e.PIXELFORMAT_RG32F=70,e.PIXELFORMAT_RG32I=42,e.PIXELFORMAT_RG32U=43,e.PIXELFORMAT_RG8=53,e.PIXELFORMAT_RG8I=38,e.PIXELFORMAT_RG8S=72,e.PIXELFORMAT_RG8U=39,e.PIXELFORMAT_RGB10A2=74,e.PIXELFORMAT_RGB10A2U=75,e.PIXELFORMAT_RGB16F=11,e.PIXELFORMAT_RGB32F=13,e.PIXELFORMAT_RGB565=3,e.PIXELFORMAT_RGB8=6,e.PIXELFORMAT_RGB9E5=71,e.PIXELFORMAT_RGBA16F=12,e.PIXELFORMAT_RGBA16I=46,e.PIXELFORMAT_RGBA16U=47,e.PIXELFORMAT_RGBA32F=14,e.PIXELFORMAT_RGBA32I=48,e.PIXELFORMAT_RGBA32U=49,e.PIXELFORMAT_RGBA4=5,e.PIXELFORMAT_RGBA5551=4,e.PIXELFORMAT_RGBA8=7,e.PIXELFORMAT_RGBA8I=44,e.PIXELFORMAT_RGBA8S=73,e.PIXELFORMAT_RGBA8U=45,e.PIXELFORMAT_SBGRA8=64,e.PIXELFORMAT_SRGB=19,e.PIXELFORMAT_SRGB8=19,e.PIXELFORMAT_SRGBA=20,e.PIXELFORMAT_SRGBA8=20,e.PRIMITIVE_LINELOOP=2,e.PRIMITIVE_LINES=1,e.PRIMITIVE_LINESTRIP=3,e.PRIMITIVE_POINTS=0,e.PRIMITIVE_TRIANGLES=4,e.PRIMITIVE_TRIFAN=6,e.PRIMITIVE_TRISTRIP=5,e.PROJECTION_ORTHOGRAPHIC=1,e.PROJECTION_PERSPECTIVE=0,e.ParticleEmitter=cd,e.ParticleSystemComponent=_$,e.ParticleSystemComponentSystem=_J,e.Picker=class{destroy(){this.releaseRenderTarget(),this.renderPass?.destroy();}getSelection(e,t,i=1,s=1){let r=this.device;if(r.isWebGPU)return [];t=this.renderTarget.height-(t+s);let a=this.sanitizeRect(e,t,i,s);r.setRenderTarget(this.renderTarget),r.updateBegin();let n=new Uint8Array(4*a.z*a.w);return r.readPixels(a.x,a.y,a.z,a.w,n),r.updateEnd(),this.decodePixels(n,this.mapping)}getSelectionAsync(e,t,i=1,s=1){return this.renderTarget&&this.renderTarget.colorBuffer?this._readTexture(this.renderTarget.colorBuffer,e,t,i,s,this.renderTarget).then(e=>this.decodePixels(e,this.mapping)):Promise.resolve([])}_readTexture(e,t,i,s,r,a){this.device?.isWebGL2&&(i=a.height-(i+r));let n=this.sanitizeRect(t,i,s,r);return e.read(n.x,n.y,n.z,n.w,{immediate:true,renderTarget:a})}async getWorldPointAsync(e,t){let i=this.renderPass.camera;if(!i)return null;let s=new ey().mul2(i.camera.projectionMatrix,i.camera.viewMatrix).invert(),r=await this.getPointDepthAsync(e,t);if(null===r)return null;let a=new ep(e/this.width*2-1,(1-t/this.height)*2-1,2*r-1,1);return s.transformVec4(a,a),a.mulScalar(1/a.w),new ed(a.x,a.y,a.z)}async getPointDepthAsync(e,t){if(!this.depthBuffer)return null;let i=await this._readTexture(this.depthBuffer,e,t,1,1,this.renderTargetDepth),s=i[0]<<24|i[1]<<16|i[2]<<8|i[3];return 0xffffffff===s?null:(Td[0]=s,Tc[0])}sanitizeRect(e,t,i,s){let r=this.renderTarget.width,a=this.renderTarget.height;return e=ei.clamp(Math.floor(e),0,r-1),t=ei.clamp(Math.floor(t),0,a-1),i=Math.min(i=Math.floor(Math.max(i,1)),r-e),s=Math.min(s=Math.floor(Math.max(s,1)),a-t),Th.set(e,t,i,s)}decodePixels(e,t){let i=[];if(this.deviceValid){let s=e.length;for(let i=0;i<s;i+=4){let s=e[i+0],r=e[i+1],a=e[i+2],n=(e[i+3]<<24|s<<16|r<<8|a)>>>0;0xffffffff!==n&&Tl.add(t.get(n));}Tl.forEach(e=>{e&&i.push(e);}),Tl.clear();}return i}createTexture(e){return new ih(this.device,{format:7,width:this.width,height:this.height,mipmaps:false,minFilter:0,magFilter:0,addressU:1,addressV:1,name:e})}allocateRenderTarget(){this.colorBuffer=this.createTexture("pick");let e=[this.colorBuffer];this.depth&&(this.depthBuffer=this.createTexture("pick-depth"),e.push(this.depthBuffer),this.renderTargetDepth=new iU({colorBuffer:this.depthBuffer,depth:false})),this.renderTarget=new iU({colorBuffers:e,depth:true});}releaseRenderTarget(){this.renderTarget?.destroyTextureBuffers(),this.renderTarget?.destroy(),this.renderTarget=null,this.renderTargetDepth?.destroy(),this.renderTargetDepth=null,this.colorBuffer=null,this.depthBuffer=null;}prepare(e,t,i){i instanceof hd&&(i=[i]),this.renderTarget?.resize(this.width,this.height),this.renderTargetDepth?.resize(this.width,this.height),this.mapping.clear();let s=this.renderPass;s.init(this.renderTarget),s.setClearColor(es.WHITE),s.depthStencilOps.clearDepth=true,s.update(e,t,i,this.mapping,this.depth),s.render();}resize(e,t){this.width=Math.floor(e),this.height=Math.floor(t);}constructor(e,t,i,s=false){this.renderTarget=null,this.colorBuffer=null,this.depthBuffer=null,this.renderTargetDepth=null,this.mapping=new Map,this.deviceValid=true,this.device=e.graphicsDevice,this.renderPass=new To(this.device,e.renderer),this.depth=s,this.width=0,this.height=0,this.resize(t,i),this.allocateRenderTarget(),this.device.on("destroy",()=>{this.deviceValid=false;});}},e.Plane=eR,e.PlaneGeometry=us,e.Pose=wV,e.PostEffect=dx,e.PostEffectQueue=g3,e.ProgramLibrary=ua,e.QuadRender=nZ,e.Quat=ex,e.REFLECTIONSRC_CUBEMAP=nd,e.REFLECTIONSRC_ENVATLAS=nh,e.REFLECTIONSRC_ENVATLASHQ=nc,e.REFLECTIONSRC_NONE=nl,e.REFLECTIONSRC_SPHEREMAP=nu,e.RENDERSTYLE_POINTS=2,e.RENDERSTYLE_SOLID=0,e.RENDERSTYLE_WIREFRAME=1,e.RESOLUTION_AUTO=fe,e.RESOLUTION_FIXED=ft,e.RIGIDBODY_ACTIVE_TAG=1,e.RIGIDBODY_CF_KINEMATIC_OBJECT=2,e.RIGIDBODY_CF_NORESPONSE_OBJECT=4,e.RIGIDBODY_CF_STATIC_OBJECT=1,e.RIGIDBODY_DISABLE_DEACTIVATION=4,e.RIGIDBODY_DISABLE_SIMULATION=5,e.RIGIDBODY_ISLAND_SLEEPING=2,e.RIGIDBODY_TYPE_DYNAMIC=mv,e.RIGIDBODY_TYPE_KINEMATIC=mS,e.RIGIDBODY_TYPE_STATIC=mg,e.RIGIDBODY_WANTS_DEACTIVATION=3,e.Ray=eM,e.RaycastResult=gr,e.ReadStream=j,e.RenderComponent=_3,e.RenderComponentSystem=_6,e.RenderHandler=Sf,e.RenderPass=as,e.RenderPassBloom=wu,e.RenderPassCameraFrame=wk,e.RenderPassColorGrab=oS,e.RenderPassCompose=wm,e.RenderPassDepthAwareBlur=wL,e.RenderPassDof=wC,e.RenderPassDownsample=wl,e.RenderPassForward=he,e.RenderPassPicker=To,e.RenderPassPrepass=wI,e.RenderPassRadixSort=class extends as{destroy(){this._destroyPasses(),this._destroyInternalTextures(),super.destroy();}get sortedIndices(){return this._currentIndices}setup(e,t,i=16){this._keysTexture=e,this._elementCount=t;let s=Math.ceil(i/4);s!==this._numPasses&&(this._destroyPasses(),this._numPasses=s);let r=this._calculateInternalSize(t);r!==this._internalSize&&(this._destroyPasses(),this._resizeInternalTextures(r),this._internalSize=r),0===this._countPasses.length&&this._createPasses();}_calculateInternalSize(e){return Math.pow(2,Math.ceil(Math.log2(Math.ceil(Math.sqrt(e)))))}_resizeInternalTextures(e){this._destroyInternalTextures(),this._keys0=this._createTexture("RadixSortKeys0",e,37),this._keys1=this._createTexture("RadixSortKeys1",e,37),this._indices0=this._createTexture("RadixSortIndices0",e,37),this._indices1=this._createTexture("RadixSortIndices1",e,37);let t=4*e/4;this._prefixSums=this._createTexture("RadixSortPrefixSums",t,15,true),this._sortRT0=new iU({name:"RadixSortRT0",colorBuffers:[this._keys0,this._indices0],depth:false}),this._sortRT1=new iU({name:"RadixSortRT1",colorBuffers:[this._keys1,this._indices1],depth:false}),this._prefixSumsRT=new iU({name:"RadixSortPrefixSumsRT",colorBuffer:this._prefixSums,depth:false});}_createTexture(e,t,i,s=false){return new ih(this.device,{name:e,width:t,height:t,format:i,mipmaps:s,minFilter:2*!!s,magFilter:0,addressU:1,addressV:1})}_destroyInternalTextures(){this._sortRT0?.destroy(),this._sortRT1?.destroy(),this._prefixSumsRT?.destroy(),this._keys0?.destroy(),this._keys1?.destroy(),this._indices0?.destroy(),this._indices1?.destroy(),this._prefixSums?.destroy(),this._sortRT0=null,this._sortRT1=null,this._prefixSumsRT=null,this._keys0=null,this._keys1=null,this._indices0=null,this._indices1=null,this._prefixSums=null;}_createPasses(){let e=this.device,t=this._numPasses,i=this._sortRT1;for(let s=0;s<t;s++){let r=0===s,a=s===t-1,n=4*s,o=new dC(e,r,4,4,n);o.init(this._prefixSumsRT),o.setClearColor(new es(0,0,0,0)),this._countPasses.push(o),this.beforePasses.push(o);let l=new dD(e,r,a,4,4,n);l.setPrefixSumsTexture(this._prefixSums),l.init(i),this._reorderPasses.push(l),this.beforePasses.push(l),i=i===this._sortRT1?this._sortRT0:this._sortRT1;}this._currentIndices=t%2==1?this._indices1:this._indices0;}_destroyPasses(){for(let e of this.beforePasses)e.destroy();this.beforePasses.length=0,this._countPasses.length=0,this._reorderPasses.length=0;}frameUpdate(){if(super.frameUpdate(),!this._keysTexture||0===this._countPasses.length)return;let e=this._countPasses.length,t=this._elementCount,i=Math.log2(this._internalSize*this._internalSize),s=this._internalSize,r=this._keys0,a=this._indices0;for(let n=0;n<e;n++){let e=0===n,o=this._countPasses[n],l=this._reorderPasses[n];e?o.setKeysTexture(this._keysTexture):o.setKeysTexture(r),o.setDynamicParams(t,i),e?l.setKeysTexture(this._keysTexture):(l.setKeysTexture(r),l.setIndicesTexture(a)),l.setDynamicParams(t,i,s),r=r===this._keys0?this._keys1:this._keys0,a=a===this._indices0?this._indices1:this._indices0;}}sort(e,t,i=16){for(let s of(this.setup(e,t,i),this.frameUpdate(),this.beforePasses))s.render();return this.sortedIndices}constructor(e){super(e),this._currentIndices=null,this._numPasses=0,this._internalSize=0,this._keys0=null,this._keys1=null,this._indices0=null,this._indices1=null,this._prefixSums=null,this._sortRT0=null,this._sortRT1=null,this._prefixSumsRT=null,this._countPasses=[],this._reorderPasses=[],this._elementCount=0,this._keysTexture=null;}},e.RenderPassShaderQuad=dT,e.RenderPassSsao=wF,e.RenderPassTAA=wy,e.RenderPassUpsample=wd,e.RenderTarget=iU,e.ResourceHandler=fC,e.ResourceLoader=fI,e.RigidBodyComponent=gi,e.RigidBodyComponentSystem=gh,e.RotateGizmo=class extends bR{set xyzTubeRadius(e){this._setDiskProp("tubeRadius",e);}get xyzTubeRadius(){return this._shapes.x.tubeRadius}set xyzRingRadius(e){this._setDiskProp("ringRadius",e);}get xyzRingRadius(){return this._shapes.x.ringRadius}set faceTubeRadius(e){this._shapes.f.tubeRadius=e;}get faceTubeRadius(){return this._shapes.f.tubeRadius}set faceRingRadius(e){this._shapes.f.ringRadius=e;}get faceRingRadius(){return this._shapes.f.ringRadius}set centerRadius(e){this._shapes.xyz.radius=e;}get centerRadius(){return this._shapes.xyz.radius}set ringTolerance(e){this._setDiskProp("tolerance",e),this._shapes.f.tolerance=e;}get ringTolerance(){return this._shapes.x.tolerance}set angleGuideThickness(e){this._guideAngleLines[0].thickness=e,this._guideAngleLines[1].thickness=e;}get angleGuideThickness(){return this._guideAngleLines[0].thickness}set orbitRotation(e){this.rotationMode=e?"orbit":"absolute";}get orbitRotation(){return "orbit"===this.rotationMode}_setDiskProp(e,t){this._shapes.x[e]=t,this._shapes.y[e]=t,this._shapes.z[e]=t;}_storeGuidePoints(){let e=this.root.getLocalPosition(),t="f"===this._selectedAxis?this.faceRingRadius:this.xyzRingRadius;this._guideAngleStart.copy(this._selectionStartPoint).sub(e).normalize(),this._guideAngleStart.mulScalar(t),this._guideAngleEnd.copy(this._guideAngleStart);}_updateGuidePoints(e){let t=this._selectedAxis;"f"===t?b1.copy(this.facingDir):(b1.set(0,0,0),b1[t]=1,this._rootStartRot.transformVector(b1,b1)),b4.setFromAxisAngle(b1,e),b4.transformVector(this._guideAngleStart,this._guideAngleEnd),this._renderUpdate=true;}_angleGuide(e){let t=this._selectedAxis;if(e&&"show"!==this.dragMode&&"xyz"!==t){let e=this.root.getLocalPosition(),i=this._theme.shapeHover[t],s=b8.copy(i);s.a*=.3,this._guideAngleLines[0].draw(e,b1.copy(this._guideAngleStart).add(e),this._scale,s),this._guideAngleLines[1].draw(e,b1.copy(this._guideAngleEnd).add(e),this._scale,i),this._guideAngleLines[0].entity.enabled=true,this._guideAngleLines[1].entity.enabled=true;}else this._guideAngleLines[0].entity.enabled=false,this._guideAngleLines[1].entity.enabled=false;}_shapesLookAtCamera(){let e,t;if(0===this._camera.projection){let e=this._camera.entity.getPosition().sub(this.root.getPosition()).normalize(),t=Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))*ei.RAD_TO_DEG,i=Math.atan2(-e.x,-e.z)*ei.RAD_TO_DEG;this._shapes.f.entity.setEulerAngles(-t+90,i,0);}else b4.copy(this._camera.entity.getRotation()).getEulerAngles(b1),this._shapes.f.entity.setEulerAngles(b1),this._shapes.f.entity.rotateLocal(-90,0,0);let i=b1.copy(this.facingDir);b4.copy(this.root.getRotation()).invert().transformVector(i,i),e=Math.atan2(i.z,i.y)*ei.RAD_TO_DEG,this._shapes.x.entity.setLocalEulerAngles(0,e-90,-90),e=Math.atan2(i.x,i.z)*ei.RAD_TO_DEG,this._shapes.y.entity.setLocalEulerAngles(0,e,0),e=Math.atan2(i.y,i.x)*ei.RAD_TO_DEG,this._shapes.z.entity.setLocalEulerAngles(90,0,e+90),this._dragging||(t=1-Math.abs(i.dot(this.root.right))>1e-4,this._shapes.x.show(t?"sector":"ring"),t=1-Math.abs(i.dot(this.root.up))>1e-4,this._shapes.y.show(t?"sector":"ring"),t=1-Math.abs(i.dot(this.root.forward))>1e-4,this._shapes.z.show(t?"sector":"ring")),i.equalsApprox(this._facingDir,1e-6)||(this._facingDir.copy(i),this._renderUpdate=true);}_drag(e){for(let t in this._shapes){let i=this._shapes[t];if(i instanceof bZ)switch(this.dragMode){case "show":break;case "hide":i.show(e?t===this._selectedAxis?"ring":"none":"sector");continue;case "selected":i.show(e&&t===this._selectedAxis?"ring":"sector");}}this._renderUpdate=true;}_storeNodeRotations(){let e=this.root.getLocalPosition();for(let t=0;t<this.nodes.length;t++){let i=this.nodes[t];this._nodeLocalRotations.set(i,i.getLocalRotation().clone()),this._nodeRotations.set(i,i.getRotation().clone()),this._nodeOffsets.set(i,i.getPosition().clone().sub(e));}}_setNodeRotations(e,t,i){let s=this.root.getLocalPosition();b4.setFromAxisAngle(t,i);for(let t=0;t<this.nodes.length;t++){let i=this.nodes[t];if(("x"===e||"y"===e||"z"===e)&&"local"===this._coordSpace){let e=this._nodeLocalRotations.get(i);if(!e)continue;b5.copy(e).mul(b4),i.setLocalRotation(b5);}else {let e=this._nodeRotations.get(i);if(!e)continue;let t=this._nodeOffsets.get(i);if(!t)continue;b1.copy(t),b4.transformVector(b1,b1),b5.copy(b4).mul(e),i.setRotation(b5),i.setPosition(b1.add(s));}}"local"===this._coordSpace&&this._updateRotation();}_screenToPoint(e,t){let i=this._camera.screenToWorld(e,t,1),s=this._selectedAxis,r=this._createRay(i),a=this._createPlane(s,"f"===s||"xyz"===s,false);if(!a.intersectsRay(r,b0)){r.direction.mulScalar(-1);let e=a.intersectsRay(r,b0);if(r.direction.mulScalar(-1),!e)return b0.copy(this.root.getLocalPosition())}return b0}_calculateArcAngle(e,t,i){let s=this.root.getLocalPosition(),r=this._selectedAxis,a=this._createPlane(r,"f"===r,false),n=0,o=this.facingDir,l=a.normal.dot(o);switch(this.rotationMode){case "absolute":if(this._camera.worldToScreen(s,b2),"f"===r||l>.9999)b1.set(this._screenStartPos.y>=b2.y?1:-1,this._screenStartPos.x>=b2.x?-1:1,0).normalize();else {let e=b1.cross(a.normal,o).normalize();this._camera.worldToScreen(e.add(s),b3),b1.sub2(b3,b2).normalize();}b2.set(t,i,0),n=b1.dot(b2);break;case "orbit":switch(b1.sub2(e,s),r){case "x":b4.copy(this._rootStartRot).invert().transformVector(b1,b1),n=Math.atan2(b1.z,b1.y)*ei.RAD_TO_DEG;break;case "y":b4.copy(this._rootStartRot).invert().transformVector(b1,b1),n=Math.atan2(b1.x,b1.z)*ei.RAD_TO_DEG;break;case "z":b4.copy(this._rootStartRot).invert().transformVector(b1,b1),n=Math.atan2(b1.y,b1.x)*ei.RAD_TO_DEG;break;case "f":b4.copy(this._camera.entity.getRotation()).invert().transformVector(b1,b1),n=Math.sign(l)*Math.atan2(b1.y,b1.x)*ei.RAD_TO_DEG;}0>b1.sub2(e,this._camera.entity.getPosition()).normalize().dot(this._camera.entity.forward)&&(n+=180);}return n}_drawGuideLines(e,t,i,s){for(let r of b6)"xyz"!==i&&(s?r!==i&&this._drawSpanLine(e,t,r):r===i&&this._drawSpanLine(e,t,r));}prerender(){super.prerender(),this.enabled&&this._shapesLookAtCamera();}destroy(){this._guideAngleLines.forEach(e=>e.destroy()),super.destroy();}constructor(e,t){super(e,t,"gizmo:rotate"),this._shapes={z:new bZ(this._device,{axis:"z",layers:[this._layer.id],rotation:new ed(90,0,90),defaultColor:this._theme.shapeBase.z,hoverColor:this._theme.shapeHover.z,disabledColor:this._theme.disabled,sectorAngle:180}),x:new bZ(this._device,{axis:"x",layers:[this._layer.id],rotation:new ed(0,0,-90),defaultColor:this._theme.shapeBase.x,hoverColor:this._theme.shapeHover.x,disabledColor:this._theme.disabled,sectorAngle:180}),y:new bZ(this._device,{axis:"y",layers:[this._layer.id],rotation:new ed(0,0,0),defaultColor:this._theme.shapeBase.y,hoverColor:this._theme.shapeHover.y,disabledColor:this._theme.disabled,sectorAngle:180}),f:new bZ(this._device,{axis:"f",layers:[this._layer.id],defaultColor:this._theme.shapeBase.f,hoverColor:this._theme.shapeHover.f,disabledColor:this._theme.disabled,ringRadius:.55}),xyz:new bW(this._device,{axis:"xyz",layers:[this._layer.id],defaultColor:this._theme.shapeBase.xyz,hoverColor:this._theme.shapeHover.xyz,disabledColor:this._theme.disabled,radius:.5})},this._selectionStartAngle=0,this._nodeLocalRotations=new Map,this._nodeRotations=new Map,this._nodeOffsets=new Map,this._screenPos=new ef,this._screenStartPos=new ef,this._guideAngleStart=new ed,this._guideAngleEnd=new ed,this._facingDir=new ed,this.snapIncrement=5,this.rotationMode="absolute",this.setTheme({shapeBase:{xyz:new es(0,0,0,0)},shapeHover:{xyz:new es(1,1,1,.2)}}),this._createTransform(),this._guideAngleLines=[new bJ(this._app,this._layer),new bJ(this._app,this._layer)],this._guideAngleLines.forEach(e=>{this._app.root.addChild(e.entity),e.entity.enabled=false;}),this.on(bR.EVENT_TRANSFORMSTART,(e,t,i)=>{this._screenPos.set(t,i),this._screenStartPos.set(t,i),this._selectionStartAngle=this._calculateArcAngle(e,t,i),this._storeNodeRotations(),this._storeGuidePoints(),this._drag(true),this._angleGuide(true);}),this.on(bR.EVENT_TRANSFORMMOVE,(e,t,i)=>{let s=this._selectedAxis;if(s)if(this._screenPos.set(t,i),"xyz"===s){let t=b1.copy(this.facingDir),i=b2.copy(e).sub(this._selectionStartPoint),r=b1.cross(t,i).normalize(),a=this._screenPos.distance(this._screenStartPos);this._setNodeRotations(s,r,a);}else {let r=this._calculateArcAngle(e,t,i)-this._selectionStartAngle;this.snap&&(r=Math.round(r/this.snapIncrement)*this.snapIncrement);let a=this._dirFromAxis(s,b1);this._setNodeRotations(s,a,r),this._updateGuidePoints(r),this._angleGuide(true);}}),this.on(bR.EVENT_TRANSFORMEND,()=>{this._drag(false),this._angleGuide(false);}),this.on(bR.EVENT_NODESDETACH,()=>{this._nodeLocalRotations.clear(),this._nodeRotations.clear(),this._nodeOffsets.clear();});}},e.SAMPLETYPE_DEPTH=2,e.SAMPLETYPE_FLOAT=0,e.SAMPLETYPE_INT=3,e.SAMPLETYPE_UINT=4,e.SAMPLETYPE_UNFILTERABLE_FLOAT=1,e.SCALEMODE_BLEND=gd,e.SCALEMODE_NONE=gc,e.SCROLLBAR_VISIBILITY_SHOW_ALWAYS=0,e.SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED=1,e.SCROLL_MODE_BOUNCE=1,e.SCROLL_MODE_CLAMP=0,e.SCROLL_MODE_INFINITE=2,e.SEMANTIC_ATTR0=tu,e.SEMANTIC_ATTR1=tf,e.SEMANTIC_ATTR10=tT,e.SEMANTIC_ATTR11=tE,e.SEMANTIC_ATTR12=tw,e.SEMANTIC_ATTR13=tb,e.SEMANTIC_ATTR14=tA,e.SEMANTIC_ATTR15=tC,e.SEMANTIC_ATTR2=tp,e.SEMANTIC_ATTR3=tm,e.SEMANTIC_ATTR4=t_,e.SEMANTIC_ATTR5=tg,e.SEMANTIC_ATTR6=tv,e.SEMANTIC_ATTR7=tS,e.SEMANTIC_ATTR8=ty,e.SEMANTIC_ATTR9=tx,e.SEMANTIC_BLENDINDICES=tt,e.SEMANTIC_BLENDWEIGHT=te,e.SEMANTIC_COLOR=ti,e.SEMANTIC_NORMAL=e9,e.SEMANTIC_POSITION=e6,e.SEMANTIC_TANGENT=e7,e.SEMANTIC_TEXCOORD=ts,e.SEMANTIC_TEXCOORD0=tr,e.SEMANTIC_TEXCOORD1=ta,e.SEMANTIC_TEXCOORD2=tn,e.SEMANTIC_TEXCOORD3=to,e.SEMANTIC_TEXCOORD4=tl,e.SEMANTIC_TEXCOORD5=th,e.SEMANTIC_TEXCOORD6=tc,e.SEMANTIC_TEXCOORD7=td,e.SHADERDEF_BATCH=16384,e.SHADERDEF_DIRLM=128,e.SHADERDEF_INSTANCING=32,e.SHADERDEF_LM=64,e.SHADERDEF_LMAMBIENT=4096,e.SHADERDEF_MORPH_NORMAL=2048,e.SHADERDEF_MORPH_POSITION=1024,e.SHADERDEF_MORPH_TEXTURE_BASED_INT=8192,e.SHADERDEF_NOSHADOW=1,e.SHADERDEF_SCREENSPACE=256,e.SHADERDEF_SKIN=2,e.SHADERDEF_TANGENTS=512,e.SHADERDEF_UV0=4,e.SHADERDEF_UV1=8,e.SHADERDEF_VCOLOR=16,e.SHADERLANGUAGE_GLSL=tz,e.SHADERLANGUAGE_WGSL=tV,e.SHADERPASS_ALBEDO="debug_albedo",e.SHADERPASS_AO="debug_ao",e.SHADERPASS_EMISSION="debug_emission",e.SHADERPASS_FORWARD="forward",e.SHADERPASS_GLOSS="debug_gloss",e.SHADERPASS_LIGHTING="debug_lighting",e.SHADERPASS_METALNESS="debug_metalness",e.SHADERPASS_OPACITY="debug_opacity",e.SHADERPASS_SPECULARITY="debug_specularity",e.SHADERPASS_UV0="debug_uv0",e.SHADERPASS_WORLDNORMAL="debug_world_normal",e.SHADERSTAGE_COMPUTE=4,e.SHADERSTAGE_FRAGMENT=2,e.SHADERSTAGE_VERTEX=1,e.SHADERTAG_MATERIAL=1,e.SHADER_DEPTH_PICK=4,e.SHADER_FORWARD=0,e.SHADER_PICK=3,e.SHADER_PREPASS=1,e.SHADER_SHADOW=2,e.SHADOWCAMERA_NAME=nM,e.SHADOWUPDATE_NONE=0,e.SHADOWUPDATE_REALTIME=2,e.SHADOWUPDATE_THISFRAME=1,e.SHADOW_CASCADE_0=1,e.SHADOW_CASCADE_1=2,e.SHADOW_CASCADE_2=4,e.SHADOW_CASCADE_3=8,e.SHADOW_CASCADE_ALL=255,e.SHADOW_PCF1=5,e.SHADOW_PCF1_16F=7,e.SHADOW_PCF1_32F=5,e.SHADOW_PCF3=0,e.SHADOW_PCF3_16F=8,e.SHADOW_PCF3_32F=0,e.SHADOW_PCF5=4,e.SHADOW_PCF5_16F=9,e.SHADOW_PCF5_32F=4,e.SHADOW_PCSS_32F=6,e.SHADOW_VSM16=2,e.SHADOW_VSM32=3,e.SHADOW_VSM_16F=2,e.SHADOW_VSM_32F=3,e.SKYTYPE_BOX="box",e.SKYTYPE_DOME=ny,e.SKYTYPE_INFINITE=nS,e.SORTMODE_BACK2FRONT=3,e.SORTMODE_CUSTOM=5,e.SORTMODE_FRONT2BACK=4,e.SORTMODE_MANUAL=1,e.SORTMODE_MATERIALMESH=2,e.SORTMODE_NONE=0,e.SPECOCC_AO=1,e.SPECOCC_GLOSSDEPENDENT=2,e.SPECOCC_NONE=0,e.SPRITETYPE_ANIMATED=gG,e.SPRITETYPE_SIMPLE=gV,e.SPRITE_RENDERMODE_SIMPLE=0,e.SPRITE_RENDERMODE_SLICED=1,e.SPRITE_RENDERMODE_TILED=2,e.SSAOTYPE_COMBINE=wa,e.SSAOTYPE_LIGHTING=wr,e.SSAOTYPE_NONE=ws,e.STENCILOP_DECREMENT=5,e.STENCILOP_DECREMENTWRAP=6,e.STENCILOP_INCREMENT=3,e.STENCILOP_INCREMENTWRAP=4,e.STENCILOP_INVERT=7,e.STENCILOP_KEEP=0,e.STENCILOP_REPLACE=2,e.STENCILOP_ZERO=1,e.ScaleGizmo=class extends bR{set coordSpace(e){}get coordSpace(){return this._coordSpace}set uniform(e){this._uniform=e??this._uniform;}get uniform(){return this._uniform}set axisGap(e){this._setArrowProp("gap",e);}get axisGap(){return this._shapes.x.gap}set axisLineThickness(e){this._setArrowProp("lineThickness",e);}get axisLineThickness(){return this._shapes.x.lineThickness}set axisLineLength(e){this._setArrowProp("lineLength",e);}get axisLineLength(){return this._shapes.x.lineLength}set axisLineTolerance(e){this._setArrowProp("tolerance",e);}get axisLineTolerance(){return this._shapes.x.tolerance}set axisBoxSize(e){this._setArrowProp("boxSize",e);}get axisBoxSize(){return this._shapes.x.boxSize}set axisPlaneSize(e){this._setPlaneProp("size",e);}get axisPlaneSize(){return this._shapes.yz.size}set axisPlaneGap(e){this._setPlaneProp("gap",e);}get axisPlaneGap(){return this._shapes.yz.gap}set axisCenterSize(e){this._shapes.xyz.size=e;}get axisCenterSize(){return this._shapes.xyz.size}set flipShapes(e){this.flipPlanes=e;}get flipShapes(){return this.flipPlanes}_setArrowProp(e,t){this._shapes.x[e]=t,this._shapes.y[e]=t,this._shapes.z[e]=t;}_setPlaneProp(e,t){this._shapes.yz[e]=t,this._shapes.xz[e]=t,this._shapes.xy[e]=t;}_shapesLookAtCamera(){let e,t,i=this.cameraDir,s=false;e=1-Math.abs(i.dot(this.root.right))>.01,this._shapes.x.entity.enabled!==e&&(this._shapes.x.entity.enabled=e,s=true),e=1-Math.abs(i.dot(this.root.up))>.01,this._shapes.y.entity.enabled!==e&&(this._shapes.y.entity.enabled=e,s=true),e=1-Math.abs(i.dot(this.root.forward))>.01,this._shapes.z.entity.enabled!==e&&(this._shapes.z.entity.enabled=e,s=true),As.cross(i,this.root.right),e=1-As.length()>.01,this._shapes.yz.entity.enabled!==e&&(this._shapes.yz.entity.enabled=e,s=true),t=this.flipPlanes?Ar.set(0,+(0>As.dot(this.root.forward)),+(0>As.dot(this.root.up))):ed.ZERO,this._shapes.yz.flipped.equals(t)||(this._shapes.yz.flipped=t,s=true),As.cross(i,this.root.forward),e=1-As.length()>.01,this._shapes.xy.entity.enabled!==e&&(this._shapes.xy.entity.enabled=e,s=true),t=this.flipPlanes?Ar.set(+(0>As.dot(this.root.up)),+(As.dot(this.root.right)>0),0):ed.ZERO,this._shapes.xy.flipped.equals(t)||(this._shapes.xy.flipped=t,s=true),As.cross(i,this.root.up),e=1-As.length()>.01,this._shapes.xz.entity.enabled!==e&&(this._shapes.xz.entity.enabled=e,s=true),t=this.flipPlanes?Ar.set(+(As.dot(this.root.forward)>0),0,+(As.dot(this.root.right)>0)):ed.ZERO,this._shapes.xz.flipped.equals(t)||(this._shapes.xz.flipped=t,s=true),s&&(this._renderUpdate=true);}_drag(e){for(let t in this._shapes){let i=this._shapes[t];switch(this.dragMode){case "show":continue;case "hide":i.visible=!e;continue;case "selected":if("xyz"===this._selectedAxis){i.visible=!e||1===t.length;continue}if(this._selectedIsPlane){i.visible=!e||1===t.length&&!t.includes(this._selectedAxis);continue}i.visible=!e||t===this._selectedAxis;continue}}this._renderUpdate=true;}_storeNodeScales(){for(let e=0;e<this.nodes.length;e++){let t=this.nodes[e];this._nodeScales.set(t,t.getLocalScale().clone());}}_setNodeScales(e){for(let t=0;t<this.nodes.length;t++){let i=this.nodes[t],s=this._nodeScales.get(i);s&&i.setLocalScale(As.copy(s).mul(e).max(this.lowerBoundScale));}}_screenToPoint(e,t){let i=this.root.getLocalPosition(),s=this._camera.screenToWorld(e,t,1),r=this._selectedAxis,a=this._selectedIsPlane,n=this._createRay(s);if(!this._createPlane(r,"xyz"===r,!a).intersectsRay(n,Aa))return Aa;if("xyz"===r){let e=Ar.add2(this._camera.entity.up,this._camera.entity.right).normalize(),t=As.sub2(Aa,i),s=t.length()*t.normalize().dot(e);return Aa.set(s,s,s),Aa}return Ao.copy(this._rootStartRot).invert().transformVector(Aa,Aa),a||this._projectToAxis(Aa,r),this._uniform&&a&&(As.set(1,1,1),As[r]=0,Aa.copy(As.mulScalar(As.dot(Aa))),Aa[r]=0),Aa}prerender(){super.prerender(),this.enabled&&this._shapesLookAtCamera();}constructor(e,t){super(e,t,"gizmo:scale"),this._shapes={xyz:new b9(this._device,{axis:"xyz",layers:[this._layer.id],defaultColor:this._theme.shapeBase.xyz,hoverColor:this._theme.shapeHover.xyz,disabledColor:this._theme.disabled}),yz:new bU(this._device,{axis:"x",layers:[this._layer.id],rotation:new ed(0,0,-90),defaultColor:this._theme.shapeBase.x,hoverColor:this._theme.shapeHover.x,disabledColor:this._theme.disabled,depth:1}),xz:new bU(this._device,{axis:"y",layers:[this._layer.id],rotation:new ed(0,0,0),defaultColor:this._theme.shapeBase.y,hoverColor:this._theme.shapeHover.y,disabledColor:this._theme.disabled,depth:1}),xy:new bU(this._device,{axis:"z",layers:[this._layer.id],rotation:new ed(90,0,0),defaultColor:this._theme.shapeBase.z,hoverColor:this._theme.shapeHover.z,disabledColor:this._theme.disabled,depth:1}),x:new Ai(this._device,{axis:"x",layers:[this._layer.id],rotation:new ed(0,0,-90),defaultColor:this._theme.shapeBase.x,hoverColor:this._theme.shapeHover.x,disabledColor:this._theme.disabled}),y:new Ai(this._device,{axis:"y",layers:[this._layer.id],rotation:new ed(0,0,0),defaultColor:this._theme.shapeBase.y,hoverColor:this._theme.shapeHover.y,disabledColor:this._theme.disabled}),z:new Ai(this._device,{axis:"z",layers:[this._layer.id],rotation:new ed(90,0,0),defaultColor:this._theme.shapeBase.z,hoverColor:this._theme.shapeHover.z,disabledColor:this._theme.disabled})},this._coordSpace="local",this._nodeScales=new Map,this._uniform=false,this.snapIncrement=1,this.flipPlanes=true,this.lowerBoundScale=new ed(-1/0,-1/0,-1/0),this._createTransform(),this.on(bR.EVENT_TRANSFORMSTART,()=>{this._storeNodeScales(),this._drag(true);}),this.on(bR.EVENT_TRANSFORMMOVE,e=>{let t=An.copy(e).sub(this._selectionStartPoint);this.snap&&(t.mulScalar(1/this.snapIncrement),t.round(),t.mulScalar(this.snapIncrement)),t.mulScalar(1/this._scale),this._setNodeScales(t.add(ed.ONE));}),this.on(bR.EVENT_TRANSFORMEND,()=>{this._drag(false);}),this.on(bR.EVENT_NODESDETACH,()=>{this._nodeScales.clear();});}},e.Scene=ds,e.SceneHandler=yH,e.SceneRegistry=fU,e.SceneRegistryItem=fk,e.SceneSettingsHandler=class extends fC{load(e,t){yD.load(e,this.maxRetries,t);}open(e,t){return t.settings}constructor(e){super(e,"scenesettings");}},e.ScopeId=ib,e.ScopeSpace=iA,e.ScreenComponent=gf,e.ScreenComponentSystem=g_,e.Script=vc,e.ScriptAttributes=vo,e.ScriptComponent=vp,e.ScriptComponentSystem=vg,e.ScriptHandler=yK,e.ScriptRegistry=fL,e.ScriptType=vf,e.ScrollViewComponent=gC,e.ScrollViewComponentSystem=gD,e.ScrollbarComponent=gR,e.ScrollbarComponentSystem=gO,e.Shader=rd,e.ShaderChunks=nH,e.ShaderHandler=yZ,e.ShaderMaterial=cf,e.ShaderPass=nz,e.ShaderUtils=nY,e.SingleContactResult=ga,e.SingleGestureSource=class extends wW{set layout(e){this._layout!==e&&(this._layout=e,this.read(),this._pointerData.clear());}get layout(){return this._layout}get joystick(){return this._joystick}_onPointerDown(e){let{pointerType:t,pointerId:i,clientX:s,clientY:r}=e;if(this._movementState.down(e),"touch"!==t)return;this._element?.setPointerCapture(i),this._pointerData.set(i,{x:s,y:r});let a=Date.now();(this._lastPointer.x-s)**2+(this._lastPointer.y-r)**2<100&&a-this._lastPointer.time<250&&this.deltas.doubleTap.append([1]),this._lastPointer.x=s,this._lastPointer.y=r,this._lastPointer.time=a,"joystick"===this._layout&&this.fire("joystick:position",this._joystick.down(s,r));}_onPointerMove(e){let{pointerType:t,pointerId:i,target:s,clientX:r,clientY:a}=e,[n,o]=this._movementState.move(e);if("touch"!==t||s!==this._element)return;let l=this._pointerData.get(i);l&&(l.x=r,l.y=a,"joystick"===this._layout?this.fire("joystick:position",this._joystick.move(r,a)):this.deltas.input.append([n,o]));}_onPointerUp(e){let{pointerType:t,pointerId:i}=e;this._movementState.up(e),"touch"!==t||(this._element?.releasePointerCapture(i),this._pointerData.get(i)&&(this._pointerData.delete(i),"joystick"===this._layout&&this.fire("joystick:position",this._joystick.up())));}attach(e){super.attach(e),this._element=e,this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("pointercancel",this._onPointerUp);}detach(){this._element&&(this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("pointercancel",this._onPointerUp),this._pointerData.clear(),super.detach());}read(){return this.deltas.input.append([this._joystick.value.x,this._joystick.value.y]),super.read()}destroy(){this._joystick.up(),super.destroy();}constructor(){super({input:[0,0],doubleTap:[0]}),this._movementState=wq(),this._layout="joystick",this._pointerData=new Map,this._lastPointer={x:0,y:0,time:0},this._joystick=new wj,this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this);}},e.Skeleton=dp,e.Skin=dr,e.SkinBatchInstance=n5,e.SkinInstance=n4,e.Sky=cW,e.SortedLoopArray=K,e.Sound=a2,e.SoundComponent=gB,e.SoundComponentSystem=gz,e.SoundInstance=a4,e.SoundInstance3d=a5,e.SoundManager=a1,e.SoundSlot=gN,e.SphereGeometry=cz,e.Sprite=dl,e.SpriteAnimationClip=gH,e.SpriteComponent=g$,e.SpriteComponentSystem=gZ,e.SpriteHandler=y0,e.StandardMaterial=d0,e.StandardMaterialOptions=dU,e.StencilParameters=iN,e.StorageBuffer=rI,e.TEXHINT_ASSET=2,e.TEXHINT_LIGHTMAP=3,e.TEXHINT_NONE=0,e.TEXHINT_SHADOWMAP=1,e.TEXPROPERTY_ADDRESS_U=4,e.TEXPROPERTY_ADDRESS_V=8,e.TEXPROPERTY_ADDRESS_W=16,e.TEXPROPERTY_ALL=255,e.TEXPROPERTY_ANISOTROPY=128,e.TEXPROPERTY_COMPARE_FUNC=64,e.TEXPROPERTY_COMPARE_ON_READ=32,e.TEXPROPERTY_MAG_FILTER=2,e.TEXPROPERTY_MIN_FILTER=1,e.TEXTUREDIMENSION_1D="1d",e.TEXTUREDIMENSION_2D="2d",e.TEXTUREDIMENSION_2D_ARRAY=tM,e.TEXTUREDIMENSION_3D="3d",e.TEXTUREDIMENSION_CUBE=tO,e.TEXTUREDIMENSION_CUBE_ARRAY=tF,e.TEXTURELOCK_NONE=0,e.TEXTURELOCK_READ=1,e.TEXTURELOCK_WRITE=2,e.TEXTUREPROJECTION_CUBE=tB,e.TEXTUREPROJECTION_EQUIRECT=tk,e.TEXTUREPROJECTION_NONE=tN,e.TEXTUREPROJECTION_OCTAHEDRAL=tU,e.TEXTURETYPE_DEFAULT=tP,e.TEXTURETYPE_RGBE=tD,e.TEXTURETYPE_RGBM=tI,e.TEXTURETYPE_RGBP=tR,e.TEXTURETYPE_SWIZZLEGGGR=tL,e.TONEMAP_ACES=3,e.TONEMAP_ACES2=4,e.TONEMAP_FILMIC=1,e.TONEMAP_HEJL=2,e.TONEMAP_LINEAR=0,e.TONEMAP_NEUTRAL=5,e.TONEMAP_NONE=6,e.TRACEID_ASSETS="Assets",e.TRACEID_BINDGROUPFORMAT_ALLOC="BindGroupFormatAlloc",e.TRACEID_BINDGROUP_ALLOC="BindGroupAlloc",e.TRACEID_COMPUTEPIPELINE_ALLOC="ComputePipelineAlloc",e.TRACEID_ELEMENT="Element",e.TRACEID_GPU_TIMINGS=E,e.TRACEID_OCTREE_RESOURCES="OctreeResources",e.TRACEID_PIPELINELAYOUT_ALLOC="PipelineLayoutAlloc",e.TRACEID_RENDERPIPELINE_ALLOC="RenderPipelineAlloc",e.TRACEID_RENDER_ACTION="RenderAction",e.TRACEID_RENDER_FRAME="RenderFrame",e.TRACEID_RENDER_FRAME_TIME="RenderFrameTime",e.TRACEID_RENDER_PASS="RenderPass",e.TRACEID_RENDER_PASS_DETAIL="RenderPassDetail",e.TRACEID_RENDER_QUEUE="RenderQueue",e.TRACEID_RENDER_TARGET_ALLOC="RenderTargetAlloc",e.TRACEID_SHADER_ALLOC="ShaderAlloc",e.TRACEID_SHADER_COMPILE="ShaderCompile",e.TRACEID_TEXTURES="Textures",e.TRACEID_TEXTURE_ALLOC="TextureAlloc",e.TRACEID_VRAM_IB="VRAM.Ib",e.TRACEID_VRAM_SB="VRAM.Sb",e.TRACEID_VRAM_TEXTURE="VRAM.Texture",e.TRACEID_VRAM_VB="VRAM.Vb",e.TYPE_FLOAT16=7,e.TYPE_FLOAT32=6,e.TYPE_INT16=2,e.TYPE_INT32=4,e.TYPE_INT8=0,e.TYPE_UINT16=3,e.TYPE_UINT32=5,e.TYPE_UINT8=1,e.Tags=Z,e.Template=y1,e.TemplateHandler=y2,e.TextElement=m5,e.TextHandler=y3,e.Texture=ih,e.TextureAtlas=dh,e.TextureAtlasHandler=y6,e.TextureHandler=xy,e.TextureUtils=is,e.TextureView=io,e.TorusGeometry=ur,e.Touch=aW,e.TouchDevice=aY,e.TouchEvent=aX,e.Tracing=et,e.TransformFeedback=class{static createShader(e,t,i,s){return new rd(e,rh.createDefinition(e,{name:i,vertexCode:t,feedbackVaryings:s,useTransformFeedback:true,fragmentCode:"void main(void) {gl_FragColor = vec4(0.0);}"}))}destroy(){this._destroyOutputBuffer&&this._outputBuffer.destroy();}process(e,t=true){let i=this.device,s=i.getRenderTarget();if(i.setRenderTarget(null),i.updateBegin(),i.setVertexBuffer(this._inputBuffer),i.setRaster(false),i.setTransformFeedbackBuffer(this._outputBuffer),i.setShader(e),i.draw({type:0,base:0,baseVertex:0,count:this._inputBuffer.numVertices,indexed:false}),i.setTransformFeedbackBuffer(null),i.setRaster(true),i.updateEnd(),i.setRenderTarget(s),t){let e=this._inputBuffer.impl.bufferId;this._inputBuffer.impl.bufferId=this._outputBuffer.impl.bufferId,this._outputBuffer.impl.bufferId=e,e=this._inputBuffer.impl.vao,this._inputBuffer.impl.vao=this._outputBuffer.impl.vao,this._outputBuffer.impl.vao=e;}}get inputBuffer(){return this._inputBuffer}get outputBuffer(){return this._outputBuffer}constructor(e,t,i=3){ void 0===t||t instanceof iP||(i=t,t=void 0),this.device=e.device;let s=this.device.gl,r=t??e;3===i&&r.usage!==i&&(s.bindBuffer(s.ARRAY_BUFFER,r.impl.bufferId),s.bufferData(s.ARRAY_BUFFER,r.storage,s.DYNAMIC_COPY)),this._inputBuffer=e,this._destroyOutputBuffer=!t,this._outputBuffer=t??new iP(e.device,e.format,e.numVertices,{usage:i,data:e.storage});}},e.TransformGizmo=bR,e.TranslateGizmo=class extends bR{set axisGap(e){this._setArrowProp("gap",e);}get axisGap(){return this._shapes.x.gap}set axisLineThickness(e){this._setArrowProp("lineThickness",e);}get axisLineThickness(){return this._shapes.x.lineThickness}set axisLineLength(e){this._setArrowProp("lineLength",e);}get axisLineLength(){return this._shapes.x.lineLength}set axisLineTolerance(e){this._setArrowProp("tolerance",e);}get axisLineTolerance(){return this._shapes.x.tolerance}set axisArrowThickness(e){this._setArrowProp("arrowThickness",e);}get axisArrowThickness(){return this._shapes.x.arrowThickness}set axisArrowLength(e){this._setArrowProp("arrowLength",e);}get axisArrowLength(){return this._shapes.x.arrowLength}set axisPlaneSize(e){this._setPlaneProp("size",e);}get axisPlaneSize(){return this._shapes.yz.size}set axisPlaneGap(e){this._setPlaneProp("gap",e);}get axisPlaneGap(){return this._shapes.yz.gap}set axisCenterSize(e){this._shapes.xyz.radius=e;}get axisCenterSize(){return this._shapes.xyz.radius}set flipShapes(e){this.flipPlanes=e;}get flipShapes(){return this.flipPlanes}_setArrowProp(e,t){this._shapes.x[e]=t,this._shapes.y[e]=t,this._shapes.z[e]=t;}_setPlaneProp(e,t){this._shapes.yz[e]=t,this._shapes.xz[e]=t,this._shapes.xy[e]=t;}_shapesLookAtCamera(){let e,t,i=this.cameraDir,s=false;e=1-Math.abs(i.dot(this.root.right))>.01,this._shapes.x.entity.enabled!==e&&(this._shapes.x.entity.enabled=e,s=true),e=1-Math.abs(i.dot(this.root.up))>.01,this._shapes.y.entity.enabled!==e&&(this._shapes.y.entity.enabled=e,s=true),e=1-Math.abs(i.dot(this.root.forward))>.01,this._shapes.z.entity.enabled!==e&&(this._shapes.z.entity.enabled=e,s=true),bX.cross(i,this.root.right),e=1-bX.length()>.01,this._shapes.yz.entity.enabled!==e&&(this._shapes.yz.entity.enabled=e,s=true),t=this.flipPlanes?bY.set(0,+(0>bX.dot(this.root.forward)),+(0>bX.dot(this.root.up))):ed.ZERO,this._shapes.yz.flipped.equals(t)||(this._shapes.yz.flipped=t,s=true),bX.cross(i,this.root.forward),e=1-bX.length()>.01,this._shapes.xy.entity.enabled!==e&&(this._shapes.xy.entity.enabled=e,s=true),t=this.flipPlanes?bY.set(+(0>bX.dot(this.root.up)),+(bX.dot(this.root.right)>0),0):ed.ZERO,this._shapes.xy.flipped.equals(t)||(this._shapes.xy.flipped=t,s=true),bX.cross(i,this.root.up),e=1-bX.length()>.01,this._shapes.xz.entity.enabled!==e&&(this._shapes.xz.entity.enabled=e,s=true),t=this.flipPlanes?bY.set(+(bX.dot(this.root.forward)>0),0,+(bX.dot(this.root.right)>0)):ed.ZERO,this._shapes.xz.flipped.equals(t)||(this._shapes.xz.flipped=t,s=true),s&&(this._renderUpdate=true);}_drag(e){for(let t in this._shapes){let i=this._shapes[t];switch(this.dragMode){case "show":continue;case "hide":i.visible=!e;continue;case "selected":if("xyz"===this._selectedAxis){i.visible=!e||1===t.length;continue}if(this._selectedIsPlane){i.visible=!e||1===t.length&&!t.includes(this._selectedAxis);continue}i.visible=!e||t===this._selectedAxis;}}this._renderUpdate=true;}_storeNodePositions(){for(let e=0;e<this.nodes.length;e++){let t=this.nodes[e];this._nodeLocalPositions.set(t,t.getLocalPosition().clone()),this._nodePositions.set(t,t.getPosition().clone());}}_setNodePositions(e){for(let t=0;t<this.nodes.length;t++){let i=this.nodes[t];if("local"===this._coordSpace){let t=this._nodeLocalPositions.get(i);if(!t)continue;bX.copy(e),i.parent?.getWorldTransform().getScale(bY),bY.x=1/bY.x,bY.y=1/bY.y,bY.z=1/bY.z,bj.copy(i.getLocalRotation()).transformVector(bX,bX),bX.mul(bY),i.setLocalPosition(bX.add(t));}else {let t=this._nodePositions.get(i);if(!t)continue;i.setPosition(bX.copy(e).add(t));}}this._updatePosition();}_screenToPoint(e,t){let i=this._camera.screenToWorld(e,t,1),s=this._selectedAxis,r=this._selectedIsPlane,a=this._createRay(i);return this._createPlane(s,"xyz"===s,!r).intersectsRay(a,bq)&&(bj.copy(this._rootStartRot).invert().transformVector(bq,bq),r||"xyz"===s||this._projectToAxis(bq,s)),bq}_drawGuideLines(e,t,i,s){for(let r of bK){if(this._dragging||"xyz"===i){this._drawSpanLine(e,t,r);continue}s?r!==i&&this._drawSpanLine(e,t,r):r===i&&this._drawSpanLine(e,t,r);}}prerender(){super.prerender(),this.enabled&&this._shapesLookAtCamera();}constructor(e,t){super(e,t,"gizmo:translate"),this._shapes={xyz:new bW(this._device,{axis:"xyz",layers:[this._layer.id],defaultColor:this._theme.shapeBase.xyz,hoverColor:this._theme.shapeHover.xyz,disabledColor:this._theme.disabled}),yz:new bU(this._device,{axis:"x",layers:[this._layer.id],rotation:new ed(0,0,-90),defaultColor:this._theme.shapeBase.x,hoverColor:this._theme.shapeHover.x,disabledColor:this._theme.disabled,depth:1}),xz:new bU(this._device,{axis:"y",layers:[this._layer.id],rotation:new ed(0,0,0),defaultColor:this._theme.shapeBase.y,hoverColor:this._theme.shapeHover.y,disabledColor:this._theme.disabled,depth:1}),xy:new bU(this._device,{axis:"z",layers:[this._layer.id],rotation:new ed(90,0,0),defaultColor:this._theme.shapeBase.z,hoverColor:this._theme.shapeHover.z,disabledColor:this._theme.disabled,depth:1}),x:new bH(this._device,{axis:"x",layers:[this._layer.id],rotation:new ed(0,0,-90),defaultColor:this._theme.shapeBase.x,hoverColor:this._theme.shapeHover.x,disabledColor:this._theme.disabled}),y:new bH(this._device,{axis:"y",layers:[this._layer.id],rotation:new ed(0,0,0),defaultColor:this._theme.shapeBase.y,hoverColor:this._theme.shapeHover.y,disabledColor:this._theme.disabled}),z:new bH(this._device,{axis:"z",layers:[this._layer.id],rotation:new ed(90,0,0),defaultColor:this._theme.shapeBase.z,hoverColor:this._theme.shapeHover.z,disabledColor:this._theme.disabled})},this._nodeLocalPositions=new Map,this._nodePositions=new Map,this.snapIncrement=1,this.flipPlanes=true,this._createTransform(),this.on(bR.EVENT_TRANSFORMSTART,()=>{this._storeNodePositions(),this._drag(true);}),this.on(bR.EVENT_TRANSFORMMOVE,e=>{let t=b$.copy(e).sub(this._selectionStartPoint);this.snap&&(t.mulScalar(1/this.snapIncrement),t.round(),t.mulScalar(this.snapIncrement)),this._setNodePositions(t);}),this.on(bR.EVENT_TRANSFORMEND,()=>{this._drag(false);}),this.on(bR.EVENT_NODESDETACH,()=>{this._nodeLocalPositions.clear(),this._nodePositions.clear();});}},e.Tri=eH,e.UNIFORMTYPE_BOOL=0,e.UNIFORMTYPE_BOOLARRAY=32,e.UNIFORMTYPE_BVEC2=9,e.UNIFORMTYPE_BVEC2ARRAY=35,e.UNIFORMTYPE_BVEC3=10,e.UNIFORMTYPE_BVEC3ARRAY=38,e.UNIFORMTYPE_BVEC4=11,e.UNIFORMTYPE_BVEC4ARRAY=41,e.UNIFORMTYPE_FLOAT=2,e.UNIFORMTYPE_FLOATARRAY=17,e.UNIFORMTYPE_INT=1,e.UNIFORMTYPE_INTARRAY=30,e.UNIFORMTYPE_ITEXTURE2D=42,e.UNIFORMTYPE_ITEXTURE2D_ARRAY=48,e.UNIFORMTYPE_ITEXTURE3D=46,e.UNIFORMTYPE_ITEXTURECUBE=44,e.UNIFORMTYPE_IVEC2=6,e.UNIFORMTYPE_IVEC2ARRAY=33,e.UNIFORMTYPE_IVEC3=7,e.UNIFORMTYPE_IVEC3ARRAY=36,e.UNIFORMTYPE_IVEC4=8,e.UNIFORMTYPE_IVEC4ARRAY=39,e.UNIFORMTYPE_MAT2=12,e.UNIFORMTYPE_MAT3=13,e.UNIFORMTYPE_MAT4=14,e.UNIFORMTYPE_MAT4ARRAY=24,e.UNIFORMTYPE_TEXTURE2D=15,e.UNIFORMTYPE_TEXTURE2D_ARRAY=25,e.UNIFORMTYPE_TEXTURE2D_SHADOW=18,e.UNIFORMTYPE_TEXTURE3D=20,e.UNIFORMTYPE_TEXTURECUBE=16,e.UNIFORMTYPE_TEXTURECUBE_SHADOW=19,e.UNIFORMTYPE_UINT=26,e.UNIFORMTYPE_UINTARRAY=31,e.UNIFORMTYPE_UTEXTURE2D=43,e.UNIFORMTYPE_UTEXTURE2D_ARRAY=49,e.UNIFORMTYPE_UTEXTURE3D=47,e.UNIFORMTYPE_UTEXTURECUBE=45,e.UNIFORMTYPE_UVEC2=27,e.UNIFORMTYPE_UVEC2ARRAY=34,e.UNIFORMTYPE_UVEC3=28,e.UNIFORMTYPE_UVEC3ARRAY=37,e.UNIFORMTYPE_UVEC4=29,e.UNIFORMTYPE_UVEC4ARRAY=40,e.UNIFORMTYPE_VEC2=3,e.UNIFORMTYPE_VEC2ARRAY=21,e.UNIFORMTYPE_VEC3=4,e.UNIFORMTYPE_VEC3ARRAY=22,e.UNIFORMTYPE_VEC4=5,e.UNIFORMTYPE_VEC4ARRAY=23,e.UNIFORM_BUFFER_DEFAULT_SLOT_NAME=tZ,e.UNUSED_UNIFORM_NAME=tQ,e.URI=ee,e.UniformBufferFormat=sf,e.UniformFormat=su,e.UsdzExporter=class extends Eu{init(){this.meshMap=new Map,this.textureMap=new Map,this.materialMap=new Map,this.materials=[],this.files={},this.nodeNames=new Set;}done(){this.meshMap=null,this.textureMap=null,this.materialMap=null,this.materials=null,this.files=null,this.nodeNames=null;}build(e,t={}){let i;this.init(),this.addFile(null,E5);let s=[];e&&e.findComponents("render").forEach(e=>{s.push(...e.meshInstances);});let r="";s.forEach(e=>{r+=this.buildMeshInstance(e);}),r+=(i=this.materials,`
def "Materials"
{
		${i.join("\n")}
}
`),this.addFile(null,E5,"",r);let a={maxTextureSize:t.maxTextureSize},n=Array.from(this.textureMap.keys()),o=[];for(let e=0;e<n.length;e++){let t=n[e],i=this.textureToCanvas(t,a).then(e=>e?new Promise(t=>e.toBlob(t,"image/png",1)).then(e=>e.arrayBuffer()):new Promise(e=>e(null)));o.push(i);}return Promise.all(o).then(e=>{e.forEach((e,t)=>{let i=n[t],s=this.getTextureFileIds(i);this.files[s.fileName]=new Uint8Array(e);}),this.alignFiles();let t=function(e,t){t||(t={});var i={},s=[];EQ(e,"",i,t);var r=0,a=0;for(var n in i){var o=i[n],l=o[0],h=o[1],c=8*(0!=h.level),d=E1(n),u=d.length,f=h.comment,p=f&&E1(f),m=p&&p.length,_=E2(h.extra);u>65535&&EF(11);var g=c?Ej(l,h||{},0,0):l,v=g.length,S=E$();S.p(l),s.push(EK(h,{size:l.length,crc:S.d(),c:g,f:d,m:p,u:u!=n.length||p&&f.length!=m,o:r,compression:c})),r+=30+u+_+v,a+=76+2*(u+_)+(m||0)+v;}for(var y=new Ef(a+22),x=r,T=a-r,E=0;E<s.length;++E){var d=s[E];E3(y,d.o,d,d.f,d.u,d.c.length);var w=30+d.f.length+E2(d.extra);y.set(d.c,d.o+w),E3(y,r,d,d.f,d.u,d.c.length,d.o,d.m),r+=16+w+(d.m?d.m.length:0);}return E4(y,r,s.length,T,x),y}(this.files,{level:0});return this.done(),t})}alignFiles(){let e=0;for(let t in this.files){let i=this.files[t],s=63&(e+=34+t.length);if(4!==s){let e=new Uint8Array(64-s);this.files[t]=[i,{extra:{12345:e}}];}e=i.length;}}getFileIds(e,t,i,s="usda"){let r=`${e?`${e}/`:""}${t}.${s}`,a=`@./${r}@</${i}>`;return {name:t,fileName:r,refName:a}}getTextureFileIds(e){return this.getFileIds("texture",`Texture_${e.id}`,"Texture","png")}addFile(e,t,i="",s=""){let r=null;s&&(r=E1(s=`${E8}
${s}`));let a=this.getFileIds(e,t,i);return this.files[a.fileName]=r,a.refName}getMaterialRef(e){let t=this.materialMap.get(e);return t||(t=this.buildMaterial(e),this.materialMap.set(e,t)),t}getMeshRef(e){let t=this.meshMap.get(e);return t||(t=this.buildMesh(e),this.meshMap.set(e,t)),t}buildArray2(e){let t=[],i=e.length;for(let s=0;s<i;s+=2)t.push(`(${e[s]}, ${1-e[s+1]})`);return t.join(", ")}buildArray3(e){let t=[],i=e.length;for(let s=0;s<i;s+=3)t.push(`(${e[s]}, ${e[s+1]}, ${e[s+2]})`);return t.join(", ")}buildMat4(e){let t=e.data,i=[];for(let e=0;e<16;e+=4)i.push(`(${t[e]}, ${t[e+1]}, ${t[e+2]}, ${t[e+3]})`);return `( ${i.join(", ")} )`}buildMaterial(e){let t=`Material_${e.id}`,i=`/Materials/${t}`,s=e=>`<${i}${e}>`,r=[],a=[],n=(t,i,n,o,l,h=false,c=false)=>{let d=e[t];if(d){let u=this.getTextureFileIds(d);this.textureMap.set(d,u.refName);let f=e[`${t}Channel`]||"rgb",p=s(`/${u.name}_${l}.outputs:${f}`);r.push(E6(n,`${o}.connect`,p)),h&&e.alphaTest;let m=e[`${t}Tiling`],_=e[`${t}Offset`],g=e[`${t}Rotation`],v=1===e[`${t}Uv`]?"st1":"st",S=c&&i?i:es.WHITE;a.push(`
								def Shader "Transform2d_${l}" (
										sdrMetadata = {
												string role = "math"
										}
								)
								{
										uniform token info:id = "UsdTransform2d"
										float2 inputs:in.connect = ${s(`/uvReader_${v}.outputs:result`)}
										float inputs:rotation = ${g}
										float2 inputs:scale = (${m.x}, ${m.y})
										float2 inputs:translation = (${_.x}, ${_.y})
										float2 outputs:result
								}

								def Shader "Texture_${d.id}_${l}"
								{
										uniform token info:id = "UsdUVTexture"
										asset inputs:file = @${u.fileName}@
										float2 inputs:st.connect = ${s(`/Transform2d_${l}.outputs:result`)}
										token inputs:wrapS = "repeat"
										token inputs:wrapT = "repeat"
										float4 inputs:scale = (${S.r}, ${S.g}, ${S.b}, ${S.a})
										float outputs:r
										float outputs:g
										float outputs:b
										float3 outputs:rgb
										float outputs:a
								}
						`);}else if(i){let e="float"===n?`${i}`:`(${i.r}, ${i.g}, ${i.b})`;r.push(E6(n,o,e));}};n("diffuseMap",e.diffuse,"color3f","diffuseColor","diffuse",false,true),(e.transparent||e.alphaTest>0)&&n("opacityMap",e.opacity,"float","opacity","opacity",true),n("normalMap",null,"normal3f","normal","normal"),n("emissiveMap",e.emissive,"color3f","emissiveColor","emissive",false,true),n("aoMap",null,"float","occlusion","occlusion"),n("metalnessMap",e.useMetalness?e.metalness:0,"float","metallic","metallic"),n("glossMap",e.glossInvert?e.gloss:1-e.gloss,"float","roughness","roughness");let o=`
						def Material "${t}"
						{
								def Shader "PreviewSurface"
								{
										uniform token info:id = "UsdPreviewSurface"
${r.join("\n")}
										int inputs:useSpecularWorkflow = 0
										token outputs:surface
								}

								token outputs:surface.connect = ${s("/PreviewSurface.outputs:surface")}

								def Shader "uvReader_st"
								{
										uniform token info:id = "UsdPrimvarReader_float2"
										token inputs:varname = "st"
										float2 inputs:fallback = (0.0, 0.0)
										float2 outputs:result
								}

								def Shader "uvReader_st1"
								{
										uniform token info:id = "UsdPrimvarReader_float2"
										token inputs:varname = "st1"
										float2 inputs:fallback = (0.0, 0.0)
										float2 outputs:result
								}

								${a.join("\n")}
						}
				`;return this.materials.push(o),s("")}buildMesh(e){let t,i,s,r,a=[],n=[],o=[],l=[],h=[];e.getVertexStream(e6,a),e.getVertexStream(e9,o),e.getVertexStream(tr,l),e.getVertexStream(ta,h),e.getIndices(n);let c=n.length||a.length,d=Array(c/3).fill(3).join(", ");if(!n.length)for(let e=0;e<c;e++)n[e]=e;let u=a.length/3;o=o.length?o:Array(3*u).fill(0),l=l.length?l:Array(2*u).fill(0),h=h.length?h:Array(2*u).fill(0),a=this.buildArray3(a),o=this.buildArray3(o),l=this.buildArray2(l),h=this.buildArray2(h);let f=(t=o,i=a,s=l,r=h,`
def "Mesh"
{
		def Mesh "Mesh"
		{
				int[] faceVertexCounts = [${d}]
				int[] faceVertexIndices = [${n}]
				normal3f[] normals = [${t}] (
						interpolation = "vertex"
				)
				point3f[] points = [${i}]
				texCoord2f[] primvars:st = [${s}] (
						interpolation = "vertex"
				)
				texCoord2f[] primvars:st1 = [${r}] (
						interpolation = "vertex"
				)
				uniform token subdivisionScheme = "none"
		}
}
`);return this.addFile("mesh",`Mesh_${e.id}`,"Mesh",f)}buildMeshInstance(e){let t,i=this.getMeshRef(e.mesh),s=this.getMaterialRef(e.material),r=this.buildMat4(e.node.getWorldTransform()),a=e.node.name.replace(/[^a-z0-9]/gi,"_"),n=a;for(;this.nodeNames.has(n);)n=`${a}_${Math.random().toString(36).slice(2,7)}`;return this.nodeNames.add(n),t=n,`
def Xform "${t}" (
		prepend references = ${i}
)
{
		matrix4d xformOp:transform = ${r}
		uniform token[] xformOpOrder = ["xformOp:transform"]

		rel material:binding = ${s}
}
`}},e.VIEW_CENTER=0,e.VIEW_LEFT=1,e.VIEW_RIGHT=2,e.Vec2=ef,e.Vec3=ed,e.Vec4=ep,e.VertexBuffer=iP,e.VertexFormat=iO,e.VertexIterator=ag,e.ViewCube=Au,e.WORKBUFFER_UPDATE_ALWAYS=2,e.WORKBUFFER_UPDATE_AUTO=0,e.WORKBUFFER_UPDATE_ONCE=1,e.WasmModule=$,e.WebglGraphicsDevice=rQ,e.WebgpuGraphicsDevice=rM,e.WorldClusters=o7,e.XRDEPTHSENSINGFORMAT_F32=xD,e.XRDEPTHSENSINGFORMAT_L8A8=xP,e.XRDEPTHSENSINGFORMAT_R16U=xI,e.XRDEPTHSENSINGUSAGE_CPU=xA,e.XRDEPTHSENSINGUSAGE_GPU=xC,e.XREYE_LEFT="left",e.XREYE_NONE="none",e.XREYE_RIGHT="right",e.XRHAND_LEFT=xb,e.XRHAND_NONE="none",e.XRHAND_RIGHT="right",e.XRPAD_A=4,e.XRPAD_B=5,e.XRPAD_SQUEEZE=1,e.XRPAD_STICK_BUTTON=3,e.XRPAD_STICK_X=2,e.XRPAD_STICK_Y=3,e.XRPAD_TOUCHPAD_BUTTON=2,e.XRPAD_TOUCHPAD_X=0,e.XRPAD_TOUCHPAD_Y=1,e.XRPAD_TRIGGER=0,e.XRSPACE_BOUNDEDFLOOR="bounded-floor",e.XRSPACE_LOCAL="local",e.XRSPACE_LOCALFLOOR="local-floor",e.XRSPACE_UNBOUNDED="unbounded",e.XRSPACE_VIEWER=xw,e.XRTARGETRAY_GAZE="gaze",e.XRTARGETRAY_POINTER="tracked-pointer",e.XRTARGETRAY_SCREEN="screen",e.XRTRACKABLE_MESH="mesh",e.XRTRACKABLE_PLANE="plane",e.XRTRACKABLE_POINT="point",e.XRTYPE_AR=xE,e.XRTYPE_INLINE=xx,e.XRTYPE_VR=xT,e.XrAnchor=x8,e.XrAnchors=x6,e.XrDomOverlay=xR,e.XrFinger=xk,e.XrHand=xY,e.XrHitTest=xF,e.XrHitTestSource=xO,e.XrImageTracking=xB,e.XrInput=xZ,e.XrInputSource=xK,e.XrJoint=xV,e.XrLightEstimation=x2,e.XrManager=Ti,e.XrMeshDetection=x7,e.XrPlane=x4,e.XrPlaneDetection=x5,e.XrTrackedImage=xN,e.XrView=Te,e.XrViews=Tt,e.ZoneComponent=gQ,e.ZoneComponentSystem=g1,e.ambientSrcNames=ng,e.basisInitialize=xa,e.bindGroupNames=tK,e.blendNames=a8,e.calculateNormals=cN,e.calculateTangents=cB,e.createBox=function(e,t){return n7.fromGeometry(e,new cU(t))},e.createCapsule=function(e,t){return n7.fromGeometry(e,new ue(t))},e.createCone=function(e,t){return n7.fromGeometry(e,new ut(t))},e.createCylinder=function(e,t){return n7.fromGeometry(e,new ui(t))},e.createGraphicsDevice=function(e,t={}){let i=t.deviceTypes??[];i.includes(tY)||i.push(tY),i.includes(t$)||i.push(t$),k.browser&&navigator.xr&&(t.xrCompatible??(t.xrCompatible=true));let s=[];for(let r=0;r<i.length;r++){let a=i[r];a===tq&&window?.navigator?.gpu&&s.push(()=>new rM(e,t).initWebGpu(t.glslangUrl,t.twgslUrl)),a===tY&&s.push(()=>new rQ(e,t)),a===t$&&s.push(()=>new r5(e,t));}return new Promise((e,t)=>{let i=0,r=()=>{i>=s.length?t(Error("Failed to create a graphics device")):Promise.resolve(s[i++]()).then(t=>{t?e(t):r();}).catch(e=>{r();});};r();})},e.createMesh=function(e,t,i={}){let s=new ck;return s.positions=t,s.normals=i.normals,s.tangents=i.tangents,s.colors=i.colors,s.uvs=i.uvs,s.uvs1=i.uvs1,s.blendIndices=i.blendIndices,s.blendWeights=i.blendWeights,s.indices=i.indices,n7.fromGeometry(e,s,i)},e.createPlane=function(e,t){return n7.fromGeometry(e,new us(t))},e.createScript=yY,e.createShader=function(e,t,i,s=false,r={}){},e.createShaderFromCode=function(e,t,i,s,r,a=false,n={}){"boolean"==typeof a?n.useTransformFeedback=a:"object"==typeof a&&(n={...n,...a});let o=nN(e),l=o.getCachedShader(s);return l||(l=new rd(e,rh.createDefinition(e,{...n,name:s,vertexCode:t,fragmentCode:i,attributes:r})),o.setCachedShader(s,l)),l},e.createSphere=function(e,t){return n7.fromGeometry(e,new cz(t))},e.createTorus=function(e,t){return n7.fromGeometry(e,new ur(t))},e.createURI=function(e){let t="";if((e.authority||e.scheme)&&(e.host||e.hostpath))throw Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(e.host&&e.hostpath)throw Error("Can't have 'host' and 'hostpath' option");if(e.path&&e.hostpath)throw Error("Can't have 'path' and 'hostpath' option");return e.scheme&&(t+=`${e.scheme}:`),e.authority&&(t+=`//${e.authority}`),e.host&&(t+=e.host),e.path&&(t+=e.path),e.hostpath&&(t+=e.hostpath),e.query&&(t+=`?${e.query}`),e.fragment&&(t+=`#${e.fragment}`),t},e.cubemaProjectionNames=nr,e.ditherNames=nb,e.dracoInitialize=e=>{e?.lazyInit?_=e:Sv(e);},e.drawFullscreenQuad=function(e,t,i,s,r){let a;if(r){let i=t?t.width:e.width,s=t?t.height:e.height;a=TW.set(r.x*i,r.y*s,r.z*i,r.w*s);}n0(e,t,s,a);},e.drawQuadWithShader=n0,e.extend=A,e.fresnelNames=a7,e.gammaNames=na,e.getGlslShaderType=e1,e.getPixelFormatArrayType=e8,e.getReservedScriptNames=function(){return yX},e.getTouchTargetCoords=aH,e.getWgslShaderType=e2,e.guid=C,e.http=a$,e.indexFormatByteSize=eW,e.isCompressedPixelFormat=eY,e.isIntegerPixelFormat=e$,e.isSrgbPixelFormat=eq,e.lightFalloffNames=ni,e.lightShapeNames=nt,e.lightTypeNames=ne,e.math=ei,e.now=Q,e.path=P,e.pixelFormatGammaToLinear=e4,e.pixelFormatInfo=eX,e.pixelFormatLinearToGamma=e3,e.platform=k,e.primitiveGlslToWgslTypeMap=t3,e.reflectionSrcNames=nf,e.registerScript=y$,e.reprojectTexture=c7,e.requiresManualGamma=e5,e.revision=b,e.script=fs,e.semanticToLocation=t4,e.shaderChunks=Tq,e.shadowTypeInfo=ns,e.specularOcclusionNames=no,e.spriteRenderModeNames=nv,e.string=H,e.tonemapNames=nn,e.typedArrayIndexFormats=t1,e.typedArrayIndexFormatsByteSize=t2,e.typedArrayToType={Int8Array:0,Uint8Array:1,Int16Array:2,Uint16Array:3,Int32Array:4,Uint32Array:5,Float32Array:6},e.typedArrayTypes=tJ,e.typedArrayTypesByteSize=t0,e.uniformTypeToName=tG,e.uniformTypeToNameMapWGSL=tW,e.uniformTypeToNameWGSL=tH,e.uniformTypeToStorage=tX,e.version=w,e.vertexTypesNames=["INT8","UINT8","INT16","UINT16","INT32","UINT32","FLOAT32","FLOAT16"];},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).pc={});
