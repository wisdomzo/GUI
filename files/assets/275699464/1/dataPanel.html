<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>

    <!-- Chart -->
    <script>
        window.onload = function () {
            const info = document.getElementById('information');
            info.textContent = '[INFO] Loading...';
            // é †ç•ªã«èª­ã¿è¾¼ã¿ä¸­ï¼šChart.js -> Date Adapter -> Zoom Plugin -> ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
            loadChartDependencies(function () {
                console.log("Chartã®ä¾å­˜é–¢ä¿‚ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã—ã¦ã„ã¾ã™...");
                loadMainScripts();
            });
        };

        // 1. Chart ã¨ãã®ä¾å­˜é–¢ä¿‚ã‚’èª­ã¿è¾¼ã¿ä¸­ (ã‚·ãƒªã‚¢ãƒ«èª­ã¿è¾¼ã¿)
        function loadChartDependencies(callback) {
            const params = new URLSearchParams(window.location.search);
            const chartUrl = params.get("chart") || "/Research/chart.umd.js" || "https://cdn.jsdelivr.net/npm/chart.js";
            const adapterUrl = params.get("dateAdapter") || "/Research/chartjs-adapter-date-fns.bundle.min.js" || "https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js";
            const zoomUrl = params.get("chartZoom") || "/Research/chartjs-plugin-zoom.js" || "https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom/dist/chartjs-plugin-zoom.min.js";

            if (!chartUrl || !adapterUrl || !zoomUrl) {
                console.error("URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ãƒãƒ£ãƒ¼ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }

            loadScript(chartUrl, "Chart.js core", function() {
                loadScript(adapterUrl, "Date adapter", function() {
                    loadScript(zoomUrl, "Zoom plugin", function() {
                        if (callback) callback();
                    });
                });
            });
        }

        // 2. ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­ (ä¾å­˜é–¢ä¿‚ã¯ä¸¦è¡Œèª­ã¿è¾¼ã¿ã€æœ€å¾Œã«ãƒ¡ã‚¤ãƒ³ã‚’èª­ã¿è¾¼ã¿)
        function loadMainScripts() {
            const params = new URLSearchParams(window.location.search);
            const mainUrl = params.get("main") || "/Research/main.js";
            const statisticsUtilsUrl = params.get("statisticsUtils") || "/Research/StatisticsUtils.js";
            const supabaseUrl = params.get("supabase") || "/Research/app_config.js";
            const supabaseJSUrl = params.get("supabaseJS") || "/Research/supabase.js" || "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";
            

            if (statisticsUtilsUrl && supabaseUrl && supabaseJSUrl) {
                Promise.all([
                    loadScriptPromise(statisticsUtilsUrl),
                    loadScriptPromise(supabaseUrl),
                    loadScriptPromise(supabaseJSUrl)
                ]).then(() => {
                    if (mainUrl) {
                        const mainScript = document.createElement("script");
                        mainScript.type = "module";
                        mainScript.src = mainUrl;
                        document.body.appendChild(mainScript);
                        console.log("ãƒ¡ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚");
                    }
                }).catch(err => console.error("é‡è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼š", err));
            }
        }

        // è£œåŠ©é–¢æ•°ï¼šé€šå¸¸ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å¼
        function loadScript(src, name, onLoadCallback) {
            const script = document.createElement("script");
            script.src = src;
            script.onload = () => { console.log(name + " loaded."); onLoadCallback(); };
            script.onerror = () => console.error("Failed to load " + name);
            document.head.appendChild(script);
        }

        // è£œåŠ©é–¢æ•°ï¼šPromiseå¼
        function loadScriptPromise(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function enableInterface() {
            const controls = ['metric', 'calFunction', 'duration', 'start', 'end', 'load', 'reset','myChart', 'statisticsInfo'];
            controls.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.disabled = false;
            });
            handleResponsiveLayout();
        }

        function handleResponsiveLayout() {
            const panel = document.querySelector('section.grid');
            if (!panel) return;
            const updateGrid = () => {
                const width = window.innerWidth;
                panel.classList.remove('grid-cols-1', 'grid-cols-2', 'grid-cols-3', 'grid-cols-4');
                if (width < 768) {
                    panel.classList.add('grid-cols-1');
                } else if (width < 1024) {
                    panel.classList.add('grid-cols-2');
                } else {
                    panel.classList.add('grid-cols-4');
                }
            };
            updateGrid();
            // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºã®å¤‰æ›´ã‚’ç›£è¦–ã—ã¾ã™ï¼ˆresizeã‚¤ãƒ™ãƒ³ãƒˆã‚ˆã‚Šã‚‚ ResizeObserver ã®æ–¹ãŒåŠ¹ç‡çš„ã§ã™ï¼‰
            window.addEventListener('resize', updateGrid);
        }

    </script>


    <!-- UI -->
    <script>
        const params = new URLSearchParams(window.location.search);
        const tailwindUrl = params.get("tailwind") || "/Research/tailwind-v3.css" || "https://cdn.tailwindcss.com";

        if (tailwindUrl) {
            const link = document.createElement("link");
            link.rel = "stylesheet";
            link.href = tailwindUrl;
            document.head.appendChild(link);
        }
    </script>

    <style>
        .label {
            font-size: clamp(0.7rem, 0.6vw, 0.8rem);
            color: #94a3b8;
        }
        .input {
            width: 100%;
            margin-top: 0.25rem;
            padding: 0 0.75rem;
            height: clamp(2.3rem, 3vw, 2.8rem);
            font-size: clamp(0.85rem, 0.9vw, 1rem);
            background: #334155;
            border-radius: 0.5rem;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            appearance: none;
        }
        input:disabled,
        select:disabled,
        button:disabled {cursor: not-allowed;}

        /* åŸºç¡€æ ·å¼ï¼šç¡®ä¿ body æ’‘æ»¡ä¸”é¢œè‰²åˆ‡æ¢å¹³æ»‘ */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            transition: box-shadow 0.3s ease; /* è®©è¾¹æ¡†å‡ºç°æ—¶æœ‰æ¸å˜æ•ˆæœ */
        }

        /* æŠ¥è­¦çŠ¶æ€ï¼šç½‘é¡µå¤–å›´å‡ºç°çº¢è‰²å†…é˜´å½±è¾¹æ¡† */
        .alert-active {
            /* inset è¡¨ç¤ºå†…é˜´å½±ï¼Œ10px æ˜¯å®½åº¦ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´ */
            box-shadow: inset 0 0 0 10px #ef4444 !important;
        }

    </style>
</head>

<body class="bg-slate-900 text-slate-100 min-h-screen">
    <div class="max-w-6xl mx-auto p-6 space-y-6">
        <span class="text-slate-400 text-sm font-semibold uppercase tracking-widest">å¯è¦–åŒ–ã‚·ã‚¹ãƒ†ãƒ ï¼ˆé˜²ç½ã‚¬ã‚¸ã‚§ãƒƒãƒˆï¼‰ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—</span>
        <header class="flex items-center justify-between">
            <h1 class="text-3xl font-bold">ğŸ“Š è§£æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <span class="text-sm text-slate-400">ä¿¡å·å¤§å­¦DXæ¨é€²ã‚»ãƒ³ã‚¿ãƒ¼ Â· Supabase Â· Chart.js</span>
        </header>

        <!-- Control Panel -->
        <section class="bg-slate-800 rounded-xl p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 items-stretch">
            <div>
                <label class="label">1. å¯¾è±¡</label>
                <select id="metric" class="input" disabled>
                    <option value="temperature">æ¸©åº¦</option>
                    <option value="humidity">æ¹¿åº¦</option>
                    <option value="pressure">æ°—åœ§</option>
                    <option value="rainfall">é›¨é‡ï¼ˆæœªå®Ÿè£…ï¼‰</option>
                    <option value="waterLevel">æ°´ä½ï¼ˆæœªå®Ÿè£…ï¼‰</option>
                    <option value="rssi">å—ä¿¡é›»åŠ›</option>
                </select>
            </div>

            <div>
                <label class="label">2. é–¢æ•°</label>
                <select id="calFunction" class="input" disabled>
                    <option value="realTime">æ™‚ç³»åˆ—ï¼ˆãƒ©ã‚¤ãƒ–ï¼‰</option>
                    <option value="timeSeries">æ™‚ç³»åˆ—ï¼ˆéå»ï¼‰</option>
                    <option value="dis_CDF">ç´¯ç©ç¢ºç‡åˆ†å¸ƒ</option>
                </select>
            </div>

            <div class="flex flex-col gap-2 w-full" style="box-sizing: border-box;">
                <div class="w-full">
                    <label class="label">3. æœŸé–“</label>
                    <select id="duration" class="input" style="box-sizing: border-box;" disabled>
                        <option value="fixable">æŒ‡å®š</option>
                        <option value="oneDay">24æ™‚é–“</option>
                        <option value="oneWeek">1é€±é–“</option>
                        <option value="oneMonth">1æœˆ</option>
                    </select>
                </div>

                <div class="w-full">
                    <label class="label">é–‹å§‹æ—¥æ™‚</label>
                    <input id="start" type="datetime-local" class="input" style="box-sizing: border-box;" disabled/>
                </div>

                <div class="w-full">
                    <label class="label">çµ‚äº†æ—¥æ™‚</label>
                    <input id="end" type="datetime-local" class="input" style="box-sizing: border-box;" disabled/>
                </div>
            </div>

            <div class="flex flex-col gap-2">
                <label class="label">4. å‹•ä½œ</label>
                <button id="load" class="relative h-11 px-6 font-bold rounded-lg bg-cyan-500 text-black hover:bg-cyan-400 transition disabled:opacity-50 glow overflow-hidden" disabled>
                    <span id="btn-text">Load Data</span>
                    <span id="spinner" class="absolute inset-0 hidden items-center justify-center">
                        <svg class="animate-spin h-5 w-5 text-black" viewBox="0 0 24 24" fill="none">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/>
                        </svg>
                    </span>
                </button>

                <button id="reset" class="h-11 px-6 font-bold text-black rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600 hover:text-white transition" disabled>
                    Reset
                </button>

                <button id="toggle-wake-lock" class="h-11 px-6 font-bold rounded-lg bg-amber-500 text-black hover:bg-amber-400 transition flex items-center justify-center gap-2">
                    <span id="wake-status-dot" class="w-2 h-2 rounded-full bg-slate-800"></span>
                    <span id="wake-text">Enable Keep-Alive Mode</span>
                </button>
            </div>
        </section>

        <!-- Information -->
        <div id="information" class="text-sm text-slate-400"></div>

        <!-- Chart -->
        <div class="chart-container" style="position: relative; width: 100%; aspect-ratio: 80 / 56.56;" disabled>
            <canvas id="myChart"></canvas>
        </div>

        <!-- StatisticsInfo -->
        <div id="statisticsInfo" class="text-lg text-slate-400" disabled></div>
        
    </div>

    <footer class="fixed bottom-0 left-0 w-full bg-slate-900/80 backdrop-blur-md py-2 text-center border-t border-slate-800">
    <p class="text-slate-400 text-xs">
        &copy; <span id="current-year"></span> ãƒ–ã‚¤ã‚¢ãƒ¼ãƒ«ã‚³ãƒã‚¯ãƒˆæ ªå¼ä¼šç¤¾. All Rights Reserved.
    </p>
    </footer>

    <script>
        document.getElementById('current-year').textContent = new Date().getFullYear();
    </script>

    <script>
        let wakeLock = null;
        let isManualEnabled = false; 

        const wakeBtn = document.getElementById('toggle-wake-lock');
        const wakeText = document.getElementById('wake-text');
        const wakeDot = document.getElementById('wake-status-dot');

        async function toggleWakeLock() {
            // æ—¢ã«ãƒ­ãƒƒã‚¯ãŒå–å¾—ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§é–‰ã˜ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™
            if (isManualEnabled) {
                if (wakeLock) {
                    await wakeLock.release();
                    wakeLock = null;
                }
                isManualEnabled = false;
                updateUI(false);
            } else {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§æœ‰åŠ¹ã«ã—ãŸã„
                isManualEnabled = true;
                await requestLock();
            }
        }

        // å†åˆ©ç”¨ã—ã‚„ã™ã„ã‚ˆã†ã«ã€ç‹¬ç«‹ã—ãŸé–¢æ•°ã«ã‚«ãƒ—ã‚»ãƒ«åŒ–ã™ã‚‹
        async function requestLock() {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                updateUI(true);
                
                // è§£æ”¾ã®ç›£è¦–
                wakeLock.addEventListener('release', () => {
                    console.log('ã‚¦ã‚§ã‚¤ã‚¯ãƒ­ãƒƒã‚¯ãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸã€‚');
                    // æ³¨æ„ï¼šè§£æ”¾æ™‚ã«å³åº§ã« updateUI(false) ã‚’å‘¼ã³å‡ºã•ãªã„ã§ãã ã•ã„ã€‚ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç§»è¡Œã«ã‚ˆã‚‹è§£æ”¾ã®å ´åˆã¯ã€å¾©å¸°æ™‚ã«è‡ªå‹•æ›´æ–°ã—ãŸã„ãŸã‚ã§ã™ã€‚
                });
            } catch (err) {
                console.error(`${err.name}, ${err.message}`);
                // æ‰‹å‹•ã§ã®æœ‰åŠ¹åŒ–ã«å¤±æ•—ã—ãŸå ´åˆã®ã¿ã‚¨ãƒ©ãƒ¼ã‚’å ±å‘Šã™ã‚‹
                if (isManualEnabled) {
                    isManualEnabled = false;
                    updateUI(false);
                }
            }
        }

        function updateUI(isActive) {
            if (isActive) {
                wakeBtn.classList.replace('bg-amber-500', 'bg-green-500');
                wakeDot.classList.replace('bg-slate-800', 'bg-white');
                wakeText.innerText = "Keep-Alive Active";
            } else {
                wakeBtn.classList.replace('bg-green-500', 'bg-amber-500');
                wakeDot.classList.replace('bg-white', 'bg-slate-800');
                wakeText.innerText = "Enable Keep-Alive Mode";
            }
        }

        wakeBtn.addEventListener('click', toggleWakeLock);

        document.addEventListener('visibilitychange', async () => {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»¥å‰ã«ã‚¹ã‚¤ãƒƒãƒã‚’ã‚ªãƒ³ã«ã—ã¦ã„ã¦ã€ã‹ã¤ãƒšãƒ¼ã‚¸ãŒãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«æˆ»ã£ãŸå ´åˆ
            if (isManualEnabled && document.visibilityState === 'visible') {
                console.log('ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å¾©å¸°ã‚’æ¤œçŸ¥ã€è‡ªå‹•æ›´æ–°ä¸­...');
                // æ–°ã—ã„ãƒ­ãƒƒã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å†å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
                await requestLock();
            }
        });
    </script>

</body>
</html>